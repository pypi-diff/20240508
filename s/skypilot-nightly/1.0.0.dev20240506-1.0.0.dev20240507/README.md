# Comparing `tmp/skypilot_nightly-1.0.0.dev20240506.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240507.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240506.tar", last modified: Mon May  6 10:38:22 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240507.tar", last modified: Tue May  7 10:38:23 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240506.tar` & `skypilot_nightly-1.0.0.dev20240507.tar`

### file list

```diff
@@ -1,338 +1,338 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.880904 skypilot_nightly-1.0.0.dev20240506/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-06 10:38:13.000000 skypilot_nightly-1.0.0.dev20240506/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-06 10:38:22.880904 skypilot_nightly-1.0.0.dev20240506/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-06 10:38:13.000000 skypilot_nightly-1.0.0.dev20240506/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-06 10:38:22.880904 skypilot_nightly-1.0.0.dev20240506/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-06 10:38:19.000000 skypilot_nightly-1.0.0.dev20240506/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.820904 skypilot_nightly-1.0.0.dev20240506/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.820904 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.824904 skypilot_nightly-1.0.0.dev20240506/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   119850 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   223596 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.824904 skypilot_nightly-1.0.0.dev20240506/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.824904 skypilot_nightly-1.0.0.dev20240506/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   191563 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.828904 skypilot_nightly-1.0.0.dev20240506/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    44034 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    31745 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    18717 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.828904 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.832904 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.832904 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    32857 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.832904 skypilot_nightly-1.0.0.dev20240506/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8230 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    24917 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/global_user_state.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/jobs/
--rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/state.py
--rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/jobs/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36608 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.836904 skypilot_nightly-1.0.0.dev20240506/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.840904 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.840904 skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.840904 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.840904 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32841 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.840904 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)    10501 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     9035 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    55170 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.844904 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.844904 skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.844904 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.848904 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.848904 skypilot_nightly-1.0.0.dev20240506/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28265 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.848904 skypilot_nightly-1.0.0.dev20240506/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-06 10:38:19.000000 skypilot_nightly-1.0.0.dev20240506/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.852904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11596 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35202 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.852904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.852904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.852904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.856904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.856904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.856904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.856904 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/skypilot_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.860904 skypilot_nightly-1.0.0.dev20240506/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7320 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/jobs-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    11034 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.860904 skypilot_nightly-1.0.0.dev20240506/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.864904 skypilot_nightly-1.0.0.dev20240506/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.864904 skypilot_nightly-1.0.0.dev20240506/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    22833 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.864904 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1193 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    20702 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.868904 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9302 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-06 10:38:22.000000 skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-06 10:38:22.868904 skypilot_nightly-1.0.0.dev20240506/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_jobs_and_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   215124 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-06 10:38:14.000000 skypilot_nightly-1.0.0.dev20240506/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.885459 skypilot_nightly-1.0.0.dev20240507/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-07 10:38:23.885459 skypilot_nightly-1.0.0.dev20240507/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-07 10:38:23.889459 skypilot_nightly-1.0.0.dev20240507/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-07 10:38:21.000000 skypilot_nightly-1.0.0.dev20240507/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.821459 skypilot_nightly-1.0.0.dev20240507/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.821459 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.825459 skypilot_nightly-1.0.0.dev20240507/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   120242 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   223596 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.825459 skypilot_nightly-1.0.0.dev20240507/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.825459 skypilot_nightly-1.0.0.dev20240507/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   192155 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.829459 skypilot_nightly-1.0.0.dev20240507/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44034 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31745 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19147 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.833459 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.833459 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.833459 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32857 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8230 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24917 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/global_user_state.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/jobs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/jobs/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.837459 skypilot_nightly-1.0.0.dev20240507/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.841459 skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36608 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.841459 skypilot_nightly-1.0.0.dev20240507/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.841459 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.841459 skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.841459 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.845459 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32841 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.845459 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10501 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9035 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    57506 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.845459 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.845459 skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.849459 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.849459 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.853459 skypilot_nightly-1.0.0.dev20240507/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28265 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.853459 skypilot_nightly-1.0.0.dev20240507/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-07 10:38:21.000000 skypilot_nightly-1.0.0.dev20240507/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.853459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11596 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35202 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.857459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.861459 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/skypilot_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.865459 skypilot_nightly-1.0.0.dev20240507/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    11034 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.865459 skypilot_nightly-1.0.0.dev20240507/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.869459 skypilot_nightly-1.0.0.dev20240507/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.869459 skypilot_nightly-1.0.0.dev20240507/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    22833 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.869459 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21863 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.873459 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9302 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-07 10:38:23.000000 skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-07 10:38:23.873459 skypilot_nightly-1.0.0.dev20240507/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_jobs_and_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   215124 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-07 10:38:18.000000 skypilot_nightly-1.0.0.dev20240507/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/LICENSE` & `skypilot_nightly-1.0.0.dev20240507/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240507/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240507/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240506
+Version: 1.0.0.dev20240507
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/README.md` & `skypilot_nightly-1.0.0.dev20240507/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240507/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/setup.py` & `skypilot_nightly-1.0.0.dev20240507/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '2ff95bb40067984022de5a5a530dfbfea3b0e741'
+_SKYPILOT_COMMIT_SHA = '904aa5cb6b59a550d39ae87a2bbfe32e4c53b8b4'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240506'
+__version__ = '1.0.0.dev20240507'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240507/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240507/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/backend_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,7491 +1,7516 @@
 00000000: 2222 2255 7469 6c20 636f 6e73 7461 6e74  """Util constant
 00000010: 732f 6675 6e63 7469 6f6e 7320 666f 7220  s/functions for 
 00000020: 7468 6520 6261 636b 656e 6473 2e22 2222  the backends."""
 00000030: 0a66 726f 6d20 6461 7465 7469 6d65 2069  .from datetime i
 00000040: 6d70 6f72 7420 6461 7465 7469 6d65 0a69  mport datetime.i
 00000050: 6d70 6f72 7420 656e 756d 0a69 6d70 6f72  mport enum.impor
-00000060: 7420 6675 6e63 746f 6f6c 730a 696d 706f  t functools.impo
-00000070: 7274 206f 730a 696d 706f 7274 2070 6174  rt os.import pat
-00000080: 686c 6962 0a69 6d70 6f72 7420 7070 7269  hlib.import ppri
-00000090: 6e74 0a69 6d70 6f72 7420 7265 0a69 6d70  nt.import re.imp
-000000a0: 6f72 7420 7368 6c65 780a 696d 706f 7274  ort shlex.import
-000000b0: 2073 7562 7072 6f63 6573 730a 696d 706f   subprocess.impo
-000000c0: 7274 2073 7973 0a69 6d70 6f72 7420 7465  rt sys.import te
-000000d0: 6d70 6669 6c65 0a69 6d70 6f72 7420 7465  mpfile.import te
-000000e0: 7874 7772 6170 0a69 6d70 6f72 7420 7469  xtwrap.import ti
-000000f0: 6d65 0a69 6d70 6f72 7420 7479 7069 6e67  me.import typing
-00000100: 0a66 726f 6d20 7479 7069 6e67 2069 6d70  .from typing imp
-00000110: 6f72 7420 416e 792c 2044 6963 742c 204c  ort Any, Dict, L
-00000120: 6973 742c 204f 7074 696f 6e61 6c2c 2053  ist, Optional, S
-00000130: 6571 7565 6e63 652c 2053 6574 2c20 5475  equence, Set, Tu
-00000140: 706c 652c 2055 6e69 6f6e 0a69 6d70 6f72  ple, Union.impor
-00000150: 7420 7575 6964 0a0a 696d 706f 7274 2063  t uuid..import c
-00000160: 6f6c 6f72 616d 610a 696d 706f 7274 2066  olorama.import f
-00000170: 696c 656c 6f63 6b0a 6672 6f6d 2070 6163  ilelock.from pac
-00000180: 6b61 6769 6e67 2069 6d70 6f72 7420 7665  kaging import ve
-00000190: 7273 696f 6e0a 696d 706f 7274 2072 6571  rsion.import req
-000001a0: 7565 7374 730a 6672 6f6d 2072 6571 7565  uests.from reque
-000001b0: 7374 7320 696d 706f 7274 2061 6461 7074  sts import adapt
-000001c0: 6572 730a 6672 6f6d 2072 6571 7565 7374  ers.from request
-000001d0: 732e 7061 636b 6167 6573 2e75 726c 6c69  s.packages.urlli
-000001e0: 6233 2e75 7469 6c20 696d 706f 7274 2072  b3.util import r
-000001f0: 6574 7279 2061 7320 7265 7472 795f 6c69  etry as retry_li
-00000200: 620a 696d 706f 7274 2072 6963 682e 7072  b.import rich.pr
-00000210: 6f67 7265 7373 2061 7320 7269 6368 5f70  ogress as rich_p
-00000220: 726f 6772 6573 730a 6672 6f6d 2074 7970  rogress.from typ
-00000230: 696e 675f 6578 7465 6e73 696f 6e73 2069  ing_extensions i
-00000240: 6d70 6f72 7420 4c69 7465 7261 6c0a 696d  mport Literal.im
-00000250: 706f 7274 2079 616d 6c0a 0a69 6d70 6f72  port yaml..impor
-00000260: 7420 736b 790a 6672 6f6d 2073 6b79 2069  t sky.from sky i
-00000270: 6d70 6f72 7420 6175 7468 656e 7469 6361  mport authentica
-00000280: 7469 6f6e 2061 7320 6175 7468 0a66 726f  tion as auth.fro
-00000290: 6d20 736b 7920 696d 706f 7274 2062 6163  m sky import bac
-000002a0: 6b65 6e64 730a 6672 6f6d 2073 6b79 2069  kends.from sky i
-000002b0: 6d70 6f72 7420 6368 6563 6b20 6173 2073  mport check as s
-000002c0: 6b79 5f63 6865 636b 0a66 726f 6d20 736b  ky_check.from sk
-000002d0: 7920 696d 706f 7274 2063 6c6f 7564 730a  y import clouds.
-000002e0: 6672 6f6d 2073 6b79 2069 6d70 6f72 7420  from sky import 
-000002f0: 6578 6365 7074 696f 6e73 0a66 726f 6d20  exceptions.from 
-00000300: 736b 7920 696d 706f 7274 2067 6c6f 6261  sky import globa
-00000310: 6c5f 7573 6572 5f73 7461 7465 0a66 726f  l_user_state.fro
-00000320: 6d20 736b 7920 696d 706f 7274 2070 726f  m sky import pro
-00000330: 7669 7369 6f6e 2061 7320 7072 6f76 6973  vision as provis
-00000340: 696f 6e5f 6c69 620a 6672 6f6d 2073 6b79  ion_lib.from sky
-00000350: 2069 6d70 6f72 7420 736b 795f 6c6f 6767   import sky_logg
-00000360: 696e 670a 6672 6f6d 2073 6b79 2069 6d70  ing.from sky imp
-00000370: 6f72 7420 736b 7970 696c 6f74 5f63 6f6e  ort skypilot_con
-00000380: 6669 670a 6672 6f6d 2073 6b79 2069 6d70  fig.from sky imp
-00000390: 6f72 7420 7374 6174 7573 5f6c 6962 0a66  ort status_lib.f
-000003a0: 726f 6d20 736b 792e 636c 6f75 6473 2069  rom sky.clouds i
-000003b0: 6d70 6f72 7420 636c 6f75 645f 7265 6769  mport cloud_regi
-000003c0: 7374 7279 0a66 726f 6d20 736b 792e 7072  stry.from sky.pr
-000003d0: 6f76 6973 696f 6e20 696d 706f 7274 2069  ovision import i
-000003e0: 6e73 7461 6e63 655f 7365 7475 700a 6672  nstance_setup.fr
-000003f0: 6f6d 2073 6b79 2e70 726f 7669 7369 6f6e  om sky.provision
-00000400: 2e6b 7562 6572 6e65 7465 7320 696d 706f  .kubernetes impo
-00000410: 7274 2075 7469 6c73 2061 7320 6b75 6265  rt utils as kube
-00000420: 726e 6574 6573 5f75 7469 6c73 0a66 726f  rnetes_utils.fro
-00000430: 6d20 736b 792e 736b 796c 6574 2069 6d70  m sky.skylet imp
-00000440: 6f72 7420 636f 6e73 7461 6e74 730a 6672  ort constants.fr
-00000450: 6f6d 2073 6b79 2e75 7361 6765 2069 6d70  om sky.usage imp
-00000460: 6f72 7420 7573 6167 655f 6c69 620a 6672  ort usage_lib.fr
-00000470: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
-00000480: 6f72 7420 636c 7573 7465 725f 7961 6d6c  ort cluster_yaml
-00000490: 5f75 7469 6c73 0a66 726f 6d20 736b 792e  _utils.from sky.
-000004a0: 7574 696c 7320 696d 706f 7274 2063 6f6d  utils import com
-000004b0: 6d61 6e64 5f72 756e 6e65 720a 6672 6f6d  mand_runner.from
-000004c0: 2073 6b79 2e75 7469 6c73 2069 6d70 6f72   sky.utils impor
-000004d0: 7420 636f 6d6d 6f6e 5f75 7469 6c73 0a66  t common_utils.f
-000004e0: 726f 6d20 736b 792e 7574 696c 7320 696d  rom sky.utils im
-000004f0: 706f 7274 2063 6f6e 7472 6f6c 6c65 725f  port controller_
-00000500: 7574 696c 730a 6672 6f6d 2073 6b79 2e75  utils.from sky.u
-00000510: 7469 6c73 2069 6d70 6f72 7420 656e 765f  tils import env_
-00000520: 6f70 7469 6f6e 730a 6672 6f6d 2073 6b79  options.from sky
-00000530: 2e75 7469 6c73 2069 6d70 6f72 7420 7269  .utils import ri
-00000540: 6368 5f75 7469 6c73 0a66 726f 6d20 736b  ch_utils.from sk
-00000550: 792e 7574 696c 7320 696d 706f 7274 2073  y.utils import s
-00000560: 7562 7072 6f63 6573 735f 7574 696c 730a  ubprocess_utils.
-00000570: 6672 6f6d 2073 6b79 2e75 7469 6c73 2069  from sky.utils i
-00000580: 6d70 6f72 7420 7469 6d65 6c69 6e65 0a66  mport timeline.f
-00000590: 726f 6d20 736b 792e 7574 696c 7320 696d  rom sky.utils im
-000005a0: 706f 7274 2075 785f 7574 696c 730a 0a69  port ux_utils..i
-000005b0: 6620 7479 7069 6e67 2e54 5950 455f 4348  f typing.TYPE_CH
-000005c0: 4543 4b49 4e47 3a0a 2020 2020 6672 6f6d  ECKING:.    from
-000005d0: 2073 6b79 2069 6d70 6f72 7420 7265 736f   sky import reso
-000005e0: 7572 6365 730a 2020 2020 6672 6f6d 2073  urces.    from s
-000005f0: 6b79 2069 6d70 6f72 7420 7461 736b 2061  ky import task a
-00000600: 7320 7461 736b 5f6c 6962 0a20 2020 2066  s task_lib.    f
-00000610: 726f 6d20 736b 792e 6261 636b 656e 6473  rom sky.backends
-00000620: 2069 6d70 6f72 7420 636c 6f75 645f 766d   import cloud_vm
-00000630: 5f72 6179 5f62 6163 6b65 6e64 0a20 2020  _ray_backend.   
-00000640: 2066 726f 6d20 736b 792e 6261 636b 656e   from sky.backen
-00000650: 6473 2069 6d70 6f72 7420 6c6f 6361 6c5f  ds import local_
-00000660: 646f 636b 6572 5f62 6163 6b65 6e64 0a0a  docker_backend..
-00000670: 6c6f 6767 6572 203d 2073 6b79 5f6c 6f67  logger = sky_log
-00000680: 6769 6e67 2e69 6e69 745f 6c6f 6767 6572  ging.init_logger
-00000690: 285f 5f6e 616d 655f 5f29 0a0a 2320 4e4f  (__name__)..# NO
-000006a0: 5445 3a20 6b65 6570 2069 6e20 7379 6e63  TE: keep in sync
-000006b0: 2077 6974 6820 7468 6520 636c 7573 7465   with the cluste
-000006c0: 7220 7465 6d70 6c61 7465 2027 6669 6c65  r template 'file
-000006d0: 5f6d 6f75 6e74 7327 2e0a 534b 595f 5245  _mounts'..SKY_RE
-000006e0: 4d4f 5445 5f41 5050 5f44 4952 203d 2027  MOTE_APP_DIR = '
-000006f0: 7e2f 2e73 6b79 2f73 6b79 5f61 7070 270a  ~/.sky/sky_app'.
-00000700: 2320 4578 636c 7564 6520 7375 626e 6574  # Exclude subnet
-00000710: 206d 6173 6b20 6672 6f6d 2049 5020 6164   mask from IP ad
-00000720: 6472 6573 7320 7265 6765 782e 0a49 505f  dress regex..IP_
-00000730: 4144 4452 5f52 4547 4558 203d 2072 275c  ADDR_REGEX = r'\
-00000740: 625c 647b 312c 337d 5c2e 5c64 7b31 2c33  b\d{1,3}\.\d{1,3
-00000750: 7d5c 2e5c 647b 312c 337d 5c2e 5c64 7b31  }\.\d{1,3}\.\d{1
-00000760: 2c33 7d28 3f21 2f5c 647b 312c 327d 295c  ,3}(?!/\d{1,2})\
-00000770: 6227 0a53 4b59 5f52 454d 4f54 455f 5041  b'.SKY_REMOTE_PA
-00000780: 5448 203d 2027 7e2f 2e73 6b79 2f77 6865  TH = '~/.sky/whe
-00000790: 656c 7327 0a53 4b59 5f55 5345 525f 4649  els'.SKY_USER_FI
-000007a0: 4c45 5f50 4154 4820 3d20 277e 2f2e 736b  LE_PATH = '~/.sk
-000007b0: 792f 6765 6e65 7261 7465 6427 0a0a 424f  y/generated'..BO
-000007c0: 4c44 203d 2027 5c30 3333 5b31 6d27 0a52  LD = '\033[1m'.R
-000007d0: 4553 4554 5f42 4f4c 4420 3d20 275c 3033  ESET_BOLD = '\03
-000007e0: 335b 306d 270a 0a23 2044 6f20 6e6f 7420  3[0m'..# Do not 
-000007f0: 7573 6520 2f74 6d70 2062 6563 6175 7365  use /tmp because
-00000800: 2069 7420 6765 7473 2063 6c65 6172 6564   it gets cleared
-00000810: 206f 6e20 564d 2072 6573 7461 7274 2e0a   on VM restart..
-00000820: 5f53 4b59 5f52 454d 4f54 455f 4649 4c45  _SKY_REMOTE_FILE
-00000830: 5f4d 4f55 4e54 535f 4449 5220 3d20 277e  _MOUNTS_DIR = '~
-00000840: 2f2e 736b 792f 6669 6c65 5f6d 6f75 6e74  /.sky/file_mount
-00000850: 732f 270a 0a5f 4c41 554e 4348 4544 5f48  s/'.._LAUNCHED_H
-00000860: 4541 445f 5041 5454 4552 4e20 3d20 7265  EAD_PATTERN = re
-00000870: 2e63 6f6d 7069 6c65 2872 2728 5c64 2b29  .compile(r'(\d+)
-00000880: 2072 6179 5b2e 5f5d 6865 6164 5b2e 5f5d   ray[._]head[._]
-00000890: 6465 6661 756c 7427 290a 5f4c 4155 4e43  default')._LAUNC
-000008a0: 4845 445f 4c4f 4341 4c5f 574f 524b 4552  HED_LOCAL_WORKER
-000008b0: 5f50 4154 5445 524e 203d 2072 652e 636f  _PATTERN = re.co
-000008c0: 6d70 696c 6528 7227 285c 642b 2920 6e6f  mpile(r'(\d+) no
-000008d0: 6465 5f27 290a 5f4c 4155 4e43 4845 445f  de_')._LAUNCHED_
-000008e0: 574f 524b 4552 5f50 4154 5445 524e 203d  WORKER_PATTERN =
-000008f0: 2072 652e 636f 6d70 696c 6528 7227 285c   re.compile(r'(\
-00000900: 642b 2920 7261 795b 2e5f 5d77 6f72 6b65  d+) ray[._]worke
-00000910: 725b 2e5f 5d64 6566 6175 6c74 2729 0a5f  r[._]default')._
-00000920: 4c41 554e 4348 4544 5f52 4553 4552 5645  LAUNCHED_RESERVE
-00000930: 445f 574f 524b 4552 5f50 4154 5445 524e  D_WORKER_PATTERN
-00000940: 203d 2072 652e 636f 6d70 696c 6528 0a20   = re.compile(. 
-00000950: 2020 2072 2728 5c64 2b29 2072 6179 5b2e     r'(\d+) ray[.
-00000960: 5f5d 776f 726b 6572 5b2e 5f5d 7265 7365  _]worker[._]rese
-00000970: 7276 6564 2729 0a23 2049 6e74 656e 7469  rved').# Intenti
-00000980: 6f6e 616c 6c79 206e 6f74 2075 7369 6e67  onally not using
-00000990: 2070 7265 6669 7820 2772 6627 2066 6f72   prefix 'rf' for
-000009a0: 2074 6865 2073 7472 696e 6720 666f 726d   the string form
-000009b0: 6174 2062 6563 6175 7365 2079 6170 6620  at because yapf 
-000009c0: 6861 7665 2061 0a23 2062 7567 2077 6974  have a.# bug wit
-000009d0: 6820 7079 7468 6f6e 3d33 2e36 2e0a 2320  h python=3.6..# 
-000009e0: 3130 2e31 3333 2e30 2e35 3a20 7261 792e  10.133.0.5: ray.
-000009f0: 776f 726b 6572 2e64 6566 6175 6c74 2c0a  worker.default,.
-00000a00: 5f4c 4155 4e43 4849 4e47 5f49 505f 5041  _LAUNCHING_IP_PA
-00000a10: 5454 4552 4e20 3d20 7265 2e63 6f6d 7069  TTERN = re.compi
-00000a20: 6c65 280a 2020 2020 7227 287b 7d29 3a20  le(.    r'({}): 
-00000a30: 7261 795b 2e5f 5d77 6f72 6b65 725b 2e5f  ray[._]worker[._
-00000a40: 5d28 3f3a 6465 6661 756c 747c 7265 7365  ](?:default|rese
-00000a50: 7276 6564 2927 2e66 6f72 6d61 7428 4950  rved)'.format(IP
-00000a60: 5f41 4444 525f 5245 4745 5829 290a 5741  _ADDR_REGEX)).WA
-00000a70: 4954 5f48 4541 445f 4e4f 4445 5f49 505f  IT_HEAD_NODE_IP_
-00000a80: 4d41 585f 4154 5445 4d50 5453 203d 2033  MAX_ATTEMPTS = 3
-00000a90: 0a0a 2320 5765 2063 6865 636b 206e 6574  ..# We check net
-00000aa0: 776f 726b 2063 6f6e 6e65 6374 696f 6e20  work connection 
-00000ab0: 6279 2067 6f69 6e67 2074 6872 6f75 6768  by going through
-00000ac0: 205f 5445 5354 5f49 505f 4c49 5354 2e20   _TEST_IP_LIST. 
-00000ad0: 5765 206d 6179 206e 6565 6420 746f 0a23  We may need to.#
-00000ae0: 2063 6865 636b 206d 756c 7469 706c 6520   check multiple 
-00000af0: 4950 7320 6265 6361 7573 6520 736f 6d65  IPs because some
-00000b00: 2049 5073 206d 6179 2062 6520 626c 6f63   IPs may be bloc
-00000b10: 6b65 6420 6f6e 2063 6572 7461 696e 206e  ked on certain n
-00000b20: 6574 776f 726b 732e 0a23 2046 6978 6564  etworks..# Fixed
-00000b30: 2049 5020 6164 6472 6573 7365 7320 6172   IP addresses ar
-00000b40: 6520 7573 6564 2074 6f20 6176 6f69 6420  e used to avoid 
-00000b50: 444e 5320 6c6f 6f6b 7570 2062 6c6f 636b  DNS lookup block
-00000b60: 696e 6720 7468 6520 6368 6563 6b2c 2066  ing the check, f
-00000b70: 6f72 0a23 206d 6163 6869 6e65 2077 6974  or.# machine wit
-00000b80: 6820 6e6f 2069 6e74 6572 6e65 7420 636f  h no internet co
-00000b90: 6e6e 6563 7469 6f6e 2e0a 2320 5265 6665  nnection..# Refe
-00000ba0: 7220 746f 3a20 6874 7470 733a 2f2f 7374  r to: https://st
-00000bb0: 6163 6b6f 7665 7266 6c6f 772e 636f 6d2f  ackoverflow.com/
-00000bc0: 7175 6573 7469 6f6e 732f 3337 3634 3239  questions/376429
-00000bd0: 312f 686f 772d 6361 6e2d 692d 7365 652d  1/how-can-i-see-
-00000be0: 6966 2d74 6865 7265 732d 616e 2d61 7661  if-theres-an-ava
-00000bf0: 696c 6162 6c65 2d61 6e64 2d61 6374 6976  ilable-and-activ
-00000c00: 652d 6e65 7477 6f72 6b2d 636f 6e6e 6563  e-network-connec
-00000c10: 7469 6f6e 2d69 6e2d 7079 7468 6f6e 2023  tion-in-python #
-00000c20: 2070 796c 696e 743a 2064 6973 6162 6c65   pylint: disable
-00000c30: 3d6c 696e 652d 746f 6f2d 6c6f 6e67 0a5f  =line-too-long._
-00000c40: 5445 5354 5f49 505f 4c49 5354 203d 205b  TEST_IP_LIST = [
-00000c50: 2768 7474 7073 3a2f 2f31 2e31 2e31 2e31  'https://1.1.1.1
-00000c60: 272c 2027 6874 7470 733a 2f2f 382e 382e  ', 'https://8.8.
-00000c70: 382e 3827 5d0a 0a23 2041 6c6c 6f77 2065  8.8']..# Allow e
-00000c80: 6163 6820 4350 5520 7468 7265 6164 2074  ach CPU thread t
-00000c90: 616b 6520 3220 7461 736b 732e 0a23 204e  ake 2 tasks..# N
-00000ca0: 6f74 653a 2054 6869 7320 7661 6c75 6520  ote: This value 
-00000cb0: 6361 6e6e 6f74 2062 6520 746f 6f20 736d  cannot be too sm
-00000cc0: 616c 6c2c 206f 7468 6572 7769 7365 204f  all, otherwise O
-00000cd0: 4f4d 2069 7373 7565 206d 6179 206f 6363  OM issue may occ
-00000ce0: 7572 2e0a 4445 4641 554c 545f 5441 534b  ur..DEFAULT_TASK
-00000cf0: 5f43 5055 5f44 454d 414e 4420 3d20 302e  _CPU_DEMAND = 0.
-00000d00: 350a 0a23 2046 696c 656c 6f63 6b73 2066  5..# Filelocks f
-00000d10: 6f72 2074 6865 2063 6c75 7374 6572 2073  or the cluster s
-00000d20: 7461 7475 7320 6368 616e 6765 2e0a 434c  tatus change..CL
-00000d30: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
-00000d40: 4b5f 5041 5448 203d 206f 732e 7061 7468  K_PATH = os.path
-00000d50: 2e65 7870 616e 6475 7365 7228 277e 2f2e  .expanduser('~/.
-00000d60: 736b 792f 2e7b 7d2e 6c6f 636b 2729 0a43  sky/.{}.lock').C
-00000d70: 4c55 5354 4552 5f53 5441 5455 535f 4c4f  LUSTER_STATUS_LO
-00000d80: 434b 5f54 494d 454f 5554 5f53 4543 4f4e  CK_TIMEOUT_SECON
-00000d90: 4453 203d 2032 300a 0a23 2046 696c 656c  DS = 20..# Filel
-00000da0: 6f63 6b73 2066 6f72 2075 7064 6174 696e  ocks for updatin
-00000db0: 6720 636c 7573 7465 7227 7320 6669 6c65  g cluster's file
-00000dc0: 5f6d 6f75 6e74 732e 0a43 4c55 5354 4552  _mounts..CLUSTER
-00000dd0: 5f46 494c 455f 4d4f 554e 5453 5f4c 4f43  _FILE_MOUNTS_LOC
-00000de0: 4b5f 5041 5448 203d 206f 732e 7061 7468  K_PATH = os.path
-00000df0: 2e65 7870 616e 6475 7365 7228 0a20 2020  .expanduser(.   
-00000e00: 2027 7e2f 2e73 6b79 2f2e 7b7d 5f66 696c   '~/.sky/.{}_fil
-00000e10: 655f 6d6f 756e 7473 2e6c 6f63 6b27 290a  e_mounts.lock').
-00000e20: 434c 5553 5445 525f 4649 4c45 5f4d 4f55  CLUSTER_FILE_MOU
-00000e30: 4e54 535f 4c4f 434b 5f54 494d 454f 5554  NTS_LOCK_TIMEOUT
-00000e40: 5f53 4543 4f4e 4453 203d 2031 300a 0a23  _SECONDS = 10..#
-00000e50: 2052 656d 6f74 6520 6469 7220 7468 6174   Remote dir that
-00000e60: 2068 6f6c 6473 206f 7572 2072 756e 7469   holds our runti
-00000e70: 6d65 2066 696c 6573 2e0a 5f52 454d 4f54  me files.._REMOT
-00000e80: 455f 5255 4e54 494d 455f 4649 4c45 535f  E_RUNTIME_FILES_
-00000e90: 4449 5220 3d20 277e 2f2e 736b 792f 2e72  DIR = '~/.sky/.r
-00000ea0: 756e 7469 6d65 5f66 696c 6573 270a 0a23  untime_files'..#
-00000eb0: 2049 6e63 6c75 6465 2074 6865 2066 6965   Include the fie
-00000ec0: 6c64 7320 7468 6174 2077 696c 6c20 6265  lds that will be
-00000ed0: 2075 7365 6420 666f 7220 6765 6e65 7261   used for genera
-00000ee0: 7469 6e67 2074 6167 7320 7468 6174 2064  ting tags that d
-00000ef0: 6973 7469 6e67 7569 7368 6573 0a23 2074  istinguishes.# t
-00000f00: 6865 2063 6c75 7374 6572 2069 6e20 7261  he cluster in ra
-00000f10: 792c 2074 6f20 6176 6f69 6420 7468 6520  y, to avoid the 
-00000f20: 7374 6f70 7065 6420 636c 7573 7465 7220  stopped cluster 
-00000f30: 6265 696e 6720 6469 7363 6172 6465 6420  being discarded 
-00000f40: 6475 6520 746f 0a23 2075 7064 6174 6573  due to.# updates
-00000f50: 2069 6e20 7468 6520 7961 6d6c 2074 656d   in the yaml tem
-00000f60: 706c 6174 652e 0a23 2053 6f6d 6520 6e6f  plate..# Some no
-00000f70: 7465 7320 6f6e 2074 6865 2066 6965 6c64  tes on the field
-00000f80: 733a 0a23 202d 2027 7072 6f76 6964 6572  s:.# - 'provider
-00000f90: 2720 6669 656c 6473 2077 696c 6c20 6265  ' fields will be
-00000fa0: 2075 7365 6420 666f 7220 626f 6f74 7374   used for bootst
-00000fb0: 7261 7070 696e 6720 616e 6420 696e 7365  rapping and inse
-00000fc0: 7274 206d 6f72 6520 6e65 7720 6974 656d  rt more new item
-00000fd0: 730a 2320 2020 696e 2027 6e6f 6465 5f63  s.#   in 'node_c
-00000fe0: 6f6e 6669 6727 2e0a 2320 2d20 6b65 6570  onfig'..# - keep
-00000ff0: 696e 6720 7468 6520 6175 7468 2069 7320  ing the auth is 
-00001000: 6e6f 7420 656e 6f75 6768 2062 6563 7561  not enough becua
-00001010: 7365 2074 6865 2063 6f6e 7465 6e74 206f  se the content o
-00001020: 6620 7468 6520 6b65 7920 6669 6c65 2077  f the key file w
-00001030: 696c 6c20 6265 0a23 2020 2075 7365 6420  ill be.#   used 
-00001040: 666f 7220 6361 6c63 756c 6174 696e 6720  for calculating 
-00001050: 7468 6520 6861 7368 2e0a 2320 544f 444f  the hash..# TODO
-00001060: 287a 6877 7529 3a20 4b65 6570 2069 6e20  (zhwu): Keep in 
-00001070: 7379 6e63 2077 6974 6820 7468 6520 6669  sync with the fi
-00001080: 656c 6473 2075 7365 6420 696e 2068 7474  elds used in htt
-00001090: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-000010a0: 7261 792d 7072 6f6a 6563 742f 7261 792f  ray-project/ray/
-000010b0: 626c 6f62 2f65 3463 6533 3864 3030 3164  blob/e4ce38d001d
-000010c0: 6262 6530 3963 6432 3163 3439 3766 6564  bbe09cd21c497fed
-000010d0: 6430 3364 3639 3262 3262 6533 652f 7079  d03d692b2be3e/py
-000010e0: 7468 6f6e 2f72 6179 2f61 7574 6f73 6361  thon/ray/autosca
-000010f0: 6c65 722f 5f70 7269 7661 7465 2f63 6f6d  ler/_private/com
-00001100: 6d61 6e64 732e 7079 234c 3638 372d 4c37  mands.py#L687-L7
-00001110: 3031 0a5f 5241 595f 5941 4d4c 5f4b 4559  01._RAY_YAML_KEY
-00001120: 535f 544f 5f52 4553 544f 5245 5f46 4f52  S_TO_RESTORE_FOR
-00001130: 5f42 4143 4b5f 434f 4d50 4154 4942 494c  _BACK_COMPATIBIL
-00001140: 4954 5920 3d20 7b0a 2020 2020 2763 6c75  ITY = {.    'clu
-00001150: 7374 6572 5f6e 616d 6527 2c20 2770 726f  ster_name', 'pro
-00001160: 7669 6465 7227 2c20 2761 7574 6827 2c20  vider', 'auth', 
-00001170: 276e 6f64 655f 636f 6e66 6967 272c 2027  'node_config', '
-00001180: 646f 636b 6572 270a 7d0a 2320 466f 7220  docker'.}.# For 
-00001190: 7468 6573 6520 6b65 7973 2c20 646f 6e27  these keys, don'
-000011a0: 7420 7573 6520 7468 6520 6f6c 6420 7961  t use the old ya
-000011b0: 6d6c 2773 2076 6572 7369 6f6e 2061 6e64  ml's version and
-000011c0: 2069 6e73 7465 6164 2075 7365 2074 6865   instead use the
-000011d0: 206e 6577 2079 616d 6c27 732e 0a23 2020   new yaml's..#  
-000011e0: 2d20 7a6f 6e65 3a20 5468 6520 7a6f 6e65  - zone: The zone
-000011f0: 2066 6965 6c64 206f 6620 7468 6520 6f6c   field of the ol
-00001200: 6420 7961 6d6c 206d 6179 2062 6520 2731  d yaml may be '1
-00001210: 612c 3162 2c31 6327 2028 4157 5329 2077  a,1b,1c' (AWS) w
-00001220: 6869 6c65 2074 6865 2061 6374 7561 6c0a  hile the actual.
-00001230: 2320 2020 207a 6f6e 6520 6f66 2074 6865  #    zone of the
-00001240: 206c 6175 6e63 6865 6420 636c 7573 7465   launched cluste
-00001250: 7220 6973 2027 3161 272e 2049 6620 7765  r is '1a'. If we
-00001260: 2072 6573 746f 7265 2c20 7468 656e 206f   restore, then o
-00001270: 6e20 6361 7061 6369 7479 2065 7272 6f72  n capacity error
-00001280: 730a 2320 2020 2069 7427 7320 706f 7373  s.#    it's poss
-00001290: 6962 6c65 2074 6f20 6661 696c 6f76 6572  ible to failover
-000012a0: 2074 6f20 3162 2c20 7768 6963 6820 6c65   to 1b, which le
-000012b0: 6176 6573 2061 206c 6561 6b65 6420 696e  aves a leaked in
-000012c0: 7374 616e 6365 2069 6e20 3161 2e20 4865  stance in 1a. He
-000012d0: 7265 2c0a 2320 2020 2077 6520 7573 6520  re,.#    we use 
-000012e0: 7468 6520 6e65 7720 7961 6d6c 2773 207a  the new yaml's z
-000012f0: 6f6e 6520 6669 656c 642c 2077 6869 6368  one field, which
-00001300: 2069 7320 6775 6172 616e 7465 6564 2074   is guaranteed t
-00001310: 6f20 6265 2074 6865 2065 7869 7374 696e  o be the existin
-00001320: 6720 7a6f 6e65 0a23 2020 2020 2731 6127  g zone.#    '1a'
-00001330: 2e0a 2320 2d20 646f 636b 6572 5f6c 6f67  ..# - docker_log
-00001340: 696e 5f63 6f6e 6669 673a 2054 6865 2064  in_config: The d
-00001350: 6f63 6b65 725f 6c6f 6769 6e5f 636f 6e66  ocker_login_conf
-00001360: 6967 2066 6965 6c64 206f 6620 7468 6520  ig field of the 
-00001370: 6f6c 6420 7961 6d6c 206d 6179 2062 650a  old yaml may be.
-00001380: 2320 2020 6f75 7464 6174 6564 206f 7220  #   outdated or 
-00001390: 7772 6f6e 672e 2055 7365 7273 206d 6179  wrong. Users may
-000013a0: 2077 616e 7420 746f 2066 6978 2074 6865   want to fix the
-000013b0: 206c 6f67 696e 2063 6f6e 6669 6720 6966   login config if
-000013c0: 2061 2063 6c75 7374 6572 2066 6169 6c73   a cluster fails
-000013d0: 0a23 2020 2074 6f20 6c61 756e 6368 2064  .#   to launch d
-000013e0: 7565 2074 6f20 7468 6520 6c6f 6769 6e20  ue to the login 
-000013f0: 636f 6e66 6967 2e0a 2320 2d20 5573 6572  config..# - User
-00001400: 4461 7461 3a20 5468 6520 5573 6572 4461  Data: The UserDa
-00001410: 7461 2066 6965 6c64 206f 6620 7468 6520  ta field of the 
-00001420: 6f6c 6420 7961 6d6c 206d 6179 2062 6520  old yaml may be 
-00001430: 6f75 7464 6174 6564 2c20 616e 6420 7765  outdated, and we
-00001440: 2077 616e 7420 746f 0a23 2020 2075 7365   want to.#   use
-00001450: 2074 6865 206e 6577 2079 616d 6c27 7320   the new yaml's 
-00001460: 5573 6572 4461 7461 2066 6965 6c64 2c20  UserData field, 
-00001470: 7768 6963 6820 636f 6e74 6169 6e73 2074  which contains t
-00001480: 6865 2061 7574 686f 7269 7a65 6420 6b65  he authorized ke
-00001490: 7920 7365 7475 7020 6173 0a23 2020 2077  y setup as.#   w
-000014a0: 656c 6c20 6173 2074 6865 2064 6973 6162  ell as the disab
-000014b0: 6c69 6e67 206f 6620 7468 6520 6175 746f  ling of the auto
-000014c0: 2d75 7064 6174 6520 7769 7468 2061 7074  -update with apt
-000014d0: 2d67 6574 2e0a 2320 2d20 6669 7265 7761  -get..# - firewa
-000014e0: 6c6c 5f72 756c 653a 2054 6869 7320 6973  ll_rule: This is
-000014f0: 2061 206e 6577 6c79 2061 6464 6564 2073   a newly added s
-00001500: 6563 7469 6f6e 2066 6f72 2067 6370 2069  ection for gcp i
-00001510: 6e20 7072 6f76 6964 6572 2073 6563 7469  n provider secti
-00001520: 6f6e 2e0a 2320 2d20 7365 6375 7269 7479  on..# - security
-00001530: 5f67 726f 7570 3a20 496e 2023 3234 3835  _group: In #2485
-00001540: 2077 6520 696e 7472 6f64 7563 6573 2074   we introduces t
-00001550: 6865 2063 6861 6e67 6564 206f 6620 7365  he changed of se
-00001560: 6375 7269 7479 2067 726f 7570 2c20 736f  curity group, so
-00001570: 2077 650a 2320 2020 7368 6f75 6c64 2074   we.#   should t
-00001580: 616b 6520 7468 6520 6c61 7465 7374 2073  ake the latest s
-00001590: 6563 7572 6974 7920 6772 6f75 7020 6e61  ecurity group na
-000015a0: 6d65 2e0a 5f52 4159 5f59 414d 4c5f 4b45  me.._RAY_YAML_KE
-000015b0: 5953 5f54 4f5f 5245 5354 4f52 455f 4558  YS_TO_RESTORE_EX
-000015c0: 4345 5054 494f 4e53 203d 205b 0a20 2020  CEPTIONS = [.   
-000015d0: 2028 2770 726f 7669 6465 7227 2c20 2761   ('provider', 'a
-000015e0: 7661 696c 6162 696c 6974 795f 7a6f 6e65  vailability_zone
-000015f0: 2729 2c0a 2020 2020 2320 436c 6f75 6473  '),.    # Clouds
-00001600: 2077 6974 6820 6e65 7720 7072 6f76 6973   with new provis
-00001610: 696f 6e65 7220 6861 7320 646f 636b 6572  ioner has docker
-00001620: 5f6c 6f67 696e 5f63 6f6e 6669 6720 696e  _login_config in
-00001630: 2074 6865 0a20 2020 2023 2064 6f63 6b65   the.    # docke
-00001640: 7220 6669 656c 642c 2069 6e73 7465 6164  r field, instead
-00001650: 206f 6620 7468 6520 7072 6f76 6964 6572   of the provider
-00001660: 2066 6965 6c64 2e0a 2020 2020 2827 646f   field..    ('do
-00001670: 636b 6572 272c 2027 646f 636b 6572 5f6c  cker', 'docker_l
-00001680: 6f67 696e 5f63 6f6e 6669 6727 292c 0a20  ogin_config'),. 
-00001690: 2020 2023 204f 7468 6572 2063 6c6f 7564     # Other cloud
-000016a0: 730a 2020 2020 2827 7072 6f76 6964 6572  s.    ('provider
-000016b0: 272c 2027 646f 636b 6572 5f6c 6f67 696e  ', 'docker_login
-000016c0: 5f63 6f6e 6669 6727 292c 0a20 2020 2028  _config'),.    (
-000016d0: 2770 726f 7669 6465 7227 2c20 2766 6972  'provider', 'fir
-000016e0: 6577 616c 6c5f 7275 6c65 2729 2c0a 2020  ewall_rule'),.  
-000016f0: 2020 2320 5450 5520 6e6f 6465 206c 6175    # TPU node lau
-00001700: 6e63 6865 6420 6265 666f 7265 2023 3239  nched before #29
-00001710: 3433 2064 6f65 7320 6e6f 7420 6861 7665  43 does not have
-00001720: 2074 6865 2060 7072 6f76 6964 6572 2e74   the `provider.t
-00001730: 7075 5f6e 6f64 6560 2073 6574 2c0a 2020  pu_node` set,.  
-00001740: 2020 2320 616e 6420 6f75 7220 6c61 7465    # and our late
-00001750: 7374 2063 6f64 6520 6e65 6564 2074 6869  st code need thi
-00001760: 7320 6669 656c 6420 746f 2062 6520 7365  s field to be se
-00001770: 7420 746f 2064 6973 7469 6e67 7569 7368  t to distinguish
-00001780: 2074 6865 206e 6f64 652c 2073 6f0a 2020   the node, so.  
-00001790: 2020 2320 7765 206e 6565 6420 746f 2074    # we need to t
-000017a0: 616b 6520 7468 6973 2066 6965 6c64 2066  ake this field f
-000017b0: 726f 6d20 7468 6520 6e65 7720 7961 6d6c  rom the new yaml
-000017c0: 2e0a 2020 2020 2827 7072 6f76 6964 6572  ..    ('provider
-000017d0: 272c 2027 7470 755f 6e6f 6465 2729 2c0a  ', 'tpu_node'),.
-000017e0: 2020 2020 2827 7072 6f76 6964 6572 272c      ('provider',
-000017f0: 2027 7365 6375 7269 7479 5f67 726f 7570   'security_group
-00001800: 272c 2027 4772 6f75 704e 616d 6527 292c  ', 'GroupName'),
-00001810: 0a20 2020 2028 2761 7661 696c 6162 6c65  .    ('available
-00001820: 5f6e 6f64 655f 7479 7065 7327 2c20 2772  _node_types', 'r
-00001830: 6179 2e68 6561 642e 6465 6661 756c 7427  ay.head.default'
-00001840: 2c20 276e 6f64 655f 636f 6e66 6967 272c  , 'node_config',
-00001850: 2027 5573 6572 4461 7461 2729 2c0a 2020   'UserData'),.  
-00001860: 2020 2827 6176 6169 6c61 626c 655f 6e6f    ('available_no
-00001870: 6465 5f74 7970 6573 272c 2027 7261 792e  de_types', 'ray.
-00001880: 776f 726b 6572 2e64 6566 6175 6c74 272c  worker.default',
-00001890: 2027 6e6f 6465 5f63 6f6e 6669 6727 2c20   'node_config', 
-000018a0: 2755 7365 7244 6174 6127 292c 0a5d 0a0a  'UserData'),.]..
-000018b0: 0a64 6566 2069 735f 6970 2873 3a20 7374  .def is_ip(s: st
-000018c0: 7229 202d 3e20 626f 6f6c 3a0a 2020 2020  r) -> bool:.    
-000018d0: 2222 2252 6574 7572 6e73 2077 6865 7468  """Returns wheth
-000018e0: 6572 2074 6869 7320 7374 7269 6e67 206d  er this string m
-000018f0: 6174 6368 6573 2049 505f 4144 4452 5f52  atches IP_ADDR_R
-00001900: 4547 4558 2e22 2222 0a20 2020 2072 6574  EGEX.""".    ret
-00001910: 7572 6e20 6c65 6e28 7265 2e66 696e 6461  urn len(re.finda
-00001920: 6c6c 2849 505f 4144 4452 5f52 4547 4558  ll(IP_ADDR_REGEX
-00001930: 2c20 7329 2920 3d3d 2031 0a0a 0a64 6566  , s)) == 1...def
-00001940: 205f 6765 745f 7961 6d6c 5f70 6174 685f   _get_yaml_path_
-00001950: 6672 6f6d 5f63 6c75 7374 6572 5f6e 616d  from_cluster_nam
-00001960: 6528 636c 7573 7465 725f 6e61 6d65 3a20  e(cluster_name: 
-00001970: 7374 722c 0a20 2020 2020 2020 2020 2020  str,.           
-00001980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001990: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
-000019a0: 3a20 7374 7220 3d20 534b 595f 5553 4552  : str = SKY_USER
-000019b0: 5f46 494c 455f 5041 5448 2920 2d3e 2073  _FILE_PATH) -> s
-000019c0: 7472 3a0a 2020 2020 6f75 7470 7574 5f70  tr:.    output_p
-000019d0: 6174 6820 3d20 7061 7468 6c69 622e 5061  ath = pathlib.Pa
-000019e0: 7468 280a 2020 2020 2020 2020 7072 6566  th(.        pref
-000019f0: 6978 292e 6578 7061 6e64 7573 6572 2829  ix).expanduser()
-00001a00: 2e72 6573 6f6c 7665 2829 202f 2066 277b  .resolve() / f'{
-00001a10: 636c 7573 7465 725f 6e61 6d65 7d2e 796d  cluster_name}.ym
-00001a20: 6c27 0a20 2020 206f 732e 6d61 6b65 6469  l'.    os.makedi
-00001a30: 7273 286f 7574 7075 745f 7061 7468 2e70  rs(output_path.p
-00001a40: 6172 656e 7473 5b30 5d2c 2065 7869 7374  arents[0], exist
-00001a50: 5f6f 6b3d 5472 7565 290a 2020 2020 7265  _ok=True).    re
-00001a60: 7475 726e 2073 7472 286f 7574 7075 745f  turn str(output_
-00001a70: 7061 7468 290a 0a0a 6465 6620 5f6f 7074  path)...def _opt
-00001a80: 696d 697a 655f 6669 6c65 5f6d 6f75 6e74  imize_file_mount
-00001a90: 7328 7961 6d6c 5f70 6174 683a 2073 7472  s(yaml_path: str
-00001aa0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00001ab0: 2222 4f70 7469 6d69 7a65 2066 696c 6520  ""Optimize file 
-00001ac0: 6d6f 756e 7473 2069 6e20 7468 6520 6769  mounts in the gi
-00001ad0: 7665 6e20 7261 7920 7961 6d6c 2066 696c  ven ray yaml fil
-00001ae0: 652e 0a0a 2020 2020 5275 6e74 696d 6520  e...    Runtime 
-00001af0: 6669 6c65 7320 6861 6e64 6c69 6e67 3a0a  files handling:.
-00001b00: 2020 2020 4c69 7374 206f 6620 7275 6e74      List of runt
-00001b10: 696d 6520 6669 6c65 7320 746f 2062 6520  ime files to be 
-00001b20: 7570 6c6f 6164 6564 2074 6f20 636c 7573  uploaded to clus
-00001b30: 7465 723a 0a20 2020 2020 202d 2079 616d  ter:.      - yam
-00001b40: 6c20 636f 6e66 6967 2028 666f 7220 6175  l config (for au
-00001b50: 746f 7374 6f70 7069 6e67 290a 2020 2020  tostopping).    
-00001b60: 2020 2d20 7768 6565 6c0a 2020 2020 2020    - wheel.      
-00001b70: 2d20 6372 6564 656e 7469 616c 730a 2020  - credentials.  
-00001b80: 2020 466f 726d 6174 2069 7320 7b64 7374    Format is {dst
-00001b90: 3a20 7372 637d 2e0a 2020 2020 2222 220a  : src}..    """.
-00001ba0: 2020 2020 7961 6d6c 5f63 6f6e 6669 6720      yaml_config 
-00001bb0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
-00001bc0: 6561 645f 7961 6d6c 2879 616d 6c5f 7061  ead_yaml(yaml_pa
-00001bd0: 7468 290a 0a20 2020 2066 696c 655f 6d6f  th)..    file_mo
-00001be0: 756e 7473 203d 2079 616d 6c5f 636f 6e66  unts = yaml_conf
-00001bf0: 6967 2e67 6574 2827 6669 6c65 5f6d 6f75  ig.get('file_mou
-00001c00: 6e74 7327 2c20 7b7d 290a 2020 2020 2320  nts', {}).    # 
-00001c10: 5265 6d6f 7665 2074 6865 2066 696c 6520  Remove the file 
-00001c20: 6d6f 756e 7473 2061 6464 6564 2062 7920  mounts added by 
-00001c30: 7468 6520 6e65 776c 696e 652e 0a20 2020  the newline..   
-00001c40: 2069 6620 2727 2069 6e20 6669 6c65 5f6d   if '' in file_m
-00001c50: 6f75 6e74 733a 0a20 2020 2020 2020 2061  ounts:.        a
-00001c60: 7373 6572 7420 6669 6c65 5f6d 6f75 6e74  ssert file_mount
-00001c70: 735b 2727 5d20 3d3d 2027 272c 2066 696c  s[''] == '', fil
-00001c80: 655f 6d6f 756e 7473 5b27 275d 0a20 2020  e_mounts[''].   
-00001c90: 2020 2020 2066 696c 655f 6d6f 756e 7473       file_mounts
-00001ca0: 2e70 6f70 2827 2729 0a0a 2020 2020 2320  .pop('')..    # 
-00001cb0: 5075 7474 696e 6720 7468 6573 6520 696e  Putting these in
-00001cc0: 2066 696c 655f 6d6f 756e 7473 2068 7572   file_mounts hur
-00001cd0: 7473 2070 726f 7669 7369 6f6e 696e 6720  ts provisioning 
-00001ce0: 7370 6565 642c 2061 7320 6561 6368 2066  speed, as each f
-00001cf0: 696c 650a 2020 2020 2320 6f70 656e 732f  ile.    # opens/
-00001d00: 636c 6f73 6573 2061 6e20 5353 4820 636f  closes an SSH co
-00001d10: 6e6e 6563 7469 6f6e 2e20 2049 6e73 7465  nnection.  Inste
-00001d20: 6164 2c20 7765 3a0a 2020 2020 2320 202d  ad, we:.    #  -
-00001d30: 2063 7020 7468 656d 206c 6f63 616c 6c79   cp them locally
-00001d40: 2069 6e74 6f20 6120 6469 7265 6374 6f72   into a director
-00001d50: 792c 2065 6163 6820 7769 7468 2061 2075  y, each with a u
-00001d60: 6e69 7175 6520 6e61 6d65 2074 6f20 6176  nique name to av
-00001d70: 6f69 640a 2020 2020 2320 2020 2062 6173  oid.    #    bas
-00001d80: 656e 616d 6520 636f 6e66 6c69 6374 730a  ename conflicts.
-00001d90: 2020 2020 2320 202d 2075 706c 6f61 6420      #  - upload 
-00001da0: 7468 6174 2064 6972 6563 746f 7279 2061  that directory a
-00001db0: 7320 6120 6669 6c65 206d 6f75 6e74 2028  s a file mount (
-00001dc0: 3120 636f 6e6e 6563 7469 6f6e 290a 2020  1 connection).  
-00001dd0: 2020 2320 202d 2075 7365 2061 2072 656d    #  - use a rem
-00001de0: 6f74 6520 636f 6d6d 616e 6420 746f 206d  ote command to m
-00001df0: 6f76 6520 616c 6c20 7275 6e74 696d 6520  ove all runtime 
-00001e00: 6669 6c65 7320 746f 2074 6865 6972 2072  files to their r
-00001e10: 6967 6874 2070 6c61 6365 732e 0a0a 2020  ight places...  
-00001e20: 2020 2320 4c6f 6361 6c20 746d 7020 6469    # Local tmp di
-00001e30: 7220 686f 6c64 696e 6720 7275 6e74 696d  r holding runtim
-00001e40: 6520 6669 6c65 732e 0a20 2020 206c 6f63  e files..    loc
-00001e50: 616c 5f72 756e 7469 6d65 5f66 696c 6573  al_runtime_files
-00001e60: 5f64 6972 203d 2074 656d 7066 696c 652e  _dir = tempfile.
-00001e70: 6d6b 6474 656d 7028 290a 2020 2020 6e65  mkdtemp().    ne
-00001e80: 775f 6669 6c65 5f6d 6f75 6e74 7320 3d20  w_file_mounts = 
-00001e90: 7b5f 5245 4d4f 5445 5f52 554e 5449 4d45  {_REMOTE_RUNTIME
-00001ea0: 5f46 494c 4553 5f44 4952 3a20 6c6f 6361  _FILES_DIR: loca
-00001eb0: 6c5f 7275 6e74 696d 655f 6669 6c65 735f  l_runtime_files_
-00001ec0: 6469 727d 0a0a 2020 2020 2320 4765 6e65  dir}..    # Gene
-00001ed0: 7261 7465 206c 6f63 616c 5f73 7263 202d  rate local_src -
-00001ee0: 3e20 756e 6971 7565 5f6e 616d 652e 0a20  > unique_name.. 
-00001ef0: 2020 206c 6f63 616c 5f73 6f75 7263 655f     local_source_
-00001f00: 746f 5f75 6e69 7175 655f 6e61 6d65 203d  to_unique_name =
-00001f10: 207b 7d0a 2020 2020 666f 7220 6c6f 6361   {}.    for loca
-00001f20: 6c5f 7372 6320 696e 2066 696c 655f 6d6f  l_src in file_mo
-00001f30: 756e 7473 2e76 616c 7565 7328 293a 0a20  unts.values():. 
-00001f40: 2020 2020 2020 206c 6f63 616c 5f73 6f75         local_sou
-00001f50: 7263 655f 746f 5f75 6e69 7175 655f 6e61  rce_to_unique_na
-00001f60: 6d65 5b6c 6f63 616c 5f73 7263 5d20 3d20  me[local_src] = 
-00001f70: 7374 7228 7575 6964 2e75 7569 6434 2829  str(uuid.uuid4()
-00001f80: 290a 0a20 2020 2023 2028 466f 7220 7265  )..    # (For re
-00001f90: 6d6f 7465 2920 4275 696c 6420 6120 636f  mote) Build a co
-00001fa0: 6d6d 616e 6420 7468 6174 2063 6f70 6965  mmand that copie
-00001fb0: 7320 7275 6e74 696d 6520 6669 6c65 7320  s runtime files 
-00001fc0: 746f 2074 6865 6972 2072 6967 6874 0a20  to their right. 
-00001fd0: 2020 2023 2064 6573 7469 6e61 7469 6f6e     # destination
-00001fe0: 732e 0a20 2020 2023 204e 4f54 453a 2077  s..    # NOTE: w
-00001ff0: 6520 636f 7079 2072 6174 6865 7220 7468  e copy rather th
-00002000: 616e 206d 6f76 652c 2062 6563 6175 7365  an move, because
-00002010: 2077 6865 6e20 6c61 756e 6368 696e 6720   when launching 
-00002020: 3e31 206e 6f64 652c 2068 6561 6420 6e6f  >1 node, head no
-00002030: 6465 0a20 2020 2023 2069 7320 6675 6c6c  de.    # is full
-00002040: 7920 7365 7420 7570 2066 6972 7374 2c20  y set up first, 
-00002050: 616e 6420 6966 206d 6f76 696e 6720 7468  and if moving th
-00002060: 656e 2068 6561 6420 6e6f 6465 2773 2066  en head node's f
-00002070: 696c 6573 2077 6f75 6c64 2061 6c72 6561  iles would alrea
-00002080: 6479 0a20 2020 2023 206d 6f76 6520 6f75  dy.    # move ou
-00002090: 7420 6f66 205f 5245 4d4f 5445 5f52 554e  t of _REMOTE_RUN
-000020a0: 5449 4d45 5f46 494c 4553 5f44 4952 2c20  TIME_FILES_DIR, 
-000020b0: 7768 6963 6820 776f 756c 6420 6361 7573  which would caus
-000020c0: 6520 7365 7474 696e 6720 7570 0a20 2020  e setting up.   
-000020d0: 2023 2077 6f72 6b65 7273 2028 6672 6f6d   # workers (from
-000020e0: 2074 6865 2068 6561 6427 7320 6669 6c65   the head's file
-000020f0: 7329 2074 6f20 6661 696c 2e20 2041 6e20  s) to fail.  An 
-00002100: 616c 7465 726e 6174 6976 6520 6973 2073  alternative is s
-00002110: 6f66 746c 696e 6b0a 2020 2020 2320 2874  oftlink.    # (t
-00002120: 6865 6e20 7765 206e 6565 6420 746f 206d  hen we need to m
-00002130: 616b 6520 7375 7265 2074 6865 2075 7361  ake sure the usa
-00002140: 6765 206f 6620 7275 6e74 696d 6520 6669  ge of runtime fi
-00002150: 6c65 7320 666f 6c6c 6f77 206c 696e 6b73  les follow links
-00002160: 292e 0a20 2020 2063 6f6d 6d61 6e64 7320  )..    commands 
-00002170: 3d20 5b5d 0a20 2020 2062 6173 656e 616d  = [].    basenam
-00002180: 6573 203d 2073 6574 2829 0a20 2020 2066  es = set().    f
-00002190: 6f72 2064 7374 2c20 7372 6320 696e 2066  or dst, src in f
-000021a0: 696c 655f 6d6f 756e 7473 2e69 7465 6d73  ile_mounts.items
-000021b0: 2829 3a0a 2020 2020 2020 2020 7372 635f  ():.        src_
-000021c0: 6261 7365 6e61 6d65 203d 206c 6f63 616c  basename = local
-000021d0: 5f73 6f75 7263 655f 746f 5f75 6e69 7175  _source_to_uniqu
-000021e0: 655f 6e61 6d65 5b73 7263 5d0a 2020 2020  e_name[src].    
-000021f0: 2020 2020 6473 745f 6261 7365 6e61 6d65      dst_basename
-00002200: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-00002210: 616d 6528 6473 7429 0a20 2020 2020 2020  ame(dst).       
-00002220: 2064 7374 5f70 6172 656e 745f 6469 7220   dst_parent_dir 
-00002230: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-00002240: 6528 6473 7429 0a0a 2020 2020 2020 2020  e(dst)..        
-00002250: 2320 5661 6c69 6461 7465 2062 7920 6173  # Validate by as
-00002260: 7365 7274 7320 6865 7265 2061 7320 7468  serts here as th
-00002270: 6573 6520 6669 6c65 7320 6172 6520 6164  ese files are ad
-00002280: 6465 6420 6279 206f 7572 2062 6163 6b65  ded by our backe
-00002290: 6e64 2e0a 2020 2020 2020 2020 2320 4f75  nd..        # Ou
-000022a0: 7220 7275 6e74 696d 6520 6669 6c65 7320  r runtime files 
-000022b0: 2877 6865 656c 2c20 7961 6d6c 2c20 6372  (wheel, yaml, cr
-000022c0: 6564 656e 7469 616c 7329 2064 6f20 6e6f  edentials) do no
-000022d0: 7420 6861 7665 2062 6163 6b73 6c61 7368  t have backslash
-000022e0: 6573 2e0a 2020 2020 2020 2020 6173 7365  es..        asse
-000022f0: 7274 206e 6f74 2073 7263 2e65 6e64 7377  rt not src.endsw
-00002300: 6974 6828 272f 2729 2c20 7372 630a 2020  ith('/'), src.  
-00002310: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00002320: 2064 7374 2e65 6e64 7377 6974 6828 272f   dst.endswith('/
-00002330: 2729 2c20 6473 740a 2020 2020 2020 2020  '), dst.        
-00002340: 6173 7365 7274 2073 7263 5f62 6173 656e  assert src_basen
-00002350: 616d 6520 6e6f 7420 696e 2062 6173 656e  ame not in basen
-00002360: 616d 6573 2c20 280a 2020 2020 2020 2020  ames, (.        
-00002370: 2020 2020 6627 4475 706c 6963 6174 6564      f'Duplicated
-00002380: 2073 7263 2062 6173 656e 616d 653a 207b   src basename: {
-00002390: 7372 635f 6261 7365 6e61 6d65 7d3b 206d  src_basename}; m
-000023a0: 6f75 6e74 733a 207b 6669 6c65 5f6d 6f75  ounts: {file_mou
-000023b0: 6e74 737d 2729 0a20 2020 2020 2020 2062  nts}').        b
-000023c0: 6173 656e 616d 6573 2e61 6464 2873 7263  asenames.add(src
-000023d0: 5f62 6173 656e 616d 6529 0a20 2020 2020  _basename).     
-000023e0: 2020 2023 204f 7572 2072 756e 7469 6d65     # Our runtime
-000023f0: 2066 696c 6573 2028 7768 6565 6c2c 2079   files (wheel, y
-00002400: 616d 6c2c 2063 7265 6465 6e74 6961 6c73  aml, credentials
-00002410: 2920 6172 6520 6e6f 7420 7265 6c61 7469  ) are not relati
-00002420: 7665 2070 6174 6873 2e0a 2020 2020 2020  ve paths..      
-00002430: 2020 6173 7365 7274 2064 7374 5f70 6172    assert dst_par
-00002440: 656e 745f 6469 722c 2066 2746 6f75 6e64  ent_dir, f'Found
-00002450: 2072 656c 6174 6976 6520 6465 7374 696e   relative destin
-00002460: 6174 696f 6e20 7061 7468 3a20 7b64 7374  ation path: {dst
-00002470: 7d27 0a0a 2020 2020 2020 2020 6d6b 6469  }'..        mkdi
-00002480: 725f 7061 7265 6e74 203d 2066 276d 6b64  r_parent = f'mkd
-00002490: 6972 202d 7020 7b64 7374 5f70 6172 656e  ir -p {dst_paren
-000024a0: 745f 6469 727d 270a 2020 2020 2020 2020  t_dir}'.        
-000024b0: 6966 206f 732e 7061 7468 2e69 7364 6972  if os.path.isdir
-000024c0: 286f 732e 7061 7468 2e65 7870 616e 6475  (os.path.expandu
-000024d0: 7365 7228 7372 6329 293a 0a20 2020 2020  ser(src)):.     
-000024e0: 2020 2020 2020 2023 2053 7065 6369 616c         # Special
-000024f0: 2063 6173 6520 666f 7220 6469 7265 6374   case for direct
-00002500: 6f72 6965 732e 2049 6620 7468 6520 6473  ories. If the ds
-00002510: 7420 616c 7265 6164 7920 6578 6973 7473  t already exists
-00002520: 2061 7320 610a 2020 2020 2020 2020 2020   as a.          
-00002530: 2020 2320 666f 6c64 6572 2c20 6469 7265    # folder, dire
-00002540: 6374 6c79 2063 6f70 7920 7468 6520 666f  ctly copy the fo
-00002550: 6c64 6572 2077 696c 6c20 6372 6561 7465  lder will create
-00002560: 2061 2073 7562 666f 6c64 6572 2075 6e64   a subfolder und
-00002570: 6572 0a20 2020 2020 2020 2020 2020 2023  er.            #
-00002580: 2074 6865 2064 7374 2e0a 2020 2020 2020   the dst..      
-00002590: 2020 2020 2020 6d6b 6469 725f 7061 7265        mkdir_pare
-000025a0: 6e74 203d 2066 276d 6b64 6972 202d 7020  nt = f'mkdir -p 
-000025b0: 7b64 7374 7d27 0a20 2020 2020 2020 2020  {dst}'.         
-000025c0: 2020 2073 7263 5f62 6173 656e 616d 6520     src_basename 
-000025d0: 3d20 6627 7b73 7263 5f62 6173 656e 616d  = f'{src_basenam
-000025e0: 657d 2f2a 270a 2020 2020 2020 2020 6d76  e}/*'.        mv
-000025f0: 203d 2028 6627 6370 202d 7220 7b5f 5245   = (f'cp -r {_RE
-00002600: 4d4f 5445 5f52 554e 5449 4d45 5f46 494c  MOTE_RUNTIME_FIL
-00002610: 4553 5f44 4952 7d2f 7b73 7263 5f62 6173  ES_DIR}/{src_bas
-00002620: 656e 616d 657d 2027 0a20 2020 2020 2020  ename} '.       
-00002630: 2020 2020 2020 2066 277b 6473 745f 7061         f'{dst_pa
-00002640: 7265 6e74 5f64 6972 7d2f 7b64 7374 5f62  rent_dir}/{dst_b
-00002650: 6173 656e 616d 657d 2729 0a20 2020 2020  asename}').     
-00002660: 2020 2066 7261 676d 656e 7420 3d20 6627     fragment = f'
-00002670: 287b 6d6b 6469 725f 7061 7265 6e74 7d20  ({mkdir_parent} 
-00002680: 2626 207b 6d76 7d29 270a 2020 2020 2020  && {mv})'.      
-00002690: 2020 636f 6d6d 616e 6473 2e61 7070 656e    commands.appen
-000026a0: 6428 6672 6167 6d65 6e74 290a 2020 2020  d(fragment).    
-000026b0: 706f 7374 7072 6f63 6573 735f 7275 6e74  postprocess_runt
-000026c0: 696d 655f 6669 6c65 735f 636f 6d6d 616e  ime_files_comman
-000026d0: 6420 3d20 2720 2626 2027 2e6a 6f69 6e28  d = ' && '.join(
-000026e0: 636f 6d6d 616e 6473 290a 0a20 2020 2073  commands)..    s
-000026f0: 6574 7570 5f63 6f6d 6d61 6e64 7320 3d20  etup_commands = 
-00002700: 7961 6d6c 5f63 6f6e 6669 672e 6765 7428  yaml_config.get(
-00002710: 2773 6574 7570 5f63 6f6d 6d61 6e64 7327  'setup_commands'
-00002720: 2c20 5b5d 290a 2020 2020 6966 2073 6574  , []).    if set
-00002730: 7570 5f63 6f6d 6d61 6e64 733a 0a20 2020  up_commands:.   
-00002740: 2020 2020 2073 6574 7570 5f63 6f6d 6d61       setup_comma
-00002750: 6e64 735b 0a20 2020 2020 2020 2020 2020  nds[.           
-00002760: 2030 5d20 3d20 6627 7b70 6f73 7470 726f   0] = f'{postpro
-00002770: 6365 7373 5f72 756e 7469 6d65 5f66 696c  cess_runtime_fil
-00002780: 6573 5f63 6f6d 6d61 6e64 7d3b 207b 7365  es_command}; {se
-00002790: 7475 705f 636f 6d6d 616e 6473 5b30 5d7d  tup_commands[0]}
-000027a0: 270a 2020 2020 656c 7365 3a0a 2020 2020  '.    else:.    
-000027b0: 2020 2020 7365 7475 705f 636f 6d6d 616e      setup_comman
-000027c0: 6473 203d 205b 706f 7374 7072 6f63 6573  ds = [postproces
-000027d0: 735f 7275 6e74 696d 655f 6669 6c65 735f  s_runtime_files_
-000027e0: 636f 6d6d 616e 645d 0a0a 2020 2020 7961  command]..    ya
-000027f0: 6d6c 5f63 6f6e 6669 675b 2766 696c 655f  ml_config['file_
-00002800: 6d6f 756e 7473 275d 203d 206e 6577 5f66  mounts'] = new_f
-00002810: 696c 655f 6d6f 756e 7473 0a20 2020 2079  ile_mounts.    y
-00002820: 616d 6c5f 636f 6e66 6967 5b27 7365 7475  aml_config['setu
-00002830: 705f 636f 6d6d 616e 6473 275d 203d 2073  p_commands'] = s
-00002840: 6574 7570 5f63 6f6d 6d61 6e64 730a 0a20  etup_commands.. 
-00002850: 2020 2023 2028 466f 7220 6c6f 6361 6c29     # (For local)
-00002860: 2043 6f70 7920 616c 6c20 7275 6e74 696d   Copy all runtim
-00002870: 6520 6669 6c65 732c 2069 6e63 6c75 6469  e files, includi
-00002880: 6e67 2074 6865 206a 7573 742d 7772 6974  ng the just-writ
-00002890: 7465 6e20 7961 6d6c 2c20 746f 0a20 2020  ten yaml, to.   
-000028a0: 2023 206c 6f63 616c 5f72 756e 7469 6d65   # local_runtime
-000028b0: 5f66 696c 6573 5f64 6972 2f2e 0a20 2020  _files_dir/..   
-000028c0: 2023 203c 2030 2e33 7320 746f 2063 7020   # < 0.3s to cp 
-000028d0: 3620 636c 6f75 6473 2720 6372 6564 656e  6 clouds' creden
-000028e0: 7469 616c 732e 0a20 2020 2066 6f72 206c  tials..    for l
-000028f0: 6f63 616c 5f73 7263 2069 6e20 6669 6c65  ocal_src in file
-00002900: 5f6d 6f75 6e74 732e 7661 6c75 6573 2829  _mounts.values()
-00002910: 3a0a 2020 2020 2020 2020 2320 6370 203c  :.        # cp <
-00002920: 6c6f 6361 6c5f 7372 633e 203c 6c6f 6361  local_src> <loca
-00002930: 6c5f 7275 6e74 696d 655f 6669 6c65 735f  l_runtime_files_
-00002940: 6469 723e 2f3c 756e 6971 7565 206e 616d  dir>/<unique nam
-00002950: 6520 6f66 206c 6f63 616c 5f73 7263 3e2e  e of local_src>.
-00002960: 0a20 2020 2020 2020 2066 756c 6c5f 6c6f  .        full_lo
-00002970: 6361 6c5f 7372 6320 3d20 7374 7228 7061  cal_src = str(pa
-00002980: 7468 6c69 622e 5061 7468 286c 6f63 616c  thlib.Path(local
-00002990: 5f73 7263 292e 6578 7061 6e64 7573 6572  _src).expanduser
-000029a0: 2829 290a 2020 2020 2020 2020 756e 6971  ()).        uniq
-000029b0: 7565 5f6e 616d 6520 3d20 6c6f 6361 6c5f  ue_name = local_
-000029c0: 736f 7572 6365 5f74 6f5f 756e 6971 7565  source_to_unique
-000029d0: 5f6e 616d 655b 6c6f 6361 6c5f 7372 635d  _name[local_src]
-000029e0: 0a20 2020 2020 2020 2023 2021 7220 746f  .        # !r to
-000029f0: 2061 6464 2071 756f 7465 7320 666f 7220   add quotes for 
-00002a00: 7061 7468 7320 636f 6e74 6169 6e69 6e67  paths containing
-00002a10: 2073 7061 6365 732e 0a20 2020 2020 2020   spaces..       
-00002a20: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
-00002a30: 0a20 2020 2020 2020 2020 2020 2066 2763  .            f'c
-00002a40: 7020 2d72 207b 6675 6c6c 5f6c 6f63 616c  p -r {full_local
-00002a50: 5f73 7263 2172 7d20 7b6c 6f63 616c 5f72  _src!r} {local_r
-00002a60: 756e 7469 6d65 5f66 696c 6573 5f64 6972  untime_files_dir
-00002a70: 7d2f 7b75 6e69 7175 655f 6e61 6d65 7d27  }/{unique_name}'
-00002a80: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
-00002a90: 656c 6c3d 5472 7565 2c0a 2020 2020 2020  ell=True,.      
-00002aa0: 2020 2020 2020 6368 6563 6b3d 5472 7565        check=True
-00002ab0: 290a 0a20 2020 2063 6f6d 6d6f 6e5f 7574  )..    common_ut
-00002ac0: 696c 732e 6475 6d70 5f79 616d 6c28 7961  ils.dump_yaml(ya
-00002ad0: 6d6c 5f70 6174 682c 2079 616d 6c5f 636f  ml_path, yaml_co
-00002ae0: 6e66 6967 290a 0a0a 6465 6620 7061 7468  nfig)...def path
-00002af0: 5f73 697a 655f 6d65 6761 6279 7465 7328  _size_megabytes(
-00002b00: 7061 7468 3a20 7374 7229 202d 3e20 696e  path: str) -> in
-00002b10: 743a 0a20 2020 2022 2222 5265 7475 726e  t:.    """Return
-00002b20: 7320 7468 6520 7369 7a65 206f 6620 2770  s the size of 'p
-00002b30: 6174 6827 2028 6469 7265 6374 6f72 7920  ath' (directory 
-00002b40: 6f72 2066 696c 6529 2069 6e20 6d65 6761  or file) in mega
-00002b50: 6279 7465 732e 0a0a 2020 2020 5265 7475  bytes...    Retu
-00002b60: 726e 733a 0a20 2020 2020 2020 2049 6620  rns:.        If 
-00002b70: 7375 6363 6573 7366 756c 3a20 7468 6520  successful: the 
-00002b80: 7369 7a65 206f 6620 2770 6174 6827 2069  size of 'path' i
-00002b90: 6e20 6d65 6761 6279 7465 732c 2072 6f75  n megabytes, rou
-00002ba0: 6e64 6564 2064 6f77 6e2e 204f 7468 6572  nded down. Other
-00002bb0: 7769 7365 2c0a 2020 2020 2020 2020 2d31  wise,.        -1
-00002bc0: 2e0a 2020 2020 2222 220a 2020 2020 7265  ..    """.    re
-00002bd0: 736f 6c76 6564 5f70 6174 6820 3d20 7061  solved_path = pa
-00002be0: 7468 6c69 622e 5061 7468 2870 6174 6829  thlib.Path(path)
-00002bf0: 2e65 7870 616e 6475 7365 7228 292e 7265  .expanduser().re
-00002c00: 736f 6c76 6528 290a 2020 2020 6769 745f  solve().    git_
-00002c10: 6578 636c 7564 655f 6669 6c74 6572 203d  exclude_filter =
-00002c20: 2027 270a 2020 2020 6966 2028 7265 736f   ''.    if (reso
-00002c30: 6c76 6564 5f70 6174 6820 2f20 636f 6d6d  lved_path / comm
-00002c40: 616e 645f 7275 6e6e 6572 2e47 4954 5f45  and_runner.GIT_E
-00002c50: 5843 4c55 4445 292e 6578 6973 7473 2829  XCLUDE).exists()
-00002c60: 3a0a 2020 2020 2020 2020 2320 456e 7375  :.        # Ensu
-00002c70: 7265 2066 696c 6520 6578 6973 7473 3b20  re file exists; 
-00002c80: 6f74 6865 7277 6973 652c 2072 7379 6e63  otherwise, rsync
-00002c90: 2077 696c 6c20 6572 726f 7220 6f75 742e   will error out.
-00002ca0: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
-00002cb0: 2020 2023 2057 6520 7368 6c65 782e 7175     # We shlex.qu
-00002cc0: 6f74 6528 2920 6265 6361 7573 6520 7468  ote() because th
-00002cd0: 6520 7061 7468 206d 6179 2063 6f6e 7461  e path may conta
-00002ce0: 696e 2073 7061 6365 733a 0a20 2020 2020  in spaces:.     
-00002cf0: 2020 2023 2020 2027 6d79 2064 6972 2f2e     #   'my dir/.
-00002d00: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
-00002d10: 270a 2020 2020 2020 2020 2320 5769 7468  '.        # With
-00002d20: 6f75 7420 7175 6f74 696e 6720 7273 796e  out quoting rsyn
-00002d30: 6320 6661 696c 732e 0a20 2020 2020 2020  c fails..       
-00002d40: 2067 6974 5f65 7863 6c75 6465 5f66 696c   git_exclude_fil
-00002d50: 7465 7220 3d20 636f 6d6d 616e 645f 7275  ter = command_ru
-00002d60: 6e6e 6572 2e52 5359 4e43 5f45 5843 4c55  nner.RSYNC_EXCLU
-00002d70: 4445 5f4f 5054 494f 4e2e 666f 726d 6174  DE_OPTION.format
-00002d80: 280a 2020 2020 2020 2020 2020 2020 7368  (.            sh
-00002d90: 6c65 782e 7175 6f74 6528 7374 7228 7265  lex.quote(str(re
-00002da0: 736f 6c76 6564 5f70 6174 6820 2f20 636f  solved_path / co
-00002db0: 6d6d 616e 645f 7275 6e6e 6572 2e47 4954  mmand_runner.GIT
-00002dc0: 5f45 5843 4c55 4445 2929 290a 2020 2020  _EXCLUDE))).    
-00002dd0: 7273 796e 635f 636f 6d6d 616e 6420 3d20  rsync_command = 
-00002de0: 2866 2772 7379 6e63 207b 636f 6d6d 616e  (f'rsync {comman
-00002df0: 645f 7275 6e6e 6572 2e52 5359 4e43 5f44  d_runner.RSYNC_D
-00002e00: 4953 504c 4159 5f4f 5054 494f 4e7d 2027  ISPLAY_OPTION} '
-00002e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002e20: 2020 2020 2020 6627 7b63 6f6d 6d61 6e64        f'{command
-00002e30: 5f72 756e 6e65 722e 5253 594e 435f 4649  _runner.RSYNC_FI
-00002e40: 4c54 4552 5f4f 5054 494f 4e7d 2027 0a20  LTER_OPTION} '. 
-00002e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e60: 2020 2020 6627 7b67 6974 5f65 7863 6c75      f'{git_exclu
-00002e70: 6465 5f66 696c 7465 727d 202d 2d64 7279  de_filter} --dry
-00002e80: 2d72 756e 207b 7061 7468 2172 7d27 290a  -run {path!r}').
-00002e90: 2020 2020 7273 796e 635f 6f75 7470 7574      rsync_output
-00002ea0: 203d 2027 270a 2020 2020 7472 793a 0a20   = ''.    try:. 
-00002eb0: 2020 2020 2020 2072 7379 6e63 5f6f 7574         rsync_out
-00002ec0: 7075 7420 3d20 7374 7228 7375 6270 726f  put = str(subpro
-00002ed0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00002ee0: 7428 7273 796e 635f 636f 6d6d 616e 642c  t(rsync_command,
-00002ef0: 2073 6865 6c6c 3d54 7275 6529 290a 2020   shell=True)).  
-00002f00: 2020 6578 6365 7074 2073 7562 7072 6f63    except subproc
-00002f10: 6573 732e 4361 6c6c 6564 5072 6f63 6573  ess.CalledProces
-00002f20: 7345 7272 6f72 3a0a 2020 2020 2020 2020  sError:.        
-00002f30: 6c6f 6767 6572 2e64 6562 7567 2827 436f  logger.debug('Co
-00002f40: 6d6d 616e 6420 6661 696c 6564 2c20 7072  mmand failed, pr
-00002f50: 6f63 6565 6469 6e67 2077 6974 686f 7574  oceeding without
-00002f60: 2065 7374 696d 6174 696e 6720 7369 7a65   estimating size
-00002f70: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
-00002f80: 2020 2020 2020 2020 2066 277b 7273 796e           f'{rsyn
-00002f90: 635f 636f 6d6d 616e 647d 2729 0a20 2020  c_command}').   
-00002fa0: 2020 2020 2072 6574 7572 6e20 2d31 0a20       return -1. 
-00002fb0: 2020 2023 2033 2e32 2e33 3a0a 2020 2020     # 3.2.3:.    
-00002fc0: 2320 2074 6f74 616c 2073 697a 6520 6973  #  total size is
-00002fd0: 2032 3530 2c39 3537 2c37 3238 2020 7370   250,957,728  sp
-00002fe0: 6565 6475 7020 6973 2033 3330 2e31 3920  eedup is 330.19 
-00002ff0: 2844 5259 2052 554e 290a 2020 2020 2320  (DRY RUN).    # 
-00003000: 322e 362e 393a 0a20 2020 2023 2020 746f  2.6.9:.    #  to
-00003010: 7461 6c20 7369 7a65 2069 7320 3231 3236  tal size is 2126
-00003020: 3237 3535 3620 2073 7065 6564 7570 2069  27556  speedup i
-00003030: 7320 3234 3337 2e34 310a 2020 2020 6d61  s 2437.41.    ma
-00003040: 7463 6820 3d20 7265 2e73 6561 7263 6828  tch = re.search(
-00003050: 7227 746f 7461 6c20 7369 7a65 2069 7320  r'total size is 
-00003060: 285b 5c64 2c5d 2b29 272c 2072 7379 6e63  ([\d,]+)', rsync
-00003070: 5f6f 7574 7075 7429 0a20 2020 2069 6620  _output).    if 
-00003080: 6d61 7463 6820 6973 206e 6f74 204e 6f6e  match is not Non
-00003090: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
-000030a0: 2020 2020 2020 2020 2020 2020 746f 7461              tota
-000030b0: 6c5f 6279 7465 7320 3d20 696e 7428 666c  l_bytes = int(fl
-000030c0: 6f61 7428 6d61 7463 682e 6772 6f75 7028  oat(match.group(
-000030d0: 3129 2e72 6570 6c61 6365 2827 2c27 2c20  1).replace(',', 
-000030e0: 2727 2929 290a 2020 2020 2020 2020 2020  ''))).          
-000030f0: 2020 7265 7475 726e 2074 6f74 616c 5f62    return total_b
-00003100: 7974 6573 202f 2f20 2831 3032 342a 2a32  ytes // (1024**2
-00003110: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00003120: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
-00003130: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00003140: 6465 6275 6728 2746 6169 6c65 6420 746f  debug('Failed to
-00003150: 2066 696e 6420 2274 6f74 616c 2073 697a   find "total siz
-00003160: 6522 2069 6e20 7273 796e 6320 6f75 7470  e" in rsync outp
-00003170: 7574 2e20 496e 7370 6563 7420 270a 2020  ut. Inspect '.  
-00003180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003190: 2020 2020 2020 2066 276f 7574 7075 7420         f'output 
-000031a0: 6f66 2074 6865 2066 6f6c 6c6f 7769 6e67  of the following
-000031b0: 2063 6f6d 6d61 6e64 3a20 7b72 7379 6e63   command: {rsync
-000031c0: 5f63 6f6d 6d61 6e64 7d27 290a 2020 2020  _command}').    
-000031d0: 2020 2020 2020 2020 7061 7373 2020 2320          pass  # 
-000031e0: 4d61 7962 6520 6469 6666 6572 656e 7420  Maybe different 
-000031f0: 7273 796e 6320 7665 7273 696f 6e73 2068  rsync versions h
-00003200: 6176 6520 6469 6666 6572 656e 7420 6f75  ave different ou
-00003210: 7470 7574 2e0a 2020 2020 7265 7475 726e  tput..    return
-00003220: 202d 310a 0a0a 636c 6173 7320 4669 6c65   -1...class File
-00003230: 4d6f 756e 7448 656c 7065 7228 6f62 6a65  MountHelper(obje
-00003240: 6374 293a 0a20 2020 2022 2222 4865 6c70  ct):.    """Help
-00003250: 6572 2066 6f72 2068 616e 646c 696e 6720  er for handling 
-00003260: 6669 6c65 206d 6f75 6e74 732e 2222 220a  file mounts.""".
-00003270: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-00003280: 640a 2020 2020 6465 6620 7772 6170 5f66  d.    def wrap_f
-00003290: 696c 655f 6d6f 756e 7428 636c 732c 2070  ile_mount(cls, p
-000032a0: 6174 683a 2073 7472 2920 2d3e 2073 7472  ath: str) -> str
-000032b0: 3a0a 2020 2020 2020 2020 2222 2250 7265  :.        """Pre
-000032c0: 7065 6e64 7320 7e2f 3c6f 7061 7175 6520  pends ~/<opaque 
-000032d0: 6469 723e 2f20 746f 2061 2070 6174 6820  dir>/ to a path 
-000032e0: 746f 2077 6f72 6b20 6172 6f75 6e64 2070  to work around p
-000032f0: 6572 6d69 7373 696f 6e20 6973 7375 6573  ermission issues
-00003300: 2e0a 0a20 2020 2020 2020 2045 7861 6d70  ...        Examp
-00003310: 6c65 733a 0a20 2020 2020 2020 202f 726f  les:.        /ro
-00003320: 6f74 2f68 656c 6c6f 2e74 7874 202d 3e20  ot/hello.txt -> 
-00003330: 7e2f 3c6f 7061 7175 6520 6469 723e 2f72  ~/<opaque dir>/r
-00003340: 6f6f 742f 6865 6c6c 6f2e 7478 740a 2020  oot/hello.txt.  
-00003350: 2020 2020 2020 6c6f 6361 6c2e 7478 7420        local.txt 
-00003360: 2d3e 207e 2f3c 6f70 6171 7565 2064 6972  -> ~/<opaque dir
-00003370: 3e2f 6c6f 6361 6c2e 7478 740a 0a20 2020  >/local.txt..   
-00003380: 2020 2020 2041 6674 6572 2074 6865 2070       After the p
-00003390: 6174 6820 6973 2073 796e 6365 642c 2077  ath is synced, w
-000033a0: 6520 6361 6e20 6c61 7465 7220 6372 6561  e can later crea
-000033b0: 7465 2061 2073 796d 6c69 6e6b 2074 6f20  te a symlink to 
-000033c0: 7468 6973 2077 7261 7070 6564 0a20 2020  this wrapped.   
-000033d0: 2020 2020 2070 6174 6820 6672 6f6d 2074       path from t
-000033e0: 6865 206f 7269 6769 6e61 6c20 7061 7468  he original path
-000033f0: 2c20 652e 672e 2c20 696e 2074 6865 2069  , e.g., in the i
-00003400: 6e69 7469 616c 697a 6174 696f 6e5f 636f  nitialization_co
-00003410: 6d6d 616e 6473 206f 6620 7468 650a 2020  mmands of the.  
-00003420: 2020 2020 2020 7261 7920 6175 746f 7363        ray autosc
-00003430: 616c 6572 2059 414d 4c2e 0a20 2020 2020  aler YAML..     
-00003440: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00003450: 6574 7572 6e20 6f73 2e70 6174 682e 6a6f  eturn os.path.jo
-00003460: 696e 285f 534b 595f 5245 4d4f 5445 5f46  in(_SKY_REMOTE_F
-00003470: 494c 455f 4d4f 554e 5453 5f44 4952 2c20  ILE_MOUNTS_DIR, 
-00003480: 7061 7468 2e6c 7374 7269 7028 272f 2729  path.lstrip('/')
-00003490: 290a 0a20 2020 2040 636c 6173 736d 6574  )..    @classmet
-000034a0: 686f 640a 2020 2020 6465 6620 6d61 6b65  hod.    def make
-000034b0: 5f73 6166 655f 7379 6d6c 696e 6b5f 636f  _safe_symlink_co
-000034c0: 6d6d 616e 6428 636c 732c 202a 2c20 736f  mmand(cls, *, so
-000034d0: 7572 6365 3a20 7374 722c 2074 6172 6765  urce: str, targe
-000034e0: 743a 2073 7472 2920 2d3e 2073 7472 3a0a  t: str) -> str:.
-000034f0: 2020 2020 2020 2020 2222 2252 6574 7572          """Retur
-00003500: 6e73 2061 2063 6f6d 6d61 6e64 2074 6861  ns a command tha
-00003510: 7420 7361 6665 6c79 2073 796d 6c69 6e6b  t safely symlink
-00003520: 7320 2773 6f75 7263 6527 2074 6f20 2774  s 'source' to 't
-00003530: 6172 6765 7427 2e0a 0a20 2020 2020 2020  arget'...       
-00003540: 2041 6c6c 2069 6e74 6572 6d65 6469 6174   All intermediat
-00003550: 6520 6469 7265 6374 6f72 6965 7320 6f66  e directories of
-00003560: 2027 736f 7572 6365 2720 7769 6c6c 2062   'source' will b
-00003570: 6520 6f77 6e65 6420 6279 2024 5553 4552  e owned by $USER
-00003580: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
-00003590: 696e 6720 7468 6520 726f 6f74 2064 6972  ing the root dir
-000035a0: 6563 746f 7279 2028 2f29 2e0a 0a20 2020  ectory (/)...   
-000035b0: 2020 2020 2027 736f 7572 6365 2720 6d75       'source' mu
-000035c0: 7374 2062 6520 616e 2061 6273 6f6c 7574  st be an absolut
-000035d0: 6520 7061 7468 3b20 626f 7468 2027 736f  e path; both 'so
-000035e0: 7572 6365 2720 616e 6420 2774 6172 6765  urce' and 'targe
-000035f0: 7427 206d 7573 7420 6e6f 740a 2020 2020  t' must not.    
-00003600: 2020 2020 656e 6420 7769 7468 2061 2073      end with a s
-00003610: 6c61 7368 2028 2f29 2e0a 0a20 2020 2020  lash (/)...     
-00003620: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-00003630: 2069 7320 6e65 6564 6564 2062 6563 6175   is needed becau
-00003640: 7365 2061 2073 696d 706c 6520 276c 6e20  se a simple 'ln 
-00003650: 2d73 2074 6172 6765 7420 736f 7572 6365  -s target source
-00003660: 2720 6d61 790a 2020 2020 2020 2020 6661  ' may.        fa
-00003670: 696c 3a20 2773 6f75 7263 6527 2063 616e  il: 'source' can
-00003680: 2068 6176 6520 6d75 6c74 6970 6c65 206c   have multiple l
-00003690: 6576 656c 7320 282f 612f 622f 6329 2c20  evels (/a/b/c), 
-000036a0: 6974 7320 7061 7265 6e74 2064 6972 7320  its parent dirs 
-000036b0: 6d61 790a 2020 2020 2020 2020 6f72 206d  may.        or m
-000036c0: 6179 206e 6f74 2065 7869 7374 2c20 6361  ay not exist, ca
-000036d0: 6e20 656e 6420 7769 7468 2061 2073 6c61  n end with a sla
-000036e0: 7368 2c20 6f72 206d 6179 206e 6565 6420  sh, or may need 
-000036f0: 7375 646f 2061 6363 6573 732c 2065 7463  sudo access, etc
-00003700: 2e0a 0a20 2020 2020 2020 2043 6173 6573  ...        Cases
-00003710: 206f 6620 3c74 6172 6765 743a 206c 6f63   of <target: loc
-00003720: 616c 3e20 6669 6c65 206d 6f75 6e74 7320  al> file mounts 
-00003730: 616e 6420 7468 6569 7220 6265 6861 7669  and their behavi
-00003740: 6f72 733a 0a0a 2020 2020 2020 2020 2020  ors:..          
-00003750: 2020 2f65 7869 7374 696e 675f 6469 723a    /existing_dir:
-00003760: 207e 2f6c 6f63 616c 2f64 6972 0a20 2020   ~/local/dir.   
-00003770: 2020 2020 2020 2020 2020 202d 2065 7272             - err
-00003780: 6f72 206f 7574 2073 6179 696e 6720 7468  or out saying th
-00003790: 6973 2063 616e 6e6f 7420 6265 2064 6f6e  is cannot be don
-000037a0: 6520 6173 204c 4853 2061 6c72 6561 6479  e as LHS already
-000037b0: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
-000037c0: 2020 2020 2f65 7869 7374 696e 675f 6669      /existing_fi
-000037d0: 6c65 3a20 7e2f 6c6f 6361 6c2f 6669 6c65  le: ~/local/file
-000037e0: 0a20 2020 2020 2020 2020 2020 2020 202d  .              -
-000037f0: 2065 7272 6f72 206f 7574 2073 6179 696e   error out sayin
-00003800: 6720 7468 6973 2063 616e 6e6f 7420 6265  g this cannot be
-00003810: 2064 6f6e 6520 6173 204c 4853 2061 6c72   done as LHS alr
-00003820: 6561 6479 2065 7869 7374 730a 2020 2020  eady exists.    
-00003830: 2020 2020 2020 2020 2f65 7869 7374 696e          /existin
-00003840: 675f 7379 6d6c 696e 6b3a 207e 2f6c 6f63  g_symlink: ~/loc
-00003850: 616c 2f66 696c 650a 2020 2020 2020 2020  al/file.        
-00003860: 2020 2020 2020 2d20 6f76 6572 7772 6974        - overwrit
-00003870: 6520 7468 6520 6578 6973 7469 6e67 2073  e the existing s
-00003880: 796d 6c69 6e6b 3b20 7468 6973 2069 7320  ymlink; this is 
-00003890: 696d 706f 7274 616e 7420 6265 6361 7573  important becaus
-000038a0: 6520 6073 6b79 0a20 2020 2020 2020 2020  e `sky.         
-000038b0: 2020 2020 2020 206c 6175 6e63 6860 2063         launch` c
-000038c0: 616e 2062 6520 7275 6e20 6d75 6c74 6970  an be run multip
-000038d0: 6c65 2074 696d 6573 0a20 2020 2020 2020  le times.       
-000038e0: 2020 2020 2050 6174 6873 2074 6861 7420       Paths that 
-000038f0: 7374 6172 7420 7769 7468 207e 2f20 616e  start with ~/ an
-00003900: 6420 2f74 6d70 2f20 646f 206e 6f74 2068  d /tmp/ do not h
-00003910: 6176 6520 7468 6520 6162 6f76 650a 2020  ave the above.  
-00003920: 2020 2020 2020 2020 2020 7265 7374 7269            restri
-00003930: 6374 696f 6e73 3b20 7468 6579 2061 7265  ctions; they are
-00003940: 2064 656c 6567 6174 6564 2074 6f20 7273   delegated to rs
-00003950: 796e 6320 6265 6861 7669 6f72 732e 0a20  ync behaviors.. 
-00003960: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00003970: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
-00003980: 682e 6973 6162 7328 736f 7572 6365 292c  h.isabs(source),
-00003990: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
-000039a0: 6173 7365 7274 206e 6f74 2073 6f75 7263  assert not sourc
-000039b0: 652e 656e 6473 7769 7468 2827 2f27 2920  e.endswith('/') 
-000039c0: 616e 6420 6e6f 7420 7461 7267 6574 2e65  and not target.e
-000039d0: 6e64 7377 6974 6828 272f 2729 2c20 2873  ndswith('/'), (s
-000039e0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
-000039f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000060: 7420 666e 6d61 7463 680a 696d 706f 7274  t fnmatch.import
+00000070: 2066 756e 6374 6f6f 6c73 0a69 6d70 6f72   functools.impor
+00000080: 7420 6f73 0a69 6d70 6f72 7420 7061 7468  t os.import path
+00000090: 6c69 620a 696d 706f 7274 2070 7072 696e  lib.import pprin
+000000a0: 740a 696d 706f 7274 2072 650a 696d 706f  t.import re.impo
+000000b0: 7274 2073 686c 6578 0a69 6d70 6f72 7420  rt shlex.import 
+000000c0: 7375 6270 726f 6365 7373 0a69 6d70 6f72  subprocess.impor
+000000d0: 7420 7379 730a 696d 706f 7274 2074 656d  t sys.import tem
+000000e0: 7066 696c 650a 696d 706f 7274 2074 6578  pfile.import tex
+000000f0: 7477 7261 700a 696d 706f 7274 2074 696d  twrap.import tim
+00000100: 650a 696d 706f 7274 2074 7970 696e 670a  e.import typing.
+00000110: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+00000120: 7274 2041 6e79 2c20 4469 6374 2c20 4c69  rt Any, Dict, Li
+00000130: 7374 2c20 4f70 7469 6f6e 616c 2c20 5365  st, Optional, Se
+00000140: 7175 656e 6365 2c20 5365 742c 2054 7570  quence, Set, Tup
+00000150: 6c65 2c20 556e 696f 6e0a 696d 706f 7274  le, Union.import
+00000160: 2075 7569 640a 0a69 6d70 6f72 7420 636f   uuid..import co
+00000170: 6c6f 7261 6d61 0a69 6d70 6f72 7420 6669  lorama.import fi
+00000180: 6c65 6c6f 636b 0a66 726f 6d20 7061 636b  lelock.from pack
+00000190: 6167 696e 6720 696d 706f 7274 2076 6572  aging import ver
+000001a0: 7369 6f6e 0a69 6d70 6f72 7420 7265 7175  sion.import requ
+000001b0: 6573 7473 0a66 726f 6d20 7265 7175 6573  ests.from reques
+000001c0: 7473 2069 6d70 6f72 7420 6164 6170 7465  ts import adapte
+000001d0: 7273 0a66 726f 6d20 7265 7175 6573 7473  rs.from requests
+000001e0: 2e70 6163 6b61 6765 732e 7572 6c6c 6962  .packages.urllib
+000001f0: 332e 7574 696c 2069 6d70 6f72 7420 7265  3.util import re
+00000200: 7472 7920 6173 2072 6574 7279 5f6c 6962  try as retry_lib
+00000210: 0a69 6d70 6f72 7420 7269 6368 2e70 726f  .import rich.pro
+00000220: 6772 6573 7320 6173 2072 6963 685f 7072  gress as rich_pr
+00000230: 6f67 7265 7373 0a66 726f 6d20 7479 7069  ogress.from typi
+00000240: 6e67 5f65 7874 656e 7369 6f6e 7320 696d  ng_extensions im
+00000250: 706f 7274 204c 6974 6572 616c 0a69 6d70  port Literal.imp
+00000260: 6f72 7420 7961 6d6c 0a0a 696d 706f 7274  ort yaml..import
+00000270: 2073 6b79 0a66 726f 6d20 736b 7920 696d   sky.from sky im
+00000280: 706f 7274 2061 7574 6865 6e74 6963 6174  port authenticat
+00000290: 696f 6e20 6173 2061 7574 680a 6672 6f6d  ion as auth.from
+000002a0: 2073 6b79 2069 6d70 6f72 7420 6261 636b   sky import back
+000002b0: 656e 6473 0a66 726f 6d20 736b 7920 696d  ends.from sky im
+000002c0: 706f 7274 2063 6865 636b 2061 7320 736b  port check as sk
+000002d0: 795f 6368 6563 6b0a 6672 6f6d 2073 6b79  y_check.from sky
+000002e0: 2069 6d70 6f72 7420 636c 6f75 6473 0a66   import clouds.f
+000002f0: 726f 6d20 736b 7920 696d 706f 7274 2065  rom sky import e
+00000300: 7863 6570 7469 6f6e 730a 6672 6f6d 2073  xceptions.from s
+00000310: 6b79 2069 6d70 6f72 7420 676c 6f62 616c  ky import global
+00000320: 5f75 7365 725f 7374 6174 650a 6672 6f6d  _user_state.from
+00000330: 2073 6b79 2069 6d70 6f72 7420 7072 6f76   sky import prov
+00000340: 6973 696f 6e20 6173 2070 726f 7669 7369  ision as provisi
+00000350: 6f6e 5f6c 6962 0a66 726f 6d20 736b 7920  on_lib.from sky 
+00000360: 696d 706f 7274 2073 6b79 5f6c 6f67 6769  import sky_loggi
+00000370: 6e67 0a66 726f 6d20 736b 7920 696d 706f  ng.from sky impo
+00000380: 7274 2073 6b79 7069 6c6f 745f 636f 6e66  rt skypilot_conf
+00000390: 6967 0a66 726f 6d20 736b 7920 696d 706f  ig.from sky impo
+000003a0: 7274 2073 7461 7475 735f 6c69 620a 6672  rt status_lib.fr
+000003b0: 6f6d 2073 6b79 2e63 6c6f 7564 7320 696d  om sky.clouds im
+000003c0: 706f 7274 2063 6c6f 7564 5f72 6567 6973  port cloud_regis
+000003d0: 7472 790a 6672 6f6d 2073 6b79 2e70 726f  try.from sky.pro
+000003e0: 7669 7369 6f6e 2069 6d70 6f72 7420 696e  vision import in
+000003f0: 7374 616e 6365 5f73 6574 7570 0a66 726f  stance_setup.fro
+00000400: 6d20 736b 792e 7072 6f76 6973 696f 6e2e  m sky.provision.
+00000410: 6b75 6265 726e 6574 6573 2069 6d70 6f72  kubernetes impor
+00000420: 7420 7574 696c 7320 6173 206b 7562 6572  t utils as kuber
+00000430: 6e65 7465 735f 7574 696c 730a 6672 6f6d  netes_utils.from
+00000440: 2073 6b79 2e73 6b79 6c65 7420 696d 706f   sky.skylet impo
+00000450: 7274 2063 6f6e 7374 616e 7473 0a66 726f  rt constants.fro
+00000460: 6d20 736b 792e 7573 6167 6520 696d 706f  m sky.usage impo
+00000470: 7274 2075 7361 6765 5f6c 6962 0a66 726f  rt usage_lib.fro
+00000480: 6d20 736b 792e 7574 696c 7320 696d 706f  m sky.utils impo
+00000490: 7274 2063 6c75 7374 6572 5f79 616d 6c5f  rt cluster_yaml_
+000004a0: 7574 696c 730a 6672 6f6d 2073 6b79 2e75  utils.from sky.u
+000004b0: 7469 6c73 2069 6d70 6f72 7420 636f 6d6d  tils import comm
+000004c0: 616e 645f 7275 6e6e 6572 0a66 726f 6d20  and_runner.from 
+000004d0: 736b 792e 7574 696c 7320 696d 706f 7274  sky.utils import
+000004e0: 2063 6f6d 6d6f 6e5f 7574 696c 730a 6672   common_utils.fr
+000004f0: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
+00000500: 6f72 7420 636f 6e74 726f 6c6c 6572 5f75  ort controller_u
+00000510: 7469 6c73 0a66 726f 6d20 736b 792e 7574  tils.from sky.ut
+00000520: 696c 7320 696d 706f 7274 2065 6e76 5f6f  ils import env_o
+00000530: 7074 696f 6e73 0a66 726f 6d20 736b 792e  ptions.from sky.
+00000540: 7574 696c 7320 696d 706f 7274 2072 6963  utils import ric
+00000550: 685f 7574 696c 730a 6672 6f6d 2073 6b79  h_utils.from sky
+00000560: 2e75 7469 6c73 2069 6d70 6f72 7420 7375  .utils import su
+00000570: 6270 726f 6365 7373 5f75 7469 6c73 0a66  bprocess_utils.f
+00000580: 726f 6d20 736b 792e 7574 696c 7320 696d  rom sky.utils im
+00000590: 706f 7274 2074 696d 656c 696e 650a 6672  port timeline.fr
+000005a0: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
+000005b0: 6f72 7420 7578 5f75 7469 6c73 0a0a 6966  ort ux_utils..if
+000005c0: 2074 7970 696e 672e 5459 5045 5f43 4845   typing.TYPE_CHE
+000005d0: 434b 494e 473a 0a20 2020 2066 726f 6d20  CKING:.    from 
+000005e0: 736b 7920 696d 706f 7274 2072 6573 6f75  sky import resou
+000005f0: 7263 6573 0a20 2020 2066 726f 6d20 736b  rces.    from sk
+00000600: 7920 696d 706f 7274 2074 6173 6b20 6173  y import task as
+00000610: 2074 6173 6b5f 6c69 620a 2020 2020 6672   task_lib.    fr
+00000620: 6f6d 2073 6b79 2e62 6163 6b65 6e64 7320  om sky.backends 
+00000630: 696d 706f 7274 2063 6c6f 7564 5f76 6d5f  import cloud_vm_
+00000640: 7261 795f 6261 636b 656e 640a 2020 2020  ray_backend.    
+00000650: 6672 6f6d 2073 6b79 2e62 6163 6b65 6e64  from sky.backend
+00000660: 7320 696d 706f 7274 206c 6f63 616c 5f64  s import local_d
+00000670: 6f63 6b65 725f 6261 636b 656e 640a 0a6c  ocker_backend..l
+00000680: 6f67 6765 7220 3d20 736b 795f 6c6f 6767  ogger = sky_logg
+00000690: 696e 672e 696e 6974 5f6c 6f67 6765 7228  ing.init_logger(
+000006a0: 5f5f 6e61 6d65 5f5f 290a 0a23 204e 4f54  __name__)..# NOT
+000006b0: 453a 206b 6565 7020 696e 2073 796e 6320  E: keep in sync 
+000006c0: 7769 7468 2074 6865 2063 6c75 7374 6572  with the cluster
+000006d0: 2074 656d 706c 6174 6520 2766 696c 655f   template 'file_
+000006e0: 6d6f 756e 7473 272e 0a53 4b59 5f52 454d  mounts'..SKY_REM
+000006f0: 4f54 455f 4150 505f 4449 5220 3d20 277e  OTE_APP_DIR = '~
+00000700: 2f2e 736b 792f 736b 795f 6170 7027 0a23  /.sky/sky_app'.#
+00000710: 2045 7863 6c75 6465 2073 7562 6e65 7420   Exclude subnet 
+00000720: 6d61 736b 2066 726f 6d20 4950 2061 6464  mask from IP add
+00000730: 7265 7373 2072 6567 6578 2e0a 4950 5f41  ress regex..IP_A
+00000740: 4444 525f 5245 4745 5820 3d20 7227 5c62  DDR_REGEX = r'\b
+00000750: 5c64 7b31 2c33 7d5c 2e5c 647b 312c 337d  \d{1,3}\.\d{1,3}
+00000760: 5c2e 5c64 7b31 2c33 7d5c 2e5c 647b 312c  \.\d{1,3}\.\d{1,
+00000770: 337d 283f 212f 5c64 7b31 2c32 7d29 5c62  3}(?!/\d{1,2})\b
+00000780: 270a 534b 595f 5245 4d4f 5445 5f50 4154  '.SKY_REMOTE_PAT
+00000790: 4820 3d20 277e 2f2e 736b 792f 7768 6565  H = '~/.sky/whee
+000007a0: 6c73 270a 534b 595f 5553 4552 5f46 494c  ls'.SKY_USER_FIL
+000007b0: 455f 5041 5448 203d 2027 7e2f 2e73 6b79  E_PATH = '~/.sky
+000007c0: 2f67 656e 6572 6174 6564 270a 0a42 4f4c  /generated'..BOL
+000007d0: 4420 3d20 275c 3033 335b 316d 270a 5245  D = '\033[1m'.RE
+000007e0: 5345 545f 424f 4c44 203d 2027 5c30 3333  SET_BOLD = '\033
+000007f0: 5b30 6d27 0a0a 2320 446f 206e 6f74 2075  [0m'..# Do not u
+00000800: 7365 202f 746d 7020 6265 6361 7573 6520  se /tmp because 
+00000810: 6974 2067 6574 7320 636c 6561 7265 6420  it gets cleared 
+00000820: 6f6e 2056 4d20 7265 7374 6172 742e 0a5f  on VM restart.._
+00000830: 534b 595f 5245 4d4f 5445 5f46 494c 455f  SKY_REMOTE_FILE_
+00000840: 4d4f 554e 5453 5f44 4952 203d 2027 7e2f  MOUNTS_DIR = '~/
+00000850: 2e73 6b79 2f66 696c 655f 6d6f 756e 7473  .sky/file_mounts
+00000860: 2f27 0a0a 5f4c 4155 4e43 4845 445f 4845  /'.._LAUNCHED_HE
+00000870: 4144 5f50 4154 5445 524e 203d 2072 652e  AD_PATTERN = re.
+00000880: 636f 6d70 696c 6528 7227 285c 642b 2920  compile(r'(\d+) 
+00000890: 7261 795b 2e5f 5d68 6561 645b 2e5f 5d64  ray[._]head[._]d
+000008a0: 6566 6175 6c74 2729 0a5f 4c41 554e 4348  efault')._LAUNCH
+000008b0: 4544 5f4c 4f43 414c 5f57 4f52 4b45 525f  ED_LOCAL_WORKER_
+000008c0: 5041 5454 4552 4e20 3d20 7265 2e63 6f6d  PATTERN = re.com
+000008d0: 7069 6c65 2872 2728 5c64 2b29 206e 6f64  pile(r'(\d+) nod
+000008e0: 655f 2729 0a5f 4c41 554e 4348 4544 5f57  e_')._LAUNCHED_W
+000008f0: 4f52 4b45 525f 5041 5454 4552 4e20 3d20  ORKER_PATTERN = 
+00000900: 7265 2e63 6f6d 7069 6c65 2872 2728 5c64  re.compile(r'(\d
+00000910: 2b29 2072 6179 5b2e 5f5d 776f 726b 6572  +) ray[._]worker
+00000920: 5b2e 5f5d 6465 6661 756c 7427 290a 5f4c  [._]default')._L
+00000930: 4155 4e43 4845 445f 5245 5345 5256 4544  AUNCHED_RESERVED
+00000940: 5f57 4f52 4b45 525f 5041 5454 4552 4e20  _WORKER_PATTERN 
+00000950: 3d20 7265 2e63 6f6d 7069 6c65 280a 2020  = re.compile(.  
+00000960: 2020 7227 285c 642b 2920 7261 795b 2e5f    r'(\d+) ray[._
+00000970: 5d77 6f72 6b65 725b 2e5f 5d72 6573 6572  ]worker[._]reser
+00000980: 7665 6427 290a 2320 496e 7465 6e74 696f  ved').# Intentio
+00000990: 6e61 6c6c 7920 6e6f 7420 7573 696e 6720  nally not using 
+000009a0: 7072 6566 6978 2027 7266 2720 666f 7220  prefix 'rf' for 
+000009b0: 7468 6520 7374 7269 6e67 2066 6f72 6d61  the string forma
+000009c0: 7420 6265 6361 7573 6520 7961 7066 2068  t because yapf h
+000009d0: 6176 6520 610a 2320 6275 6720 7769 7468  ave a.# bug with
+000009e0: 2070 7974 686f 6e3d 332e 362e 0a23 2031   python=3.6..# 1
+000009f0: 302e 3133 332e 302e 353a 2072 6179 2e77  0.133.0.5: ray.w
+00000a00: 6f72 6b65 722e 6465 6661 756c 742c 0a5f  orker.default,._
+00000a10: 4c41 554e 4348 494e 475f 4950 5f50 4154  LAUNCHING_IP_PAT
+00000a20: 5445 524e 203d 2072 652e 636f 6d70 696c  TERN = re.compil
+00000a30: 6528 0a20 2020 2072 2728 7b7d 293a 2072  e(.    r'({}): r
+00000a40: 6179 5b2e 5f5d 776f 726b 6572 5b2e 5f5d  ay[._]worker[._]
+00000a50: 283f 3a64 6566 6175 6c74 7c72 6573 6572  (?:default|reser
+00000a60: 7665 6429 272e 666f 726d 6174 2849 505f  ved)'.format(IP_
+00000a70: 4144 4452 5f52 4547 4558 2929 0a57 4149  ADDR_REGEX)).WAI
+00000a80: 545f 4845 4144 5f4e 4f44 455f 4950 5f4d  T_HEAD_NODE_IP_M
+00000a90: 4158 5f41 5454 454d 5054 5320 3d20 330a  AX_ATTEMPTS = 3.
+00000aa0: 0a23 2057 6520 6368 6563 6b20 6e65 7477  .# We check netw
+00000ab0: 6f72 6b20 636f 6e6e 6563 7469 6f6e 2062  ork connection b
+00000ac0: 7920 676f 696e 6720 7468 726f 7567 6820  y going through 
+00000ad0: 5f54 4553 545f 4950 5f4c 4953 542e 2057  _TEST_IP_LIST. W
+00000ae0: 6520 6d61 7920 6e65 6564 2074 6f0a 2320  e may need to.# 
+00000af0: 6368 6563 6b20 6d75 6c74 6970 6c65 2049  check multiple I
+00000b00: 5073 2062 6563 6175 7365 2073 6f6d 6520  Ps because some 
+00000b10: 4950 7320 6d61 7920 6265 2062 6c6f 636b  IPs may be block
+00000b20: 6564 206f 6e20 6365 7274 6169 6e20 6e65  ed on certain ne
+00000b30: 7477 6f72 6b73 2e0a 2320 4669 7865 6420  tworks..# Fixed 
+00000b40: 4950 2061 6464 7265 7373 6573 2061 7265  IP addresses are
+00000b50: 2075 7365 6420 746f 2061 766f 6964 2044   used to avoid D
+00000b60: 4e53 206c 6f6f 6b75 7020 626c 6f63 6b69  NS lookup blocki
+00000b70: 6e67 2074 6865 2063 6865 636b 2c20 666f  ng the check, fo
+00000b80: 720a 2320 6d61 6368 696e 6520 7769 7468  r.# machine with
+00000b90: 206e 6f20 696e 7465 726e 6574 2063 6f6e   no internet con
+00000ba0: 6e65 6374 696f 6e2e 0a23 2052 6566 6572  nection..# Refer
+00000bb0: 2074 6f3a 2068 7474 7073 3a2f 2f73 7461   to: https://sta
+00000bc0: 636b 6f76 6572 666c 6f77 2e63 6f6d 2f71  ckoverflow.com/q
+00000bd0: 7565 7374 696f 6e73 2f33 3736 3432 3931  uestions/3764291
+00000be0: 2f68 6f77 2d63 616e 2d69 2d73 6565 2d69  /how-can-i-see-i
+00000bf0: 662d 7468 6572 6573 2d61 6e2d 6176 6169  f-theres-an-avai
+00000c00: 6c61 626c 652d 616e 642d 6163 7469 7665  lable-and-active
+00000c10: 2d6e 6574 776f 726b 2d63 6f6e 6e65 6374  -network-connect
+00000c20: 696f 6e2d 696e 2d70 7974 686f 6e20 2320  ion-in-python # 
+00000c30: 7079 6c69 6e74 3a20 6469 7361 626c 653d  pylint: disable=
+00000c40: 6c69 6e65 2d74 6f6f 2d6c 6f6e 670a 5f54  line-too-long._T
+00000c50: 4553 545f 4950 5f4c 4953 5420 3d20 5b27  EST_IP_LIST = ['
+00000c60: 6874 7470 733a 2f2f 312e 312e 312e 3127  https://1.1.1.1'
+00000c70: 2c20 2768 7474 7073 3a2f 2f38 2e38 2e38  , 'https://8.8.8
+00000c80: 2e38 275d 0a0a 2320 416c 6c6f 7720 6561  .8']..# Allow ea
+00000c90: 6368 2043 5055 2074 6872 6561 6420 7461  ch CPU thread ta
+00000ca0: 6b65 2032 2074 6173 6b73 2e0a 2320 4e6f  ke 2 tasks..# No
+00000cb0: 7465 3a20 5468 6973 2076 616c 7565 2063  te: This value c
+00000cc0: 616e 6e6f 7420 6265 2074 6f6f 2073 6d61  annot be too sma
+00000cd0: 6c6c 2c20 6f74 6865 7277 6973 6520 4f4f  ll, otherwise OO
+00000ce0: 4d20 6973 7375 6520 6d61 7920 6f63 6375  M issue may occu
+00000cf0: 722e 0a44 4546 4155 4c54 5f54 4153 4b5f  r..DEFAULT_TASK_
+00000d00: 4350 555f 4445 4d41 4e44 203d 2030 2e35  CPU_DEMAND = 0.5
+00000d10: 0a0a 2320 4669 6c65 6c6f 636b 7320 666f  ..# Filelocks fo
+00000d20: 7220 7468 6520 636c 7573 7465 7220 7374  r the cluster st
+00000d30: 6174 7573 2063 6861 6e67 652e 0a43 4c55  atus change..CLU
+00000d40: 5354 4552 5f53 5441 5455 535f 4c4f 434b  STER_STATUS_LOCK
+00000d50: 5f50 4154 4820 3d20 6f73 2e70 6174 682e  _PATH = os.path.
+00000d60: 6578 7061 6e64 7573 6572 2827 7e2f 2e73  expanduser('~/.s
+00000d70: 6b79 2f2e 7b7d 2e6c 6f63 6b27 290a 434c  ky/.{}.lock').CL
+00000d80: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
+00000d90: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
+00000da0: 5320 3d20 3230 0a0a 2320 4669 6c65 6c6f  S = 20..# Filelo
+00000db0: 636b 7320 666f 7220 7570 6461 7469 6e67  cks for updating
+00000dc0: 2063 6c75 7374 6572 2773 2066 696c 655f   cluster's file_
+00000dd0: 6d6f 756e 7473 2e0a 434c 5553 5445 525f  mounts..CLUSTER_
+00000de0: 4649 4c45 5f4d 4f55 4e54 535f 4c4f 434b  FILE_MOUNTS_LOCK
+00000df0: 5f50 4154 4820 3d20 6f73 2e70 6174 682e  _PATH = os.path.
+00000e00: 6578 7061 6e64 7573 6572 280a 2020 2020  expanduser(.    
+00000e10: 277e 2f2e 736b 792f 2e7b 7d5f 6669 6c65  '~/.sky/.{}_file
+00000e20: 5f6d 6f75 6e74 732e 6c6f 636b 2729 0a43  _mounts.lock').C
+00000e30: 4c55 5354 4552 5f46 494c 455f 4d4f 554e  LUSTER_FILE_MOUN
+00000e40: 5453 5f4c 4f43 4b5f 5449 4d45 4f55 545f  TS_LOCK_TIMEOUT_
+00000e50: 5345 434f 4e44 5320 3d20 3130 0a0a 2320  SECONDS = 10..# 
+00000e60: 5265 6d6f 7465 2064 6972 2074 6861 7420  Remote dir that 
+00000e70: 686f 6c64 7320 6f75 7220 7275 6e74 696d  holds our runtim
+00000e80: 6520 6669 6c65 732e 0a5f 5245 4d4f 5445  e files.._REMOTE
+00000e90: 5f52 554e 5449 4d45 5f46 494c 4553 5f44  _RUNTIME_FILES_D
+00000ea0: 4952 203d 2027 7e2f 2e73 6b79 2f2e 7275  IR = '~/.sky/.ru
+00000eb0: 6e74 696d 655f 6669 6c65 7327 0a0a 2320  ntime_files'..# 
+00000ec0: 496e 636c 7564 6520 7468 6520 6669 656c  Include the fiel
+00000ed0: 6473 2074 6861 7420 7769 6c6c 2062 6520  ds that will be 
+00000ee0: 7573 6564 2066 6f72 2067 656e 6572 6174  used for generat
+00000ef0: 696e 6720 7461 6773 2074 6861 7420 6469  ing tags that di
+00000f00: 7374 696e 6775 6973 6865 730a 2320 7468  stinguishes.# th
+00000f10: 6520 636c 7573 7465 7220 696e 2072 6179  e cluster in ray
+00000f20: 2c20 746f 2061 766f 6964 2074 6865 2073  , to avoid the s
+00000f30: 746f 7070 6564 2063 6c75 7374 6572 2062  topped cluster b
+00000f40: 6569 6e67 2064 6973 6361 7264 6564 2064  eing discarded d
+00000f50: 7565 2074 6f0a 2320 7570 6461 7465 7320  ue to.# updates 
+00000f60: 696e 2074 6865 2079 616d 6c20 7465 6d70  in the yaml temp
+00000f70: 6c61 7465 2e0a 2320 536f 6d65 206e 6f74  late..# Some not
+00000f80: 6573 206f 6e20 7468 6520 6669 656c 6473  es on the fields
+00000f90: 3a0a 2320 2d20 2770 726f 7669 6465 7227  :.# - 'provider'
+00000fa0: 2066 6965 6c64 7320 7769 6c6c 2062 6520   fields will be 
+00000fb0: 7573 6564 2066 6f72 2062 6f6f 7473 7472  used for bootstr
+00000fc0: 6170 7069 6e67 2061 6e64 2069 6e73 6572  apping and inser
+00000fd0: 7420 6d6f 7265 206e 6577 2069 7465 6d73  t more new items
+00000fe0: 0a23 2020 2069 6e20 276e 6f64 655f 636f  .#   in 'node_co
+00000ff0: 6e66 6967 272e 0a23 202d 206b 6565 7069  nfig'..# - keepi
+00001000: 6e67 2074 6865 2061 7574 6820 6973 206e  ng the auth is n
+00001010: 6f74 2065 6e6f 7567 6820 6265 6375 6173  ot enough becuas
+00001020: 6520 7468 6520 636f 6e74 656e 7420 6f66  e the content of
+00001030: 2074 6865 206b 6579 2066 696c 6520 7769   the key file wi
+00001040: 6c6c 2062 650a 2320 2020 7573 6564 2066  ll be.#   used f
+00001050: 6f72 2063 616c 6375 6c61 7469 6e67 2074  or calculating t
+00001060: 6865 2068 6173 682e 0a23 2054 4f44 4f28  he hash..# TODO(
+00001070: 7a68 7775 293a 204b 6565 7020 696e 2073  zhwu): Keep in s
+00001080: 796e 6320 7769 7468 2074 6865 2066 6965  ync with the fie
+00001090: 6c64 7320 7573 6564 2069 6e20 6874 7470  lds used in http
+000010a0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f72  s://github.com/r
+000010b0: 6179 2d70 726f 6a65 6374 2f72 6179 2f62  ay-project/ray/b
+000010c0: 6c6f 622f 6534 6365 3338 6430 3031 6462  lob/e4ce38d001db
+000010d0: 6265 3039 6364 3231 6334 3937 6665 6464  be09cd21c497fedd
+000010e0: 3033 6436 3932 6232 6265 3365 2f70 7974  03d692b2be3e/pyt
+000010f0: 686f 6e2f 7261 792f 6175 746f 7363 616c  hon/ray/autoscal
+00001100: 6572 2f5f 7072 6976 6174 652f 636f 6d6d  er/_private/comm
+00001110: 616e 6473 2e70 7923 4c36 3837 2d4c 3730  ands.py#L687-L70
+00001120: 310a 5f52 4159 5f59 414d 4c5f 4b45 5953  1._RAY_YAML_KEYS
+00001130: 5f54 4f5f 5245 5354 4f52 455f 464f 525f  _TO_RESTORE_FOR_
+00001140: 4241 434b 5f43 4f4d 5041 5449 4249 4c49  BACK_COMPATIBILI
+00001150: 5459 203d 207b 0a20 2020 2027 636c 7573  TY = {.    'clus
+00001160: 7465 725f 6e61 6d65 272c 2027 7072 6f76  ter_name', 'prov
+00001170: 6964 6572 272c 2027 6175 7468 272c 2027  ider', 'auth', '
+00001180: 6e6f 6465 5f63 6f6e 6669 6727 2c20 2764  node_config', 'd
+00001190: 6f63 6b65 7227 0a7d 0a23 2046 6f72 2074  ocker'.}.# For t
+000011a0: 6865 7365 206b 6579 732c 2064 6f6e 2774  hese keys, don't
+000011b0: 2075 7365 2074 6865 206f 6c64 2079 616d   use the old yam
+000011c0: 6c27 7320 7665 7273 696f 6e20 616e 6420  l's version and 
+000011d0: 696e 7374 6561 6420 7573 6520 7468 6520  instead use the 
+000011e0: 6e65 7720 7961 6d6c 2773 2e0a 2320 202d  new yaml's..#  -
+000011f0: 207a 6f6e 653a 2054 6865 207a 6f6e 6520   zone: The zone 
+00001200: 6669 656c 6420 6f66 2074 6865 206f 6c64  field of the old
+00001210: 2079 616d 6c20 6d61 7920 6265 2027 3161   yaml may be '1a
+00001220: 2c31 622c 3163 2720 2841 5753 2920 7768  ,1b,1c' (AWS) wh
+00001230: 696c 6520 7468 6520 6163 7475 616c 0a23  ile the actual.#
+00001240: 2020 2020 7a6f 6e65 206f 6620 7468 6520      zone of the 
+00001250: 6c61 756e 6368 6564 2063 6c75 7374 6572  launched cluster
+00001260: 2069 7320 2731 6127 2e20 4966 2077 6520   is '1a'. If we 
+00001270: 7265 7374 6f72 652c 2074 6865 6e20 6f6e  restore, then on
+00001280: 2063 6170 6163 6974 7920 6572 726f 7273   capacity errors
+00001290: 0a23 2020 2020 6974 2773 2070 6f73 7369  .#    it's possi
+000012a0: 626c 6520 746f 2066 6169 6c6f 7665 7220  ble to failover 
+000012b0: 746f 2031 622c 2077 6869 6368 206c 6561  to 1b, which lea
+000012c0: 7665 7320 6120 6c65 616b 6564 2069 6e73  ves a leaked ins
+000012d0: 7461 6e63 6520 696e 2031 612e 2048 6572  tance in 1a. Her
+000012e0: 652c 0a23 2020 2020 7765 2075 7365 2074  e,.#    we use t
+000012f0: 6865 206e 6577 2079 616d 6c27 7320 7a6f  he new yaml's zo
+00001300: 6e65 2066 6965 6c64 2c20 7768 6963 6820  ne field, which 
+00001310: 6973 2067 7561 7261 6e74 6565 6420 746f  is guaranteed to
+00001320: 2062 6520 7468 6520 6578 6973 7469 6e67   be the existing
+00001330: 207a 6f6e 650a 2320 2020 2027 3161 272e   zone.#    '1a'.
+00001340: 0a23 202d 2064 6f63 6b65 725f 6c6f 6769  .# - docker_logi
+00001350: 6e5f 636f 6e66 6967 3a20 5468 6520 646f  n_config: The do
+00001360: 636b 6572 5f6c 6f67 696e 5f63 6f6e 6669  cker_login_confi
+00001370: 6720 6669 656c 6420 6f66 2074 6865 206f  g field of the o
+00001380: 6c64 2079 616d 6c20 6d61 7920 6265 0a23  ld yaml may be.#
+00001390: 2020 206f 7574 6461 7465 6420 6f72 2077     outdated or w
+000013a0: 726f 6e67 2e20 5573 6572 7320 6d61 7920  rong. Users may 
+000013b0: 7761 6e74 2074 6f20 6669 7820 7468 6520  want to fix the 
+000013c0: 6c6f 6769 6e20 636f 6e66 6967 2069 6620  login config if 
+000013d0: 6120 636c 7573 7465 7220 6661 696c 730a  a cluster fails.
+000013e0: 2320 2020 746f 206c 6175 6e63 6820 6475  #   to launch du
+000013f0: 6520 746f 2074 6865 206c 6f67 696e 2063  e to the login c
+00001400: 6f6e 6669 672e 0a23 202d 2055 7365 7244  onfig..# - UserD
+00001410: 6174 613a 2054 6865 2055 7365 7244 6174  ata: The UserDat
+00001420: 6120 6669 656c 6420 6f66 2074 6865 206f  a field of the o
+00001430: 6c64 2079 616d 6c20 6d61 7920 6265 206f  ld yaml may be o
+00001440: 7574 6461 7465 642c 2061 6e64 2077 6520  utdated, and we 
+00001450: 7761 6e74 2074 6f0a 2320 2020 7573 6520  want to.#   use 
+00001460: 7468 6520 6e65 7720 7961 6d6c 2773 2055  the new yaml's U
+00001470: 7365 7244 6174 6120 6669 656c 642c 2077  serData field, w
+00001480: 6869 6368 2063 6f6e 7461 696e 7320 7468  hich contains th
+00001490: 6520 6175 7468 6f72 697a 6564 206b 6579  e authorized key
+000014a0: 2073 6574 7570 2061 730a 2320 2020 7765   setup as.#   we
+000014b0: 6c6c 2061 7320 7468 6520 6469 7361 626c  ll as the disabl
+000014c0: 696e 6720 6f66 2074 6865 2061 7574 6f2d  ing of the auto-
+000014d0: 7570 6461 7465 2077 6974 6820 6170 742d  update with apt-
+000014e0: 6765 742e 0a23 202d 2066 6972 6577 616c  get..# - firewal
+000014f0: 6c5f 7275 6c65 3a20 5468 6973 2069 7320  l_rule: This is 
+00001500: 6120 6e65 776c 7920 6164 6465 6420 7365  a newly added se
+00001510: 6374 696f 6e20 666f 7220 6763 7020 696e  ction for gcp in
+00001520: 2070 726f 7669 6465 7220 7365 6374 696f   provider sectio
+00001530: 6e2e 0a23 202d 2073 6563 7572 6974 795f  n..# - security_
+00001540: 6772 6f75 703a 2049 6e20 2332 3438 3520  group: In #2485 
+00001550: 7765 2069 6e74 726f 6475 6365 7320 7468  we introduces th
+00001560: 6520 6368 616e 6765 6420 6f66 2073 6563  e changed of sec
+00001570: 7572 6974 7920 6772 6f75 702c 2073 6f20  urity group, so 
+00001580: 7765 0a23 2020 2073 686f 756c 6420 7461  we.#   should ta
+00001590: 6b65 2074 6865 206c 6174 6573 7420 7365  ke the latest se
+000015a0: 6375 7269 7479 2067 726f 7570 206e 616d  curity group nam
+000015b0: 652e 0a5f 5241 595f 5941 4d4c 5f4b 4559  e.._RAY_YAML_KEY
+000015c0: 535f 544f 5f52 4553 544f 5245 5f45 5843  S_TO_RESTORE_EXC
+000015d0: 4550 5449 4f4e 5320 3d20 5b0a 2020 2020  EPTIONS = [.    
+000015e0: 2827 7072 6f76 6964 6572 272c 2027 6176  ('provider', 'av
+000015f0: 6169 6c61 6269 6c69 7479 5f7a 6f6e 6527  ailability_zone'
+00001600: 292c 0a20 2020 2023 2043 6c6f 7564 7320  ),.    # Clouds 
+00001610: 7769 7468 206e 6577 2070 726f 7669 7369  with new provisi
+00001620: 6f6e 6572 2068 6173 2064 6f63 6b65 725f  oner has docker_
+00001630: 6c6f 6769 6e5f 636f 6e66 6967 2069 6e20  login_config in 
+00001640: 7468 650a 2020 2020 2320 646f 636b 6572  the.    # docker
+00001650: 2066 6965 6c64 2c20 696e 7374 6561 6420   field, instead 
+00001660: 6f66 2074 6865 2070 726f 7669 6465 7220  of the provider 
+00001670: 6669 656c 642e 0a20 2020 2028 2764 6f63  field..    ('doc
+00001680: 6b65 7227 2c20 2764 6f63 6b65 725f 6c6f  ker', 'docker_lo
+00001690: 6769 6e5f 636f 6e66 6967 2729 2c0a 2020  gin_config'),.  
+000016a0: 2020 2320 4f74 6865 7220 636c 6f75 6473    # Other clouds
+000016b0: 0a20 2020 2028 2770 726f 7669 6465 7227  .    ('provider'
+000016c0: 2c20 2764 6f63 6b65 725f 6c6f 6769 6e5f  , 'docker_login_
+000016d0: 636f 6e66 6967 2729 2c0a 2020 2020 2827  config'),.    ('
+000016e0: 7072 6f76 6964 6572 272c 2027 6669 7265  provider', 'fire
+000016f0: 7761 6c6c 5f72 756c 6527 292c 0a20 2020  wall_rule'),.   
+00001700: 2023 2054 5055 206e 6f64 6520 6c61 756e   # TPU node laun
+00001710: 6368 6564 2062 6566 6f72 6520 2332 3934  ched before #294
+00001720: 3320 646f 6573 206e 6f74 2068 6176 6520  3 does not have 
+00001730: 7468 6520 6070 726f 7669 6465 722e 7470  the `provider.tp
+00001740: 755f 6e6f 6465 6020 7365 742c 0a20 2020  u_node` set,.   
+00001750: 2023 2061 6e64 206f 7572 206c 6174 6573   # and our lates
+00001760: 7420 636f 6465 206e 6565 6420 7468 6973  t code need this
+00001770: 2066 6965 6c64 2074 6f20 6265 2073 6574   field to be set
+00001780: 2074 6f20 6469 7374 696e 6775 6973 6820   to distinguish 
+00001790: 7468 6520 6e6f 6465 2c20 736f 0a20 2020  the node, so.   
+000017a0: 2023 2077 6520 6e65 6564 2074 6f20 7461   # we need to ta
+000017b0: 6b65 2074 6869 7320 6669 656c 6420 6672  ke this field fr
+000017c0: 6f6d 2074 6865 206e 6577 2079 616d 6c2e  om the new yaml.
+000017d0: 0a20 2020 2028 2770 726f 7669 6465 7227  .    ('provider'
+000017e0: 2c20 2774 7075 5f6e 6f64 6527 292c 0a20  , 'tpu_node'),. 
+000017f0: 2020 2028 2770 726f 7669 6465 7227 2c20     ('provider', 
+00001800: 2773 6563 7572 6974 795f 6772 6f75 7027  'security_group'
+00001810: 2c20 2747 726f 7570 4e61 6d65 2729 2c0a  , 'GroupName'),.
+00001820: 2020 2020 2827 6176 6169 6c61 626c 655f      ('available_
+00001830: 6e6f 6465 5f74 7970 6573 272c 2027 7261  node_types', 'ra
+00001840: 792e 6865 6164 2e64 6566 6175 6c74 272c  y.head.default',
+00001850: 2027 6e6f 6465 5f63 6f6e 6669 6727 2c20   'node_config', 
+00001860: 2755 7365 7244 6174 6127 292c 0a20 2020  'UserData'),.   
+00001870: 2028 2761 7661 696c 6162 6c65 5f6e 6f64   ('available_nod
+00001880: 655f 7479 7065 7327 2c20 2772 6179 2e77  e_types', 'ray.w
+00001890: 6f72 6b65 722e 6465 6661 756c 7427 2c20  orker.default', 
+000018a0: 276e 6f64 655f 636f 6e66 6967 272c 2027  'node_config', '
+000018b0: 5573 6572 4461 7461 2729 2c0a 5d0a 0a0a  UserData'),.]...
+000018c0: 6465 6620 6973 5f69 7028 733a 2073 7472  def is_ip(s: str
+000018d0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2022  ) -> bool:.    "
+000018e0: 2222 5265 7475 726e 7320 7768 6574 6865  ""Returns whethe
+000018f0: 7220 7468 6973 2073 7472 696e 6720 6d61  r this string ma
+00001900: 7463 6865 7320 4950 5f41 4444 525f 5245  tches IP_ADDR_RE
+00001910: 4745 582e 2222 220a 2020 2020 7265 7475  GEX.""".    retu
+00001920: 726e 206c 656e 2872 652e 6669 6e64 616c  rn len(re.findal
+00001930: 6c28 4950 5f41 4444 525f 5245 4745 582c  l(IP_ADDR_REGEX,
+00001940: 2073 2929 203d 3d20 310a 0a0a 6465 6620   s)) == 1...def 
+00001950: 5f67 6574 5f79 616d 6c5f 7061 7468 5f66  _get_yaml_path_f
+00001960: 726f 6d5f 636c 7573 7465 725f 6e61 6d65  rom_cluster_name
+00001970: 2863 6c75 7374 6572 5f6e 616d 653a 2073  (cluster_name: s
+00001980: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
+00001990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019a0: 2020 2020 2020 2020 2070 7265 6669 783a           prefix:
+000019b0: 2073 7472 203d 2053 4b59 5f55 5345 525f   str = SKY_USER_
+000019c0: 4649 4c45 5f50 4154 4829 202d 3e20 7374  FILE_PATH) -> st
+000019d0: 723a 0a20 2020 206f 7574 7075 745f 7061  r:.    output_pa
+000019e0: 7468 203d 2070 6174 686c 6962 2e50 6174  th = pathlib.Pat
+000019f0: 6828 0a20 2020 2020 2020 2070 7265 6669  h(.        prefi
+00001a00: 7829 2e65 7870 616e 6475 7365 7228 292e  x).expanduser().
+00001a10: 7265 736f 6c76 6528 2920 2f20 6627 7b63  resolve() / f'{c
+00001a20: 6c75 7374 6572 5f6e 616d 657d 2e79 6d6c  luster_name}.yml
+00001a30: 270a 2020 2020 6f73 2e6d 616b 6564 6972  '.    os.makedir
+00001a40: 7328 6f75 7470 7574 5f70 6174 682e 7061  s(output_path.pa
+00001a50: 7265 6e74 735b 305d 2c20 6578 6973 745f  rents[0], exist_
+00001a60: 6f6b 3d54 7275 6529 0a20 2020 2072 6574  ok=True).    ret
+00001a70: 7572 6e20 7374 7228 6f75 7470 7574 5f70  urn str(output_p
+00001a80: 6174 6829 0a0a 0a64 6566 205f 6f70 7469  ath)...def _opti
+00001a90: 6d69 7a65 5f66 696c 655f 6d6f 756e 7473  mize_file_mounts
+00001aa0: 2879 616d 6c5f 7061 7468 3a20 7374 7229  (yaml_path: str)
+00001ab0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00001ac0: 224f 7074 696d 697a 6520 6669 6c65 206d  "Optimize file m
+00001ad0: 6f75 6e74 7320 696e 2074 6865 2067 6976  ounts in the giv
+00001ae0: 656e 2072 6179 2079 616d 6c20 6669 6c65  en ray yaml file
+00001af0: 2e0a 0a20 2020 2052 756e 7469 6d65 2066  ...    Runtime f
+00001b00: 696c 6573 2068 616e 646c 696e 673a 0a20  iles handling:. 
+00001b10: 2020 204c 6973 7420 6f66 2072 756e 7469     List of runti
+00001b20: 6d65 2066 696c 6573 2074 6f20 6265 2075  me files to be u
+00001b30: 706c 6f61 6465 6420 746f 2063 6c75 7374  ploaded to clust
+00001b40: 6572 3a0a 2020 2020 2020 2d20 7961 6d6c  er:.      - yaml
+00001b50: 2063 6f6e 6669 6720 2866 6f72 2061 7574   config (for aut
+00001b60: 6f73 746f 7070 696e 6729 0a20 2020 2020  ostopping).     
+00001b70: 202d 2077 6865 656c 0a20 2020 2020 202d   - wheel.      -
+00001b80: 2063 7265 6465 6e74 6961 6c73 0a20 2020   credentials.   
+00001b90: 2046 6f72 6d61 7420 6973 207b 6473 743a   Format is {dst:
+00001ba0: 2073 7263 7d2e 0a20 2020 2022 2222 0a20   src}..    """. 
+00001bb0: 2020 2079 616d 6c5f 636f 6e66 6967 203d     yaml_config =
+00001bc0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 7265   common_utils.re
+00001bd0: 6164 5f79 616d 6c28 7961 6d6c 5f70 6174  ad_yaml(yaml_pat
+00001be0: 6829 0a0a 2020 2020 6669 6c65 5f6d 6f75  h)..    file_mou
+00001bf0: 6e74 7320 3d20 7961 6d6c 5f63 6f6e 6669  nts = yaml_confi
+00001c00: 672e 6765 7428 2766 696c 655f 6d6f 756e  g.get('file_moun
+00001c10: 7473 272c 207b 7d29 0a20 2020 2023 2052  ts', {}).    # R
+00001c20: 656d 6f76 6520 7468 6520 6669 6c65 206d  emove the file m
+00001c30: 6f75 6e74 7320 6164 6465 6420 6279 2074  ounts added by t
+00001c40: 6865 206e 6577 6c69 6e65 2e0a 2020 2020  he newline..    
+00001c50: 6966 2027 2720 696e 2066 696c 655f 6d6f  if '' in file_mo
+00001c60: 756e 7473 3a0a 2020 2020 2020 2020 6173  unts:.        as
+00001c70: 7365 7274 2066 696c 655f 6d6f 756e 7473  sert file_mounts
+00001c80: 5b27 275d 203d 3d20 2727 2c20 6669 6c65  [''] == '', file
+00001c90: 5f6d 6f75 6e74 735b 2727 5d0a 2020 2020  _mounts[''].    
+00001ca0: 2020 2020 6669 6c65 5f6d 6f75 6e74 732e      file_mounts.
+00001cb0: 706f 7028 2727 290a 0a20 2020 2023 2050  pop('')..    # P
+00001cc0: 7574 7469 6e67 2074 6865 7365 2069 6e20  utting these in 
+00001cd0: 6669 6c65 5f6d 6f75 6e74 7320 6875 7274  file_mounts hurt
+00001ce0: 7320 7072 6f76 6973 696f 6e69 6e67 2073  s provisioning s
+00001cf0: 7065 6564 2c20 6173 2065 6163 6820 6669  peed, as each fi
+00001d00: 6c65 0a20 2020 2023 206f 7065 6e73 2f63  le.    # opens/c
+00001d10: 6c6f 7365 7320 616e 2053 5348 2063 6f6e  loses an SSH con
+00001d20: 6e65 6374 696f 6e2e 2020 496e 7374 6561  nection.  Instea
+00001d30: 642c 2077 653a 0a20 2020 2023 2020 2d20  d, we:.    #  - 
+00001d40: 6370 2074 6865 6d20 6c6f 6361 6c6c 7920  cp them locally 
+00001d50: 696e 746f 2061 2064 6972 6563 746f 7279  into a directory
+00001d60: 2c20 6561 6368 2077 6974 6820 6120 756e  , each with a un
+00001d70: 6971 7565 206e 616d 6520 746f 2061 766f  ique name to avo
+00001d80: 6964 0a20 2020 2023 2020 2020 6261 7365  id.    #    base
+00001d90: 6e61 6d65 2063 6f6e 666c 6963 7473 0a20  name conflicts. 
+00001da0: 2020 2023 2020 2d20 7570 6c6f 6164 2074     #  - upload t
+00001db0: 6861 7420 6469 7265 6374 6f72 7920 6173  hat directory as
+00001dc0: 2061 2066 696c 6520 6d6f 756e 7420 2831   a file mount (1
+00001dd0: 2063 6f6e 6e65 6374 696f 6e29 0a20 2020   connection).   
+00001de0: 2023 2020 2d20 7573 6520 6120 7265 6d6f   #  - use a remo
+00001df0: 7465 2063 6f6d 6d61 6e64 2074 6f20 6d6f  te command to mo
+00001e00: 7665 2061 6c6c 2072 756e 7469 6d65 2066  ve all runtime f
+00001e10: 696c 6573 2074 6f20 7468 6569 7220 7269  iles to their ri
+00001e20: 6768 7420 706c 6163 6573 2e0a 0a20 2020  ght places...   
+00001e30: 2023 204c 6f63 616c 2074 6d70 2064 6972   # Local tmp dir
+00001e40: 2068 6f6c 6469 6e67 2072 756e 7469 6d65   holding runtime
+00001e50: 2066 696c 6573 2e0a 2020 2020 6c6f 6361   files..    loca
+00001e60: 6c5f 7275 6e74 696d 655f 6669 6c65 735f  l_runtime_files_
+00001e70: 6469 7220 3d20 7465 6d70 6669 6c65 2e6d  dir = tempfile.m
+00001e80: 6b64 7465 6d70 2829 0a20 2020 206e 6577  kdtemp().    new
+00001e90: 5f66 696c 655f 6d6f 756e 7473 203d 207b  _file_mounts = {
+00001ea0: 5f52 454d 4f54 455f 5255 4e54 494d 455f  _REMOTE_RUNTIME_
+00001eb0: 4649 4c45 535f 4449 523a 206c 6f63 616c  FILES_DIR: local
+00001ec0: 5f72 756e 7469 6d65 5f66 696c 6573 5f64  _runtime_files_d
+00001ed0: 6972 7d0a 0a20 2020 2023 2047 656e 6572  ir}..    # Gener
+00001ee0: 6174 6520 6c6f 6361 6c5f 7372 6320 2d3e  ate local_src ->
+00001ef0: 2075 6e69 7175 655f 6e61 6d65 2e0a 2020   unique_name..  
+00001f00: 2020 6c6f 6361 6c5f 736f 7572 6365 5f74    local_source_t
+00001f10: 6f5f 756e 6971 7565 5f6e 616d 6520 3d20  o_unique_name = 
+00001f20: 7b7d 0a20 2020 2066 6f72 206c 6f63 616c  {}.    for local
+00001f30: 5f73 7263 2069 6e20 6669 6c65 5f6d 6f75  _src in file_mou
+00001f40: 6e74 732e 7661 6c75 6573 2829 3a0a 2020  nts.values():.  
+00001f50: 2020 2020 2020 6c6f 6361 6c5f 736f 7572        local_sour
+00001f60: 6365 5f74 6f5f 756e 6971 7565 5f6e 616d  ce_to_unique_nam
+00001f70: 655b 6c6f 6361 6c5f 7372 635d 203d 2073  e[local_src] = s
+00001f80: 7472 2875 7569 642e 7575 6964 3428 2929  tr(uuid.uuid4())
+00001f90: 0a0a 2020 2020 2320 2846 6f72 2072 656d  ..    # (For rem
+00001fa0: 6f74 6529 2042 7569 6c64 2061 2063 6f6d  ote) Build a com
+00001fb0: 6d61 6e64 2074 6861 7420 636f 7069 6573  mand that copies
+00001fc0: 2072 756e 7469 6d65 2066 696c 6573 2074   runtime files t
+00001fd0: 6f20 7468 6569 7220 7269 6768 740a 2020  o their right.  
+00001fe0: 2020 2320 6465 7374 696e 6174 696f 6e73    # destinations
+00001ff0: 2e0a 2020 2020 2320 4e4f 5445 3a20 7765  ..    # NOTE: we
+00002000: 2063 6f70 7920 7261 7468 6572 2074 6861   copy rather tha
+00002010: 6e20 6d6f 7665 2c20 6265 6361 7573 6520  n move, because 
+00002020: 7768 656e 206c 6175 6e63 6869 6e67 203e  when launching >
+00002030: 3120 6e6f 6465 2c20 6865 6164 206e 6f64  1 node, head nod
+00002040: 650a 2020 2020 2320 6973 2066 756c 6c79  e.    # is fully
+00002050: 2073 6574 2075 7020 6669 7273 742c 2061   set up first, a
+00002060: 6e64 2069 6620 6d6f 7669 6e67 2074 6865  nd if moving the
+00002070: 6e20 6865 6164 206e 6f64 6527 7320 6669  n head node's fi
+00002080: 6c65 7320 776f 756c 6420 616c 7265 6164  les would alread
+00002090: 790a 2020 2020 2320 6d6f 7665 206f 7574  y.    # move out
+000020a0: 206f 6620 5f52 454d 4f54 455f 5255 4e54   of _REMOTE_RUNT
+000020b0: 494d 455f 4649 4c45 535f 4449 522c 2077  IME_FILES_DIR, w
+000020c0: 6869 6368 2077 6f75 6c64 2063 6175 7365  hich would cause
+000020d0: 2073 6574 7469 6e67 2075 700a 2020 2020   setting up.    
+000020e0: 2320 776f 726b 6572 7320 2866 726f 6d20  # workers (from 
+000020f0: 7468 6520 6865 6164 2773 2066 696c 6573  the head's files
+00002100: 2920 746f 2066 6169 6c2e 2020 416e 2061  ) to fail.  An a
+00002110: 6c74 6572 6e61 7469 7665 2069 7320 736f  lternative is so
+00002120: 6674 6c69 6e6b 0a20 2020 2023 2028 7468  ftlink.    # (th
+00002130: 656e 2077 6520 6e65 6564 2074 6f20 6d61  en we need to ma
+00002140: 6b65 2073 7572 6520 7468 6520 7573 6167  ke sure the usag
+00002150: 6520 6f66 2072 756e 7469 6d65 2066 696c  e of runtime fil
+00002160: 6573 2066 6f6c 6c6f 7720 6c69 6e6b 7329  es follow links)
+00002170: 2e0a 2020 2020 636f 6d6d 616e 6473 203d  ..    commands =
+00002180: 205b 5d0a 2020 2020 6261 7365 6e61 6d65   [].    basename
+00002190: 7320 3d20 7365 7428 290a 2020 2020 666f  s = set().    fo
+000021a0: 7220 6473 742c 2073 7263 2069 6e20 6669  r dst, src in fi
+000021b0: 6c65 5f6d 6f75 6e74 732e 6974 656d 7328  le_mounts.items(
+000021c0: 293a 0a20 2020 2020 2020 2073 7263 5f62  ):.        src_b
+000021d0: 6173 656e 616d 6520 3d20 6c6f 6361 6c5f  asename = local_
+000021e0: 736f 7572 6365 5f74 6f5f 756e 6971 7565  source_to_unique
+000021f0: 5f6e 616d 655b 7372 635d 0a20 2020 2020  _name[src].     
+00002200: 2020 2064 7374 5f62 6173 656e 616d 6520     dst_basename 
+00002210: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+00002220: 6d65 2864 7374 290a 2020 2020 2020 2020  me(dst).        
+00002230: 6473 745f 7061 7265 6e74 5f64 6972 203d  dst_parent_dir =
+00002240: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
+00002250: 2864 7374 290a 0a20 2020 2020 2020 2023  (dst)..        #
+00002260: 2056 616c 6964 6174 6520 6279 2061 7373   Validate by ass
+00002270: 6572 7473 2068 6572 6520 6173 2074 6865  erts here as the
+00002280: 7365 2066 696c 6573 2061 7265 2061 6464  se files are add
+00002290: 6564 2062 7920 6f75 7220 6261 636b 656e  ed by our backen
+000022a0: 642e 0a20 2020 2020 2020 2023 204f 7572  d..        # Our
+000022b0: 2072 756e 7469 6d65 2066 696c 6573 2028   runtime files (
+000022c0: 7768 6565 6c2c 2079 616d 6c2c 2063 7265  wheel, yaml, cre
+000022d0: 6465 6e74 6961 6c73 2920 646f 206e 6f74  dentials) do not
+000022e0: 2068 6176 6520 6261 636b 736c 6173 6865   have backslashe
+000022f0: 732e 0a20 2020 2020 2020 2061 7373 6572  s..        asser
+00002300: 7420 6e6f 7420 7372 632e 656e 6473 7769  t not src.endswi
+00002310: 7468 2827 2f27 292c 2073 7263 0a20 2020  th('/'), src.   
+00002320: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00002330: 6473 742e 656e 6473 7769 7468 2827 2f27  dst.endswith('/'
+00002340: 292c 2064 7374 0a20 2020 2020 2020 2061  ), dst.        a
+00002350: 7373 6572 7420 7372 635f 6261 7365 6e61  ssert src_basena
+00002360: 6d65 206e 6f74 2069 6e20 6261 7365 6e61  me not in basena
+00002370: 6d65 732c 2028 0a20 2020 2020 2020 2020  mes, (.         
+00002380: 2020 2066 2744 7570 6c69 6361 7465 6420     f'Duplicated 
+00002390: 7372 6320 6261 7365 6e61 6d65 3a20 7b73  src basename: {s
+000023a0: 7263 5f62 6173 656e 616d 657d 3b20 6d6f  rc_basename}; mo
+000023b0: 756e 7473 3a20 7b66 696c 655f 6d6f 756e  unts: {file_moun
+000023c0: 7473 7d27 290a 2020 2020 2020 2020 6261  ts}').        ba
+000023d0: 7365 6e61 6d65 732e 6164 6428 7372 635f  senames.add(src_
+000023e0: 6261 7365 6e61 6d65 290a 2020 2020 2020  basename).      
+000023f0: 2020 2320 4f75 7220 7275 6e74 696d 6520    # Our runtime 
+00002400: 6669 6c65 7320 2877 6865 656c 2c20 7961  files (wheel, ya
+00002410: 6d6c 2c20 6372 6564 656e 7469 616c 7329  ml, credentials)
+00002420: 2061 7265 206e 6f74 2072 656c 6174 6976   are not relativ
+00002430: 6520 7061 7468 732e 0a20 2020 2020 2020  e paths..       
+00002440: 2061 7373 6572 7420 6473 745f 7061 7265   assert dst_pare
+00002450: 6e74 5f64 6972 2c20 6627 466f 756e 6420  nt_dir, f'Found 
+00002460: 7265 6c61 7469 7665 2064 6573 7469 6e61  relative destina
+00002470: 7469 6f6e 2070 6174 683a 207b 6473 747d  tion path: {dst}
+00002480: 270a 0a20 2020 2020 2020 206d 6b64 6972  '..        mkdir
+00002490: 5f70 6172 656e 7420 3d20 6627 6d6b 6469  _parent = f'mkdi
+000024a0: 7220 2d70 207b 6473 745f 7061 7265 6e74  r -p {dst_parent
+000024b0: 5f64 6972 7d27 0a20 2020 2020 2020 2069  _dir}'.        i
+000024c0: 6620 6f73 2e70 6174 682e 6973 6469 7228  f os.path.isdir(
+000024d0: 6f73 2e70 6174 682e 6578 7061 6e64 7573  os.path.expandus
+000024e0: 6572 2873 7263 2929 3a0a 2020 2020 2020  er(src)):.      
+000024f0: 2020 2020 2020 2320 5370 6563 6961 6c20        # Special 
+00002500: 6361 7365 2066 6f72 2064 6972 6563 746f  case for directo
+00002510: 7269 6573 2e20 4966 2074 6865 2064 7374  ries. If the dst
+00002520: 2061 6c72 6561 6479 2065 7869 7374 7320   already exists 
+00002530: 6173 2061 0a20 2020 2020 2020 2020 2020  as a.           
+00002540: 2023 2066 6f6c 6465 722c 2064 6972 6563   # folder, direc
+00002550: 746c 7920 636f 7079 2074 6865 2066 6f6c  tly copy the fol
+00002560: 6465 7220 7769 6c6c 2063 7265 6174 6520  der will create 
+00002570: 6120 7375 6266 6f6c 6465 7220 756e 6465  a subfolder unde
+00002580: 720a 2020 2020 2020 2020 2020 2020 2320  r.            # 
+00002590: 7468 6520 6473 742e 0a20 2020 2020 2020  the dst..       
+000025a0: 2020 2020 206d 6b64 6972 5f70 6172 656e       mkdir_paren
+000025b0: 7420 3d20 6627 6d6b 6469 7220 2d70 207b  t = f'mkdir -p {
+000025c0: 6473 747d 270a 2020 2020 2020 2020 2020  dst}'.          
+000025d0: 2020 7372 635f 6261 7365 6e61 6d65 203d    src_basename =
+000025e0: 2066 277b 7372 635f 6261 7365 6e61 6d65   f'{src_basename
+000025f0: 7d2f 2a27 0a20 2020 2020 2020 206d 7620  }/*'.        mv 
+00002600: 3d20 2866 2763 7020 2d72 207b 5f52 454d  = (f'cp -r {_REM
+00002610: 4f54 455f 5255 4e54 494d 455f 4649 4c45  OTE_RUNTIME_FILE
+00002620: 535f 4449 527d 2f7b 7372 635f 6261 7365  S_DIR}/{src_base
+00002630: 6e61 6d65 7d20 270a 2020 2020 2020 2020  name} '.        
+00002640: 2020 2020 2020 6627 7b64 7374 5f70 6172        f'{dst_par
+00002650: 656e 745f 6469 727d 2f7b 6473 745f 6261  ent_dir}/{dst_ba
+00002660: 7365 6e61 6d65 7d27 290a 2020 2020 2020  sename}').      
+00002670: 2020 6672 6167 6d65 6e74 203d 2066 2728    fragment = f'(
+00002680: 7b6d 6b64 6972 5f70 6172 656e 747d 2026  {mkdir_parent} &
+00002690: 2620 7b6d 767d 2927 0a20 2020 2020 2020  & {mv})'.       
+000026a0: 2063 6f6d 6d61 6e64 732e 6170 7065 6e64   commands.append
+000026b0: 2866 7261 676d 656e 7429 0a20 2020 2070  (fragment).    p
+000026c0: 6f73 7470 726f 6365 7373 5f72 756e 7469  ostprocess_runti
+000026d0: 6d65 5f66 696c 6573 5f63 6f6d 6d61 6e64  me_files_command
+000026e0: 203d 2027 2026 2620 272e 6a6f 696e 2863   = ' && '.join(c
+000026f0: 6f6d 6d61 6e64 7329 0a0a 2020 2020 7365  ommands)..    se
+00002700: 7475 705f 636f 6d6d 616e 6473 203d 2079  tup_commands = y
+00002710: 616d 6c5f 636f 6e66 6967 2e67 6574 2827  aml_config.get('
+00002720: 7365 7475 705f 636f 6d6d 616e 6473 272c  setup_commands',
+00002730: 205b 5d29 0a20 2020 2069 6620 7365 7475   []).    if setu
+00002740: 705f 636f 6d6d 616e 6473 3a0a 2020 2020  p_commands:.    
+00002750: 2020 2020 7365 7475 705f 636f 6d6d 616e      setup_comman
+00002760: 6473 5b0a 2020 2020 2020 2020 2020 2020  ds[.            
+00002770: 305d 203d 2066 277b 706f 7374 7072 6f63  0] = f'{postproc
+00002780: 6573 735f 7275 6e74 696d 655f 6669 6c65  ess_runtime_file
+00002790: 735f 636f 6d6d 616e 647d 3b20 7b73 6574  s_command}; {set
+000027a0: 7570 5f63 6f6d 6d61 6e64 735b 305d 7d27  up_commands[0]}'
+000027b0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000027c0: 2020 2073 6574 7570 5f63 6f6d 6d61 6e64     setup_command
+000027d0: 7320 3d20 5b70 6f73 7470 726f 6365 7373  s = [postprocess
+000027e0: 5f72 756e 7469 6d65 5f66 696c 6573 5f63  _runtime_files_c
+000027f0: 6f6d 6d61 6e64 5d0a 0a20 2020 2079 616d  ommand]..    yam
+00002800: 6c5f 636f 6e66 6967 5b27 6669 6c65 5f6d  l_config['file_m
+00002810: 6f75 6e74 7327 5d20 3d20 6e65 775f 6669  ounts'] = new_fi
+00002820: 6c65 5f6d 6f75 6e74 730a 2020 2020 7961  le_mounts.    ya
+00002830: 6d6c 5f63 6f6e 6669 675b 2773 6574 7570  ml_config['setup
+00002840: 5f63 6f6d 6d61 6e64 7327 5d20 3d20 7365  _commands'] = se
+00002850: 7475 705f 636f 6d6d 616e 6473 0a0a 2020  tup_commands..  
+00002860: 2020 2320 2846 6f72 206c 6f63 616c 2920    # (For local) 
+00002870: 436f 7079 2061 6c6c 2072 756e 7469 6d65  Copy all runtime
+00002880: 2066 696c 6573 2c20 696e 636c 7564 696e   files, includin
+00002890: 6720 7468 6520 6a75 7374 2d77 7269 7474  g the just-writt
+000028a0: 656e 2079 616d 6c2c 2074 6f0a 2020 2020  en yaml, to.    
+000028b0: 2320 6c6f 6361 6c5f 7275 6e74 696d 655f  # local_runtime_
+000028c0: 6669 6c65 735f 6469 722f 2e0a 2020 2020  files_dir/..    
+000028d0: 2320 3c20 302e 3373 2074 6f20 6370 2036  # < 0.3s to cp 6
+000028e0: 2063 6c6f 7564 7327 2063 7265 6465 6e74   clouds' credent
+000028f0: 6961 6c73 2e0a 2020 2020 666f 7220 6c6f  ials..    for lo
+00002900: 6361 6c5f 7372 6320 696e 2066 696c 655f  cal_src in file_
+00002910: 6d6f 756e 7473 2e76 616c 7565 7328 293a  mounts.values():
+00002920: 0a20 2020 2020 2020 2023 2063 7020 3c6c  .        # cp <l
+00002930: 6f63 616c 5f73 7263 3e20 3c6c 6f63 616c  ocal_src> <local
+00002940: 5f72 756e 7469 6d65 5f66 696c 6573 5f64  _runtime_files_d
+00002950: 6972 3e2f 3c75 6e69 7175 6520 6e61 6d65  ir>/<unique name
+00002960: 206f 6620 6c6f 6361 6c5f 7372 633e 2e0a   of local_src>..
+00002970: 2020 2020 2020 2020 6675 6c6c 5f6c 6f63          full_loc
+00002980: 616c 5f73 7263 203d 2073 7472 2870 6174  al_src = str(pat
+00002990: 686c 6962 2e50 6174 6828 6c6f 6361 6c5f  hlib.Path(local_
+000029a0: 7372 6329 2e65 7870 616e 6475 7365 7228  src).expanduser(
+000029b0: 2929 0a20 2020 2020 2020 2075 6e69 7175  )).        uniqu
+000029c0: 655f 6e61 6d65 203d 206c 6f63 616c 5f73  e_name = local_s
+000029d0: 6f75 7263 655f 746f 5f75 6e69 7175 655f  ource_to_unique_
+000029e0: 6e61 6d65 5b6c 6f63 616c 5f73 7263 5d0a  name[local_src].
+000029f0: 2020 2020 2020 2020 2320 2172 2074 6f20          # !r to 
+00002a00: 6164 6420 7175 6f74 6573 2066 6f72 2070  add quotes for p
+00002a10: 6174 6873 2063 6f6e 7461 696e 696e 6720  aths containing 
+00002a20: 7370 6163 6573 2e0a 2020 2020 2020 2020  spaces..        
+00002a30: 7375 6270 726f 6365 7373 2e72 756e 280a  subprocess.run(.
+00002a40: 2020 2020 2020 2020 2020 2020 6627 6370              f'cp
+00002a50: 202d 7220 7b66 756c 6c5f 6c6f 6361 6c5f   -r {full_local_
+00002a60: 7372 6321 727d 207b 6c6f 6361 6c5f 7275  src!r} {local_ru
+00002a70: 6e74 696d 655f 6669 6c65 735f 6469 727d  ntime_files_dir}
+00002a80: 2f7b 756e 6971 7565 5f6e 616d 657d 272c  /{unique_name}',
+00002a90: 0a20 2020 2020 2020 2020 2020 2073 6865  .            she
+00002aa0: 6c6c 3d54 7275 652c 0a20 2020 2020 2020  ll=True,.       
+00002ab0: 2020 2020 2063 6865 636b 3d54 7275 6529       check=True)
+00002ac0: 0a0a 2020 2020 636f 6d6d 6f6e 5f75 7469  ..    common_uti
+00002ad0: 6c73 2e64 756d 705f 7961 6d6c 2879 616d  ls.dump_yaml(yam
+00002ae0: 6c5f 7061 7468 2c20 7961 6d6c 5f63 6f6e  l_path, yaml_con
+00002af0: 6669 6729 0a0a 0a64 6566 2070 6174 685f  fig)...def path_
+00002b00: 7369 7a65 5f6d 6567 6162 7974 6573 2870  size_megabytes(p
+00002b10: 6174 683a 2073 7472 2920 2d3e 2069 6e74  ath: str) -> int
+00002b20: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
+00002b30: 2074 6865 2073 697a 6520 6f66 2027 7061   the size of 'pa
+00002b40: 7468 2720 2864 6972 6563 746f 7279 206f  th' (directory o
+00002b50: 7220 6669 6c65 2920 696e 206d 6567 6162  r file) in megab
+00002b60: 7974 6573 2e0a 0a20 2020 2052 6574 7572  ytes...    Retur
+00002b70: 6e73 3a0a 2020 2020 2020 2020 4966 2073  ns:.        If s
+00002b80: 7563 6365 7373 6675 6c3a 2074 6865 2073  uccessful: the s
+00002b90: 697a 6520 6f66 2027 7061 7468 2720 696e  ize of 'path' in
+00002ba0: 206d 6567 6162 7974 6573 2c20 726f 756e   megabytes, roun
+00002bb0: 6465 6420 646f 776e 2e20 4f74 6865 7277  ded down. Otherw
+00002bc0: 6973 652c 0a20 2020 2020 2020 202d 312e  ise,.        -1.
+00002bd0: 0a20 2020 2022 2222 0a20 2020 2072 6573  .    """.    res
+00002be0: 6f6c 7665 645f 7061 7468 203d 2070 6174  olved_path = pat
+00002bf0: 686c 6962 2e50 6174 6828 7061 7468 292e  hlib.Path(path).
+00002c00: 6578 7061 6e64 7573 6572 2829 2e72 6573  expanduser().res
+00002c10: 6f6c 7665 2829 0a20 2020 2067 6974 5f65  olve().    git_e
+00002c20: 7863 6c75 6465 5f66 696c 7465 7220 3d20  xclude_filter = 
+00002c30: 2727 0a20 2020 2069 6620 2872 6573 6f6c  ''.    if (resol
+00002c40: 7665 645f 7061 7468 202f 2063 6f6d 6d61  ved_path / comma
+00002c50: 6e64 5f72 756e 6e65 722e 4749 545f 4558  nd_runner.GIT_EX
+00002c60: 434c 5544 4529 2e65 7869 7374 7328 293a  CLUDE).exists():
+00002c70: 0a20 2020 2020 2020 2023 2045 6e73 7572  .        # Ensur
+00002c80: 6520 6669 6c65 2065 7869 7374 733b 206f  e file exists; o
+00002c90: 7468 6572 7769 7365 2c20 7273 796e 6320  therwise, rsync 
+00002ca0: 7769 6c6c 2065 7272 6f72 206f 7574 2e0a  will error out..
+00002cb0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00002cc0: 2020 2320 5765 2073 686c 6578 2e71 756f    # We shlex.quo
+00002cd0: 7465 2829 2062 6563 6175 7365 2074 6865  te() because the
+00002ce0: 2070 6174 6820 6d61 7920 636f 6e74 6169   path may contai
+00002cf0: 6e20 7370 6163 6573 3a0a 2020 2020 2020  n spaces:.      
+00002d00: 2020 2320 2020 276d 7920 6469 722f 2e67    #   'my dir/.g
+00002d10: 6974 2f69 6e66 6f2f 6578 636c 7564 6527  it/info/exclude'
+00002d20: 0a20 2020 2020 2020 2023 2057 6974 686f  .        # Witho
+00002d30: 7574 2071 756f 7469 6e67 2072 7379 6e63  ut quoting rsync
+00002d40: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
+00002d50: 6769 745f 6578 636c 7564 655f 6669 6c74  git_exclude_filt
+00002d60: 6572 203d 2063 6f6d 6d61 6e64 5f72 756e  er = command_run
+00002d70: 6e65 722e 5253 594e 435f 4558 434c 5544  ner.RSYNC_EXCLUD
+00002d80: 455f 4f50 5449 4f4e 2e66 6f72 6d61 7428  E_OPTION.format(
+00002d90: 0a20 2020 2020 2020 2020 2020 2073 686c  .            shl
+00002da0: 6578 2e71 756f 7465 2873 7472 2872 6573  ex.quote(str(res
+00002db0: 6f6c 7665 645f 7061 7468 202f 2063 6f6d  olved_path / com
+00002dc0: 6d61 6e64 5f72 756e 6e65 722e 4749 545f  mand_runner.GIT_
+00002dd0: 4558 434c 5544 4529 2929 0a20 2020 2072  EXCLUDE))).    r
+00002de0: 7379 6e63 5f63 6f6d 6d61 6e64 203d 2028  sync_command = (
+00002df0: 6627 7273 796e 6320 7b63 6f6d 6d61 6e64  f'rsync {command
+00002e00: 5f72 756e 6e65 722e 5253 594e 435f 4449  _runner.RSYNC_DI
+00002e10: 5350 4c41 595f 4f50 5449 4f4e 7d20 270a  SPLAY_OPTION} '.
+00002e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e30: 2020 2020 2066 277b 636f 6d6d 616e 645f       f'{command_
+00002e40: 7275 6e6e 6572 2e52 5359 4e43 5f46 494c  runner.RSYNC_FIL
+00002e50: 5445 525f 4f50 5449 4f4e 7d20 270a 2020  TER_OPTION} '.  
+00002e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e70: 2020 2066 277b 6769 745f 6578 636c 7564     f'{git_exclud
+00002e80: 655f 6669 6c74 6572 7d20 2d2d 6472 792d  e_filter} --dry-
+00002e90: 7275 6e20 7b70 6174 6821 727d 2729 0a20  run {path!r}'). 
+00002ea0: 2020 2072 7379 6e63 5f6f 7574 7075 7420     rsync_output 
+00002eb0: 3d20 2727 0a20 2020 2074 7279 3a0a 2020  = ''.    try:.  
+00002ec0: 2020 2020 2020 7273 796e 635f 6f75 7470        rsync_outp
+00002ed0: 7574 203d 2073 7472 2873 7562 7072 6f63  ut = str(subproc
+00002ee0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00002ef0: 2872 7379 6e63 5f63 6f6d 6d61 6e64 2c20  (rsync_command, 
+00002f00: 7368 656c 6c3d 5472 7565 2929 0a20 2020  shell=True)).   
+00002f10: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
+00002f20: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
+00002f30: 4572 726f 723a 0a20 2020 2020 2020 206c  Error:.        l
+00002f40: 6f67 6765 722e 6465 6275 6728 2743 6f6d  ogger.debug('Com
+00002f50: 6d61 6e64 2066 6169 6c65 642c 2070 726f  mand failed, pro
+00002f60: 6365 6564 696e 6720 7769 7468 6f75 7420  ceeding without 
+00002f70: 6573 7469 6d61 7469 6e67 2073 697a 653a  estimating size:
+00002f80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00002f90: 2020 2020 2020 2020 6627 7b72 7379 6e63          f'{rsync
+00002fa0: 5f63 6f6d 6d61 6e64 7d27 290a 2020 2020  _command}').    
+00002fb0: 2020 2020 7265 7475 726e 202d 310a 2020      return -1.  
+00002fc0: 2020 2320 332e 322e 333a 0a20 2020 2023    # 3.2.3:.    #
+00002fd0: 2020 746f 7461 6c20 7369 7a65 2069 7320    total size is 
+00002fe0: 3235 302c 3935 372c 3732 3820 2073 7065  250,957,728  spe
+00002ff0: 6564 7570 2069 7320 3333 302e 3139 2028  edup is 330.19 (
+00003000: 4452 5920 5255 4e29 0a20 2020 2023 2032  DRY RUN).    # 2
+00003010: 2e36 2e39 3a0a 2020 2020 2320 2074 6f74  .6.9:.    #  tot
+00003020: 616c 2073 697a 6520 6973 2032 3132 3632  al size is 21262
+00003030: 3735 3536 2020 7370 6565 6475 7020 6973  7556  speedup is
+00003040: 2032 3433 372e 3431 0a20 2020 206d 6174   2437.41.    mat
+00003050: 6368 203d 2072 652e 7365 6172 6368 2872  ch = re.search(r
+00003060: 2774 6f74 616c 2073 697a 6520 6973 2028  'total size is (
+00003070: 5b5c 642c 5d2b 2927 2c20 7273 796e 635f  [\d,]+)', rsync_
+00003080: 6f75 7470 7574 290a 2020 2020 6966 206d  output).    if m
+00003090: 6174 6368 2069 7320 6e6f 7420 4e6f 6e65  atch is not None
+000030a0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+000030b0: 2020 2020 2020 2020 2020 2074 6f74 616c             total
+000030c0: 5f62 7974 6573 203d 2069 6e74 2866 6c6f  _bytes = int(flo
+000030d0: 6174 286d 6174 6368 2e67 726f 7570 2831  at(match.group(1
+000030e0: 292e 7265 706c 6163 6528 272c 272c 2027  ).replace(',', '
+000030f0: 2729 2929 0a20 2020 2020 2020 2020 2020  '))).           
+00003100: 2072 6574 7572 6e20 746f 7461 6c5f 6279   return total_by
+00003110: 7465 7320 2f2f 2028 3130 3234 2a2a 3229  tes // (1024**2)
+00003120: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00003130: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+00003140: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00003150: 6562 7567 2827 4661 696c 6564 2074 6f20  ebug('Failed to 
+00003160: 6669 6e64 2022 746f 7461 6c20 7369 7a65  find "total size
+00003170: 2220 696e 2072 7379 6e63 206f 7574 7075  " in rsync outpu
+00003180: 742e 2049 6e73 7065 6374 2027 0a20 2020  t. Inspect '.   
+00003190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000031a0: 2020 2020 2020 6627 6f75 7470 7574 206f        f'output o
+000031b0: 6620 7468 6520 666f 6c6c 6f77 696e 6720  f the following 
+000031c0: 636f 6d6d 616e 643a 207b 7273 796e 635f  command: {rsync_
+000031d0: 636f 6d6d 616e 647d 2729 0a20 2020 2020  command}').     
+000031e0: 2020 2020 2020 2070 6173 7320 2023 204d         pass  # M
+000031f0: 6179 6265 2064 6966 6665 7265 6e74 2072  aybe different r
+00003200: 7379 6e63 2076 6572 7369 6f6e 7320 6861  sync versions ha
+00003210: 7665 2064 6966 6665 7265 6e74 206f 7574  ve different out
+00003220: 7075 742e 0a20 2020 2072 6574 7572 6e20  put..    return 
+00003230: 2d31 0a0a 0a63 6c61 7373 2046 696c 654d  -1...class FileM
+00003240: 6f75 6e74 4865 6c70 6572 286f 626a 6563  ountHelper(objec
+00003250: 7429 3a0a 2020 2020 2222 2248 656c 7065  t):.    """Helpe
+00003260: 7220 666f 7220 6861 6e64 6c69 6e67 2066  r for handling f
+00003270: 696c 6520 6d6f 756e 7473 2e22 2222 0a0a  ile mounts."""..
+00003280: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00003290: 0a20 2020 2064 6566 2077 7261 705f 6669  .    def wrap_fi
+000032a0: 6c65 5f6d 6f75 6e74 2863 6c73 2c20 7061  le_mount(cls, pa
+000032b0: 7468 3a20 7374 7229 202d 3e20 7374 723a  th: str) -> str:
+000032c0: 0a20 2020 2020 2020 2022 2222 5072 6570  .        """Prep
+000032d0: 656e 6473 207e 2f3c 6f70 6171 7565 2064  ends ~/<opaque d
+000032e0: 6972 3e2f 2074 6f20 6120 7061 7468 2074  ir>/ to a path t
+000032f0: 6f20 776f 726b 2061 726f 756e 6420 7065  o work around pe
+00003300: 726d 6973 7369 6f6e 2069 7373 7565 732e  rmission issues.
+00003310: 0a0a 2020 2020 2020 2020 4578 616d 706c  ..        Exampl
+00003320: 6573 3a0a 2020 2020 2020 2020 2f72 6f6f  es:.        /roo
+00003330: 742f 6865 6c6c 6f2e 7478 7420 2d3e 207e  t/hello.txt -> ~
+00003340: 2f3c 6f70 6171 7565 2064 6972 3e2f 726f  /<opaque dir>/ro
+00003350: 6f74 2f68 656c 6c6f 2e74 7874 0a20 2020  ot/hello.txt.   
+00003360: 2020 2020 206c 6f63 616c 2e74 7874 202d       local.txt -
+00003370: 3e20 7e2f 3c6f 7061 7175 6520 6469 723e  > ~/<opaque dir>
+00003380: 2f6c 6f63 616c 2e74 7874 0a0a 2020 2020  /local.txt..    
+00003390: 2020 2020 4166 7465 7220 7468 6520 7061      After the pa
+000033a0: 7468 2069 7320 7379 6e63 6564 2c20 7765  th is synced, we
+000033b0: 2063 616e 206c 6174 6572 2063 7265 6174   can later creat
+000033c0: 6520 6120 7379 6d6c 696e 6b20 746f 2074  e a symlink to t
+000033d0: 6869 7320 7772 6170 7065 640a 2020 2020  his wrapped.    
+000033e0: 2020 2020 7061 7468 2066 726f 6d20 7468      path from th
+000033f0: 6520 6f72 6967 696e 616c 2070 6174 682c  e original path,
+00003400: 2065 2e67 2e2c 2069 6e20 7468 6520 696e   e.g., in the in
+00003410: 6974 6961 6c69 7a61 7469 6f6e 5f63 6f6d  itialization_com
+00003420: 6d61 6e64 7320 6f66 2074 6865 0a20 2020  mands of the.   
+00003430: 2020 2020 2072 6179 2061 7574 6f73 6361       ray autosca
+00003440: 6c65 7220 5941 4d4c 2e0a 2020 2020 2020  ler YAML..      
+00003450: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00003460: 7475 726e 206f 732e 7061 7468 2e6a 6f69  turn os.path.joi
+00003470: 6e28 5f53 4b59 5f52 454d 4f54 455f 4649  n(_SKY_REMOTE_FI
+00003480: 4c45 5f4d 4f55 4e54 535f 4449 522c 2070  LE_MOUNTS_DIR, p
+00003490: 6174 682e 6c73 7472 6970 2827 2f27 2929  ath.lstrip('/'))
+000034a0: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
+000034b0: 6f64 0a20 2020 2064 6566 206d 616b 655f  od.    def make_
+000034c0: 7361 6665 5f73 796d 6c69 6e6b 5f63 6f6d  safe_symlink_com
+000034d0: 6d61 6e64 2863 6c73 2c20 2a2c 2073 6f75  mand(cls, *, sou
+000034e0: 7263 653a 2073 7472 2c20 7461 7267 6574  rce: str, target
+000034f0: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
+00003500: 2020 2020 2020 2022 2222 5265 7475 726e         """Return
+00003510: 7320 6120 636f 6d6d 616e 6420 7468 6174  s a command that
+00003520: 2073 6166 656c 7920 7379 6d6c 696e 6b73   safely symlinks
+00003530: 2027 736f 7572 6365 2720 746f 2027 7461   'source' to 'ta
+00003540: 7267 6574 272e 0a0a 2020 2020 2020 2020  rget'...        
+00003550: 416c 6c20 696e 7465 726d 6564 6961 7465  All intermediate
+00003560: 2064 6972 6563 746f 7269 6573 206f 6620   directories of 
+00003570: 2773 6f75 7263 6527 2077 696c 6c20 6265  'source' will be
+00003580: 206f 776e 6564 2062 7920 2455 5345 522c   owned by $USER,
+00003590: 0a20 2020 2020 2020 2065 7863 6c75 6469  .        excludi
+000035a0: 6e67 2074 6865 2072 6f6f 7420 6469 7265  ng the root dire
+000035b0: 6374 6f72 7920 282f 292e 0a0a 2020 2020  ctory (/)...    
+000035c0: 2020 2020 2773 6f75 7263 6527 206d 7573      'source' mus
+000035d0: 7420 6265 2061 6e20 6162 736f 6c75 7465  t be an absolute
+000035e0: 2070 6174 683b 2062 6f74 6820 2773 6f75   path; both 'sou
+000035f0: 7263 6527 2061 6e64 2027 7461 7267 6574  rce' and 'target
+00003600: 2720 6d75 7374 206e 6f74 0a20 2020 2020  ' must not.     
+00003610: 2020 2065 6e64 2077 6974 6820 6120 736c     end with a sl
+00003620: 6173 6820 282f 292e 0a0a 2020 2020 2020  ash (/)...      
+00003630: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+00003640: 6973 206e 6565 6465 6420 6265 6361 7573  is needed becaus
+00003650: 6520 6120 7369 6d70 6c65 2027 6c6e 202d  e a simple 'ln -
+00003660: 7320 7461 7267 6574 2073 6f75 7263 6527  s target source'
+00003670: 206d 6179 0a20 2020 2020 2020 2066 6169   may.        fai
+00003680: 6c3a 2027 736f 7572 6365 2720 6361 6e20  l: 'source' can 
+00003690: 6861 7665 206d 756c 7469 706c 6520 6c65  have multiple le
+000036a0: 7665 6c73 2028 2f61 2f62 2f63 292c 2069  vels (/a/b/c), i
+000036b0: 7473 2070 6172 656e 7420 6469 7273 206d  ts parent dirs m
+000036c0: 6179 0a20 2020 2020 2020 206f 7220 6d61  ay.        or ma
+000036d0: 7920 6e6f 7420 6578 6973 742c 2063 616e  y not exist, can
+000036e0: 2065 6e64 2077 6974 6820 6120 736c 6173   end with a slas
+000036f0: 682c 206f 7220 6d61 7920 6e65 6564 2073  h, or may need s
+00003700: 7564 6f20 6163 6365 7373 2c20 6574 632e  udo access, etc.
+00003710: 0a0a 2020 2020 2020 2020 4361 7365 7320  ..        Cases 
+00003720: 6f66 203c 7461 7267 6574 3a20 6c6f 6361  of <target: loca
+00003730: 6c3e 2066 696c 6520 6d6f 756e 7473 2061  l> file mounts a
+00003740: 6e64 2074 6865 6972 2062 6568 6176 696f  nd their behavio
+00003750: 7273 3a0a 0a20 2020 2020 2020 2020 2020  rs:..           
+00003760: 202f 6578 6973 7469 6e67 5f64 6972 3a20   /existing_dir: 
+00003770: 7e2f 6c6f 6361 6c2f 6469 720a 2020 2020  ~/local/dir.    
+00003780: 2020 2020 2020 2020 2020 2d20 6572 726f            - erro
+00003790: 7220 6f75 7420 7361 7969 6e67 2074 6869  r out saying thi
+000037a0: 7320 6361 6e6e 6f74 2062 6520 646f 6e65  s cannot be done
+000037b0: 2061 7320 4c48 5320 616c 7265 6164 7920   as LHS already 
+000037c0: 6578 6973 7473 0a20 2020 2020 2020 2020  exists.         
+000037d0: 2020 202f 6578 6973 7469 6e67 5f66 696c     /existing_fil
+000037e0: 653a 207e 2f6c 6f63 616c 2f66 696c 650a  e: ~/local/file.
+000037f0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+00003800: 6572 726f 7220 6f75 7420 7361 7969 6e67  error out saying
+00003810: 2074 6869 7320 6361 6e6e 6f74 2062 6520   this cannot be 
+00003820: 646f 6e65 2061 7320 4c48 5320 616c 7265  done as LHS alre
+00003830: 6164 7920 6578 6973 7473 0a20 2020 2020  ady exists.     
+00003840: 2020 2020 2020 202f 6578 6973 7469 6e67         /existing
+00003850: 5f73 796d 6c69 6e6b 3a20 7e2f 6c6f 6361  _symlink: ~/loca
+00003860: 6c2f 6669 6c65 0a20 2020 2020 2020 2020  l/file.         
+00003870: 2020 2020 202d 206f 7665 7277 7269 7465       - overwrite
+00003880: 2074 6865 2065 7869 7374 696e 6720 7379   the existing sy
+00003890: 6d6c 696e 6b3b 2074 6869 7320 6973 2069  mlink; this is i
+000038a0: 6d70 6f72 7461 6e74 2062 6563 6175 7365  mportant because
+000038b0: 2060 736b 790a 2020 2020 2020 2020 2020   `sky.          
+000038c0: 2020 2020 2020 6c61 756e 6368 6020 6361        launch` ca
+000038d0: 6e20 6265 2072 756e 206d 756c 7469 706c  n be run multipl
+000038e0: 6520 7469 6d65 730a 2020 2020 2020 2020  e times.        
+000038f0: 2020 2020 5061 7468 7320 7468 6174 2073      Paths that s
+00003900: 7461 7274 2077 6974 6820 7e2f 2061 6e64  tart with ~/ and
+00003910: 202f 746d 702f 2064 6f20 6e6f 7420 6861   /tmp/ do not ha
+00003920: 7665 2074 6865 2061 626f 7665 0a20 2020  ve the above.   
+00003930: 2020 2020 2020 2020 2072 6573 7472 6963           restric
+00003940: 7469 6f6e 733b 2074 6865 7920 6172 6520  tions; they are 
+00003950: 6465 6c65 6761 7465 6420 746f 2072 7379  delegated to rsy
+00003960: 6e63 2062 6568 6176 696f 7273 2e0a 2020  nc behaviors..  
+00003970: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003980: 2020 6173 7365 7274 206f 732e 7061 7468    assert os.path
+00003990: 2e69 7361 6273 2873 6f75 7263 6529 2c20  .isabs(source), 
+000039a0: 736f 7572 6365 0a20 2020 2020 2020 2061  source.        a
+000039b0: 7373 6572 7420 6e6f 7420 736f 7572 6365  ssert not source
+000039c0: 2e65 6e64 7377 6974 6828 272f 2729 2061  .endswith('/') a
+000039d0: 6e64 206e 6f74 2074 6172 6765 742e 656e  nd not target.en
+000039e0: 6473 7769 7468 2827 2f27 292c 2028 736f  dswith('/'), (so
+000039f0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
 00003a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a20: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00003a30: 7267 6574 290a 2020 2020 2020 2020 2320  rget).        # 
-00003a40: 4265 6c6f 772c 2075 7365 2073 7564 6f20  Below, use sudo 
-00003a50: 696e 2063 6173 6520 7468 6520 7379 6d6c  in case the syml
-00003a60: 696e 6b20 6e65 6564 7320 7375 646f 2061  ink needs sudo a
-00003a70: 6363 6573 7320 746f 2063 7265 6174 652e  ccess to create.
-00003a80: 0a20 2020 2020 2020 2023 2050 7265 7061  .        # Prepa
-00003a90: 7265 2074 6f20 6372 6561 7465 2074 6865  re to create the
-00003aa0: 2073 796d 6c69 6e6b 3a0a 2020 2020 2020   symlink:.      
-00003ab0: 2020 2320 2031 2e20 6d61 6b65 2073 7572    #  1. make sur
-00003ac0: 6520 6974 7320 6469 7228 7329 2065 7869  e its dir(s) exi
-00003ad0: 7374 2026 2061 7265 206f 776e 6564 2062  st & are owned b
-00003ae0: 7920 2455 5345 522e 0a20 2020 2020 2020  y $USER..       
-00003af0: 2064 6972 5f6f 665f 7379 6d6c 696e 6b20   dir_of_symlink 
-00003b00: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-00003b10: 6528 736f 7572 6365 290a 2020 2020 2020  e(source).      
-00003b20: 2020 636f 6d6d 616e 6473 203d 205b 0a20    commands = [. 
-00003b30: 2020 2020 2020 2020 2020 2023 206d 6b64             # mkd
-00003b40: 6972 2c20 7468 656e 206c 6f6f 7020 6f76  ir, then loop ov
-00003b50: 6572 2027 2f61 2f62 2f63 2720 6173 202f  er '/a/b/c' as /
-00003b60: 612c 202f 612f 622c 202f 612f 622f 632e  a, /a/b, /a/b/c.
-00003b70: 2020 466f 7220 6561 6368 2c0a 2020 2020    For each,.    
-00003b80: 2020 2020 2020 2020 2320 6368 6f77 6e20          # chown 
-00003b90: 2455 5345 5220 6f6e 2069 7420 736f 2075  $USER on it so u
-00003ba0: 7365 7220 6361 6e20 7573 6520 7468 6573  ser can use thes
-00003bb0: 6520 696e 7465 726d 6564 6961 7465 2064  e intermediate d
-00003bc0: 6972 730a 2020 2020 2020 2020 2020 2020  irs.            
-00003bd0: 2320 2865 7863 6c75 6469 6e67 202f 292e  # (excluding /).
-00003be0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003bf0: 7564 6f20 6d6b 6469 7220 2d70 207b 6469  udo mkdir -p {di
-00003c00: 725f 6f66 5f73 796d 6c69 6e6b 7d27 2c0a  r_of_symlink}',.
-00003c10: 2020 2020 2020 2020 2020 2020 2320 703a              # p:
-00003c20: 2070 6174 6820 736f 2066 6172 0a20 2020   path so far.   
-00003c30: 2020 2020 2020 2020 2028 2728 703d 2222           ('(p=""
-00003c40: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00003c50: 2066 2766 6f72 2077 2069 6e20 2428 6563   f'for w in $(ec
-00003c60: 686f 207b 6469 725f 6f66 5f73 796d 6c69  ho {dir_of_symli
-00003c70: 6e6b 7d20 7c20 7472 2022 2f22 2022 2022  nk} | tr "/" " "
-00003c80: 293b 2064 6f20 270a 2020 2020 2020 2020  ); do '.        
-00003c90: 2020 2020 2027 703d 247b 707d 2f24 7b77       'p=${p}/${w
-00003ca0: 7d3b 2073 7564 6f20 6368 6f77 6e20 2455  }; sudo chown $U
-00003cb0: 5345 5220 2470 3b20 646f 6e65 2927 290a  SER $p; done)').
-00003cc0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00003cd0: 2020 2320 2032 2e20 7265 6d6f 7665 2061    #  2. remove a
-00003ce0: 6e79 2065 7869 7374 696e 6720 7379 6d6c  ny existing syml
-00003cf0: 696e 6b20 286c 6e20 2d66 206d 6179 2074  ink (ln -f may t
-00003d00: 6872 6f77 2027 6361 6e6e 6f74 0a20 2020  hrow 'cannot.   
-00003d10: 2020 2020 2023 2020 2020 206f 7665 7277       #     overw
-00003d20: 7269 7465 2064 6972 6563 746f 7279 272c  rite directory',
-00003d30: 2069 6620 7468 6520 6c69 6e6b 2065 7869   if the link exi
-00003d40: 7374 7320 616e 6420 706f 696e 7473 2074  sts and points t
-00003d50: 6f20 610a 2020 2020 2020 2020 2320 2020  o a.        #   
-00003d60: 2020 6469 7265 6374 6f72 7929 2e0a 2020    directory)..  
-00003d70: 2020 2020 2020 636f 6d6d 616e 6473 202b        commands +
-00003d80: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00003d90: 2320 4572 726f 7220 6f75 7420 6966 2073  # Error out if s
-00003da0: 6f75 7263 6520 6973 2061 6e20 6578 6973  ource is an exis
-00003db0: 7469 6e67 2c20 6e6f 6e2d 7379 6d6c 696e  ting, non-symlin
-00003dc0: 6b20 6469 7265 6374 6f72 792f 6669 6c65  k directory/file
-00003dd0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00003de0: 2828 7465 7374 202d 4c20 7b73 6f75 7263  ((test -L {sourc
-00003df0: 657d 2026 2620 7375 646f 2072 6d20 7b73  e} && sudo rm {s
-00003e00: 6f75 7263 657d 2026 3e2f 6465 762f 6e75  ource} &>/dev/nu
-00003e10: 6c6c 2920 7c7c 2027 0a20 2020 2020 2020  ll) || '.       
-00003e20: 2020 2020 2066 2728 7465 7374 2021 202d       f'(test ! -
-00003e30: 6520 7b73 6f75 7263 657d 207c 7c20 270a  e {source} || '.
-00003e40: 2020 2020 2020 2020 2020 2020 6627 2865              f'(e
-00003e50: 6368 6f20 2221 2121 2046 6169 6c65 6420  cho "!!! Failed 
-00003e60: 6d6f 756e 7469 6e67 2062 6563 6175 7365  mounting because
-00003e70: 2070 6174 6820 6578 6973 7473 2028 7b73   path exists ({s
-00003e80: 6f75 7263 657d 2922 3b20 270a 2020 2020  ource})"; '.    
-00003e90: 2020 2020 2020 2020 2765 7869 7420 3129          'exit 1)
-00003ea0: 2929 272c 0a20 2020 2020 2020 205d 0a20  ))',.        ]. 
-00003eb0: 2020 2020 2020 2063 6f6d 6d61 6e64 7320         commands 
-00003ec0: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
-00003ed0: 2023 204c 696e 6b2e 0a20 2020 2020 2020   # Link..       
-00003ee0: 2020 2020 2066 2773 7564 6f20 6c6e 202d       f'sudo ln -
-00003ef0: 7320 7b74 6172 6765 747d 207b 736f 7572  s {target} {sour
-00003f00: 6365 7d27 2c0a 2020 2020 2020 2020 2020  ce}',.          
-00003f10: 2020 2320 6368 6f77 6e2e 2020 2d68 2074    # chown.  -h t
-00003f20: 6f20 6166 6665 6374 2073 796d 6c69 6e6b  o affect symlink
-00003f30: 7320 6f6e 6c79 2e0a 2020 2020 2020 2020  s only..        
-00003f40: 2020 2020 6627 7375 646f 2063 686f 776e      f'sudo chown
-00003f50: 202d 6820 2455 5345 5220 7b73 6f75 7263   -h $USER {sourc
-00003f60: 657d 272c 0a20 2020 2020 2020 205d 0a20  e}',.        ]. 
-00003f70: 2020 2020 2020 2072 6574 7572 6e20 2720         return ' 
-00003f80: 2626 2027 2e6a 6f69 6e28 636f 6d6d 616e  && '.join(comman
-00003f90: 6473 290a 0a0a 636c 6173 7320 5353 4843  ds)...class SSHC
-00003fa0: 6f6e 6669 6748 656c 7065 7228 6f62 6a65  onfigHelper(obje
-00003fb0: 6374 293a 0a20 2020 2022 2222 4865 6c70  ct):.    """Help
-00003fc0: 6572 2066 6f72 2068 616e 646c 696e 6720  er for handling 
-00003fd0: 6c6f 6361 6c20 5353 4820 636f 6e66 6967  local SSH config
-00003fe0: 7572 6174 696f 6e2e 2222 220a 0a20 2020  uration."""..   
-00003ff0: 2073 7368 5f63 6f6e 665f 7061 7468 203d   ssh_conf_path =
-00004000: 2027 7e2f 2e73 7368 2f63 6f6e 6669 6727   '~/.ssh/config'
-00004010: 0a20 2020 2073 7368 5f63 6f6e 665f 6c6f  .    ssh_conf_lo
-00004020: 636b 5f70 6174 6820 3d20 6f73 2e70 6174  ck_path = os.pat
-00004030: 682e 6578 7061 6e64 7573 6572 2827 7e2f  h.expanduser('~/
-00004040: 2e73 6b79 2f73 7368 5f63 6f6e 6669 672e  .sky/ssh_config.
-00004050: 6c6f 636b 2729 0a20 2020 2073 7368 5f63  lock').    ssh_c
-00004060: 6c75 7374 6572 5f70 6174 6820 3d20 534b  luster_path = SK
-00004070: 595f 5553 4552 5f46 494c 455f 5041 5448  Y_USER_FILE_PATH
-00004080: 202b 2027 2f73 7368 2f7b 7d27 0a0a 2020   + '/ssh/{}'..  
-00004090: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
-000040a0: 2020 2064 6566 205f 6765 745f 6765 6e65     def _get_gene
-000040b0: 7261 7465 645f 636f 6e66 6967 2863 6c73  rated_config(cls
-000040c0: 2c20 6175 746f 6765 6e5f 636f 6d6d 656e  , autogen_commen
-000040d0: 743a 2073 7472 2c20 686f 7374 5f6e 616d  t: str, host_nam
-000040e0: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
-000040f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004100: 2020 2020 2020 6970 3a20 7374 722c 2075        ip: str, u
-00004110: 7365 726e 616d 653a 2073 7472 2c20 7373  sername: str, ss
-00004120: 685f 6b65 795f 7061 7468 3a20 7374 722c  h_key_path: str,
-00004130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004140: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00004150: 726f 7879 5f63 6f6d 6d61 6e64 3a20 4f70  roxy_command: Op
-00004160: 7469 6f6e 616c 5b73 7472 5d2c 2070 6f72  tional[str], por
-00004170: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
-00004180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004190: 2020 2020 2020 646f 636b 6572 5f70 726f        docker_pro
-000041a0: 7879 5f63 6f6d 6d61 6e64 3a20 4f70 7469  xy_command: Opti
-000041b0: 6f6e 616c 5b73 7472 5d29 3a0a 2020 2020  onal[str]):.    
-000041c0: 2020 2020 6966 2070 726f 7879 5f63 6f6d      if proxy_com
-000041d0: 6d61 6e64 2069 7320 6e6f 7420 4e6f 6e65  mand is not None
-000041e0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000041f0: 416c 7265 6164 7920 6368 6563 6b65 6420  Already checked 
-00004200: 696e 2072 6573 6f75 7263 6573 0a20 2020  in resources.   
-00004210: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00004220: 646f 636b 6572 5f70 726f 7879 5f63 6f6d  docker_proxy_com
-00004230: 6d61 6e64 2069 7320 4e6f 6e65 2c20 280a  mand is None, (.
-00004240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004250: 2743 616e 6e6f 7420 7370 6563 6966 7920  'Cannot specify 
-00004260: 626f 7468 2070 726f 7879 5f63 6f6d 6d61  both proxy_comma
-00004270: 6e64 2061 6e64 2064 6f63 6b65 725f 7072  nd and docker_pr
-00004280: 6f78 795f 636f 6d6d 616e 642e 2729 0a20  oxy_command.'). 
-00004290: 2020 2020 2020 2020 2020 2070 726f 7879             proxy
-000042a0: 203d 2066 2750 726f 7879 436f 6d6d 616e   = f'ProxyComman
-000042b0: 6420 7b70 726f 7879 5f63 6f6d 6d61 6e64  d {proxy_command
-000042c0: 7d27 0a20 2020 2020 2020 2065 6c69 6620  }'.        elif 
-000042d0: 646f 636b 6572 5f70 726f 7879 5f63 6f6d  docker_proxy_com
-000042e0: 6d61 6e64 2069 7320 6e6f 7420 4e6f 6e65  mand is not None
-000042f0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00004300: 6f78 7920 3d20 6627 5072 6f78 7943 6f6d  oxy = f'ProxyCom
-00004310: 6d61 6e64 207b 646f 636b 6572 5f70 726f  mand {docker_pro
-00004320: 7879 5f63 6f6d 6d61 6e64 7d27 0a20 2020  xy_command}'.   
-00004330: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00004340: 2020 2020 2020 2070 726f 7879 203d 2027         proxy = '
-00004350: 270a 2020 2020 2020 2020 2320 5374 7269  '.        # Stri
-00004360: 6374 486f 7374 4b65 7943 6865 636b 696e  ctHostKeyCheckin
-00004370: 673d 6e6f 2073 6b69 7073 2074 6865 2068  g=no skips the h
-00004380: 6f73 7420 6b65 7920 6368 6563 6b20 666f  ost key check fo
-00004390: 7220 7468 6520 6669 7273 740a 2020 2020  r the first.    
-000043a0: 2020 2020 2320 7469 6d65 2e20 5573 6572      # time. User
-000043b0: 4b6e 6f77 6e48 6f73 7473 4669 6c65 3d2f  KnownHostsFile=/
-000043c0: 6465 762f 6e75 6c6c 2061 6e64 2047 6c6f  dev/null and Glo
-000043d0: 6261 6c4b 6e6f 776e 486f 7374 7346 696c  balKnownHostsFil
-000043e0: 652f 6465 762f 6e75 6c6c 0a20 2020 2020  e/dev/null.     
-000043f0: 2020 2023 2070 7265 7665 6e74 2074 6865     # prevent the
-00004400: 2068 6f73 7420 6b65 7920 6672 6f6d 2062   host key from b
-00004410: 6569 6e67 2061 6464 6564 2074 6f20 7468  eing added to th
-00004420: 6520 6b6e 6f77 6e5f 686f 7374 7320 6669  e known_hosts fi
-00004430: 6c65 2061 6e64 0a20 2020 2020 2020 2023  le and.        #
-00004440: 2061 6c77 6179 7320 7265 7475 726e 2061   always return a
-00004450: 6e20 656d 7074 7920 6669 6c65 2066 6f72  n empty file for
-00004460: 206b 6e6f 776e 2068 6f73 7473 2c20 6d61   known hosts, ma
-00004470: 6b69 6e67 2074 6865 2073 7368 2074 6869  king the ssh thi
-00004480: 6e6b 0a20 2020 2020 2020 2023 2074 6869  nk.        # thi
-00004490: 7320 6973 2061 2066 6972 7374 2d74 696d  s is a first-tim
-000044a0: 6520 636f 6e6e 6563 7469 6f6e 2c20 616e  e connection, an
-000044b0: 6420 7468 7573 2073 6b69 7070 696e 6720  d thus skipping 
-000044c0: 7468 6520 686f 7374 206b 6579 0a20 2020  the host key.   
-000044d0: 2020 2020 2023 2063 6865 636b 2e0a 2020       # check..  
-000044e0: 2020 2020 2020 636f 6465 6765 6e20 3d20        codegen = 
-000044f0: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
-00004500: 6622 2222 5c0a 2020 2020 2020 2020 2020  f"""\.          
-00004510: 2020 7b61 7574 6f67 656e 5f63 6f6d 6d65    {autogen_comme
-00004520: 6e74 7d0a 2020 2020 2020 2020 2020 2020  nt}.            
-00004530: 486f 7374 207b 686f 7374 5f6e 616d 657d  Host {host_name}
-00004540: 0a20 2020 2020 2020 2020 2020 2020 2048  .              H
-00004550: 6f73 744e 616d 6520 7b69 707d 0a20 2020  ostName {ip}.   
-00004560: 2020 2020 2020 2020 2020 2055 7365 7220             User 
-00004570: 7b75 7365 726e 616d 657d 0a20 2020 2020  {username}.     
-00004580: 2020 2020 2020 2020 2049 6465 6e74 6974           Identit
-00004590: 7946 696c 6520 7b73 7368 5f6b 6579 5f70  yFile {ssh_key_p
-000045a0: 6174 687d 0a20 2020 2020 2020 2020 2020  ath}.           
-000045b0: 2020 2049 6465 6e74 6974 6965 734f 6e6c     IdentitiesOnl
-000045c0: 7920 7965 730a 2020 2020 2020 2020 2020  y yes.          
-000045d0: 2020 2020 466f 7277 6172 6441 6765 6e74      ForwardAgent
-000045e0: 2079 6573 0a20 2020 2020 2020 2020 2020   yes.           
-000045f0: 2020 2053 7472 6963 7448 6f73 744b 6579     StrictHostKey
-00004600: 4368 6563 6b69 6e67 206e 6f0a 2020 2020  Checking no.    
-00004610: 2020 2020 2020 2020 2020 5573 6572 4b6e            UserKn
-00004620: 6f77 6e48 6f73 7473 4669 6c65 3d2f 6465  ownHostsFile=/de
-00004630: 762f 6e75 6c6c 0a20 2020 2020 2020 2020  v/null.         
-00004640: 2020 2020 2047 6c6f 6261 6c4b 6e6f 776e       GlobalKnown
-00004650: 486f 7374 7346 696c 653d 2f64 6576 2f6e  HostsFile=/dev/n
-00004660: 756c 6c0a 2020 2020 2020 2020 2020 2020  ull.            
-00004670: 2020 506f 7274 207b 706f 7274 7d0a 2020    Port {port}.  
-00004680: 2020 2020 2020 2020 2020 2020 7b70 726f              {pro
-00004690: 7879 7d0a 2020 2020 2020 2020 2020 2020  xy}.            
-000046a0: 2222 222e 7273 7472 6970 2829 290a 2020  """.rstrip()).  
-000046b0: 2020 2020 2020 636f 6465 6765 6e20 3d20        codegen = 
-000046c0: 636f 6465 6765 6e20 2b20 275c 6e27 0a20  codegen + '\n'. 
-000046d0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-000046e0: 6465 6765 6e0a 0a20 2020 2040 636c 6173  degen..    @clas
-000046f0: 736d 6574 686f 640a 2020 2020 4074 696d  smethod.    @tim
-00004700: 656c 696e 652e 4669 6c65 4c6f 636b 4576  eline.FileLockEv
-00004710: 656e 7428 7373 685f 636f 6e66 5f6c 6f63  ent(ssh_conf_loc
-00004720: 6b5f 7061 7468 290a 2020 2020 6465 6620  k_path).    def 
-00004730: 6164 645f 636c 7573 7465 7228 0a20 2020  add_cluster(.   
-00004740: 2020 2020 2063 6c73 2c0a 2020 2020 2020       cls,.      
-00004750: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
-00004760: 7374 722c 0a20 2020 2020 2020 2069 7073  str,.        ips
-00004770: 3a20 4c69 7374 5b73 7472 5d2c 0a20 2020  : List[str],.   
-00004780: 2020 2020 2061 7574 685f 636f 6e66 6967       auth_config
-00004790: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-000047a0: 2c0a 2020 2020 2020 2020 706f 7274 733a  ,.        ports:
-000047b0: 204c 6973 745b 696e 745d 2c0a 2020 2020   List[int],.    
-000047c0: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
-000047d0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-000047e0: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-000047f0: 7368 5f75 7365 723a 204f 7074 696f 6e61  sh_user: Optiona
-00004800: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00004810: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00004820: 2241 6464 2061 7574 6865 6e74 6963 6174  "Add authenticat
-00004830: 696f 6e20 696e 666f 726d 6174 696f 6e20  ion information 
-00004840: 666f 7220 636c 7573 7465 7220 746f 206c  for cluster to l
-00004850: 6f63 616c 2053 5348 2063 6f6e 6669 6720  ocal SSH config 
-00004860: 6669 6c65 2e0a 0a20 2020 2020 2020 2049  file...        I
-00004870: 6620 6120 686f 7374 2077 6974 6820 6063  f a host with `c
-00004880: 6c75 7374 6572 5f6e 616d 6560 2061 6c72  luster_name` alr
-00004890: 6561 6479 2065 7869 7374 7320 616e 6420  eady exists and 
-000048a0: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
-000048b0: 6e20 7761 730a 2020 2020 2020 2020 6e6f  n was.        no
-000048c0: 7420 6164 6465 6420 6279 2073 6b79 2c20  t added by sky, 
-000048d0: 7468 656e 2060 6970 6020 6973 2075 7365  then `ip` is use
-000048e0: 6420 746f 2069 6465 6e74 6966 7920 7468  d to identify th
-000048f0: 6520 686f 7374 2069 6e73 7465 6164 2069  e host instead i
-00004900: 6e20 7468 650a 2020 2020 2020 2020 6669  n the.        fi
-00004910: 6c65 2e0a 0a20 2020 2020 2020 2049 6620  le...        If 
-00004920: 6120 686f 7374 2077 6974 6820 6063 6c75  a host with `clu
-00004930: 7374 6572 5f6e 616d 6560 2061 6c72 6561  ster_name` alrea
-00004940: 6479 2065 7869 7374 7320 616e 6420 7468  dy exists and th
-00004950: 6520 636f 6e66 6967 7572 6174 696f 6e20  e configuration 
-00004960: 7761 730a 2020 2020 2020 2020 6164 6465  was.        adde
-00004970: 6420 6279 2073 6b79 2028 652e 672e 2061  d by sky (e.g. a
-00004980: 2073 706f 7420 696e 7374 616e 6365 292c   spot instance),
-00004990: 2074 6865 6e20 7468 6520 636f 6e66 6967   then the config
-000049a0: 7572 6174 696f 6e20 6973 0a20 2020 2020  uration is.     
-000049b0: 2020 206f 7665 7277 7269 7474 656e 2e0a     overwritten..
-000049c0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-000049d0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-000049e0: 6572 5f6e 616d 653a 2043 6c75 7374 6572  er_name: Cluster
-000049f0: 206e 616d 6520 2873 6565 2060 736b 7920   name (see `sky 
-00004a00: 7374 6174 7573 6029 0a20 2020 2020 2020  status`).       
-00004a10: 2020 2020 2069 7073 3a20 4c69 7374 206f       ips: List o
-00004a20: 6620 7075 626c 6963 2049 5020 6164 6472  f public IP addr
-00004a30: 6573 7365 7320 696e 2074 6865 2063 6c75  esses in the clu
-00004a40: 7374 6572 2e20 4669 7273 7420 4950 2069  ster. First IP i
-00004a50: 7320 6865 6164 0a20 2020 2020 2020 2020  s head.         
-00004a60: 2020 2020 206e 6f64 652e 0a20 2020 2020       node..     
-00004a70: 2020 2020 2020 2061 7574 685f 636f 6e66         auth_conf
-00004a80: 6967 3a20 7265 6164 5f79 616d 6c28 6861  ig: read_yaml(ha
-00004a90: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
-00004aa0: 6c29 5b27 6175 7468 275d 0a20 2020 2020  l)['auth'].     
-00004ab0: 2020 2020 2020 2070 6f72 7473 3a20 4c69         ports: Li
-00004ac0: 7374 206f 6620 706f 7274 206e 756d 6265  st of port numbe
-00004ad0: 7273 2066 6f72 2053 5348 2063 6f72 7265  rs for SSH corre
-00004ae0: 7370 6f6e 6469 6e67 2074 6f20 6970 730a  sponding to ips.
-00004af0: 2020 2020 2020 2020 2020 2020 646f 636b              dock
-00004b00: 6572 5f75 7365 723a 2049 6620 6e6f 7420  er_user: If not 
-00004b10: 4e6f 6e65 2c20 7573 6520 7468 6973 2075  None, use this u
-00004b20: 7365 7220 746f 2073 7368 2069 6e74 6f20  ser to ssh into 
-00004b30: 7468 6520 646f 636b 6572 0a20 2020 2020  the docker.     
-00004b40: 2020 2020 2020 2073 7368 5f75 7365 723a         ssh_user:
-00004b50: 204f 7665 7272 6964 6520 7468 6520 7373   Override the ss
-00004b60: 685f 7573 6572 2069 6e20 6175 7468 5f63  h_user in auth_c
-00004b70: 6f6e 6669 670a 2020 2020 2020 2020 2222  onfig.        ""
-00004b80: 220a 2020 2020 2020 2020 6966 2073 7368  ".        if ssh
-00004b90: 5f75 7365 7220 6973 204e 6f6e 653a 0a20  _user is None:. 
-00004ba0: 2020 2020 2020 2020 2020 2075 7365 726e             usern
-00004bb0: 616d 6520 3d20 6175 7468 5f63 6f6e 6669  ame = auth_confi
-00004bc0: 675b 2773 7368 5f75 7365 7227 5d0a 2020  g['ssh_user'].  
-00004bd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00004be0: 2020 2020 2020 2020 7573 6572 6e61 6d65          username
-00004bf0: 203d 2073 7368 5f75 7365 720a 2020 2020   = ssh_user.    
-00004c00: 2020 2020 6966 2064 6f63 6b65 725f 7573      if docker_us
-00004c10: 6572 2069 7320 6e6f 7420 4e6f 6e65 3a0a  er is not None:.
-00004c20: 2020 2020 2020 2020 2020 2020 7573 6572              user
-00004c30: 6e61 6d65 203d 2064 6f63 6b65 725f 7573  name = docker_us
-00004c40: 6572 0a20 2020 2020 2020 206b 6579 5f70  er.        key_p
-00004c50: 6174 6820 3d20 6f73 2e70 6174 682e 6578  ath = os.path.ex
-00004c60: 7061 6e64 7573 6572 2861 7574 685f 636f  panduser(auth_co
-00004c70: 6e66 6967 5b27 7373 685f 7072 6976 6174  nfig['ssh_privat
-00004c80: 655f 6b65 7927 5d29 0a20 2020 2020 2020  e_key']).       
-00004c90: 2073 6b79 5f61 7574 6f67 656e 5f63 6f6d   sky_autogen_com
-00004ca0: 6d65 6e74 203d 2028 2723 2041 6464 6564  ment = ('# Added
-00004cb0: 2062 7920 736b 7920 2875 7365 2060 736b   by sky (use `sk
-00004cc0: 7920 7374 6f70 2f64 6f77 6e20 270a 2020  y stop/down '.  
-00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ce0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00004cf0: 636c 7573 7465 725f 6e61 6d65 7d60 2074  cluster_name}` t
-00004d00: 6f20 7265 6d6f 7665 2927 290a 2020 2020  o remove)').    
-00004d10: 2020 2020 6970 203d 2069 7073 5b30 5d0a      ip = ips[0].
-00004d20: 2020 2020 2020 2020 6966 2064 6f63 6b65          if docke
-00004d30: 725f 7573 6572 2069 7320 6e6f 7420 4e6f  r_user is not No
-00004d40: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00004d50: 6970 203d 2027 6c6f 6361 6c68 6f73 7427  ip = 'localhost'
-00004d60: 0a0a 2020 2020 2020 2020 636f 6e66 6967  ..        config
-00004d70: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-00004d80: 6578 7061 6e64 7573 6572 2863 6c73 2e73  expanduser(cls.s
-00004d90: 7368 5f63 6f6e 665f 7061 7468 290a 0a20  sh_conf_path).. 
-00004da0: 2020 2020 2020 2023 2046 6f72 2062 6163         # For bac
-00004db0: 6b77 6172 6420 636f 6d70 6174 6962 696c  kward compatibil
-00004dc0: 6974 793a 2062 6566 6f72 6520 2332 3730  ity: before #270
-00004dd0: 362c 2077 6520 7772 6f74 6520 7468 6520  6, we wrote the 
-00004de0: 636f 6e66 6967 206f 6620 536b 7950 696c  config of SkyPil
-00004df0: 6f74 2063 6c75 7374 6572 730a 2020 2020  ot clusters.    
-00004e00: 2020 2020 2320 6469 7265 6374 6c79 2069      # directly i
-00004e10: 6e20 7e2f 2e73 7368 2f63 6f6e 6669 672e  n ~/.ssh/config.
-00004e20: 2046 6f72 2074 6865 7365 2063 6c75 7374   For these clust
-00004e30: 6572 732c 2077 6520 7265 6d6f 7665 2074  ers, we remove t
-00004e40: 6865 2063 6f6e 6669 6720 696e 207e 2f2e  he config in ~/.
-00004e50: 7373 682f 636f 6e66 6967 0a20 2020 2020  ssh/config.     
-00004e60: 2020 2023 2061 6e64 2077 7269 7465 2f6f     # and write/o
-00004e70: 7665 7277 7269 7465 2074 6865 2063 6f6e  verwrite the con
-00004e80: 6669 6720 696e 207e 2f2e 736b 792f 7373  fig in ~/.sky/ss
-00004e90: 682f 3c63 6c75 7374 6572 5f6e 616d 653e  h/<cluster_name>
-00004ea0: 2069 6e73 7465 6164 2e0a 2020 2020 2020   instead..      
-00004eb0: 2020 636c 732e 5f72 656d 6f76 655f 7374    cls._remove_st
-00004ec0: 616c 655f 636c 7573 7465 725f 636f 6e66  ale_cluster_conf
-00004ed0: 6967 5f66 6f72 5f62 6163 6b77 6172 645f  ig_for_backward_
-00004ee0: 636f 6d70 6174 6962 696c 6974 7928 0a20  compatibility(. 
-00004ef0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-00004f00: 6572 5f6e 616d 652c 2069 702c 2061 7574  er_name, ip, aut
-00004f10: 685f 636f 6e66 6967 2c20 646f 636b 6572  h_config, docker
-00004f20: 5f75 7365 7229 0a0a 2020 2020 2020 2020  _user)..        
-00004f30: 6966 206e 6f74 206f 732e 7061 7468 2e65  if not os.path.e
-00004f40: 7869 7374 7328 636f 6e66 6967 5f70 6174  xists(config_pat
-00004f50: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00004f60: 636f 6e66 6967 203d 205b 275c 6e27 5d0a  config = ['\n'].
-00004f70: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00004f80: 206f 7065 6e28 636f 6e66 6967 5f70 6174   open(config_pat
-00004f90: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00004fa0: 2020 2020 2020 2020 2027 7727 2c0a 2020           'w',.  
-00004fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fc0: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
-00004fd0: 662d 3827 2c0a 2020 2020 2020 2020 2020  f-8',.          
-00004fe0: 2020 2020 2020 2020 2020 2020 6f70 656e              open
-00004ff0: 6572 3d66 756e 6374 6f6f 6c73 2e70 6172  er=functools.par
-00005000: 7469 616c 286f 732e 6f70 656e 2c20 6d6f  tial(os.open, mo
-00005010: 6465 3d30 6f36 3434 2929 2061 7320 663a  de=0o644)) as f:
-00005020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005030: 2066 2e77 7269 7465 6c69 6e65 7328 636f   f.writelines(co
-00005040: 6e66 6967 290a 0a20 2020 2020 2020 2077  nfig)..        w
-00005050: 6974 6820 6f70 656e 2863 6f6e 6669 675f  ith open(config_
-00005060: 7061 7468 2c20 2772 272c 2065 6e63 6f64  path, 'r', encod
-00005070: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
-00005080: 663a 0a20 2020 2020 2020 2020 2020 2063  f:.            c
-00005090: 6f6e 6669 6720 3d20 662e 7265 6164 6c69  onfig = f.readli
-000050a0: 6e65 7328 290a 0a20 2020 2020 2020 2073  nes()..        s
-000050b0: 7368 5f64 6972 203d 2063 6c73 2e73 7368  sh_dir = cls.ssh
-000050c0: 5f63 6c75 7374 6572 5f70 6174 682e 666f  _cluster_path.fo
-000050d0: 726d 6174 2827 2729 0a20 2020 2020 2020  rmat('').       
-000050e0: 206f 732e 6d61 6b65 6469 7273 286f 732e   os.makedirs(os.
-000050f0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-00005100: 7373 685f 6469 7229 2c20 6578 6973 745f  ssh_dir), exist_
-00005110: 6f6b 3d54 7275 652c 206d 6f64 653d 306f  ok=True, mode=0o
-00005120: 3730 3029 0a0a 2020 2020 2020 2020 2320  700)..        # 
-00005130: 4861 6e64 6c65 2049 6e63 6c75 6465 206f  Handle Include o
-00005140: 6e20 746f 7020 6f66 2043 6f6e 6669 6720  n top of Config 
-00005150: 6669 6c65 0a20 2020 2020 2020 2069 6e63  file.        inc
-00005160: 6c75 6465 5f73 7472 203d 2066 2749 6e63  lude_str = f'Inc
-00005170: 6c75 6465 207b 636c 732e 7373 685f 636c  lude {cls.ssh_cl
-00005180: 7573 7465 725f 7061 7468 2e66 6f72 6d61  uster_path.forma
-00005190: 7428 222a 2229 7d27 0a20 2020 2020 2020  t("*")}'.       
-000051a0: 2066 6f75 6e64 203d 2046 616c 7365 0a20   found = False. 
-000051b0: 2020 2020 2020 2066 6f72 2069 2c20 6c69         for i, li
-000051c0: 6e65 2069 6e20 656e 756d 6572 6174 6528  ne in enumerate(
-000051d0: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
-000051e0: 2020 2020 2063 6f6e 6669 675f 7374 7220       config_str 
-000051f0: 3d20 6c69 6e65 2e73 7472 6970 2829 0a20  = line.strip(). 
-00005200: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-00005210: 6e66 6967 5f73 7472 203d 3d20 696e 636c  nfig_str == incl
-00005220: 7564 655f 7374 723a 0a20 2020 2020 2020  ude_str:.       
-00005230: 2020 2020 2020 2020 2066 6f75 6e64 203d           found =
-00005240: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00005250: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00005260: 2020 2020 2020 2020 6966 2027 486f 7374          if 'Host
-00005270: 2720 696e 2063 6f6e 6669 675f 7374 723a  ' in config_str:
-00005280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005290: 2062 7265 616b 0a20 2020 2020 2020 2069   break.        i
-000052a0: 6620 6e6f 7420 666f 756e 643a 0a20 2020  f not found:.   
-000052b0: 2020 2020 2020 2020 2023 2044 6964 206e           # Did n
-000052c0: 6f74 2066 696e 6420 496e 636c 7564 6520  ot find Include 
-000052d0: 7374 7269 6e67 2e20 496e 7365 7274 2060  string. Insert `
-000052e0: 496e 636c 7564 6560 206c 696e 6573 2e0a  Include` lines..
-000052f0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00005300: 206f 7065 6e28 636f 6e66 6967 5f70 6174   open(config_pat
-00005310: 682c 2027 7727 2c20 656e 636f 6469 6e67  h, 'w', encoding
-00005320: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
-00005330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005340: 636f 6e66 6967 2e69 6e73 6572 7428 0a20  config.insert(. 
-00005350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005360: 2020 2030 2c0a 2020 2020 2020 2020 2020     0,.          
-00005370: 2020 2020 2020 2020 2020 6627 2320 4164            f'# Ad
-00005380: 6465 6420 6279 2053 6b79 5069 6c6f 7420  ded by SkyPilot 
-00005390: 666f 7220 7373 6820 636f 6e66 6967 206f  for ssh config o
-000053a0: 6620 616c 6c20 636c 7573 7465 7273 5c6e  f all clusters\n
-000053b0: 7b69 6e63 6c75 6465 5f73 7472 7d5c 6e27  {include_str}\n'
-000053c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000053d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000053e0: 2020 2066 2e77 7269 7465 2827 272e 6a6f     f.write(''.jo
-000053f0: 696e 2863 6f6e 6669 6729 2e73 7472 6970  in(config).strip
-00005400: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00005410: 2020 2020 662e 7772 6974 6528 275c 6e27      f.write('\n'
-00005420: 202a 2032 290a 0a20 2020 2020 2020 2070   * 2)..        p
-00005430: 726f 7879 5f63 6f6d 6d61 6e64 203d 2061  roxy_command = a
-00005440: 7574 685f 636f 6e66 6967 2e67 6574 2827  uth_config.get('
-00005450: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-00005460: 6427 2c20 4e6f 6e65 290a 0a20 2020 2020  d', None)..     
-00005470: 2020 2064 6f63 6b65 725f 7072 6f78 795f     docker_proxy_
-00005480: 636f 6d6d 616e 645f 6765 6e65 7261 746f  command_generato
-00005490: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-000054a0: 2069 6620 646f 636b 6572 5f75 7365 7220   if docker_user 
-000054b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000054c0: 2020 2020 2020 2020 2064 6f63 6b65 725f           docker_
-000054d0: 7072 6f78 795f 636f 6d6d 616e 645f 6765  proxy_command_ge
-000054e0: 6e65 7261 746f 7220 3d20 6c61 6d62 6461  nerator = lambda
-000054f0: 2069 702c 2070 6f72 743a 2027 2027 2e6a   ip, port: ' '.j
-00005500: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
-00005510: 2020 2020 205b 2773 7368 275d 202b 2063       ['ssh'] + c
-00005520: 6f6d 6d61 6e64 5f72 756e 6e65 722e 7373  ommand_runner.ss
-00005530: 685f 6f70 7469 6f6e 735f 6c69 7374 280a  h_options_list(.
-00005540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005550: 2020 2020 6b65 795f 7061 7468 2c20 7373      key_path, ss
-00005560: 685f 636f 6e74 726f 6c5f 6e61 6d65 3d4e  h_control_name=N
-00005570: 6f6e 652c 2070 6f72 743d 706f 7274 2920  one, port=port) 
-00005580: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
-00005590: 2020 5b27 2d57 272c 2027 2568 3a25 7027    ['-W', '%h:%p'
-000055a0: 2c20 6627 7b61 7574 685f 636f 6e66 6967  , f'{auth_config
-000055b0: 5b22 7373 685f 7573 6572 225d 7d40 7b69  ["ssh_user"]}@{i
-000055c0: 707d 275d 290a 0a20 2020 2020 2020 2063  p}'])..        c
-000055d0: 6f64 6567 656e 203d 2027 270a 2020 2020  odegen = ''.    
-000055e0: 2020 2020 2320 4164 6420 7468 6520 6e6f      # Add the no
-000055f0: 6465 7320 746f 2074 6865 2063 6f64 6567  des to the codeg
-00005600: 656e 0a20 2020 2020 2020 2066 6f72 2069  en.        for i
-00005610: 2c20 6970 2069 6e20 656e 756d 6572 6174  , ip in enumerat
-00005620: 6528 6970 7329 3a0a 2020 2020 2020 2020  e(ips):.        
-00005630: 2020 2020 646f 636b 6572 5f70 726f 7879      docker_proxy
-00005640: 5f63 6f6d 6d61 6e64 203d 204e 6f6e 650a  _command = None.
-00005650: 2020 2020 2020 2020 2020 2020 706f 7274              port
-00005660: 203d 2070 6f72 7473 5b69 5d0a 2020 2020   = ports[i].    
-00005670: 2020 2020 2020 2020 6966 2064 6f63 6b65          if docke
-00005680: 725f 7072 6f78 795f 636f 6d6d 616e 645f  r_proxy_command_
-00005690: 6765 6e65 7261 746f 7220 6973 206e 6f74  generator is not
-000056a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000056b0: 2020 2020 2020 2064 6f63 6b65 725f 7072         docker_pr
-000056c0: 6f78 795f 636f 6d6d 616e 6420 3d20 646f  oxy_command = do
-000056d0: 636b 6572 5f70 726f 7879 5f63 6f6d 6d61  cker_proxy_comma
-000056e0: 6e64 5f67 656e 6572 6174 6f72 2869 702c  nd_generator(ip,
-000056f0: 2070 6f72 7429 0a20 2020 2020 2020 2020   port).         
-00005700: 2020 2020 2020 2069 7020 3d20 276c 6f63         ip = 'loc
-00005710: 616c 686f 7374 270a 2020 2020 2020 2020  alhost'.        
-00005720: 2020 2020 2020 2020 706f 7274 203d 2063          port = c
-00005730: 6f6e 7374 616e 7473 2e44 4546 4155 4c54  onstants.DEFAULT
-00005740: 5f44 4f43 4b45 525f 504f 5254 0a20 2020  _DOCKER_PORT.   
-00005750: 2020 2020 2020 2020 206e 6f64 655f 6e61           node_na
-00005760: 6d65 203d 2063 6c75 7374 6572 5f6e 616d  me = cluster_nam
-00005770: 6520 6966 2069 203d 3d20 3020 656c 7365  e if i == 0 else
-00005780: 2063 6c75 7374 6572 5f6e 616d 6520 2b20   cluster_name + 
-00005790: 6627 2d77 6f72 6b65 727b 697d 270a 2020  f'-worker{i}'.  
-000057a0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-000057b0: 2872 6f6d 696c 6229 3a20 5570 6461 7465  (romilb): Update
-000057c0: 2070 6f72 7420 6e75 6d62 6572 2077 6865   port number whe
-000057d0: 6e20 6b38 7320 7375 7070 6f72 7473 206d  n k8s supports m
-000057e0: 756c 7469 6e6f 6465 0a20 2020 2020 2020  ultinode.       
-000057f0: 2020 2020 2063 6f64 6567 656e 202b 3d20       codegen += 
-00005800: 636c 732e 5f67 6574 5f67 656e 6572 6174  cls._get_generat
-00005810: 6564 5f63 6f6e 6669 6728 0a20 2020 2020  ed_config(.     
-00005820: 2020 2020 2020 2020 2020 2073 6b79 5f61             sky_a
-00005830: 7574 6f67 656e 5f63 6f6d 6d65 6e74 2c20  utogen_comment, 
-00005840: 6e6f 6465 5f6e 616d 652c 2069 702c 2075  node_name, ip, u
-00005850: 7365 726e 616d 652c 206b 6579 5f70 6174  sername, key_pat
-00005860: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00005870: 2020 2070 726f 7879 5f63 6f6d 6d61 6e64     proxy_command
-00005880: 2c20 706f 7274 2c20 646f 636b 6572 5f70  , port, docker_p
-00005890: 726f 7879 5f63 6f6d 6d61 6e64 2920 2b20  roxy_command) + 
-000058a0: 275c 6e27 0a0a 2020 2020 2020 2020 636c  '\n'..        cl
-000058b0: 7573 7465 725f 636f 6e66 6967 5f70 6174  uster_config_pat
-000058c0: 6820 3d20 6f73 2e70 6174 682e 6578 7061  h = os.path.expa
-000058d0: 6e64 7573 6572 280a 2020 2020 2020 2020  nduser(.        
-000058e0: 2020 2020 636c 732e 7373 685f 636c 7573      cls.ssh_clus
-000058f0: 7465 725f 7061 7468 2e66 6f72 6d61 7428  ter_path.format(
-00005900: 636c 7573 7465 725f 6e61 6d65 2929 0a0a  cluster_name))..
-00005910: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
-00005920: 6e28 636c 7573 7465 725f 636f 6e66 6967  n(cluster_config
-00005930: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00005940: 2020 2020 2020 2020 2027 7727 2c0a 2020           'w',.  
-00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005960: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00005970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005980: 2020 2020 6f70 656e 6572 3d66 756e 6374      opener=funct
-00005990: 6f6f 6c73 2e70 6172 7469 616c 286f 732e  ools.partial(os.
-000059a0: 6f70 656e 2c20 6d6f 6465 3d30 6f36 3434  open, mode=0o644
-000059b0: 2929 2061 7320 663a 0a20 2020 2020 2020  )) as f:.       
-000059c0: 2020 2020 2066 2e77 7269 7465 2863 6f64       f.write(cod
-000059d0: 6567 656e 290a 0a20 2020 2040 636c 6173  egen)..    @clas
-000059e0: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-000059f0: 5f72 656d 6f76 655f 7374 616c 655f 636c  _remove_stale_cl
-00005a00: 7573 7465 725f 636f 6e66 6967 5f66 6f72  uster_config_for
-00005a10: 5f62 6163 6b77 6172 645f 636f 6d70 6174  _backward_compat
-00005a20: 6962 696c 6974 7928 0a20 2020 2020 2020  ibility(.       
-00005a30: 2063 6c73 2c0a 2020 2020 2020 2020 636c   cls,.        cl
-00005a40: 7573 7465 725f 6e61 6d65 3a20 7374 722c  uster_name: str,
-00005a50: 0a20 2020 2020 2020 2069 703a 2073 7472  .        ip: str
-00005a60: 2c0a 2020 2020 2020 2020 6175 7468 5f63  ,.        auth_c
-00005a70: 6f6e 6669 673a 2044 6963 745b 7374 722c  onfig: Dict[str,
-00005a80: 2073 7472 5d2c 0a20 2020 2020 2020 2064   str],.        d
-00005a90: 6f63 6b65 725f 7573 6572 3a20 4f70 7469  ocker_user: Opti
-00005aa0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00005ab0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00005ac0: 2022 2222 5265 6d6f 7665 2061 7574 6865   """Remove authe
-00005ad0: 6e74 6963 6174 696f 6e20 696e 666f 726d  ntication inform
-00005ae0: 6174 696f 6e20 666f 7220 636c 7573 7465  ation for cluste
-00005af0: 7220 6672 6f6d 206c 6f63 616c 2053 5348  r from local SSH
-00005b00: 2063 6f6e 6669 672e 0a0a 2020 2020 2020   config...      
-00005b10: 2020 4966 206e 6f20 6578 6973 7469 6e67    If no existing
-00005b20: 2068 6f73 7420 6d61 7463 6869 6e67 2074   host matching t
-00005b30: 6865 2070 726f 7669 6465 6420 7370 6563  he provided spec
-00005b40: 6966 6963 6174 696f 6e20 6973 2066 6f75  ification is fou
-00005b50: 6e64 2c20 7468 656e 0a20 2020 2020 2020  nd, then.       
-00005b60: 206e 6f74 6869 6e67 2069 7320 7265 6d6f   nothing is remo
-00005b70: 7665 642e 0a0a 2020 2020 2020 2020 4172  ved...        Ar
-00005b80: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00005b90: 6970 3a20 4865 6164 206e 6f64 6527 7320  ip: Head node's 
-00005ba0: 4950 2061 6464 7265 7373 2e0a 2020 2020  IP address..    
-00005bb0: 2020 2020 2020 2020 6175 7468 5f63 6f6e          auth_con
-00005bc0: 6669 673a 2072 6561 645f 7961 6d6c 2868  fig: read_yaml(h
-00005bd0: 616e 646c 652e 636c 7573 7465 725f 7961  andle.cluster_ya
-00005be0: 6d6c 295b 2761 7574 6827 5d0a 2020 2020  ml)['auth'].    
-00005bf0: 2020 2020 2020 2020 646f 636b 6572 5f75          docker_u
-00005c00: 7365 723a 2049 6620 6e6f 7420 4e6f 6e65  ser: If not None
-00005c10: 2c20 7573 6520 7468 6973 2075 7365 7220  , use this user 
-00005c20: 746f 2073 7368 2069 6e74 6f20 7468 6520  to ssh into the 
-00005c30: 646f 636b 6572 0a20 2020 2020 2020 2022  docker.        "
-00005c40: 2222 0a20 2020 2020 2020 2075 7365 726e  "".        usern
-00005c50: 616d 6520 3d20 6175 7468 5f63 6f6e 6669  ame = auth_confi
-00005c60: 675b 2773 7368 5f75 7365 7227 5d0a 2020  g['ssh_user'].  
-00005c70: 2020 2020 2020 636f 6e66 6967 5f70 6174        config_pat
-00005c80: 6820 3d20 6f73 2e70 6174 682e 6578 7061  h = os.path.expa
-00005c90: 6e64 7573 6572 2863 6c73 2e73 7368 5f63  nduser(cls.ssh_c
-00005ca0: 6f6e 665f 7061 7468 290a 2020 2020 2020  onf_path).      
-00005cb0: 2020 636c 7573 7465 725f 636f 6e66 6967    cluster_config
-00005cc0: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-00005cd0: 6578 7061 6e64 7573 6572 280a 2020 2020  expanduser(.    
-00005ce0: 2020 2020 2020 2020 636c 732e 7373 685f          cls.ssh_
-00005cf0: 636c 7573 7465 725f 7061 7468 2e66 6f72  cluster_path.for
-00005d00: 6d61 7428 636c 7573 7465 725f 6e61 6d65  mat(cluster_name
-00005d10: 2929 0a20 2020 2020 2020 2069 6620 6e6f  )).        if no
-00005d20: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
-00005d30: 2863 6f6e 6669 675f 7061 7468 293a 0a20  (config_path):. 
-00005d40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00005d50: 6e0a 0a20 2020 2020 2020 2077 6974 6820  n..        with 
-00005d60: 6f70 656e 2863 6f6e 6669 675f 7061 7468  open(config_path
-00005d70: 2c20 2772 272c 2065 6e63 6f64 696e 673d  , 'r', encoding=
-00005d80: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
-00005d90: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00005da0: 6720 3d20 662e 7265 6164 6c69 6e65 7328  g = f.readlines(
-00005db0: 290a 0a20 2020 2020 2020 2073 7461 7274  )..        start
-00005dc0: 5f6c 696e 655f 6964 7820 3d20 4e6f 6e65  _line_idx = None
-00005dd0: 0a0a 2020 2020 2020 2020 2320 5363 616e  ..        # Scan
-00005de0: 2074 6865 2063 6f6e 6669 6720 666f 7220   the config for 
-00005df0: 7468 6520 636c 7573 7465 7220 6e61 6d65  the cluster name
-00005e00: 2e0a 2020 2020 2020 2020 666f 7220 692c  ..        for i,
-00005e10: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
-00005e20: 7465 2863 6f6e 6669 6729 3a0a 2020 2020  te(config):.    
-00005e30: 2020 2020 2020 2020 6e65 7874 5f6c 696e          next_lin
-00005e40: 6520 3d20 636f 6e66 6967 5b69 202b 2031  e = config[i + 1
-00005e50: 5d20 6966 2069 202b 2031 203c 206c 656e  ] if i + 1 < len
-00005e60: 2863 6f6e 6669 6729 2065 6c73 6520 2727  (config) else ''
-00005e70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005e80: 646f 636b 6572 5f75 7365 7220 6973 204e  docker_user is N
-00005e90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00005ea0: 2020 2020 2066 6f75 6e64 203d 2028 6c69       found = (li
-00005eb0: 6e65 2e73 7472 6970 2829 203d 3d20 6627  ne.strip() == f'
-00005ec0: 486f 7374 4e61 6d65 207b 6970 7d27 2061  HostName {ip}' a
-00005ed0: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
-00005ee0: 2020 2020 2020 2020 2020 2020 6e65 7874              next
-00005ef0: 5f6c 696e 652e 7374 7269 7028 2920 3d3d  _line.strip() ==
-00005f00: 2066 2755 7365 7220 7b75 7365 726e 616d   f'User {usernam
-00005f10: 657d 2729 0a20 2020 2020 2020 2020 2020  e}').           
-00005f20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00005f30: 2020 2020 2020 2066 6f75 6e64 203d 2028         found = (
-00005f40: 6c69 6e65 2e73 7472 6970 2829 203d 3d20  line.strip() == 
-00005f50: 2748 6f73 744e 616d 6520 6c6f 6361 6c68  'HostName localh
-00005f60: 6f73 7427 2061 6e64 0a20 2020 2020 2020  ost' and.       
-00005f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f80: 2020 6e65 7874 5f6c 696e 652e 7374 7269    next_line.stri
-00005f90: 7028 2920 3d3d 2066 2755 7365 7220 7b64  p() == f'User {d
-00005fa0: 6f63 6b65 725f 7573 6572 7d27 290a 2020  ocker_user}').  
-00005fb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00005fc0: 2066 6f75 6e64 3a0a 2020 2020 2020 2020   found:.        
-00005fd0: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
-00005fe0: 6e64 2074 6865 206c 696e 6520 7374 6172  nd the line star
-00005ff0: 7469 6e67 2077 6974 6820 5072 6f78 7943  ting with ProxyC
-00006000: 6f6d 6d61 6e64 2061 6e64 2063 6f6e 7461  ommand and conta
-00006010: 696e 7320 7468 6520 6970 0a20 2020 2020  ins the ip.     
-00006020: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00006030: 6f75 6e64 203d 2046 616c 7365 0a20 2020  ound = False.   
-00006040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006050: 2066 6f72 2069 6478 2069 6e20 7261 6e67   for idx in rang
-00006060: 6528 692c 206c 656e 2863 6f6e 6669 6729  e(i, len(config)
-00006070: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00006080: 2020 2020 2020 2020 2020 2023 2053 746f             # Sto
-00006090: 7020 6966 2077 6520 7265 6163 6820 616e  p if we reach an
-000060a0: 2065 6d70 7479 206c 696e 652c 2077 6869   empty line, whi
-000060b0: 6368 206d 6561 6e73 2061 206e 6577 2068  ch means a new h
-000060c0: 6f73 740a 2020 2020 2020 2020 2020 2020  ost.            
-000060d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000060e0: 6f74 2063 6f6e 6669 675b 6964 785d 2e73  ot config[idx].s
-000060f0: 7472 6970 2829 3a0a 2020 2020 2020 2020  trip():.        
-00006100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006110: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006130: 2020 6966 2063 6f6e 6669 675b 6964 785d    if config[idx]
-00006140: 2e73 7472 6970 2829 2e73 7461 7274 7377  .strip().startsw
-00006150: 6974 6828 2750 726f 7879 436f 6d6d 616e  ith('ProxyComman
-00006160: 6427 293a 0a20 2020 2020 2020 2020 2020  d'):.           
-00006170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006180: 2070 726f 7879 5f63 6f6d 6d61 6e64 5f6c   proxy_command_l
-00006190: 696e 6520 3d20 636f 6e66 6967 5b69 6478  ine = config[idx
-000061a0: 5d2e 7374 7269 7028 290a 2020 2020 2020  ].strip().      
-000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061c0: 2020 2020 2020 6966 2070 726f 7879 5f63        if proxy_c
-000061d0: 6f6d 6d61 6e64 5f6c 696e 652e 656e 6473  ommand_line.ends
-000061e0: 7769 7468 2866 2740 7b69 707d 2729 3a0a  with(f'@{ip}'):.
-000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a30: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+00003a40: 6765 7429 0a20 2020 2020 2020 2023 2042  get).        # B
+00003a50: 656c 6f77 2c20 7573 6520 7375 646f 2069  elow, use sudo i
+00003a60: 6e20 6361 7365 2074 6865 2073 796d 6c69  n case the symli
+00003a70: 6e6b 206e 6565 6473 2073 7564 6f20 6163  nk needs sudo ac
+00003a80: 6365 7373 2074 6f20 6372 6561 7465 2e0a  cess to create..
+00003a90: 2020 2020 2020 2020 2320 5072 6570 6172          # Prepar
+00003aa0: 6520 746f 2063 7265 6174 6520 7468 6520  e to create the 
+00003ab0: 7379 6d6c 696e 6b3a 0a20 2020 2020 2020  symlink:.       
+00003ac0: 2023 2020 312e 206d 616b 6520 7375 7265   #  1. make sure
+00003ad0: 2069 7473 2064 6972 2873 2920 6578 6973   its dir(s) exis
+00003ae0: 7420 2620 6172 6520 6f77 6e65 6420 6279  t & are owned by
+00003af0: 2024 5553 4552 2e0a 2020 2020 2020 2020   $USER..        
+00003b00: 6469 725f 6f66 5f73 796d 6c69 6e6b 203d  dir_of_symlink =
+00003b10: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
+00003b20: 2873 6f75 7263 6529 0a20 2020 2020 2020  (source).       
+00003b30: 2063 6f6d 6d61 6e64 7320 3d20 5b0a 2020   commands = [.  
+00003b40: 2020 2020 2020 2020 2020 2320 6d6b 6469            # mkdi
+00003b50: 722c 2074 6865 6e20 6c6f 6f70 206f 7665  r, then loop ove
+00003b60: 7220 272f 612f 622f 6327 2061 7320 2f61  r '/a/b/c' as /a
+00003b70: 2c20 2f61 2f62 2c20 2f61 2f62 2f63 2e20  , /a/b, /a/b/c. 
+00003b80: 2046 6f72 2065 6163 682c 0a20 2020 2020   For each,.     
+00003b90: 2020 2020 2020 2023 2063 686f 776e 2024         # chown $
+00003ba0: 5553 4552 206f 6e20 6974 2073 6f20 7573  USER on it so us
+00003bb0: 6572 2063 616e 2075 7365 2074 6865 7365  er can use these
+00003bc0: 2069 6e74 6572 6d65 6469 6174 6520 6469   intermediate di
+00003bd0: 7273 0a20 2020 2020 2020 2020 2020 2023  rs.            #
+00003be0: 2028 6578 636c 7564 696e 6720 2f29 2e0a   (excluding /)..
+00003bf0: 2020 2020 2020 2020 2020 2020 6627 7375              f'su
+00003c00: 646f 206d 6b64 6972 202d 7020 7b64 6972  do mkdir -p {dir
+00003c10: 5f6f 665f 7379 6d6c 696e 6b7d 272c 0a20  _of_symlink}',. 
+00003c20: 2020 2020 2020 2020 2020 2023 2070 3a20             # p: 
+00003c30: 7061 7468 2073 6f20 6661 720a 2020 2020  path so far.    
+00003c40: 2020 2020 2020 2020 2827 2870 3d22 223b          ('(p="";
+00003c50: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00003c60: 6627 666f 7220 7720 696e 2024 2865 6368  f'for w in $(ech
+00003c70: 6f20 7b64 6972 5f6f 665f 7379 6d6c 696e  o {dir_of_symlin
+00003c80: 6b7d 207c 2074 7220 222f 2220 2220 2229  k} | tr "/" " ")
+00003c90: 3b20 646f 2027 0a20 2020 2020 2020 2020  ; do '.         
+00003ca0: 2020 2020 2770 3d24 7b70 7d2f 247b 777d      'p=${p}/${w}
+00003cb0: 3b20 7375 646f 2063 686f 776e 2024 5553  ; sudo chown $US
+00003cc0: 4552 2024 703b 2064 6f6e 6529 2729 0a20  ER $p; done)'). 
+00003cd0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00003ce0: 2023 2020 322e 2072 656d 6f76 6520 616e   #  2. remove an
+00003cf0: 7920 6578 6973 7469 6e67 2073 796d 6c69  y existing symli
+00003d00: 6e6b 2028 6c6e 202d 6620 6d61 7920 7468  nk (ln -f may th
+00003d10: 726f 7720 2763 616e 6e6f 740a 2020 2020  row 'cannot.    
+00003d20: 2020 2020 2320 2020 2020 6f76 6572 7772      #     overwr
+00003d30: 6974 6520 6469 7265 6374 6f72 7927 2c20  ite directory', 
+00003d40: 6966 2074 6865 206c 696e 6b20 6578 6973  if the link exis
+00003d50: 7473 2061 6e64 2070 6f69 6e74 7320 746f  ts and points to
+00003d60: 2061 0a20 2020 2020 2020 2023 2020 2020   a.        #    
+00003d70: 2064 6972 6563 746f 7279 292e 0a20 2020   directory)..   
+00003d80: 2020 2020 2063 6f6d 6d61 6e64 7320 2b3d       commands +=
+00003d90: 205b 0a20 2020 2020 2020 2020 2020 2023   [.            #
+00003da0: 2045 7272 6f72 206f 7574 2069 6620 736f   Error out if so
+00003db0: 7572 6365 2069 7320 616e 2065 7869 7374  urce is an exist
+00003dc0: 696e 672c 206e 6f6e 2d73 796d 6c69 6e6b  ing, non-symlink
+00003dd0: 2064 6972 6563 746f 7279 2f66 696c 652e   directory/file.
+00003de0: 0a20 2020 2020 2020 2020 2020 2066 2728  .            f'(
+00003df0: 2874 6573 7420 2d4c 207b 736f 7572 6365  (test -L {source
+00003e00: 7d20 2626 2073 7564 6f20 726d 207b 736f  } && sudo rm {so
+00003e10: 7572 6365 7d20 263e 2f64 6576 2f6e 756c  urce} &>/dev/nul
+00003e20: 6c29 207c 7c20 270a 2020 2020 2020 2020  l) || '.        
+00003e30: 2020 2020 6627 2874 6573 7420 2120 2d65      f'(test ! -e
+00003e40: 207b 736f 7572 6365 7d20 7c7c 2027 0a20   {source} || '. 
+00003e50: 2020 2020 2020 2020 2020 2066 2728 6563             f'(ec
+00003e60: 686f 2022 2121 2120 4661 696c 6564 206d  ho "!!! Failed m
+00003e70: 6f75 6e74 696e 6720 6265 6361 7573 6520  ounting because 
+00003e80: 7061 7468 2065 7869 7374 7320 287b 736f  path exists ({so
+00003e90: 7572 6365 7d29 223b 2027 0a20 2020 2020  urce})"; '.     
+00003ea0: 2020 2020 2020 2027 6578 6974 2031 2929         'exit 1))
+00003eb0: 2927 2c0a 2020 2020 2020 2020 5d0a 2020  )',.        ].  
+00003ec0: 2020 2020 2020 636f 6d6d 616e 6473 202b        commands +
+00003ed0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00003ee0: 2320 4c69 6e6b 2e0a 2020 2020 2020 2020  # Link..        
+00003ef0: 2020 2020 6627 7375 646f 206c 6e20 2d73      f'sudo ln -s
+00003f00: 207b 7461 7267 6574 7d20 7b73 6f75 7263   {target} {sourc
+00003f10: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00003f20: 2023 2063 686f 776e 2e20 202d 6820 746f   # chown.  -h to
+00003f30: 2061 6666 6563 7420 7379 6d6c 696e 6b73   affect symlinks
+00003f40: 206f 6e6c 792e 0a20 2020 2020 2020 2020   only..         
+00003f50: 2020 2066 2773 7564 6f20 6368 6f77 6e20     f'sudo chown 
+00003f60: 2d68 2024 5553 4552 207b 736f 7572 6365  -h $USER {source
+00003f70: 7d27 2c0a 2020 2020 2020 2020 5d0a 2020  }',.        ].  
+00003f80: 2020 2020 2020 7265 7475 726e 2027 2026        return ' &
+00003f90: 2620 272e 6a6f 696e 2863 6f6d 6d61 6e64  & '.join(command
+00003fa0: 7329 0a0a 0a63 6c61 7373 2053 5348 436f  s)...class SSHCo
+00003fb0: 6e66 6967 4865 6c70 6572 286f 626a 6563  nfigHelper(objec
+00003fc0: 7429 3a0a 2020 2020 2222 2248 656c 7065  t):.    """Helpe
+00003fd0: 7220 666f 7220 6861 6e64 6c69 6e67 206c  r for handling l
+00003fe0: 6f63 616c 2053 5348 2063 6f6e 6669 6775  ocal SSH configu
+00003ff0: 7261 7469 6f6e 2e22 2222 0a0a 2020 2020  ration."""..    
+00004000: 7373 685f 636f 6e66 5f70 6174 6820 3d20  ssh_conf_path = 
+00004010: 277e 2f2e 7373 682f 636f 6e66 6967 270a  '~/.ssh/config'.
+00004020: 2020 2020 7373 685f 636f 6e66 5f6c 6f63      ssh_conf_loc
+00004030: 6b5f 7061 7468 203d 206f 732e 7061 7468  k_path = os.path
+00004040: 2e65 7870 616e 6475 7365 7228 277e 2f2e  .expanduser('~/.
+00004050: 736b 792f 7373 685f 636f 6e66 6967 2e6c  sky/ssh_config.l
+00004060: 6f63 6b27 290a 2020 2020 7373 685f 636c  ock').    ssh_cl
+00004070: 7573 7465 725f 7061 7468 203d 2053 4b59  uster_path = SKY
+00004080: 5f55 5345 525f 4649 4c45 5f50 4154 4820  _USER_FILE_PATH 
+00004090: 2b20 272f 7373 682f 7b7d 270a 0a20 2020  + '/ssh/{}'..   
+000040a0: 2040 636c 6173 736d 6574 686f 640a 2020   @classmethod.  
+000040b0: 2020 6465 6620 5f67 6574 5f67 656e 6572    def _get_gener
+000040c0: 6174 6564 5f63 6f6e 6669 6728 636c 732c  ated_config(cls,
+000040d0: 2061 7574 6f67 656e 5f63 6f6d 6d65 6e74   autogen_comment
+000040e0: 3a20 7374 722c 2068 6f73 745f 6e61 6d65  : str, host_name
+000040f0: 3a20 7374 722c 0a20 2020 2020 2020 2020  : str,.         
+00004100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004110: 2020 2020 2069 703a 2073 7472 2c20 7573       ip: str, us
+00004120: 6572 6e61 6d65 3a20 7374 722c 2073 7368  ername: str, ssh
+00004130: 5f6b 6579 5f70 6174 683a 2073 7472 2c0a  _key_path: str,.
+00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004150: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00004160: 6f78 795f 636f 6d6d 616e 643a 204f 7074  oxy_command: Opt
+00004170: 696f 6e61 6c5b 7374 725d 2c20 706f 7274  ional[str], port
+00004180: 3a20 696e 742c 0a20 2020 2020 2020 2020  : int,.         
+00004190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041a0: 2020 2020 2064 6f63 6b65 725f 7072 6f78       docker_prox
+000041b0: 795f 636f 6d6d 616e 643a 204f 7074 696f  y_command: Optio
+000041c0: 6e61 6c5b 7374 725d 293a 0a20 2020 2020  nal[str]):.     
+000041d0: 2020 2069 6620 7072 6f78 795f 636f 6d6d     if proxy_comm
+000041e0: 616e 6420 6973 206e 6f74 204e 6f6e 653a  and is not None:
+000041f0: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+00004200: 6c72 6561 6479 2063 6865 636b 6564 2069  lready checked i
+00004210: 6e20 7265 736f 7572 6365 730a 2020 2020  n resources.    
+00004220: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+00004230: 6f63 6b65 725f 7072 6f78 795f 636f 6d6d  ocker_proxy_comm
+00004240: 616e 6420 6973 204e 6f6e 652c 2028 0a20  and is None, (. 
+00004250: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00004260: 4361 6e6e 6f74 2073 7065 6369 6679 2062  Cannot specify b
+00004270: 6f74 6820 7072 6f78 795f 636f 6d6d 616e  oth proxy_comman
+00004280: 6420 616e 6420 646f 636b 6572 5f70 726f  d and docker_pro
+00004290: 7879 5f63 6f6d 6d61 6e64 2e27 290a 2020  xy_command.').  
+000042a0: 2020 2020 2020 2020 2020 7072 6f78 7920            proxy 
+000042b0: 3d20 6627 5072 6f78 7943 6f6d 6d61 6e64  = f'ProxyCommand
+000042c0: 207b 7072 6f78 795f 636f 6d6d 616e 647d   {proxy_command}
+000042d0: 270a 2020 2020 2020 2020 656c 6966 2064  '.        elif d
+000042e0: 6f63 6b65 725f 7072 6f78 795f 636f 6d6d  ocker_proxy_comm
+000042f0: 616e 6420 6973 206e 6f74 204e 6f6e 653a  and is not None:
+00004300: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00004310: 7879 203d 2066 2750 726f 7879 436f 6d6d  xy = f'ProxyComm
+00004320: 616e 6420 7b64 6f63 6b65 725f 7072 6f78  and {docker_prox
+00004330: 795f 636f 6d6d 616e 647d 270a 2020 2020  y_command}'.    
+00004340: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00004350: 2020 2020 2020 7072 6f78 7920 3d20 2727        proxy = ''
+00004360: 0a20 2020 2020 2020 2023 2053 7472 6963  .        # Stric
+00004370: 7448 6f73 744b 6579 4368 6563 6b69 6e67  tHostKeyChecking
+00004380: 3d6e 6f20 736b 6970 7320 7468 6520 686f  =no skips the ho
+00004390: 7374 206b 6579 2063 6865 636b 2066 6f72  st key check for
+000043a0: 2074 6865 2066 6972 7374 0a20 2020 2020   the first.     
+000043b0: 2020 2023 2074 696d 652e 2055 7365 724b     # time. UserK
+000043c0: 6e6f 776e 486f 7374 7346 696c 653d 2f64  nownHostsFile=/d
+000043d0: 6576 2f6e 756c 6c20 616e 6420 476c 6f62  ev/null and Glob
+000043e0: 616c 4b6e 6f77 6e48 6f73 7473 4669 6c65  alKnownHostsFile
+000043f0: 2f64 6576 2f6e 756c 6c0a 2020 2020 2020  /dev/null.      
+00004400: 2020 2320 7072 6576 656e 7420 7468 6520    # prevent the 
+00004410: 686f 7374 206b 6579 2066 726f 6d20 6265  host key from be
+00004420: 696e 6720 6164 6465 6420 746f 2074 6865  ing added to the
+00004430: 206b 6e6f 776e 5f68 6f73 7473 2066 696c   known_hosts fil
+00004440: 6520 616e 640a 2020 2020 2020 2020 2320  e and.        # 
+00004450: 616c 7761 7973 2072 6574 7572 6e20 616e  always return an
+00004460: 2065 6d70 7479 2066 696c 6520 666f 7220   empty file for 
+00004470: 6b6e 6f77 6e20 686f 7374 732c 206d 616b  known hosts, mak
+00004480: 696e 6720 7468 6520 7373 6820 7468 696e  ing the ssh thin
+00004490: 6b0a 2020 2020 2020 2020 2320 7468 6973  k.        # this
+000044a0: 2069 7320 6120 6669 7273 742d 7469 6d65   is a first-time
+000044b0: 2063 6f6e 6e65 6374 696f 6e2c 2061 6e64   connection, and
+000044c0: 2074 6875 7320 736b 6970 7069 6e67 2074   thus skipping t
+000044d0: 6865 2068 6f73 7420 6b65 790a 2020 2020  he host key.    
+000044e0: 2020 2020 2320 6368 6563 6b2e 0a20 2020      # check..   
+000044f0: 2020 2020 2063 6f64 6567 656e 203d 2074       codegen = t
+00004500: 6578 7477 7261 702e 6465 6465 6e74 2866  extwrap.dedent(f
+00004510: 2222 225c 0a20 2020 2020 2020 2020 2020  """\.           
+00004520: 207b 6175 746f 6765 6e5f 636f 6d6d 656e   {autogen_commen
+00004530: 747d 0a20 2020 2020 2020 2020 2020 2048  t}.            H
+00004540: 6f73 7420 7b68 6f73 745f 6e61 6d65 7d0a  ost {host_name}.
+00004550: 2020 2020 2020 2020 2020 2020 2020 486f                Ho
+00004560: 7374 4e61 6d65 207b 6970 7d0a 2020 2020  stName {ip}.    
+00004570: 2020 2020 2020 2020 2020 5573 6572 207b            User {
+00004580: 7573 6572 6e61 6d65 7d0a 2020 2020 2020  username}.      
+00004590: 2020 2020 2020 2020 4964 656e 7469 7479          Identity
+000045a0: 4669 6c65 207b 7373 685f 6b65 795f 7061  File {ssh_key_pa
+000045b0: 7468 7d0a 2020 2020 2020 2020 2020 2020  th}.            
+000045c0: 2020 4964 656e 7469 7469 6573 4f6e 6c79    IdentitiesOnly
+000045d0: 2079 6573 0a20 2020 2020 2020 2020 2020   yes.           
+000045e0: 2020 2046 6f72 7761 7264 4167 656e 7420     ForwardAgent 
+000045f0: 7965 730a 2020 2020 2020 2020 2020 2020  yes.            
+00004600: 2020 5374 7269 6374 486f 7374 4b65 7943    StrictHostKeyC
+00004610: 6865 636b 696e 6720 6e6f 0a20 2020 2020  hecking no.     
+00004620: 2020 2020 2020 2020 2055 7365 724b 6e6f           UserKno
+00004630: 776e 486f 7374 7346 696c 653d 2f64 6576  wnHostsFile=/dev
+00004640: 2f6e 756c 6c0a 2020 2020 2020 2020 2020  /null.          
+00004650: 2020 2020 476c 6f62 616c 4b6e 6f77 6e48      GlobalKnownH
+00004660: 6f73 7473 4669 6c65 3d2f 6465 762f 6e75  ostsFile=/dev/nu
+00004670: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+00004680: 2050 6f72 7420 7b70 6f72 747d 0a20 2020   Port {port}.   
+00004690: 2020 2020 2020 2020 2020 207b 7072 6f78             {prox
+000046a0: 797d 0a20 2020 2020 2020 2020 2020 2022  y}.            "
+000046b0: 2222 2e72 7374 7269 7028 2929 0a20 2020  "".rstrip()).   
+000046c0: 2020 2020 2063 6f64 6567 656e 203d 2063       codegen = c
+000046d0: 6f64 6567 656e 202b 2027 5c6e 270a 2020  odegen + '\n'.  
+000046e0: 2020 2020 2020 7265 7475 726e 2063 6f64        return cod
+000046f0: 6567 656e 0a0a 2020 2020 4063 6c61 7373  egen..    @class
+00004700: 6d65 7468 6f64 0a20 2020 2040 7469 6d65  method.    @time
+00004710: 6c69 6e65 2e46 696c 654c 6f63 6b45 7665  line.FileLockEve
+00004720: 6e74 2873 7368 5f63 6f6e 665f 6c6f 636b  nt(ssh_conf_lock
+00004730: 5f70 6174 6829 0a20 2020 2064 6566 2061  _path).    def a
+00004740: 6464 5f63 6c75 7374 6572 280a 2020 2020  dd_cluster(.    
+00004750: 2020 2020 636c 732c 0a20 2020 2020 2020      cls,.       
+00004760: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
+00004770: 7472 2c0a 2020 2020 2020 2020 6970 733a  tr,.        ips:
+00004780: 204c 6973 745b 7374 725d 2c0a 2020 2020   List[str],.    
+00004790: 2020 2020 6175 7468 5f63 6f6e 6669 673a      auth_config:
+000047a0: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
+000047b0: 0a20 2020 2020 2020 2070 6f72 7473 3a20  .        ports: 
+000047c0: 4c69 7374 5b69 6e74 5d2c 0a20 2020 2020  List[int],.     
+000047d0: 2020 2064 6f63 6b65 725f 7573 6572 3a20     docker_user: 
+000047e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+000047f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7373  None,.        ss
+00004800: 685f 7573 6572 3a20 4f70 7469 6f6e 616c  h_user: Optional
+00004810: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+00004820: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00004830: 4164 6420 6175 7468 656e 7469 6361 7469  Add authenticati
+00004840: 6f6e 2069 6e66 6f72 6d61 7469 6f6e 2066  on information f
+00004850: 6f72 2063 6c75 7374 6572 2074 6f20 6c6f  or cluster to lo
+00004860: 6361 6c20 5353 4820 636f 6e66 6967 2066  cal SSH config f
+00004870: 696c 652e 0a0a 2020 2020 2020 2020 4966  ile...        If
+00004880: 2061 2068 6f73 7420 7769 7468 2060 636c   a host with `cl
+00004890: 7573 7465 725f 6e61 6d65 6020 616c 7265  uster_name` alre
+000048a0: 6164 7920 6578 6973 7473 2061 6e64 2074  ady exists and t
+000048b0: 6865 2063 6f6e 6669 6775 7261 7469 6f6e  he configuration
+000048c0: 2077 6173 0a20 2020 2020 2020 206e 6f74   was.        not
+000048d0: 2061 6464 6564 2062 7920 736b 792c 2074   added by sky, t
+000048e0: 6865 6e20 6069 7060 2069 7320 7573 6564  hen `ip` is used
+000048f0: 2074 6f20 6964 656e 7469 6679 2074 6865   to identify the
+00004900: 2068 6f73 7420 696e 7374 6561 6420 696e   host instead in
+00004910: 2074 6865 0a20 2020 2020 2020 2066 696c   the.        fil
+00004920: 652e 0a0a 2020 2020 2020 2020 4966 2061  e...        If a
+00004930: 2068 6f73 7420 7769 7468 2060 636c 7573   host with `clus
+00004940: 7465 725f 6e61 6d65 6020 616c 7265 6164  ter_name` alread
+00004950: 7920 6578 6973 7473 2061 6e64 2074 6865  y exists and the
+00004960: 2063 6f6e 6669 6775 7261 7469 6f6e 2077   configuration w
+00004970: 6173 0a20 2020 2020 2020 2061 6464 6564  as.        added
+00004980: 2062 7920 736b 7920 2865 2e67 2e20 6120   by sky (e.g. a 
+00004990: 7370 6f74 2069 6e73 7461 6e63 6529 2c20  spot instance), 
+000049a0: 7468 656e 2074 6865 2063 6f6e 6669 6775  then the configu
+000049b0: 7261 7469 6f6e 2069 730a 2020 2020 2020  ration is.      
+000049c0: 2020 6f76 6572 7772 6974 7465 6e2e 0a0a    overwritten...
+000049d0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+000049e0: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+000049f0: 725f 6e61 6d65 3a20 436c 7573 7465 7220  r_name: Cluster 
+00004a00: 6e61 6d65 2028 7365 6520 6073 6b79 2073  name (see `sky s
+00004a10: 7461 7475 7360 290a 2020 2020 2020 2020  tatus`).        
+00004a20: 2020 2020 6970 733a 204c 6973 7420 6f66      ips: List of
+00004a30: 2070 7562 6c69 6320 4950 2061 6464 7265   public IP addre
+00004a40: 7373 6573 2069 6e20 7468 6520 636c 7573  sses in the clus
+00004a50: 7465 722e 2046 6972 7374 2049 5020 6973  ter. First IP is
+00004a60: 2068 6561 640a 2020 2020 2020 2020 2020   head.          
+00004a70: 2020 2020 6e6f 6465 2e0a 2020 2020 2020      node..      
+00004a80: 2020 2020 2020 6175 7468 5f63 6f6e 6669        auth_confi
+00004a90: 673a 2072 6561 645f 7961 6d6c 2868 616e  g: read_yaml(han
+00004aa0: 646c 652e 636c 7573 7465 725f 7961 6d6c  dle.cluster_yaml
+00004ab0: 295b 2761 7574 6827 5d0a 2020 2020 2020  )['auth'].      
+00004ac0: 2020 2020 2020 706f 7274 733a 204c 6973        ports: Lis
+00004ad0: 7420 6f66 2070 6f72 7420 6e75 6d62 6572  t of port number
+00004ae0: 7320 666f 7220 5353 4820 636f 7272 6573  s for SSH corres
+00004af0: 706f 6e64 696e 6720 746f 2069 7073 0a20  ponding to ips. 
+00004b00: 2020 2020 2020 2020 2020 2064 6f63 6b65             docke
+00004b10: 725f 7573 6572 3a20 4966 206e 6f74 204e  r_user: If not N
+00004b20: 6f6e 652c 2075 7365 2074 6869 7320 7573  one, use this us
+00004b30: 6572 2074 6f20 7373 6820 696e 746f 2074  er to ssh into t
+00004b40: 6865 2064 6f63 6b65 720a 2020 2020 2020  he docker.      
+00004b50: 2020 2020 2020 7373 685f 7573 6572 3a20        ssh_user: 
+00004b60: 4f76 6572 7269 6465 2074 6865 2073 7368  Override the ssh
+00004b70: 5f75 7365 7220 696e 2061 7574 685f 636f  _user in auth_co
+00004b80: 6e66 6967 0a20 2020 2020 2020 2022 2222  nfig.        """
+00004b90: 0a20 2020 2020 2020 2069 6620 7373 685f  .        if ssh_
+00004ba0: 7573 6572 2069 7320 4e6f 6e65 3a0a 2020  user is None:.  
+00004bb0: 2020 2020 2020 2020 2020 7573 6572 6e61            userna
+00004bc0: 6d65 203d 2061 7574 685f 636f 6e66 6967  me = auth_config
+00004bd0: 5b27 7373 685f 7573 6572 275d 0a20 2020  ['ssh_user'].   
+00004be0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00004bf0: 2020 2020 2020 2075 7365 726e 616d 6520         username 
+00004c00: 3d20 7373 685f 7573 6572 0a20 2020 2020  = ssh_user.     
+00004c10: 2020 2069 6620 646f 636b 6572 5f75 7365     if docker_use
+00004c20: 7220 6973 206e 6f74 204e 6f6e 653a 0a20  r is not None:. 
+00004c30: 2020 2020 2020 2020 2020 2075 7365 726e             usern
+00004c40: 616d 6520 3d20 646f 636b 6572 5f75 7365  ame = docker_use
+00004c50: 720a 2020 2020 2020 2020 6b65 795f 7061  r.        key_pa
+00004c60: 7468 203d 206f 732e 7061 7468 2e65 7870  th = os.path.exp
+00004c70: 616e 6475 7365 7228 6175 7468 5f63 6f6e  anduser(auth_con
+00004c80: 6669 675b 2773 7368 5f70 7269 7661 7465  fig['ssh_private
+00004c90: 5f6b 6579 275d 290a 2020 2020 2020 2020  _key']).        
+00004ca0: 736b 795f 6175 746f 6765 6e5f 636f 6d6d  sky_autogen_comm
+00004cb0: 656e 7420 3d20 2827 2320 4164 6465 6420  ent = ('# Added 
+00004cc0: 6279 2073 6b79 2028 7573 6520 6073 6b79  by sky (use `sky
+00004cd0: 2073 746f 702f 646f 776e 2027 0a20 2020   stop/down '.   
+00004ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004cf0: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
+00004d00: 6c75 7374 6572 5f6e 616d 657d 6020 746f  luster_name}` to
+00004d10: 2072 656d 6f76 6529 2729 0a20 2020 2020   remove)').     
+00004d20: 2020 2069 7020 3d20 6970 735b 305d 0a20     ip = ips[0]. 
+00004d30: 2020 2020 2020 2069 6620 646f 636b 6572         if docker
+00004d40: 5f75 7365 7220 6973 206e 6f74 204e 6f6e  _user is not Non
+00004d50: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00004d60: 7020 3d20 276c 6f63 616c 686f 7374 270a  p = 'localhost'.
+00004d70: 0a20 2020 2020 2020 2063 6f6e 6669 675f  .        config_
+00004d80: 7061 7468 203d 206f 732e 7061 7468 2e65  path = os.path.e
+00004d90: 7870 616e 6475 7365 7228 636c 732e 7373  xpanduser(cls.ss
+00004da0: 685f 636f 6e66 5f70 6174 6829 0a0a 2020  h_conf_path)..  
+00004db0: 2020 2020 2020 2320 466f 7220 6261 636b        # For back
+00004dc0: 7761 7264 2063 6f6d 7061 7469 6269 6c69  ward compatibili
+00004dd0: 7479 3a20 6265 666f 7265 2023 3237 3036  ty: before #2706
+00004de0: 2c20 7765 2077 726f 7465 2074 6865 2063  , we wrote the c
+00004df0: 6f6e 6669 6720 6f66 2053 6b79 5069 6c6f  onfig of SkyPilo
+00004e00: 7420 636c 7573 7465 7273 0a20 2020 2020  t clusters.     
+00004e10: 2020 2023 2064 6972 6563 746c 7920 696e     # directly in
+00004e20: 207e 2f2e 7373 682f 636f 6e66 6967 2e20   ~/.ssh/config. 
+00004e30: 466f 7220 7468 6573 6520 636c 7573 7465  For these cluste
+00004e40: 7273 2c20 7765 2072 656d 6f76 6520 7468  rs, we remove th
+00004e50: 6520 636f 6e66 6967 2069 6e20 7e2f 2e73  e config in ~/.s
+00004e60: 7368 2f63 6f6e 6669 670a 2020 2020 2020  sh/config.      
+00004e70: 2020 2320 616e 6420 7772 6974 652f 6f76    # and write/ov
+00004e80: 6572 7772 6974 6520 7468 6520 636f 6e66  erwrite the conf
+00004e90: 6967 2069 6e20 7e2f 2e73 6b79 2f73 7368  ig in ~/.sky/ssh
+00004ea0: 2f3c 636c 7573 7465 725f 6e61 6d65 3e20  /<cluster_name> 
+00004eb0: 696e 7374 6561 642e 0a20 2020 2020 2020  instead..       
+00004ec0: 2063 6c73 2e5f 7265 6d6f 7665 5f73 7461   cls._remove_sta
+00004ed0: 6c65 5f63 6c75 7374 6572 5f63 6f6e 6669  le_cluster_confi
+00004ee0: 675f 666f 725f 6261 636b 7761 7264 5f63  g_for_backward_c
+00004ef0: 6f6d 7061 7469 6269 6c69 7479 280a 2020  ompatibility(.  
+00004f00: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00004f10: 725f 6e61 6d65 2c20 6970 2c20 6175 7468  r_name, ip, auth
+00004f20: 5f63 6f6e 6669 672c 2064 6f63 6b65 725f  _config, docker_
+00004f30: 7573 6572 290a 0a20 2020 2020 2020 2069  user)..        i
+00004f40: 6620 6e6f 7420 6f73 2e70 6174 682e 6578  f not os.path.ex
+00004f50: 6973 7473 2863 6f6e 6669 675f 7061 7468  ists(config_path
+00004f60: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00004f70: 6f6e 6669 6720 3d20 5b27 5c6e 275d 0a20  onfig = ['\n']. 
+00004f80: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00004f90: 6f70 656e 2863 6f6e 6669 675f 7061 7468  open(config_path
+00004fa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004fb0: 2020 2020 2020 2020 2777 272c 0a20 2020          'w',.   
+00004fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004fd0: 2020 2065 6e63 6f64 696e 673d 2775 7466     encoding='utf
+00004fe0: 2d38 272c 0a20 2020 2020 2020 2020 2020  -8',.           
+00004ff0: 2020 2020 2020 2020 2020 206f 7065 6e65             opene
+00005000: 723d 6675 6e63 746f 6f6c 732e 7061 7274  r=functools.part
+00005010: 6961 6c28 6f73 2e6f 7065 6e2c 206d 6f64  ial(os.open, mod
+00005020: 653d 306f 3634 3429 2920 6173 2066 3a0a  e=0o644)) as f:.
+00005030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005040: 662e 7772 6974 656c 696e 6573 2863 6f6e  f.writelines(con
+00005050: 6669 6729 0a0a 2020 2020 2020 2020 7769  fig)..        wi
+00005060: 7468 206f 7065 6e28 636f 6e66 6967 5f70  th open(config_p
+00005070: 6174 682c 2027 7227 2c20 656e 636f 6469  ath, 'r', encodi
+00005080: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+00005090: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000050a0: 6e66 6967 203d 2066 2e72 6561 646c 696e  nfig = f.readlin
+000050b0: 6573 2829 0a0a 2020 2020 2020 2020 7373  es()..        ss
+000050c0: 685f 6469 7220 3d20 636c 732e 7373 685f  h_dir = cls.ssh_
+000050d0: 636c 7573 7465 725f 7061 7468 2e66 6f72  cluster_path.for
+000050e0: 6d61 7428 2727 290a 2020 2020 2020 2020  mat('').        
+000050f0: 6f73 2e6d 616b 6564 6972 7328 6f73 2e70  os.makedirs(os.p
+00005100: 6174 682e 6578 7061 6e64 7573 6572 2873  ath.expanduser(s
+00005110: 7368 5f64 6972 292c 2065 7869 7374 5f6f  sh_dir), exist_o
+00005120: 6b3d 5472 7565 2c20 6d6f 6465 3d30 6f37  k=True, mode=0o7
+00005130: 3030 290a 0a20 2020 2020 2020 2023 2048  00)..        # H
+00005140: 616e 646c 6520 496e 636c 7564 6520 6f6e  andle Include on
+00005150: 2074 6f70 206f 6620 436f 6e66 6967 2066   top of Config f
+00005160: 696c 650a 2020 2020 2020 2020 696e 636c  ile.        incl
+00005170: 7564 655f 7374 7220 3d20 6627 496e 636c  ude_str = f'Incl
+00005180: 7564 6520 7b63 6c73 2e73 7368 5f63 6c75  ude {cls.ssh_clu
+00005190: 7374 6572 5f70 6174 682e 666f 726d 6174  ster_path.format
+000051a0: 2822 2a22 297d 270a 2020 2020 2020 2020  ("*")}'.        
+000051b0: 666f 756e 6420 3d20 4661 6c73 650a 2020  found = False.  
+000051c0: 2020 2020 2020 666f 7220 692c 206c 696e        for i, lin
+000051d0: 6520 696e 2065 6e75 6d65 7261 7465 2863  e in enumerate(c
+000051e0: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
+000051f0: 2020 2020 636f 6e66 6967 5f73 7472 203d      config_str =
+00005200: 206c 696e 652e 7374 7269 7028 290a 2020   line.strip().  
+00005210: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
+00005220: 6669 675f 7374 7220 3d3d 2069 6e63 6c75  fig_str == inclu
+00005230: 6465 5f73 7472 3a0a 2020 2020 2020 2020  de_str:.        
+00005240: 2020 2020 2020 2020 666f 756e 6420 3d20          found = 
+00005250: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00005260: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+00005270: 2020 2020 2020 2069 6620 2748 6f73 7427         if 'Host'
+00005280: 2069 6e20 636f 6e66 6967 5f73 7472 3a0a   in config_str:.
+00005290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052a0: 6272 6561 6b0a 2020 2020 2020 2020 6966  break.        if
+000052b0: 206e 6f74 2066 6f75 6e64 3a0a 2020 2020   not found:.    
+000052c0: 2020 2020 2020 2020 2320 4469 6420 6e6f          # Did no
+000052d0: 7420 6669 6e64 2049 6e63 6c75 6465 2073  t find Include s
+000052e0: 7472 696e 672e 2049 6e73 6572 7420 6049  tring. Insert `I
+000052f0: 6e63 6c75 6465 6020 6c69 6e65 732e 0a20  nclude` lines.. 
+00005300: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00005310: 6f70 656e 2863 6f6e 6669 675f 7061 7468  open(config_path
+00005320: 2c20 2777 272c 2065 6e63 6f64 696e 673d  , 'w', encoding=
+00005330: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00005340: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00005350: 6f6e 6669 672e 696e 7365 7274 280a 2020  onfig.insert(.  
+00005360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005370: 2020 302c 0a20 2020 2020 2020 2020 2020    0,.           
+00005380: 2020 2020 2020 2020 2066 2723 2041 6464           f'# Add
+00005390: 6564 2062 7920 536b 7950 696c 6f74 2066  ed by SkyPilot f
+000053a0: 6f72 2073 7368 2063 6f6e 6669 6720 6f66  or ssh config of
+000053b0: 2061 6c6c 2063 6c75 7374 6572 735c 6e7b   all clusters\n{
+000053c0: 696e 636c 7564 655f 7374 727d 5c6e 270a  include_str}\n'.
+000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000053f0: 2020 662e 7772 6974 6528 2727 2e6a 6f69    f.write(''.joi
+00005400: 6e28 636f 6e66 6967 292e 7374 7269 7028  n(config).strip(
+00005410: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00005420: 2020 2066 2e77 7269 7465 2827 5c6e 2720     f.write('\n' 
+00005430: 2a20 3229 0a0a 2020 2020 2020 2020 7072  * 2)..        pr
+00005440: 6f78 795f 636f 6d6d 616e 6420 3d20 6175  oxy_command = au
+00005450: 7468 5f63 6f6e 6669 672e 6765 7428 2773  th_config.get('s
+00005460: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
+00005470: 272c 204e 6f6e 6529 0a0a 2020 2020 2020  ', None)..      
+00005480: 2020 646f 636b 6572 5f70 726f 7879 5f63    docker_proxy_c
+00005490: 6f6d 6d61 6e64 5f67 656e 6572 6174 6f72  ommand_generator
+000054a0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000054b0: 6966 2064 6f63 6b65 725f 7573 6572 2069  if docker_user i
+000054c0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000054d0: 2020 2020 2020 2020 646f 636b 6572 5f70          docker_p
+000054e0: 726f 7879 5f63 6f6d 6d61 6e64 5f67 656e  roxy_command_gen
+000054f0: 6572 6174 6f72 203d 206c 616d 6264 6120  erator = lambda 
+00005500: 6970 2c20 706f 7274 3a20 2720 272e 6a6f  ip, port: ' '.jo
+00005510: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00005520: 2020 2020 5b27 7373 6827 5d20 2b20 636f      ['ssh'] + co
+00005530: 6d6d 616e 645f 7275 6e6e 6572 2e73 7368  mmand_runner.ssh
+00005540: 5f6f 7074 696f 6e73 5f6c 6973 7428 0a20  _options_list(. 
+00005550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005560: 2020 206b 6579 5f70 6174 682c 2073 7368     key_path, ssh
+00005570: 5f63 6f6e 7472 6f6c 5f6e 616d 653d 4e6f  _control_name=No
+00005580: 6e65 2c20 706f 7274 3d70 6f72 7429 202b  ne, port=port) +
+00005590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000055a0: 205b 272d 5727 2c20 2725 683a 2570 272c   ['-W', '%h:%p',
+000055b0: 2066 277b 6175 7468 5f63 6f6e 6669 675b   f'{auth_config[
+000055c0: 2273 7368 5f75 7365 7222 5d7d 407b 6970  "ssh_user"]}@{ip
+000055d0: 7d27 5d29 0a0a 2020 2020 2020 2020 636f  }'])..        co
+000055e0: 6465 6765 6e20 3d20 2727 0a20 2020 2020  degen = ''.     
+000055f0: 2020 2023 2041 6464 2074 6865 206e 6f64     # Add the nod
+00005600: 6573 2074 6f20 7468 6520 636f 6465 6765  es to the codege
+00005610: 6e0a 2020 2020 2020 2020 666f 7220 692c  n.        for i,
+00005620: 2069 7020 696e 2065 6e75 6d65 7261 7465   ip in enumerate
+00005630: 2869 7073 293a 0a20 2020 2020 2020 2020  (ips):.         
+00005640: 2020 2064 6f63 6b65 725f 7072 6f78 795f     docker_proxy_
+00005650: 636f 6d6d 616e 6420 3d20 4e6f 6e65 0a20  command = None. 
+00005660: 2020 2020 2020 2020 2020 2070 6f72 7420             port 
+00005670: 3d20 706f 7274 735b 695d 0a20 2020 2020  = ports[i].     
+00005680: 2020 2020 2020 2069 6620 646f 636b 6572         if docker
+00005690: 5f70 726f 7879 5f63 6f6d 6d61 6e64 5f67  _proxy_command_g
+000056a0: 656e 6572 6174 6f72 2069 7320 6e6f 7420  enerator is not 
+000056b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000056c0: 2020 2020 2020 646f 636b 6572 5f70 726f        docker_pro
+000056d0: 7879 5f63 6f6d 6d61 6e64 203d 2064 6f63  xy_command = doc
+000056e0: 6b65 725f 7072 6f78 795f 636f 6d6d 616e  ker_proxy_comman
+000056f0: 645f 6765 6e65 7261 746f 7228 6970 2c20  d_generator(ip, 
+00005700: 706f 7274 290a 2020 2020 2020 2020 2020  port).          
+00005710: 2020 2020 2020 6970 203d 2027 6c6f 6361        ip = 'loca
+00005720: 6c68 6f73 7427 0a20 2020 2020 2020 2020  lhost'.         
+00005730: 2020 2020 2020 2070 6f72 7420 3d20 636f         port = co
+00005740: 6e73 7461 6e74 732e 4445 4641 554c 545f  nstants.DEFAULT_
+00005750: 444f 434b 4552 5f50 4f52 540a 2020 2020  DOCKER_PORT.    
+00005760: 2020 2020 2020 2020 6e6f 6465 5f6e 616d          node_nam
+00005770: 6520 3d20 636c 7573 7465 725f 6e61 6d65  e = cluster_name
+00005780: 2069 6620 6920 3d3d 2030 2065 6c73 6520   if i == 0 else 
+00005790: 636c 7573 7465 725f 6e61 6d65 202b 2066  cluster_name + f
+000057a0: 272d 776f 726b 6572 7b69 7d27 0a20 2020  '-worker{i}'.   
+000057b0: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+000057c0: 726f 6d69 6c62 293a 2055 7064 6174 6520  romilb): Update 
+000057d0: 706f 7274 206e 756d 6265 7220 7768 656e  port number when
+000057e0: 206b 3873 2073 7570 706f 7274 7320 6d75   k8s supports mu
+000057f0: 6c74 696e 6f64 650a 2020 2020 2020 2020  ltinode.        
+00005800: 2020 2020 636f 6465 6765 6e20 2b3d 2063      codegen += c
+00005810: 6c73 2e5f 6765 745f 6765 6e65 7261 7465  ls._get_generate
+00005820: 645f 636f 6e66 6967 280a 2020 2020 2020  d_config(.      
+00005830: 2020 2020 2020 2020 2020 736b 795f 6175            sky_au
+00005840: 746f 6765 6e5f 636f 6d6d 656e 742c 206e  togen_comment, n
+00005850: 6f64 655f 6e61 6d65 2c20 6970 2c20 7573  ode_name, ip, us
+00005860: 6572 6e61 6d65 2c20 6b65 795f 7061 7468  ername, key_path
+00005870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005880: 2020 7072 6f78 795f 636f 6d6d 616e 642c    proxy_command,
+00005890: 2070 6f72 742c 2064 6f63 6b65 725f 7072   port, docker_pr
+000058a0: 6f78 795f 636f 6d6d 616e 6429 202b 2027  oxy_command) + '
+000058b0: 5c6e 270a 0a20 2020 2020 2020 2063 6c75  \n'..        clu
+000058c0: 7374 6572 5f63 6f6e 6669 675f 7061 7468  ster_config_path
+000058d0: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+000058e0: 6475 7365 7228 0a20 2020 2020 2020 2020  duser(.         
+000058f0: 2020 2063 6c73 2e73 7368 5f63 6c75 7374     cls.ssh_clust
+00005900: 6572 5f70 6174 682e 666f 726d 6174 2863  er_path.format(c
+00005910: 6c75 7374 6572 5f6e 616d 6529 290a 0a20  luster_name)).. 
+00005920: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00005930: 2863 6c75 7374 6572 5f63 6f6e 6669 675f  (cluster_config_
+00005940: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00005950: 2020 2020 2020 2020 2777 272c 0a20 2020          'w',.   
+00005960: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00005970: 6e63 6f64 696e 673d 2775 7466 2d38 272c  ncoding='utf-8',
+00005980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005990: 2020 206f 7065 6e65 723d 6675 6e63 746f     opener=functo
+000059a0: 6f6c 732e 7061 7274 6961 6c28 6f73 2e6f  ols.partial(os.o
+000059b0: 7065 6e2c 206d 6f64 653d 306f 3634 3429  pen, mode=0o644)
+000059c0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+000059d0: 2020 2020 662e 7772 6974 6528 636f 6465      f.write(code
+000059e0: 6765 6e29 0a0a 2020 2020 4063 6c61 7373  gen)..    @class
+000059f0: 6d65 7468 6f64 0a20 2020 2064 6566 205f  method.    def _
+00005a00: 7265 6d6f 7665 5f73 7461 6c65 5f63 6c75  remove_stale_clu
+00005a10: 7374 6572 5f63 6f6e 6669 675f 666f 725f  ster_config_for_
+00005a20: 6261 636b 7761 7264 5f63 6f6d 7061 7469  backward_compati
+00005a30: 6269 6c69 7479 280a 2020 2020 2020 2020  bility(.        
+00005a40: 636c 732c 0a20 2020 2020 2020 2063 6c75  cls,.        clu
+00005a50: 7374 6572 5f6e 616d 653a 2073 7472 2c0a  ster_name: str,.
+00005a60: 2020 2020 2020 2020 6970 3a20 7374 722c          ip: str,
+00005a70: 0a20 2020 2020 2020 2061 7574 685f 636f  .        auth_co
+00005a80: 6e66 6967 3a20 4469 6374 5b73 7472 2c20  nfig: Dict[str, 
+00005a90: 7374 725d 2c0a 2020 2020 2020 2020 646f  str],.        do
+00005aa0: 636b 6572 5f75 7365 723a 204f 7074 696f  cker_user: Optio
+00005ab0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00005ac0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00005ad0: 2222 2252 656d 6f76 6520 6175 7468 656e  """Remove authen
+00005ae0: 7469 6361 7469 6f6e 2069 6e66 6f72 6d61  tication informa
+00005af0: 7469 6f6e 2066 6f72 2063 6c75 7374 6572  tion for cluster
+00005b00: 2066 726f 6d20 6c6f 6361 6c20 5353 4820   from local SSH 
+00005b10: 636f 6e66 6967 2e0a 0a20 2020 2020 2020  config...       
+00005b20: 2049 6620 6e6f 2065 7869 7374 696e 6720   If no existing 
+00005b30: 686f 7374 206d 6174 6368 696e 6720 7468  host matching th
+00005b40: 6520 7072 6f76 6964 6564 2073 7065 6369  e provided speci
+00005b50: 6669 6361 7469 6f6e 2069 7320 666f 756e  fication is foun
+00005b60: 642c 2074 6865 6e0a 2020 2020 2020 2020  d, then.        
+00005b70: 6e6f 7468 696e 6720 6973 2072 656d 6f76  nothing is remov
+00005b80: 6564 2e0a 0a20 2020 2020 2020 2041 7267  ed...        Arg
+00005b90: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00005ba0: 703a 2048 6561 6420 6e6f 6465 2773 2049  p: Head node's I
+00005bb0: 5020 6164 6472 6573 732e 0a20 2020 2020  P address..     
+00005bc0: 2020 2020 2020 2061 7574 685f 636f 6e66         auth_conf
+00005bd0: 6967 3a20 7265 6164 5f79 616d 6c28 6861  ig: read_yaml(ha
+00005be0: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
+00005bf0: 6c29 5b27 6175 7468 275d 0a20 2020 2020  l)['auth'].     
+00005c00: 2020 2020 2020 2064 6f63 6b65 725f 7573         docker_us
+00005c10: 6572 3a20 4966 206e 6f74 204e 6f6e 652c  er: If not None,
+00005c20: 2075 7365 2074 6869 7320 7573 6572 2074   use this user t
+00005c30: 6f20 7373 6820 696e 746f 2074 6865 2064  o ssh into the d
+00005c40: 6f63 6b65 720a 2020 2020 2020 2020 2222  ocker.        ""
+00005c50: 220a 2020 2020 2020 2020 7573 6572 6e61  ".        userna
+00005c60: 6d65 203d 2061 7574 685f 636f 6e66 6967  me = auth_config
+00005c70: 5b27 7373 685f 7573 6572 275d 0a20 2020  ['ssh_user'].   
+00005c80: 2020 2020 2063 6f6e 6669 675f 7061 7468       config_path
+00005c90: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+00005ca0: 6475 7365 7228 636c 732e 7373 685f 636f  duser(cls.ssh_co
+00005cb0: 6e66 5f70 6174 6829 0a20 2020 2020 2020  nf_path).       
+00005cc0: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
+00005cd0: 7061 7468 203d 206f 732e 7061 7468 2e65  path = os.path.e
+00005ce0: 7870 616e 6475 7365 7228 0a20 2020 2020  xpanduser(.     
+00005cf0: 2020 2020 2020 2063 6c73 2e73 7368 5f63         cls.ssh_c
+00005d00: 6c75 7374 6572 5f70 6174 682e 666f 726d  luster_path.form
+00005d10: 6174 2863 6c75 7374 6572 5f6e 616d 6529  at(cluster_name)
+00005d20: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00005d30: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
+00005d40: 636f 6e66 6967 5f70 6174 6829 3a0a 2020  config_path):.  
+00005d50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00005d60: 0a0a 2020 2020 2020 2020 7769 7468 206f  ..        with o
+00005d70: 7065 6e28 636f 6e66 6967 5f70 6174 682c  pen(config_path,
+00005d80: 2027 7227 2c20 656e 636f 6469 6e67 3d27   'r', encoding='
+00005d90: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
+00005da0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00005db0: 203d 2066 2e72 6561 646c 696e 6573 2829   = f.readlines()
+00005dc0: 0a0a 2020 2020 2020 2020 7374 6172 745f  ..        start_
+00005dd0: 6c69 6e65 5f69 6478 203d 204e 6f6e 650a  line_idx = None.
+00005de0: 0a20 2020 2020 2020 2023 2053 6361 6e20  .        # Scan 
+00005df0: 7468 6520 636f 6e66 6967 2066 6f72 2074  the config for t
+00005e00: 6865 2063 6c75 7374 6572 206e 616d 652e  he cluster name.
+00005e10: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
+00005e20: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
+00005e30: 6528 636f 6e66 6967 293a 0a20 2020 2020  e(config):.     
+00005e40: 2020 2020 2020 206e 6578 745f 6c69 6e65         next_line
+00005e50: 203d 2063 6f6e 6669 675b 6920 2b20 315d   = config[i + 1]
+00005e60: 2069 6620 6920 2b20 3120 3c20 6c65 6e28   if i + 1 < len(
+00005e70: 636f 6e66 6967 2920 656c 7365 2027 270a  config) else ''.
+00005e80: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00005e90: 6f63 6b65 725f 7573 6572 2069 7320 4e6f  ocker_user is No
+00005ea0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00005eb0: 2020 2020 666f 756e 6420 3d20 286c 696e      found = (lin
+00005ec0: 652e 7374 7269 7028 2920 3d3d 2066 2748  e.strip() == f'H
+00005ed0: 6f73 744e 616d 6520 7b69 707d 2720 616e  ostName {ip}' an
+00005ee0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00005ef0: 2020 2020 2020 2020 2020 206e 6578 745f             next_
+00005f00: 6c69 6e65 2e73 7472 6970 2829 203d 3d20  line.strip() == 
+00005f10: 6627 5573 6572 207b 7573 6572 6e61 6d65  f'User {username
+00005f20: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00005f30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00005f40: 2020 2020 2020 666f 756e 6420 3d20 286c        found = (l
+00005f50: 696e 652e 7374 7269 7028 2920 3d3d 2027  ine.strip() == '
+00005f60: 486f 7374 4e61 6d65 206c 6f63 616c 686f  HostName localho
+00005f70: 7374 2720 616e 640a 2020 2020 2020 2020  st' and.        
+00005f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f90: 206e 6578 745f 6c69 6e65 2e73 7472 6970   next_line.strip
+00005fa0: 2829 203d 3d20 6627 5573 6572 207b 646f  () == f'User {do
+00005fb0: 636b 6572 5f75 7365 727d 2729 0a20 2020  cker_user}').   
+00005fc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00005fd0: 666f 756e 643a 0a20 2020 2020 2020 2020  found:.         
+00005fe0: 2020 2020 2020 2020 2020 2023 2046 696e             # Fin
+00005ff0: 6420 7468 6520 6c69 6e65 2073 7461 7274  d the line start
+00006000: 696e 6720 7769 7468 2050 726f 7879 436f  ing with ProxyCo
+00006010: 6d6d 616e 6420 616e 6420 636f 6e74 6169  mmand and contai
+00006020: 6e73 2074 6865 2069 700a 2020 2020 2020  ns the ip.      
+00006030: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00006040: 756e 6420 3d20 4661 6c73 650a 2020 2020  und = False.    
+00006050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006060: 666f 7220 6964 7820 696e 2072 616e 6765  for idx in range
+00006070: 2869 2c20 6c65 6e28 636f 6e66 6967 2929  (i, len(config))
+00006080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006090: 2020 2020 2020 2020 2020 2320 5374 6f70            # Stop
+000060a0: 2069 6620 7765 2072 6561 6368 2061 6e20   if we reach an 
+000060b0: 656d 7074 7920 6c69 6e65 2c20 7768 6963  empty line, whic
+000060c0: 6820 6d65 616e 7320 6120 6e65 7720 686f  h means a new ho
+000060d0: 7374 0a20 2020 2020 2020 2020 2020 2020  st.             
+000060e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000060f0: 7420 636f 6e66 6967 5b69 6478 5d2e 7374  t config[idx].st
+00006100: 7269 7028 293a 0a20 2020 2020 2020 2020  rip():.         
+00006110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006120: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+00006130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006140: 2069 6620 636f 6e66 6967 5b69 6478 5d2e   if config[idx].
+00006150: 7374 7269 7028 292e 7374 6172 7473 7769  strip().startswi
+00006160: 7468 2827 5072 6f78 7943 6f6d 6d61 6e64  th('ProxyCommand
+00006170: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00006180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006190: 7072 6f78 795f 636f 6d6d 616e 645f 6c69  proxy_command_li
+000061a0: 6e65 203d 2063 6f6e 6669 675b 6964 785d  ne = config[idx]
+000061b0: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+000061c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061d0: 2020 2020 2069 6620 7072 6f78 795f 636f       if proxy_co
+000061e0: 6d6d 616e 645f 6c69 6e65 2e65 6e64 7377  mmand_line.endsw
+000061f0: 6974 6828 6627 407b 6970 7d27 293a 0a20  ith(f'@{ip}'):. 
 00006200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006210: 666f 756e 6420 3d20 5472 7565 0a20 2020  found = True.   
-00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006230: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00006240: 616b 0a20 2020 2020 2020 2020 2020 2069  ak.            i
-00006250: 6620 666f 756e 643a 0a20 2020 2020 2020  f found:.       
-00006260: 2020 2020 2020 2020 2073 7461 7274 5f6c           start_l
-00006270: 696e 655f 6964 7820 3d20 6920 2d20 310a  ine_idx = i - 1.
-00006280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006290: 6272 6561 6b0a 0a20 2020 2020 2020 2069  break..        i
-000062a0: 6620 7374 6172 745f 6c69 6e65 5f69 6478  f start_line_idx
-000062b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000062c0: 2020 2020 2020 2020 2020 2320 5363 616e            # Scan
-000062d0: 2066 6f72 2065 6e64 206f 6620 7072 6576   for end of prev
-000062e0: 696f 7573 2063 6f6e 6669 672e 0a20 2020  ious config..   
-000062f0: 2020 2020 2020 2020 2063 7572 736f 7220           cursor 
-00006300: 3d20 7374 6172 745f 6c69 6e65 5f69 6478  = start_line_idx
-00006310: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-00006320: 6c65 2063 7572 736f 7220 3e20 3020 616e  le cursor > 0 an
-00006330: 6420 6c65 6e28 636f 6e66 6967 5b63 7572  d len(config[cur
-00006340: 736f 725d 2e73 7472 6970 2829 2920 3e20  sor].strip()) > 
-00006350: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00006360: 2020 2063 7572 736f 7220 2d3d 2031 0a20     cursor -= 1. 
-00006370: 2020 2020 2020 2020 2020 2070 7265 765f             prev_
-00006380: 656e 645f 6c69 6e65 5f69 6478 203d 2063  end_line_idx = c
-00006390: 7572 736f 720a 0a20 2020 2020 2020 2020  ursor..         
-000063a0: 2020 2023 2053 6361 6e20 666f 7220 656e     # Scan for en
-000063b0: 6420 6f66 2074 6865 2063 6c75 7374 6572  d of the cluster
-000063c0: 2063 6f6e 6669 672e 0a20 2020 2020 2020   config..       
-000063d0: 2020 2020 2065 6e64 5f6c 696e 655f 6964       end_line_id
-000063e0: 7820 3d20 4e6f 6e65 0a20 2020 2020 2020  x = None.       
-000063f0: 2020 2020 2063 7572 736f 7220 3d20 7374       cursor = st
-00006400: 6172 745f 6c69 6e65 5f69 6478 202b 2031  art_line_idx + 1
-00006410: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00006420: 7274 5f6c 696e 655f 6964 7820 2d3d 2031  rt_line_idx -= 1
-00006430: 2020 2320 7265 6d6f 7665 2061 7574 6f2d    # remove auto-
-00006440: 6765 6e65 7261 7465 6420 636f 6d6d 656e  generated commen
-00006450: 740a 2020 2020 2020 2020 2020 2020 7768  t.            wh
-00006460: 696c 6520 6375 7273 6f72 203c 206c 656e  ile cursor < len
-00006470: 2863 6f6e 6669 6729 3a0a 2020 2020 2020  (config):.      
-00006480: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
-00006490: 6669 675b 6375 7273 6f72 5d2e 7374 7269  fig[cursor].stri
-000064a0: 7028 292e 7374 6172 7473 7769 7468 280a  p().startswith(.
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064c0: 2020 2020 2020 2020 2723 2027 2920 6f72          '# ') or
-000064d0: 2063 6f6e 6669 675b 6375 7273 6f72 5d2e   config[cursor].
-000064e0: 7374 7269 7028 292e 7374 6172 7473 7769  strip().startswi
-000064f0: 7468 2827 486f 7374 2027 293a 0a20 2020  th('Host '):.   
-00006500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006510: 2065 6e64 5f6c 696e 655f 6964 7820 3d20   end_line_idx = 
-00006520: 6375 7273 6f72 0a20 2020 2020 2020 2020  cursor.         
-00006530: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00006540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006550: 2063 7572 736f 7220 2b3d 2031 0a0a 2020   cursor += 1..  
-00006560: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
-00006570: 7665 2073 6b79 2d67 656e 6572 6174 6564  ve sky-generated
-00006580: 2063 6f6e 6669 6720 616e 6420 7570 6461   config and upda
-00006590: 7465 2074 6865 2066 696c 652e 0a20 2020  te the file..   
-000065a0: 2020 2020 2020 2020 2063 6f6e 6669 675b           config[
-000065b0: 7072 6576 5f65 6e64 5f6c 696e 655f 6964  prev_end_line_id
-000065c0: 783a 656e 645f 6c69 6e65 5f69 6478 5d20  x:end_line_idx] 
-000065d0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-000065e0: 2020 2020 275c 6e27 0a20 2020 2020 2020      '\n'.       
-000065f0: 2020 2020 205d 2069 6620 656e 645f 6c69       ] if end_li
-00006600: 6e65 5f69 6478 2069 7320 6e6f 7420 4e6f  ne_idx is not No
-00006610: 6e65 2065 6c73 6520 5b5d 0a20 2020 2020  ne else [].     
-00006620: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
-00006630: 2863 6f6e 6669 675f 7061 7468 2c20 2777  (config_path, 'w
-00006640: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
-00006650: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
-00006660: 2020 2020 2020 2020 2020 2066 2e77 7269             f.wri
-00006670: 7465 2827 272e 6a6f 696e 2863 6f6e 6669  te(''.join(confi
-00006680: 6729 2e73 7472 6970 2829 290a 2020 2020  g).strip()).    
-00006690: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
-000066a0: 6974 6528 275c 6e27 202a 2032 290a 0a20  ite('\n' * 2).. 
-000066b0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
-000066c0: 696e 636c 7564 6520 7374 6174 656d 656e  include statemen
-000066d0: 7420 6966 2069 7420 6578 6973 7473 2069  t if it exists i
-000066e0: 6e20 7468 6520 636f 6e66 6967 2e0a 2020  n the config..  
-000066f0: 2020 2020 2020 736b 795f 6175 746f 6765        sky_autoge
-00006700: 6e5f 636f 6d6d 656e 7420 3d20 2827 2320  n_comment = ('# 
-00006710: 4164 6465 6420 6279 2073 6b79 2028 7573  Added by sky (us
-00006720: 6520 6073 6b79 2073 746f 702f 646f 776e  e `sky stop/down
-00006730: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00006740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006750: 2020 6627 7b63 6c75 7374 6572 5f6e 616d    f'{cluster_nam
-00006760: 657d 6020 746f 2072 656d 6f76 6529 2729  e}` to remove)')
-00006770: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-00006780: 656e 2863 6f6e 6669 675f 7061 7468 2c20  en(config_path, 
-00006790: 2772 272c 2065 6e63 6f64 696e 673d 2775  'r', encoding='u
-000067a0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
-000067b0: 2020 2020 2020 2020 2063 6f6e 6669 6720           config 
-000067c0: 3d20 662e 7265 6164 6c69 6e65 7328 290a  = f.readlines().
-000067d0: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
-000067e0: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
-000067f0: 6528 636f 6e66 6967 293a 0a20 2020 2020  e(config):.     
-00006800: 2020 2020 2020 2063 6f6e 6669 675f 7374         config_st
-00006810: 7220 3d20 6c69 6e65 2e73 7472 6970 2829  r = line.strip()
-00006820: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006830: 6627 496e 636c 7564 6520 7b63 6c75 7374  f'Include {clust
-00006840: 6572 5f63 6f6e 6669 675f 7061 7468 7d27  er_config_path}'
-00006850: 2069 6e20 636f 6e66 6967 5f73 7472 3a0a   in config_str:.
-00006860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006870: 7769 7468 206f 7065 6e28 636f 6e66 6967  with open(config
-00006880: 5f70 6174 682c 2027 7727 2c20 656e 636f  _path, 'w', enco
-00006890: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
-000068a0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-000068b0: 2020 2020 2020 2020 6966 2069 203c 206c          if i < l
-000068c0: 656e 2863 6f6e 6669 6729 202d 2031 2061  en(config) - 1 a
-000068d0: 6e64 2063 6f6e 6669 675b 6920 2b20 315d  nd config[i + 1]
-000068e0: 203d 3d20 275c 6e27 3a0a 2020 2020 2020   == '\n':.      
-000068f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006900: 2020 6465 6c20 636f 6e66 6967 5b69 202b    del config[i +
-00006910: 2031 5d0a 2020 2020 2020 2020 2020 2020   1].            
-00006920: 2020 2020 2020 2020 2320 4465 6c65 7465          # Delete
-00006930: 2049 6e63 6c75 6465 2073 7472 696e 670a   Include string.
-00006940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006950: 2020 2020 6465 6c20 636f 6e66 6967 5b69      del config[i
-00006960: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00006970: 2020 2020 2020 2320 4465 6c65 7465 2053        # Delete S
-00006980: 6b79 2041 7574 6f67 656e 2043 6f6d 6d65  ky Autogen Comme
-00006990: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-000069a0: 2020 2020 2020 2069 6620 6920 3e20 3020         if i > 0 
-000069b0: 616e 6420 736b 795f 6175 746f 6765 6e5f  and sky_autogen_
-000069c0: 636f 6d6d 656e 7420 696e 2063 6f6e 6669  comment in confi
-000069d0: 675b 6920 2d20 315d 2e73 7472 6970 2829  g[i - 1].strip()
-000069e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000069f0: 2020 2020 2020 2020 2020 6465 6c20 636f            del co
-00006a00: 6e66 6967 5b69 202d 2031 5d0a 2020 2020  nfig[i - 1].    
-00006a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a20: 662e 7772 6974 6528 2727 2e6a 6f69 6e28  f.write(''.join(
-00006a30: 636f 6e66 6967 2929 0a20 2020 2020 2020  config)).       
-00006a40: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-00006a50: 2020 2020 2020 2020 2020 2069 6620 2748             if 'H
-00006a60: 6f73 7427 2069 6e20 636f 6e66 6967 5f73  ost' in config_s
-00006a70: 7472 3a0a 2020 2020 2020 2020 2020 2020  tr:.            
-00006a80: 2020 2020 6272 6561 6b0a 0a20 2020 2040      break..    @
-00006a90: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
-00006aa0: 2320 544f 444f 3a20 5765 2063 616e 2072  # TODO: We can r
-00006ab0: 656d 6f76 6520 7468 6973 2061 6674 6572  emove this after
-00006ac0: 2030 2e36 2e30 2061 6e64 2068 6176 6520   0.6.0 and have 
-00006ad0: 6120 6c6f 636b 206f 6e6c 7920 7065 7220  a lock only per 
-00006ae0: 636c 7573 7465 722e 0a20 2020 2040 7469  cluster..    @ti
-00006af0: 6d65 6c69 6e65 2e46 696c 654c 6f63 6b45  meline.FileLockE
-00006b00: 7665 6e74 2873 7368 5f63 6f6e 665f 6c6f  vent(ssh_conf_lo
-00006b10: 636b 5f70 6174 6829 0a20 2020 2064 6566  ck_path).    def
-00006b20: 2072 656d 6f76 655f 636c 7573 7465 7228   remove_cluster(
-00006b30: 0a20 2020 2020 2020 2063 6c73 2c0a 2020  .        cls,.  
-00006b40: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
-00006b50: 6d65 3a20 7374 722c 0a20 2020 2020 2020  me: str,.       
-00006b60: 2069 703a 2073 7472 2c0a 2020 2020 2020   ip: str,.      
-00006b70: 2020 6175 7468 5f63 6f6e 6669 673a 2044    auth_config: D
-00006b80: 6963 745b 7374 722c 2073 7472 5d2c 0a20  ict[str, str],. 
-00006b90: 2020 2020 2020 2064 6f63 6b65 725f 7573         docker_us
-00006ba0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-00006bb0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 293a  ] = None,.    ):
-00006bc0: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
-00006bd0: 7665 2061 7574 6865 6e74 6963 6174 696f  ve authenticatio
-00006be0: 6e20 696e 666f 726d 6174 696f 6e20 666f  n information fo
-00006bf0: 7220 636c 7573 7465 7220 6672 6f6d 207e  r cluster from ~
-00006c00: 2f2e 736b 792f 7373 682f 3c63 6c75 7374  /.sky/ssh/<clust
-00006c10: 6572 5f6e 616d 653e 2e0a 0a20 2020 2020  er_name>...     
-00006c20: 2020 2046 6f72 2062 6163 6b77 6172 6420     For backward 
-00006c30: 636f 6d70 6174 6962 696c 6974 7920 616c  compatibility al
-00006c40: 736f 2072 656d 6f76 6520 7468 6520 636f  so remove the co
-00006c50: 6e66 6967 2066 726f 6d20 7e2f 2e73 7368  nfig from ~/.ssh
-00006c60: 2f63 6f6e 6669 6720 6966 2069 7420 6578  /config if it ex
-00006c70: 6973 7473 2e0a 0a20 2020 2020 2020 2049  ists...        I
-00006c80: 6620 6e6f 2065 7869 7374 696e 6720 686f  f no existing ho
-00006c90: 7374 206d 6174 6368 696e 6720 7468 6520  st matching the 
-00006ca0: 7072 6f76 6964 6564 2073 7065 6369 6669  provided specifi
-00006cb0: 6361 7469 6f6e 2069 7320 666f 756e 642c  cation is found,
-00006cc0: 2074 6865 6e0a 2020 2020 2020 2020 6e6f   then.        no
-00006cd0: 7468 696e 6720 6973 2072 656d 6f76 6564  thing is removed
-00006ce0: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-00006cf0: 0a20 2020 2020 2020 2020 2020 2069 703a  .            ip:
-00006d00: 2048 6561 6420 6e6f 6465 2773 2049 5020   Head node's IP 
-00006d10: 6164 6472 6573 732e 0a20 2020 2020 2020  address..       
-00006d20: 2020 2020 2061 7574 685f 636f 6e66 6967       auth_config
-00006d30: 3a20 7265 6164 5f79 616d 6c28 6861 6e64  : read_yaml(hand
-00006d40: 6c65 2e63 6c75 7374 6572 5f79 616d 6c29  le.cluster_yaml)
-00006d50: 5b27 6175 7468 275d 0a20 2020 2020 2020  ['auth'].       
-00006d60: 2020 2020 2064 6f63 6b65 725f 7573 6572       docker_user
-00006d70: 3a20 4966 206e 6f74 204e 6f6e 652c 2075  : If not None, u
-00006d80: 7365 2074 6869 7320 7573 6572 2074 6f20  se this user to 
-00006d90: 7373 6820 696e 746f 2074 6865 2064 6f63  ssh into the doc
-00006da0: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
-00006db0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-00006dc0: 636f 6e66 6967 5f70 6174 6820 3d20 6f73  config_path = os
-00006dd0: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
-00006de0: 280a 2020 2020 2020 2020 2020 2020 636c  (.            cl
-00006df0: 732e 7373 685f 636c 7573 7465 725f 7061  s.ssh_cluster_pa
-00006e00: 7468 2e66 6f72 6d61 7428 636c 7573 7465  th.format(cluste
-00006e10: 725f 6e61 6d65 2929 0a20 2020 2020 2020  r_name)).       
-00006e20: 2063 6f6d 6d6f 6e5f 7574 696c 732e 7265   common_utils.re
-00006e30: 6d6f 7665 5f66 696c 655f 6966 5f65 7869  move_file_if_exi
-00006e40: 7374 7328 636c 7573 7465 725f 636f 6e66  sts(cluster_conf
-00006e50: 6967 5f70 6174 6829 0a0a 2020 2020 2020  ig_path)..      
-00006e60: 2020 2320 456e 7375 7265 7320 6261 636b    # Ensures back
-00006e70: 7761 7264 2063 6f6d 7061 7469 6269 6c69  ward compatibili
-00006e80: 7479 3a20 6265 666f 7265 2023 3237 3036  ty: before #2706
-00006e90: 2c20 7765 2077 726f 7465 2074 6865 2063  , we wrote the c
-00006ea0: 6f6e 6669 6720 6f66 2053 6b79 5069 6c6f  onfig of SkyPilo
-00006eb0: 7420 636c 7573 7465 7273 0a20 2020 2020  t clusters.     
-00006ec0: 2020 2023 2064 6972 6563 746c 7920 696e     # directly in
-00006ed0: 207e 2f2e 7373 682f 636f 6e66 6967 2e20   ~/.ssh/config. 
-00006ee0: 466f 7220 7468 6573 6520 636c 7573 7465  For these cluste
-00006ef0: 7273 2c20 7765 2073 686f 756c 6420 636c  rs, we should cl
-00006f00: 6561 6e20 7570 2074 6865 2063 6f6e 6669  ean up the confi
-00006f10: 672e 0a20 2020 2020 2020 2023 2054 4f44  g..        # TOD
-00006f20: 4f3a 2052 656d 6f76 6520 7468 6973 2061  O: Remove this a
-00006f30: 6674 6572 2030 2e36 2e30 0a20 2020 2020  fter 0.6.0.     
-00006f40: 2020 2063 6c73 2e5f 7265 6d6f 7665 5f73     cls._remove_s
-00006f50: 7461 6c65 5f63 6c75 7374 6572 5f63 6f6e  tale_cluster_con
-00006f60: 6669 675f 666f 725f 6261 636b 7761 7264  fig_for_backward
-00006f70: 5f63 6f6d 7061 7469 6269 6c69 7479 280a  _compatibility(.
-00006f80: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00006f90: 7465 725f 6e61 6d65 2c20 6970 2c20 6175  ter_name, ip, au
-00006fa0: 7468 5f63 6f6e 6669 672c 2064 6f63 6b65  th_config, docke
-00006fb0: 725f 7573 6572 290a 0a0a 6465 6620 5f72  r_user)...def _r
-00006fc0: 6570 6c61 6365 5f79 616d 6c5f 6469 6374  eplace_yaml_dict
-00006fd0: 7328 0a20 2020 2020 2020 206e 6577 5f79  s(.        new_y
-00006fe0: 616d 6c3a 2073 7472 2c20 6f6c 645f 7961  aml: str, old_ya
-00006ff0: 6d6c 3a20 7374 722c 2072 6573 746f 7265  ml: str, restore
-00007000: 5f6b 6579 5f6e 616d 6573 3a20 5365 745b  _key_names: Set[
-00007010: 7374 725d 2c0a 2020 2020 2020 2020 7265  str],.        re
-00007020: 7374 6f72 655f 6b65 795f 6e61 6d65 735f  store_key_names_
-00007030: 6578 6365 7074 696f 6e73 3a20 5365 7175  exceptions: Sequ
-00007040: 656e 6365 5b54 7570 6c65 5b73 7472 2c20  ence[Tuple[str, 
-00007050: 2e2e 2e5d 5d29 202d 3e20 7374 723a 0a20  ...]]) -> str:. 
-00007060: 2020 2022 2222 5265 706c 6163 6573 2027     """Replaces '
-00007070: 6e65 7727 2077 6974 6820 276f 6c64 2720  new' with 'old' 
-00007080: 666f 7220 616c 6c20 6b65 7973 2069 6e20  for all keys in 
-00007090: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
-000070a0: 732e 0a0a 2020 2020 5468 6520 7265 706c  s...    The repl
-000070b0: 6163 656d 656e 7420 7769 6c6c 2062 6520  acement will be 
-000070c0: 6170 706c 6965 6420 7265 6375 7273 6976  applied recursiv
-000070d0: 656c 7920 616e 6420 6f6e 6c79 2066 6f72  ely and only for
-000070e0: 2074 6865 2062 6c6f 636b 730a 2020 2020   the blocks.    
-000070f0: 7769 7468 2074 6865 206b 6579 2069 6e20  with the key in 
-00007100: 6b65 795f 6e61 6d65 732c 2061 6e64 2068  key_names, and h
-00007110: 6176 6520 7468 6520 7361 6d65 2061 6e63  ave the same anc
-00007120: 6573 746f 7273 2069 6e20 626f 7468 2027  estors in both '
-00007130: 6e65 7727 0a20 2020 2061 6e64 2027 6f6c  new'.    and 'ol
-00007140: 6427 2059 414d 4c20 7472 6565 2e0a 0a20  d' YAML tree... 
-00007150: 2020 2054 6865 2072 6573 746f 7265 5f6b     The restore_k
-00007160: 6579 5f6e 616d 6573 5f65 7863 6570 7469  ey_names_excepti
-00007170: 6f6e 7320 6973 2061 206c 6973 7420 6f66  ons is a list of
-00007180: 206b 6579 206e 616d 6573 2074 6861 7420   key names that 
-00007190: 7368 6f75 6c64 206e 6f74 0a20 2020 2062  should not.    b
-000071a0: 6520 7265 7374 6f72 6564 2c20 692e 652e  e restored, i.e.
-000071b0: 2074 686f 7365 206b 6579 7320 7769 6c6c   those keys will
-000071c0: 2062 6520 7265 7365 7420 746f 2074 6865   be reset to the
-000071d0: 2076 616c 7565 2069 6e20 276e 6577 2720   value in 'new' 
-000071e0: 5941 4d4c 0a20 2020 2074 7265 6520 6166  YAML.    tree af
-000071f0: 7465 7220 7468 6520 7265 706c 6163 656d  ter the replacem
-00007200: 656e 742e 0a20 2020 2022 2222 0a0a 2020  ent..    """..  
-00007210: 2020 6465 6620 5f72 6573 746f 7265 5f62    def _restore_b
-00007220: 6c6f 636b 286e 6577 5f62 6c6f 636b 3a20  lock(new_block: 
-00007230: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
-00007240: 6f6c 645f 626c 6f63 6b3a 2044 6963 745b  old_block: Dict[
-00007250: 7374 722c 2041 6e79 5d29 3a0a 2020 2020  str, Any]):.    
-00007260: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
-00007270: 7565 2069 6e20 6e65 775f 626c 6f63 6b2e  ue in new_block.
-00007280: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00007290: 2020 2020 2069 6620 6b65 7920 696e 2072       if key in r
-000072a0: 6573 746f 7265 5f6b 6579 5f6e 616d 6573  estore_key_names
-000072b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000072c0: 2020 6966 206b 6579 2069 6e20 6f6c 645f    if key in old_
-000072d0: 626c 6f63 6b3a 0a20 2020 2020 2020 2020  block:.         
-000072e0: 2020 2020 2020 2020 2020 206e 6577 5f62             new_b
-000072f0: 6c6f 636b 5b6b 6579 5d20 3d20 6f6c 645f  lock[key] = old_
-00007300: 626c 6f63 6b5b 6b65 795d 0a20 2020 2020  block[key].     
-00007310: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00007320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007330: 2020 2020 2064 656c 206e 6577 5f62 6c6f       del new_blo
-00007340: 636b 5b6b 6579 5d0a 2020 2020 2020 2020  ck[key].        
-00007350: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00007360: 6e63 6528 7661 6c75 652c 2064 6963 7429  nce(value, dict)
-00007370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007380: 2020 6966 206b 6579 2069 6e20 6f6c 645f    if key in old_
-00007390: 626c 6f63 6b3a 0a20 2020 2020 2020 2020  block:.         
-000073a0: 2020 2020 2020 2020 2020 205f 7265 7374             _rest
-000073b0: 6f72 655f 626c 6f63 6b28 7661 6c75 652c  ore_block(value,
-000073c0: 206f 6c64 5f62 6c6f 636b 5b6b 6579 5d29   old_block[key])
-000073d0: 0a0a 2020 2020 6e65 775f 636f 6e66 6967  ..    new_config
-000073e0: 203d 2079 616d 6c2e 7361 6665 5f6c 6f61   = yaml.safe_loa
-000073f0: 6428 6e65 775f 7961 6d6c 290a 2020 2020  d(new_yaml).    
-00007400: 6f6c 645f 636f 6e66 6967 203d 2079 616d  old_config = yam
-00007410: 6c2e 7361 6665 5f6c 6f61 6428 6f6c 645f  l.safe_load(old_
-00007420: 7961 6d6c 290a 2020 2020 6578 636c 7564  yaml).    exclud
-00007430: 6564 5f72 6573 756c 7473 203d 207b 7d0a  ed_results = {}.
-00007440: 2020 2020 2320 4669 6e64 2061 6c6c 206b      # Find all k
-00007450: 6579 2076 616c 7565 7320 6578 636c 7564  ey values exclud
-00007460: 6564 2066 726f 6d20 7265 7374 6f72 650a  ed from restore.
-00007470: 2020 2020 666f 7220 6578 636c 7564 655f      for exclude_
-00007480: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
-00007490: 5f6c 6973 7420 696e 2072 6573 746f 7265  _list in restore
-000074a0: 5f6b 6579 5f6e 616d 6573 5f65 7863 6570  _key_names_excep
-000074b0: 7469 6f6e 733a 0a20 2020 2020 2020 2065  tions:.        e
-000074c0: 7863 6c75 6465 645f 7265 7375 6c74 203d  xcluded_result =
-000074d0: 206e 6577 5f63 6f6e 6669 670a 2020 2020   new_config.    
-000074e0: 2020 2020 666f 756e 645f 6578 636c 7564      found_exclud
-000074f0: 6564 5f6b 6579 203d 2054 7275 650a 2020  ed_key = True.  
-00007500: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-00007510: 2065 7863 6c75 6465 5f72 6573 746f 7265   exclude_restore
-00007520: 5f6b 6579 5f6e 616d 655f 6c69 7374 3a0a  _key_name_list:.
-00007530: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00007540: 6e6f 7420 6973 696e 7374 616e 6365 2865  not isinstance(e
-00007550: 7863 6c75 6465 645f 7265 7375 6c74 2c20  xcluded_result, 
-00007560: 6469 6374 2920 6f72 0a20 2020 2020 2020  dict) or.       
-00007570: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00007580: 206e 6f74 2069 6e20 6578 636c 7564 6564   not in excluded
-00007590: 5f72 6573 756c 7429 3a0a 2020 2020 2020  _result):.      
-000075a0: 2020 2020 2020 2020 2020 666f 756e 645f            found_
-000075b0: 6578 636c 7564 6564 5f6b 6579 203d 2046  excluded_key = F
-000075c0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-000075d0: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-000075e0: 2020 2020 2020 2065 7863 6c75 6465 645f         excluded_
-000075f0: 7265 7375 6c74 203d 2065 7863 6c75 6465  result = exclude
-00007600: 645f 7265 7375 6c74 5b6b 6579 5d0a 2020  d_result[key].  
-00007610: 2020 2020 2020 6966 2066 6f75 6e64 5f65        if found_e
-00007620: 7863 6c75 6465 645f 6b65 793a 0a20 2020  xcluded_key:.   
-00007630: 2020 2020 2020 2020 2065 7863 6c75 6465           exclude
-00007640: 645f 7265 7375 6c74 735b 6578 636c 7564  d_results[exclud
-00007650: 655f 7265 7374 6f72 655f 6b65 795f 6e61  e_restore_key_na
-00007660: 6d65 5f6c 6973 745d 203d 2065 7863 6c75  me_list] = exclu
-00007670: 6465 645f 7265 7375 6c74 0a0a 2020 2020  ded_result..    
-00007680: 2320 5265 7374 6f72 6520 6672 6f6d 206f  # Restore from o
-00007690: 6c64 2063 6f6e 6669 670a 2020 2020 5f72  ld config.    _r
-000076a0: 6573 746f 7265 5f62 6c6f 636b 286e 6577  estore_block(new
-000076b0: 5f63 6f6e 6669 672c 206f 6c64 5f63 6f6e  _config, old_con
-000076c0: 6669 6729 0a0a 2020 2020 2320 5265 7665  fig)..    # Reve
-000076d0: 7274 2074 6865 2063 6861 6e67 6573 2066  rt the changes f
-000076e0: 6f72 2074 6865 2065 7863 6c75 6465 6420  or the excluded 
-000076f0: 6b65 7920 7661 6c75 6573 0a20 2020 2066  key values.    f
-00007700: 6f72 2065 7863 6c75 6465 5f72 6573 746f  or exclude_resto
-00007710: 7265 5f6b 6579 5f6e 616d 652c 2076 616c  re_key_name, val
-00007720: 7565 2069 6e20 6578 636c 7564 6564 5f72  ue in excluded_r
-00007730: 6573 756c 7473 2e69 7465 6d73 2829 3a0a  esults.items():.
-00007740: 2020 2020 2020 2020 6375 7272 203d 206e          curr = n
-00007750: 6577 5f63 6f6e 6669 670a 2020 2020 2020  ew_config.      
-00007760: 2020 666f 7220 6b65 7920 696e 2065 7863    for key in exc
-00007770: 6c75 6465 5f72 6573 746f 7265 5f6b 6579  lude_restore_key
-00007780: 5f6e 616d 655b 3a2d 315d 3a0a 2020 2020  _name[:-1]:.    
-00007790: 2020 2020 2020 2020 6375 7272 203d 2063          curr = c
-000077a0: 7572 725b 6b65 795d 0a20 2020 2020 2020  urr[key].       
-000077b0: 2063 7572 725b 6578 636c 7564 655f 7265   curr[exclude_re
-000077c0: 7374 6f72 655f 6b65 795f 6e61 6d65 5b2d  store_key_name[-
-000077d0: 315d 5d20 3d20 7661 6c75 650a 2020 2020  1]] = value.    
-000077e0: 7265 7475 726e 2063 6f6d 6d6f 6e5f 7574  return common_ut
-000077f0: 696c 732e 6475 6d70 5f79 616d 6c5f 7374  ils.dump_yaml_st
-00007800: 7228 6e65 775f 636f 6e66 6967 290a 0a0a  r(new_config)...
-00007810: 2320 544f 444f 3a20 746f 6f20 6d61 6e79  # TODO: too many
-00007820: 2074 6869 6e67 7320 6861 7070 656e 696e   things happenin
-00007830: 6720 6865 7265 202d 206c 6561 6b79 2061  g here - leaky a
-00007840: 6273 7472 6163 7469 6f6e 2e20 5265 6661  bstraction. Refa
-00007850: 6374 6f72 2e0a 4074 696d 656c 696e 652e  ctor..@timeline.
-00007860: 6576 656e 740a 6465 6620 7772 6974 655f  event.def write_
-00007870: 636c 7573 7465 725f 636f 6e66 6967 280a  cluster_config(.
-00007880: 2020 2020 2020 2020 746f 5f70 726f 7669          to_provi
-00007890: 7369 6f6e 3a20 2772 6573 6f75 7263 6573  sion: 'resources
-000078a0: 2e52 6573 6f75 7263 6573 272c 0a20 2020  .Resources',.   
-000078b0: 2020 2020 206e 756d 5f6e 6f64 6573 3a20       num_nodes: 
-000078c0: 696e 742c 0a20 2020 2020 2020 2063 6c75  int,.        clu
-000078d0: 7374 6572 5f63 6f6e 6669 675f 7465 6d70  ster_config_temp
-000078e0: 6c61 7465 3a20 7374 722c 0a20 2020 2020  late: str,.     
-000078f0: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
-00007900: 2073 7472 2c0a 2020 2020 2020 2020 6c6f   str,.        lo
-00007910: 6361 6c5f 7768 6565 6c5f 7061 7468 3a20  cal_wheel_path: 
-00007920: 7061 7468 6c69 622e 5061 7468 2c0a 2020  pathlib.Path,.  
-00007930: 2020 2020 2020 7768 6565 6c5f 6861 7368        wheel_hash
-00007940: 3a20 7374 722c 0a20 2020 2020 2020 2072  : str,.        r
-00007950: 6567 696f 6e3a 2063 6c6f 7564 732e 5265  egion: clouds.Re
-00007960: 6769 6f6e 2c0a 2020 2020 2020 2020 7a6f  gion,.        zo
-00007970: 6e65 733a 204f 7074 696f 6e61 6c5b 4c69  nes: Optional[Li
-00007980: 7374 5b63 6c6f 7564 732e 5a6f 6e65 5d5d  st[clouds.Zone]]
-00007990: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000079a0: 2064 7279 7275 6e3a 2062 6f6f 6c20 3d20   dryrun: bool = 
-000079b0: 4661 6c73 652c 0a20 2020 2020 2020 206b  False,.        k
-000079c0: 6565 705f 6c61 756e 6368 5f66 6965 6c64  eep_launch_field
-000079d0: 735f 696e 5f65 7869 7374 696e 675f 636f  s_in_existing_co
-000079e0: 6e66 6967 3a20 626f 6f6c 203d 2054 7275  nfig: bool = Tru
-000079f0: 6529 202d 3e20 4469 6374 5b73 7472 2c20  e) -> Dict[str, 
-00007a00: 7374 725d 3a0a 2020 2020 2222 2246 696c  str]:.    """Fil
-00007a10: 6c73 2069 6e20 636c 7573 7465 7220 636f  ls in cluster co
-00007a20: 6e66 6967 7572 6174 696f 6e20 7465 6d70  nfiguration temp
-00007a30: 6c61 7465 7320 616e 6420 7772 6974 6573  lates and writes
-00007a40: 2074 6865 6d20 6f75 742e 0a0a 2020 2020   them out...    
-00007a50: 5265 7475 726e 733a 207b 7072 6f76 6973  Returns: {provis
-00007a60: 696f 6e65 723a 2070 6174 6820 746f 2079  ioner: path to y
-00007a70: 616d 6c2c 2074 6865 2070 726f 7669 7369  aml, the provisi
-00007a80: 6f6e 696e 6720 7370 6563 7d2e 0a20 2020  oning spec}..   
-00007a90: 2020 2027 7072 6f76 6973 696f 6e65 7227     'provisioner'
-00007aa0: 2063 616e 2062 650a 2020 2020 2020 2020   can be.        
-00007ab0: 2d20 2772 6179 270a 2020 2020 2020 2020  - 'ray'.        
-00007ac0: 2d20 2774 7075 2d63 7265 6174 652d 7363  - 'tpu-create-sc
-00007ad0: 7269 7074 2720 2869 6620 5450 5520 6973  ript' (if TPU is
-00007ae0: 2072 6571 7565 7374 6564 290a 2020 2020   requested).    
-00007af0: 2020 2020 2d20 2774 7075 2d64 656c 6574      - 'tpu-delet
-00007b00: 652d 7363 7269 7074 2720 2869 6620 5450  e-script' (if TP
-00007b10: 5520 6973 2072 6571 7565 7374 6564 290a  U is requested).
-00007b20: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-00007b30: 2020 2020 6578 6365 7074 696f 6e73 2e52      exceptions.R
-00007b40: 6573 6f75 7263 6573 556e 6176 6169 6c61  esourcesUnavaila
-00007b50: 626c 6545 7272 6f72 3a20 6966 2074 6865  bleError: if the
-00007b60: 2072 6567 696f 6e2f 7a6f 6e65 7320 7265   region/zones re
-00007b70: 7175 6573 7465 6420 646f 6573 0a20 2020  quested does.   
-00007b80: 2020 2020 2020 2020 206e 6f74 2061 7070           not app
-00007b90: 6561 7220 696e 2074 6865 2063 6174 616c  ear in the catal
-00007ba0: 6f67 2c20 6f72 2061 6e20 7373 685f 7072  og, or an ssh_pr
-00007bb0: 6f78 795f 636f 6d6d 616e 6420 6973 2073  oxy_command is s
-00007bc0: 7065 6369 6669 6564 2062 7574 0a20 2020  pecified but.   
-00007bd0: 2020 2020 2020 2020 206e 6f74 2066 6f72           not for
-00007be0: 2074 6865 2067 6976 656e 2072 6567 696f   the given regio
-00007bf0: 6e2c 206f 7220 4750 5573 2061 7265 2072  n, or GPUs are r
-00007c00: 6571 7565 7374 6564 2069 6e20 6120 4b75  equested in a Ku
-00007c10: 6265 726e 6574 6573 0a20 2020 2020 2020  bernetes.       
-00007c20: 2020 2020 2063 6c75 7374 6572 2062 7574       cluster but
-00007c30: 2074 6865 2063 6c75 7374 6572 2064 6f65   the cluster doe
-00007c40: 7320 6e6f 7420 6861 7665 206e 6f64 6573  s not have nodes
-00007c50: 206c 6162 656c 6564 2077 6974 6820 4750   labeled with GP
-00007c60: 5520 7479 7065 732e 0a20 2020 2020 2020  U types..       
-00007c70: 2065 7863 6570 7469 6f6e 732e 496e 7661   exceptions.Inva
-00007c80: 6c69 6443 6c6f 7564 436f 6e66 6967 733a  lidCloudConfigs:
-00007c90: 2069 6620 7468 6520 7573 6572 2073 7065   if the user spe
-00007ca0: 6369 6669 6573 2073 6f6d 6520 636f 6e66  cifies some conf
-00007cb0: 6967 2066 6f72 2074 6865 0a20 2020 2020  ig for the.     
-00007cc0: 2020 2020 2020 2063 6c6f 7564 2074 6861         cloud tha
-00007cd0: 7420 6973 206e 6f74 2076 616c 6964 2c20  t is not valid, 
-00007ce0: 652e 672e 2072 656d 6f74 655f 6964 656e  e.g. remote_iden
-00007cf0: 7469 7479 3a20 5345 5256 4943 455f 4143  tity: SERVICE_AC
-00007d00: 434f 554e 540a 2020 2020 2020 2020 2020  COUNT.          
-00007d10: 2020 666f 7220 6120 636c 6f75 6420 7468    for a cloud th
-00007d20: 6174 2064 6f65 7320 6e6f 7420 7375 7070  at does not supp
-00007d30: 6f72 7420 6974 2c20 7468 6520 6361 6c6c  ort it, the call
-00007d40: 6572 2073 686f 756c 6420 736b 6970 2074  er should skip t
-00007d50: 6865 0a20 2020 2020 2020 2020 2020 2063  he.            c
-00007d60: 6c6f 7564 2069 6e20 7468 6973 2063 6173  loud in this cas
-00007d70: 652e 0a20 2020 2022 2222 0a20 2020 2023  e..    """.    #
-00007d80: 2074 6173 6b2e 6265 7374 5f72 6573 6f75   task.best_resou
-00007d90: 7263 6573 206d 6179 206e 6f74 2062 6520  rces may not be 
-00007da0: 6571 7561 6c20 746f 2074 6f5f 7072 6f76  equal to to_prov
-00007db0: 6973 696f 6e20 6966 2074 6865 2075 7365  ision if the use
-00007dc0: 720a 2020 2020 2320 6973 2072 756e 6e69  r.    # is runni
-00007dd0: 6e67 2061 206a 6f62 2077 6974 6820 6c65  ng a job with le
-00007de0: 7373 2072 6573 6f75 7263 6573 2074 6861  ss resources tha
-00007df0: 6e20 7468 6520 636c 7573 7465 7220 6861  n the cluster ha
-00007e00: 732e 0a20 2020 2063 6c6f 7564 203d 2074  s..    cloud = t
-00007e10: 6f5f 7072 6f76 6973 696f 6e2e 636c 6f75  o_provision.clou
-00007e20: 640a 2020 2020 6173 7365 7274 2063 6c6f  d.    assert clo
-00007e30: 7564 2069 7320 6e6f 7420 4e6f 6e65 2c20  ud is not None, 
-00007e40: 746f 5f70 726f 7669 7369 6f6e 0a0a 2020  to_provision..  
-00007e50: 2020 636c 7573 7465 725f 6e61 6d65 5f6f    cluster_name_o
-00007e60: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-00007e70: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-00007e80: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-00007e90: 6428 0a20 2020 2020 2020 2063 6c75 7374  d(.        clust
-00007ea0: 6572 5f6e 616d 652c 206d 6178 5f6c 656e  er_name, max_len
-00007eb0: 6774 683d 636c 6f75 642e 6d61 785f 636c  gth=cloud.max_cl
-00007ec0: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
-00007ed0: 6828 2929 0a0a 2020 2020 2320 5468 6973  h())..    # This
-00007ee0: 2063 616e 2072 6169 7365 2061 2052 6573   can raise a Res
-00007ef0: 6f75 7263 6573 556e 6176 6169 6c61 626c  ourcesUnavailabl
-00007f00: 6545 7272 6f72 2077 6865 6e3a 0a20 2020  eError when:.   
-00007f10: 2023 2020 2a20 5468 6520 7265 6769 6f6e   #  * The region
-00007f20: 2f7a 6f6e 6573 2072 6571 7565 7374 6564  /zones requested
-00007f30: 2064 6f65 7320 6e6f 7420 6170 7065 6172   does not appear
-00007f40: 2069 6e20 7468 6520 6361 7461 6c6f 672e   in the catalog.
-00007f50: 2049 7420 6361 6e20 6265 0a20 2020 2023   It can be.    #
-00007f60: 2020 2020 7472 6967 6765 7265 6420 6966      triggered if
-00007f70: 2074 6865 2075 7365 7220 6368 616e 6765   the user change
-00007f80: 6420 7468 6520 6361 7461 6c6f 6720 6669  d the catalog fi
-00007f90: 6c65 2077 6869 6c65 2074 6865 7265 2069  le while there i
-00007fa0: 7320 6120 636c 7573 7465 720a 2020 2020  s a cluster.    
-00007fb0: 2320 2020 2069 6e20 7468 6520 7265 6d6f  #    in the remo
-00007fc0: 7665 6420 7265 6769 6f6e 2f7a 6f6e 652e  ved region/zone.
-00007fd0: 0a20 2020 2023 2020 2a20 4750 5573 2061  .    #  * GPUs a
-00007fe0: 7265 2072 6571 7565 7374 6564 2069 6e20  re requested in 
-00007ff0: 6120 4b75 6265 726e 6574 6573 2063 6c75  a Kubernetes clu
-00008000: 7374 6572 2062 7574 2074 6865 2063 6c75  ster but the clu
-00008010: 7374 6572 2064 6f65 7320 6e6f 740a 2020  ster does not.  
-00008020: 2020 2320 2020 2068 6176 6520 6e6f 6465    #    have node
-00008030: 7320 6c61 6265 6c65 6420 7769 7468 2047  s labeled with G
-00008040: 5055 2074 7970 6573 2e0a 2020 2020 230a  PU types..    #.
-00008050: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-00008060: 3a20 5765 2073 686f 756c 6420 6368 616e  : We should chan
-00008070: 6765 2074 6865 2065 7863 6570 7469 6f6e  ge the exception
-00008080: 2074 7970 6520 746f 2061 206d 6f72 6520   type to a more 
-00008090: 7370 6563 6966 6963 206f 6e65 2c20 6173  specific one, as
-000080a0: 0a20 2020 2023 2074 6865 2052 6573 6f75  .    # the Resou
-000080b0: 7263 6573 556e 6176 6169 6c61 626c 6545  rcesUnavailableE
-000080c0: 7272 6f72 2069 7320 6f76 6572 6c79 2075  rror is overly u
-000080d0: 7365 642e 2041 6c73 6f2c 2069 7420 776f  sed. Also, it wo
-000080e0: 756c 6420 6265 2062 6574 7465 7220 746f  uld be better to
-000080f0: 0a20 2020 2023 206d 6f76 6520 7468 6520  .    # move the 
-00008100: 6368 6563 6b20 6f75 7420 6f66 2074 6869  check out of thi
-00008110: 7320 6675 6e63 7469 6f6e 2c20 692e 652e  s function, i.e.
-00008120: 2074 6865 2063 616c 6c65 7220 7368 6f75   the caller shou
-00008130: 6c64 2062 6520 7265 7370 6f6e 7369 626c  ld be responsibl
-00008140: 650a 2020 2020 2320 666f 7220 7468 6520  e.    # for the 
-00008150: 7661 6c69 6461 7469 6f6e 2e0a 2020 2020  validation..    
-00008160: 2320 544f 444f 2874 6961 6e29 3a20 4d6f  # TODO(tian): Mo
-00008170: 7665 206d 6f72 6520 636c 6f75 6420 6167  ve more cloud ag
-00008180: 6e6f 7374 6963 2076 6172 7320 746f 2072  nostic vars to r
-00008190: 6573 6f75 7263 6573 2e70 792e 0a20 2020  esources.py..   
-000081a0: 2072 6573 6f75 7263 6573 5f76 6172 7320   resources_vars 
-000081b0: 3d20 746f 5f70 726f 7669 7369 6f6e 2e6d  = to_provision.m
-000081c0: 616b 655f 6465 706c 6f79 5f76 6172 6961  ake_deploy_varia
-000081d0: 626c 6573 2863 6c75 7374 6572 5f6e 616d  bles(cluster_nam
-000081e0: 655f 6f6e 5f63 6c6f 7564 2c0a 2020 2020  e_on_cloud,.    
-000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006210: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006220: 6f75 6e64 203d 2054 7275 650a 2020 2020  ound = True.    
+00006230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006240: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00006250: 6b0a 2020 2020 2020 2020 2020 2020 6966  k.            if
+00006260: 2066 6f75 6e64 3a0a 2020 2020 2020 2020   found:.        
+00006270: 2020 2020 2020 2020 7374 6172 745f 6c69          start_li
+00006280: 6e65 5f69 6478 203d 2069 202d 2031 0a20  ne_idx = i - 1. 
+00006290: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000062a0: 7265 616b 0a0a 2020 2020 2020 2020 6966  reak..        if
+000062b0: 2073 7461 7274 5f6c 696e 655f 6964 7820   start_line_idx 
+000062c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000062d0: 2020 2020 2020 2020 2023 2053 6361 6e20           # Scan 
+000062e0: 666f 7220 656e 6420 6f66 2070 7265 7669  for end of previ
+000062f0: 6f75 7320 636f 6e66 6967 2e0a 2020 2020  ous config..    
+00006300: 2020 2020 2020 2020 6375 7273 6f72 203d          cursor =
+00006310: 2073 7461 7274 5f6c 696e 655f 6964 780a   start_line_idx.
+00006320: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00006330: 6520 6375 7273 6f72 203e 2030 2061 6e64  e cursor > 0 and
+00006340: 206c 656e 2863 6f6e 6669 675b 6375 7273   len(config[curs
+00006350: 6f72 5d2e 7374 7269 7028 2929 203e 2030  or].strip()) > 0
+00006360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006370: 2020 6375 7273 6f72 202d 3d20 310a 2020    cursor -= 1.  
+00006380: 2020 2020 2020 2020 2020 7072 6576 5f65            prev_e
+00006390: 6e64 5f6c 696e 655f 6964 7820 3d20 6375  nd_line_idx = cu
+000063a0: 7273 6f72 0a0a 2020 2020 2020 2020 2020  rsor..          
+000063b0: 2020 2320 5363 616e 2066 6f72 2065 6e64    # Scan for end
+000063c0: 206f 6620 7468 6520 636c 7573 7465 7220   of the cluster 
+000063d0: 636f 6e66 6967 2e0a 2020 2020 2020 2020  config..        
+000063e0: 2020 2020 656e 645f 6c69 6e65 5f69 6478      end_line_idx
+000063f0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00006400: 2020 2020 6375 7273 6f72 203d 2073 7461      cursor = sta
+00006410: 7274 5f6c 696e 655f 6964 7820 2b20 310a  rt_line_idx + 1.
+00006420: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00006430: 745f 6c69 6e65 5f69 6478 202d 3d20 3120  t_line_idx -= 1 
+00006440: 2023 2072 656d 6f76 6520 6175 746f 2d67   # remove auto-g
+00006450: 656e 6572 6174 6564 2063 6f6d 6d65 6e74  enerated comment
+00006460: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+00006470: 6c65 2063 7572 736f 7220 3c20 6c65 6e28  le cursor < len(
+00006480: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00006490: 2020 2020 2020 2020 2069 6620 636f 6e66           if conf
+000064a0: 6967 5b63 7572 736f 725d 2e73 7472 6970  ig[cursor].strip
+000064b0: 2829 2e73 7461 7274 7377 6974 6828 0a20  ().startswith(. 
+000064c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064d0: 2020 2020 2020 2027 2320 2729 206f 7220         '# ') or 
+000064e0: 636f 6e66 6967 5b63 7572 736f 725d 2e73  config[cursor].s
+000064f0: 7472 6970 2829 2e73 7461 7274 7377 6974  trip().startswit
+00006500: 6828 2748 6f73 7420 2729 3a0a 2020 2020  h('Host '):.    
+00006510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006520: 656e 645f 6c69 6e65 5f69 6478 203d 2063  end_line_idx = c
+00006530: 7572 736f 720a 2020 2020 2020 2020 2020  ursor.          
+00006540: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006560: 6375 7273 6f72 202b 3d20 310a 0a20 2020  cursor += 1..   
+00006570: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
+00006580: 6520 736b 792d 6765 6e65 7261 7465 6420  e sky-generated 
+00006590: 636f 6e66 6967 2061 6e64 2075 7064 6174  config and updat
+000065a0: 6520 7468 6520 6669 6c65 2e0a 2020 2020  e the file..    
+000065b0: 2020 2020 2020 2020 636f 6e66 6967 5b70          config[p
+000065c0: 7265 765f 656e 645f 6c69 6e65 5f69 6478  rev_end_line_idx
+000065d0: 3a65 6e64 5f6c 696e 655f 6964 785d 203d  :end_line_idx] =
+000065e0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+000065f0: 2020 2027 5c6e 270a 2020 2020 2020 2020     '\n'.        
+00006600: 2020 2020 5d20 6966 2065 6e64 5f6c 696e      ] if end_lin
+00006610: 655f 6964 7820 6973 206e 6f74 204e 6f6e  e_idx is not Non
+00006620: 6520 656c 7365 205b 5d0a 2020 2020 2020  e else [].      
+00006630: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+00006640: 636f 6e66 6967 5f70 6174 682c 2027 7727  config_path, 'w'
+00006650: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+00006660: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+00006670: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
+00006680: 6528 2727 2e6a 6f69 6e28 636f 6e66 6967  e(''.join(config
+00006690: 292e 7374 7269 7028 2929 0a20 2020 2020  ).strip()).     
+000066a0: 2020 2020 2020 2020 2020 2066 2e77 7269             f.wri
+000066b0: 7465 2827 5c6e 2720 2a20 3229 0a0a 2020  te('\n' * 2)..  
+000066c0: 2020 2020 2020 2320 4465 6c65 7465 2069        # Delete i
+000066d0: 6e63 6c75 6465 2073 7461 7465 6d65 6e74  nclude statement
+000066e0: 2069 6620 6974 2065 7869 7374 7320 696e   if it exists in
+000066f0: 2074 6865 2063 6f6e 6669 672e 0a20 2020   the config..   
+00006700: 2020 2020 2073 6b79 5f61 7574 6f67 656e       sky_autogen
+00006710: 5f63 6f6d 6d65 6e74 203d 2028 2723 2041  _comment = ('# A
+00006720: 6464 6564 2062 7920 736b 7920 2875 7365  dded by sky (use
+00006730: 2060 736b 7920 7374 6f70 2f64 6f77 6e20   `sky stop/down 
+00006740: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00006750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006760: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
+00006770: 7d60 2074 6f20 7265 6d6f 7665 2927 290a  }` to remove)').
+00006780: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00006790: 6e28 636f 6e66 6967 5f70 6174 682c 2027  n(config_path, '
+000067a0: 7227 2c20 656e 636f 6469 6e67 3d27 7574  r', encoding='ut
+000067b0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+000067c0: 2020 2020 2020 2020 636f 6e66 6967 203d          config =
+000067d0: 2066 2e72 6561 646c 696e 6573 2829 0a0a   f.readlines()..
+000067e0: 2020 2020 2020 2020 666f 7220 692c 206c          for i, l
+000067f0: 696e 6520 696e 2065 6e75 6d65 7261 7465  ine in enumerate
+00006800: 2863 6f6e 6669 6729 3a0a 2020 2020 2020  (config):.      
+00006810: 2020 2020 2020 636f 6e66 6967 5f73 7472        config_str
+00006820: 203d 206c 696e 652e 7374 7269 7028 290a   = line.strip().
+00006830: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00006840: 2749 6e63 6c75 6465 207b 636c 7573 7465  'Include {cluste
+00006850: 725f 636f 6e66 6967 5f70 6174 687d 2720  r_config_path}' 
+00006860: 696e 2063 6f6e 6669 675f 7374 723a 0a20  in config_str:. 
+00006870: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00006880: 6974 6820 6f70 656e 2863 6f6e 6669 675f  ith open(config_
+00006890: 7061 7468 2c20 2777 272c 2065 6e63 6f64  path, 'w', encod
+000068a0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+000068b0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+000068c0: 2020 2020 2020 2069 6620 6920 3c20 6c65         if i < le
+000068d0: 6e28 636f 6e66 6967 2920 2d20 3120 616e  n(config) - 1 an
+000068e0: 6420 636f 6e66 6967 5b69 202b 2031 5d20  d config[i + 1] 
+000068f0: 3d3d 2027 5c6e 273a 0a20 2020 2020 2020  == '\n':.       
+00006900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006910: 2064 656c 2063 6f6e 6669 675b 6920 2b20   del config[i + 
+00006920: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+00006930: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
+00006940: 496e 636c 7564 6520 7374 7269 6e67 0a20  Include string. 
+00006950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006960: 2020 2064 656c 2063 6f6e 6669 675b 695d     del config[i]
+00006970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006980: 2020 2020 2023 2044 656c 6574 6520 536b       # Delete Sk
+00006990: 7920 4175 746f 6765 6e20 436f 6d6d 656e  y Autogen Commen
+000069a0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+000069b0: 2020 2020 2020 6966 2069 203e 2030 2061        if i > 0 a
+000069c0: 6e64 2073 6b79 5f61 7574 6f67 656e 5f63  nd sky_autogen_c
+000069d0: 6f6d 6d65 6e74 2069 6e20 636f 6e66 6967  omment in config
+000069e0: 5b69 202d 2031 5d2e 7374 7269 7028 293a  [i - 1].strip():
+000069f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a00: 2020 2020 2020 2020 2064 656c 2063 6f6e           del con
+00006a10: 6669 675b 6920 2d20 315d 0a20 2020 2020  fig[i - 1].     
+00006a20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006a30: 2e77 7269 7465 2827 272e 6a6f 696e 2863  .write(''.join(c
+00006a40: 6f6e 6669 6729 290a 2020 2020 2020 2020  onfig)).        
+00006a50: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00006a60: 2020 2020 2020 2020 2020 6966 2027 486f            if 'Ho
+00006a70: 7374 2720 696e 2063 6f6e 6669 675f 7374  st' in config_st
+00006a80: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00006a90: 2020 2062 7265 616b 0a0a 2020 2020 4063     break..    @c
+00006aa0: 6c61 7373 6d65 7468 6f64 0a20 2020 2023  lassmethod.    #
+00006ab0: 2054 4f44 4f3a 2057 6520 6361 6e20 7265   TODO: We can re
+00006ac0: 6d6f 7665 2074 6869 7320 6166 7465 7220  move this after 
+00006ad0: 302e 362e 3020 616e 6420 6861 7665 2061  0.6.0 and have a
+00006ae0: 206c 6f63 6b20 6f6e 6c79 2070 6572 2063   lock only per c
+00006af0: 6c75 7374 6572 2e0a 2020 2020 4074 696d  luster..    @tim
+00006b00: 656c 696e 652e 4669 6c65 4c6f 636b 4576  eline.FileLockEv
+00006b10: 656e 7428 7373 685f 636f 6e66 5f6c 6f63  ent(ssh_conf_loc
+00006b20: 6b5f 7061 7468 290a 2020 2020 6465 6620  k_path).    def 
+00006b30: 7265 6d6f 7665 5f63 6c75 7374 6572 280a  remove_cluster(.
+00006b40: 2020 2020 2020 2020 636c 732c 0a20 2020          cls,.   
+00006b50: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+00006b60: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00006b70: 6970 3a20 7374 722c 0a20 2020 2020 2020  ip: str,.       
+00006b80: 2061 7574 685f 636f 6e66 6967 3a20 4469   auth_config: Di
+00006b90: 6374 5b73 7472 2c20 7374 725d 2c0a 2020  ct[str, str],.  
+00006ba0: 2020 2020 2020 646f 636b 6572 5f75 7365        docker_use
+00006bb0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+00006bc0: 203d 204e 6f6e 652c 0a20 2020 2029 3a0a   = None,.    ):.
+00006bd0: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
+00006be0: 6520 6175 7468 656e 7469 6361 7469 6f6e  e authentication
+00006bf0: 2069 6e66 6f72 6d61 7469 6f6e 2066 6f72   information for
+00006c00: 2063 6c75 7374 6572 2066 726f 6d20 7e2f   cluster from ~/
+00006c10: 2e73 6b79 2f73 7368 2f3c 636c 7573 7465  .sky/ssh/<cluste
+00006c20: 725f 6e61 6d65 3e2e 0a0a 2020 2020 2020  r_name>...      
+00006c30: 2020 466f 7220 6261 636b 7761 7264 2063    For backward c
+00006c40: 6f6d 7061 7469 6269 6c69 7479 2061 6c73  ompatibility als
+00006c50: 6f20 7265 6d6f 7665 2074 6865 2063 6f6e  o remove the con
+00006c60: 6669 6720 6672 6f6d 207e 2f2e 7373 682f  fig from ~/.ssh/
+00006c70: 636f 6e66 6967 2069 6620 6974 2065 7869  config if it exi
+00006c80: 7374 732e 0a0a 2020 2020 2020 2020 4966  sts...        If
+00006c90: 206e 6f20 6578 6973 7469 6e67 2068 6f73   no existing hos
+00006ca0: 7420 6d61 7463 6869 6e67 2074 6865 2070  t matching the p
+00006cb0: 726f 7669 6465 6420 7370 6563 6966 6963  rovided specific
+00006cc0: 6174 696f 6e20 6973 2066 6f75 6e64 2c20  ation is found, 
+00006cd0: 7468 656e 0a20 2020 2020 2020 206e 6f74  then.        not
+00006ce0: 6869 6e67 2069 7320 7265 6d6f 7665 642e  hing is removed.
+00006cf0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00006d00: 2020 2020 2020 2020 2020 2020 6970 3a20              ip: 
+00006d10: 4865 6164 206e 6f64 6527 7320 4950 2061  Head node's IP a
+00006d20: 6464 7265 7373 2e0a 2020 2020 2020 2020  ddress..        
+00006d30: 2020 2020 6175 7468 5f63 6f6e 6669 673a      auth_config:
+00006d40: 2072 6561 645f 7961 6d6c 2868 616e 646c   read_yaml(handl
+00006d50: 652e 636c 7573 7465 725f 7961 6d6c 295b  e.cluster_yaml)[
+00006d60: 2761 7574 6827 5d0a 2020 2020 2020 2020  'auth'].        
+00006d70: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
+00006d80: 2049 6620 6e6f 7420 4e6f 6e65 2c20 7573   If not None, us
+00006d90: 6520 7468 6973 2075 7365 7220 746f 2073  e this user to s
+00006da0: 7368 2069 6e74 6f20 7468 6520 646f 636b  sh into the dock
+00006db0: 6572 0a20 2020 2020 2020 2022 2222 0a20  er.        """. 
+00006dc0: 2020 2020 2020 2063 6c75 7374 6572 5f63         cluster_c
+00006dd0: 6f6e 6669 675f 7061 7468 203d 206f 732e  onfig_path = os.
+00006de0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+00006df0: 0a20 2020 2020 2020 2020 2020 2063 6c73  .            cls
+00006e00: 2e73 7368 5f63 6c75 7374 6572 5f70 6174  .ssh_cluster_pat
+00006e10: 682e 666f 726d 6174 2863 6c75 7374 6572  h.format(cluster
+00006e20: 5f6e 616d 6529 290a 2020 2020 2020 2020  _name)).        
+00006e30: 636f 6d6d 6f6e 5f75 7469 6c73 2e72 656d  common_utils.rem
+00006e40: 6f76 655f 6669 6c65 5f69 665f 6578 6973  ove_file_if_exis
+00006e50: 7473 2863 6c75 7374 6572 5f63 6f6e 6669  ts(cluster_confi
+00006e60: 675f 7061 7468 290a 0a20 2020 2020 2020  g_path)..       
+00006e70: 2023 2045 6e73 7572 6573 2062 6163 6b77   # Ensures backw
+00006e80: 6172 6420 636f 6d70 6174 6962 696c 6974  ard compatibilit
+00006e90: 793a 2062 6566 6f72 6520 2332 3730 362c  y: before #2706,
+00006ea0: 2077 6520 7772 6f74 6520 7468 6520 636f   we wrote the co
+00006eb0: 6e66 6967 206f 6620 536b 7950 696c 6f74  nfig of SkyPilot
+00006ec0: 2063 6c75 7374 6572 730a 2020 2020 2020   clusters.      
+00006ed0: 2020 2320 6469 7265 6374 6c79 2069 6e20    # directly in 
+00006ee0: 7e2f 2e73 7368 2f63 6f6e 6669 672e 2046  ~/.ssh/config. F
+00006ef0: 6f72 2074 6865 7365 2063 6c75 7374 6572  or these cluster
+00006f00: 732c 2077 6520 7368 6f75 6c64 2063 6c65  s, we should cle
+00006f10: 616e 2075 7020 7468 6520 636f 6e66 6967  an up the config
+00006f20: 2e0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
+00006f30: 3a20 5265 6d6f 7665 2074 6869 7320 6166  : Remove this af
+00006f40: 7465 7220 302e 362e 300a 2020 2020 2020  ter 0.6.0.      
+00006f50: 2020 636c 732e 5f72 656d 6f76 655f 7374    cls._remove_st
+00006f60: 616c 655f 636c 7573 7465 725f 636f 6e66  ale_cluster_conf
+00006f70: 6967 5f66 6f72 5f62 6163 6b77 6172 645f  ig_for_backward_
+00006f80: 636f 6d70 6174 6962 696c 6974 7928 0a20  compatibility(. 
+00006f90: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+00006fa0: 6572 5f6e 616d 652c 2069 702c 2061 7574  er_name, ip, aut
+00006fb0: 685f 636f 6e66 6967 2c20 646f 636b 6572  h_config, docker
+00006fc0: 5f75 7365 7229 0a0a 0a64 6566 205f 7265  _user)...def _re
+00006fd0: 706c 6163 655f 7961 6d6c 5f64 6963 7473  place_yaml_dicts
+00006fe0: 280a 2020 2020 2020 2020 6e65 775f 7961  (.        new_ya
+00006ff0: 6d6c 3a20 7374 722c 206f 6c64 5f79 616d  ml: str, old_yam
+00007000: 6c3a 2073 7472 2c20 7265 7374 6f72 655f  l: str, restore_
+00007010: 6b65 795f 6e61 6d65 733a 2053 6574 5b73  key_names: Set[s
+00007020: 7472 5d2c 0a20 2020 2020 2020 2072 6573  tr],.        res
+00007030: 746f 7265 5f6b 6579 5f6e 616d 6573 5f65  tore_key_names_e
+00007040: 7863 6570 7469 6f6e 733a 2053 6571 7565  xceptions: Seque
+00007050: 6e63 655b 5475 706c 655b 7374 722c 202e  nce[Tuple[str, .
+00007060: 2e2e 5d5d 2920 2d3e 2073 7472 3a0a 2020  ..]]) -> str:.  
+00007070: 2020 2222 2252 6570 6c61 6365 7320 276e    """Replaces 'n
+00007080: 6577 2720 7769 7468 2027 6f6c 6427 2066  ew' with 'old' f
+00007090: 6f72 2061 6c6c 206b 6579 7320 696e 2072  or all keys in r
+000070a0: 6573 746f 7265 5f6b 6579 5f6e 616d 6573  estore_key_names
+000070b0: 2e0a 0a20 2020 2054 6865 2072 6570 6c61  ...    The repla
+000070c0: 6365 6d65 6e74 2077 696c 6c20 6265 2061  cement will be a
+000070d0: 7070 6c69 6564 2072 6563 7572 7369 7665  pplied recursive
+000070e0: 6c79 2061 6e64 206f 6e6c 7920 666f 7220  ly and only for 
+000070f0: 7468 6520 626c 6f63 6b73 0a20 2020 2077  the blocks.    w
+00007100: 6974 6820 7468 6520 6b65 7920 696e 206b  ith the key in k
+00007110: 6579 5f6e 616d 6573 2c20 616e 6420 6861  ey_names, and ha
+00007120: 7665 2074 6865 2073 616d 6520 616e 6365  ve the same ance
+00007130: 7374 6f72 7320 696e 2062 6f74 6820 276e  stors in both 'n
+00007140: 6577 270a 2020 2020 616e 6420 276f 6c64  ew'.    and 'old
+00007150: 2720 5941 4d4c 2074 7265 652e 0a0a 2020  ' YAML tree...  
+00007160: 2020 5468 6520 7265 7374 6f72 655f 6b65    The restore_ke
+00007170: 795f 6e61 6d65 735f 6578 6365 7074 696f  y_names_exceptio
+00007180: 6e73 2069 7320 6120 6c69 7374 206f 6620  ns is a list of 
+00007190: 6b65 7920 6e61 6d65 7320 7468 6174 2073  key names that s
+000071a0: 686f 756c 6420 6e6f 740a 2020 2020 6265  hould not.    be
+000071b0: 2072 6573 746f 7265 642c 2069 2e65 2e20   restored, i.e. 
+000071c0: 7468 6f73 6520 6b65 7973 2077 696c 6c20  those keys will 
+000071d0: 6265 2072 6573 6574 2074 6f20 7468 6520  be reset to the 
+000071e0: 7661 6c75 6520 696e 2027 6e65 7727 2059  value in 'new' Y
+000071f0: 414d 4c0a 2020 2020 7472 6565 2061 6674  AML.    tree aft
+00007200: 6572 2074 6865 2072 6570 6c61 6365 6d65  er the replaceme
+00007210: 6e74 2e0a 2020 2020 2222 220a 0a20 2020  nt..    """..   
+00007220: 2064 6566 205f 7265 7374 6f72 655f 626c   def _restore_bl
+00007230: 6f63 6b28 6e65 775f 626c 6f63 6b3a 2044  ock(new_block: D
+00007240: 6963 745b 7374 722c 2041 6e79 5d2c 206f  ict[str, Any], o
+00007250: 6c64 5f62 6c6f 636b 3a20 4469 6374 5b73  ld_block: Dict[s
+00007260: 7472 2c20 416e 795d 293a 0a20 2020 2020  tr, Any]):.     
+00007270: 2020 2066 6f72 206b 6579 2c20 7661 6c75     for key, valu
+00007280: 6520 696e 206e 6577 5f62 6c6f 636b 2e69  e in new_block.i
+00007290: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+000072a0: 2020 2020 6966 206b 6579 2069 6e20 7265      if key in re
+000072b0: 7374 6f72 655f 6b65 795f 6e61 6d65 733a  store_key_names:
+000072c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000072d0: 2069 6620 6b65 7920 696e 206f 6c64 5f62   if key in old_b
+000072e0: 6c6f 636b 3a0a 2020 2020 2020 2020 2020  lock:.          
+000072f0: 2020 2020 2020 2020 2020 6e65 775f 626c            new_bl
+00007300: 6f63 6b5b 6b65 795d 203d 206f 6c64 5f62  ock[key] = old_b
+00007310: 6c6f 636b 5b6b 6579 5d0a 2020 2020 2020  lock[key].      
+00007320: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00007330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007340: 2020 2020 6465 6c20 6e65 775f 626c 6f63      del new_bloc
+00007350: 6b5b 6b65 795d 0a20 2020 2020 2020 2020  k[key].         
+00007360: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00007370: 6365 2876 616c 7565 2c20 6469 6374 293a  ce(value, dict):
+00007380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007390: 2069 6620 6b65 7920 696e 206f 6c64 5f62   if key in old_b
+000073a0: 6c6f 636b 3a0a 2020 2020 2020 2020 2020  lock:.          
+000073b0: 2020 2020 2020 2020 2020 5f72 6573 746f            _resto
+000073c0: 7265 5f62 6c6f 636b 2876 616c 7565 2c20  re_block(value, 
+000073d0: 6f6c 645f 626c 6f63 6b5b 6b65 795d 290a  old_block[key]).
+000073e0: 0a20 2020 206e 6577 5f63 6f6e 6669 6720  .    new_config 
+000073f0: 3d20 7961 6d6c 2e73 6166 655f 6c6f 6164  = yaml.safe_load
+00007400: 286e 6577 5f79 616d 6c29 0a20 2020 206f  (new_yaml).    o
+00007410: 6c64 5f63 6f6e 6669 6720 3d20 7961 6d6c  ld_config = yaml
+00007420: 2e73 6166 655f 6c6f 6164 286f 6c64 5f79  .safe_load(old_y
+00007430: 616d 6c29 0a20 2020 2065 7863 6c75 6465  aml).    exclude
+00007440: 645f 7265 7375 6c74 7320 3d20 7b7d 0a20  d_results = {}. 
+00007450: 2020 2023 2046 696e 6420 616c 6c20 6b65     # Find all ke
+00007460: 7920 7661 6c75 6573 2065 7863 6c75 6465  y values exclude
+00007470: 6420 6672 6f6d 2072 6573 746f 7265 0a20  d from restore. 
+00007480: 2020 2066 6f72 2065 7863 6c75 6465 5f72     for exclude_r
+00007490: 6573 746f 7265 5f6b 6579 5f6e 616d 655f  estore_key_name_
+000074a0: 6c69 7374 2069 6e20 7265 7374 6f72 655f  list in restore_
+000074b0: 6b65 795f 6e61 6d65 735f 6578 6365 7074  key_names_except
+000074c0: 696f 6e73 3a0a 2020 2020 2020 2020 6578  ions:.        ex
+000074d0: 636c 7564 6564 5f72 6573 756c 7420 3d20  cluded_result = 
+000074e0: 6e65 775f 636f 6e66 6967 0a20 2020 2020  new_config.     
+000074f0: 2020 2066 6f75 6e64 5f65 7863 6c75 6465     found_exclude
+00007500: 645f 6b65 7920 3d20 5472 7565 0a20 2020  d_key = True.   
+00007510: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00007520: 6578 636c 7564 655f 7265 7374 6f72 655f  exclude_restore_
+00007530: 6b65 795f 6e61 6d65 5f6c 6973 743a 0a20  key_name_list:. 
+00007540: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
+00007550: 6f74 2069 7369 6e73 7461 6e63 6528 6578  ot isinstance(ex
+00007560: 636c 7564 6564 5f72 6573 756c 742c 2064  cluded_result, d
+00007570: 6963 7429 206f 720a 2020 2020 2020 2020  ict) or.        
+00007580: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
+00007590: 6e6f 7420 696e 2065 7863 6c75 6465 645f  not in excluded_
+000075a0: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
+000075b0: 2020 2020 2020 2020 2066 6f75 6e64 5f65           found_e
+000075c0: 7863 6c75 6465 645f 6b65 7920 3d20 4661  xcluded_key = Fa
+000075d0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000075e0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+000075f0: 2020 2020 2020 6578 636c 7564 6564 5f72        excluded_r
+00007600: 6573 756c 7420 3d20 6578 636c 7564 6564  esult = excluded
+00007610: 5f72 6573 756c 745b 6b65 795d 0a20 2020  _result[key].   
+00007620: 2020 2020 2069 6620 666f 756e 645f 6578       if found_ex
+00007630: 636c 7564 6564 5f6b 6579 3a0a 2020 2020  cluded_key:.    
+00007640: 2020 2020 2020 2020 6578 636c 7564 6564          excluded
+00007650: 5f72 6573 756c 7473 5b65 7863 6c75 6465  _results[exclude
+00007660: 5f72 6573 746f 7265 5f6b 6579 5f6e 616d  _restore_key_nam
+00007670: 655f 6c69 7374 5d20 3d20 6578 636c 7564  e_list] = exclud
+00007680: 6564 5f72 6573 756c 740a 0a20 2020 2023  ed_result..    #
+00007690: 2052 6573 746f 7265 2066 726f 6d20 6f6c   Restore from ol
+000076a0: 6420 636f 6e66 6967 0a20 2020 205f 7265  d config.    _re
+000076b0: 7374 6f72 655f 626c 6f63 6b28 6e65 775f  store_block(new_
+000076c0: 636f 6e66 6967 2c20 6f6c 645f 636f 6e66  config, old_conf
+000076d0: 6967 290a 0a20 2020 2023 2052 6576 6572  ig)..    # Rever
+000076e0: 7420 7468 6520 6368 616e 6765 7320 666f  t the changes fo
+000076f0: 7220 7468 6520 6578 636c 7564 6564 206b  r the excluded k
+00007700: 6579 2076 616c 7565 730a 2020 2020 666f  ey values.    fo
+00007710: 7220 6578 636c 7564 655f 7265 7374 6f72  r exclude_restor
+00007720: 655f 6b65 795f 6e61 6d65 2c20 7661 6c75  e_key_name, valu
+00007730: 6520 696e 2065 7863 6c75 6465 645f 7265  e in excluded_re
+00007740: 7375 6c74 732e 6974 656d 7328 293a 0a20  sults.items():. 
+00007750: 2020 2020 2020 2063 7572 7220 3d20 6e65         curr = ne
+00007760: 775f 636f 6e66 6967 0a20 2020 2020 2020  w_config.       
+00007770: 2066 6f72 206b 6579 2069 6e20 6578 636c   for key in excl
+00007780: 7564 655f 7265 7374 6f72 655f 6b65 795f  ude_restore_key_
+00007790: 6e61 6d65 5b3a 2d31 5d3a 0a20 2020 2020  name[:-1]:.     
+000077a0: 2020 2020 2020 2063 7572 7220 3d20 6375         curr = cu
+000077b0: 7272 5b6b 6579 5d0a 2020 2020 2020 2020  rr[key].        
+000077c0: 6375 7272 5b65 7863 6c75 6465 5f72 6573  curr[exclude_res
+000077d0: 746f 7265 5f6b 6579 5f6e 616d 655b 2d31  tore_key_name[-1
+000077e0: 5d5d 203d 2076 616c 7565 0a20 2020 2072  ]] = value.    r
+000077f0: 6574 7572 6e20 636f 6d6d 6f6e 5f75 7469  eturn common_uti
+00007800: 6c73 2e64 756d 705f 7961 6d6c 5f73 7472  ls.dump_yaml_str
+00007810: 286e 6577 5f63 6f6e 6669 6729 0a0a 0a23  (new_config)...#
+00007820: 2054 4f44 4f3a 2074 6f6f 206d 616e 7920   TODO: too many 
+00007830: 7468 696e 6773 2068 6170 7065 6e69 6e67  things happening
+00007840: 2068 6572 6520 2d20 6c65 616b 7920 6162   here - leaky ab
+00007850: 7374 7261 6374 696f 6e2e 2052 6566 6163  straction. Refac
+00007860: 746f 722e 0a40 7469 6d65 6c69 6e65 2e65  tor..@timeline.e
+00007870: 7665 6e74 0a64 6566 2077 7269 7465 5f63  vent.def write_c
+00007880: 6c75 7374 6572 5f63 6f6e 6669 6728 0a20  luster_config(. 
+00007890: 2020 2020 2020 2074 6f5f 7072 6f76 6973         to_provis
+000078a0: 696f 6e3a 2027 7265 736f 7572 6365 732e  ion: 'resources.
+000078b0: 5265 736f 7572 6365 7327 2c0a 2020 2020  Resources',.    
+000078c0: 2020 2020 6e75 6d5f 6e6f 6465 733a 2069      num_nodes: i
+000078d0: 6e74 2c0a 2020 2020 2020 2020 636c 7573  nt,.        clus
+000078e0: 7465 725f 636f 6e66 6967 5f74 656d 706c  ter_config_templ
+000078f0: 6174 653a 2073 7472 2c0a 2020 2020 2020  ate: str,.      
+00007900: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
+00007910: 7374 722c 0a20 2020 2020 2020 206c 6f63  str,.        loc
+00007920: 616c 5f77 6865 656c 5f70 6174 683a 2070  al_wheel_path: p
+00007930: 6174 686c 6962 2e50 6174 682c 0a20 2020  athlib.Path,.   
+00007940: 2020 2020 2077 6865 656c 5f68 6173 683a       wheel_hash:
+00007950: 2073 7472 2c0a 2020 2020 2020 2020 7265   str,.        re
+00007960: 6769 6f6e 3a20 636c 6f75 6473 2e52 6567  gion: clouds.Reg
+00007970: 696f 6e2c 0a20 2020 2020 2020 207a 6f6e  ion,.        zon
+00007980: 6573 3a20 4f70 7469 6f6e 616c 5b4c 6973  es: Optional[Lis
+00007990: 745b 636c 6f75 6473 2e5a 6f6e 655d 5d20  t[clouds.Zone]] 
+000079a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000079b0: 6472 7972 756e 3a20 626f 6f6c 203d 2046  dryrun: bool = F
+000079c0: 616c 7365 2c0a 2020 2020 2020 2020 6b65  alse,.        ke
+000079d0: 6570 5f6c 6175 6e63 685f 6669 656c 6473  ep_launch_fields
+000079e0: 5f69 6e5f 6578 6973 7469 6e67 5f63 6f6e  _in_existing_con
+000079f0: 6669 673a 2062 6f6f 6c20 3d20 5472 7565  fig: bool = True
+00007a00: 2920 2d3e 2044 6963 745b 7374 722c 2073  ) -> Dict[str, s
+00007a10: 7472 5d3a 0a20 2020 2022 2222 4669 6c6c  tr]:.    """Fill
+00007a20: 7320 696e 2063 6c75 7374 6572 2063 6f6e  s in cluster con
+00007a30: 6669 6775 7261 7469 6f6e 2074 656d 706c  figuration templ
+00007a40: 6174 6573 2061 6e64 2077 7269 7465 7320  ates and writes 
+00007a50: 7468 656d 206f 7574 2e0a 0a20 2020 2052  them out...    R
+00007a60: 6574 7572 6e73 3a20 7b70 726f 7669 7369  eturns: {provisi
+00007a70: 6f6e 6572 3a20 7061 7468 2074 6f20 7961  oner: path to ya
+00007a80: 6d6c 2c20 7468 6520 7072 6f76 6973 696f  ml, the provisio
+00007a90: 6e69 6e67 2073 7065 637d 2e0a 2020 2020  ning spec}..    
+00007aa0: 2020 2770 726f 7669 7369 6f6e 6572 2720    'provisioner' 
+00007ab0: 6361 6e20 6265 0a20 2020 2020 2020 202d  can be.        -
+00007ac0: 2027 7261 7927 0a20 2020 2020 2020 202d   'ray'.        -
+00007ad0: 2027 7470 752d 6372 6561 7465 2d73 6372   'tpu-create-scr
+00007ae0: 6970 7427 2028 6966 2054 5055 2069 7320  ipt' (if TPU is 
+00007af0: 7265 7175 6573 7465 6429 0a20 2020 2020  requested).     
+00007b00: 2020 202d 2027 7470 752d 6465 6c65 7465     - 'tpu-delete
+00007b10: 2d73 6372 6970 7427 2028 6966 2054 5055  -script' (if TPU
+00007b20: 2069 7320 7265 7175 6573 7465 6429 0a20   is requested). 
+00007b30: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
+00007b40: 2020 2065 7863 6570 7469 6f6e 732e 5265     exceptions.Re
+00007b50: 736f 7572 6365 7355 6e61 7661 696c 6162  sourcesUnavailab
+00007b60: 6c65 4572 726f 723a 2069 6620 7468 6520  leError: if the 
+00007b70: 7265 6769 6f6e 2f7a 6f6e 6573 2072 6571  region/zones req
+00007b80: 7565 7374 6564 2064 6f65 730a 2020 2020  uested does.    
+00007b90: 2020 2020 2020 2020 6e6f 7420 6170 7065          not appe
+00007ba0: 6172 2069 6e20 7468 6520 6361 7461 6c6f  ar in the catalo
+00007bb0: 672c 206f 7220 616e 2073 7368 5f70 726f  g, or an ssh_pro
+00007bc0: 7879 5f63 6f6d 6d61 6e64 2069 7320 7370  xy_command is sp
+00007bd0: 6563 6966 6965 6420 6275 740a 2020 2020  ecified but.    
+00007be0: 2020 2020 2020 2020 6e6f 7420 666f 7220          not for 
+00007bf0: 7468 6520 6769 7665 6e20 7265 6769 6f6e  the given region
+00007c00: 2c20 6f72 2047 5055 7320 6172 6520 7265  , or GPUs are re
+00007c10: 7175 6573 7465 6420 696e 2061 204b 7562  quested in a Kub
+00007c20: 6572 6e65 7465 730a 2020 2020 2020 2020  ernetes.        
+00007c30: 2020 2020 636c 7573 7465 7220 6275 7420      cluster but 
+00007c40: 7468 6520 636c 7573 7465 7220 646f 6573  the cluster does
+00007c50: 206e 6f74 2068 6176 6520 6e6f 6465 7320   not have nodes 
+00007c60: 6c61 6265 6c65 6420 7769 7468 2047 5055  labeled with GPU
+00007c70: 2074 7970 6573 2e0a 2020 2020 2020 2020   types..        
+00007c80: 6578 6365 7074 696f 6e73 2e49 6e76 616c  exceptions.Inval
+00007c90: 6964 436c 6f75 6443 6f6e 6669 6773 3a20  idCloudConfigs: 
+00007ca0: 6966 2074 6865 2075 7365 7220 7370 6563  if the user spec
+00007cb0: 6966 6965 7320 736f 6d65 2063 6f6e 6669  ifies some confi
+00007cc0: 6720 666f 7220 7468 650a 2020 2020 2020  g for the.      
+00007cd0: 2020 2020 2020 636c 6f75 6420 7468 6174        cloud that
+00007ce0: 2069 7320 6e6f 7420 7661 6c69 642c 2065   is not valid, e
+00007cf0: 2e67 2e20 7265 6d6f 7465 5f69 6465 6e74  .g. remote_ident
+00007d00: 6974 793a 2053 4552 5649 4345 5f41 4343  ity: SERVICE_ACC
+00007d10: 4f55 4e54 0a20 2020 2020 2020 2020 2020  OUNT.           
+00007d20: 2066 6f72 2061 2063 6c6f 7564 2074 6861   for a cloud tha
+00007d30: 7420 646f 6573 206e 6f74 2073 7570 706f  t does not suppo
+00007d40: 7274 2069 742c 2074 6865 2063 616c 6c65  rt it, the calle
+00007d50: 7220 7368 6f75 6c64 2073 6b69 7020 7468  r should skip th
+00007d60: 650a 2020 2020 2020 2020 2020 2020 636c  e.            cl
+00007d70: 6f75 6420 696e 2074 6869 7320 6361 7365  oud in this case
+00007d80: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
+00007d90: 7461 736b 2e62 6573 745f 7265 736f 7572  task.best_resour
+00007da0: 6365 7320 6d61 7920 6e6f 7420 6265 2065  ces may not be e
+00007db0: 7175 616c 2074 6f20 746f 5f70 726f 7669  qual to to_provi
+00007dc0: 7369 6f6e 2069 6620 7468 6520 7573 6572  sion if the user
+00007dd0: 0a20 2020 2023 2069 7320 7275 6e6e 696e  .    # is runnin
+00007de0: 6720 6120 6a6f 6220 7769 7468 206c 6573  g a job with les
+00007df0: 7320 7265 736f 7572 6365 7320 7468 616e  s resources than
+00007e00: 2074 6865 2063 6c75 7374 6572 2068 6173   the cluster has
+00007e10: 2e0a 2020 2020 636c 6f75 6420 3d20 746f  ..    cloud = to
+00007e20: 5f70 726f 7669 7369 6f6e 2e63 6c6f 7564  _provision.cloud
+00007e30: 0a20 2020 2061 7373 6572 7420 636c 6f75  .    assert clou
+00007e40: 6420 6973 206e 6f74 204e 6f6e 652c 2074  d is not None, t
+00007e50: 6f5f 7072 6f76 6973 696f 6e0a 0a20 2020  o_provision..   
+00007e60: 2063 6c75 7374 6572 5f6e 616d 655f 6f6e   cluster_name_on
+00007e70: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
+00007e80: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+00007e90: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+00007ea0: 280a 2020 2020 2020 2020 636c 7573 7465  (.        cluste
+00007eb0: 725f 6e61 6d65 2c20 6d61 785f 6c65 6e67  r_name, max_leng
+00007ec0: 7468 3d63 6c6f 7564 2e6d 6178 5f63 6c75  th=cloud.max_clu
+00007ed0: 7374 6572 5f6e 616d 655f 6c65 6e67 7468  ster_name_length
+00007ee0: 2829 290a 0a20 2020 2023 2054 6869 7320  ())..    # This 
+00007ef0: 6361 6e20 7261 6973 6520 6120 5265 736f  can raise a Reso
+00007f00: 7572 6365 7355 6e61 7661 696c 6162 6c65  urcesUnavailable
+00007f10: 4572 726f 7220 7768 656e 3a0a 2020 2020  Error when:.    
+00007f20: 2320 202a 2054 6865 2072 6567 696f 6e2f  #  * The region/
+00007f30: 7a6f 6e65 7320 7265 7175 6573 7465 6420  zones requested 
+00007f40: 646f 6573 206e 6f74 2061 7070 6561 7220  does not appear 
+00007f50: 696e 2074 6865 2063 6174 616c 6f67 2e20  in the catalog. 
+00007f60: 4974 2063 616e 2062 650a 2020 2020 2320  It can be.    # 
+00007f70: 2020 2074 7269 6767 6572 6564 2069 6620     triggered if 
+00007f80: 7468 6520 7573 6572 2063 6861 6e67 6564  the user changed
+00007f90: 2074 6865 2063 6174 616c 6f67 2066 696c   the catalog fil
+00007fa0: 6520 7768 696c 6520 7468 6572 6520 6973  e while there is
+00007fb0: 2061 2063 6c75 7374 6572 0a20 2020 2023   a cluster.    #
+00007fc0: 2020 2020 696e 2074 6865 2072 656d 6f76      in the remov
+00007fd0: 6564 2072 6567 696f 6e2f 7a6f 6e65 2e0a  ed region/zone..
+00007fe0: 2020 2020 2320 202a 2047 5055 7320 6172      #  * GPUs ar
+00007ff0: 6520 7265 7175 6573 7465 6420 696e 2061  e requested in a
+00008000: 204b 7562 6572 6e65 7465 7320 636c 7573   Kubernetes clus
+00008010: 7465 7220 6275 7420 7468 6520 636c 7573  ter but the clus
+00008020: 7465 7220 646f 6573 206e 6f74 0a20 2020  ter does not.   
+00008030: 2023 2020 2020 6861 7665 206e 6f64 6573   #    have nodes
+00008040: 206c 6162 656c 6564 2077 6974 6820 4750   labeled with GP
+00008050: 5520 7479 7065 732e 0a20 2020 2023 0a20  U types..    #. 
+00008060: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+00008070: 2057 6520 7368 6f75 6c64 2063 6861 6e67   We should chang
+00008080: 6520 7468 6520 6578 6365 7074 696f 6e20  e the exception 
+00008090: 7479 7065 2074 6f20 6120 6d6f 7265 2073  type to a more s
+000080a0: 7065 6369 6669 6320 6f6e 652c 2061 730a  pecific one, as.
+000080b0: 2020 2020 2320 7468 6520 5265 736f 7572      # the Resour
+000080c0: 6365 7355 6e61 7661 696c 6162 6c65 4572  cesUnavailableEr
+000080d0: 726f 7220 6973 206f 7665 726c 7920 7573  ror is overly us
+000080e0: 6564 2e20 416c 736f 2c20 6974 2077 6f75  ed. Also, it wou
+000080f0: 6c64 2062 6520 6265 7474 6572 2074 6f0a  ld be better to.
+00008100: 2020 2020 2320 6d6f 7665 2074 6865 2063      # move the c
+00008110: 6865 636b 206f 7574 206f 6620 7468 6973  heck out of this
+00008120: 2066 756e 6374 696f 6e2c 2069 2e65 2e20   function, i.e. 
+00008130: 7468 6520 6361 6c6c 6572 2073 686f 756c  the caller shoul
+00008140: 6420 6265 2072 6573 706f 6e73 6962 6c65  d be responsible
+00008150: 0a20 2020 2023 2066 6f72 2074 6865 2076  .    # for the v
+00008160: 616c 6964 6174 696f 6e2e 0a20 2020 2023  alidation..    #
+00008170: 2054 4f44 4f28 7469 616e 293a 204d 6f76   TODO(tian): Mov
+00008180: 6520 6d6f 7265 2063 6c6f 7564 2061 676e  e more cloud agn
+00008190: 6f73 7469 6320 7661 7273 2074 6f20 7265  ostic vars to re
+000081a0: 736f 7572 6365 732e 7079 2e0a 2020 2020  sources.py..    
+000081b0: 7265 736f 7572 6365 735f 7661 7273 203d  resources_vars =
+000081c0: 2074 6f5f 7072 6f76 6973 696f 6e2e 6d61   to_provision.ma
+000081d0: 6b65 5f64 6570 6c6f 795f 7661 7269 6162  ke_deploy_variab
+000081e0: 6c65 7328 636c 7573 7465 725f 6e61 6d65  les(cluster_name
+000081f0: 5f6f 6e5f 636c 6f75 642c 0a20 2020 2020  _on_cloud,.     
 00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008220: 2020 2020 7265 6769 6f6e 2c20 7a6f 6e65      region, zone
-00008230: 732c 2064 7279 7275 6e29 0a20 2020 2063  s, dryrun).    c
-00008240: 6f6e 6669 675f 6469 6374 203d 207b 7d0a  onfig_dict = {}.
-00008250: 0a20 2020 2073 7065 6369 6669 635f 7265  .    specific_re
-00008260: 7365 7276 6174 696f 6e73 203d 2073 6574  servations = set
-00008270: 280a 2020 2020 2020 2020 736b 7970 696c  (.        skypil
-00008280: 6f74 5f63 6f6e 6669 672e 6765 745f 6e65  ot_config.get_ne
-00008290: 7374 6564 280a 2020 2020 2020 2020 2020  sted(.          
-000082a0: 2020 2873 7472 2874 6f5f 7072 6f76 6973    (str(to_provis
-000082b0: 696f 6e2e 636c 6f75 6429 2e6c 6f77 6572  ion.cloud).lower
-000082c0: 2829 2c20 2773 7065 6369 6669 635f 7265  (), 'specific_re
-000082d0: 7365 7276 6174 696f 6e73 2729 2c20 7365  servations'), se
-000082e0: 7428 2929 290a 0a20 2020 2061 7373 6572  t()))..    asser
-000082f0: 7420 636c 7573 7465 725f 6e61 6d65 2069  t cluster_name i
-00008300: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2065  s not None.    e
-00008310: 7863 6c75 6465 645f 636c 6f75 6473 203d  xcluded_clouds =
-00008320: 205b 5d0a 2020 2020 7265 6d6f 7465 5f69   [].    remote_i
-00008330: 6465 6e74 6974 7920 3d20 736b 7970 696c  dentity = skypil
-00008340: 6f74 5f63 6f6e 6669 672e 6765 745f 6e65  ot_config.get_ne
-00008350: 7374 6564 280a 2020 2020 2020 2020 2873  sted(.        (s
-00008360: 7472 2863 6c6f 7564 292e 6c6f 7765 7228  tr(cloud).lower(
-00008370: 292c 2027 7265 6d6f 7465 5f69 6465 6e74  ), 'remote_ident
-00008380: 6974 7927 292c 2027 4c4f 4341 4c5f 4352  ity'), 'LOCAL_CR
-00008390: 4544 454e 5449 414c 5327 290a 2020 2020  EDENTIALS').    
-000083a0: 6966 2072 656d 6f74 655f 6964 656e 7469  if remote_identi
-000083b0: 7479 203d 3d20 2753 4552 5649 4345 5f41  ty == 'SERVICE_A
-000083c0: 4343 4f55 4e54 273a 0a20 2020 2020 2020  CCOUNT':.       
-000083d0: 2069 6620 6e6f 7420 636c 6f75 642e 7375   if not cloud.su
-000083e0: 7070 6f72 7473 5f73 6572 7669 6365 5f61  pports_service_a
-000083f0: 6363 6f75 6e74 5f6f 6e5f 7265 6d6f 7465  ccount_on_remote
-00008400: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00008410: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
-00008420: 2e49 6e76 616c 6964 436c 6f75 6443 6f6e  .InvalidCloudCon
-00008430: 6669 6773 280a 2020 2020 2020 2020 2020  figs(.          
-00008440: 2020 2020 2020 2772 656d 6f74 655f 6964        'remote_id
-00008450: 656e 7469 7479 3a20 5345 5256 4943 455f  entity: SERVICE_
-00008460: 4143 434f 554e 5420 6973 2073 7065 6369  ACCOUNT is speci
-00008470: 6669 6564 2069 6e20 270a 2020 2020 2020  fied in '.      
-00008480: 2020 2020 2020 2020 2020 6627 7b73 6b79            f'{sky
-00008490: 7069 6c6f 745f 636f 6e66 6967 2e6c 6f61  pilot_config.loa
-000084a0: 6465 645f 636f 6e66 6967 5f70 6174 6821  ded_config_path!
-000084b0: 727d 2066 6f72 207b 636c 6f75 647d 2c20  r} for {cloud}, 
-000084c0: 6275 7420 6974 2027 0a20 2020 2020 2020  but it '.       
-000084d0: 2020 2020 2020 2020 2027 6973 206e 6f74           'is not
-000084e0: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
-000084f0: 6973 2063 6c6f 7564 2e20 5265 6d6f 7665  is cloud. Remove
-00008500: 2074 6865 2063 6f6e 6669 6720 6f72 2073   the config or s
-00008510: 6574 3a20 270a 2020 2020 2020 2020 2020  et: '.          
-00008520: 2020 2020 2020 2760 7265 6d6f 7465 5f69        '`remote_i
-00008530: 6465 6e74 6974 793a 204c 4f43 414c 5f43  dentity: LOCAL_C
-00008540: 5245 4445 4e54 4941 4c53 602e 2729 0a20  REDENTIALS`.'). 
-00008550: 2020 2020 2020 2065 7863 6c75 6465 645f         excluded_
-00008560: 636c 6f75 6473 203d 205b 636c 6f75 645d  clouds = [cloud]
-00008570: 0a20 2020 2063 7265 6465 6e74 6961 6c73  .    credentials
-00008580: 203d 2073 6b79 5f63 6865 636b 2e67 6574   = sky_check.get
-00008590: 5f63 6c6f 7564 5f63 7265 6465 6e74 6961  _cloud_credentia
-000085a0: 6c5f 6669 6c65 5f6d 6f75 6e74 7328 6578  l_file_mounts(ex
-000085b0: 636c 7564 6564 5f63 6c6f 7564 7329 0a0a  cluded_clouds)..
-000085c0: 2020 2020 6175 7468 5f63 6f6e 6669 6720      auth_config 
-000085d0: 3d20 7b27 7373 685f 7072 6976 6174 655f  = {'ssh_private_
-000085e0: 6b65 7927 3a20 6175 7468 2e50 5249 5641  key': auth.PRIVA
-000085f0: 5445 5f53 5348 5f4b 4559 5f50 4154 487d  TE_SSH_KEY_PATH}
-00008600: 0a20 2020 2072 6567 696f 6e5f 6e61 6d65  .    region_name
-00008610: 203d 2072 6573 6f75 7263 6573 5f76 6172   = resources_var
-00008620: 732e 6765 7428 2772 6567 696f 6e27 290a  s.get('region').
-00008630: 0a20 2020 2079 616d 6c5f 7061 7468 203d  .    yaml_path =
-00008640: 205f 6765 745f 7961 6d6c 5f70 6174 685f   _get_yaml_path_
-00008650: 6672 6f6d 5f63 6c75 7374 6572 5f6e 616d  from_cluster_nam
-00008660: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
-00008670: 0a20 2020 2023 2052 6574 7269 6576 6520  .    # Retrieve 
-00008680: 7468 6520 7373 685f 7072 6f78 795f 636f  the ssh_proxy_co
-00008690: 6d6d 616e 6420 666f 7220 7468 6520 6769  mmand for the gi
-000086a0: 7665 6e20 636c 6f75 6420 2f20 7265 6769  ven cloud / regi
-000086b0: 6f6e 2e0a 2020 2020 7373 685f 7072 6f78  on..    ssh_prox
-000086c0: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
-000086d0: 203d 2073 6b79 7069 6c6f 745f 636f 6e66   = skypilot_conf
-000086e0: 6967 2e67 6574 5f6e 6573 7465 6428 0a20  ig.get_nested(. 
-000086f0: 2020 2020 2020 2028 7374 7228 636c 6f75         (str(clou
-00008700: 6429 2e6c 6f77 6572 2829 2c20 2773 7368  d).lower(), 'ssh
-00008710: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2729  _proxy_command')
-00008720: 2c20 4e6f 6e65 290a 2020 2020 6966 2028  , None).    if (
-00008730: 6973 696e 7374 616e 6365 2873 7368 5f70  isinstance(ssh_p
-00008740: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
-00008750: 6669 672c 2073 7472 2920 6f72 0a20 2020  fig, str) or.   
-00008760: 2020 2020 2020 2020 2073 7368 5f70 726f           ssh_pro
-00008770: 7879 5f63 6f6d 6d61 6e64 5f63 6f6e 6669  xy_command_confi
-00008780: 6720 6973 204e 6f6e 6529 3a0a 2020 2020  g is None):.    
-00008790: 2020 2020 7373 685f 7072 6f78 795f 636f      ssh_proxy_co
-000087a0: 6d6d 616e 6420 3d20 7373 685f 7072 6f78  mmand = ssh_prox
-000087b0: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
-000087c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000087d0: 2020 2023 2073 7368 5f70 726f 7879 5f63     # ssh_proxy_c
-000087e0: 6f6d 6d61 6e64 5f63 6f6e 6669 673a 2044  ommand_config: D
-000087f0: 6963 745b 7374 722c 2073 7472 5d2c 2072  ict[str, str], r
-00008800: 6567 696f 6e5f 6e61 6d65 202d 3e20 636f  egion_name -> co
-00008810: 6d6d 616e 640a 2020 2020 2020 2020 2320  mmand.        # 
-00008820: 5468 6973 2074 7970 6520 6368 6563 6b20  This type check 
-00008830: 6973 2064 6f6e 6520 6279 2073 6b79 7069  is done by skypi
-00008840: 6c6f 745f 636f 6e66 6967 2061 7420 636f  lot_config at co
-00008850: 6e66 6967 206c 6f61 6420 7469 6d65 2e0a  nfig load time..
-00008860: 0a20 2020 2020 2020 2023 2054 6865 7265  .        # There
-00008870: 2061 7265 2074 776f 2063 6173 6573 3a0a   are two cases:.
-00008880: 2020 2020 2020 2020 6966 206b 6565 705f          if keep_
-00008890: 6c61 756e 6368 5f66 6965 6c64 735f 696e  launch_fields_in
-000088a0: 5f65 7869 7374 696e 675f 636f 6e66 6967  _existing_config
-000088b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000088c0: 2831 2920 5765 2772 6520 7265 2d70 726f  (1) We're re-pro
-000088d0: 7669 7369 6f6e 696e 6720 616e 2065 7869  visioning an exi
-000088e0: 7374 696e 6720 636c 7573 7465 722e 0a20  sting cluster.. 
-000088f0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
-00008900: 2020 2020 2020 2020 2023 2057 6520 7573           # We us
-00008910: 6520 4e6f 6e65 2066 6f72 2073 7368 5f70  e None for ssh_p
-00008920: 726f 7879 5f63 6f6d 6d61 6e64 2c20 7768  roxy_command, wh
-00008930: 6963 6820 7769 6c6c 2062 6520 7265 7374  ich will be rest
-00008940: 6f72 6564 2074 6f20 7468 650a 2020 2020  ored to the.    
-00008950: 2020 2020 2020 2020 2320 636c 7573 7465          # cluste
-00008960: 7227 7320 6f72 6967 696e 616c 2076 616c  r's original val
-00008970: 7565 206c 6174 6572 2062 7920 5f72 6570  ue later by _rep
-00008980: 6c61 6365 5f79 616d 6c5f 6469 6374 7328  lace_yaml_dicts(
-00008990: 292e 0a20 2020 2020 2020 2020 2020 2073  )..            s
-000089a0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-000089b0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000089c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000089d0: 2020 2320 2832 2920 5765 2772 6520 6c61    # (2) We're la
-000089e0: 756e 6368 696e 6720 6120 6e65 7720 636c  unching a new cl
-000089f0: 7573 7465 722e 0a20 2020 2020 2020 2020  uster..         
-00008a00: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
-00008a10: 2023 2052 6573 6f75 7263 6573 2e67 6574   # Resources.get
-00008a20: 5f76 616c 6964 5f72 6567 696f 6e73 5f66  _valid_regions_f
-00008a30: 6f72 5f6c 6175 6e63 6861 626c 6528 2920  or_launchable() 
-00008a40: 7265 7370 6563 7473 2074 6865 206b 6579  respects the key
-00008a50: 7320 2872 6567 696f 6e73 290a 2020 2020  s (regions).    
-00008a60: 2020 2020 2020 2020 2320 696e 2073 7368          # in ssh
-00008a70: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2069  _proxy_command i
-00008a80: 6e20 736b 7970 696c 6f74 5f63 6f6e 6669  n skypilot_confi
-00008a90: 672e 2053 6f20 6865 7265 2077 6520 6164  g. So here we ad
-00008aa0: 6420 616e 2061 7373 6572 742e 0a20 2020  d an assert..   
-00008ab0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00008ac0: 7265 6769 6f6e 5f6e 616d 6520 696e 2073  region_name in s
-00008ad0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-00008ae0: 5f63 6f6e 6669 672c 2028 0a20 2020 2020  _config, (.     
-00008af0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-00008b00: 6e5f 6e61 6d65 2c20 7373 685f 7072 6f78  n_name, ssh_prox
-00008b10: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
-00008b20: 290a 2020 2020 2020 2020 2020 2020 7373  ).            ss
-00008b30: 685f 7072 6f78 795f 636f 6d6d 616e 6420  h_proxy_command 
-00008b40: 3d20 7373 685f 7072 6f78 795f 636f 6d6d  = ssh_proxy_comm
-00008b50: 616e 645f 636f 6e66 6967 5b72 6567 696f  and_config[regio
-00008b60: 6e5f 6e61 6d65 5d0a 2020 2020 6c6f 6767  n_name].    logg
-00008b70: 6572 2e64 6562 7567 2866 2755 7369 6e67  er.debug(f'Using
-00008b80: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
-00008b90: 6e64 3a20 7b73 7368 5f70 726f 7879 5f63  nd: {ssh_proxy_c
-00008ba0: 6f6d 6d61 6e64 2172 7d27 290a 0a20 2020  ommand!r}')..   
-00008bb0: 2023 2055 7365 722d 7375 7070 6c69 6564   # User-supplied
-00008bc0: 2067 6c6f 6261 6c20 696e 7374 616e 6365   global instance
-00008bd0: 2074 6167 7320 6672 6f6d 207e 2f2e 736b   tags from ~/.sk
-00008be0: 792f 636f 6e66 6967 2e79 616d 6c2e 0a20  y/config.yaml.. 
-00008bf0: 2020 206c 6162 656c 7320 3d20 736b 7970     labels = skyp
-00008c00: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
-00008c10: 6e65 7374 6564 2828 7374 7228 636c 6f75  nested((str(clou
-00008c20: 6429 2e6c 6f77 6572 2829 2c20 276c 6162  d).lower(), 'lab
-00008c30: 656c 7327 292c 207b 7d29 0a20 2020 2023  els'), {}).    #
-00008c40: 2044 6570 7265 6361 7465 643a 2069 6e73   Deprecated: ins
-00008c50: 7461 6e63 655f 7461 6773 2068 6176 6520  tance_tags have 
-00008c60: 6265 656e 2072 6570 6c61 6365 6420 6279  been replaced by
-00008c70: 206c 6162 656c 732e 2046 6f72 2062 6163   labels. For bac
-00008c80: 6b77 6172 640a 2020 2020 2320 636f 6d70  kward.    # comp
-00008c90: 6174 6962 696c 6974 792c 2077 6520 7375  atibility, we su
-00008ca0: 7070 6f72 7420 7468 656d 2061 6e64 2074  pport them and t
-00008cb0: 6865 2073 6368 656d 6120 616c 6c6f 7773  he schema allows
-00008cc0: 2074 6865 6d20 6f6e 6c79 2069 660a 2020   them only if.  
-00008cd0: 2020 2320 606c 6162 656c 7360 2061 7265    # `labels` are
-00008ce0: 206e 6f74 2073 7065 6369 6669 6564 2e20   not specified. 
-00008cf0: 5468 6973 2073 686f 756c 6420 6265 2072  This should be r
-00008d00: 656d 6f76 6564 2061 6674 6572 2030 2e37  emoved after 0.7
-00008d10: 2e30 2e0a 2020 2020 6c61 6265 6c73 203d  .0..    labels =
-00008d20: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
-00008d30: 2e67 6574 5f6e 6573 7465 6428 2873 7472  .get_nested((str
-00008d40: 2863 6c6f 7564 292e 6c6f 7765 7228 292c  (cloud).lower(),
-00008d50: 2027 696e 7374 616e 6365 5f74 6167 7327   'instance_tags'
-00008d60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00008d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d80: 2020 2020 2020 2020 2020 206c 6162 656c             label
-00008d90: 7329 0a20 2020 2023 206c 6162 656c 7320  s).    # labels 
-00008da0: 6973 2061 2064 6963 742c 2077 6869 6368  is a dict, which
-00008db0: 2069 7320 6775 6172 616e 7465 6564 2062   is guaranteed b
-00008dc0: 7920 7468 6520 7479 7065 2063 6865 636b  y the type check
-00008dd0: 2069 6e0a 2020 2020 2320 7363 6865 6d61   in.    # schema
-00008de0: 732e 7079 0a20 2020 2061 7373 6572 7420  s.py.    assert 
-00008df0: 6973 696e 7374 616e 6365 286c 6162 656c  isinstance(label
-00008e00: 732c 2064 6963 7429 2c20 6c61 6265 6c73  s, dict), labels
-00008e10: 0a0a 2020 2020 2320 4765 7420 6c61 6265  ..    # Get labe
-00008e20: 6c73 2066 726f 6d20 7265 736f 7572 6365  ls from resource
-00008e30: 7320 616e 6420 6f76 6572 7269 6465 2066  s and override f
-00008e40: 726f 6d20 7468 6520 6c61 6265 6c73 2074  rom the labels t
-00008e50: 6f5f 7072 6f76 6973 696f 6e2e 0a20 2020  o_provision..   
-00008e60: 2069 6620 746f 5f70 726f 7669 7369 6f6e   if to_provision
-00008e70: 2e6c 6162 656c 733a 0a20 2020 2020 2020  .labels:.       
-00008e80: 206c 6162 656c 732e 7570 6461 7465 2874   labels.update(t
-00008e90: 6f5f 7072 6f76 6973 696f 6e2e 6c61 6265  o_provision.labe
-00008ea0: 6c73 290a 0a20 2020 2023 2044 756d 7020  ls)..    # Dump 
-00008eb0: 7468 6520 5261 7920 706f 7274 7320 746f  the Ray ports to
-00008ec0: 2061 2066 696c 6520 666f 7220 5261 7920   a file for Ray 
-00008ed0: 6a6f 6220 7375 626d 6973 7369 6f6e 0a20  job submission. 
-00008ee0: 2020 2064 756d 705f 706f 7274 5f63 6f6d     dump_port_com
-00008ef0: 6d61 6e64 203d 2028 0a20 2020 2020 2020  mand = (.       
-00008f00: 2066 277b 636f 6e73 7461 6e74 732e 534b   f'{constants.SK
-00008f10: 595f 5059 5448 4f4e 5f43 4d44 7d20 2d63  Y_PYTHON_CMD} -c
-00008f20: 205c 2769 6d70 6f72 7420 6a73 6f6e 2c20   \'import json, 
-00008f30: 6f73 3b20 6a73 6f6e 2e64 756d 7028 7b63  os; json.dump({c
-00008f40: 6f6e 7374 616e 7473 2e53 4b59 5f52 454d  onstants.SKY_REM
-00008f50: 4f54 455f 5241 595f 504f 5254 5f44 4943  OTE_RAY_PORT_DIC
-00008f60: 545f 5354 527d 2c20 270a 2020 2020 2020  T_STR}, '.      
-00008f70: 2020 6627 6f70 656e 286f 732e 7061 7468    f'open(os.path
-00008f80: 2e65 7870 616e 6475 7365 7228 227b 636f  .expanduser("{co
-00008f90: 6e73 7461 6e74 732e 534b 595f 5245 4d4f  nstants.SKY_REMO
-00008fa0: 5445 5f52 4159 5f50 4f52 545f 4649 4c45  TE_RAY_PORT_FILE
-00008fb0: 7d22 292c 2022 7722 2c20 656e 636f 6469  }"), "w", encodi
-00008fc0: 6e67 3d22 7574 662d 3822 2929 5c27 270a  ng="utf-8"))\''.
-00008fd0: 2020 2020 290a 0a20 2020 2023 2055 7365      )..    # Use
-00008fe0: 2061 2074 6d70 2066 696c 6520 7061 7468   a tmp file path
-00008ff0: 2074 6f20 6176 6f69 6420 696e 636f 6d70   to avoid incomp
-00009000: 6c65 7465 2059 414d 4c20 6669 6c65 2062  lete YAML file b
-00009010: 6569 6e67 2072 652d 7573 6564 2069 6e20  eing re-used in 
-00009020: 7468 650a 2020 2020 2320 6675 7475 7265  the.    # future
-00009030: 2e0a 2020 2020 746d 705f 7961 6d6c 5f70  ..    tmp_yaml_p
-00009040: 6174 6820 3d20 7961 6d6c 5f70 6174 6820  ath = yaml_path 
-00009050: 2b20 272e 746d 7027 0a20 2020 2063 6f6d  + '.tmp'.    com
-00009060: 6d6f 6e5f 7574 696c 732e 6669 6c6c 5f74  mon_utils.fill_t
-00009070: 656d 706c 6174 6528 0a20 2020 2020 2020  emplate(.       
-00009080: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
-00009090: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
-000090a0: 2020 6469 6374 280a 2020 2020 2020 2020    dict(.        
-000090b0: 2020 2020 7265 736f 7572 6365 735f 7661      resources_va
-000090c0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-000090d0: 2a2a 7b0a 2020 2020 2020 2020 2020 2020  **{.            
-000090e0: 2020 2020 2763 6c75 7374 6572 5f6e 616d      'cluster_nam
-000090f0: 655f 6f6e 5f63 6c6f 7564 273a 2063 6c75  e_on_cloud': clu
-00009100: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00009110: 7564 2c0a 2020 2020 2020 2020 2020 2020  ud,.            
-00009120: 2020 2020 276e 756d 5f6e 6f64 6573 273a      'num_nodes':
-00009130: 206e 756d 5f6e 6f64 6573 2c0a 2020 2020   num_nodes,.    
-00009140: 2020 2020 2020 2020 2020 2020 2764 6973              'dis
-00009150: 6b5f 7369 7a65 273a 2074 6f5f 7072 6f76  k_size': to_prov
-00009160: 6973 696f 6e2e 6469 736b 5f73 697a 652c  ision.disk_size,
-00009170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009180: 2023 2049 6620 7468 6520 6375 7272 656e   # If the curren
-00009190: 7420 636f 6465 2069 7320 7275 6e20 6279  t code is run by
-000091a0: 2063 6f6e 7472 6f6c 6c65 722c 2070 726f   controller, pro
-000091b0: 7061 6761 7465 2074 6865 2072 6561 6c0a  pagate the real.
-000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091d0: 2320 6361 6c6c 696e 6720 7573 6572 2077  # calling user w
-000091e0: 6869 6368 2073 686f 756c 6427 7665 2062  hich should've b
-000091f0: 6565 6e20 7061 7373 6564 2069 6e20 6173  een passed in as
-00009200: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00009210: 2020 2020 2023 2053 4b59 5049 4c4f 545f       # SKYPILOT_
-00009220: 5553 4552 2065 6e76 2076 6172 2028 7365  USER env var (se
-00009230: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00009240: 2020 2320 636f 6e74 726f 6c6c 6572 5f75    # controller_u
-00009250: 7469 6c73 2e73 6861 7265 645f 636f 6e74  tils.shared_cont
-00009260: 726f 6c6c 6572 5f76 6172 735f 746f 5f66  roller_vars_to_f
-00009270: 696c 6c28 292e 0a20 2020 2020 2020 2020  ill()..         
-00009280: 2020 2020 2020 2027 7573 6572 273a 2063         'user': c
-00009290: 6f6d 6d6f 6e5f 7574 696c 732e 6765 745f  ommon_utils.get_
-000092a0: 636c 6561 6e65 645f 7573 6572 6e61 6d65  cleaned_username
-000092b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000092c0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
-000092d0: 2e67 6574 2863 6f6e 7374 616e 7473 2e55  .get(constants.U
-000092e0: 5345 525f 454e 565f 5641 522c 2027 2729  SER_ENV_VAR, '')
-000092f0: 292c 0a0a 2020 2020 2020 2020 2020 2020  ),..            
-00009300: 2020 2020 2320 4e65 7477 6f72 6b69 6e67      # Networking
-00009310: 2063 6f6e 6669 6773 0a20 2020 2020 2020   configs.       
-00009320: 2020 2020 2020 2020 2027 7573 655f 696e           'use_in
-00009330: 7465 726e 616c 5f69 7073 273a 2073 6b79  ternal_ips': sky
-00009340: 7069 6c6f 745f 636f 6e66 6967 2e67 6574  pilot_config.get
-00009350: 5f6e 6573 7465 6428 0a20 2020 2020 2020  _nested(.       
-00009360: 2020 2020 2020 2020 2020 2020 2028 7374               (st
-00009370: 7228 636c 6f75 6429 2e6c 6f77 6572 2829  r(cloud).lower()
-00009380: 2c20 2775 7365 5f69 6e74 6572 6e61 6c5f  , 'use_internal_
-00009390: 6970 7327 292c 2046 616c 7365 292c 0a20  ips'), False),. 
-000093a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000093b0: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-000093c0: 6427 3a20 7373 685f 7072 6f78 795f 636f  d': ssh_proxy_co
-000093d0: 6d6d 616e 642c 0a20 2020 2020 2020 2020  mmand,.         
-000093e0: 2020 2020 2020 2027 7670 635f 6e61 6d65         'vpc_name
-000093f0: 273a 2073 6b79 7069 6c6f 745f 636f 6e66  ': skypilot_conf
-00009400: 6967 2e67 6574 5f6e 6573 7465 6428 0a20  ig.get_nested(. 
-00009410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009420: 2020 2028 7374 7228 636c 6f75 6429 2e6c     (str(cloud).l
-00009430: 6f77 6572 2829 2c20 2776 7063 5f6e 616d  ower(), 'vpc_nam
-00009440: 6527 292c 204e 6f6e 6529 2c0a 0a20 2020  e'), None),..   
-00009450: 2020 2020 2020 2020 2020 2020 2023 2055               # U
-00009460: 7365 722d 7375 7070 6c69 6564 206c 6162  ser-supplied lab
-00009470: 656c 732e 0a20 2020 2020 2020 2020 2020  els..           
-00009480: 2020 2020 2027 6c61 6265 6c73 273a 206c       'labels': l
-00009490: 6162 656c 732c 0a20 2020 2020 2020 2020  abels,.         
-000094a0: 2020 2020 2020 2023 2054 6865 2072 6573         # The res
-000094b0: 6572 7661 7469 6f6e 2070 6f6f 6c73 2074  ervation pools t
-000094c0: 6861 7420 7370 6563 6966 6965 6420 6279  hat specified by
-000094d0: 2074 6865 2075 7365 722e 2054 6869 7320   the user. This 
-000094e0: 6973 0a20 2020 2020 2020 2020 2020 2020  is.             
-000094f0: 2020 2023 2063 7572 7265 6e74 6c79 206f     # currently o
-00009500: 6e6c 7920 7573 6564 2062 7920 4743 502e  nly used by GCP.
-00009510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009520: 2027 7370 6563 6966 6963 5f72 6573 6572   'specific_reser
-00009530: 7661 7469 6f6e 7327 3a20 7370 6563 6966  vations': specif
-00009540: 6963 5f72 6573 6572 7661 7469 6f6e 732c  ic_reservations,
-00009550: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00009560: 2020 2320 436f 6e64 6120 7365 7475 700a    # Conda setup.
+00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008230: 2020 2072 6567 696f 6e2c 207a 6f6e 6573     region, zones
+00008240: 2c20 6472 7972 756e 290a 2020 2020 636f  , dryrun).    co
+00008250: 6e66 6967 5f64 6963 7420 3d20 7b7d 0a0a  nfig_dict = {}..
+00008260: 2020 2020 7370 6563 6966 6963 5f72 6573      specific_res
+00008270: 6572 7661 7469 6f6e 7320 3d20 7365 7428  ervations = set(
+00008280: 0a20 2020 2020 2020 2073 6b79 7069 6c6f  .        skypilo
+00008290: 745f 636f 6e66 6967 2e67 6574 5f6e 6573  t_config.get_nes
+000082a0: 7465 6428 0a20 2020 2020 2020 2020 2020  ted(.           
+000082b0: 2028 7374 7228 746f 5f70 726f 7669 7369   (str(to_provisi
+000082c0: 6f6e 2e63 6c6f 7564 292e 6c6f 7765 7228  on.cloud).lower(
+000082d0: 292c 2027 7370 6563 6966 6963 5f72 6573  ), 'specific_res
+000082e0: 6572 7661 7469 6f6e 7327 292c 2073 6574  ervations'), set
+000082f0: 2829 2929 0a0a 2020 2020 6173 7365 7274  ()))..    assert
+00008300: 2063 6c75 7374 6572 5f6e 616d 6520 6973   cluster_name is
+00008310: 206e 6f74 204e 6f6e 650a 2020 2020 6578   not None.    ex
+00008320: 636c 7564 6564 5f63 6c6f 7564 7320 3d20  cluded_clouds = 
+00008330: 5b5d 0a20 2020 2072 656d 6f74 655f 6964  [].    remote_id
+00008340: 656e 7469 7479 203d 2073 6b79 7069 6c6f  entity = skypilo
+00008350: 745f 636f 6e66 6967 2e67 6574 5f6e 6573  t_config.get_nes
+00008360: 7465 6428 0a20 2020 2020 2020 2028 7374  ted(.        (st
+00008370: 7228 636c 6f75 6429 2e6c 6f77 6572 2829  r(cloud).lower()
+00008380: 2c20 2772 656d 6f74 655f 6964 656e 7469  , 'remote_identi
+00008390: 7479 2729 2c20 274c 4f43 414c 5f43 5245  ty'), 'LOCAL_CRE
+000083a0: 4445 4e54 4941 4c53 2729 0a20 2020 2069  DENTIALS').    i
+000083b0: 6620 7265 6d6f 7465 5f69 6465 6e74 6974  f remote_identit
+000083c0: 7920 6973 206e 6f74 204e 6f6e 6520 616e  y is not None an
+000083d0: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
+000083e0: 2872 656d 6f74 655f 6964 656e 7469 7479  (remote_identity
+000083f0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00008400: 666f 7220 7072 6f66 696c 6520 696e 2072  for profile in r
+00008410: 656d 6f74 655f 6964 656e 7469 7479 3a0a  emote_identity:.
+00008420: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00008430: 6e6d 6174 6368 2e66 6e6d 6174 6368 6361  nmatch.fnmatchca
+00008440: 7365 2863 6c75 7374 6572 5f6e 616d 652c  se(cluster_name,
+00008450: 206c 6973 7428 7072 6f66 696c 652e 6b65   list(profile.ke
+00008460: 7973 2829 295b 305d 293a 0a20 2020 2020  ys())[0]):.     
+00008470: 2020 2020 2020 2020 2020 2072 656d 6f74             remot
+00008480: 655f 6964 656e 7469 7479 203d 206c 6973  e_identity = lis
+00008490: 7428 7072 6f66 696c 652e 7661 6c75 6573  t(profile.values
+000084a0: 2829 295b 305d 0a20 2020 2020 2020 2020  ())[0].         
+000084b0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+000084c0: 2069 6620 7265 6d6f 7465 5f69 6465 6e74   if remote_ident
+000084d0: 6974 7920 213d 2027 4c4f 4341 4c5f 4352  ity != 'LOCAL_CR
+000084e0: 4544 454e 5449 414c 5327 3a0a 2020 2020  EDENTIALS':.    
+000084f0: 2020 2020 6966 206e 6f74 2063 6c6f 7564      if not cloud
+00008500: 2e73 7570 706f 7274 735f 7365 7276 6963  .supports_servic
+00008510: 655f 6163 636f 756e 745f 6f6e 5f72 656d  e_account_on_rem
+00008520: 6f74 6528 293a 0a20 2020 2020 2020 2020  ote():.         
+00008530: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00008540: 6f6e 732e 496e 7661 6c69 6443 6c6f 7564  ons.InvalidCloud
+00008550: 436f 6e66 6967 7328 0a20 2020 2020 2020  Configs(.       
+00008560: 2020 2020 2020 2020 2027 7265 6d6f 7465           'remote
+00008570: 5f69 6465 6e74 6974 793a 2053 4552 5649  _identity: SERVI
+00008580: 4345 5f41 4343 4f55 4e54 2069 7320 7370  CE_ACCOUNT is sp
+00008590: 6563 6966 6965 6420 696e 2027 0a20 2020  ecified in '.   
+000085a0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+000085b0: 736b 7970 696c 6f74 5f63 6f6e 6669 672e  skypilot_config.
+000085c0: 6c6f 6164 6564 5f63 6f6e 6669 675f 7061  loaded_config_pa
+000085d0: 7468 2172 7d20 666f 7220 7b63 6c6f 7564  th!r} for {cloud
+000085e0: 7d2c 2062 7574 2069 7420 270a 2020 2020  }, but it '.    
+000085f0: 2020 2020 2020 2020 2020 2020 2769 7320              'is 
+00008600: 6e6f 7420 7375 7070 6f72 7465 6420 6279  not supported by
+00008610: 2074 6869 7320 636c 6f75 642e 2052 656d   this cloud. Rem
+00008620: 6f76 6520 7468 6520 636f 6e66 6967 206f  ove the config o
+00008630: 7220 7365 743a 2027 0a20 2020 2020 2020  r set: '.       
+00008640: 2020 2020 2020 2020 2027 6072 656d 6f74           '`remot
+00008650: 655f 6964 656e 7469 7479 3a20 4c4f 4341  e_identity: LOCA
+00008660: 4c5f 4352 4544 454e 5449 414c 5360 2e27  L_CREDENTIALS`.'
+00008670: 290a 2020 2020 2020 2020 6578 636c 7564  ).        exclud
+00008680: 6564 5f63 6c6f 7564 7320 3d20 5b63 6c6f  ed_clouds = [clo
+00008690: 7564 5d0a 2020 2020 6372 6564 656e 7469  ud].    credenti
+000086a0: 616c 7320 3d20 736b 795f 6368 6563 6b2e  als = sky_check.
+000086b0: 6765 745f 636c 6f75 645f 6372 6564 656e  get_cloud_creden
+000086c0: 7469 616c 5f66 696c 655f 6d6f 756e 7473  tial_file_mounts
+000086d0: 2865 7863 6c75 6465 645f 636c 6f75 6473  (excluded_clouds
+000086e0: 290a 0a20 2020 2061 7574 685f 636f 6e66  )..    auth_conf
+000086f0: 6967 203d 207b 2773 7368 5f70 7269 7661  ig = {'ssh_priva
+00008700: 7465 5f6b 6579 273a 2061 7574 682e 5052  te_key': auth.PR
+00008710: 4956 4154 455f 5353 485f 4b45 595f 5041  IVATE_SSH_KEY_PA
+00008720: 5448 7d0a 2020 2020 7265 6769 6f6e 5f6e  TH}.    region_n
+00008730: 616d 6520 3d20 7265 736f 7572 6365 735f  ame = resources_
+00008740: 7661 7273 2e67 6574 2827 7265 6769 6f6e  vars.get('region
+00008750: 2729 0a0a 2020 2020 7961 6d6c 5f70 6174  ')..    yaml_pat
+00008760: 6820 3d20 5f67 6574 5f79 616d 6c5f 7061  h = _get_yaml_pa
+00008770: 7468 5f66 726f 6d5f 636c 7573 7465 725f  th_from_cluster_
+00008780: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00008790: 6529 0a0a 2020 2020 2320 5265 7472 6965  e)..    # Retrie
+000087a0: 7665 2074 6865 2073 7368 5f70 726f 7879  ve the ssh_proxy
+000087b0: 5f63 6f6d 6d61 6e64 2066 6f72 2074 6865  _command for the
+000087c0: 2067 6976 656e 2063 6c6f 7564 202f 2072   given cloud / r
+000087d0: 6567 696f 6e2e 0a20 2020 2073 7368 5f70  egion..    ssh_p
+000087e0: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
+000087f0: 6669 6720 3d20 736b 7970 696c 6f74 5f63  fig = skypilot_c
+00008800: 6f6e 6669 672e 6765 745f 6e65 7374 6564  onfig.get_nested
+00008810: 280a 2020 2020 2020 2020 2873 7472 2863  (.        (str(c
+00008820: 6c6f 7564 292e 6c6f 7765 7228 292c 2027  loud).lower(), '
+00008830: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
+00008840: 6427 292c 204e 6f6e 6529 0a20 2020 2069  d'), None).    i
+00008850: 6620 2869 7369 6e73 7461 6e63 6528 7373  f (isinstance(ss
+00008860: 685f 7072 6f78 795f 636f 6d6d 616e 645f  h_proxy_command_
+00008870: 636f 6e66 6967 2c20 7374 7229 206f 720a  config, str) or.
+00008880: 2020 2020 2020 2020 2020 2020 7373 685f              ssh_
+00008890: 7072 6f78 795f 636f 6d6d 616e 645f 636f  proxy_command_co
+000088a0: 6e66 6967 2069 7320 4e6f 6e65 293a 0a20  nfig is None):. 
+000088b0: 2020 2020 2020 2073 7368 5f70 726f 7879         ssh_proxy
+000088c0: 5f63 6f6d 6d61 6e64 203d 2073 7368 5f70  _command = ssh_p
+000088d0: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
+000088e0: 6669 670a 2020 2020 656c 7365 3a0a 2020  fig.    else:.  
+000088f0: 2020 2020 2020 2320 7373 685f 7072 6f78        # ssh_prox
+00008900: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
+00008910: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
+00008920: 2c20 7265 6769 6f6e 5f6e 616d 6520 2d3e  , region_name ->
+00008930: 2063 6f6d 6d61 6e64 0a20 2020 2020 2020   command.       
+00008940: 2023 2054 6869 7320 7479 7065 2063 6865   # This type che
+00008950: 636b 2069 7320 646f 6e65 2062 7920 736b  ck is done by sk
+00008960: 7970 696c 6f74 5f63 6f6e 6669 6720 6174  ypilot_config at
+00008970: 2063 6f6e 6669 6720 6c6f 6164 2074 696d   config load tim
+00008980: 652e 0a0a 2020 2020 2020 2020 2320 5468  e...        # Th
+00008990: 6572 6520 6172 6520 7477 6f20 6361 7365  ere are two case
+000089a0: 733a 0a20 2020 2020 2020 2069 6620 6b65  s:.        if ke
+000089b0: 6570 5f6c 6175 6e63 685f 6669 656c 6473  ep_launch_fields
+000089c0: 5f69 6e5f 6578 6973 7469 6e67 5f63 6f6e  _in_existing_con
+000089d0: 6669 673a 0a20 2020 2020 2020 2020 2020  fig:.           
+000089e0: 2023 2028 3129 2057 6527 7265 2072 652d   # (1) We're re-
+000089f0: 7072 6f76 6973 696f 6e69 6e67 2061 6e20  provisioning an 
+00008a00: 6578 6973 7469 6e67 2063 6c75 7374 6572  existing cluster
+00008a10: 2e0a 2020 2020 2020 2020 2020 2020 230a  ..            #.
+00008a20: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00008a30: 2075 7365 204e 6f6e 6520 666f 7220 7373   use None for ss
+00008a40: 685f 7072 6f78 795f 636f 6d6d 616e 642c  h_proxy_command,
+00008a50: 2077 6869 6368 2077 696c 6c20 6265 2072   which will be r
+00008a60: 6573 746f 7265 6420 746f 2074 6865 0a20  estored to the. 
+00008a70: 2020 2020 2020 2020 2020 2023 2063 6c75             # clu
+00008a80: 7374 6572 2773 206f 7269 6769 6e61 6c20  ster's original 
+00008a90: 7661 6c75 6520 6c61 7465 7220 6279 205f  value later by _
+00008aa0: 7265 706c 6163 655f 7961 6d6c 5f64 6963  replace_yaml_dic
+00008ab0: 7473 2829 2e0a 2020 2020 2020 2020 2020  ts()..          
+00008ac0: 2020 7373 685f 7072 6f78 795f 636f 6d6d    ssh_proxy_comm
+00008ad0: 616e 6420 3d20 4e6f 6e65 0a20 2020 2020  and = None.     
+00008ae0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00008af0: 2020 2020 2023 2028 3229 2057 6527 7265       # (2) We're
+00008b00: 206c 6175 6e63 6869 6e67 2061 206e 6577   launching a new
+00008b10: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00008b20: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00008b30: 2020 2020 2320 5265 736f 7572 6365 732e      # Resources.
+00008b40: 6765 745f 7661 6c69 645f 7265 6769 6f6e  get_valid_region
+00008b50: 735f 666f 725f 6c61 756e 6368 6162 6c65  s_for_launchable
+00008b60: 2829 2072 6573 7065 6374 7320 7468 6520  () respects the 
+00008b70: 6b65 7973 2028 7265 6769 6f6e 7329 0a20  keys (regions). 
+00008b80: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
+00008b90: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
+00008ba0: 6420 696e 2073 6b79 7069 6c6f 745f 636f  d in skypilot_co
+00008bb0: 6e66 6967 2e20 536f 2068 6572 6520 7765  nfig. So here we
+00008bc0: 2061 6464 2061 6e20 6173 7365 7274 2e0a   add an assert..
+00008bd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00008be0: 7274 2072 6567 696f 6e5f 6e61 6d65 2069  rt region_name i
+00008bf0: 6e20 7373 685f 7072 6f78 795f 636f 6d6d  n ssh_proxy_comm
+00008c00: 616e 645f 636f 6e66 6967 2c20 280a 2020  and_config, (.  
+00008c10: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00008c20: 6769 6f6e 5f6e 616d 652c 2073 7368 5f70  gion_name, ssh_p
+00008c30: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
+00008c40: 6669 6729 0a20 2020 2020 2020 2020 2020  fig).           
+00008c50: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00008c60: 6e64 203d 2073 7368 5f70 726f 7879 5f63  nd = ssh_proxy_c
+00008c70: 6f6d 6d61 6e64 5f63 6f6e 6669 675b 7265  ommand_config[re
+00008c80: 6769 6f6e 5f6e 616d 655d 0a20 2020 206c  gion_name].    l
+00008c90: 6f67 6765 722e 6465 6275 6728 6627 5573  ogger.debug(f'Us
+00008ca0: 696e 6720 7373 685f 7072 6f78 795f 636f  ing ssh_proxy_co
+00008cb0: 6d6d 616e 643a 207b 7373 685f 7072 6f78  mmand: {ssh_prox
+00008cc0: 795f 636f 6d6d 616e 6421 727d 2729 0a0a  y_command!r}')..
+00008cd0: 2020 2020 2320 5573 6572 2d73 7570 706c      # User-suppl
+00008ce0: 6965 6420 676c 6f62 616c 2069 6e73 7461  ied global insta
+00008cf0: 6e63 6520 7461 6773 2066 726f 6d20 7e2f  nce tags from ~/
+00008d00: 2e73 6b79 2f63 6f6e 6669 672e 7961 6d6c  .sky/config.yaml
+00008d10: 2e0a 2020 2020 6c61 6265 6c73 203d 2073  ..    labels = s
+00008d20: 6b79 7069 6c6f 745f 636f 6e66 6967 2e67  kypilot_config.g
+00008d30: 6574 5f6e 6573 7465 6428 2873 7472 2863  et_nested((str(c
+00008d40: 6c6f 7564 292e 6c6f 7765 7228 292c 2027  loud).lower(), '
+00008d50: 6c61 6265 6c73 2729 2c20 7b7d 290a 2020  labels'), {}).  
+00008d60: 2020 2320 4465 7072 6563 6174 6564 3a20    # Deprecated: 
+00008d70: 696e 7374 616e 6365 5f74 6167 7320 6861  instance_tags ha
+00008d80: 7665 2062 6565 6e20 7265 706c 6163 6564  ve been replaced
+00008d90: 2062 7920 6c61 6265 6c73 2e20 466f 7220   by labels. For 
+00008da0: 6261 636b 7761 7264 0a20 2020 2023 2063  backward.    # c
+00008db0: 6f6d 7061 7469 6269 6c69 7479 2c20 7765  ompatibility, we
+00008dc0: 2073 7570 706f 7274 2074 6865 6d20 616e   support them an
+00008dd0: 6420 7468 6520 7363 6865 6d61 2061 6c6c  d the schema all
+00008de0: 6f77 7320 7468 656d 206f 6e6c 7920 6966  ows them only if
+00008df0: 0a20 2020 2023 2060 6c61 6265 6c73 6020  .    # `labels` 
+00008e00: 6172 6520 6e6f 7420 7370 6563 6966 6965  are not specifie
+00008e10: 642e 2054 6869 7320 7368 6f75 6c64 2062  d. This should b
+00008e20: 6520 7265 6d6f 7665 6420 6166 7465 7220  e removed after 
+00008e30: 302e 372e 302e 0a20 2020 206c 6162 656c  0.7.0..    label
+00008e40: 7320 3d20 736b 7970 696c 6f74 5f63 6f6e  s = skypilot_con
+00008e50: 6669 672e 6765 745f 6e65 7374 6564 2828  fig.get_nested((
+00008e60: 7374 7228 636c 6f75 6429 2e6c 6f77 6572  str(cloud).lower
+00008e70: 2829 2c20 2769 6e73 7461 6e63 655f 7461  (), 'instance_ta
+00008e80: 6773 2729 2c0a 2020 2020 2020 2020 2020  gs'),.          
+00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ea0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00008eb0: 6265 6c73 290a 2020 2020 2320 6c61 6265  bels).    # labe
+00008ec0: 6c73 2069 7320 6120 6469 6374 2c20 7768  ls is a dict, wh
+00008ed0: 6963 6820 6973 2067 7561 7261 6e74 6565  ich is guarantee
+00008ee0: 6420 6279 2074 6865 2074 7970 6520 6368  d by the type ch
+00008ef0: 6563 6b20 696e 0a20 2020 2023 2073 6368  eck in.    # sch
+00008f00: 656d 6173 2e70 790a 2020 2020 6173 7365  emas.py.    asse
+00008f10: 7274 2069 7369 6e73 7461 6e63 6528 6c61  rt isinstance(la
+00008f20: 6265 6c73 2c20 6469 6374 292c 206c 6162  bels, dict), lab
+00008f30: 656c 730a 0a20 2020 2023 2047 6574 206c  els..    # Get l
+00008f40: 6162 656c 7320 6672 6f6d 2072 6573 6f75  abels from resou
+00008f50: 7263 6573 2061 6e64 206f 7665 7272 6964  rces and overrid
+00008f60: 6520 6672 6f6d 2074 6865 206c 6162 656c  e from the label
+00008f70: 7320 746f 5f70 726f 7669 7369 6f6e 2e0a  s to_provision..
+00008f80: 2020 2020 6966 2074 6f5f 7072 6f76 6973      if to_provis
+00008f90: 696f 6e2e 6c61 6265 6c73 3a0a 2020 2020  ion.labels:.    
+00008fa0: 2020 2020 6c61 6265 6c73 2e75 7064 6174      labels.updat
+00008fb0: 6528 746f 5f70 726f 7669 7369 6f6e 2e6c  e(to_provision.l
+00008fc0: 6162 656c 7329 0a0a 2020 2020 2320 4475  abels)..    # Du
+00008fd0: 6d70 2074 6865 2052 6179 2070 6f72 7473  mp the Ray ports
+00008fe0: 2074 6f20 6120 6669 6c65 2066 6f72 2052   to a file for R
+00008ff0: 6179 206a 6f62 2073 7562 6d69 7373 696f  ay job submissio
+00009000: 6e0a 2020 2020 6475 6d70 5f70 6f72 745f  n.    dump_port_
+00009010: 636f 6d6d 616e 6420 3d20 280a 2020 2020  command = (.    
+00009020: 2020 2020 6627 7b63 6f6e 7374 616e 7473      f'{constants
+00009030: 2e53 4b59 5f50 5954 484f 4e5f 434d 447d  .SKY_PYTHON_CMD}
+00009040: 202d 6320 5c27 696d 706f 7274 206a 736f   -c \'import jso
+00009050: 6e2c 206f 733b 206a 736f 6e2e 6475 6d70  n, os; json.dump
+00009060: 287b 636f 6e73 7461 6e74 732e 534b 595f  ({constants.SKY_
+00009070: 5245 4d4f 5445 5f52 4159 5f50 4f52 545f  REMOTE_RAY_PORT_
+00009080: 4449 4354 5f53 5452 7d2c 2027 0a20 2020  DICT_STR}, '.   
+00009090: 2020 2020 2066 276f 7065 6e28 6f73 2e70       f'open(os.p
+000090a0: 6174 682e 6578 7061 6e64 7573 6572 2822  ath.expanduser("
+000090b0: 7b63 6f6e 7374 616e 7473 2e53 4b59 5f52  {constants.SKY_R
+000090c0: 454d 4f54 455f 5241 595f 504f 5254 5f46  EMOTE_RAY_PORT_F
+000090d0: 494c 457d 2229 2c20 2277 222c 2065 6e63  ILE}"), "w", enc
+000090e0: 6f64 696e 673d 2275 7466 2d38 2229 295c  oding="utf-8"))\
+000090f0: 2727 0a20 2020 2029 0a0a 2020 2020 2320  ''.    )..    # 
+00009100: 5573 6520 6120 746d 7020 6669 6c65 2070  Use a tmp file p
+00009110: 6174 6820 746f 2061 766f 6964 2069 6e63  ath to avoid inc
+00009120: 6f6d 706c 6574 6520 5941 4d4c 2066 696c  omplete YAML fil
+00009130: 6520 6265 696e 6720 7265 2d75 7365 6420  e being re-used 
+00009140: 696e 2074 6865 0a20 2020 2023 2066 7574  in the.    # fut
+00009150: 7572 652e 0a20 2020 2074 6d70 5f79 616d  ure..    tmp_yam
+00009160: 6c5f 7061 7468 203d 2079 616d 6c5f 7061  l_path = yaml_pa
+00009170: 7468 202b 2027 2e74 6d70 270a 2020 2020  th + '.tmp'.    
+00009180: 636f 6d6d 6f6e 5f75 7469 6c73 2e66 696c  common_utils.fil
+00009190: 6c5f 7465 6d70 6c61 7465 280a 2020 2020  l_template(.    
+000091a0: 2020 2020 636c 7573 7465 725f 636f 6e66      cluster_conf
+000091b0: 6967 5f74 656d 706c 6174 652c 0a20 2020  ig_template,.   
+000091c0: 2020 2020 2064 6963 7428 0a20 2020 2020       dict(.     
+000091d0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+000091e0: 5f76 6172 732c 0a20 2020 2020 2020 2020  _vars,.         
+000091f0: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
+00009200: 2020 2020 2020 2027 636c 7573 7465 725f         'cluster_
+00009210: 6e61 6d65 5f6f 6e5f 636c 6f75 6427 3a20  name_on_cloud': 
+00009220: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+00009230: 636c 6f75 642c 0a20 2020 2020 2020 2020  cloud,.         
+00009240: 2020 2020 2020 2027 6e75 6d5f 6e6f 6465         'num_node
+00009250: 7327 3a20 6e75 6d5f 6e6f 6465 732c 0a20  s': num_nodes,. 
+00009260: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009270: 6469 736b 5f73 697a 6527 3a20 746f 5f70  disk_size': to_p
+00009280: 726f 7669 7369 6f6e 2e64 6973 6b5f 7369  rovision.disk_si
+00009290: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+000092a0: 2020 2020 2320 4966 2074 6865 2063 7572      # If the cur
+000092b0: 7265 6e74 2063 6f64 6520 6973 2072 756e  rent code is run
+000092c0: 2062 7920 636f 6e74 726f 6c6c 6572 2c20   by controller, 
+000092d0: 7072 6f70 6167 6174 6520 7468 6520 7265  propagate the re
+000092e0: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
+000092f0: 2020 2023 2063 616c 6c69 6e67 2075 7365     # calling use
+00009300: 7220 7768 6963 6820 7368 6f75 6c64 2776  r which should'v
+00009310: 6520 6265 656e 2070 6173 7365 6420 696e  e been passed in
+00009320: 2061 7320 7468 650a 2020 2020 2020 2020   as the.        
+00009330: 2020 2020 2020 2020 2320 534b 5950 494c          # SKYPIL
+00009340: 4f54 5f55 5345 5220 656e 7620 7661 7220  OT_USER env var 
+00009350: 2873 6565 0a20 2020 2020 2020 2020 2020  (see.           
+00009360: 2020 2020 2023 2063 6f6e 7472 6f6c 6c65       # controlle
+00009370: 725f 7574 696c 732e 7368 6172 6564 5f63  r_utils.shared_c
+00009380: 6f6e 7472 6f6c 6c65 725f 7661 7273 5f74  ontroller_vars_t
+00009390: 6f5f 6669 6c6c 2829 2e0a 2020 2020 2020  o_fill()..      
+000093a0: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
+000093b0: 3a20 636f 6d6d 6f6e 5f75 7469 6c73 2e67  : common_utils.g
+000093c0: 6574 5f63 6c65 616e 6564 5f75 7365 726e  et_cleaned_usern
+000093d0: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
+000093e0: 2020 2020 2020 2020 206f 732e 656e 7669           os.envi
+000093f0: 726f 6e2e 6765 7428 636f 6e73 7461 6e74  ron.get(constant
+00009400: 732e 5553 4552 5f45 4e56 5f56 4152 2c20  s.USER_ENV_VAR, 
+00009410: 2727 2929 2c0a 0a20 2020 2020 2020 2020  '')),..         
+00009420: 2020 2020 2020 2023 204e 6574 776f 726b         # Network
+00009430: 696e 6720 636f 6e66 6967 730a 2020 2020  ing configs.    
+00009440: 2020 2020 2020 2020 2020 2020 2775 7365              'use
+00009450: 5f69 6e74 6572 6e61 6c5f 6970 7327 3a20  _internal_ips': 
+00009460: 736b 7970 696c 6f74 5f63 6f6e 6669 672e  skypilot_config.
+00009470: 6765 745f 6e65 7374 6564 280a 2020 2020  get_nested(.    
+00009480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009490: 2873 7472 2863 6c6f 7564 292e 6c6f 7765  (str(cloud).lowe
+000094a0: 7228 292c 2027 7573 655f 696e 7465 726e  r(), 'use_intern
+000094b0: 616c 5f69 7073 2729 2c20 4661 6c73 6529  al_ips'), False)
+000094c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000094d0: 2020 2773 7368 5f70 726f 7879 5f63 6f6d    'ssh_proxy_com
+000094e0: 6d61 6e64 273a 2073 7368 5f70 726f 7879  mand': ssh_proxy
+000094f0: 5f63 6f6d 6d61 6e64 2c0a 2020 2020 2020  _command,.      
+00009500: 2020 2020 2020 2020 2020 2776 7063 5f6e            'vpc_n
+00009510: 616d 6527 3a20 736b 7970 696c 6f74 5f63  ame': skypilot_c
+00009520: 6f6e 6669 672e 6765 745f 6e65 7374 6564  onfig.get_nested
+00009530: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009540: 2020 2020 2020 2873 7472 2863 6c6f 7564        (str(cloud
+00009550: 292e 6c6f 7765 7228 292c 2027 7670 635f  ).lower(), 'vpc_
+00009560: 6e61 6d65 2729 2c20 4e6f 6e65 292c 0a0a  name'), None),..
 00009570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009580: 2763 6f6e 6461 5f69 6e73 7461 6c6c 6174  'conda_installat
-00009590: 696f 6e5f 636f 6d6d 616e 6473 273a 0a20  ion_commands':. 
-000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095b0: 2020 2063 6f6e 7374 616e 7473 2e43 4f4e     constants.CON
-000095c0: 4441 5f49 4e53 5441 4c4c 4154 494f 4e5f  DA_INSTALLATION_
-000095d0: 434f 4d4d 414e 4453 2c0a 2020 2020 2020  COMMANDS,.      
-000095e0: 2020 2020 2020 2020 2020 2320 5765 2073            # We s
-000095f0: 686f 756c 6420 6e6f 7420 7573 6520 602e  hould not use `.
-00009600: 666f 726d 6174 602c 2061 7320 6974 2063  format`, as it c
-00009610: 6f6e 7461 696e 7320 277b 7d27 2061 7320  ontains '{}' as 
-00009620: 7468 6520 6261 7368 0a20 2020 2020 2020  the bash.       
-00009630: 2020 2020 2020 2020 2023 2073 796e 7461           # synta
-00009640: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
-00009650: 2020 2027 7261 795f 736b 7970 696c 6f74     'ray_skypilot
-00009660: 5f69 6e73 7461 6c6c 6174 696f 6e5f 636f  _installation_co
-00009670: 6d6d 616e 6473 273a 0a20 2020 2020 2020  mmands':.       
-00009680: 2020 2020 2020 2020 2020 2020 2028 636f               (co
-00009690: 6e73 7461 6e74 732e 5241 595f 534b 5950  nstants.RAY_SKYP
-000096a0: 494c 4f54 5f49 4e53 5441 4c4c 4154 494f  ILOT_INSTALLATIO
-000096b0: 4e5f 434f 4d4d 414e 4453 2e72 6570 6c61  N_COMMANDS.repla
-000096c0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-000096d0: 2020 2020 2020 2020 2020 2020 277b 736b              '{sk
-000096e0: 795f 7768 6565 6c5f 6861 7368 7d27 2c0a  y_wheel_hash}',.
-000096f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009700: 2020 2020 2020 2020 7768 6565 6c5f 6861          wheel_ha
-00009710: 7368 292e 7265 706c 6163 6528 277b 636c  sh).replace('{cl
-00009720: 6f75 647d 272c 0a20 2020 2020 2020 2020  oud}',.         
-00009730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009750: 2020 2073 7472 2863 6c6f 7564 292e 6c6f     str(cloud).lo
-00009760: 7765 7228 2929 292c 0a0a 2020 2020 2020  wer())),..      
-00009770: 2020 2020 2020 2020 2020 2320 506f 7274            # Port
-00009780: 206f 6620 5261 7920 2847 4353 2073 6572   of Ray (GCS ser
-00009790: 7665 7229 2e0a 2020 2020 2020 2020 2020  ver)..          
-000097a0: 2020 2020 2020 2320 5261 7927 7320 6465        # Ray's de
-000097b0: 6661 756c 7420 706f 7274 2036 3337 3920  fault port 6379 
-000097c0: 6973 2063 6f6e 666c 6963 7465 6420 7769  is conflicted wi
-000097d0: 7468 2052 6564 6973 2e0a 2020 2020 2020  th Redis..      
-000097e0: 2020 2020 2020 2020 2020 2772 6179 5f70            'ray_p
-000097f0: 6f72 7427 3a20 636f 6e73 7461 6e74 732e  ort': constants.
-00009800: 534b 595f 5245 4d4f 5445 5f52 4159 5f50  SKY_REMOTE_RAY_P
-00009810: 4f52 542c 0a20 2020 2020 2020 2020 2020  ORT,.           
-00009820: 2020 2020 2027 7261 795f 6461 7368 626f       'ray_dashbo
-00009830: 6172 645f 706f 7274 273a 2063 6f6e 7374  ard_port': const
-00009840: 616e 7473 2e53 4b59 5f52 454d 4f54 455f  ants.SKY_REMOTE_
-00009850: 5241 595f 4441 5348 424f 4152 445f 504f  RAY_DASHBOARD_PO
-00009860: 5254 2c0a 2020 2020 2020 2020 2020 2020  RT,.            
-00009870: 2020 2020 2772 6179 5f74 656d 705f 6469      'ray_temp_di
-00009880: 7227 3a20 636f 6e73 7461 6e74 732e 534b  r': constants.SK
-00009890: 595f 5245 4d4f 5445 5f52 4159 5f54 454d  Y_REMOTE_RAY_TEM
-000098a0: 5044 4952 2c0a 2020 2020 2020 2020 2020  PDIR,.          
-000098b0: 2020 2020 2020 2764 756d 705f 706f 7274        'dump_port
-000098c0: 5f63 6f6d 6d61 6e64 273a 2064 756d 705f  _command': dump_
-000098d0: 706f 7274 5f63 6f6d 6d61 6e64 2c0a 2020  port_command,.  
-000098e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000098f0: 536b 792d 696e 7465 726e 616c 2063 6f6e  Sky-internal con
-00009900: 7374 616e 7473 2e0a 2020 2020 2020 2020  stants..        
-00009910: 2020 2020 2020 2020 2773 6b79 5f72 6179          'sky_ray
-00009920: 5f63 6d64 273a 2063 6f6e 7374 616e 7473  _cmd': constants
-00009930: 2e53 4b59 5f52 4159 5f43 4d44 2c0a 2020  .SKY_RAY_CMD,.  
-00009940: 2020 2020 2020 2020 2020 2020 2020 2773                's
-00009950: 6b79 5f70 6970 5f63 6d64 273a 2063 6f6e  ky_pip_cmd': con
-00009960: 7374 616e 7473 2e53 4b59 5f50 4950 5f43  stants.SKY_PIP_C
-00009970: 4d44 2c0a 2020 2020 2020 2020 2020 2020  MD,.            
-00009980: 2020 2020 2772 6179 5f76 6572 7369 6f6e      'ray_version
-00009990: 273a 2063 6f6e 7374 616e 7473 2e53 4b59  ': constants.SKY
-000099a0: 5f52 454d 4f54 455f 5241 595f 5645 5253  _REMOTE_RAY_VERS
-000099b0: 494f 4e2c 0a20 2020 2020 2020 2020 2020  ION,.           
-000099c0: 2020 2020 2023 2043 6f6d 6d61 6e64 2066       # Command f
-000099d0: 6f72 2077 6169 7469 6e67 2072 6179 2063  or waiting ray c
-000099e0: 6c75 7374 6572 2074 6f20 6265 2072 6561  luster to be rea
-000099f0: 6479 206f 6e20 6865 6164 2e0a 2020 2020  dy on head..    
-00009a00: 2020 2020 2020 2020 2020 2020 2772 6179              'ray
-00009a10: 5f68 6561 645f 7761 6974 5f69 6e69 7469  _head_wait_initi
-00009a20: 616c 697a 6564 5f63 6f6d 6d61 6e64 273a  alized_command':
-00009a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009a40: 2020 2020 2069 6e73 7461 6e63 655f 7365       instance_se
-00009a50: 7475 702e 5241 595f 4845 4144 5f57 4149  tup.RAY_HEAD_WAI
-00009a60: 545f 494e 4954 4941 4c49 5a45 445f 434f  T_INITIALIZED_CO
-00009a70: 4d4d 414e 442c 0a0a 2020 2020 2020 2020  MMAND,..        
-00009a80: 2020 2020 2020 2020 2320 436c 6f75 6420          # Cloud 
-00009a90: 6372 6564 656e 7469 616c 7320 666f 7220  credentials for 
-00009aa0: 636c 6f75 6420 7374 6f72 6167 652e 0a20  cloud storage.. 
-00009ab0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00009ac0: 6372 6564 656e 7469 616c 7327 3a20 6372  credentials': cr
-00009ad0: 6564 656e 7469 616c 732c 0a20 2020 2020  edentials,.     
-00009ae0: 2020 2020 2020 2020 2020 2023 2053 6b79             # Sky
-00009af0: 2072 656d 6f74 6520 7574 696c 732e 0a20   remote utils.. 
-00009b00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00009b10: 736b 795f 7265 6d6f 7465 5f70 6174 6827  sky_remote_path'
-00009b20: 3a20 534b 595f 5245 4d4f 5445 5f50 4154  : SKY_REMOTE_PAT
-00009b30: 482c 0a20 2020 2020 2020 2020 2020 2020  H,.             
-00009b40: 2020 2027 736b 795f 6c6f 6361 6c5f 7061     'sky_local_pa
-00009b50: 7468 273a 2073 7472 286c 6f63 616c 5f77  th': str(local_w
-00009b60: 6865 656c 5f70 6174 6829 2c0a 2020 2020  heel_path),.    
-00009b70: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-00009b80: 6420 7961 6d6c 2066 696c 6520 7061 7468  d yaml file path
-00009b90: 2074 6f20 7468 6520 7465 6d70 6c61 7465   to the template
-00009ba0: 2076 6172 6961 626c 6573 2e0a 2020 2020   variables..    
-00009bb0: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
-00009bc0: 5f72 6179 5f79 616d 6c5f 7265 6d6f 7465  _ray_yaml_remote
-00009bd0: 5f70 6174 6827 3a0a 2020 2020 2020 2020  _path':.        
-00009be0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00009bf0: 7465 725f 7961 6d6c 5f75 7469 6c73 2e53  ter_yaml_utils.S
-00009c00: 4b59 5f43 4c55 5354 4552 5f59 414d 4c5f  KY_CLUSTER_YAML_
-00009c10: 5245 4d4f 5445 5f50 4154 482c 0a20 2020  REMOTE_PATH,.   
-00009c20: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
-00009c30: 795f 7261 795f 7961 6d6c 5f6c 6f63 616c  y_ray_yaml_local
-00009c40: 5f70 6174 6827 3a20 746d 705f 7961 6d6c  _path': tmp_yaml
-00009c50: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00009c60: 2020 2020 2020 2027 736b 795f 7665 7273         'sky_vers
-00009c70: 696f 6e27 3a20 7374 7228 7665 7273 696f  ion': str(versio
-00009c80: 6e2e 7061 7273 6528 736b 792e 5f5f 7665  n.parse(sky.__ve
-00009c90: 7273 696f 6e5f 5f29 292c 0a20 2020 2020  rsion__)),.     
-00009ca0: 2020 2020 2020 2020 2020 2027 736b 795f             'sky_
-00009cb0: 7768 6565 6c5f 6861 7368 273a 2077 6865  wheel_hash': whe
-00009cc0: 656c 5f68 6173 682c 0a20 2020 2020 2020  el_hash,.       
-00009cd0: 2020 2020 2020 2020 2023 2041 7574 6865           # Authe
-00009ce0: 6e74 6963 6174 696f 6e20 286f 7074 696f  ntication (optio
-00009cf0: 6e61 6c29 2e0a 2020 2020 2020 2020 2020  nal)..          
-00009d00: 2020 2020 2020 2a2a 6175 7468 5f63 6f6e        **auth_con
-00009d10: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
-00009d20: 207d 292c 0a20 2020 2020 2020 206f 7574   }),.        out
-00009d30: 7075 745f 7061 7468 3d74 6d70 5f79 616d  put_path=tmp_yam
-00009d40: 6c5f 7061 7468 290a 2020 2020 636f 6e66  l_path).    conf
-00009d50: 6967 5f64 6963 745b 2763 6c75 7374 6572  ig_dict['cluster
-00009d60: 5f6e 616d 6527 5d20 3d20 636c 7573 7465  _name'] = cluste
-00009d70: 725f 6e61 6d65 0a20 2020 2063 6f6e 6669  r_name.    confi
-00009d80: 675f 6469 6374 5b27 7261 7927 5d20 3d20  g_dict['ray'] = 
-00009d90: 7961 6d6c 5f70 6174 680a 2020 2020 6966  yaml_path.    if
-00009da0: 2064 7279 7275 6e3a 0a20 2020 2020 2020   dryrun:.       
-00009db0: 2023 2049 6620 6472 7972 756e 2c20 7265   # If dryrun, re
-00009dc0: 7475 726e 2074 6865 2075 6e66 696e 6973  turn the unfinis
-00009dd0: 6865 6420 746d 7020 7961 6d6c 2070 6174  hed tmp yaml pat
-00009de0: 682e 0a20 2020 2020 2020 2063 6f6e 6669  h..        confi
-00009df0: 675f 6469 6374 5b27 7261 7927 5d20 3d20  g_dict['ray'] = 
-00009e00: 746d 705f 7961 6d6c 5f70 6174 680a 2020  tmp_yaml_path.  
-00009e10: 2020 2020 2020 7265 7475 726e 2063 6f6e        return con
-00009e20: 6669 675f 6469 6374 0a20 2020 205f 6164  fig_dict.    _ad
-00009e30: 645f 6175 7468 5f74 6f5f 636c 7573 7465  d_auth_to_cluste
-00009e40: 725f 636f 6e66 6967 2863 6c6f 7564 2c20  r_config(cloud, 
-00009e50: 746d 705f 7961 6d6c 5f70 6174 6829 0a0a  tmp_yaml_path)..
-00009e60: 2020 2020 2320 4164 6420 6b75 6265 726e      # Add kubern
-00009e70: 6574 6573 2063 6f6e 6669 6720 6669 656c  etes config fiel
-00009e80: 6473 2066 726f 6d20 7e2f 2e73 6b79 2f63  ds from ~/.sky/c
-00009e90: 6f6e 6669 670a 2020 2020 6966 2069 7369  onfig.    if isi
-00009ea0: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
-00009eb0: 6c6f 7564 732e 4b75 6265 726e 6574 6573  louds.Kubernetes
-00009ec0: 293a 0a20 2020 2020 2020 206b 7562 6572  ):.        kuber
-00009ed0: 6e65 7465 735f 7574 696c 732e 636f 6d62  netes_utils.comb
-00009ee0: 696e 655f 706f 645f 636f 6e66 6967 5f66  ine_pod_config_f
-00009ef0: 6965 6c64 7328 746d 705f 7961 6d6c 5f70  ields(tmp_yaml_p
-00009f00: 6174 6829 0a20 2020 2020 2020 206b 7562  ath).        kub
-00009f10: 6572 6e65 7465 735f 7574 696c 732e 636f  ernetes_utils.co
-00009f20: 6d62 696e 655f 6d65 7461 6461 7461 5f66  mbine_metadata_f
-00009f30: 6965 6c64 7328 746d 705f 7961 6d6c 5f70  ields(tmp_yaml_p
-00009f40: 6174 6829 0a0a 2020 2020 2320 5265 7374  ath)..    # Rest
-00009f50: 6f72 6520 7468 6520 6f6c 6420 7961 6d6c  ore the old yaml
-00009f60: 2063 6f6e 7465 6e74 2066 6f72 2062 6163   content for bac
-00009f70: 6b77 6172 6420 636f 6d70 6174 6962 696c  kward compatibil
-00009f80: 6974 792e 0a20 2020 2069 6620 6f73 2e70  ity..    if os.p
-00009f90: 6174 682e 6578 6973 7473 2879 616d 6c5f  ath.exists(yaml_
-00009fa0: 7061 7468 2920 616e 6420 6b65 6570 5f6c  path) and keep_l
-00009fb0: 6175 6e63 685f 6669 656c 6473 5f69 6e5f  aunch_fields_in_
-00009fc0: 6578 6973 7469 6e67 5f63 6f6e 6669 673a  existing_config:
-00009fd0: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-00009fe0: 656e 2879 616d 6c5f 7061 7468 2c20 2772  en(yaml_path, 'r
-00009ff0: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
-0000a000: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
-0000a010: 2020 2020 2020 206f 6c64 5f79 616d 6c5f         old_yaml_
-0000a020: 636f 6e74 656e 7420 3d20 662e 7265 6164  content = f.read
-0000a030: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
-0000a040: 6f70 656e 2874 6d70 5f79 616d 6c5f 7061  open(tmp_yaml_pa
-0000a050: 7468 2c20 2772 272c 2065 6e63 6f64 696e  th, 'r', encodin
-0000a060: 673d 2775 7466 2d38 2729 2061 7320 663a  g='utf-8') as f:
-0000a070: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-0000a080: 5f79 616d 6c5f 636f 6e74 656e 7420 3d20  _yaml_content = 
-0000a090: 662e 7265 6164 2829 0a20 2020 2020 2020  f.read().       
-0000a0a0: 2072 6573 746f 7265 645f 7961 6d6c 5f63   restored_yaml_c
-0000a0b0: 6f6e 7465 6e74 203d 205f 7265 706c 6163  ontent = _replac
-0000a0c0: 655f 7961 6d6c 5f64 6963 7473 280a 2020  e_yaml_dicts(.  
-0000a0d0: 2020 2020 2020 2020 2020 6e65 775f 7961            new_ya
-0000a0e0: 6d6c 5f63 6f6e 7465 6e74 2c20 6f6c 645f  ml_content, old_
-0000a0f0: 7961 6d6c 5f63 6f6e 7465 6e74 2c0a 2020  yaml_content,.  
-0000a100: 2020 2020 2020 2020 2020 5f52 4159 5f59            _RAY_Y
-0000a110: 414d 4c5f 4b45 5953 5f54 4f5f 5245 5354  AML_KEYS_TO_REST
-0000a120: 4f52 455f 464f 525f 4241 434b 5f43 4f4d  ORE_FOR_BACK_COM
-0000a130: 5041 5449 4249 4c49 5459 2c0a 2020 2020  PATIBILITY,.    
-0000a140: 2020 2020 2020 2020 5f52 4159 5f59 414d          _RAY_YAM
-0000a150: 4c5f 4b45 5953 5f54 4f5f 5245 5354 4f52  L_KEYS_TO_RESTOR
-0000a160: 455f 4558 4345 5054 494f 4e53 290a 2020  E_EXCEPTIONS).  
-0000a170: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-0000a180: 746d 705f 7961 6d6c 5f70 6174 682c 2027  tmp_yaml_path, '
-0000a190: 7727 2c20 656e 636f 6469 6e67 3d27 7574  w', encoding='ut
-0000a1a0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
-0000a1b0: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
-0000a1c0: 7265 7374 6f72 6564 5f79 616d 6c5f 636f  restored_yaml_co
-0000a1d0: 6e74 656e 7429 0a0a 2020 2020 636f 6e66  ntent)..    conf
-0000a1e0: 6967 5f64 6963 745b 2763 6c75 7374 6572  ig_dict['cluster
-0000a1f0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 275d  _name_on_cloud']
-0000a200: 203d 2063 6c75 7374 6572 5f6e 616d 655f   = cluster_name_
-0000a210: 6f6e 5f63 6c6f 7564 0a0a 2020 2020 2320  on_cloud..    # 
-0000a220: 4f70 7469 6d69 7a61 7469 6f6e 3a20 636f  Optimization: co
-0000a230: 7079 2074 6865 2063 6f6e 7465 6e74 7320  py the contents 
-0000a240: 6f66 2073 6f75 7263 6520 6669 6c65 7320  of source files 
-0000a250: 696e 2066 696c 655f 6d6f 756e 7473 2074  in file_mounts t
-0000a260: 6f20 610a 2020 2020 2320 7370 6563 6961  o a.    # specia
-0000a270: 6c20 6469 722c 2061 6e64 2075 706c 6f61  l dir, and uploa
-0000a280: 6420 7468 6174 2061 7320 7468 6520 6f6e  d that as the on
-0000a290: 6c79 2066 696c 655f 6d6f 756e 7420 696e  ly file_mount in
-0000a2a0: 7374 6561 642e 2044 656c 6179 0a20 2020  stead. Delay.   
-0000a2b0: 2023 2063 616c 6c69 6e67 2074 6869 7320   # calling this 
-0000a2c0: 6f70 7469 6d69 7a61 7469 6f6e 2075 6e74  optimization unt
-0000a2d0: 696c 206e 6f77 2c20 7768 656e 2061 6c6c  il now, when all
-0000a2e0: 2073 6f75 7263 6520 6669 6c65 7320 6861   source files ha
-0000a2f0: 7665 2062 6565 6e0a 2020 2020 2320 7772  ve been.    # wr
-0000a300: 6974 7465 6e20 616e 6420 7468 6569 7220  itten and their 
-0000a310: 636f 6e74 656e 7473 2066 696e 616c 697a  contents finaliz
-0000a320: 6564 2e0a 2020 2020 230a 2020 2020 2320  ed..    #.    # 
-0000a330: 4e6f 7465 2074 6861 7420 7468 6520 7261  Note that the ra
-0000a340: 7920 7961 6d6c 2066 696c 6520 7769 6c6c  y yaml file will
-0000a350: 2062 6520 636f 7069 6564 2069 6e74 6f20   be copied into 
-0000a360: 7468 6174 2073 7065 6369 616c 2064 6972  that special dir
-0000a370: 2028 692e 652e 2c0a 2020 2020 2320 7570   (i.e.,.    # up
-0000a380: 6c6f 6164 6564 2061 7320 7061 7274 206f  loaded as part o
-0000a390: 6620 7468 6520 6669 6c65 5f6d 6f75 6e74  f the file_mount
-0000a3a0: 7329 2c20 736f 2074 6865 2072 6573 746f  s), so the resto
-0000a3b0: 7265 2066 6f72 2062 6163 6b77 6172 640a  re for backward.
-0000a3c0: 2020 2020 2320 636f 6d70 6174 6962 696c      # compatibil
-0000a3d0: 6974 7920 7368 6f75 6c64 2067 6f20 6265  ity should go be
-0000a3e0: 666f 7265 2074 6869 7320 6361 6c6c 2e0a  fore this call..
-0000a3f0: 2020 2020 5f6f 7074 696d 697a 655f 6669      _optimize_fi
-0000a400: 6c65 5f6d 6f75 6e74 7328 746d 705f 7961  le_mounts(tmp_ya
-0000a410: 6d6c 5f70 6174 6829 0a0a 2020 2020 2320  ml_path)..    # 
-0000a420: 5265 6e61 6d65 2074 6865 2074 6d70 2066  Rename the tmp f
-0000a430: 696c 6520 746f 2074 6865 2066 696e 616c  ile to the final
-0000a440: 2059 414d 4c20 7061 7468 2e0a 2020 2020   YAML path..    
-0000a450: 6f73 2e72 656e 616d 6528 746d 705f 7961  os.rename(tmp_ya
-0000a460: 6d6c 5f70 6174 682c 2079 616d 6c5f 7061  ml_path, yaml_pa
-0000a470: 7468 290a 2020 2020 7573 6167 655f 6c69  th).    usage_li
-0000a480: 622e 6d65 7373 6167 6573 2e75 7361 6765  b.messages.usage
-0000a490: 2e75 7064 6174 655f 7261 795f 7961 6d6c  .update_ray_yaml
-0000a4a0: 2879 616d 6c5f 7061 7468 290a 2020 2020  (yaml_path).    
-0000a4b0: 7265 7475 726e 2063 6f6e 6669 675f 6469  return config_di
-0000a4c0: 6374 0a0a 0a64 6566 205f 6164 645f 6175  ct...def _add_au
-0000a4d0: 7468 5f74 6f5f 636c 7573 7465 725f 636f  th_to_cluster_co
-0000a4e0: 6e66 6967 2863 6c6f 7564 3a20 636c 6f75  nfig(cloud: clou
-0000a4f0: 6473 2e43 6c6f 7564 2c20 636c 7573 7465  ds.Cloud, cluste
-0000a500: 725f 636f 6e66 6967 5f66 696c 653a 2073  r_config_file: s
-0000a510: 7472 293a 0a20 2020 2022 2222 4164 6473  tr):.    """Adds
-0000a520: 2053 5348 206b 6579 2069 6e66 6f20 746f   SSH key info to
-0000a530: 2074 6865 2063 6c75 7374 6572 2063 6f6e   the cluster con
-0000a540: 6669 672e 0a0a 2020 2020 5468 6973 2066  fig...    This f
-0000a550: 756e 6374 696f 6e27 7320 6f75 7470 7574  unction's output
-0000a560: 2072 656d 6f76 6573 2063 6f6d 6d65 6e74   removes comment
-0000a570: 7320 696e 636c 7564 6564 2069 6e20 7468  s included in th
-0000a580: 6520 6a69 6e6a 6132 2074 656d 706c 6174  e jinja2 templat
-0000a590: 652e 0a20 2020 2022 2222 0a20 2020 2063  e..    """.    c
-0000a5a0: 6f6e 6669 6720 3d20 636f 6d6d 6f6e 5f75  onfig = common_u
-0000a5b0: 7469 6c73 2e72 6561 645f 7961 6d6c 2863  tils.read_yaml(c
-0000a5c0: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
-0000a5d0: 6c65 290a 2020 2020 2320 4368 6563 6b20  le).    # Check 
-0000a5e0: 7468 6520 6176 6169 6c61 6269 6c69 7479  the availability
-0000a5f0: 206f 6620 7468 6520 636c 6f75 6420 7479   of the cloud ty
-0000a600: 7065 2e0a 2020 2020 6966 2069 7369 6e73  pe..    if isins
-0000a610: 7461 6e63 6528 636c 6f75 642c 2028 636c  tance(cloud, (cl
-0000a620: 6f75 6473 2e41 5753 2c20 636c 6f75 6473  ouds.AWS, clouds
-0000a630: 2e4f 4349 2c20 636c 6f75 6473 2e53 4350  .OCI, clouds.SCP
-0000a640: 2c20 636c 6f75 6473 2e56 7370 6865 7265  , clouds.Vsphere
-0000a650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a660: 2020 2020 2020 2020 2020 2020 636c 6f75              clou
-0000a670: 6473 2e43 7564 6f2c 2063 6c6f 7564 732e  ds.Cudo, clouds.
-0000a680: 5061 7065 7273 7061 6365 2929 3a0a 2020  Paperspace)):.  
-0000a690: 2020 2020 2020 636f 6e66 6967 203d 2061        config = a
-0000a6a0: 7574 682e 636f 6e66 6967 7572 655f 7373  uth.configure_ss
-0000a6b0: 685f 696e 666f 2863 6f6e 6669 6729 0a20  h_info(config). 
-0000a6c0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0000a6d0: 6365 2863 6c6f 7564 2c20 636c 6f75 6473  ce(cloud, clouds
-0000a6e0: 2e47 4350 293a 0a20 2020 2020 2020 2063  .GCP):.        c
-0000a6f0: 6f6e 6669 6720 3d20 6175 7468 2e73 6574  onfig = auth.set
-0000a700: 7570 5f67 6370 5f61 7574 6865 6e74 6963  up_gcp_authentic
-0000a710: 6174 696f 6e28 636f 6e66 6967 290a 2020  ation(config).  
-0000a720: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0000a730: 6528 636c 6f75 642c 2063 6c6f 7564 732e  e(cloud, clouds.
-0000a740: 417a 7572 6529 3a0a 2020 2020 2020 2020  Azure):.        
-0000a750: 636f 6e66 6967 203d 2061 7574 682e 7365  config = auth.se
-0000a760: 7475 705f 617a 7572 655f 6175 7468 656e  tup_azure_authen
-0000a770: 7469 6361 7469 6f6e 2863 6f6e 6669 6729  tication(config)
-0000a780: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
-0000a790: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
-0000a7a0: 6473 2e4c 616d 6264 6129 3a0a 2020 2020  ds.Lambda):.    
-0000a7b0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
-0000a7c0: 682e 7365 7475 705f 6c61 6d62 6461 5f61  h.setup_lambda_a
-0000a7d0: 7574 6865 6e74 6963 6174 696f 6e28 636f  uthentication(co
-0000a7e0: 6e66 6967 290a 2020 2020 656c 6966 2069  nfig).    elif i
-0000a7f0: 7369 6e73 7461 6e63 6528 636c 6f75 642c  sinstance(cloud,
-0000a800: 2063 6c6f 7564 732e 4b75 6265 726e 6574   clouds.Kubernet
-0000a810: 6573 293a 0a20 2020 2020 2020 2063 6f6e  es):.        con
-0000a820: 6669 6720 3d20 6175 7468 2e73 6574 7570  fig = auth.setup
-0000a830: 5f6b 7562 6572 6e65 7465 735f 6175 7468  _kubernetes_auth
-0000a840: 656e 7469 6361 7469 6f6e 2863 6f6e 6669  entication(confi
-0000a850: 6729 0a20 2020 2065 6c69 6620 6973 696e  g).    elif isin
-0000a860: 7374 616e 6365 2863 6c6f 7564 2c20 636c  stance(cloud, cl
-0000a870: 6f75 6473 2e49 424d 293a 0a20 2020 2020  ouds.IBM):.     
-0000a880: 2020 2063 6f6e 6669 6720 3d20 6175 7468     config = auth
-0000a890: 2e73 6574 7570 5f69 626d 5f61 7574 6865  .setup_ibm_authe
-0000a8a0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
-0000a8b0: 290a 2020 2020 656c 6966 2069 7369 6e73  ).    elif isins
-0000a8c0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
-0000a8d0: 7564 732e 5275 6e50 6f64 293a 0a20 2020  uds.RunPod):.   
-0000a8e0: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
-0000a8f0: 7468 2e73 6574 7570 5f72 756e 706f 645f  th.setup_runpod_
-0000a900: 6175 7468 656e 7469 6361 7469 6f6e 2863  authentication(c
-0000a910: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
-0000a920: 6973 696e 7374 616e 6365 2863 6c6f 7564  isinstance(cloud
-0000a930: 2c20 636c 6f75 6473 2e46 6c75 6964 7374  , clouds.Fluidst
-0000a940: 6163 6b29 3a0a 2020 2020 2020 2020 636f  ack):.        co
-0000a950: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
-0000a960: 705f 666c 7569 6473 7461 636b 5f61 7574  p_fluidstack_aut
-0000a970: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
-0000a980: 6967 290a 2020 2020 656c 7365 3a0a 2020  ig).    else:.  
-0000a990: 2020 2020 2020 6173 7365 7274 2046 616c        assert Fal
-0000a9a0: 7365 2c20 636c 6f75 640a 2020 2020 636f  se, cloud.    co
-0000a9b0: 6d6d 6f6e 5f75 7469 6c73 2e64 756d 705f  mmon_utils.dump_
-0000a9c0: 7961 6d6c 2863 6c75 7374 6572 5f63 6f6e  yaml(cluster_con
-0000a9d0: 6669 675f 6669 6c65 2c20 636f 6e66 6967  fig_file, config
-0000a9e0: 290a 0a0a 6465 6620 6765 745f 7275 6e5f  )...def get_run_
-0000a9f0: 7469 6d65 7374 616d 7028 2920 2d3e 2073  timestamp() -> s
-0000aa00: 7472 3a0a 2020 2020 7265 7475 726e 2027  tr:.    return '
-0000aa10: 736b 792d 2720 2b20 6461 7465 7469 6d65  sky-' + datetime
-0000aa20: 2e6e 6f77 2829 2e73 7472 6674 696d 6528  .now().strftime(
-0000aa30: 2725 592d 256d 2d25 642d 2548 2d25 4d2d  '%Y-%m-%d-%H-%M-
-0000aa40: 2553 2d25 6627 290a 0a0a 6465 6620 6765  %S-%f')...def ge
-0000aa50: 745f 7469 6d65 7374 616d 705f 6672 6f6d  t_timestamp_from
-0000aa60: 5f72 756e 5f74 696d 6573 7461 6d70 2872  _run_timestamp(r
-0000aa70: 756e 5f74 696d 6573 7461 6d70 3a20 7374  un_timestamp: st
-0000aa80: 7229 202d 3e20 666c 6f61 743a 0a20 2020  r) -> float:.   
-0000aa90: 2072 6574 7572 6e20 6461 7465 7469 6d65   return datetime
-0000aaa0: 2e73 7472 7074 696d 6528 0a20 2020 2020  .strptime(.     
-0000aab0: 2020 2072 756e 5f74 696d 6573 7461 6d70     run_timestamp
-0000aac0: 2e70 6172 7469 7469 6f6e 2827 2d27 295b  .partition('-')[
-0000aad0: 325d 2c20 2725 592d 256d 2d25 642d 2548  2], '%Y-%m-%d-%H
-0000aae0: 2d25 4d2d 2553 2d25 6627 292e 7469 6d65  -%M-%S-%f').time
-0000aaf0: 7374 616d 7028 290a 0a0a 6465 6620 5f63  stamp()...def _c
-0000ab00: 6f75 6e74 5f68 6561 6c74 6879 5f6e 6f64  ount_healthy_nod
-0000ab10: 6573 5f66 726f 6d5f 7261 7928 6f75 7470  es_from_ray(outp
-0000ab20: 7574 3a20 7374 722c 0a20 2020 2020 2020  ut: str,.       
-0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab40: 2020 2020 2020 2020 2020 2069 735f 6c6f             is_lo
-0000ab50: 6361 6c5f 636c 6f75 643a 2062 6f6f 6c20  cal_cloud: bool 
-0000ab60: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab80: 2020 2020 2020 2020 2029 202d 3e20 5475           ) -> Tu
-0000ab90: 706c 655b 696e 742c 2069 6e74 5d3a 0a20  ple[int, int]:. 
-0000aba0: 2020 2022 2222 436f 756e 7420 7468 6520     """Count the 
-0000abb0: 6e75 6d62 6572 206f 6620 6865 616c 7468  number of health
-0000abc0: 7920 6e6f 6465 7320 6672 6f6d 2074 6865  y nodes from the
-0000abd0: 206f 7574 7075 7420 6f66 2060 7261 7920   output of `ray 
-0000abe0: 7374 6174 7573 602e 2222 220a 0a20 2020  status`."""..   
-0000abf0: 2064 6566 2067 6574 5f72 6561 6479 5f6e   def get_ready_n
-0000ac00: 6f64 6573 5f63 6f75 6e74 7328 7061 7474  odes_counts(patt
-0000ac10: 6572 6e2c 206f 7574 7075 7429 3a0a 2020  ern, output):.  
-0000ac20: 2020 2020 2020 7265 7375 6c74 203d 2070        result = p
-0000ac30: 6174 7465 726e 2e66 696e 6461 6c6c 286f  attern.findall(o
-0000ac40: 7574 7075 7429 0a20 2020 2020 2020 2069  utput).        i
-0000ac50: 6620 6e6f 7420 7265 7375 6c74 3a0a 2020  f not result:.  
-0000ac60: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000ac70: 2030 0a20 2020 2020 2020 2061 7373 6572   0.        asser
-0000ac80: 7420 6c65 6e28 7265 7375 6c74 2920 3d3d  t len(result) ==
-0000ac90: 2031 2c20 7265 7375 6c74 0a20 2020 2020   1, result.     
-0000aca0: 2020 2072 6574 7572 6e20 696e 7428 7265     return int(re
-0000acb0: 7375 6c74 5b30 5d29 0a0a 2020 2020 2320  sult[0])..    # 
-0000acc0: 4368 6563 6b20 6966 2074 6865 2072 6179  Check if the ray
-0000acd0: 2063 6c75 7374 6572 2069 7320 7374 6172   cluster is star
-0000ace0: 7465 6420 7769 7468 2072 6179 2061 7574  ted with ray aut
-0000acf0: 6f73 6361 6c65 722e 2049 6e20 6e65 770a  oscaler. In new.
-0000ad00: 2020 2020 2320 7072 6f76 6973 696f 6e65      # provisione
-0000ad10: 7220 2823 3137 3032 2920 616e 6420 6c6f  r (#1702) and lo
-0000ad20: 6361 6c20 6d6f 6465 2c20 7765 2073 7461  cal mode, we sta
-0000ad30: 7274 6564 2074 6865 2072 6179 2063 6c75  rted the ray clu
-0000ad40: 7374 6572 2077 6974 686f 7574 2072 6179  ster without ray
-0000ad50: 0a20 2020 2023 2061 7574 6f73 6361 6c65  .    # autoscale
-0000ad60: 722e 0a20 2020 2023 2049 6620 7261 7920  r..    # If ray 
-0000ad70: 636c 7573 7465 7220 6973 2073 7461 7274  cluster is start
-0000ad80: 6564 2077 6974 6820 7261 7920 6175 746f  ed with ray auto
-0000ad90: 7363 616c 6572 2c20 7468 6520 6f75 7470  scaler, the outp
-0000ada0: 7574 2077 696c 6c20 6265 3a0a 2020 2020  ut will be:.    
-0000adb0: 2320 2031 2072 6179 2e68 6561 642e 6465  #  1 ray.head.de
-0000adc0: 6661 756c 740a 2020 2020 2320 202e 2e2e  fault.    #  ...
-0000add0: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
-0000ade0: 293a 206f 6e63 6520 7765 2064 6570 7265  ): once we depre
-0000adf0: 6361 7465 2074 6865 206f 6c64 2070 726f  cate the old pro
-0000ae00: 7669 7369 6f6e 6572 2c20 7765 2063 616e  visioner, we can
-0000ae10: 2072 656d 6f76 6520 7468 6973 0a20 2020   remove this.   
-0000ae20: 2023 2063 6865 636b 2e0a 2020 2020 7261   # check..    ra
-0000ae30: 795f 6175 746f 7363 616c 6572 5f68 6561  y_autoscaler_hea
-0000ae40: 6420 3d20 6765 745f 7265 6164 795f 6e6f  d = get_ready_no
-0000ae50: 6465 735f 636f 756e 7473 285f 4c41 554e  des_counts(_LAUN
-0000ae60: 4348 4544 5f48 4541 445f 5041 5454 4552  CHED_HEAD_PATTER
-0000ae70: 4e2c 206f 7574 7075 7429 0a20 2020 2069  N, output).    i
-0000ae80: 735f 6c6f 6361 6c5f 7261 795f 636c 7573  s_local_ray_clus
-0000ae90: 7465 7220 3d20 7261 795f 6175 746f 7363  ter = ray_autosc
-0000aea0: 616c 6572 5f68 6561 6420 3d3d 2030 0a0a  aler_head == 0..
-0000aeb0: 2020 2020 6966 2069 735f 6c6f 6361 6c5f      if is_local_
-0000aec0: 7261 795f 636c 7573 7465 7220 6f72 2069  ray_cluster or i
-0000aed0: 735f 6c6f 6361 6c5f 636c 6f75 643a 0a20  s_local_cloud:. 
-0000aee0: 2020 2020 2020 2023 2052 6179 2063 6c75         # Ray clu
-0000aef0: 7374 6572 2069 7320 6c61 756e 6368 6564  ster is launched
-0000af00: 2077 6974 6820 6e65 7720 7072 6f76 6973   with new provis
-0000af10: 696f 6e65 720a 2020 2020 2020 2020 2320  ioner.        # 
-0000af20: 466f 7220 6e65 7720 7072 6f76 6973 696f  For new provisio
-0000af30: 6e65 7220 616e 6420 6c6f 6361 6c20 6d6f  ner and local mo
-0000af40: 6465 2c20 7468 6520 6f75 7470 7574 2077  de, the output w
-0000af50: 696c 6c20 6265 3a0a 2020 2020 2020 2020  ill be:.        
-0000af60: 2320 2031 206e 6f64 655f 7878 7878 0a20  #  1 node_xxxx. 
-0000af70: 2020 2020 2020 2023 2020 3120 6e6f 6465         #  1 node
-0000af80: 5f78 7878 780a 2020 2020 2020 2020 7265  _xxxx.        re
-0000af90: 6164 795f 6865 6164 203d 2030 0a20 2020  ady_head = 0.   
-0000afa0: 2020 2020 2072 6561 6479 5f77 6f72 6b65       ready_worke
-0000afb0: 7273 203d 205f 4c41 554e 4348 4544 5f4c  rs = _LAUNCHED_L
-0000afc0: 4f43 414c 5f57 4f52 4b45 525f 5041 5454  OCAL_WORKER_PATT
-0000afd0: 4552 4e2e 6669 6e64 616c 6c28 6f75 7470  ERN.findall(outp
-0000afe0: 7574 290a 2020 2020 2020 2020 7265 6164  ut).        read
-0000aff0: 795f 776f 726b 6572 7320 3d20 6c65 6e28  y_workers = len(
-0000b000: 7265 6164 795f 776f 726b 6572 7329 0a20  ready_workers). 
-0000b010: 2020 2020 2020 2069 6620 6973 5f6c 6f63         if is_loc
-0000b020: 616c 5f72 6179 5f63 6c75 7374 6572 3a0a  al_ray_cluster:.
-0000b030: 2020 2020 2020 2020 2020 2020 7265 6164              read
-0000b040: 795f 6865 6164 203d 2031 0a20 2020 2020  y_head = 1.     
-0000b050: 2020 2020 2020 2072 6561 6479 5f77 6f72         ready_wor
-0000b060: 6b65 7273 202d 3d20 310a 2020 2020 2020  kers -= 1.      
-0000b070: 2020 7265 7475 726e 2072 6561 6479 5f68    return ready_h
-0000b080: 6561 642c 2072 6561 6479 5f77 6f72 6b65  ead, ready_worke
-0000b090: 7273 0a0a 2020 2020 2320 436f 756e 7420  rs..    # Count 
-0000b0a0: 6e75 6d62 6572 206f 6620 6e6f 6465 7320  number of nodes 
-0000b0b0: 6279 2070 6172 7369 6e67 2074 6865 206f  by parsing the o
-0000b0c0: 7574 7075 7420 6f66 2060 7261 7920 7374  utput of `ray st
-0000b0d0: 6174 7573 602e 2054 6865 206f 7574 7075  atus`. The outpu
-0000b0e0: 740a 2020 2020 2320 6c6f 6f6b 7320 6c69  t.    # looks li
-0000b0f0: 6b65 3a0a 2020 2020 2320 2020 3120 7261  ke:.    #   1 ra
-0000b100: 792e 6865 6164 2e64 6566 6175 6c74 0a20  y.head.default. 
-0000b110: 2020 2023 2020 2032 2072 6179 2e77 6f72     #   2 ray.wor
-0000b120: 6b65 722e 6465 6661 756c 740a 2020 2020  ker.default.    
-0000b130: 7265 6164 795f 6865 6164 203d 2072 6179  ready_head = ray
-0000b140: 5f61 7574 6f73 6361 6c65 725f 6865 6164  _autoscaler_head
-0000b150: 0a20 2020 2072 6561 6479 5f77 6f72 6b65  .    ready_worke
-0000b160: 7273 203d 2067 6574 5f72 6561 6479 5f6e  rs = get_ready_n
-0000b170: 6f64 6573 5f63 6f75 6e74 7328 5f4c 4155  odes_counts(_LAU
-0000b180: 4e43 4845 445f 574f 524b 4552 5f50 4154  NCHED_WORKER_PAT
-0000b190: 5445 524e 2c20 6f75 7470 7574 290a 2020  TERN, output).  
-0000b1a0: 2020 7265 6164 795f 7265 7365 7276 6564    ready_reserved
-0000b1b0: 5f77 6f72 6b65 7273 203d 2067 6574 5f72  _workers = get_r
-0000b1c0: 6561 6479 5f6e 6f64 6573 5f63 6f75 6e74  eady_nodes_count
-0000b1d0: 7328 0a20 2020 2020 2020 205f 4c41 554e  s(.        _LAUN
-0000b1e0: 4348 4544 5f52 4553 4552 5645 445f 574f  CHED_RESERVED_WO
-0000b1f0: 524b 4552 5f50 4154 5445 524e 2c20 6f75  RKER_PATTERN, ou
-0000b200: 7470 7574 290a 2020 2020 7265 6164 795f  tput).    ready_
-0000b210: 776f 726b 6572 7320 2b3d 2072 6561 6479  workers += ready
-0000b220: 5f72 6573 6572 7665 645f 776f 726b 6572  _reserved_worker
-0000b230: 730a 2020 2020 6173 7365 7274 2072 6561  s.    assert rea
-0000b240: 6479 5f68 6561 6420 3c3d 2031 2c20 6627  dy_head <= 1, f'
-0000b250: 2368 6561 6420 6e6f 6465 2073 686f 756c  #head node shoul
-0000b260: 6420 6265 203c 3d31 2028 476f 7420 7b72  d be <=1 (Got {r
-0000b270: 6561 6479 5f68 6561 647d 292e 270a 2020  eady_head}).'.  
-0000b280: 2020 7265 7475 726e 2072 6561 6479 5f68    return ready_h
-0000b290: 6561 642c 2072 6561 6479 5f77 6f72 6b65  ead, ready_worke
-0000b2a0: 7273 0a0a 0a64 6566 2067 6574 5f64 6f63  rs...def get_doc
-0000b2b0: 6b65 725f 7573 6572 2869 703a 2073 7472  ker_user(ip: str
-0000b2c0: 2c20 636c 7573 7465 725f 636f 6e66 6967  , cluster_config
-0000b2d0: 5f66 696c 653a 2073 7472 2920 2d3e 2073  _file: str) -> s
-0000b2e0: 7472 3a0a 2020 2020 2222 2246 696e 6420  tr:.    """Find 
-0000b2f0: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
-0000b300: 2075 7365 726e 616d 652e 2222 220a 2020   username.""".  
-0000b310: 2020 7373 685f 6372 6564 656e 7469 616c    ssh_credential
-0000b320: 7320 3d20 7373 685f 6372 6564 656e 7469  s = ssh_credenti
-0000b330: 616c 5f66 726f 6d5f 7961 6d6c 2863 6c75  al_from_yaml(clu
-0000b340: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
-0000b350: 290a 2020 2020 7275 6e6e 6572 203d 2063  ).    runner = c
-0000b360: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
-0000b370: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2869  HCommandRunner(i
-0000b380: 702c 2070 6f72 743d 3232 2c20 2a2a 7373  p, port=22, **ss
-0000b390: 685f 6372 6564 656e 7469 616c 7329 0a20  h_credentials). 
-0000b3a0: 2020 2063 6f6e 7461 696e 6572 5f6e 616d     container_nam
-0000b3b0: 6520 3d20 636f 6e73 7461 6e74 732e 4445  e = constants.DE
-0000b3c0: 4641 554c 545f 444f 434b 4552 5f43 4f4e  FAULT_DOCKER_CON
-0000b3d0: 5441 494e 4552 5f4e 414d 450a 2020 2020  TAINER_NAME.    
-0000b3e0: 7768 6f61 6d69 5f72 6574 7572 6e63 6f64  whoami_returncod
-0000b3f0: 652c 2077 686f 616d 695f 7374 646f 7574  e, whoami_stdout
-0000b400: 2c20 7768 6f61 6d69 5f73 7464 6572 7220  , whoami_stderr 
-0000b410: 3d20 7275 6e6e 6572 2e72 756e 280a 2020  = runner.run(.  
-0000b420: 2020 2020 2020 6627 7375 646f 2064 6f63        f'sudo doc
-0000b430: 6b65 7220 6578 6563 207b 636f 6e74 6169  ker exec {contai
-0000b440: 6e65 725f 6e61 6d65 7d20 7768 6f61 6d69  ner_name} whoami
-0000b450: 272c 0a20 2020 2020 2020 2073 7472 6561  ',.        strea
-0000b460: 6d5f 6c6f 6773 3d46 616c 7365 2c0a 2020  m_logs=False,.  
-0000b470: 2020 2020 2020 7265 7175 6972 655f 6f75        require_ou
-0000b480: 7470 7574 733d 5472 7565 290a 2020 2020  tputs=True).    
-0000b490: 6173 7365 7274 2077 686f 616d 695f 7265  assert whoami_re
-0000b4a0: 7475 726e 636f 6465 203d 3d20 302c 2028  turncode == 0, (
-0000b4b0: 0a20 2020 2020 2020 2066 2746 6169 6c65  .        f'Faile
-0000b4c0: 6420 746f 2067 6574 2064 6f63 6b65 7220  d to get docker 
-0000b4d0: 636f 6e74 6169 6e65 7220 7573 6572 2e20  container user. 
-0000b4e0: 5265 7475 726e 2027 0a20 2020 2020 2020  Return '.       
-0000b4f0: 2066 2763 6f64 653a 207b 7768 6f61 6d69   f'code: {whoami
-0000b500: 5f72 6574 7572 6e63 6f64 657d 2c20 4572  _returncode}, Er
-0000b510: 726f 723a 207b 7768 6f61 6d69 5f73 7464  ror: {whoami_std
-0000b520: 6572 727d 2729 0a20 2020 2064 6f63 6b65  err}').    docke
-0000b530: 725f 7573 6572 203d 2077 686f 616d 695f  r_user = whoami_
-0000b540: 7374 646f 7574 2e73 7472 6970 2829 0a20  stdout.strip(). 
-0000b550: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0000b560: 6627 446f 636b 6572 2063 6f6e 7461 696e  f'Docker contain
-0000b570: 6572 2075 7365 723a 207b 646f 636b 6572  er user: {docker
-0000b580: 5f75 7365 727d 2729 0a20 2020 2072 6574  _user}').    ret
-0000b590: 7572 6e20 646f 636b 6572 5f75 7365 720a  urn docker_user.
-0000b5a0: 0a0a 4074 696d 656c 696e 652e 6576 656e  ..@timeline.even
-0000b5b0: 740a 6465 6620 7761 6974 5f75 6e74 696c  t.def wait_until
-0000b5c0: 5f72 6179 5f63 6c75 7374 6572 5f72 6561  _ray_cluster_rea
-0000b5d0: 6479 280a 2020 2020 636c 7573 7465 725f  dy(.    cluster_
-0000b5e0: 636f 6e66 6967 5f66 696c 653a 2073 7472  config_file: str
-0000b5f0: 2c0a 2020 2020 6e75 6d5f 6e6f 6465 733a  ,.    num_nodes:
-0000b600: 2069 6e74 2c0a 2020 2020 6c6f 675f 7061   int,.    log_pa
-0000b610: 7468 3a20 7374 722c 0a20 2020 2069 735f  th: str,.    is_
-0000b620: 6c6f 6361 6c5f 636c 6f75 643a 2062 6f6f  local_cloud: boo
-0000b630: 6c20 3d20 4661 6c73 652c 0a20 2020 206e  l = False,.    n
-0000b640: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
-0000b650: 726f 6772 6573 735f 7469 6d65 6f75 743a  rogress_timeout:
-0000b660: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
-0000b670: 204e 6f6e 652c 0a29 202d 3e20 5475 706c   None,.) -> Tupl
-0000b680: 655b 626f 6f6c 2c20 4f70 7469 6f6e 616c  e[bool, Optional
-0000b690: 5b73 7472 5d5d 3a0a 2020 2020 2222 2257  [str]]:.    """W
-0000b6a0: 6169 7420 756e 7469 6c20 7468 6520 7261  ait until the ra
-0000b6b0: 7920 636c 7573 7465 7220 6973 2073 6574  y cluster is set
-0000b6c0: 2075 7020 6f6e 2056 4d73 206f 7220 696e   up on VMs or in
-0000b6d0: 2063 6f6e 7461 696e 6572 732e 0a0a 2020   containers...  
-0000b6e0: 2020 5265 7475 726e 733a 2020 7768 6574    Returns:  whet
-0000b6f0: 6865 7220 7468 6520 656e 7469 7265 2072  her the entire r
-0000b700: 6179 2063 6c75 7374 6572 2069 7320 7265  ay cluster is re
-0000b710: 6164 792c 2061 6e64 2064 6f63 6b65 7220  ady, and docker 
-0000b720: 7573 6572 6e61 6d65 0a20 2020 2069 6620  username.    if 
-0000b730: 6c61 756e 6368 6564 2077 6974 6820 646f  launched with do
-0000b740: 636b 6572 2e0a 2020 2020 2222 220a 2020  cker..    """.  
-0000b750: 2020 2320 4d61 6e75 616c 6c79 2066 6574    # Manually fet
-0000b760: 6368 696e 6720 6865 6164 2069 7020 696e  ching head ip in
-0000b770: 7374 6561 6420 6f66 2075 7369 6e67 2060  stead of using `
-0000b780: 7261 7920 6578 6563 6020 746f 2061 766f  ray exec` to avo
-0000b790: 6964 2074 6865 2062 7567 0a20 2020 2023  id the bug.    #
-0000b7a0: 2074 6861 7420 6072 6179 2065 7865 6360   that `ray exec`
-0000b7b0: 2066 6169 6c73 2074 6f20 636f 6e6e 6563   fails to connec
-0000b7c0: 7420 746f 2074 6865 2068 6561 6420 6e6f  t to the head no
-0000b7d0: 6465 2061 6674 6572 2073 6f6d 6520 776f  de after some wo
-0000b7e0: 726b 6572 730a 2020 2020 2320 6c61 756e  rkers.    # laun
-0000b7f0: 6368 6564 2065 7370 6563 6961 6c6c 7920  ched especially 
-0000b800: 666f 7220 417a 7572 652e 0a20 2020 2074  for Azure..    t
-0000b810: 7279 3a0a 2020 2020 2020 2020 6865 6164  ry:.        head
-0000b820: 5f69 7020 3d20 5f71 7565 7279 5f68 6561  _ip = _query_hea
-0000b830: 645f 6970 5f77 6974 685f 7265 7472 6965  d_ip_with_retrie
-0000b840: 7328 0a20 2020 2020 2020 2020 2020 2063  s(.            c
-0000b850: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
-0000b860: 6c65 2c20 6d61 785f 6174 7465 6d70 7473  le, max_attempts
-0000b870: 3d57 4149 545f 4845 4144 5f4e 4f44 455f  =WAIT_HEAD_NODE_
-0000b880: 4950 5f4d 4158 5f41 5454 454d 5054 5329  IP_MAX_ATTEMPTS)
-0000b890: 0a20 2020 2065 7863 6570 7420 6578 6365  .    except exce
-0000b8a0: 7074 696f 6e73 2e46 6574 6368 4950 4572  ptions.FetchIPEr
-0000b8b0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-0000b8c0: 2020 6c6f 6767 6572 2e65 7272 6f72 2863    logger.error(c
-0000b8d0: 6f6d 6d6f 6e5f 7574 696c 732e 666f 726d  ommon_utils.form
-0000b8e0: 6174 5f65 7863 6570 7469 6f6e 2865 2929  at_exception(e))
-0000b8f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b900: 4661 6c73 652c 204e 6f6e 6520 2023 2066  False, None  # f
-0000b910: 6169 6c65 640a 0a20 2020 2063 6f6e 6669  ailed..    confi
-0000b920: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
-0000b930: 2e72 6561 645f 7961 6d6c 2863 6c75 7374  .read_yaml(clust
-0000b940: 6572 5f63 6f6e 6669 675f 6669 6c65 290a  er_config_file).
-0000b950: 0a20 2020 2064 6f63 6b65 725f 7573 6572  .    docker_user
-0000b960: 203d 204e 6f6e 650a 2020 2020 6966 2027   = None.    if '
-0000b970: 646f 636b 6572 2720 696e 2063 6f6e 6669  docker' in confi
-0000b980: 673a 0a20 2020 2020 2020 2064 6f63 6b65  g:.        docke
-0000b990: 725f 7573 6572 203d 2067 6574 5f64 6f63  r_user = get_doc
-0000b9a0: 6b65 725f 7573 6572 2868 6561 645f 6970  ker_user(head_ip
-0000b9b0: 2c20 636c 7573 7465 725f 636f 6e66 6967  , cluster_config
-0000b9c0: 5f66 696c 6529 0a0a 2020 2020 6966 206e  _file)..    if n
-0000b9d0: 756d 5f6e 6f64 6573 203c 3d20 313a 0a20  um_nodes <= 1:. 
-0000b9e0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000b9f0: 7565 2c20 646f 636b 6572 5f75 7365 720a  ue, docker_user.
-0000ba00: 0a20 2020 2073 7368 5f63 7265 6465 6e74  .    ssh_credent
-0000ba10: 6961 6c73 203d 2073 7368 5f63 7265 6465  ials = ssh_crede
-0000ba20: 6e74 6961 6c5f 6672 6f6d 5f79 616d 6c28  ntial_from_yaml(
-0000ba30: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
-0000ba40: 696c 652c 2064 6f63 6b65 725f 7573 6572  ile, docker_user
-0000ba50: 290a 2020 2020 6c61 7374 5f6e 6f64 6573  ).    last_nodes
-0000ba60: 5f73 6f5f 6661 7220 3d20 300a 2020 2020  _so_far = 0.    
-0000ba70: 7374 6172 7420 3d20 7469 6d65 2e74 696d  start = time.tim
-0000ba80: 6528 290a 2020 2020 7275 6e6e 6572 203d  e().    runner =
-0000ba90: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
-0000baa0: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
-0000bab0: 2868 6561 645f 6970 2c0a 2020 2020 2020  (head_ip,.      
-0000bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bae0: 2020 2020 2020 2070 6f72 743d 3232 2c0a         port=22,.
-0000baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb10: 2020 2020 2020 2020 2020 2020 202a 2a73               **s
-0000bb20: 7368 5f63 7265 6465 6e74 6961 6c73 290a  sh_credentials).
-0000bb30: 2020 2020 7769 7468 2072 6963 685f 7574      with rich_ut
-0000bb40: 696c 732e 7361 6665 5f73 7461 7475 7328  ils.safe_status(
-0000bb50: 0a20 2020 2020 2020 2020 2020 2027 5b62  .            '[b
-0000bb60: 6f6c 6420 6379 616e 5d57 6169 7469 6e67  old cyan]Waiting
-0000bb70: 2066 6f72 2077 6f72 6b65 7273 2e2e 2e27   for workers...'
-0000bb80: 2920 6173 2077 6f72 6b65 725f 7374 6174  ) as worker_stat
-0000bb90: 7573 3a0a 2020 2020 2020 2020 7768 696c  us:.        whil
-0000bba0: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
-0000bbb0: 2020 2020 7263 2c20 6f75 7470 7574 2c20      rc, output, 
-0000bbc0: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
-0000bbd0: 7275 6e28 0a20 2020 2020 2020 2020 2020  run(.           
-0000bbe0: 2020 2020 2069 6e73 7461 6e63 655f 7365       instance_se
-0000bbf0: 7475 702e 5241 595f 5354 4154 5553 5f57  tup.RAY_STATUS_W
-0000bc00: 4954 485f 534b 595f 5241 595f 504f 5254  ITH_SKY_RAY_PORT
-0000bc10: 5f43 4f4d 4d41 4e44 2c0a 2020 2020 2020  _COMMAND,.      
-0000bc20: 2020 2020 2020 2020 2020 6c6f 675f 7061            log_pa
-0000bc30: 7468 3d6c 6f67 5f70 6174 682c 0a20 2020  th=log_path,.   
-0000bc40: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0000bc50: 6561 6d5f 6c6f 6773 3d46 616c 7365 2c0a  eam_logs=False,.
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 7265 7175 6972 655f 6f75 7470 7574 733d  require_outputs=
-0000bc80: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0000bc90: 2020 2020 2020 7365 7061 7261 7465 5f73        separate_s
-0000bca0: 7464 6572 723d 5472 7565 290a 2020 2020  tderr=True).    
-0000bcb0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0000bcc0: 7373 5f75 7469 6c73 2e68 616e 646c 655f  ss_utils.handle_
-0000bcd0: 7265 7475 726e 636f 6465 280a 2020 2020  returncode(.    
-0000bce0: 2020 2020 2020 2020 2020 2020 7263 2c20              rc, 
-0000bcf0: 696e 7374 616e 6365 5f73 6574 7570 2e52  instance_setup.R
-0000bd00: 4159 5f53 5441 5455 535f 5749 5448 5f53  AY_STATUS_WITH_S
-0000bd10: 4b59 5f52 4159 5f50 4f52 545f 434f 4d4d  KY_RAY_PORT_COMM
-0000bd20: 414e 442c 0a20 2020 2020 2020 2020 2020  AND,.           
-0000bd30: 2020 2020 2027 4661 696c 6564 2074 6f20       'Failed to 
-0000bd40: 7275 6e20 7261 7920 7374 6174 7573 206f  run ray status o
-0000bd50: 6e20 6865 6164 206e 6f64 652e 272c 2073  n head node.', s
-0000bd60: 7464 6572 7229 0a20 2020 2020 2020 2020  tderr).         
-0000bd70: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0000bd80: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
-0000bd90: 2020 2020 2072 6561 6479 5f68 6561 642c       ready_head,
-0000bda0: 2072 6561 6479 5f77 6f72 6b65 7273 203d   ready_workers =
-0000bdb0: 205f 636f 756e 745f 6865 616c 7468 795f   _count_healthy_
-0000bdc0: 6e6f 6465 735f 6672 6f6d 5f72 6179 280a  nodes_from_ray(.
-0000bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bde0: 6f75 7470 7574 2c20 6973 5f6c 6f63 616c  output, is_local
-0000bdf0: 5f63 6c6f 7564 3d69 735f 6c6f 6361 6c5f  _cloud=is_local_
-0000be00: 636c 6f75 6429 0a0a 2020 2020 2020 2020  cloud)..        
-0000be10: 2020 2020 776f 726b 6572 5f73 7461 7475      worker_statu
-0000be20: 732e 7570 6461 7465 2827 5b62 6f6c 6420  s.update('[bold 
-0000be30: 6379 616e 5d27 0a20 2020 2020 2020 2020  cyan]'.         
-0000be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be50: 2020 2020 2020 2020 6627 7b72 6561 6479          f'{ready
-0000be60: 5f77 6f72 6b65 7273 7d20 6f75 7420 6f66  _workers} out of
-0000be70: 207b 6e75 6d5f 6e6f 6465 7320 2d20 317d   {num_nodes - 1}
-0000be80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bea0: 2020 2020 2777 6f72 6b65 7273 2072 6561      'workers rea
-0000beb0: 6479 2729 0a0a 2020 2020 2020 2020 2020  dy')..          
-0000bec0: 2020 2320 496e 2074 6865 206c 6f63 616c    # In the local
-0000bed0: 2063 6173 652c 2072 6561 6479 5f68 6561   case, ready_hea
-0000bee0: 643d 3020 616e 6420 7265 6164 795f 776f  d=0 and ready_wo
-0000bef0: 726b 6572 733d 6e75 6d5f 6e6f 6465 732e  rkers=num_nodes.
-0000bf00: 2054 6869 730a 2020 2020 2020 2020 2020   This.          
-0000bf10: 2020 2320 6973 2062 6563 6175 7365 2074    # is because t
-0000bf20: 6865 7265 2069 7320 6e6f 206d 6174 6368  here is no match
-0000bf30: 696e 6720 7265 6765 7820 666f 7220 5f4c  ing regex for _L
-0000bf40: 4155 4e43 4845 445f 4845 4144 5f50 4154  AUNCHED_HEAD_PAT
-0000bf50: 5445 524e 2e0a 2020 2020 2020 2020 2020  TERN..          
-0000bf60: 2020 6966 2072 6561 6479 5f68 6561 6420    if ready_head 
-0000bf70: 2b20 7265 6164 795f 776f 726b 6572 7320  + ready_workers 
-0000bf80: 3d3d 206e 756d 5f6e 6f64 6573 3a0a 2020  == num_nodes:.  
-0000bf90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000bfa0: 416c 6c20 6e6f 6465 7320 6172 6520 7570  All nodes are up
-0000bfb0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000bfc0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-0000bfd0: 2020 2020 2023 2050 656e 6469 6e67 2077       # Pending w
-0000bfe0: 6f72 6b65 7273 2074 6861 7420 6861 7665  orkers that have
-0000bff0: 2062 6565 6e20 6c61 756e 6368 6564 2062   been launched b
-0000c000: 7920 7261 7920 7570 2e0a 2020 2020 2020  y ray up..      
-0000c010: 2020 2020 2020 666f 756e 645f 6970 7320        found_ips 
-0000c020: 3d20 5f4c 4155 4e43 4849 4e47 5f49 505f  = _LAUNCHING_IP_
-0000c030: 5041 5454 4552 4e2e 6669 6e64 616c 6c28  PATTERN.findall(
-0000c040: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
-0000c050: 2020 2020 7065 6e64 696e 675f 776f 726b      pending_work
-0000c060: 6572 7320 3d20 6c65 6e28 666f 756e 645f  ers = len(found_
-0000c070: 6970 7329 0a0a 2020 2020 2020 2020 2020  ips)..          
-0000c080: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-0000c090: 4861 6e64 6c65 2074 6865 2063 6173 6520  Handle the case 
-0000c0a0: 7768 6572 6520 7468 6520 666f 6c6c 6f77  where the follow
-0000c0b0: 696e 6720 6f63 6375 7273 2c20 7768 6572  ing occurs, wher
-0000c0c0: 6520 7261 790a 2020 2020 2020 2020 2020  e ray.          
-0000c0d0: 2020 2320 636c 7573 7465 7220 6973 206e    # cluster is n
-0000c0e0: 6f74 2063 6f72 7265 6374 6c79 2073 7461  ot correctly sta
-0000c0f0: 7274 6564 206f 6e20 7468 6520 636c 7573  rted on the clus
-0000c100: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
-0000c110: 2023 2050 656e 6469 6e67 3a0a 2020 2020   # Pending:.    
-0000c120: 2020 2020 2020 2020 2320 2031 3732 2e33          #  172.3
-0000c130: 312e 392e 3132 313a 2072 6179 2e77 6f72  1.9.121: ray.wor
-0000c140: 6b65 722e 6465 6661 756c 742c 2075 6e69  ker.default, uni
-0000c150: 6e69 7469 616c 697a 6564 0a20 2020 2020  nitialized.     
-0000c160: 2020 2020 2020 206e 6f64 6573 5f73 6f5f         nodes_so_
-0000c170: 6661 7220 3d20 7265 6164 795f 6865 6164  far = ready_head
-0000c180: 202b 2072 6561 6479 5f77 6f72 6b65 7273   + ready_workers
-0000c190: 202b 2070 656e 6469 6e67 5f77 6f72 6b65   + pending_worke
-0000c1a0: 7273 0a0a 2020 2020 2020 2020 2020 2020  rs..            
-0000c1b0: 2320 4368 6563 6b20 7468 6520 6e75 6d62  # Check the numb
-0000c1c0: 6572 206f 6620 6e6f 6465 7320 7468 6174  er of nodes that
-0000c1d0: 2061 7265 2066 6574 6368 6564 2e20 5469   are fetched. Ti
-0000c1e0: 6d65 6f75 7420 6966 206e 6f20 6e65 770a  meout if no new.
-0000c1f0: 2020 2020 2020 2020 2020 2020 2320 6e6f              # no
-0000c200: 6465 7320 6665 7463 6865 6420 696e 2061  des fetched in a
-0000c210: 2077 6869 6c65 2028 6e6f 6465 735f 6c61   while (nodes_la
-0000c220: 756e 6368 696e 675f 7072 6f67 7265 7373  unching_progress
-0000c230: 5f74 696d 656f 7574 292c 0a20 2020 2020  _timeout),.     
-0000c240: 2020 2020 2020 2023 2074 686f 7567 6820         # though 
-0000c250: 6e75 6d62 6572 206f 6620 6e6f 6465 735f  number of nodes_
-0000c260: 736f 5f66 6172 2069 7320 7374 696c 6c20  so_far is still 
-0000c270: 6e6f 7420 6173 2065 7870 6563 7465 642e  not as expected.
-0000c280: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c290: 6e6f 6465 735f 736f 5f66 6172 203e 206c  nodes_so_far > l
-0000c2a0: 6173 745f 6e6f 6465 735f 736f 5f66 6172  ast_nodes_so_far
-0000c2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c2c0: 2020 2320 5265 7365 7420 7468 6520 7374    # Reset the st
-0000c2d0: 6172 7420 7469 6d65 2069 6620 7468 6520  art time if the 
-0000c2e0: 6e75 6d62 6572 206f 6620 6c61 756e 6368  number of launch
-0000c2f0: 696e 6720 6e6f 6465 730a 2020 2020 2020  ing nodes.      
-0000c300: 2020 2020 2020 2020 2020 2320 6368 616e            # chan
-0000c310: 6765 732c 2069 2e65 2e20 6e65 7720 6e6f  ges, i.e. new no
-0000c320: 6465 7320 6172 6520 6c61 756e 6368 6564  des are launched
-0000c330: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000c340: 2020 6c6f 6767 6572 2e64 6562 7567 2827    logger.debug('
-0000c350: 5265 7365 7420 7374 6172 7420 7469 6d65  Reset start time
-0000c360: 2c20 6173 206e 6577 206e 6f64 6573 2061  , as new nodes a
-0000c370: 7265 206c 6175 6e63 6865 642e 2027 0a20  re launched. '. 
-0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c390: 2020 2020 2020 2020 2020 2020 6627 287b              f'({
-0000c3a0: 6c61 7374 5f6e 6f64 6573 5f73 6f5f 6661  last_nodes_so_fa
-0000c3b0: 727d 202d 3e20 7b6e 6f64 6573 5f73 6f5f  r} -> {nodes_so_
-0000c3c0: 6661 727d 2927 290a 2020 2020 2020 2020  far})').        
-0000c3d0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-0000c3e0: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
-0000c3f0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-0000c400: 5f6e 6f64 6573 5f73 6f5f 6661 7220 3d20  _nodes_so_far = 
-0000c410: 6e6f 6465 735f 736f 5f66 6172 0a20 2020  nodes_so_far.   
-0000c420: 2020 2020 2020 2020 2065 6c69 6620 286e           elif (n
-0000c430: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
-0000c440: 726f 6772 6573 735f 7469 6d65 6f75 7420  rogress_timeout 
-0000c450: 6973 206e 6f74 204e 6f6e 6520 616e 640a  is not None and.
-0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c470: 2020 7469 6d65 2e74 696d 6528 2920 2d20    time.time() - 
-0000c480: 7374 6172 7420 3e20 6e6f 6465 735f 6c61  start > nodes_la
-0000c490: 756e 6368 696e 675f 7072 6f67 7265 7373  unching_progress
-0000c4a0: 5f74 696d 656f 7574 2061 6e64 0a20 2020  _timeout and.   
-0000c4b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000c4c0: 6f64 6573 5f73 6f5f 6661 7220 213d 206e  odes_so_far != n
-0000c4d0: 756d 5f6e 6f64 6573 293a 0a20 2020 2020  um_nodes):.     
-0000c4e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000c4f0: 722e 6572 726f 7228 0a20 2020 2020 2020  r.error(.       
-0000c500: 2020 2020 2020 2020 2020 2020 2027 5469               'Ti
-0000c510: 6d65 6420 6f75 743a 2077 6169 7465 6420  med out: waited 
-0000c520: 666f 7220 6d6f 7265 2074 6861 6e20 270a  for more than '.
-0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c540: 2020 2020 6627 7b6e 6f64 6573 5f6c 6175      f'{nodes_lau
-0000c550: 6e63 6869 6e67 5f70 726f 6772 6573 735f  nching_progress_
-0000c560: 7469 6d65 6f75 747d 2073 6563 6f6e 6473  timeout} seconds
-0000c570: 2066 6f72 206e 6577 2027 0a20 2020 2020   for new '.     
-0000c580: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000c590: 776f 726b 6572 7320 746f 2062 6520 7072  workers to be pr
-0000c5a0: 6f76 6973 696f 6e65 642c 2062 7574 206e  ovisioned, but n
-0000c5b0: 6f20 7072 6f67 7265 7373 2e27 290a 2020  o progress.').  
-0000c5c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000c5d0: 7475 726e 2046 616c 7365 2c20 4e6f 6e65  turn False, None
-0000c5e0: 2020 2320 6661 696c 6564 0a0a 2020 2020    # failed..    
-0000c5f0: 2020 2020 2020 2020 6966 2027 286e 6f20          if '(no 
-0000c600: 7065 6e64 696e 6720 6e6f 6465 7329 2720  pending nodes)' 
-0000c610: 696e 206f 7574 7075 7420 616e 6420 2728  in output and '(
-0000c620: 6e6f 2066 6169 6c75 7265 7329 2720 696e  no failures)' in
-0000c630: 206f 7574 7075 743a 0a20 2020 2020 2020   output:.       
-0000c640: 2020 2020 2020 2020 2023 2042 7567 2069           # Bug i
-0000c650: 6e20 7261 7920 6175 746f 7363 616c 6572  n ray autoscaler
-0000c660: 3a20 652e 672e 2c20 6f6e 2047 4350 2c20  : e.g., on GCP, 
-0000c670: 6966 2072 6571 7565 7374 696e 6720 3220  if requesting 2 
-0000c680: 6e6f 6465 730a 2020 2020 2020 2020 2020  nodes.          
-0000c690: 2020 2020 2020 2320 7468 6174 2047 4350        # that GCP
-0000c6a0: 2063 616e 2073 6174 6973 6679 206f 6e6c   can satisfy onl
-0000c6b0: 7920 6279 2068 616c 662c 2074 6865 2077  y by half, the w
-0000c6c0: 6f72 6b65 7220 6e6f 6465 2077 6f75 6c64  orker node would
-0000c6d0: 2062 650a 2020 2020 2020 2020 2020 2020   be.            
-0000c6e0: 2020 2020 2320 666f 7267 6f74 7465 6e2e      # forgotten.
-0000c6f0: 2054 6865 2063 6f72 7265 6374 2062 6568   The correct beh
-0000c700: 6176 696f 7220 7368 6f75 6c64 2062 6520  avior should be 
-0000c710: 666f 7220 6974 2074 6f20 6572 726f 7220  for it to error 
-0000c720: 6f75 742e 0a20 2020 2020 2020 2020 2020  out..           
-0000c730: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
-0000c740: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000c750: 2020 2020 2020 2027 4661 696c 6564 2074         'Failed t
-0000c760: 6f20 6c61 756e 6368 206d 756c 7469 706c  o launch multipl
-0000c770: 6520 6e6f 6465 7320 6f6e 2027 0a20 2020  e nodes on '.   
-0000c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c790: 2027 4743 5020 6475 6520 746f 2061 206e   'GCP due to a n
-0000c7a0: 6f6e 6465 7465 726d 696e 6973 7469 6320  ondeterministic 
-0000c7b0: 6275 6720 696e 2072 6179 2061 7574 6f73  bug in ray autos
-0000c7c0: 6361 6c65 722e 2729 0a20 2020 2020 2020  caler.').       
-0000c7d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c7e0: 4661 6c73 652c 204e 6f6e 6520 2023 2066  False, None  # f
-0000c7f0: 6169 6c65 640a 2020 2020 2020 2020 2020  ailed.          
-0000c800: 2020 7469 6d65 2e73 6c65 6570 2831 3029    time.sleep(10)
-0000c810: 0a20 2020 2072 6574 7572 6e20 5472 7565  .    return True
-0000c820: 2c20 646f 636b 6572 5f75 7365 7220 2023  , docker_user  #
-0000c830: 2073 7563 6365 7373 0a0a 0a64 6566 2073   success...def s
-0000c840: 7368 5f63 7265 6465 6e74 6961 6c5f 6672  sh_credential_fr
-0000c850: 6f6d 5f79 616d 6c28 0a20 2020 2063 6c75  om_yaml(.    clu
-0000c860: 7374 6572 5f79 616d 6c3a 2073 7472 2c0a  ster_yaml: str,.
-0000c870: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
-0000c880: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0000c890: 204e 6f6e 652c 0a20 2020 2073 7368 5f75   None,.    ssh_u
-0000c8a0: 7365 723a 204f 7074 696f 6e61 6c5b 7374  ser: Optional[st
-0000c8b0: 725d 203d 204e 6f6e 652c 0a29 202d 3e20  r] = None,.) -> 
-0000c8c0: 4469 6374 5b73 7472 2c20 416e 795d 3a0a  Dict[str, Any]:.
-0000c8d0: 2020 2020 2222 2252 6574 7572 6e73 2073      """Returns s
-0000c8e0: 7368 5f75 7365 722c 2073 7368 5f70 7269  sh_user, ssh_pri
-0000c8f0: 7661 7465 5f6b 6579 2061 6e64 2073 7368  vate_key and ssh
-0000c900: 5f63 6f6e 7472 6f6c 206e 616d 652e 0a0a  _control name...
-0000c910: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000c920: 2020 636c 7573 7465 725f 7961 6d6c 3a20    cluster_yaml: 
-0000c930: 7061 7468 2074 6f20 7468 6520 636c 7573  path to the clus
-0000c940: 7465 7220 7961 6d6c 2e0a 2020 2020 2020  ter yaml..      
-0000c950: 2020 646f 636b 6572 5f75 7365 723a 2077    docker_user: w
-0000c960: 6865 6e20 7573 696e 6720 6375 7374 6f6d  hen using custom
-0000c970: 2064 6f63 6b65 7220 696d 6167 652c 2075   docker image, u
-0000c980: 7365 2074 6869 7320 7573 6572 2074 6f20  se this user to 
-0000c990: 7373 6820 696e 746f 0a20 2020 2020 2020  ssh into.       
-0000c9a0: 2020 2020 2074 6865 2064 6f63 6b65 7220       the docker 
-0000c9b0: 636f 6e74 6169 6e65 722e 0a20 2020 2020  container..     
-0000c9c0: 2020 2073 7368 5f75 7365 723a 206f 7665     ssh_user: ove
-0000c9d0: 7272 6964 6520 7468 6520 7373 685f 7573  rride the ssh_us
-0000c9e0: 6572 2069 6e20 7468 6520 636c 7573 7465  er in the cluste
-0000c9f0: 7220 7961 6d6c 2e0a 2020 2020 2222 220a  r yaml..    """.
-0000ca00: 2020 2020 636f 6e66 6967 203d 2063 6f6d      config = com
-0000ca10: 6d6f 6e5f 7574 696c 732e 7265 6164 5f79  mon_utils.read_y
-0000ca20: 616d 6c28 636c 7573 7465 725f 7961 6d6c  aml(cluster_yaml
-0000ca30: 290a 2020 2020 6175 7468 5f73 6563 7469  ).    auth_secti
-0000ca40: 6f6e 203d 2063 6f6e 6669 675b 2761 7574  on = config['aut
-0000ca50: 6827 5d0a 2020 2020 6966 2073 7368 5f75  h'].    if ssh_u
-0000ca60: 7365 7220 6973 204e 6f6e 653a 0a20 2020  ser is None:.   
-0000ca70: 2020 2020 2073 7368 5f75 7365 7220 3d20       ssh_user = 
-0000ca80: 6175 7468 5f73 6563 7469 6f6e 5b27 7373  auth_section['ss
-0000ca90: 685f 7573 6572 275d 2e73 7472 6970 2829  h_user'].strip()
-0000caa0: 0a20 2020 2073 7368 5f70 7269 7661 7465  .    ssh_private
-0000cab0: 5f6b 6579 203d 2061 7574 685f 7365 6374  _key = auth_sect
-0000cac0: 696f 6e2e 6765 7428 2773 7368 5f70 7269  ion.get('ssh_pri
-0000cad0: 7661 7465 5f6b 6579 2729 0a20 2020 2073  vate_key').    s
-0000cae0: 7368 5f63 6f6e 7472 6f6c 5f6e 616d 6520  sh_control_name 
-0000caf0: 3d20 636f 6e66 6967 2e67 6574 2827 636c  = config.get('cl
-0000cb00: 7573 7465 725f 6e61 6d65 272c 2027 5f5f  uster_name', '__
-0000cb10: 6465 6661 756c 745f 5f27 290a 2020 2020  default__').    
-0000cb20: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-0000cb30: 6420 3d20 6175 7468 5f73 6563 7469 6f6e  d = auth_section
-0000cb40: 2e67 6574 2827 7373 685f 7072 6f78 795f  .get('ssh_proxy_
-0000cb50: 636f 6d6d 616e 6427 290a 2020 2020 6372  command').    cr
-0000cb60: 6564 656e 7469 616c 7320 3d20 7b0a 2020  edentials = {.  
-0000cb70: 2020 2020 2020 2773 7368 5f75 7365 7227        'ssh_user'
-0000cb80: 3a20 7373 685f 7573 6572 2c0a 2020 2020  : ssh_user,.    
-0000cb90: 2020 2020 2773 7368 5f70 7269 7661 7465      'ssh_private
-0000cba0: 5f6b 6579 273a 2073 7368 5f70 7269 7661  _key': ssh_priva
-0000cbb0: 7465 5f6b 6579 2c0a 2020 2020 2020 2020  te_key,.        
-0000cbc0: 2773 7368 5f63 6f6e 7472 6f6c 5f6e 616d  'ssh_control_nam
-0000cbd0: 6527 3a20 7373 685f 636f 6e74 726f 6c5f  e': ssh_control_
-0000cbe0: 6e61 6d65 2c0a 2020 2020 2020 2020 2773  name,.        's
-0000cbf0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-0000cc00: 273a 2073 7368 5f70 726f 7879 5f63 6f6d  ': ssh_proxy_com
-0000cc10: 6d61 6e64 2c0a 2020 2020 7d0a 2020 2020  mand,.    }.    
-0000cc20: 6966 2064 6f63 6b65 725f 7573 6572 2069  if docker_user i
-0000cc30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000cc40: 2020 2020 6372 6564 656e 7469 616c 735b      credentials[
-0000cc50: 2764 6f63 6b65 725f 7573 6572 275d 203d  'docker_user'] =
-0000cc60: 2064 6f63 6b65 725f 7573 6572 0a20 2020   docker_user.   
-0000cc70: 2073 7368 5f70 726f 7669 6465 725f 6d6f   ssh_provider_mo
-0000cc80: 6475 6c65 203d 2063 6f6e 6669 675b 2770  dule = config['p
-0000cc90: 726f 7669 6465 7227 5d5b 276d 6f64 756c  rovider']['modul
-0000cca0: 6527 5d0a 2020 2020 2320 4966 2077 6520  e'].    # If we 
-0000ccb0: 6172 6520 7275 6e6e 696e 6720 7373 6820  are running ssh 
-0000ccc0: 636f 6d6d 616e 6420 6f6e 206b 7562 6572  command on kuber
-0000ccd0: 6e65 7465 7320 6e6f 6465 2e0a 2020 2020  netes node..    
-0000cce0: 6966 2027 6b75 6265 726e 6574 6573 2720  if 'kubernetes' 
-0000ccf0: 696e 2073 7368 5f70 726f 7669 6465 725f  in ssh_provider_
-0000cd00: 6d6f 6475 6c65 3a0a 2020 2020 2020 2020  module:.        
-0000cd10: 6372 6564 656e 7469 616c 735b 2764 6973  credentials['dis
-0000cd20: 6162 6c65 5f63 6f6e 7472 6f6c 5f6d 6173  able_control_mas
-0000cd30: 7465 7227 5d20 3d20 5472 7565 0a20 2020  ter'] = True.   
-0000cd40: 2072 6574 7572 6e20 6372 6564 656e 7469   return credenti
-0000cd50: 616c 730a 0a0a 6465 6620 7061 7261 6c6c  als...def parall
-0000cd60: 656c 5f64 6174 615f 7472 616e 7366 6572  el_data_transfer
-0000cd70: 5f74 6f5f 6e6f 6465 7328 0a20 2020 2072  _to_nodes(.    r
-0000cd80: 756e 6e65 7273 3a20 4c69 7374 5b63 6f6d  unners: List[com
-0000cd90: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
-0000cda0: 6f6d 6d61 6e64 5275 6e6e 6572 5d2c 0a20  ommandRunner],. 
-0000cdb0: 2020 2073 6f75 7263 653a 204f 7074 696f     source: Optio
-0000cdc0: 6e61 6c5b 7374 725d 2c0a 2020 2020 7461  nal[str],.    ta
-0000cdd0: 7267 6574 3a20 7374 722c 0a20 2020 2063  rget: str,.    c
-0000cde0: 6d64 3a20 4f70 7469 6f6e 616c 5b73 7472  md: Optional[str
-0000cdf0: 5d2c 0a20 2020 2072 756e 5f72 7379 6e63  ],.    run_rsync
-0000ce00: 3a20 626f 6f6c 2c0a 2020 2020 2a2c 0a20  : bool,.    *,. 
-0000ce10: 2020 2061 6374 696f 6e5f 6d65 7373 6167     action_messag
-0000ce20: 653a 2073 7472 2c0a 2020 2020 2320 4164  e: str,.    # Ad
-0000ce30: 7661 6e63 6564 206f 7074 696f 6e73 2e0a  vanced options..
-0000ce40: 2020 2020 6c6f 675f 7061 7468 3a20 7374      log_path: st
-0000ce50: 7220 3d20 6f73 2e64 6576 6e75 6c6c 2c0a  r = os.devnull,.
-0000ce60: 2020 2020 7374 7265 616d 5f6c 6f67 733a      stream_logs:
-0000ce70: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
-0000ce80: 3a0a 2020 2020 2222 2252 756e 7320 6120  :.    """Runs a 
-0000ce90: 636f 6d6d 616e 6420 6f6e 2061 6c6c 206e  command on all n
-0000cea0: 6f64 6573 2061 6e64 206f 7074 696f 6e61  odes and optiona
-0000ceb0: 6c6c 7920 7275 6e73 2072 7379 6e63 2066  lly runs rsync f
-0000cec0: 726f 6d20 7372 632d 3e64 7374 2e0a 0a20  rom src->dst... 
-0000ced0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000cee0: 2072 756e 6e65 7273 3a20 4120 6c69 7374   runners: A list
-0000cef0: 206f 6620 5353 4843 6f6d 6d61 6e64 5275   of SSHCommandRu
-0000cf00: 6e6e 6572 206f 626a 6563 7473 2074 6861  nner objects tha
-0000cf10: 7420 7265 7072 6573 656e 7420 6d75 6c74  t represent mult
-0000cf20: 6970 6c65 206e 6f64 6573 2e0a 2020 2020  iple nodes..    
-0000cf30: 2020 2020 736f 7572 6365 3a20 4f70 7469      source: Opti
-0000cf40: 6f6e 616c 5b73 7472 5d3b 2053 6f75 7263  onal[str]; Sourc
-0000cf50: 6520 666f 7220 7273 796e 6320 6f6e 206c  e for rsync on l
-0000cf60: 6f63 616c 206e 6f64 650a 2020 2020 2020  ocal node.      
-0000cf70: 2020 7461 7267 6574 3a20 7374 723b 2044    target: str; D
-0000cf80: 6573 7469 6e61 7469 6f6e 206f 6e20 7265  estination on re
-0000cf90: 6d6f 7465 206e 6f64 6520 666f 7220 7273  mote node for rs
-0000cfa0: 796e 630a 2020 2020 2020 2020 636d 643a  ync.        cmd:
-0000cfb0: 2073 7472 3b20 436f 6d6d 616e 6420 746f   str; Command to
-0000cfc0: 2062 6520 6578 6563 7574 6564 206f 6e20   be executed on 
-0000cfd0: 616c 6c20 6e6f 6465 730a 2020 2020 2020  all nodes.      
-0000cfe0: 2020 6163 7469 6f6e 5f6d 6573 7361 6765    action_message
-0000cff0: 3a20 7374 723b 204d 6573 7361 6765 2074  : str; Message t
-0000d000: 6f20 6265 2070 7269 6e74 6564 2077 6869  o be printed whi
-0000d010: 6c65 2074 6865 2063 6f6d 6d61 6e64 2072  le the command r
-0000d020: 756e 730a 2020 2020 2020 2020 6c6f 675f  uns.        log_
-0000d030: 7061 7468 3a20 7374 723b 2050 6174 6820  path: str; Path 
-0000d040: 746f 2074 6865 206c 6f67 2066 696c 650a  to the log file.
-0000d050: 2020 2020 2020 2020 7374 7265 616d 5f6c          stream_l
-0000d060: 6f67 733a 2062 6f6f 6c3b 2057 6865 7468  ogs: bool; Wheth
-0000d070: 6572 2074 6f20 7374 7265 616d 206c 6f67  er to stream log
-0000d080: 7320 746f 2073 7464 6f75 740a 2020 2020  s to stdout.    
-0000d090: 2222 220a 2020 2020 666f 7265 203d 2063  """.    fore = c
-0000d0a0: 6f6c 6f72 616d 612e 466f 7265 0a20 2020  olorama.Fore.   
-0000d0b0: 2073 7479 6c65 203d 2063 6f6c 6f72 616d   style = coloram
-0000d0c0: 612e 5374 796c 650a 0a20 2020 206f 7269  a.Style..    ori
-0000d0d0: 6769 6e5f 736f 7572 6365 203d 2073 6f75  gin_source = sou
-0000d0e0: 7263 650a 0a20 2020 2064 6566 205f 7379  rce..    def _sy
-0000d0f0: 6e63 5f6e 6f64 6528 7275 6e6e 6572 3a20  nc_node(runner: 
-0000d100: 2763 6f6d 6d61 6e64 5f72 756e 6e65 722e  'command_runner.
-0000d110: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
-0000d120: 2729 202d 3e20 4e6f 6e65 3a0a 2020 2020  ') -> None:.    
-0000d130: 2020 2020 6966 2063 6d64 2069 7320 6e6f      if cmd is no
-0000d140: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000d150: 2020 2020 7263 2c20 7374 646f 7574 2c20      rc, stdout, 
-0000d160: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
-0000d170: 7275 6e28 636d 642c 0a20 2020 2020 2020  run(cmd,.       
-0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1a0: 2020 2020 206c 6f67 5f70 6174 683d 6c6f       log_path=lo
-0000d1b0: 675f 7061 7468 2c0a 2020 2020 2020 2020  g_path,.        
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1e0: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
-0000d1f0: 7374 7265 616d 5f6c 6f67 732c 0a20 2020  stream_logs,.   
-0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d220: 2020 2020 2020 2020 2072 6571 7569 7265           require
-0000d230: 5f6f 7574 7075 7473 3d54 7275 6529 0a20  _outputs=True). 
-0000d240: 2020 2020 2020 2020 2020 2065 7272 5f6d             err_m
-0000d250: 7367 203d 2028 2746 6169 6c65 6420 746f  sg = ('Failed to
-0000d260: 2072 756e 2063 6f6d 6d61 6e64 2062 6566   run command bef
-0000d270: 6f72 6520 7273 796e 6320 270a 2020 2020  ore rsync '.    
-0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d290: 2020 2066 277b 6f72 6967 696e 5f73 6f75     f'{origin_sou
-0000d2a0: 7263 657d 202d 3e20 7b74 6172 6765 747d  rce} -> {target}
-0000d2b0: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
-0000d2c0: 2020 2020 2020 2020 2020 2027 456e 7375             'Ensu
-0000d2d0: 7265 2074 6861 7420 7468 6520 6e65 7477  re that the netw
-0000d2e0: 6f72 6b20 6973 2073 7461 626c 652c 2074  ork is stable, t
-0000d2f0: 6865 6e20 7265 7472 792e 2729 0a20 2020  hen retry.').   
-0000d300: 2020 2020 2020 2020 2069 6620 6c6f 675f           if log_
-0000d310: 7061 7468 2021 3d20 6f73 2e64 6576 6e75  path != os.devnu
-0000d320: 6c6c 3a0a 2020 2020 2020 2020 2020 2020  ll:.            
-0000d330: 2020 2020 6572 725f 6d73 6720 2b3d 2066      err_msg += f
-0000d340: 2720 5365 6520 6c6f 6773 2069 6e20 7b6c  ' See logs in {l
-0000d350: 6f67 5f70 6174 687d 270a 2020 2020 2020  og_path}'.      
-0000d360: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0000d370: 5f75 7469 6c73 2e68 616e 646c 655f 7265  _utils.handle_re
-0000d380: 7475 726e 636f 6465 2872 632c 0a20 2020  turncode(rc,.   
+00009580: 2320 5573 6572 2d73 7570 706c 6965 6420  # User-supplied 
+00009590: 6c61 6265 6c73 2e0a 2020 2020 2020 2020  labels..        
+000095a0: 2020 2020 2020 2020 276c 6162 656c 7327          'labels'
+000095b0: 3a20 6c61 6265 6c73 2c0a 2020 2020 2020  : labels,.      
+000095c0: 2020 2020 2020 2020 2020 2320 5573 6572            # User
+000095d0: 2d73 7570 706c 6965 6420 7265 6d6f 7465  -supplied remote
+000095e0: 5f69 6465 6e74 6974 790a 2020 2020 2020  _identity.      
+000095f0: 2020 2020 2020 2020 2020 2772 656d 6f74            'remot
+00009600: 655f 6964 656e 7469 7479 273a 2072 656d  e_identity': rem
+00009610: 6f74 655f 6964 656e 7469 7479 2c0a 2020  ote_identity,.  
+00009620: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009630: 5468 6520 7265 7365 7276 6174 696f 6e20  The reservation 
+00009640: 706f 6f6c 7320 7468 6174 2073 7065 6369  pools that speci
+00009650: 6669 6564 2062 7920 7468 6520 7573 6572  fied by the user
+00009660: 2e20 5468 6973 2069 730a 2020 2020 2020  . This is.      
+00009670: 2020 2020 2020 2020 2020 2320 6375 7272            # curr
+00009680: 656e 746c 7920 6f6e 6c79 2075 7365 6420  ently only used 
+00009690: 6279 2047 4350 2e0a 2020 2020 2020 2020  by GCP..        
+000096a0: 2020 2020 2020 2020 2773 7065 6369 6669          'specifi
+000096b0: 635f 7265 7365 7276 6174 696f 6e73 273a  c_reservations':
+000096c0: 2073 7065 6369 6669 635f 7265 7365 7276   specific_reserv
+000096d0: 6174 696f 6e73 2c0a 0a20 2020 2020 2020  ations,..       
+000096e0: 2020 2020 2020 2020 2023 2043 6f6e 6461           # Conda
+000096f0: 2073 6574 7570 0a20 2020 2020 2020 2020   setup.         
+00009700: 2020 2020 2020 2027 636f 6e64 615f 696e         'conda_in
+00009710: 7374 616c 6c61 7469 6f6e 5f63 6f6d 6d61  stallation_comma
+00009720: 6e64 7327 3a0a 2020 2020 2020 2020 2020  nds':.          
+00009730: 2020 2020 2020 2020 2020 636f 6e73 7461            consta
+00009740: 6e74 732e 434f 4e44 415f 494e 5354 414c  nts.CONDA_INSTAL
+00009750: 4c41 5449 4f4e 5f43 4f4d 4d41 4e44 532c  LATION_COMMANDS,
+00009760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009770: 2023 2057 6520 7368 6f75 6c64 206e 6f74   # We should not
+00009780: 2075 7365 2060 2e66 6f72 6d61 7460 2c20   use `.format`, 
+00009790: 6173 2069 7420 636f 6e74 6169 6e73 2027  as it contains '
+000097a0: 7b7d 2720 6173 2074 6865 2062 6173 680a  {}' as the bash.
+000097b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097c0: 2320 7379 6e74 6178 2e0a 2020 2020 2020  # syntax..      
+000097d0: 2020 2020 2020 2020 2020 2772 6179 5f73            'ray_s
+000097e0: 6b79 7069 6c6f 745f 696e 7374 616c 6c61  kypilot_installa
+000097f0: 7469 6f6e 5f63 6f6d 6d61 6e64 7327 3a0a  tion_commands':.
+00009800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009810: 2020 2020 2863 6f6e 7374 616e 7473 2e52      (constants.R
+00009820: 4159 5f53 4b59 5049 4c4f 545f 494e 5354  AY_SKYPILOT_INST
+00009830: 414c 4c41 5449 4f4e 5f43 4f4d 4d41 4e44  ALLATION_COMMAND
+00009840: 532e 7265 706c 6163 6528 0a20 2020 2020  S.replace(.     
+00009850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009860: 2020 2027 7b73 6b79 5f77 6865 656c 5f68     '{sky_wheel_h
+00009870: 6173 687d 272c 0a20 2020 2020 2020 2020  ash}',.         
+00009880: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00009890: 6865 656c 5f68 6173 6829 2e72 6570 6c61  heel_hash).repla
+000098a0: 6365 2827 7b63 6c6f 7564 7d27 2c0a 2020  ce('{cloud}',.  
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098d0: 2020 2020 2020 2020 2020 7374 7228 636c            str(cl
+000098e0: 6f75 6429 2e6c 6f77 6572 2829 2929 2c0a  oud).lower())),.
+000098f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009900: 2023 2050 6f72 7420 6f66 2052 6179 2028   # Port of Ray (
+00009910: 4743 5320 7365 7276 6572 292e 0a20 2020  GCS server)..   
+00009920: 2020 2020 2020 2020 2020 2020 2023 2052               # R
+00009930: 6179 2773 2064 6566 6175 6c74 2070 6f72  ay's default por
+00009940: 7420 3633 3739 2069 7320 636f 6e66 6c69  t 6379 is confli
+00009950: 6374 6564 2077 6974 6820 5265 6469 732e  cted with Redis.
+00009960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009970: 2027 7261 795f 706f 7274 273a 2063 6f6e   'ray_port': con
+00009980: 7374 616e 7473 2e53 4b59 5f52 454d 4f54  stants.SKY_REMOT
+00009990: 455f 5241 595f 504f 5254 2c0a 2020 2020  E_RAY_PORT,.    
+000099a0: 2020 2020 2020 2020 2020 2020 2772 6179              'ray
+000099b0: 5f64 6173 6862 6f61 7264 5f70 6f72 7427  _dashboard_port'
+000099c0: 3a20 636f 6e73 7461 6e74 732e 534b 595f  : constants.SKY_
+000099d0: 5245 4d4f 5445 5f52 4159 5f44 4153 4842  REMOTE_RAY_DASHB
+000099e0: 4f41 5244 5f50 4f52 542c 0a20 2020 2020  OARD_PORT,.     
+000099f0: 2020 2020 2020 2020 2020 2027 7261 795f             'ray_
+00009a00: 7465 6d70 5f64 6972 273a 2063 6f6e 7374  temp_dir': const
+00009a10: 616e 7473 2e53 4b59 5f52 454d 4f54 455f  ants.SKY_REMOTE_
+00009a20: 5241 595f 5445 4d50 4449 522c 0a20 2020  RAY_TEMPDIR,.   
+00009a30: 2020 2020 2020 2020 2020 2020 2027 6475               'du
+00009a40: 6d70 5f70 6f72 745f 636f 6d6d 616e 6427  mp_port_command'
+00009a50: 3a20 6475 6d70 5f70 6f72 745f 636f 6d6d  : dump_port_comm
+00009a60: 616e 642c 0a20 2020 2020 2020 2020 2020  and,.           
+00009a70: 2020 2020 2023 2053 6b79 2d69 6e74 6572       # Sky-inter
+00009a80: 6e61 6c20 636f 6e73 7461 6e74 732e 0a20  nal constants.. 
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009aa0: 736b 795f 7261 795f 636d 6427 3a20 636f  sky_ray_cmd': co
+00009ab0: 6e73 7461 6e74 732e 534b 595f 5241 595f  nstants.SKY_RAY_
+00009ac0: 434d 442c 0a20 2020 2020 2020 2020 2020  CMD,.           
+00009ad0: 2020 2020 2027 736b 795f 7069 705f 636d       'sky_pip_cm
+00009ae0: 6427 3a20 636f 6e73 7461 6e74 732e 534b  d': constants.SK
+00009af0: 595f 5049 505f 434d 442c 0a20 2020 2020  Y_PIP_CMD,.     
+00009b00: 2020 2020 2020 2020 2020 2027 7261 795f             'ray_
+00009b10: 7665 7273 696f 6e27 3a20 636f 6e73 7461  version': consta
+00009b20: 6e74 732e 534b 595f 5245 4d4f 5445 5f52  nts.SKY_REMOTE_R
+00009b30: 4159 5f56 4552 5349 4f4e 2c0a 2020 2020  AY_VERSION,.    
+00009b40: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+00009b50: 6d6d 616e 6420 666f 7220 7761 6974 696e  mmand for waitin
+00009b60: 6720 7261 7920 636c 7573 7465 7220 746f  g ray cluster to
+00009b70: 2062 6520 7265 6164 7920 6f6e 2068 6561   be ready on hea
+00009b80: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
+00009b90: 2020 2027 7261 795f 6865 6164 5f77 6169     'ray_head_wai
+00009ba0: 745f 696e 6974 6961 6c69 7a65 645f 636f  t_initialized_co
+00009bb0: 6d6d 616e 6427 3a0a 2020 2020 2020 2020  mmand':.        
+00009bc0: 2020 2020 2020 2020 2020 2020 696e 7374              inst
+00009bd0: 616e 6365 5f73 6574 7570 2e52 4159 5f48  ance_setup.RAY_H
+00009be0: 4541 445f 5741 4954 5f49 4e49 5449 414c  EAD_WAIT_INITIAL
+00009bf0: 495a 4544 5f43 4f4d 4d41 4e44 2c0a 0a20  IZED_COMMAND,.. 
+00009c00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00009c10: 2043 6c6f 7564 2063 7265 6465 6e74 6961   Cloud credentia
+00009c20: 6c73 2066 6f72 2063 6c6f 7564 2073 746f  ls for cloud sto
+00009c30: 7261 6765 2e0a 2020 2020 2020 2020 2020  rage..          
+00009c40: 2020 2020 2020 2763 7265 6465 6e74 6961        'credentia
+00009c50: 6c73 273a 2063 7265 6465 6e74 6961 6c73  ls': credentials
+00009c60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009c70: 2020 2320 536b 7920 7265 6d6f 7465 2075    # Sky remote u
+00009c80: 7469 6c73 2e0a 2020 2020 2020 2020 2020  tils..          
+00009c90: 2020 2020 2020 2773 6b79 5f72 656d 6f74        'sky_remot
+00009ca0: 655f 7061 7468 273a 2053 4b59 5f52 454d  e_path': SKY_REM
+00009cb0: 4f54 455f 5041 5448 2c0a 2020 2020 2020  OTE_PATH,.      
+00009cc0: 2020 2020 2020 2020 2020 2773 6b79 5f6c            'sky_l
+00009cd0: 6f63 616c 5f70 6174 6827 3a20 7374 7228  ocal_path': str(
+00009ce0: 6c6f 6361 6c5f 7768 6565 6c5f 7061 7468  local_wheel_path
+00009cf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00009d00: 2020 2023 2041 6464 2079 616d 6c20 6669     # Add yaml fi
+00009d10: 6c65 2070 6174 6820 746f 2074 6865 2074  le path to the t
+00009d20: 656d 706c 6174 6520 7661 7269 6162 6c65  emplate variable
+00009d30: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+00009d40: 2020 2027 736b 795f 7261 795f 7961 6d6c     'sky_ray_yaml
+00009d50: 5f72 656d 6f74 655f 7061 7468 273a 0a20  _remote_path':. 
+00009d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d70: 2020 2063 6c75 7374 6572 5f79 616d 6c5f     cluster_yaml_
+00009d80: 7574 696c 732e 534b 595f 434c 5553 5445  utils.SKY_CLUSTE
+00009d90: 525f 5941 4d4c 5f52 454d 4f54 455f 5041  R_YAML_REMOTE_PA
+00009da0: 5448 2c0a 2020 2020 2020 2020 2020 2020  TH,.            
+00009db0: 2020 2020 2773 6b79 5f72 6179 5f79 616d      'sky_ray_yam
+00009dc0: 6c5f 6c6f 6361 6c5f 7061 7468 273a 2074  l_local_path': t
+00009dd0: 6d70 5f79 616d 6c5f 7061 7468 2c0a 2020  mp_yaml_path,.  
+00009de0: 2020 2020 2020 2020 2020 2020 2020 2773                's
+00009df0: 6b79 5f76 6572 7369 6f6e 273a 2073 7472  ky_version': str
+00009e00: 2876 6572 7369 6f6e 2e70 6172 7365 2873  (version.parse(s
+00009e10: 6b79 2e5f 5f76 6572 7369 6f6e 5f5f 2929  ky.__version__))
+00009e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009e30: 2020 2773 6b79 5f77 6865 656c 5f68 6173    'sky_wheel_has
+00009e40: 6827 3a20 7768 6565 6c5f 6861 7368 2c0a  h': wheel_hash,.
+00009e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e60: 2320 4175 7468 656e 7469 6361 7469 6f6e  # Authentication
+00009e70: 2028 6f70 7469 6f6e 616c 292e 0a20 2020   (optional)..   
+00009e80: 2020 2020 2020 2020 2020 2020 202a 2a61               **a
+00009e90: 7574 685f 636f 6e66 6967 2c0a 2020 2020  uth_config,.    
+00009ea0: 2020 2020 2020 2020 7d29 2c0a 2020 2020          }),.    
+00009eb0: 2020 2020 6f75 7470 7574 5f70 6174 683d      output_path=
+00009ec0: 746d 705f 7961 6d6c 5f70 6174 6829 0a20  tmp_yaml_path). 
+00009ed0: 2020 2063 6f6e 6669 675f 6469 6374 5b27     config_dict['
+00009ee0: 636c 7573 7465 725f 6e61 6d65 275d 203d  cluster_name'] =
+00009ef0: 2063 6c75 7374 6572 5f6e 616d 650a 2020   cluster_name.  
+00009f00: 2020 636f 6e66 6967 5f64 6963 745b 2772    config_dict['r
+00009f10: 6179 275d 203d 2079 616d 6c5f 7061 7468  ay'] = yaml_path
+00009f20: 0a20 2020 2069 6620 6472 7972 756e 3a0a  .    if dryrun:.
+00009f30: 2020 2020 2020 2020 2320 4966 2064 7279          # If dry
+00009f40: 7275 6e2c 2072 6574 7572 6e20 7468 6520  run, return the 
+00009f50: 756e 6669 6e69 7368 6564 2074 6d70 2079  unfinished tmp y
+00009f60: 616d 6c20 7061 7468 2e0a 2020 2020 2020  aml path..      
+00009f70: 2020 636f 6e66 6967 5f64 6963 745b 2772    config_dict['r
+00009f80: 6179 275d 203d 2074 6d70 5f79 616d 6c5f  ay'] = tmp_yaml_
+00009f90: 7061 7468 0a20 2020 2020 2020 2072 6574  path.        ret
+00009fa0: 7572 6e20 636f 6e66 6967 5f64 6963 740a  urn config_dict.
+00009fb0: 2020 2020 5f61 6464 5f61 7574 685f 746f      _add_auth_to
+00009fc0: 5f63 6c75 7374 6572 5f63 6f6e 6669 6728  _cluster_config(
+00009fd0: 636c 6f75 642c 2074 6d70 5f79 616d 6c5f  cloud, tmp_yaml_
+00009fe0: 7061 7468 290a 0a20 2020 2023 2041 6464  path)..    # Add
+00009ff0: 206b 7562 6572 6e65 7465 7320 636f 6e66   kubernetes conf
+0000a000: 6967 2066 6965 6c64 7320 6672 6f6d 207e  ig fields from ~
+0000a010: 2f2e 736b 792f 636f 6e66 6967 0a20 2020  /.sky/config.   
+0000a020: 2069 6620 6973 696e 7374 616e 6365 2863   if isinstance(c
+0000a030: 6c6f 7564 2c20 636c 6f75 6473 2e4b 7562  loud, clouds.Kub
+0000a040: 6572 6e65 7465 7329 3a0a 2020 2020 2020  ernetes):.      
+0000a050: 2020 6b75 6265 726e 6574 6573 5f75 7469    kubernetes_uti
+0000a060: 6c73 2e63 6f6d 6269 6e65 5f70 6f64 5f63  ls.combine_pod_c
+0000a070: 6f6e 6669 675f 6669 656c 6473 2874 6d70  onfig_fields(tmp
+0000a080: 5f79 616d 6c5f 7061 7468 290a 2020 2020  _yaml_path).    
+0000a090: 2020 2020 6b75 6265 726e 6574 6573 5f75      kubernetes_u
+0000a0a0: 7469 6c73 2e63 6f6d 6269 6e65 5f6d 6574  tils.combine_met
+0000a0b0: 6164 6174 615f 6669 656c 6473 2874 6d70  adata_fields(tmp
+0000a0c0: 5f79 616d 6c5f 7061 7468 290a 0a20 2020  _yaml_path)..   
+0000a0d0: 2023 2052 6573 746f 7265 2074 6865 206f   # Restore the o
+0000a0e0: 6c64 2079 616d 6c20 636f 6e74 656e 7420  ld yaml content 
+0000a0f0: 666f 7220 6261 636b 7761 7264 2063 6f6d  for backward com
+0000a100: 7061 7469 6269 6c69 7479 2e0a 2020 2020  patibility..    
+0000a110: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
+0000a120: 7328 7961 6d6c 5f70 6174 6829 2061 6e64  s(yaml_path) and
+0000a130: 206b 6565 705f 6c61 756e 6368 5f66 6965   keep_launch_fie
+0000a140: 6c64 735f 696e 5f65 7869 7374 696e 675f  lds_in_existing_
+0000a150: 636f 6e66 6967 3a0a 2020 2020 2020 2020  config:.        
+0000a160: 7769 7468 206f 7065 6e28 7961 6d6c 5f70  with open(yaml_p
+0000a170: 6174 682c 2027 7227 2c20 656e 636f 6469  ath, 'r', encodi
+0000a180: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+0000a190: 3a0a 2020 2020 2020 2020 2020 2020 6f6c  :.            ol
+0000a1a0: 645f 7961 6d6c 5f63 6f6e 7465 6e74 203d  d_yaml_content =
+0000a1b0: 2066 2e72 6561 6428 290a 2020 2020 2020   f.read().      
+0000a1c0: 2020 7769 7468 206f 7065 6e28 746d 705f    with open(tmp_
+0000a1d0: 7961 6d6c 5f70 6174 682c 2027 7227 2c20  yaml_path, 'r', 
+0000a1e0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+0000a1f0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000a200: 2020 2020 6e65 775f 7961 6d6c 5f63 6f6e      new_yaml_con
+0000a210: 7465 6e74 203d 2066 2e72 6561 6428 290a  tent = f.read().
+0000a220: 2020 2020 2020 2020 7265 7374 6f72 6564          restored
+0000a230: 5f79 616d 6c5f 636f 6e74 656e 7420 3d20  _yaml_content = 
+0000a240: 5f72 6570 6c61 6365 5f79 616d 6c5f 6469  _replace_yaml_di
+0000a250: 6374 7328 0a20 2020 2020 2020 2020 2020  cts(.           
+0000a260: 206e 6577 5f79 616d 6c5f 636f 6e74 656e   new_yaml_conten
+0000a270: 742c 206f 6c64 5f79 616d 6c5f 636f 6e74  t, old_yaml_cont
+0000a280: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+0000a290: 205f 5241 595f 5941 4d4c 5f4b 4559 535f   _RAY_YAML_KEYS_
+0000a2a0: 544f 5f52 4553 544f 5245 5f46 4f52 5f42  TO_RESTORE_FOR_B
+0000a2b0: 4143 4b5f 434f 4d50 4154 4942 494c 4954  ACK_COMPATIBILIT
+0000a2c0: 592c 0a20 2020 2020 2020 2020 2020 205f  Y,.            _
+0000a2d0: 5241 595f 5941 4d4c 5f4b 4559 535f 544f  RAY_YAML_KEYS_TO
+0000a2e0: 5f52 4553 544f 5245 5f45 5843 4550 5449  _RESTORE_EXCEPTI
+0000a2f0: 4f4e 5329 0a20 2020 2020 2020 2077 6974  ONS).        wit
+0000a300: 6820 6f70 656e 2874 6d70 5f79 616d 6c5f  h open(tmp_yaml_
+0000a310: 7061 7468 2c20 2777 272c 2065 6e63 6f64  path, 'w', encod
+0000a320: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+0000a330: 663a 0a20 2020 2020 2020 2020 2020 2066  f:.            f
+0000a340: 2e77 7269 7465 2872 6573 746f 7265 645f  .write(restored_
+0000a350: 7961 6d6c 5f63 6f6e 7465 6e74 290a 0a20  yaml_content).. 
+0000a360: 2020 2063 6f6e 6669 675f 6469 6374 5b27     config_dict['
+0000a370: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+0000a380: 636c 6f75 6427 5d20 3d20 636c 7573 7465  cloud'] = cluste
+0000a390: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 640a  r_name_on_cloud.
+0000a3a0: 0a20 2020 2023 204f 7074 696d 697a 6174  .    # Optimizat
+0000a3b0: 696f 6e3a 2063 6f70 7920 7468 6520 636f  ion: copy the co
+0000a3c0: 6e74 656e 7473 206f 6620 736f 7572 6365  ntents of source
+0000a3d0: 2066 696c 6573 2069 6e20 6669 6c65 5f6d   files in file_m
+0000a3e0: 6f75 6e74 7320 746f 2061 0a20 2020 2023  ounts to a.    #
+0000a3f0: 2073 7065 6369 616c 2064 6972 2c20 616e   special dir, an
+0000a400: 6420 7570 6c6f 6164 2074 6861 7420 6173  d upload that as
+0000a410: 2074 6865 206f 6e6c 7920 6669 6c65 5f6d   the only file_m
+0000a420: 6f75 6e74 2069 6e73 7465 6164 2e20 4465  ount instead. De
+0000a430: 6c61 790a 2020 2020 2320 6361 6c6c 696e  lay.    # callin
+0000a440: 6720 7468 6973 206f 7074 696d 697a 6174  g this optimizat
+0000a450: 696f 6e20 756e 7469 6c20 6e6f 772c 2077  ion until now, w
+0000a460: 6865 6e20 616c 6c20 736f 7572 6365 2066  hen all source f
+0000a470: 696c 6573 2068 6176 6520 6265 656e 0a20  iles have been. 
+0000a480: 2020 2023 2077 7269 7474 656e 2061 6e64     # written and
+0000a490: 2074 6865 6972 2063 6f6e 7465 6e74 7320   their contents 
+0000a4a0: 6669 6e61 6c69 7a65 642e 0a20 2020 2023  finalized..    #
+0000a4b0: 0a20 2020 2023 204e 6f74 6520 7468 6174  .    # Note that
+0000a4c0: 2074 6865 2072 6179 2079 616d 6c20 6669   the ray yaml fi
+0000a4d0: 6c65 2077 696c 6c20 6265 2063 6f70 6965  le will be copie
+0000a4e0: 6420 696e 746f 2074 6861 7420 7370 6563  d into that spec
+0000a4f0: 6961 6c20 6469 7220 2869 2e65 2e2c 0a20  ial dir (i.e.,. 
+0000a500: 2020 2023 2075 706c 6f61 6465 6420 6173     # uploaded as
+0000a510: 2070 6172 7420 6f66 2074 6865 2066 696c   part of the fil
+0000a520: 655f 6d6f 756e 7473 292c 2073 6f20 7468  e_mounts), so th
+0000a530: 6520 7265 7374 6f72 6520 666f 7220 6261  e restore for ba
+0000a540: 636b 7761 7264 0a20 2020 2023 2063 6f6d  ckward.    # com
+0000a550: 7061 7469 6269 6c69 7479 2073 686f 756c  patibility shoul
+0000a560: 6420 676f 2062 6566 6f72 6520 7468 6973  d go before this
+0000a570: 2063 616c 6c2e 0a20 2020 205f 6f70 7469   call..    _opti
+0000a580: 6d69 7a65 5f66 696c 655f 6d6f 756e 7473  mize_file_mounts
+0000a590: 2874 6d70 5f79 616d 6c5f 7061 7468 290a  (tmp_yaml_path).
+0000a5a0: 0a20 2020 2023 2052 656e 616d 6520 7468  .    # Rename th
+0000a5b0: 6520 746d 7020 6669 6c65 2074 6f20 7468  e tmp file to th
+0000a5c0: 6520 6669 6e61 6c20 5941 4d4c 2070 6174  e final YAML pat
+0000a5d0: 682e 0a20 2020 206f 732e 7265 6e61 6d65  h..    os.rename
+0000a5e0: 2874 6d70 5f79 616d 6c5f 7061 7468 2c20  (tmp_yaml_path, 
+0000a5f0: 7961 6d6c 5f70 6174 6829 0a20 2020 2075  yaml_path).    u
+0000a600: 7361 6765 5f6c 6962 2e6d 6573 7361 6765  sage_lib.message
+0000a610: 732e 7573 6167 652e 7570 6461 7465 5f72  s.usage.update_r
+0000a620: 6179 5f79 616d 6c28 7961 6d6c 5f70 6174  ay_yaml(yaml_pat
+0000a630: 6829 0a20 2020 2072 6574 7572 6e20 636f  h).    return co
+0000a640: 6e66 6967 5f64 6963 740a 0a0a 6465 6620  nfig_dict...def 
+0000a650: 5f61 6464 5f61 7574 685f 746f 5f63 6c75  _add_auth_to_clu
+0000a660: 7374 6572 5f63 6f6e 6669 6728 636c 6f75  ster_config(clou
+0000a670: 643a 2063 6c6f 7564 732e 436c 6f75 642c  d: clouds.Cloud,
+0000a680: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
+0000a690: 6669 6c65 3a20 7374 7229 3a0a 2020 2020  file: str):.    
+0000a6a0: 2222 2241 6464 7320 5353 4820 6b65 7920  """Adds SSH key 
+0000a6b0: 696e 666f 2074 6f20 7468 6520 636c 7573  info to the clus
+0000a6c0: 7465 7220 636f 6e66 6967 2e0a 0a20 2020  ter config...   
+0000a6d0: 2054 6869 7320 6675 6e63 7469 6f6e 2773   This function's
+0000a6e0: 206f 7574 7075 7420 7265 6d6f 7665 7320   output removes 
+0000a6f0: 636f 6d6d 656e 7473 2069 6e63 6c75 6465  comments include
+0000a700: 6420 696e 2074 6865 206a 696e 6a61 3220  d in the jinja2 
+0000a710: 7465 6d70 6c61 7465 2e0a 2020 2020 2222  template..    ""
+0000a720: 220a 2020 2020 636f 6e66 6967 203d 2063  ".    config = c
+0000a730: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
+0000a740: 5f79 616d 6c28 636c 7573 7465 725f 636f  _yaml(cluster_co
+0000a750: 6e66 6967 5f66 696c 6529 0a20 2020 2023  nfig_file).    #
+0000a760: 2043 6865 636b 2074 6865 2061 7661 696c   Check the avail
+0000a770: 6162 696c 6974 7920 6f66 2074 6865 2063  ability of the c
+0000a780: 6c6f 7564 2074 7970 652e 0a20 2020 2069  loud type..    i
+0000a790: 6620 6973 696e 7374 616e 6365 2863 6c6f  f isinstance(clo
+0000a7a0: 7564 2c20 2863 6c6f 7564 732e 4157 532c  ud, (clouds.AWS,
+0000a7b0: 2063 6c6f 7564 732e 4f43 492c 2063 6c6f   clouds.OCI, clo
+0000a7c0: 7564 732e 5343 502c 2063 6c6f 7564 732e  uds.SCP, clouds.
+0000a7d0: 5673 7068 6572 652c 0a20 2020 2020 2020  Vsphere,.       
+0000a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7f0: 2020 2063 6c6f 7564 732e 4375 646f 2c20     clouds.Cudo, 
+0000a800: 636c 6f75 6473 2e50 6170 6572 7370 6163  clouds.Paperspac
+0000a810: 6529 293a 0a20 2020 2020 2020 2063 6f6e  e)):.        con
+0000a820: 6669 6720 3d20 6175 7468 2e63 6f6e 6669  fig = auth.confi
+0000a830: 6775 7265 5f73 7368 5f69 6e66 6f28 636f  gure_ssh_info(co
+0000a840: 6e66 6967 290a 2020 2020 656c 6966 2069  nfig).    elif i
+0000a850: 7369 6e73 7461 6e63 6528 636c 6f75 642c  sinstance(cloud,
+0000a860: 2063 6c6f 7564 732e 4743 5029 3a0a 2020   clouds.GCP):.  
+0000a870: 2020 2020 2020 636f 6e66 6967 203d 2061        config = a
+0000a880: 7574 682e 7365 7475 705f 6763 705f 6175  uth.setup_gcp_au
+0000a890: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
+0000a8a0: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
+0000a8b0: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
+0000a8c0: 636c 6f75 6473 2e41 7a75 7265 293a 0a20  clouds.Azure):. 
+0000a8d0: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
+0000a8e0: 6175 7468 2e73 6574 7570 5f61 7a75 7265  auth.setup_azure
+0000a8f0: 5f61 7574 6865 6e74 6963 6174 696f 6e28  _authentication(
+0000a900: 636f 6e66 6967 290a 2020 2020 656c 6966  config).    elif
+0000a910: 2069 7369 6e73 7461 6e63 6528 636c 6f75   isinstance(clou
+0000a920: 642c 2063 6c6f 7564 732e 4c61 6d62 6461  d, clouds.Lambda
+0000a930: 293a 0a20 2020 2020 2020 2063 6f6e 6669  ):.        confi
+0000a940: 6720 3d20 6175 7468 2e73 6574 7570 5f6c  g = auth.setup_l
+0000a950: 616d 6264 615f 6175 7468 656e 7469 6361  ambda_authentica
+0000a960: 7469 6f6e 2863 6f6e 6669 6729 0a20 2020  tion(config).   
+0000a970: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+0000a980: 2863 6c6f 7564 2c20 636c 6f75 6473 2e4b  (cloud, clouds.K
+0000a990: 7562 6572 6e65 7465 7329 3a0a 2020 2020  ubernetes):.    
+0000a9a0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
+0000a9b0: 682e 7365 7475 705f 6b75 6265 726e 6574  h.setup_kubernet
+0000a9c0: 6573 5f61 7574 6865 6e74 6963 6174 696f  es_authenticatio
+0000a9d0: 6e28 636f 6e66 6967 290a 2020 2020 656c  n(config).    el
+0000a9e0: 6966 2069 7369 6e73 7461 6e63 6528 636c  if isinstance(cl
+0000a9f0: 6f75 642c 2063 6c6f 7564 732e 4942 4d29  oud, clouds.IBM)
+0000aa00: 3a0a 2020 2020 2020 2020 636f 6e66 6967  :.        config
+0000aa10: 203d 2061 7574 682e 7365 7475 705f 6962   = auth.setup_ib
+0000aa20: 6d5f 6175 7468 656e 7469 6361 7469 6f6e  m_authentication
+0000aa30: 2863 6f6e 6669 6729 0a20 2020 2065 6c69  (config).    eli
+0000aa40: 6620 6973 696e 7374 616e 6365 2863 6c6f  f isinstance(clo
+0000aa50: 7564 2c20 636c 6f75 6473 2e52 756e 506f  ud, clouds.RunPo
+0000aa60: 6429 3a0a 2020 2020 2020 2020 636f 6e66  d):.        conf
+0000aa70: 6967 203d 2061 7574 682e 7365 7475 705f  ig = auth.setup_
+0000aa80: 7275 6e70 6f64 5f61 7574 6865 6e74 6963  runpod_authentic
+0000aa90: 6174 696f 6e28 636f 6e66 6967 290a 2020  ation(config).  
+0000aaa0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0000aab0: 6528 636c 6f75 642c 2063 6c6f 7564 732e  e(cloud, clouds.
+0000aac0: 466c 7569 6473 7461 636b 293a 0a20 2020  Fluidstack):.   
+0000aad0: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
+0000aae0: 7468 2e73 6574 7570 5f66 6c75 6964 7374  th.setup_fluidst
+0000aaf0: 6163 6b5f 6175 7468 656e 7469 6361 7469  ack_authenticati
+0000ab00: 6f6e 2863 6f6e 6669 6729 0a20 2020 2065  on(config).    e
+0000ab10: 6c73 653a 0a20 2020 2020 2020 2061 7373  lse:.        ass
+0000ab20: 6572 7420 4661 6c73 652c 2063 6c6f 7564  ert False, cloud
+0000ab30: 0a20 2020 2063 6f6d 6d6f 6e5f 7574 696c  .    common_util
+0000ab40: 732e 6475 6d70 5f79 616d 6c28 636c 7573  s.dump_yaml(clus
+0000ab50: 7465 725f 636f 6e66 6967 5f66 696c 652c  ter_config_file,
+0000ab60: 2063 6f6e 6669 6729 0a0a 0a64 6566 2067   config)...def g
+0000ab70: 6574 5f72 756e 5f74 696d 6573 7461 6d70  et_run_timestamp
+0000ab80: 2829 202d 3e20 7374 723a 0a20 2020 2072  () -> str:.    r
+0000ab90: 6574 7572 6e20 2773 6b79 2d27 202b 2064  eturn 'sky-' + d
+0000aba0: 6174 6574 696d 652e 6e6f 7728 292e 7374  atetime.now().st
+0000abb0: 7266 7469 6d65 2827 2559 2d25 6d2d 2564  rftime('%Y-%m-%d
+0000abc0: 2d25 482d 254d 2d25 532d 2566 2729 0a0a  -%H-%M-%S-%f')..
+0000abd0: 0a64 6566 2067 6574 5f74 696d 6573 7461  .def get_timesta
+0000abe0: 6d70 5f66 726f 6d5f 7275 6e5f 7469 6d65  mp_from_run_time
+0000abf0: 7374 616d 7028 7275 6e5f 7469 6d65 7374  stamp(run_timest
+0000ac00: 616d 703a 2073 7472 2920 2d3e 2066 6c6f  amp: str) -> flo
+0000ac10: 6174 3a0a 2020 2020 7265 7475 726e 2064  at:.    return d
+0000ac20: 6174 6574 696d 652e 7374 7270 7469 6d65  atetime.strptime
+0000ac30: 280a 2020 2020 2020 2020 7275 6e5f 7469  (.        run_ti
+0000ac40: 6d65 7374 616d 702e 7061 7274 6974 696f  mestamp.partitio
+0000ac50: 6e28 272d 2729 5b32 5d2c 2027 2559 2d25  n('-')[2], '%Y-%
+0000ac60: 6d2d 2564 2d25 482d 254d 2d25 532d 2566  m-%d-%H-%M-%S-%f
+0000ac70: 2729 2e74 696d 6573 7461 6d70 2829 0a0a  ').timestamp()..
+0000ac80: 0a64 6566 205f 636f 756e 745f 6865 616c  .def _count_heal
+0000ac90: 7468 795f 6e6f 6465 735f 6672 6f6d 5f72  thy_nodes_from_r
+0000aca0: 6179 286f 7574 7075 743a 2073 7472 2c0a  ay(output: str,.
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acd0: 2020 6973 5f6c 6f63 616c 5f63 6c6f 7564    is_local_cloud
+0000ace0: 3a20 626f 6f6c 203d 2046 616c 7365 0a20  : bool = False. 
+0000acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad10: 2920 2d3e 2054 7570 6c65 5b69 6e74 2c20  ) -> Tuple[int, 
+0000ad20: 696e 745d 3a0a 2020 2020 2222 2243 6f75  int]:.    """Cou
+0000ad30: 6e74 2074 6865 206e 756d 6265 7220 6f66  nt the number of
+0000ad40: 2068 6561 6c74 6879 206e 6f64 6573 2066   healthy nodes f
+0000ad50: 726f 6d20 7468 6520 6f75 7470 7574 206f  rom the output o
+0000ad60: 6620 6072 6179 2073 7461 7475 7360 2e22  f `ray status`."
+0000ad70: 2222 0a0a 2020 2020 6465 6620 6765 745f  ""..    def get_
+0000ad80: 7265 6164 795f 6e6f 6465 735f 636f 756e  ready_nodes_coun
+0000ad90: 7473 2870 6174 7465 726e 2c20 6f75 7470  ts(pattern, outp
+0000ada0: 7574 293a 0a20 2020 2020 2020 2072 6573  ut):.        res
+0000adb0: 756c 7420 3d20 7061 7474 6572 6e2e 6669  ult = pattern.fi
+0000adc0: 6e64 616c 6c28 6f75 7470 7574 290a 2020  ndall(output).  
+0000add0: 2020 2020 2020 6966 206e 6f74 2072 6573        if not res
+0000ade0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+0000adf0: 2072 6574 7572 6e20 300a 2020 2020 2020   return 0.      
+0000ae00: 2020 6173 7365 7274 206c 656e 2872 6573    assert len(res
+0000ae10: 756c 7429 203d 3d20 312c 2072 6573 756c  ult) == 1, resul
+0000ae20: 740a 2020 2020 2020 2020 7265 7475 726e  t.        return
+0000ae30: 2069 6e74 2872 6573 756c 745b 305d 290a   int(result[0]).
+0000ae40: 0a20 2020 2023 2043 6865 636b 2069 6620  .    # Check if 
+0000ae50: 7468 6520 7261 7920 636c 7573 7465 7220  the ray cluster 
+0000ae60: 6973 2073 7461 7274 6564 2077 6974 6820  is started with 
+0000ae70: 7261 7920 6175 746f 7363 616c 6572 2e20  ray autoscaler. 
+0000ae80: 496e 206e 6577 0a20 2020 2023 2070 726f  In new.    # pro
+0000ae90: 7669 7369 6f6e 6572 2028 2331 3730 3229  visioner (#1702)
+0000aea0: 2061 6e64 206c 6f63 616c 206d 6f64 652c   and local mode,
+0000aeb0: 2077 6520 7374 6172 7465 6420 7468 6520   we started the 
+0000aec0: 7261 7920 636c 7573 7465 7220 7769 7468  ray cluster with
+0000aed0: 6f75 7420 7261 790a 2020 2020 2320 6175  out ray.    # au
+0000aee0: 746f 7363 616c 6572 2e0a 2020 2020 2320  toscaler..    # 
+0000aef0: 4966 2072 6179 2063 6c75 7374 6572 2069  If ray cluster i
+0000af00: 7320 7374 6172 7465 6420 7769 7468 2072  s started with r
+0000af10: 6179 2061 7574 6f73 6361 6c65 722c 2074  ay autoscaler, t
+0000af20: 6865 206f 7574 7075 7420 7769 6c6c 2062  he output will b
+0000af30: 653a 0a20 2020 2023 2020 3120 7261 792e  e:.    #  1 ray.
+0000af40: 6865 6164 2e64 6566 6175 6c74 0a20 2020  head.default.   
+0000af50: 2023 2020 2e2e 2e0a 2020 2020 2320 544f   #  ....    # TO
+0000af60: 444f 287a 6877 7529 3a20 6f6e 6365 2077  DO(zhwu): once w
+0000af70: 6520 6465 7072 6563 6174 6520 7468 6520  e deprecate the 
+0000af80: 6f6c 6420 7072 6f76 6973 696f 6e65 722c  old provisioner,
+0000af90: 2077 6520 6361 6e20 7265 6d6f 7665 2074   we can remove t
+0000afa0: 6869 730a 2020 2020 2320 6368 6563 6b2e  his.    # check.
+0000afb0: 0a20 2020 2072 6179 5f61 7574 6f73 6361  .    ray_autosca
+0000afc0: 6c65 725f 6865 6164 203d 2067 6574 5f72  ler_head = get_r
+0000afd0: 6561 6479 5f6e 6f64 6573 5f63 6f75 6e74  eady_nodes_count
+0000afe0: 7328 5f4c 4155 4e43 4845 445f 4845 4144  s(_LAUNCHED_HEAD
+0000aff0: 5f50 4154 5445 524e 2c20 6f75 7470 7574  _PATTERN, output
+0000b000: 290a 2020 2020 6973 5f6c 6f63 616c 5f72  ).    is_local_r
+0000b010: 6179 5f63 6c75 7374 6572 203d 2072 6179  ay_cluster = ray
+0000b020: 5f61 7574 6f73 6361 6c65 725f 6865 6164  _autoscaler_head
+0000b030: 203d 3d20 300a 0a20 2020 2069 6620 6973   == 0..    if is
+0000b040: 5f6c 6f63 616c 5f72 6179 5f63 6c75 7374  _local_ray_clust
+0000b050: 6572 206f 7220 6973 5f6c 6f63 616c 5f63  er or is_local_c
+0000b060: 6c6f 7564 3a0a 2020 2020 2020 2020 2320  loud:.        # 
+0000b070: 5261 7920 636c 7573 7465 7220 6973 206c  Ray cluster is l
+0000b080: 6175 6e63 6865 6420 7769 7468 206e 6577  aunched with new
+0000b090: 2070 726f 7669 7369 6f6e 6572 0a20 2020   provisioner.   
+0000b0a0: 2020 2020 2023 2046 6f72 206e 6577 2070       # For new p
+0000b0b0: 726f 7669 7369 6f6e 6572 2061 6e64 206c  rovisioner and l
+0000b0c0: 6f63 616c 206d 6f64 652c 2074 6865 206f  ocal mode, the o
+0000b0d0: 7574 7075 7420 7769 6c6c 2062 653a 0a20  utput will be:. 
+0000b0e0: 2020 2020 2020 2023 2020 3120 6e6f 6465         #  1 node
+0000b0f0: 5f78 7878 780a 2020 2020 2020 2020 2320  _xxxx.        # 
+0000b100: 2031 206e 6f64 655f 7878 7878 0a20 2020   1 node_xxxx.   
+0000b110: 2020 2020 2072 6561 6479 5f68 6561 6420       ready_head 
+0000b120: 3d20 300a 2020 2020 2020 2020 7265 6164  = 0.        read
+0000b130: 795f 776f 726b 6572 7320 3d20 5f4c 4155  y_workers = _LAU
+0000b140: 4e43 4845 445f 4c4f 4341 4c5f 574f 524b  NCHED_LOCAL_WORK
+0000b150: 4552 5f50 4154 5445 524e 2e66 696e 6461  ER_PATTERN.finda
+0000b160: 6c6c 286f 7574 7075 7429 0a20 2020 2020  ll(output).     
+0000b170: 2020 2072 6561 6479 5f77 6f72 6b65 7273     ready_workers
+0000b180: 203d 206c 656e 2872 6561 6479 5f77 6f72   = len(ready_wor
+0000b190: 6b65 7273 290a 2020 2020 2020 2020 6966  kers).        if
+0000b1a0: 2069 735f 6c6f 6361 6c5f 7261 795f 636c   is_local_ray_cl
+0000b1b0: 7573 7465 723a 0a20 2020 2020 2020 2020  uster:.         
+0000b1c0: 2020 2072 6561 6479 5f68 6561 6420 3d20     ready_head = 
+0000b1d0: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
+0000b1e0: 6164 795f 776f 726b 6572 7320 2d3d 2031  ady_workers -= 1
+0000b1f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b200: 7265 6164 795f 6865 6164 2c20 7265 6164  ready_head, read
+0000b210: 795f 776f 726b 6572 730a 0a20 2020 2023  y_workers..    #
+0000b220: 2043 6f75 6e74 206e 756d 6265 7220 6f66   Count number of
+0000b230: 206e 6f64 6573 2062 7920 7061 7273 696e   nodes by parsin
+0000b240: 6720 7468 6520 6f75 7470 7574 206f 6620  g the output of 
+0000b250: 6072 6179 2073 7461 7475 7360 2e20 5468  `ray status`. Th
+0000b260: 6520 6f75 7470 7574 0a20 2020 2023 206c  e output.    # l
+0000b270: 6f6f 6b73 206c 696b 653a 0a20 2020 2023  ooks like:.    #
+0000b280: 2020 2031 2072 6179 2e68 6561 642e 6465     1 ray.head.de
+0000b290: 6661 756c 740a 2020 2020 2320 2020 3220  fault.    #   2 
+0000b2a0: 7261 792e 776f 726b 6572 2e64 6566 6175  ray.worker.defau
+0000b2b0: 6c74 0a20 2020 2072 6561 6479 5f68 6561  lt.    ready_hea
+0000b2c0: 6420 3d20 7261 795f 6175 746f 7363 616c  d = ray_autoscal
+0000b2d0: 6572 5f68 6561 640a 2020 2020 7265 6164  er_head.    read
+0000b2e0: 795f 776f 726b 6572 7320 3d20 6765 745f  y_workers = get_
+0000b2f0: 7265 6164 795f 6e6f 6465 735f 636f 756e  ready_nodes_coun
+0000b300: 7473 285f 4c41 554e 4348 4544 5f57 4f52  ts(_LAUNCHED_WOR
+0000b310: 4b45 525f 5041 5454 4552 4e2c 206f 7574  KER_PATTERN, out
+0000b320: 7075 7429 0a20 2020 2072 6561 6479 5f72  put).    ready_r
+0000b330: 6573 6572 7665 645f 776f 726b 6572 7320  eserved_workers 
+0000b340: 3d20 6765 745f 7265 6164 795f 6e6f 6465  = get_ready_node
+0000b350: 735f 636f 756e 7473 280a 2020 2020 2020  s_counts(.      
+0000b360: 2020 5f4c 4155 4e43 4845 445f 5245 5345    _LAUNCHED_RESE
+0000b370: 5256 4544 5f57 4f52 4b45 525f 5041 5454  RVED_WORKER_PATT
+0000b380: 4552 4e2c 206f 7574 7075 7429 0a20 2020  ERN, output).   
+0000b390: 2072 6561 6479 5f77 6f72 6b65 7273 202b   ready_workers +
+0000b3a0: 3d20 7265 6164 795f 7265 7365 7276 6564  = ready_reserved
+0000b3b0: 5f77 6f72 6b65 7273 0a20 2020 2061 7373  _workers.    ass
+0000b3c0: 6572 7420 7265 6164 795f 6865 6164 203c  ert ready_head <
+0000b3d0: 3d20 312c 2066 2723 6865 6164 206e 6f64  = 1, f'#head nod
+0000b3e0: 6520 7368 6f75 6c64 2062 6520 3c3d 3120  e should be <=1 
+0000b3f0: 2847 6f74 207b 7265 6164 795f 6865 6164  (Got {ready_head
+0000b400: 7d29 2e27 0a20 2020 2072 6574 7572 6e20  }).'.    return 
+0000b410: 7265 6164 795f 6865 6164 2c20 7265 6164  ready_head, read
+0000b420: 795f 776f 726b 6572 730a 0a0a 6465 6620  y_workers...def 
+0000b430: 6765 745f 646f 636b 6572 5f75 7365 7228  get_docker_user(
+0000b440: 6970 3a20 7374 722c 2063 6c75 7374 6572  ip: str, cluster
+0000b450: 5f63 6f6e 6669 675f 6669 6c65 3a20 7374  _config_file: st
+0000b460: 7229 202d 3e20 7374 723a 0a20 2020 2022  r) -> str:.    "
+0000b470: 2222 4669 6e64 2064 6f63 6b65 7220 636f  ""Find docker co
+0000b480: 6e74 6169 6e65 7220 7573 6572 6e61 6d65  ntainer username
+0000b490: 2e22 2222 0a20 2020 2073 7368 5f63 7265  .""".    ssh_cre
+0000b4a0: 6465 6e74 6961 6c73 203d 2073 7368 5f63  dentials = ssh_c
+0000b4b0: 7265 6465 6e74 6961 6c5f 6672 6f6d 5f79  redential_from_y
+0000b4c0: 616d 6c28 636c 7573 7465 725f 636f 6e66  aml(cluster_conf
+0000b4d0: 6967 5f66 696c 6529 0a20 2020 2072 756e  ig_file).    run
+0000b4e0: 6e65 7220 3d20 636f 6d6d 616e 645f 7275  ner = command_ru
+0000b4f0: 6e6e 6572 2e53 5348 436f 6d6d 616e 6452  nner.SSHCommandR
+0000b500: 756e 6e65 7228 6970 2c20 706f 7274 3d32  unner(ip, port=2
+0000b510: 322c 202a 2a73 7368 5f63 7265 6465 6e74  2, **ssh_credent
+0000b520: 6961 6c73 290a 2020 2020 636f 6e74 6169  ials).    contai
+0000b530: 6e65 725f 6e61 6d65 203d 2063 6f6e 7374  ner_name = const
+0000b540: 616e 7473 2e44 4546 4155 4c54 5f44 4f43  ants.DEFAULT_DOC
+0000b550: 4b45 525f 434f 4e54 4149 4e45 525f 4e41  KER_CONTAINER_NA
+0000b560: 4d45 0a20 2020 2077 686f 616d 695f 7265  ME.    whoami_re
+0000b570: 7475 726e 636f 6465 2c20 7768 6f61 6d69  turncode, whoami
+0000b580: 5f73 7464 6f75 742c 2077 686f 616d 695f  _stdout, whoami_
+0000b590: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
+0000b5a0: 7275 6e28 0a20 2020 2020 2020 2066 2773  run(.        f's
+0000b5b0: 7564 6f20 646f 636b 6572 2065 7865 6320  udo docker exec 
+0000b5c0: 7b63 6f6e 7461 696e 6572 5f6e 616d 657d  {container_name}
+0000b5d0: 2077 686f 616d 6927 2c0a 2020 2020 2020   whoami',.      
+0000b5e0: 2020 7374 7265 616d 5f6c 6f67 733d 4661    stream_logs=Fa
+0000b5f0: 6c73 652c 0a20 2020 2020 2020 2072 6571  lse,.        req
+0000b600: 7569 7265 5f6f 7574 7075 7473 3d54 7275  uire_outputs=Tru
+0000b610: 6529 0a20 2020 2061 7373 6572 7420 7768  e).    assert wh
+0000b620: 6f61 6d69 5f72 6574 7572 6e63 6f64 6520  oami_returncode 
+0000b630: 3d3d 2030 2c20 280a 2020 2020 2020 2020  == 0, (.        
+0000b640: 6627 4661 696c 6564 2074 6f20 6765 7420  f'Failed to get 
+0000b650: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
+0000b660: 2075 7365 722e 2052 6574 7572 6e20 270a   user. Return '.
+0000b670: 2020 2020 2020 2020 6627 636f 6465 3a20          f'code: 
+0000b680: 7b77 686f 616d 695f 7265 7475 726e 636f  {whoami_returnco
+0000b690: 6465 7d2c 2045 7272 6f72 3a20 7b77 686f  de}, Error: {who
+0000b6a0: 616d 695f 7374 6465 7272 7d27 290a 2020  ami_stderr}').  
+0000b6b0: 2020 646f 636b 6572 5f75 7365 7220 3d20    docker_user = 
+0000b6c0: 7768 6f61 6d69 5f73 7464 6f75 742e 7374  whoami_stdout.st
+0000b6d0: 7269 7028 290a 2020 2020 6c6f 6767 6572  rip().    logger
+0000b6e0: 2e64 6562 7567 2866 2744 6f63 6b65 7220  .debug(f'Docker 
+0000b6f0: 636f 6e74 6169 6e65 7220 7573 6572 3a20  container user: 
+0000b700: 7b64 6f63 6b65 725f 7573 6572 7d27 290a  {docker_user}').
+0000b710: 2020 2020 7265 7475 726e 2064 6f63 6b65      return docke
+0000b720: 725f 7573 6572 0a0a 0a40 7469 6d65 6c69  r_user...@timeli
+0000b730: 6e65 2e65 7665 6e74 0a64 6566 2077 6169  ne.event.def wai
+0000b740: 745f 756e 7469 6c5f 7261 795f 636c 7573  t_until_ray_clus
+0000b750: 7465 725f 7265 6164 7928 0a20 2020 2063  ter_ready(.    c
+0000b760: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
+0000b770: 6c65 3a20 7374 722c 0a20 2020 206e 756d  le: str,.    num
+0000b780: 5f6e 6f64 6573 3a20 696e 742c 0a20 2020  _nodes: int,.   
+0000b790: 206c 6f67 5f70 6174 683a 2073 7472 2c0a   log_path: str,.
+0000b7a0: 2020 2020 6973 5f6c 6f63 616c 5f63 6c6f      is_local_clo
+0000b7b0: 7564 3a20 626f 6f6c 203d 2046 616c 7365  ud: bool = False
+0000b7c0: 2c0a 2020 2020 6e6f 6465 735f 6c61 756e  ,.    nodes_laun
+0000b7d0: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
+0000b7e0: 696d 656f 7574 3a20 4f70 7469 6f6e 616c  imeout: Optional
+0000b7f0: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2920  [int] = None,.) 
+0000b800: 2d3e 2054 7570 6c65 5b62 6f6f 6c2c 204f  -> Tuple[bool, O
+0000b810: 7074 696f 6e61 6c5b 7374 725d 5d3a 0a20  ptional[str]]:. 
+0000b820: 2020 2022 2222 5761 6974 2075 6e74 696c     """Wait until
+0000b830: 2074 6865 2072 6179 2063 6c75 7374 6572   the ray cluster
+0000b840: 2069 7320 7365 7420 7570 206f 6e20 564d   is set up on VM
+0000b850: 7320 6f72 2069 6e20 636f 6e74 6169 6e65  s or in containe
+0000b860: 7273 2e0a 0a20 2020 2052 6574 7572 6e73  rs...    Returns
+0000b870: 3a20 2077 6865 7468 6572 2074 6865 2065  :  whether the e
+0000b880: 6e74 6972 6520 7261 7920 636c 7573 7465  ntire ray cluste
+0000b890: 7220 6973 2072 6561 6479 2c20 616e 6420  r is ready, and 
+0000b8a0: 646f 636b 6572 2075 7365 726e 616d 650a  docker username.
+0000b8b0: 2020 2020 6966 206c 6175 6e63 6865 6420      if launched 
+0000b8c0: 7769 7468 2064 6f63 6b65 722e 0a20 2020  with docker..   
+0000b8d0: 2022 2222 0a20 2020 2023 204d 616e 7561   """.    # Manua
+0000b8e0: 6c6c 7920 6665 7463 6869 6e67 2068 6561  lly fetching hea
+0000b8f0: 6420 6970 2069 6e73 7465 6164 206f 6620  d ip instead of 
+0000b900: 7573 696e 6720 6072 6179 2065 7865 6360  using `ray exec`
+0000b910: 2074 6f20 6176 6f69 6420 7468 6520 6275   to avoid the bu
+0000b920: 670a 2020 2020 2320 7468 6174 2060 7261  g.    # that `ra
+0000b930: 7920 6578 6563 6020 6661 696c 7320 746f  y exec` fails to
+0000b940: 2063 6f6e 6e65 6374 2074 6f20 7468 6520   connect to the 
+0000b950: 6865 6164 206e 6f64 6520 6166 7465 7220  head node after 
+0000b960: 736f 6d65 2077 6f72 6b65 7273 0a20 2020  some workers.   
+0000b970: 2023 206c 6175 6e63 6865 6420 6573 7065   # launched espe
+0000b980: 6369 616c 6c79 2066 6f72 2041 7a75 7265  cially for Azure
+0000b990: 2e0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+0000b9a0: 2020 2068 6561 645f 6970 203d 205f 7175     head_ip = _qu
+0000b9b0: 6572 795f 6865 6164 5f69 705f 7769 7468  ery_head_ip_with
+0000b9c0: 5f72 6574 7269 6573 280a 2020 2020 2020  _retries(.      
+0000b9d0: 2020 2020 2020 636c 7573 7465 725f 636f        cluster_co
+0000b9e0: 6e66 6967 5f66 696c 652c 206d 6178 5f61  nfig_file, max_a
+0000b9f0: 7474 656d 7074 733d 5741 4954 5f48 4541  ttempts=WAIT_HEA
+0000ba00: 445f 4e4f 4445 5f49 505f 4d41 585f 4154  D_NODE_IP_MAX_AT
+0000ba10: 5445 4d50 5453 290a 2020 2020 6578 6365  TEMPTS).    exce
+0000ba20: 7074 2065 7863 6570 7469 6f6e 732e 4665  pt exceptions.Fe
+0000ba30: 7463 6849 5045 7272 6f72 2061 7320 653a  tchIPError as e:
+0000ba40: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0000ba50: 6572 726f 7228 636f 6d6d 6f6e 5f75 7469  error(common_uti
+0000ba60: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+0000ba70: 696f 6e28 6529 290a 2020 2020 2020 2020  ion(e)).        
+0000ba80: 7265 7475 726e 2046 616c 7365 2c20 4e6f  return False, No
+0000ba90: 6e65 2020 2320 6661 696c 6564 0a0a 2020  ne  # failed..  
+0000baa0: 2020 636f 6e66 6967 203d 2063 6f6d 6d6f    config = commo
+0000bab0: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
+0000bac0: 6c28 636c 7573 7465 725f 636f 6e66 6967  l(cluster_config
+0000bad0: 5f66 696c 6529 0a0a 2020 2020 646f 636b  _file)..    dock
+0000bae0: 6572 5f75 7365 7220 3d20 4e6f 6e65 0a20  er_user = None. 
+0000baf0: 2020 2069 6620 2764 6f63 6b65 7227 2069     if 'docker' i
+0000bb00: 6e20 636f 6e66 6967 3a0a 2020 2020 2020  n config:.      
+0000bb10: 2020 646f 636b 6572 5f75 7365 7220 3d20    docker_user = 
+0000bb20: 6765 745f 646f 636b 6572 5f75 7365 7228  get_docker_user(
+0000bb30: 6865 6164 5f69 702c 2063 6c75 7374 6572  head_ip, cluster
+0000bb40: 5f63 6f6e 6669 675f 6669 6c65 290a 0a20  _config_file).. 
+0000bb50: 2020 2069 6620 6e75 6d5f 6e6f 6465 7320     if num_nodes 
+0000bb60: 3c3d 2031 3a0a 2020 2020 2020 2020 7265  <= 1:.        re
+0000bb70: 7475 726e 2054 7275 652c 2064 6f63 6b65  turn True, docke
+0000bb80: 725f 7573 6572 0a0a 2020 2020 7373 685f  r_user..    ssh_
+0000bb90: 6372 6564 656e 7469 616c 7320 3d20 7373  credentials = ss
+0000bba0: 685f 6372 6564 656e 7469 616c 5f66 726f  h_credential_fro
+0000bbb0: 6d5f 7961 6d6c 2863 6c75 7374 6572 5f63  m_yaml(cluster_c
+0000bbc0: 6f6e 6669 675f 6669 6c65 2c20 646f 636b  onfig_file, dock
+0000bbd0: 6572 5f75 7365 7229 0a20 2020 206c 6173  er_user).    las
+0000bbe0: 745f 6e6f 6465 735f 736f 5f66 6172 203d  t_nodes_so_far =
+0000bbf0: 2030 0a20 2020 2073 7461 7274 203d 2074   0.    start = t
+0000bc00: 696d 652e 7469 6d65 2829 0a20 2020 2072  ime.time().    r
+0000bc10: 756e 6e65 7220 3d20 636f 6d6d 616e 645f  unner = command_
+0000bc20: 7275 6e6e 6572 2e53 5348 436f 6d6d 616e  runner.SSHComman
+0000bc30: 6452 756e 6e65 7228 6865 6164 5f69 702c  dRunner(head_ip,
+0000bc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 706f                po
+0000bc70: 7274 3d32 322c 0a20 2020 2020 2020 2020  rt=22,.         
+0000bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bca0: 2020 2020 2a2a 7373 685f 6372 6564 656e      **ssh_creden
+0000bcb0: 7469 616c 7329 0a20 2020 2077 6974 6820  tials).    with 
+0000bcc0: 7269 6368 5f75 7469 6c73 2e73 6166 655f  rich_utils.safe_
+0000bcd0: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+0000bce0: 2020 2020 275b 626f 6c64 2063 7961 6e5d      '[bold cyan]
+0000bcf0: 5761 6974 696e 6720 666f 7220 776f 726b  Waiting for work
+0000bd00: 6572 732e 2e2e 2729 2061 7320 776f 726b  ers...') as work
+0000bd10: 6572 5f73 7461 7475 733a 0a20 2020 2020  er_status:.     
+0000bd20: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+0000bd30: 2020 2020 2020 2020 2020 2072 632c 206f             rc, o
+0000bd40: 7574 7075 742c 2073 7464 6572 7220 3d20  utput, stderr = 
+0000bd50: 7275 6e6e 6572 2e72 756e 280a 2020 2020  runner.run(.    
+0000bd60: 2020 2020 2020 2020 2020 2020 696e 7374              inst
+0000bd70: 616e 6365 5f73 6574 7570 2e52 4159 5f53  ance_setup.RAY_S
+0000bd80: 5441 5455 535f 5749 5448 5f53 4b59 5f52  TATUS_WITH_SKY_R
+0000bd90: 4159 5f50 4f52 545f 434f 4d4d 414e 442c  AY_PORT_COMMAND,
+0000bda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bdb0: 206c 6f67 5f70 6174 683d 6c6f 675f 7061   log_path=log_pa
+0000bdc0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000bdd0: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
+0000bde0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+0000bdf0: 2020 2020 2020 2072 6571 7569 7265 5f6f         require_o
+0000be00: 7574 7075 7473 3d54 7275 652c 0a20 2020  utputs=True,.   
+0000be10: 2020 2020 2020 2020 2020 2020 2073 6570               sep
+0000be20: 6172 6174 655f 7374 6465 7272 3d54 7275  arate_stderr=Tru
+0000be30: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0000be40: 7562 7072 6f63 6573 735f 7574 696c 732e  ubprocess_utils.
+0000be50: 6861 6e64 6c65 5f72 6574 7572 6e63 6f64  handle_returncod
+0000be60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000be70: 2020 2072 632c 2069 6e73 7461 6e63 655f     rc, instance_
+0000be80: 7365 7475 702e 5241 595f 5354 4154 5553  setup.RAY_STATUS
+0000be90: 5f57 4954 485f 534b 595f 5241 595f 504f  _WITH_SKY_RAY_PO
+0000bea0: 5254 5f43 4f4d 4d41 4e44 2c0a 2020 2020  RT_COMMAND,.    
+0000beb0: 2020 2020 2020 2020 2020 2020 2746 6169              'Fai
+0000bec0: 6c65 6420 746f 2072 756e 2072 6179 2073  led to run ray s
+0000bed0: 7461 7475 7320 6f6e 2068 6561 6420 6e6f  tatus on head no
+0000bee0: 6465 2e27 2c20 7374 6465 7272 290a 2020  de.', stderr).  
+0000bef0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0000bf00: 2e64 6562 7567 286f 7574 7075 7429 0a0a  .debug(output)..
+0000bf10: 2020 2020 2020 2020 2020 2020 7265 6164              read
+0000bf20: 795f 6865 6164 2c20 7265 6164 795f 776f  y_head, ready_wo
+0000bf30: 726b 6572 7320 3d20 5f63 6f75 6e74 5f68  rkers = _count_h
+0000bf40: 6561 6c74 6879 5f6e 6f64 6573 5f66 726f  ealthy_nodes_fro
+0000bf50: 6d5f 7261 7928 0a20 2020 2020 2020 2020  m_ray(.         
+0000bf60: 2020 2020 2020 206f 7574 7075 742c 2069         output, i
+0000bf70: 735f 6c6f 6361 6c5f 636c 6f75 643d 6973  s_local_cloud=is
+0000bf80: 5f6c 6f63 616c 5f63 6c6f 7564 290a 0a20  _local_cloud).. 
+0000bf90: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0000bfa0: 725f 7374 6174 7573 2e75 7064 6174 6528  r_status.update(
+0000bfb0: 275b 626f 6c64 2063 7961 6e5d 270a 2020  '[bold cyan]'.  
+0000bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000bfe0: 277b 7265 6164 795f 776f 726b 6572 737d  '{ready_workers}
+0000bff0: 206f 7574 206f 6620 7b6e 756d 5f6e 6f64   out of {num_nod
+0000c000: 6573 202d 2031 7d20 270a 2020 2020 2020  es - 1} '.      
+0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c020: 2020 2020 2020 2020 2020 2027 776f 726b             'work
+0000c030: 6572 7320 7265 6164 7927 290a 0a20 2020  ers ready')..   
+0000c040: 2020 2020 2020 2020 2023 2049 6e20 7468           # In th
+0000c050: 6520 6c6f 6361 6c20 6361 7365 2c20 7265  e local case, re
+0000c060: 6164 795f 6865 6164 3d30 2061 6e64 2072  ady_head=0 and r
+0000c070: 6561 6479 5f77 6f72 6b65 7273 3d6e 756d  eady_workers=num
+0000c080: 5f6e 6f64 6573 2e20 5468 6973 0a20 2020  _nodes. This.   
+0000c090: 2020 2020 2020 2020 2023 2069 7320 6265           # is be
+0000c0a0: 6361 7573 6520 7468 6572 6520 6973 206e  cause there is n
+0000c0b0: 6f20 6d61 7463 6869 6e67 2072 6567 6578  o matching regex
+0000c0c0: 2066 6f72 205f 4c41 554e 4348 4544 5f48   for _LAUNCHED_H
+0000c0d0: 4541 445f 5041 5454 4552 4e2e 0a20 2020  EAD_PATTERN..   
+0000c0e0: 2020 2020 2020 2020 2069 6620 7265 6164           if read
+0000c0f0: 795f 6865 6164 202b 2072 6561 6479 5f77  y_head + ready_w
+0000c100: 6f72 6b65 7273 203d 3d20 6e75 6d5f 6e6f  orkers == num_no
+0000c110: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
+0000c120: 2020 2020 2023 2041 6c6c 206e 6f64 6573       # All nodes
+0000c130: 2061 7265 2075 702e 0a20 2020 2020 2020   are up..       
+0000c140: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+0000c150: 2020 2020 2020 2020 2020 2020 2320 5065              # Pe
+0000c160: 6e64 696e 6720 776f 726b 6572 7320 7468  nding workers th
+0000c170: 6174 2068 6176 6520 6265 656e 206c 6175  at have been lau
+0000c180: 6e63 6865 6420 6279 2072 6179 2075 702e  nched by ray up.
+0000c190: 0a20 2020 2020 2020 2020 2020 2066 6f75  .            fou
+0000c1a0: 6e64 5f69 7073 203d 205f 4c41 554e 4348  nd_ips = _LAUNCH
+0000c1b0: 494e 475f 4950 5f50 4154 5445 524e 2e66  ING_IP_PATTERN.f
+0000c1c0: 696e 6461 6c6c 286f 7574 7075 7429 0a20  indall(output). 
+0000c1d0: 2020 2020 2020 2020 2020 2070 656e 6469             pendi
+0000c1e0: 6e67 5f77 6f72 6b65 7273 203d 206c 656e  ng_workers = len
+0000c1f0: 2866 6f75 6e64 5f69 7073 290a 0a20 2020  (found_ips)..   
+0000c200: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+0000c210: 7a68 7775 293a 2048 616e 646c 6520 7468  zhwu): Handle th
+0000c220: 6520 6361 7365 2077 6865 7265 2074 6865  e case where the
+0000c230: 2066 6f6c 6c6f 7769 6e67 206f 6363 7572   following occur
+0000c240: 732c 2077 6865 7265 2072 6179 0a20 2020  s, where ray.   
+0000c250: 2020 2020 2020 2020 2023 2063 6c75 7374           # clust
+0000c260: 6572 2069 7320 6e6f 7420 636f 7272 6563  er is not correc
+0000c270: 746c 7920 7374 6172 7465 6420 6f6e 2074  tly started on t
+0000c280: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+0000c290: 2020 2020 2020 2020 2320 5065 6e64 696e          # Pendin
+0000c2a0: 673a 0a20 2020 2020 2020 2020 2020 2023  g:.            #
+0000c2b0: 2020 3137 322e 3331 2e39 2e31 3231 3a20    172.31.9.121: 
+0000c2c0: 7261 792e 776f 726b 6572 2e64 6566 6175  ray.worker.defau
+0000c2d0: 6c74 2c20 756e 696e 6974 6961 6c69 7a65  lt, uninitialize
+0000c2e0: 640a 2020 2020 2020 2020 2020 2020 6e6f  d.            no
+0000c2f0: 6465 735f 736f 5f66 6172 203d 2072 6561  des_so_far = rea
+0000c300: 6479 5f68 6561 6420 2b20 7265 6164 795f  dy_head + ready_
+0000c310: 776f 726b 6572 7320 2b20 7065 6e64 696e  workers + pendin
+0000c320: 675f 776f 726b 6572 730a 0a20 2020 2020  g_workers..     
+0000c330: 2020 2020 2020 2023 2043 6865 636b 2074         # Check t
+0000c340: 6865 206e 756d 6265 7220 6f66 206e 6f64  he number of nod
+0000c350: 6573 2074 6861 7420 6172 6520 6665 7463  es that are fetc
+0000c360: 6865 642e 2054 696d 656f 7574 2069 6620  hed. Timeout if 
+0000c370: 6e6f 206e 6577 0a20 2020 2020 2020 2020  no new.         
+0000c380: 2020 2023 206e 6f64 6573 2066 6574 6368     # nodes fetch
+0000c390: 6564 2069 6e20 6120 7768 696c 6520 286e  ed in a while (n
+0000c3a0: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
+0000c3b0: 726f 6772 6573 735f 7469 6d65 6f75 7429  rogress_timeout)
+0000c3c0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000c3d0: 7468 6f75 6768 206e 756d 6265 7220 6f66  though number of
+0000c3e0: 206e 6f64 6573 5f73 6f5f 6661 7220 6973   nodes_so_far is
+0000c3f0: 2073 7469 6c6c 206e 6f74 2061 7320 6578   still not as ex
+0000c400: 7065 6374 6564 2e0a 2020 2020 2020 2020  pected..        
+0000c410: 2020 2020 6966 206e 6f64 6573 5f73 6f5f      if nodes_so_
+0000c420: 6661 7220 3e20 6c61 7374 5f6e 6f64 6573  far > last_nodes
+0000c430: 5f73 6f5f 6661 723a 0a20 2020 2020 2020  _so_far:.       
+0000c440: 2020 2020 2020 2020 2023 2052 6573 6574           # Reset
+0000c450: 2074 6865 2073 7461 7274 2074 696d 6520   the start time 
+0000c460: 6966 2074 6865 206e 756d 6265 7220 6f66  if the number of
+0000c470: 206c 6175 6e63 6869 6e67 206e 6f64 6573   launching nodes
+0000c480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c490: 2023 2063 6861 6e67 6573 2c20 692e 652e   # changes, i.e.
+0000c4a0: 206e 6577 206e 6f64 6573 2061 7265 206c   new nodes are l
+0000c4b0: 6175 6e63 6865 642e 0a20 2020 2020 2020  aunched..       
+0000c4c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000c4d0: 6465 6275 6728 2752 6573 6574 2073 7461  debug('Reset sta
+0000c4e0: 7274 2074 696d 652c 2061 7320 6e65 7720  rt time, as new 
+0000c4f0: 6e6f 6465 7320 6172 6520 6c61 756e 6368  nodes are launch
+0000c500: 6564 2e20 270a 2020 2020 2020 2020 2020  ed. '.          
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c520: 2020 2066 2728 7b6c 6173 745f 6e6f 6465     f'({last_node
+0000c530: 735f 736f 5f66 6172 7d20 2d3e 207b 6e6f  s_so_far} -> {no
+0000c540: 6465 735f 736f 5f66 6172 7d29 2729 0a20  des_so_far})'). 
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000c560: 7461 7274 203d 2074 696d 652e 7469 6d65  tart = time.time
+0000c570: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000c580: 2020 206c 6173 745f 6e6f 6465 735f 736f     last_nodes_so
+0000c590: 5f66 6172 203d 206e 6f64 6573 5f73 6f5f  _far = nodes_so_
+0000c5a0: 6661 720a 2020 2020 2020 2020 2020 2020  far.            
+0000c5b0: 656c 6966 2028 6e6f 6465 735f 6c61 756e  elif (nodes_laun
+0000c5c0: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
+0000c5d0: 696d 656f 7574 2069 7320 6e6f 7420 4e6f  imeout is not No
+0000c5e0: 6e65 2061 6e64 0a20 2020 2020 2020 2020  ne and.         
+0000c5f0: 2020 2020 2020 2020 2074 696d 652e 7469           time.ti
+0000c600: 6d65 2829 202d 2073 7461 7274 203e 206e  me() - start > n
+0000c610: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
+0000c620: 726f 6772 6573 735f 7469 6d65 6f75 7420  rogress_timeout 
+0000c630: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
+0000c640: 2020 2020 2020 6e6f 6465 735f 736f 5f66        nodes_so_f
+0000c650: 6172 2021 3d20 6e75 6d5f 6e6f 6465 7329  ar != num_nodes)
+0000c660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c670: 2020 6c6f 6767 6572 2e65 7272 6f72 280a    logger.error(.
+0000c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c690: 2020 2020 2754 696d 6564 206f 7574 3a20      'Timed out: 
+0000c6a0: 7761 6974 6564 2066 6f72 206d 6f72 6520  waited for more 
+0000c6b0: 7468 616e 2027 0a20 2020 2020 2020 2020  than '.         
+0000c6c0: 2020 2020 2020 2020 2020 2066 277b 6e6f             f'{no
+0000c6d0: 6465 735f 6c61 756e 6368 696e 675f 7072  des_launching_pr
+0000c6e0: 6f67 7265 7373 5f74 696d 656f 7574 7d20  ogress_timeout} 
+0000c6f0: 7365 636f 6e64 7320 666f 7220 6e65 7720  seconds for new 
+0000c700: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000c710: 2020 2020 2020 2777 6f72 6b65 7273 2074        'workers t
+0000c720: 6f20 6265 2070 726f 7669 7369 6f6e 6564  o be provisioned
+0000c730: 2c20 6275 7420 6e6f 2070 726f 6772 6573  , but no progres
+0000c740: 732e 2729 0a20 2020 2020 2020 2020 2020  s.').           
+0000c750: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0000c760: 652c 204e 6f6e 6520 2023 2066 6169 6c65  e, None  # faile
+0000c770: 640a 0a20 2020 2020 2020 2020 2020 2069  d..            i
+0000c780: 6620 2728 6e6f 2070 656e 6469 6e67 206e  f '(no pending n
+0000c790: 6f64 6573 2927 2069 6e20 6f75 7470 7574  odes)' in output
+0000c7a0: 2061 6e64 2027 286e 6f20 6661 696c 7572   and '(no failur
+0000c7b0: 6573 2927 2069 6e20 6f75 7470 7574 3a0a  es)' in output:.
+0000c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7d0: 2320 4275 6720 696e 2072 6179 2061 7574  # Bug in ray aut
+0000c7e0: 6f73 6361 6c65 723a 2065 2e67 2e2c 206f  oscaler: e.g., o
+0000c7f0: 6e20 4743 502c 2069 6620 7265 7175 6573  n GCP, if reques
+0000c800: 7469 6e67 2032 206e 6f64 6573 0a20 2020  ting 2 nodes.   
+0000c810: 2020 2020 2020 2020 2020 2020 2023 2074               # t
+0000c820: 6861 7420 4743 5020 6361 6e20 7361 7469  hat GCP can sati
+0000c830: 7366 7920 6f6e 6c79 2062 7920 6861 6c66  sfy only by half
+0000c840: 2c20 7468 6520 776f 726b 6572 206e 6f64  , the worker nod
+0000c850: 6520 776f 756c 6420 6265 0a20 2020 2020  e would be.     
+0000c860: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
+0000c870: 676f 7474 656e 2e20 5468 6520 636f 7272  gotten. The corr
+0000c880: 6563 7420 6265 6861 7669 6f72 2073 686f  ect behavior sho
+0000c890: 756c 6420 6265 2066 6f72 2069 7420 746f  uld be for it to
+0000c8a0: 2065 7272 6f72 206f 7574 2e0a 2020 2020   error out..    
+0000c8b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000c8c0: 6572 2e65 7272 6f72 280a 2020 2020 2020  er.error(.      
+0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2746                'F
+0000c8e0: 6169 6c65 6420 746f 206c 6175 6e63 6820  ailed to launch 
+0000c8f0: 6d75 6c74 6970 6c65 206e 6f64 6573 206f  multiple nodes o
+0000c900: 6e20 270a 2020 2020 2020 2020 2020 2020  n '.            
+0000c910: 2020 2020 2020 2020 2747 4350 2064 7565          'GCP due
+0000c920: 2074 6f20 6120 6e6f 6e64 6574 6572 6d69   to a nondetermi
+0000c930: 6e69 7374 6963 2062 7567 2069 6e20 7261  nistic bug in ra
+0000c940: 7920 6175 746f 7363 616c 6572 2e27 290a  y autoscaler.').
+0000c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c960: 7265 7475 726e 2046 616c 7365 2c20 4e6f  return False, No
+0000c970: 6e65 2020 2320 6661 696c 6564 0a20 2020  ne  # failed.   
+0000c980: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+0000c990: 6565 7028 3130 290a 2020 2020 7265 7475  eep(10).    retu
+0000c9a0: 726e 2054 7275 652c 2064 6f63 6b65 725f  rn True, docker_
+0000c9b0: 7573 6572 2020 2320 7375 6363 6573 730a  user  # success.
+0000c9c0: 0a0a 6465 6620 7373 685f 6372 6564 656e  ..def ssh_creden
+0000c9d0: 7469 616c 5f66 726f 6d5f 7961 6d6c 280a  tial_from_yaml(.
+0000c9e0: 2020 2020 636c 7573 7465 725f 7961 6d6c      cluster_yaml
+0000c9f0: 3a20 7374 722c 0a20 2020 2064 6f63 6b65  : str,.    docke
+0000ca00: 725f 7573 6572 3a20 4f70 7469 6f6e 616c  r_user: Optional
+0000ca10: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+0000ca20: 2020 7373 685f 7573 6572 3a20 4f70 7469    ssh_user: Opti
+0000ca30: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+0000ca40: 2c0a 2920 2d3e 2044 6963 745b 7374 722c  ,.) -> Dict[str,
+0000ca50: 2041 6e79 5d3a 0a20 2020 2022 2222 5265   Any]:.    """Re
+0000ca60: 7475 726e 7320 7373 685f 7573 6572 2c20  turns ssh_user, 
+0000ca70: 7373 685f 7072 6976 6174 655f 6b65 7920  ssh_private_key 
+0000ca80: 616e 6420 7373 685f 636f 6e74 726f 6c20  and ssh_control 
+0000ca90: 6e61 6d65 2e0a 0a20 2020 2041 7267 733a  name...    Args:
+0000caa0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+0000cab0: 5f79 616d 6c3a 2070 6174 6820 746f 2074  _yaml: path to t
+0000cac0: 6865 2063 6c75 7374 6572 2079 616d 6c2e  he cluster yaml.
+0000cad0: 0a20 2020 2020 2020 2064 6f63 6b65 725f  .        docker_
+0000cae0: 7573 6572 3a20 7768 656e 2075 7369 6e67  user: when using
+0000caf0: 2063 7573 746f 6d20 646f 636b 6572 2069   custom docker i
+0000cb00: 6d61 6765 2c20 7573 6520 7468 6973 2075  mage, use this u
+0000cb10: 7365 7220 746f 2073 7368 2069 6e74 6f0a  ser to ssh into.
+0000cb20: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+0000cb30: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
+0000cb40: 2e0a 2020 2020 2020 2020 7373 685f 7573  ..        ssh_us
+0000cb50: 6572 3a20 6f76 6572 7269 6465 2074 6865  er: override the
+0000cb60: 2073 7368 5f75 7365 7220 696e 2074 6865   ssh_user in the
+0000cb70: 2063 6c75 7374 6572 2079 616d 6c2e 0a20   cluster yaml.. 
+0000cb80: 2020 2022 2222 0a20 2020 2063 6f6e 6669     """.    confi
+0000cb90: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
+0000cba0: 2e72 6561 645f 7961 6d6c 2863 6c75 7374  .read_yaml(clust
+0000cbb0: 6572 5f79 616d 6c29 0a20 2020 2061 7574  er_yaml).    aut
+0000cbc0: 685f 7365 6374 696f 6e20 3d20 636f 6e66  h_section = conf
+0000cbd0: 6967 5b27 6175 7468 275d 0a20 2020 2069  ig['auth'].    i
+0000cbe0: 6620 7373 685f 7573 6572 2069 7320 4e6f  f ssh_user is No
+0000cbf0: 6e65 3a0a 2020 2020 2020 2020 7373 685f  ne:.        ssh_
+0000cc00: 7573 6572 203d 2061 7574 685f 7365 6374  user = auth_sect
+0000cc10: 696f 6e5b 2773 7368 5f75 7365 7227 5d2e  ion['ssh_user'].
+0000cc20: 7374 7269 7028 290a 2020 2020 7373 685f  strip().    ssh_
+0000cc30: 7072 6976 6174 655f 6b65 7920 3d20 6175  private_key = au
+0000cc40: 7468 5f73 6563 7469 6f6e 2e67 6574 2827  th_section.get('
+0000cc50: 7373 685f 7072 6976 6174 655f 6b65 7927  ssh_private_key'
+0000cc60: 290a 2020 2020 7373 685f 636f 6e74 726f  ).    ssh_contro
+0000cc70: 6c5f 6e61 6d65 203d 2063 6f6e 6669 672e  l_name = config.
+0000cc80: 6765 7428 2763 6c75 7374 6572 5f6e 616d  get('cluster_nam
+0000cc90: 6527 2c20 275f 5f64 6566 6175 6c74 5f5f  e', '__default__
+0000cca0: 2729 0a20 2020 2073 7368 5f70 726f 7879  ').    ssh_proxy
+0000ccb0: 5f63 6f6d 6d61 6e64 203d 2061 7574 685f  _command = auth_
+0000ccc0: 7365 6374 696f 6e2e 6765 7428 2773 7368  section.get('ssh
+0000ccd0: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2729  _proxy_command')
+0000cce0: 0a20 2020 2063 7265 6465 6e74 6961 6c73  .    credentials
+0000ccf0: 203d 207b 0a20 2020 2020 2020 2027 7373   = {.        'ss
+0000cd00: 685f 7573 6572 273a 2073 7368 5f75 7365  h_user': ssh_use
+0000cd10: 722c 0a20 2020 2020 2020 2027 7373 685f  r,.        'ssh_
+0000cd20: 7072 6976 6174 655f 6b65 7927 3a20 7373  private_key': ss
+0000cd30: 685f 7072 6976 6174 655f 6b65 792c 0a20  h_private_key,. 
+0000cd40: 2020 2020 2020 2027 7373 685f 636f 6e74         'ssh_cont
+0000cd50: 726f 6c5f 6e61 6d65 273a 2073 7368 5f63  rol_name': ssh_c
+0000cd60: 6f6e 7472 6f6c 5f6e 616d 652c 0a20 2020  ontrol_name,.   
+0000cd70: 2020 2020 2027 7373 685f 7072 6f78 795f       'ssh_proxy_
+0000cd80: 636f 6d6d 616e 6427 3a20 7373 685f 7072  command': ssh_pr
+0000cd90: 6f78 795f 636f 6d6d 616e 642c 0a20 2020  oxy_command,.   
+0000cda0: 207d 0a20 2020 2069 6620 646f 636b 6572   }.    if docker
+0000cdb0: 5f75 7365 7220 6973 206e 6f74 204e 6f6e  _user is not Non
+0000cdc0: 653a 0a20 2020 2020 2020 2063 7265 6465  e:.        crede
+0000cdd0: 6e74 6961 6c73 5b27 646f 636b 6572 5f75  ntials['docker_u
+0000cde0: 7365 7227 5d20 3d20 646f 636b 6572 5f75  ser'] = docker_u
+0000cdf0: 7365 720a 2020 2020 7373 685f 7072 6f76  ser.    ssh_prov
+0000ce00: 6964 6572 5f6d 6f64 756c 6520 3d20 636f  ider_module = co
+0000ce10: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
+0000ce20: 5b27 6d6f 6475 6c65 275d 0a20 2020 2023  ['module'].    #
+0000ce30: 2049 6620 7765 2061 7265 2072 756e 6e69   If we are runni
+0000ce40: 6e67 2073 7368 2063 6f6d 6d61 6e64 206f  ng ssh command o
+0000ce50: 6e20 6b75 6265 726e 6574 6573 206e 6f64  n kubernetes nod
+0000ce60: 652e 0a20 2020 2069 6620 276b 7562 6572  e..    if 'kuber
+0000ce70: 6e65 7465 7327 2069 6e20 7373 685f 7072  netes' in ssh_pr
+0000ce80: 6f76 6964 6572 5f6d 6f64 756c 653a 0a20  ovider_module:. 
+0000ce90: 2020 2020 2020 2063 7265 6465 6e74 6961         credentia
+0000cea0: 6c73 5b27 6469 7361 626c 655f 636f 6e74  ls['disable_cont
+0000ceb0: 726f 6c5f 6d61 7374 6572 275d 203d 2054  rol_master'] = T
+0000cec0: 7275 650a 2020 2020 7265 7475 726e 2063  rue.    return c
+0000ced0: 7265 6465 6e74 6961 6c73 0a0a 0a64 6566  redentials...def
+0000cee0: 2070 6172 616c 6c65 6c5f 6461 7461 5f74   parallel_data_t
+0000cef0: 7261 6e73 6665 725f 746f 5f6e 6f64 6573  ransfer_to_nodes
+0000cf00: 280a 2020 2020 7275 6e6e 6572 733a 204c  (.    runners: L
+0000cf10: 6973 745b 636f 6d6d 616e 645f 7275 6e6e  ist[command_runn
+0000cf20: 6572 2e53 5348 436f 6d6d 616e 6452 756e  er.SSHCommandRun
+0000cf30: 6e65 725d 2c0a 2020 2020 736f 7572 6365  ner],.    source
+0000cf40: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
+0000cf50: 0a20 2020 2074 6172 6765 743a 2073 7472  .    target: str
+0000cf60: 2c0a 2020 2020 636d 643a 204f 7074 696f  ,.    cmd: Optio
+0000cf70: 6e61 6c5b 7374 725d 2c0a 2020 2020 7275  nal[str],.    ru
+0000cf80: 6e5f 7273 796e 633a 2062 6f6f 6c2c 0a20  n_rsync: bool,. 
+0000cf90: 2020 202a 2c0a 2020 2020 6163 7469 6f6e     *,.    action
+0000cfa0: 5f6d 6573 7361 6765 3a20 7374 722c 0a20  _message: str,. 
+0000cfb0: 2020 2023 2041 6476 616e 6365 6420 6f70     # Advanced op
+0000cfc0: 7469 6f6e 732e 0a20 2020 206c 6f67 5f70  tions..    log_p
+0000cfd0: 6174 683a 2073 7472 203d 206f 732e 6465  ath: str = os.de
+0000cfe0: 766e 756c 6c2c 0a20 2020 2073 7472 6561  vnull,.    strea
+0000cff0: 6d5f 6c6f 6773 3a20 626f 6f6c 203d 2046  m_logs: bool = F
+0000d000: 616c 7365 2c0a 293a 0a20 2020 2022 2222  alse,.):.    """
+0000d010: 5275 6e73 2061 2063 6f6d 6d61 6e64 206f  Runs a command o
+0000d020: 6e20 616c 6c20 6e6f 6465 7320 616e 6420  n all nodes and 
+0000d030: 6f70 7469 6f6e 616c 6c79 2072 756e 7320  optionally runs 
+0000d040: 7273 796e 6320 6672 6f6d 2073 7263 2d3e  rsync from src->
+0000d050: 6473 742e 0a0a 2020 2020 4172 6773 3a0a  dst...    Args:.
+0000d060: 2020 2020 2020 2020 7275 6e6e 6572 733a          runners:
+0000d070: 2041 206c 6973 7420 6f66 2053 5348 436f   A list of SSHCo
+0000d080: 6d6d 616e 6452 756e 6e65 7220 6f62 6a65  mmandRunner obje
+0000d090: 6374 7320 7468 6174 2072 6570 7265 7365  cts that represe
+0000d0a0: 6e74 206d 756c 7469 706c 6520 6e6f 6465  nt multiple node
+0000d0b0: 732e 0a20 2020 2020 2020 2073 6f75 7263  s..        sourc
+0000d0c0: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+0000d0d0: 3b20 536f 7572 6365 2066 6f72 2072 7379  ; Source for rsy
+0000d0e0: 6e63 206f 6e20 6c6f 6361 6c20 6e6f 6465  nc on local node
+0000d0f0: 0a20 2020 2020 2020 2074 6172 6765 743a  .        target:
+0000d100: 2073 7472 3b20 4465 7374 696e 6174 696f   str; Destinatio
+0000d110: 6e20 6f6e 2072 656d 6f74 6520 6e6f 6465  n on remote node
+0000d120: 2066 6f72 2072 7379 6e63 0a20 2020 2020   for rsync.     
+0000d130: 2020 2063 6d64 3a20 7374 723b 2043 6f6d     cmd: str; Com
+0000d140: 6d61 6e64 2074 6f20 6265 2065 7865 6375  mand to be execu
+0000d150: 7465 6420 6f6e 2061 6c6c 206e 6f64 6573  ted on all nodes
+0000d160: 0a20 2020 2020 2020 2061 6374 696f 6e5f  .        action_
+0000d170: 6d65 7373 6167 653a 2073 7472 3b20 4d65  message: str; Me
+0000d180: 7373 6167 6520 746f 2062 6520 7072 696e  ssage to be prin
+0000d190: 7465 6420 7768 696c 6520 7468 6520 636f  ted while the co
+0000d1a0: 6d6d 616e 6420 7275 6e73 0a20 2020 2020  mmand runs.     
+0000d1b0: 2020 206c 6f67 5f70 6174 683a 2073 7472     log_path: str
+0000d1c0: 3b20 5061 7468 2074 6f20 7468 6520 6c6f  ; Path to the lo
+0000d1d0: 6720 6669 6c65 0a20 2020 2020 2020 2073  g file.        s
+0000d1e0: 7472 6561 6d5f 6c6f 6773 3a20 626f 6f6c  tream_logs: bool
+0000d1f0: 3b20 5768 6574 6865 7220 746f 2073 7472  ; Whether to str
+0000d200: 6561 6d20 6c6f 6773 2074 6f20 7374 646f  eam logs to stdo
+0000d210: 7574 0a20 2020 2022 2222 0a20 2020 2066  ut.    """.    f
+0000d220: 6f72 6520 3d20 636f 6c6f 7261 6d61 2e46  ore = colorama.F
+0000d230: 6f72 650a 2020 2020 7374 796c 6520 3d20  ore.    style = 
+0000d240: 636f 6c6f 7261 6d61 2e53 7479 6c65 0a0a  colorama.Style..
+0000d250: 2020 2020 6f72 6967 696e 5f73 6f75 7263      origin_sourc
+0000d260: 6520 3d20 736f 7572 6365 0a0a 2020 2020  e = source..    
+0000d270: 6465 6620 5f73 796e 635f 6e6f 6465 2872  def _sync_node(r
+0000d280: 756e 6e65 723a 2027 636f 6d6d 616e 645f  unner: 'command_
+0000d290: 7275 6e6e 6572 2e53 5348 436f 6d6d 616e  runner.SSHComman
+0000d2a0: 6452 756e 6e65 7227 2920 2d3e 204e 6f6e  dRunner') -> Non
+0000d2b0: 653a 0a20 2020 2020 2020 2069 6620 636d  e:.        if cm
+0000d2c0: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
+0000d2d0: 2020 2020 2020 2020 2020 2072 632c 2073             rc, s
+0000d2e0: 7464 6f75 742c 2073 7464 6572 7220 3d20  tdout, stderr = 
+0000d2f0: 7275 6e6e 6572 2e72 756e 2863 6d64 2c0a  runner.run(cmd,.
+0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d320: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+0000d330: 7061 7468 3d6c 6f67 5f70 6174 682c 0a20  path=log_path,. 
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d360: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+0000d370: 6d5f 6c6f 6773 3d73 7472 6561 6d5f 6c6f  m_logs=stream_lo
+0000d380: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
 0000d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3b0: 2020 2020 2020 2020 2020 2020 636d 642c              cmd,
-0000d3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3f0: 6572 725f 6d73 672c 0a20 2020 2020 2020  err_msg,.       
-0000d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d420: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
-0000d430: 7464 6f75 7420 2b20 7374 6465 7272 290a  tdout + stderr).
-0000d440: 0a20 2020 2020 2020 2069 6620 7275 6e5f  .        if run_
-0000d450: 7273 796e 633a 0a20 2020 2020 2020 2020  rsync:.         
-0000d460: 2020 2061 7373 6572 7420 736f 7572 6365     assert source
-0000d470: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0000d480: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
-0000d490: 7a68 7775 293a 204f 7074 696d 697a 6520  zhwu): Optimize 
-0000d4a0: 666f 7220 6c61 7267 6520 616d 6f75 6e74  for large amount
-0000d4b0: 206f 6620 6669 6c65 732e 0a20 2020 2020   of files..     
-0000d4c0: 2020 2020 2020 2023 207a 6970 202f 2074         # zip / t
-0000d4d0: 7261 6e73 6665 7220 2f20 756e 7a69 700a  ransfer / unzip.
-0000d4e0: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
-0000d4f0: 6572 2e72 7379 6e63 280a 2020 2020 2020  er.rsync(.      
-0000d500: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000d510: 3d73 6f75 7263 652c 0a20 2020 2020 2020  =source,.       
-0000d520: 2020 2020 2020 2020 2074 6172 6765 743d           target=
-0000d530: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
-0000d540: 2020 2020 2020 2020 7570 3d54 7275 652c          up=True,
-0000d550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d560: 206c 6f67 5f70 6174 683d 6c6f 675f 7061   log_path=log_pa
-0000d570: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000d580: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
-0000d590: 7374 7265 616d 5f6c 6f67 732c 0a20 2020  stream_logs,.   
-0000d5a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000d5b0: 6e75 6d5f 6e6f 6465 7320 3d20 6c65 6e28  num_nodes = len(
-0000d5c0: 7275 6e6e 6572 7329 0a20 2020 2070 6c75  runners).    plu
-0000d5d0: 7261 6c20 3d20 2773 2720 6966 206e 756d  ral = 's' if num
-0000d5e0: 5f6e 6f64 6573 203e 2031 2065 6c73 6520  _nodes > 1 else 
-0000d5f0: 2727 0a20 2020 206d 6573 7361 6765 203d  ''.    message =
-0000d600: 2028 6627 7b66 6f72 652e 4359 414e 7d7b   (f'{fore.CYAN}{
-0000d610: 6163 7469 6f6e 5f6d 6573 7361 6765 7d20  action_message} 
-0000d620: 2874 6f20 7b6e 756d 5f6e 6f64 6573 7d20  (to {num_nodes} 
-0000d630: 6e6f 6465 7b70 6c75 7261 6c7d 2927 0a20  node{plural})'. 
-0000d640: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000d650: 3a20 7b73 7479 6c65 2e42 5249 4748 547d  : {style.BRIGHT}
-0000d660: 7b6f 7269 6769 6e5f 736f 7572 6365 7d7b  {origin_source}{
-0000d670: 7374 796c 652e 5245 5345 545f 414c 4c7d  style.RESET_ALL}
-0000d680: 202d 3e20 270a 2020 2020 2020 2020 2020   -> '.          
-0000d690: 2020 2020 2066 277b 7374 796c 652e 4252       f'{style.BR
-0000d6a0: 4947 4854 7d7b 7461 7267 6574 7d7b 7374  IGHT}{target}{st
-0000d6b0: 796c 652e 5245 5345 545f 414c 4c7d 2729  yle.RESET_ALL}')
-0000d6c0: 0a20 2020 206c 6f67 6765 722e 696e 666f  .    logger.info
-0000d6d0: 286d 6573 7361 6765 290a 2020 2020 7769  (message).    wi
-0000d6e0: 7468 2072 6963 685f 7574 696c 732e 7361  th rich_utils.sa
-0000d6f0: 6665 5f73 7461 7475 7328 6627 5b62 6f6c  fe_status(f'[bol
-0000d700: 6420 6379 616e 5d7b 6163 7469 6f6e 5f6d  d cyan]{action_m
-0000d710: 6573 7361 6765 7d5b 2f5d 2729 3a0a 2020  essage}[/]'):.  
-0000d720: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0000d730: 5f75 7469 6c73 2e72 756e 5f69 6e5f 7061  _utils.run_in_pa
-0000d740: 7261 6c6c 656c 285f 7379 6e63 5f6e 6f64  rallel(_sync_nod
-0000d750: 652c 2072 756e 6e65 7273 290a 0a0a 6465  e, runners)...de
-0000d760: 6620 6368 6563 6b5f 6c6f 6361 6c5f 6770  f check_local_gp
-0000d770: 7573 2829 202d 3e20 626f 6f6c 3a0a 2020  us() -> bool:.  
-0000d780: 2020 2222 2243 6865 636b 7320 6966 2047    """Checks if G
-0000d790: 5055 7320 6172 6520 6176 6169 6c61 626c  PUs are availabl
-0000d7a0: 6520 6c6f 6361 6c6c 792e 0a0a 2020 2020  e locally...    
-0000d7b0: 5265 7475 726e 7320 7768 6574 6865 7220  Returns whether 
-0000d7c0: 4750 5573 2061 7265 2061 7661 696c 6162  GPUs are availab
-0000d7d0: 6c65 206f 6e20 7468 6520 6c6f 6361 6c20  le on the local 
-0000d7e0: 6d61 6368 696e 6520 6279 2063 6865 636b  machine by check
-0000d7f0: 696e 670a 2020 2020 6966 206e 7669 6469  ing.    if nvidi
-0000d800: 612d 736d 6920 6973 2069 6e73 7461 6c6c  a-smi is install
-0000d810: 6564 2061 6e64 2072 6574 7572 6e73 207a  ed and returns z
-0000d820: 6572 6f20 7265 7475 726e 2063 6f64 652e  ero return code.
-0000d830: 0a0a 2020 2020 5265 7475 726e 7320 5472  ..    Returns Tr
-0000d840: 7565 2069 6620 6e76 6964 6961 2d73 6d69  ue if nvidia-smi
-0000d850: 2069 7320 696e 7374 616c 6c65 6420 616e   is installed an
-0000d860: 6420 7265 7475 726e 7320 7a65 726f 2072  d returns zero r
-0000d870: 6574 7572 6e20 636f 6465 2c0a 2020 2020  eturn code,.    
-0000d880: 4661 6c73 6520 6966 206e 6f74 2e0a 2020  False if not..  
-0000d890: 2020 2222 220a 2020 2020 6973 5f66 756e    """.    is_fun
-0000d8a0: 6374 696f 6e61 6c20 3d20 4661 6c73 650a  ctional = False.
-0000d8b0: 2020 2020 696e 7374 616c 6c61 7469 6f6e      installation
-0000d8c0: 5f63 6865 636b 203d 2073 7562 7072 6f63  _check = subproc
-0000d8d0: 6573 732e 7275 6e28 5b27 7768 6963 6827  ess.run(['which'
-0000d8e0: 2c20 276e 7669 6469 612d 736d 6927 5d2c  , 'nvidia-smi'],
-0000d8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d910: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
-0000d920: 7375 6270 726f 6365 7373 2e44 4556 4e55  subprocess.DEVNU
-0000d930: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 2020 2020 2020 2020 2020 2020 7374 6465              stde
-0000d960: 7272 3d73 7562 7072 6f63 6573 732e 4445  rr=subprocess.DE
-0000d970: 564e 554c 4c2c 0a20 2020 2020 2020 2020  VNULL,.         
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000d9a0: 6865 636b 3d46 616c 7365 290a 2020 2020  heck=False).    
-0000d9b0: 6973 5f69 6e73 7461 6c6c 6564 203d 2069  is_installed = i
-0000d9c0: 6e73 7461 6c6c 6174 696f 6e5f 6368 6563  nstallation_chec
-0000d9d0: 6b2e 7265 7475 726e 636f 6465 203d 3d20  k.returncode == 
-0000d9e0: 300a 2020 2020 6966 2069 735f 696e 7374  0.    if is_inst
-0000d9f0: 616c 6c65 643a 0a20 2020 2020 2020 2065  alled:.        e
-0000da00: 7865 6375 7469 6f6e 5f63 6865 636b 203d  xecution_check =
-0000da10: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
-0000da20: 5b27 6e76 6964 6961 2d73 6d69 275d 2c0a  ['nvidia-smi'],.
-0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da50: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
-0000da60: 7375 6270 726f 6365 7373 2e44 4556 4e55  subprocess.DEVNU
-0000da70: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0000d3b0: 7265 7175 6972 655f 6f75 7470 7574 733d  require_outputs=
+0000d3c0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0000d3d0: 2020 6572 725f 6d73 6720 3d20 2827 4661    err_msg = ('Fa
+0000d3e0: 696c 6564 2074 6f20 7275 6e20 636f 6d6d  iled to run comm
+0000d3f0: 616e 6420 6265 666f 7265 2072 7379 6e63  and before rsync
+0000d400: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000d410: 2020 2020 2020 2020 2020 6627 7b6f 7269            f'{ori
+0000d420: 6769 6e5f 736f 7572 6365 7d20 2d3e 207b  gin_source} -> {
+0000d430: 7461 7267 6574 7d2e 2027 0a20 2020 2020  target}. '.     
+0000d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d450: 2020 2745 6e73 7572 6520 7468 6174 2074    'Ensure that t
+0000d460: 6865 206e 6574 776f 726b 2069 7320 7374  he network is st
+0000d470: 6162 6c65 2c20 7468 656e 2072 6574 7279  able, then retry
+0000d480: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+0000d490: 6966 206c 6f67 5f70 6174 6820 213d 206f  if log_path != o
+0000d4a0: 732e 6465 766e 756c 6c3a 0a20 2020 2020  s.devnull:.     
+0000d4b0: 2020 2020 2020 2020 2020 2065 7272 5f6d             err_m
+0000d4c0: 7367 202b 3d20 6627 2053 6565 206c 6f67  sg += f' See log
+0000d4d0: 7320 696e 207b 6c6f 675f 7061 7468 7d27  s in {log_path}'
+0000d4e0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
+0000d4f0: 7072 6f63 6573 735f 7574 696c 732e 6861  process_utils.ha
+0000d500: 6e64 6c65 5f72 6574 7572 6e63 6f64 6528  ndle_returncode(
+0000d510: 7263 2c0a 2020 2020 2020 2020 2020 2020  rc,.            
+0000d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d540: 2020 2063 6d64 2c0a 2020 2020 2020 2020     cmd,.        
+0000d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d570: 2020 2020 2020 2065 7272 5f6d 7367 2c0a         err_msg,.
+0000d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000d5b0: 7464 6572 723d 7374 646f 7574 202b 2073  tderr=stdout + s
+0000d5c0: 7464 6572 7229 0a0a 2020 2020 2020 2020  tderr)..        
+0000d5d0: 6966 2072 756e 5f72 7379 6e63 3a0a 2020  if run_rsync:.  
+0000d5e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000d5f0: 2073 6f75 7263 6520 6973 206e 6f74 204e   source is not N
+0000d600: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000d610: 2320 544f 444f 287a 6877 7529 3a20 4f70  # TODO(zhwu): Op
+0000d620: 7469 6d69 7a65 2066 6f72 206c 6172 6765  timize for large
+0000d630: 2061 6d6f 756e 7420 6f66 2066 696c 6573   amount of files
+0000d640: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000d650: 7a69 7020 2f20 7472 616e 7366 6572 202f  zip / transfer /
+0000d660: 2075 6e7a 6970 0a20 2020 2020 2020 2020   unzip.         
+0000d670: 2020 2072 756e 6e65 722e 7273 796e 6328     runner.rsync(
+0000d680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d690: 2073 6f75 7263 653d 736f 7572 6365 2c0a   source=source,.
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6b0: 7461 7267 6574 3d74 6172 6765 742c 0a20  target=target,. 
+0000d6c0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0000d6d0: 703d 5472 7565 2c0a 2020 2020 2020 2020  p=True,.        
+0000d6e0: 2020 2020 2020 2020 6c6f 675f 7061 7468          log_path
+0000d6f0: 3d6c 6f67 5f70 6174 682c 0a20 2020 2020  =log_path,.     
+0000d700: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+0000d710: 6d5f 6c6f 6773 3d73 7472 6561 6d5f 6c6f  m_logs=stream_lo
+0000d720: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0000d730: 290a 0a20 2020 206e 756d 5f6e 6f64 6573  )..    num_nodes
+0000d740: 203d 206c 656e 2872 756e 6e65 7273 290a   = len(runners).
+0000d750: 2020 2020 706c 7572 616c 203d 2027 7327      plural = 's'
+0000d760: 2069 6620 6e75 6d5f 6e6f 6465 7320 3e20   if num_nodes > 
+0000d770: 3120 656c 7365 2027 270a 2020 2020 6d65  1 else ''.    me
+0000d780: 7373 6167 6520 3d20 2866 277b 666f 7265  ssage = (f'{fore
+0000d790: 2e43 5941 4e7d 7b61 6374 696f 6e5f 6d65  .CYAN}{action_me
+0000d7a0: 7373 6167 657d 2028 746f 207b 6e75 6d5f  ssage} (to {num_
+0000d7b0: 6e6f 6465 737d 206e 6f64 657b 706c 7572  nodes} node{plur
+0000d7c0: 616c 7d29 270a 2020 2020 2020 2020 2020  al})'.          
+0000d7d0: 2020 2020 2066 273a 207b 7374 796c 652e       f': {style.
+0000d7e0: 4252 4947 4854 7d7b 6f72 6967 696e 5f73  BRIGHT}{origin_s
+0000d7f0: 6f75 7263 657d 7b73 7479 6c65 2e52 4553  ource}{style.RES
+0000d800: 4554 5f41 4c4c 7d20 2d3e 2027 0a20 2020  ET_ALL} -> '.   
+0000d810: 2020 2020 2020 2020 2020 2020 6627 7b73              f'{s
+0000d820: 7479 6c65 2e42 5249 4748 547d 7b74 6172  tyle.BRIGHT}{tar
+0000d830: 6765 747d 7b73 7479 6c65 2e52 4553 4554  get}{style.RESET
+0000d840: 5f41 4c4c 7d27 290a 2020 2020 6c6f 6767  _ALL}').    logg
+0000d850: 6572 2e69 6e66 6f28 6d65 7373 6167 6529  er.info(message)
+0000d860: 0a20 2020 2077 6974 6820 7269 6368 5f75  .    with rich_u
+0000d870: 7469 6c73 2e73 6166 655f 7374 6174 7573  tils.safe_status
+0000d880: 2866 275b 626f 6c64 2063 7961 6e5d 7b61  (f'[bold cyan]{a
+0000d890: 6374 696f 6e5f 6d65 7373 6167 657d 5b2f  ction_message}[/
+0000d8a0: 5d27 293a 0a20 2020 2020 2020 2073 7562  ]'):.        sub
+0000d8b0: 7072 6f63 6573 735f 7574 696c 732e 7275  process_utils.ru
+0000d8c0: 6e5f 696e 5f70 6172 616c 6c65 6c28 5f73  n_in_parallel(_s
+0000d8d0: 796e 635f 6e6f 6465 2c20 7275 6e6e 6572  ync_node, runner
+0000d8e0: 7329 0a0a 0a64 6566 2063 6865 636b 5f6c  s)...def check_l
+0000d8f0: 6f63 616c 5f67 7075 7328 2920 2d3e 2062  ocal_gpus() -> b
+0000d900: 6f6f 6c3a 0a20 2020 2022 2222 4368 6563  ool:.    """Chec
+0000d910: 6b73 2069 6620 4750 5573 2061 7265 2061  ks if GPUs are a
+0000d920: 7661 696c 6162 6c65 206c 6f63 616c 6c79  vailable locally
+0000d930: 2e0a 0a20 2020 2052 6574 7572 6e73 2077  ...    Returns w
+0000d940: 6865 7468 6572 2047 5055 7320 6172 6520  hether GPUs are 
+0000d950: 6176 6169 6c61 626c 6520 6f6e 2074 6865  available on the
+0000d960: 206c 6f63 616c 206d 6163 6869 6e65 2062   local machine b
+0000d970: 7920 6368 6563 6b69 6e67 0a20 2020 2069  y checking.    i
+0000d980: 6620 6e76 6964 6961 2d73 6d69 2069 7320  f nvidia-smi is 
+0000d990: 696e 7374 616c 6c65 6420 616e 6420 7265  installed and re
+0000d9a0: 7475 726e 7320 7a65 726f 2072 6574 7572  turns zero retur
+0000d9b0: 6e20 636f 6465 2e0a 0a20 2020 2052 6574  n code...    Ret
+0000d9c0: 7572 6e73 2054 7275 6520 6966 206e 7669  urns True if nvi
+0000d9d0: 6469 612d 736d 6920 6973 2069 6e73 7461  dia-smi is insta
+0000d9e0: 6c6c 6564 2061 6e64 2072 6574 7572 6e73  lled and returns
+0000d9f0: 207a 6572 6f20 7265 7475 726e 2063 6f64   zero return cod
+0000da00: 652c 0a20 2020 2046 616c 7365 2069 6620  e,.    False if 
+0000da10: 6e6f 742e 0a20 2020 2022 2222 0a20 2020  not..    """.   
+0000da20: 2069 735f 6675 6e63 7469 6f6e 616c 203d   is_functional =
+0000da30: 2046 616c 7365 0a20 2020 2069 6e73 7461   False.    insta
+0000da40: 6c6c 6174 696f 6e5f 6368 6563 6b20 3d20  llation_check = 
+0000da50: 7375 6270 726f 6365 7373 2e72 756e 285b  subprocess.run([
+0000da60: 2777 6869 6368 272c 2027 6e76 6964 6961  'which', 'nvidia
+0000da70: 2d73 6d69 275d 2c0a 2020 2020 2020 2020  -smi'],.        
 0000da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da90: 2020 2020 2020 2020 2020 2020 2073 7464               std
-0000daa0: 6572 723d 7375 6270 726f 6365 7373 2e44  err=subprocess.D
-0000dab0: 4556 4e55 4c4c 2c0a 2020 2020 2020 2020  EVNULL,.        
+0000da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000daa0: 7374 646f 7574 3d73 7562 7072 6f63 6573  stdout=subproces
+0000dab0: 732e 4445 564e 554c 4c2c 0a20 2020 2020  s.DEVNULL,.     
 0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dae0: 2063 6865 636b 3d46 616c 7365 290a 2020   check=False).  
-0000daf0: 2020 2020 2020 6973 5f66 756e 6374 696f        is_functio
-0000db00: 6e61 6c20 3d20 6578 6563 7574 696f 6e5f  nal = execution_
-0000db10: 6368 6563 6b2e 7265 7475 726e 636f 6465  check.returncode
-0000db20: 203d 3d20 300a 2020 2020 7265 7475 726e   == 0.    return
-0000db30: 2069 735f 6675 6e63 7469 6f6e 616c 0a0a   is_functional..
-0000db40: 0a64 6566 2067 656e 6572 6174 655f 636c  .def generate_cl
-0000db50: 7573 7465 725f 6e61 6d65 2829 3a0a 2020  uster_name():.  
-0000db60: 2020 2320 544f 444f 3a20 6368 616e 6765    # TODO: change
-0000db70: 2074 6869 7320 4944 2066 6f72 6d61 7474   this ID formatt
-0000db80: 696e 6720 746f 2073 6f6d 6574 6869 6e67  ing to something
-0000db90: 206d 6f72 6520 706c 6561 7361 6e74 2e0a   more pleasant..
-0000dba0: 2020 2020 2320 5573 6572 206e 616d 6520      # User name 
-0000dbb0: 6973 2068 656c 7066 756c 2069 6e20 6e6f  is helpful in no
-0000dbc0: 6e2d 6973 6f6c 6174 6564 2061 6363 6f75  n-isolated accou
-0000dbd0: 6e74 732c 2065 2e67 2e2c 2047 4350 2c20  nts, e.g., GCP, 
-0000dbe0: 417a 7572 652e 0a20 2020 2072 6574 7572  Azure..    retur
-0000dbf0: 6e20 6627 736b 792d 7b75 7569 642e 7575  n f'sky-{uuid.uu
-0000dc00: 6964 3428 292e 6865 785b 3a34 5d7d 2d7b  id4().hex[:4]}-{
-0000dc10: 636f 6d6d 6f6e 5f75 7469 6c73 2e67 6574  common_utils.get
-0000dc20: 5f63 6c65 616e 6564 5f75 7365 726e 616d  _cleaned_usernam
-0000dc30: 6528 297d 270a 0a0a 6465 6620 5f71 7565  e()}'...def _que
-0000dc40: 7279 5f68 6561 645f 6970 5f77 6974 685f  ry_head_ip_with_
-0000dc50: 7265 7472 6965 7328 636c 7573 7465 725f  retries(cluster_
-0000dc60: 7961 6d6c 3a20 7374 722c 0a20 2020 2020  yaml: str,.     
-0000dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc80: 2020 2020 2020 2020 2020 206d 6178 5f61             max_a
-0000dc90: 7474 656d 7074 733a 2069 6e74 203d 2031  ttempts: int = 1
-0000dca0: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
-0000dcb0: 2252 6574 7572 6e73 2074 6865 2049 5020  "Returns the IP 
-0000dcc0: 6f66 2074 6865 2068 6561 6420 6e6f 6465  of the head node
-0000dcd0: 2062 7920 7175 6572 7969 6e67 2074 6865   by querying the
-0000dce0: 2063 6c6f 7564 2e0a 0a20 2020 2052 6169   cloud...    Rai
-0000dcf0: 7365 733a 0a20 2020 2020 2065 7863 6570  ses:.      excep
-0000dd00: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-0000dd10: 6f72 3a20 6966 2077 6520 6661 696c 6564  or: if we failed
-0000dd20: 2074 6f20 6765 7420 7468 6520 6865 6164   to get the head
-0000dd30: 2049 502e 0a20 2020 2022 2222 0a20 2020   IP..    """.   
-0000dd40: 2062 6163 6b6f 6666 203d 2063 6f6d 6d6f   backoff = commo
-0000dd50: 6e5f 7574 696c 732e 4261 636b 6f66 6628  n_utils.Backoff(
-0000dd60: 696e 6974 6961 6c5f 6261 636b 6f66 663d  initial_backoff=
-0000dd70: 352c 206d 6178 5f62 6163 6b6f 6666 5f66  5, max_backoff_f
-0000dd80: 6163 746f 723d 3529 0a20 2020 2066 6f72  actor=5).    for
-0000dd90: 2069 2069 6e20 7261 6e67 6528 6d61 785f   i in range(max_
-0000dda0: 6174 7465 6d70 7473 293a 0a20 2020 2020  attempts):.     
-0000ddb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000ddc0: 2020 2020 6675 6c6c 5f63 6c75 7374 6572      full_cluster
-0000ddd0: 5f79 616d 6c20 3d20 7374 7228 7061 7468  _yaml = str(path
-0000dde0: 6c69 622e 5061 7468 2863 6c75 7374 6572  lib.Path(cluster
-0000ddf0: 5f79 616d 6c29 2e65 7870 616e 6475 7365  _yaml).expanduse
-0000de00: 7228 2929 0a20 2020 2020 2020 2020 2020  r()).           
-0000de10: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-0000de20: 735f 7574 696c 732e 7275 6e28 0a20 2020  s_utils.run(.   
-0000de30: 2020 2020 2020 2020 2020 2020 2066 2772               f'r
-0000de40: 6179 2067 6574 2d68 6561 642d 6970 207b  ay get-head-ip {
-0000de50: 6675 6c6c 5f63 6c75 7374 6572 5f79 616d  full_cluster_yam
-0000de60: 6c21 727d 272c 0a20 2020 2020 2020 2020  l!r}',.         
-0000de70: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
-0000de80: 6270 726f 6365 7373 2e50 4950 452c 0a20  bprocess.PIPE,. 
-0000de90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000dea0: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
-0000deb0: 2e44 4556 4e55 4c4c 292e 7374 646f 7574  .DEVNULL).stdout
-0000dec0: 2e64 6563 6f64 6528 292e 7374 7269 7028  .decode().strip(
-0000ded0: 290a 2020 2020 2020 2020 2020 2020 6865  ).            he
-0000dee0: 6164 5f69 705f 6c69 7374 203d 2072 652e  ad_ip_list = re.
-0000def0: 6669 6e64 616c 6c28 4950 5f41 4444 525f  findall(IP_ADDR_
-0000df00: 5245 4745 582c 206f 7574 290a 2020 2020  REGEX, out).    
-0000df10: 2020 2020 2020 2020 6966 206c 656e 2868          if len(h
-0000df20: 6561 645f 6970 5f6c 6973 7429 203e 2031  ead_ip_list) > 1
-0000df30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000df40: 2020 2320 5468 6973 2063 6f75 6c64 2062    # This could b
-0000df50: 6520 7472 6967 6765 7265 6420 6966 2065  e triggered if e
-0000df60: 2e67 2e2c 2073 6f6d 6520 6c6f 6767 696e  .g., some loggin
-0000df70: 6720 6973 2061 6464 6564 2069 6e0a 2020  g is added in.  
-0000df80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000df90: 736b 7970 696c 6f74 5f63 6f6e 6669 672c  skypilot_config,
-0000dfa0: 2061 206d 6f64 756c 6520 7468 6174 2068   a module that h
-0000dfb0: 6173 2073 6f6d 6520 636f 6465 2065 7865  as some code exe
-0000dfc0: 6375 7465 640a 2020 2020 2020 2020 2020  cuted.          
-0000dfd0: 2020 2020 2020 2320 7768 656e 6576 6572        # whenever
-0000dfe0: 2060 736b 7960 2069 7320 696d 706f 7274   `sky` is import
-0000dff0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0000e000: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-0000e010: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-0000e020: 2020 2020 2020 2020 2744 6574 6563 7465          'Detecte
-0000e030: 6420 6d6f 7265 2074 6861 6e20 3120 4950  d more than 1 IP
-0000e040: 2066 726f 6d20 7468 6520 6f75 7470 7574   from the output
-0000e050: 206f 6620 270a 2020 2020 2020 2020 2020   of '.          
-0000e060: 2020 2020 2020 2020 2020 2774 6865 2060            'the `
-0000e070: 7261 7920 6765 742d 6865 6164 2d69 7060  ray get-head-ip`
-0000e080: 2063 6f6d 6d61 6e64 2e20 5468 6973 2063   command. This c
-0000e090: 6f75 6c64 2027 0a20 2020 2020 2020 2020  ould '.         
-0000e0a0: 2020 2020 2020 2020 2020 2027 6861 7070             'happ
-0000e0b0: 656e 2069 6620 7468 6572 6520 6973 2065  en if there is e
-0000e0c0: 7874 7261 206f 7574 7075 7420 6672 6f6d  xtra output from
-0000e0d0: 2069 742c 2027 0a20 2020 2020 2020 2020   it, '.         
-0000e0e0: 2020 2020 2020 2020 2020 2027 7768 6963             'whic
-0000e0f0: 6820 7368 6f75 6c64 2062 6520 696e 7370  h should be insp
-0000e100: 6563 7465 6420 6265 6c6f 772e 5c6e 5072  ected below.\nPr
-0000e110: 6f63 6565 6469 6e67 2077 6974 6820 270a  oceeding with '.
-0000e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e130: 2020 2020 6627 7468 6520 6c61 7374 2064      f'the last d
-0000e140: 6574 6563 7465 6420 4950 2028 7b68 6561  etected IP ({hea
-0000e150: 645f 6970 5f6c 6973 745b 2d31 5d7d 2920  d_ip_list[-1]}) 
-0000e160: 6173 2068 6561 6420 4950 2e27 0a20 2020  as head IP.'.   
-0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e180: 2066 275c 6e3d 3d20 4f75 7470 7574 203d   f'\n== Output =
-0000e190: 3d5c 6e7b 6f75 747d 270a 2020 2020 2020  =\n{out}'.      
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000e1b0: 5c6e 3d3d 204f 7574 7075 7420 656e 6473  \n== Output ends
-0000e1c0: 203d 3d27 290a 2020 2020 2020 2020 2020   ==').          
-0000e1d0: 2020 2020 2020 6865 6164 5f69 705f 6c69        head_ip_li
-0000e1e0: 7374 203d 2068 6561 645f 6970 5f6c 6973  st = head_ip_lis
-0000e1f0: 745b 2d31 3a5d 0a20 2020 2020 2020 2020  t[-1:].         
-0000e200: 2020 2061 7373 6572 7420 3120 3d3d 206c     assert 1 == l
-0000e210: 656e 2868 6561 645f 6970 5f6c 6973 7429  en(head_ip_list)
-0000e220: 2c20 286f 7574 2c20 6865 6164 5f69 705f  , (out, head_ip_
-0000e230: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
-0000e240: 2020 6865 6164 5f69 7020 3d20 6865 6164    head_ip = head
-0000e250: 5f69 705f 6c69 7374 5b30 5d0a 2020 2020  _ip_list[0].    
-0000e260: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
-0000e270: 2020 2020 2020 6578 6365 7074 2073 7562        except sub
-0000e280: 7072 6f63 6573 732e 4361 6c6c 6564 5072  process.CalledPr
-0000e290: 6f63 6573 7345 7272 6f72 2061 7320 653a  ocessError as e:
-0000e2a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000e2b0: 6920 3d3d 206d 6178 5f61 7474 656d 7074  i == max_attempt
-0000e2c0: 7320 2d20 313a 0a20 2020 2020 2020 2020  s - 1:.         
-0000e2d0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-0000e2e0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
-0000e2f0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000e300: 2020 2020 2020 2020 2020 7265 6173 6f6e            reason
-0000e310: 3d65 7863 6570 7469 6f6e 732e 4665 7463  =exceptions.Fetc
-0000e320: 6849 5045 7272 6f72 2e52 6561 736f 6e2e  hIPError.Reason.
-0000e330: 4845 4144 2920 6672 6f6d 2065 0a20 2020  HEAD) from e.   
-0000e340: 2020 2020 2020 2020 2023 2052 6574 7279           # Retry
-0000e350: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
-0000e360: 6973 206e 6f74 2075 7020 7965 742e 0a20  is not up yet.. 
-0000e370: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000e380: 722e 6465 6275 6728 2752 6574 7279 696e  r.debug('Retryin
-0000e390: 6720 746f 2067 6574 2068 6561 6420 6970  g to get head ip
-0000e3a0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0000e3b0: 7469 6d65 2e73 6c65 6570 2862 6163 6b6f  time.sleep(backo
-0000e3c0: 6666 2e63 7572 7265 6e74 5f62 6163 6b6f  ff.current_backo
-0000e3d0: 6666 2829 290a 2020 2020 7265 7475 726e  ff()).    return
-0000e3e0: 2068 6561 645f 6970 0a0a 0a40 7469 6d65   head_ip...@time
-0000e3f0: 6c69 6e65 2e65 7665 6e74 0a64 6566 2067  line.event.def g
-0000e400: 6574 5f6e 6f64 655f 6970 7328 636c 7573  et_node_ips(clus
-0000e410: 7465 725f 7961 6d6c 3a20 7374 722c 0a20  ter_yaml: str,. 
-0000e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e430: 6578 7065 6374 6564 5f6e 756d 5f6e 6f64  expected_num_nod
-0000e440: 6573 3a20 696e 742c 0a20 2020 2020 2020  es: int,.       
-0000e450: 2020 2020 2020 2020 2020 6865 6164 5f69            head_i
-0000e460: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
-0000e470: 696e 7420 3d20 312c 0a20 2020 2020 2020  int = 1,.       
-0000e480: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0000e490: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
-0000e4a0: 3a20 696e 7420 3d20 312c 0a20 2020 2020  : int = 1,.     
-0000e4b0: 2020 2020 2020 2020 2020 2020 6765 745f              get_
-0000e4c0: 696e 7465 726e 616c 5f69 7073 3a20 626f  internal_ips: bo
-0000e4d0: 6f6c 203d 2046 616c 7365 2920 2d3e 204c  ol = False) -> L
-0000e4e0: 6973 745b 7374 725d 3a0a 2020 2020 2222  ist[str]:.    ""
-0000e4f0: 2252 6574 7572 6e73 2074 6865 2049 5073  "Returns the IPs
-0000e500: 206f 6620 616c 6c20 6e6f 6465 7320 696e   of all nodes in
-0000e510: 2074 6865 2063 6c75 7374 6572 2c20 7769   the cluster, wi
-0000e520: 7468 2068 6561 6420 6e6f 6465 2061 7420  th head node at 
-0000e530: 6672 6f6e 742e 0a0a 2020 2020 4172 6773  front...    Args
-0000e540: 3a0a 2020 2020 2020 2020 636c 7573 7465  :.        cluste
-0000e550: 725f 7961 6d6c 3a20 5061 7468 2074 6f20  r_yaml: Path to 
-0000e560: 7468 6520 636c 7573 7465 7220 7961 6d6c  the cluster yaml
-0000e570: 2e0a 2020 2020 2020 2020 6578 7065 6374  ..        expect
-0000e580: 6564 5f6e 756d 5f6e 6f64 6573 3a20 4578  ed_num_nodes: Ex
-0000e590: 7065 6374 6564 206e 756d 6265 7220 6f66  pected number of
-0000e5a0: 206e 6f64 6573 2069 6e20 7468 6520 636c   nodes in the cl
-0000e5b0: 7573 7465 722e 0a20 2020 2020 2020 2068  uster..        h
-0000e5c0: 6561 645f 6970 5f6d 6178 5f61 7474 656d  ead_ip_max_attem
-0000e5d0: 7074 733a 204d 6178 2061 7474 656d 7074  pts: Max attempt
-0000e5e0: 7320 746f 2067 6574 2068 6561 6420 6970  s to get head ip
-0000e5f0: 2e0a 2020 2020 2020 2020 776f 726b 6572  ..        worker
-0000e600: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
-0000e610: 3a20 4d61 7820 6174 7465 6d70 7473 2074  : Max attempts t
-0000e620: 6f20 6765 7420 776f 726b 6572 2069 7073  o get worker ips
-0000e630: 2e0a 2020 2020 2020 2020 6765 745f 696e  ..        get_in
-0000e640: 7465 726e 616c 5f69 7073 3a20 5768 6574  ternal_ips: Whet
-0000e650: 6865 7220 746f 2067 6574 2069 6e74 6572  her to get inter
-0000e660: 6e61 6c20 4950 732e 2057 6865 6e20 4661  nal IPs. When Fa
-0000e670: 6c73 652c 2069 7420 6973 2073 7469 6c6c  lse, it is still
-0000e680: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
-0000e690: 7369 626c 6520 746f 2067 6574 2069 6e74  sible to get int
-0000e6a0: 6572 6e61 6c20 4950 7320 6966 2074 6865  ernal IPs if the
-0000e6b0: 2063 6c75 7374 6572 2064 6f65 7320 6e6f   cluster does no
-0000e6c0: 7420 6861 7665 2065 7874 6572 6e61 6c0a  t have external.
-0000e6d0: 2020 2020 2020 2020 2020 2020 4950 732e              IPs.
-0000e6e0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-0000e6f0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-0000e700: 2e46 6574 6368 4950 4572 726f 723a 2069  .FetchIPError: i
-0000e710: 6620 7765 2066 6169 6c65 6420 746f 2067  f we failed to g
-0000e720: 6574 2074 6865 2049 5073 2e20 652e 7265  et the IPs. e.re
-0000e730: 6173 6f6e 2069 730a 2020 2020 2020 2020  ason is.        
-0000e740: 2020 2020 4845 4144 206f 7220 574f 524b      HEAD or WORK
-0000e750: 4552 2e0a 2020 2020 2222 220a 2020 2020  ER..    """.    
-0000e760: 7261 795f 636f 6e66 6967 203d 2063 6f6d  ray_config = com
-0000e770: 6d6f 6e5f 7574 696c 732e 7265 6164 5f79  mon_utils.read_y
-0000e780: 616d 6c28 636c 7573 7465 725f 7961 6d6c  aml(cluster_yaml
-0000e790: 290a 2020 2020 2320 5573 6520 7468 6520  ).    # Use the 
-0000e7a0: 6e65 7720 7072 6f76 6973 696f 6e65 7220  new provisioner 
-0000e7b0: 666f 7220 4157 532e 0a20 2020 2070 726f  for AWS..    pro
-0000e7c0: 7669 6465 725f 6e61 6d65 203d 2063 6c75  vider_name = clu
-0000e7d0: 7374 6572 5f79 616d 6c5f 7574 696c 732e  ster_yaml_utils.
-0000e7e0: 6765 745f 7072 6f76 6964 6572 5f6e 616d  get_provider_nam
-0000e7f0: 6528 7261 795f 636f 6e66 6967 290a 2020  e(ray_config).  
-0000e800: 2020 636c 6f75 6420 3d20 636c 6f75 645f    cloud = cloud_
-0000e810: 7265 6769 7374 7279 2e43 4c4f 5544 5f52  registry.CLOUD_R
-0000e820: 4547 4953 5452 592e 6672 6f6d 5f73 7472  EGISTRY.from_str
-0000e830: 2870 726f 7669 6465 725f 6e61 6d65 290a  (provider_name).
-0000e840: 2020 2020 6173 7365 7274 2063 6c6f 7564      assert cloud
-0000e850: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7072   is not None, pr
-0000e860: 6f76 6964 6572 5f6e 616d 650a 0a20 2020  ovider_name..   
-0000e870: 2069 6620 636c 6f75 642e 5052 4f56 4953   if cloud.PROVIS
-0000e880: 494f 4e45 525f 5645 5253 494f 4e20 3e3d  IONER_VERSION >=
-0000e890: 2063 6c6f 7564 732e 5072 6f76 6973 696f   clouds.Provisio
-0000e8a0: 6e65 7256 6572 7369 6f6e 2e53 4b59 5049  nerVersion.SKYPI
-0000e8b0: 4c4f 543a 0a20 2020 2020 2020 2074 7279  LOT:.        try
-0000e8c0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-0000e8d0: 7461 6461 7461 203d 2070 726f 7669 7369  tadata = provisi
-0000e8e0: 6f6e 5f6c 6962 2e67 6574 5f63 6c75 7374  on_lib.get_clust
-0000e8f0: 6572 5f69 6e66 6f28 0a20 2020 2020 2020  er_info(.       
-0000e900: 2020 2020 2020 2020 2070 726f 7669 6465           provide
-0000e910: 725f 6e61 6d65 2c20 7261 795f 636f 6e66  r_name, ray_conf
-0000e920: 6967 5b27 7072 6f76 6964 6572 275d 2e67  ig['provider'].g
-0000e930: 6574 2827 7265 6769 6f6e 2729 2c0a 2020  et('region'),.  
-0000e940: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000e950: 795f 636f 6e66 6967 5b27 636c 7573 7465  y_config['cluste
-0000e960: 725f 6e61 6d65 275d 2c20 7261 795f 636f  r_name'], ray_co
-0000e970: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
-0000e980: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-0000e990: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0000e9a0: 2020 2320 7079 6c69 6e74 3a20 6469 7361    # pylint: disa
-0000e9b0: 626c 653d 6272 6f61 642d 6578 6365 7074  ble=broad-except
-0000e9c0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0000e9d0: 6869 7320 636f 756c 6420 6861 7070 656e  his could happen
-0000e9e0: 2077 6865 6e20 7468 6520 564d 2069 7320   when the VM is 
-0000e9f0: 6e6f 7420 6675 6c6c 7920 6c61 756e 6368  not fully launch
-0000ea00: 6564 2c20 616e 6420 6120 7573 6572 0a20  ed, and a user. 
-0000ea10: 2020 2020 2020 2020 2020 2023 2069 7320             # is 
-0000ea20: 7472 7969 6e67 2074 6f20 7465 726d 696e  trying to termin
-0000ea30: 6174 6520 6974 2077 6974 6820 6073 6b79  ate it with `sky
-0000ea40: 2064 6f77 6e60 2e0a 2020 2020 2020 2020   down`..        
-0000ea50: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0000ea60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ea70: 2020 2746 6169 6c65 6420 746f 2067 6574    'Failed to get
-0000ea80: 2063 6c75 7374 6572 2069 6e66 6f20 666f   cluster info fo
-0000ea90: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-0000eaa0: 2020 2020 6627 7b72 6179 5f63 6f6e 6669      f'{ray_confi
-0000eab0: 675b 2263 6c75 7374 6572 5f6e 616d 6522  g["cluster_name"
-0000eac0: 5d7d 2066 726f 6d20 7468 6520 6e65 7720  ]} from the new 
-0000ead0: 7072 6f76 6973 696f 6e65 7220 270a 2020  provisioner '.  
-0000eae0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000eaf0: 7769 7468 207b 636f 6d6d 6f6e 5f75 7469  with {common_uti
-0000eb00: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
-0000eb10: 696f 6e28 6529 7d2e 2729 0a20 2020 2020  ion(e)}.').     
-0000eb20: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-0000eb30: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
-0000eb40: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000eb50: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-0000eb60: 2e46 6574 6368 4950 4572 726f 722e 5265  .FetchIPError.Re
-0000eb70: 6173 6f6e 2e48 4541 4429 2066 726f 6d20  ason.HEAD) from 
-0000eb80: 650a 2020 2020 2020 2020 6966 206c 656e  e.        if len
-0000eb90: 286d 6574 6164 6174 612e 696e 7374 616e  (metadata.instan
-0000eba0: 6365 7329 203c 2065 7870 6563 7465 645f  ces) < expected_
-0000ebb0: 6e75 6d5f 6e6f 6465 733a 0a20 2020 2020  num_nodes:.     
-0000ebc0: 2020 2020 2020 2023 2053 696d 756c 6174         # Simulat
-0000ebd0: 6520 7468 6520 6578 6365 7074 696f 6e20  e the exception 
-0000ebe0: 7768 656e 2052 6179 2068 6561 6420 6e6f  when Ray head no
-0000ebf0: 6465 2069 7320 6e6f 7420 7570 2e0a 2020  de is not up..  
-0000ec00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000ec10: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
-0000ec20: 4950 4572 726f 7228 6578 6365 7074 696f  IPError(exceptio
-0000ec30: 6e73 2e46 6574 6368 4950 4572 726f 722e  ns.FetchIPError.
-0000ec40: 5265 6173 6f6e 2e48 4541 4429 0a20 2020  Reason.HEAD).   
-0000ec50: 2020 2020 2072 6574 7572 6e20 6d65 7461       return meta
-0000ec60: 6461 7461 2e67 6574 5f66 6561 7369 626c  data.get_feasibl
-0000ec70: 655f 6970 7328 6765 745f 696e 7465 726e  e_ips(get_intern
-0000ec80: 616c 5f69 7073 290a 0a20 2020 2069 6620  al_ips)..    if 
-0000ec90: 6765 745f 696e 7465 726e 616c 5f69 7073  get_internal_ips
-0000eca0: 3a0a 2020 2020 2020 2020 7769 7468 2074  :.        with t
-0000ecb0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-0000ecc0: 706f 7261 7279 4669 6c65 286d 6f64 653d  poraryFile(mode=
-0000ecd0: 2777 272c 2064 656c 6574 653d 4661 6c73  'w', delete=Fals
-0000ece0: 6529 2061 7320 663a 0a20 2020 2020 2020  e) as f:.       
-0000ecf0: 2020 2020 2072 6179 5f63 6f6e 6669 675b       ray_config[
-0000ed00: 2770 726f 7669 6465 7227 5d5b 2775 7365  'provider']['use
-0000ed10: 5f69 6e74 6572 6e61 6c5f 6970 7327 5d20  _internal_ips'] 
-0000ed20: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0000ed30: 2020 2079 616d 6c2e 6475 6d70 2872 6179     yaml.dump(ray
-0000ed40: 5f63 6f6e 6669 672c 2066 290a 2020 2020  _config, f).    
-0000ed50: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-0000ed60: 7961 6d6c 203d 2066 2e6e 616d 650a 0a20  yaml = f.name.. 
-0000ed70: 2020 2023 2043 6865 636b 2074 6865 206e     # Check the n
-0000ed80: 6574 776f 726b 2063 6f6e 6e65 6374 696f  etwork connectio
-0000ed90: 6e20 6669 7273 7420 746f 2061 766f 6964  n first to avoid
-0000eda0: 206c 6f6e 6720 6861 6e67 696e 6720 7469   long hanging ti
-0000edb0: 6d65 2066 6f72 0a20 2020 2023 2072 6179  me for.    # ray
-0000edc0: 2067 6574 2d68 6561 642d 6970 2062 656c   get-head-ip bel
-0000edd0: 6f77 2c20 6966 2061 206c 6f6e 672d 6c61  ow, if a long-la
-0000ede0: 7374 696e 6720 6e65 7477 6f72 6b20 636f  sting network co
-0000edf0: 6e6e 6563 7469 6f6e 2066 6169 6c75 7265  nnection failure
-0000ee00: 0a20 2020 2023 2068 6170 7065 6e73 2e0a  .    # happens..
-0000ee10: 2020 2020 6368 6563 6b5f 6e65 7477 6f72      check_networ
-0000ee20: 6b5f 636f 6e6e 6563 7469 6f6e 2829 0a20  k_connection(). 
-0000ee30: 2020 2068 6561 645f 6970 203d 205f 7175     head_ip = _qu
-0000ee40: 6572 795f 6865 6164 5f69 705f 7769 7468  ery_head_ip_with
-0000ee50: 5f72 6574 7269 6573 2863 6c75 7374 6572  _retries(cluster
-0000ee60: 5f79 616d 6c2c 0a20 2020 2020 2020 2020  _yaml,.         
-0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee90: 206d 6178 5f61 7474 656d 7074 733d 6865   max_attempts=he
-0000eea0: 6164 5f69 705f 6d61 785f 6174 7465 6d70  ad_ip_max_attemp
-0000eeb0: 7473 290a 2020 2020 6865 6164 5f69 705f  ts).    head_ip_
-0000eec0: 6c69 7374 203d 205b 6865 6164 5f69 705d  list = [head_ip]
-0000eed0: 0a20 2020 2069 6620 6578 7065 6374 6564  .    if expected
-0000eee0: 5f6e 756d 5f6e 6f64 6573 203e 2031 3a0a  _num_nodes > 1:.
-0000eef0: 2020 2020 2020 2020 6261 636b 6f66 6620          backoff 
-0000ef00: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e42  = common_utils.B
-0000ef10: 6163 6b6f 6666 2869 6e69 7469 616c 5f62  ackoff(initial_b
-0000ef20: 6163 6b6f 6666 3d35 2c20 6d61 785f 6261  ackoff=5, max_ba
-0000ef30: 636b 6f66 665f 6661 6374 6f72 3d35 290a  ckoff_factor=5).
-0000ef40: 0a20 2020 2020 2020 2066 6f72 2072 6574  .        for ret
-0000ef50: 7279 5f63 6e74 2069 6e20 7261 6e67 6528  ry_cnt in range(
-0000ef60: 776f 726b 6572 5f69 705f 6d61 785f 6174  worker_ip_max_at
-0000ef70: 7465 6d70 7473 293a 0a20 2020 2020 2020  tempts):.       
-0000ef80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000ef90: 2020 2020 2020 2020 2020 6675 6c6c 5f63            full_c
-0000efa0: 6c75 7374 6572 5f79 616d 6c20 3d20 7374  luster_yaml = st
-0000efb0: 7228 7061 7468 6c69 622e 5061 7468 2863  r(pathlib.Path(c
-0000efc0: 6c75 7374 6572 5f79 616d 6c29 2e65 7870  luster_yaml).exp
-0000efd0: 616e 6475 7365 7228 2929 0a20 2020 2020  anduser()).     
-0000efe0: 2020 2020 2020 2020 2020 2070 726f 6320             proc 
-0000eff0: 3d20 7375 6270 726f 6365 7373 5f75 7469  = subprocess_uti
-0000f000: 6c73 2e72 756e 280a 2020 2020 2020 2020  ls.run(.        
-0000f010: 2020 2020 2020 2020 2020 2020 6627 7261              f'ra
-0000f020: 7920 6765 742d 776f 726b 6572 2d69 7073  y get-worker-ips
-0000f030: 207b 6675 6c6c 5f63 6c75 7374 6572 5f79   {full_cluster_y
-0000f040: 616d 6c21 727d 272c 0a20 2020 2020 2020  aml!r}',.       
-0000f050: 2020 2020 2020 2020 2020 2020 2073 7464               std
-0000f060: 6f75 743d 7375 6270 726f 6365 7373 2e50  out=subprocess.P
-0000f070: 4950 452c 0a20 2020 2020 2020 2020 2020  IPE,.           
-0000f080: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
-0000f090: 7375 6270 726f 6365 7373 2e50 4950 4529  subprocess.PIPE)
-0000f0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f0b0: 206f 7574 203d 2070 726f 632e 7374 646f   out = proc.stdo
-0000f0c0: 7574 2e64 6563 6f64 6528 290a 2020 2020  ut.decode().    
-0000f0d0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0000f0e0: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
-0000f0f0: 6365 7074 2073 7562 7072 6f63 6573 732e  cept subprocess.
-0000f100: 4361 6c6c 6564 5072 6f63 6573 7345 7272  CalledProcessErr
-0000f110: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-0000f120: 2020 2020 2020 2020 2069 6620 7265 7472           if retr
-0000f130: 795f 636e 7420 3d3d 2077 6f72 6b65 725f  y_cnt == worker_
-0000f140: 6970 5f6d 6178 5f61 7474 656d 7074 7320  ip_max_attempts 
-0000f150: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
-0000f160: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-0000f170: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000f180: 5045 7272 6f72 280a 2020 2020 2020 2020  PError(.        
+0000dae0: 2020 2073 7464 6572 723d 7375 6270 726f     stderr=subpro
+0000daf0: 6365 7373 2e44 4556 4e55 4c4c 2c0a 2020  cess.DEVNULL,.  
+0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db20: 2020 2020 2020 6368 6563 6b3d 4661 6c73        check=Fals
+0000db30: 6529 0a20 2020 2069 735f 696e 7374 616c  e).    is_instal
+0000db40: 6c65 6420 3d20 696e 7374 616c 6c61 7469  led = installati
+0000db50: 6f6e 5f63 6865 636b 2e72 6574 7572 6e63  on_check.returnc
+0000db60: 6f64 6520 3d3d 2030 0a20 2020 2069 6620  ode == 0.    if 
+0000db70: 6973 5f69 6e73 7461 6c6c 6564 3a0a 2020  is_installed:.  
+0000db80: 2020 2020 2020 6578 6563 7574 696f 6e5f        execution_
+0000db90: 6368 6563 6b20 3d20 7375 6270 726f 6365  check = subproce
+0000dba0: 7373 2e72 756e 285b 276e 7669 6469 612d  ss.run(['nvidia-
+0000dbb0: 736d 6927 5d2c 0a20 2020 2020 2020 2020  smi'],.         
+0000dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbe0: 7374 646f 7574 3d73 7562 7072 6f63 6573  stdout=subproces
+0000dbf0: 732e 4445 564e 554c 4c2c 0a20 2020 2020  s.DEVNULL,.     
+0000dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc20: 2020 2020 7374 6465 7272 3d73 7562 7072      stderr=subpr
+0000dc30: 6f63 6573 732e 4445 564e 554c 4c2c 0a20  ocess.DEVNULL,. 
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc60: 2020 2020 2020 2020 6368 6563 6b3d 4661          check=Fa
+0000dc70: 6c73 6529 0a20 2020 2020 2020 2069 735f  lse).        is_
+0000dc80: 6675 6e63 7469 6f6e 616c 203d 2065 7865  functional = exe
+0000dc90: 6375 7469 6f6e 5f63 6865 636b 2e72 6574  cution_check.ret
+0000dca0: 7572 6e63 6f64 6520 3d3d 2030 0a20 2020  urncode == 0.   
+0000dcb0: 2072 6574 7572 6e20 6973 5f66 756e 6374   return is_funct
+0000dcc0: 696f 6e61 6c0a 0a0a 6465 6620 6765 6e65  ional...def gene
+0000dcd0: 7261 7465 5f63 6c75 7374 6572 5f6e 616d  rate_cluster_nam
+0000dce0: 6528 293a 0a20 2020 2023 2054 4f44 4f3a  e():.    # TODO:
+0000dcf0: 2063 6861 6e67 6520 7468 6973 2049 4420   change this ID 
+0000dd00: 666f 726d 6174 7469 6e67 2074 6f20 736f  formatting to so
+0000dd10: 6d65 7468 696e 6720 6d6f 7265 2070 6c65  mething more ple
+0000dd20: 6173 616e 742e 0a20 2020 2023 2055 7365  asant..    # Use
+0000dd30: 7220 6e61 6d65 2069 7320 6865 6c70 6675  r name is helpfu
+0000dd40: 6c20 696e 206e 6f6e 2d69 736f 6c61 7465  l in non-isolate
+0000dd50: 6420 6163 636f 756e 7473 2c20 652e 672e  d accounts, e.g.
+0000dd60: 2c20 4743 502c 2041 7a75 7265 2e0a 2020  , GCP, Azure..  
+0000dd70: 2020 7265 7475 726e 2066 2773 6b79 2d7b    return f'sky-{
+0000dd80: 7575 6964 2e75 7569 6434 2829 2e68 6578  uuid.uuid4().hex
+0000dd90: 5b3a 345d 7d2d 7b63 6f6d 6d6f 6e5f 7574  [:4]}-{common_ut
+0000dda0: 696c 732e 6765 745f 636c 6561 6e65 645f  ils.get_cleaned_
+0000ddb0: 7573 6572 6e61 6d65 2829 7d27 0a0a 0a64  username()}'...d
+0000ddc0: 6566 205f 7175 6572 795f 6865 6164 5f69  ef _query_head_i
+0000ddd0: 705f 7769 7468 5f72 6574 7269 6573 2863  p_with_retries(c
+0000dde0: 6c75 7374 6572 5f79 616d 6c3a 2073 7472  luster_yaml: str
+0000ddf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de10: 2020 6d61 785f 6174 7465 6d70 7473 3a20    max_attempts: 
+0000de20: 696e 7420 3d20 3129 202d 3e20 7374 723a  int = 1) -> str:
+0000de30: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+0000de40: 7468 6520 4950 206f 6620 7468 6520 6865  the IP of the he
+0000de50: 6164 206e 6f64 6520 6279 2071 7565 7279  ad node by query
+0000de60: 696e 6720 7468 6520 636c 6f75 642e 0a0a  ing the cloud...
+0000de70: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000de80: 2020 6578 6365 7074 696f 6e73 2e46 6574    exceptions.Fet
+0000de90: 6368 4950 4572 726f 723a 2069 6620 7765  chIPError: if we
+0000dea0: 2066 6169 6c65 6420 746f 2067 6574 2074   failed to get t
+0000deb0: 6865 2068 6561 6420 4950 2e0a 2020 2020  he head IP..    
+0000dec0: 2222 220a 2020 2020 6261 636b 6f66 6620  """.    backoff 
+0000ded0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e42  = common_utils.B
+0000dee0: 6163 6b6f 6666 2869 6e69 7469 616c 5f62  ackoff(initial_b
+0000def0: 6163 6b6f 6666 3d35 2c20 6d61 785f 6261  ackoff=5, max_ba
+0000df00: 636b 6f66 665f 6661 6374 6f72 3d35 290a  ckoff_factor=5).
+0000df10: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000df20: 6765 286d 6178 5f61 7474 656d 7074 7329  ge(max_attempts)
+0000df30: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+0000df40: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+0000df50: 636c 7573 7465 725f 7961 6d6c 203d 2073  cluster_yaml = s
+0000df60: 7472 2870 6174 686c 6962 2e50 6174 6828  tr(pathlib.Path(
+0000df70: 636c 7573 7465 725f 7961 6d6c 292e 6578  cluster_yaml).ex
+0000df80: 7061 6e64 7573 6572 2829 290a 2020 2020  panduser()).    
+0000df90: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+0000dfa0: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
+0000dfb0: 756e 280a 2020 2020 2020 2020 2020 2020  un(.            
+0000dfc0: 2020 2020 6627 7261 7920 6765 742d 6865      f'ray get-he
+0000dfd0: 6164 2d69 7020 7b66 756c 6c5f 636c 7573  ad-ip {full_clus
+0000dfe0: 7465 725f 7961 6d6c 2172 7d27 2c0a 2020  ter_yaml!r}',.  
+0000dff0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0000e000: 646f 7574 3d73 7562 7072 6f63 6573 732e  dout=subprocess.
+0000e010: 5049 5045 2c0a 2020 2020 2020 2020 2020  PIPE,.          
+0000e020: 2020 2020 2020 7374 6465 7272 3d73 7562        stderr=sub
+0000e030: 7072 6f63 6573 732e 4445 564e 554c 4c29  process.DEVNULL)
+0000e040: 2e73 7464 6f75 742e 6465 636f 6465 2829  .stdout.decode()
+0000e050: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+0000e060: 2020 2020 2068 6561 645f 6970 5f6c 6973       head_ip_lis
+0000e070: 7420 3d20 7265 2e66 696e 6461 6c6c 2849  t = re.findall(I
+0000e080: 505f 4144 4452 5f52 4547 4558 2c20 6f75  P_ADDR_REGEX, ou
+0000e090: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
+0000e0a0: 6620 6c65 6e28 6865 6164 5f69 705f 6c69  f len(head_ip_li
+0000e0b0: 7374 2920 3e20 313a 0a20 2020 2020 2020  st) > 1:.       
+0000e0c0: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+0000e0d0: 636f 756c 6420 6265 2074 7269 6767 6572  could be trigger
+0000e0e0: 6564 2069 6620 652e 672e 2c20 736f 6d65  ed if e.g., some
+0000e0f0: 206c 6f67 6769 6e67 2069 7320 6164 6465   logging is adde
+0000e100: 6420 696e 0a20 2020 2020 2020 2020 2020  d in.           
+0000e110: 2020 2020 2023 2073 6b79 7069 6c6f 745f       # skypilot_
+0000e120: 636f 6e66 6967 2c20 6120 6d6f 6475 6c65  config, a module
+0000e130: 2074 6861 7420 6861 7320 736f 6d65 2063   that has some c
+0000e140: 6f64 6520 6578 6563 7574 6564 0a20 2020  ode executed.   
+0000e150: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+0000e160: 6865 6e65 7665 7220 6073 6b79 6020 6973  henever `sky` is
+0000e170: 2069 6d70 6f72 7465 642e 0a20 2020 2020   imported..     
+0000e180: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000e190: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e1b0: 4465 7465 6374 6564 206d 6f72 6520 7468  Detected more th
+0000e1c0: 616e 2031 2049 5020 6672 6f6d 2074 6865  an 1 IP from the
+0000e1d0: 206f 7574 7075 7420 6f66 2027 0a20 2020   output of '.   
+0000e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1f0: 2027 7468 6520 6072 6179 2067 6574 2d68   'the `ray get-h
+0000e200: 6561 642d 6970 6020 636f 6d6d 616e 642e  ead-ip` command.
+0000e210: 2054 6869 7320 636f 756c 6420 270a 2020   This could '.  
+0000e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e230: 2020 2768 6170 7065 6e20 6966 2074 6865    'happen if the
+0000e240: 7265 2069 7320 6578 7472 6120 6f75 7470  re is extra outp
+0000e250: 7574 2066 726f 6d20 6974 2c20 270a 2020  ut from it, '.  
+0000e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e270: 2020 2777 6869 6368 2073 686f 756c 6420    'which should 
+0000e280: 6265 2069 6e73 7065 6374 6564 2062 656c  be inspected bel
+0000e290: 6f77 2e5c 6e50 726f 6365 6564 696e 6720  ow.\nProceeding 
+0000e2a0: 7769 7468 2027 0a20 2020 2020 2020 2020  with '.         
+0000e2b0: 2020 2020 2020 2020 2020 2066 2774 6865             f'the
+0000e2c0: 206c 6173 7420 6465 7465 6374 6564 2049   last detected I
+0000e2d0: 5020 287b 6865 6164 5f69 705f 6c69 7374  P ({head_ip_list
+0000e2e0: 5b2d 315d 7d29 2061 7320 6865 6164 2049  [-1]}) as head I
+0000e2f0: 502e 270a 2020 2020 2020 2020 2020 2020  P.'.            
+0000e300: 2020 2020 2020 2020 6627 5c6e 3d3d 204f          f'\n== O
+0000e310: 7574 7075 7420 3d3d 5c6e 7b6f 7574 7d27  utput ==\n{out}'
+0000e320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e330: 2020 2020 2066 275c 6e3d 3d20 4f75 7470       f'\n== Outp
+0000e340: 7574 2065 6e64 7320 3d3d 2729 0a20 2020  ut ends ==').   
+0000e350: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+0000e360: 645f 6970 5f6c 6973 7420 3d20 6865 6164  d_ip_list = head
+0000e370: 5f69 705f 6c69 7374 5b2d 313a 5d0a 2020  _ip_list[-1:].  
+0000e380: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000e390: 2031 203d 3d20 6c65 6e28 6865 6164 5f69   1 == len(head_i
+0000e3a0: 705f 6c69 7374 292c 2028 6f75 742c 2068  p_list), (out, h
+0000e3b0: 6561 645f 6970 5f6c 6973 7429 0a20 2020  ead_ip_list).   
+0000e3c0: 2020 2020 2020 2020 2068 6561 645f 6970           head_ip
+0000e3d0: 203d 2068 6561 645f 6970 5f6c 6973 745b   = head_ip_list[
+0000e3e0: 305d 0a20 2020 2020 2020 2020 2020 2062  0].            b
+0000e3f0: 7265 616b 0a20 2020 2020 2020 2065 7863  reak.        exc
+0000e400: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+0000e410: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+0000e420: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+0000e430: 2020 2020 6966 2069 203d 3d20 6d61 785f      if i == max_
+0000e440: 6174 7465 6d70 7473 202d 2031 3a0a 2020  attempts - 1:.  
+0000e450: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000e460: 6973 6520 6578 6365 7074 696f 6e73 2e46  ise exceptions.F
+0000e470: 6574 6368 4950 4572 726f 7228 0a20 2020  etchIPError(.   
+0000e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e490: 2072 6561 736f 6e3d 6578 6365 7074 696f   reason=exceptio
+0000e4a0: 6e73 2e46 6574 6368 4950 4572 726f 722e  ns.FetchIPError.
+0000e4b0: 5265 6173 6f6e 2e48 4541 4429 2066 726f  Reason.HEAD) fro
+0000e4c0: 6d20 650a 2020 2020 2020 2020 2020 2020  m e.            
+0000e4d0: 2320 5265 7472 7920 6966 2074 6865 2063  # Retry if the c
+0000e4e0: 6c75 7374 6572 2069 7320 6e6f 7420 7570  luster is not up
+0000e4f0: 2079 6574 2e0a 2020 2020 2020 2020 2020   yet..          
+0000e500: 2020 6c6f 6767 6572 2e64 6562 7567 2827    logger.debug('
+0000e510: 5265 7472 7969 6e67 2074 6f20 6765 7420  Retrying to get 
+0000e520: 6865 6164 2069 702e 2729 0a20 2020 2020  head ip.').     
+0000e530: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+0000e540: 7028 6261 636b 6f66 662e 6375 7272 656e  p(backoff.curren
+0000e550: 745f 6261 636b 6f66 6628 2929 0a20 2020  t_backoff()).   
+0000e560: 2072 6574 7572 6e20 6865 6164 5f69 700a   return head_ip.
+0000e570: 0a0a 4074 696d 656c 696e 652e 6576 656e  ..@timeline.even
+0000e580: 740a 6465 6620 6765 745f 6e6f 6465 5f69  t.def get_node_i
+0000e590: 7073 2863 6c75 7374 6572 5f79 616d 6c3a  ps(cluster_yaml:
+0000e5a0: 2073 7472 2c0a 2020 2020 2020 2020 2020   str,.          
+0000e5b0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+0000e5c0: 6e75 6d5f 6e6f 6465 733a 2069 6e74 2c0a  num_nodes: int,.
+0000e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5e0: 2068 6561 645f 6970 5f6d 6178 5f61 7474   head_ip_max_att
+0000e5f0: 656d 7074 733a 2069 6e74 203d 2031 2c0a  empts: int = 1,.
+0000e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e610: 2077 6f72 6b65 725f 6970 5f6d 6178 5f61   worker_ip_max_a
+0000e620: 7474 656d 7074 733a 2069 6e74 203d 2031  ttempts: int = 1
+0000e630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e640: 2020 2067 6574 5f69 6e74 6572 6e61 6c5f     get_internal_
+0000e650: 6970 733a 2062 6f6f 6c20 3d20 4661 6c73  ips: bool = Fals
+0000e660: 6529 202d 3e20 4c69 7374 5b73 7472 5d3a  e) -> List[str]:
+0000e670: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+0000e680: 7468 6520 4950 7320 6f66 2061 6c6c 206e  the IPs of all n
+0000e690: 6f64 6573 2069 6e20 7468 6520 636c 7573  odes in the clus
+0000e6a0: 7465 722c 2077 6974 6820 6865 6164 206e  ter, with head n
+0000e6b0: 6f64 6520 6174 2066 726f 6e74 2e0a 0a20  ode at front... 
+0000e6c0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000e6d0: 2063 6c75 7374 6572 5f79 616d 6c3a 2050   cluster_yaml: P
+0000e6e0: 6174 6820 746f 2074 6865 2063 6c75 7374  ath to the clust
+0000e6f0: 6572 2079 616d 6c2e 0a20 2020 2020 2020  er yaml..       
+0000e700: 2065 7870 6563 7465 645f 6e75 6d5f 6e6f   expected_num_no
+0000e710: 6465 733a 2045 7870 6563 7465 6420 6e75  des: Expected nu
+0000e720: 6d62 6572 206f 6620 6e6f 6465 7320 696e  mber of nodes in
+0000e730: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
+0000e740: 2020 2020 2020 6865 6164 5f69 705f 6d61        head_ip_ma
+0000e750: 785f 6174 7465 6d70 7473 3a20 4d61 7820  x_attempts: Max 
+0000e760: 6174 7465 6d70 7473 2074 6f20 6765 7420  attempts to get 
+0000e770: 6865 6164 2069 702e 0a20 2020 2020 2020  head ip..       
+0000e780: 2077 6f72 6b65 725f 6970 5f6d 6178 5f61   worker_ip_max_a
+0000e790: 7474 656d 7074 733a 204d 6178 2061 7474  ttempts: Max att
+0000e7a0: 656d 7074 7320 746f 2067 6574 2077 6f72  empts to get wor
+0000e7b0: 6b65 7220 6970 732e 0a20 2020 2020 2020  ker ips..       
+0000e7c0: 2067 6574 5f69 6e74 6572 6e61 6c5f 6970   get_internal_ip
+0000e7d0: 733a 2057 6865 7468 6572 2074 6f20 6765  s: Whether to ge
+0000e7e0: 7420 696e 7465 726e 616c 2049 5073 2e20  t internal IPs. 
+0000e7f0: 5768 656e 2046 616c 7365 2c20 6974 2069  When False, it i
+0000e800: 7320 7374 696c 6c0a 2020 2020 2020 2020  s still.        
+0000e810: 2020 2020 706f 7373 6962 6c65 2074 6f20      possible to 
+0000e820: 6765 7420 696e 7465 726e 616c 2049 5073  get internal IPs
+0000e830: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
+0000e840: 646f 6573 206e 6f74 2068 6176 6520 6578  does not have ex
+0000e850: 7465 726e 616c 0a20 2020 2020 2020 2020  ternal.         
+0000e860: 2020 2049 5073 2e0a 0a20 2020 2052 6169     IPs...    Rai
+0000e870: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
+0000e880: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000e890: 7272 6f72 3a20 6966 2077 6520 6661 696c  rror: if we fail
+0000e8a0: 6564 2074 6f20 6765 7420 7468 6520 4950  ed to get the IP
+0000e8b0: 732e 2065 2e72 6561 736f 6e20 6973 0a20  s. e.reason is. 
+0000e8c0: 2020 2020 2020 2020 2020 2048 4541 4420             HEAD 
+0000e8d0: 6f72 2057 4f52 4b45 522e 0a20 2020 2022  or WORKER..    "
+0000e8e0: 2222 0a20 2020 2072 6179 5f63 6f6e 6669  "".    ray_confi
+0000e8f0: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
+0000e900: 2e72 6561 645f 7961 6d6c 2863 6c75 7374  .read_yaml(clust
+0000e910: 6572 5f79 616d 6c29 0a20 2020 2023 2055  er_yaml).    # U
+0000e920: 7365 2074 6865 206e 6577 2070 726f 7669  se the new provi
+0000e930: 7369 6f6e 6572 2066 6f72 2041 5753 2e0a  sioner for AWS..
+0000e940: 2020 2020 7072 6f76 6964 6572 5f6e 616d      provider_nam
+0000e950: 6520 3d20 636c 7573 7465 725f 7961 6d6c  e = cluster_yaml
+0000e960: 5f75 7469 6c73 2e67 6574 5f70 726f 7669  _utils.get_provi
+0000e970: 6465 725f 6e61 6d65 2872 6179 5f63 6f6e  der_name(ray_con
+0000e980: 6669 6729 0a20 2020 2063 6c6f 7564 203d  fig).    cloud =
+0000e990: 2063 6c6f 7564 5f72 6567 6973 7472 792e   cloud_registry.
+0000e9a0: 434c 4f55 445f 5245 4749 5354 5259 2e66  CLOUD_REGISTRY.f
+0000e9b0: 726f 6d5f 7374 7228 7072 6f76 6964 6572  rom_str(provider
+0000e9c0: 5f6e 616d 6529 0a20 2020 2061 7373 6572  _name).    asser
+0000e9d0: 7420 636c 6f75 6420 6973 206e 6f74 204e  t cloud is not N
+0000e9e0: 6f6e 652c 2070 726f 7669 6465 725f 6e61  one, provider_na
+0000e9f0: 6d65 0a0a 2020 2020 6966 2063 6c6f 7564  me..    if cloud
+0000ea00: 2e50 524f 5649 5349 4f4e 4552 5f56 4552  .PROVISIONER_VER
+0000ea10: 5349 4f4e 203e 3d20 636c 6f75 6473 2e50  SION >= clouds.P
+0000ea20: 726f 7669 7369 6f6e 6572 5665 7273 696f  rovisionerVersio
+0000ea30: 6e2e 534b 5950 494c 4f54 3a0a 2020 2020  n.SKYPILOT:.    
+0000ea40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000ea50: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+0000ea60: 7072 6f76 6973 696f 6e5f 6c69 622e 6765  provision_lib.ge
+0000ea70: 745f 636c 7573 7465 725f 696e 666f 280a  t_cluster_info(.
+0000ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea90: 7072 6f76 6964 6572 5f6e 616d 652c 2072  provider_name, r
+0000eaa0: 6179 5f63 6f6e 6669 675b 2770 726f 7669  ay_config['provi
+0000eab0: 6465 7227 5d2e 6765 7428 2772 6567 696f  der'].get('regio
+0000eac0: 6e27 292c 0a20 2020 2020 2020 2020 2020  n'),.           
+0000ead0: 2020 2020 2072 6179 5f63 6f6e 6669 675b       ray_config[
+0000eae0: 2763 6c75 7374 6572 5f6e 616d 6527 5d2c  'cluster_name'],
+0000eaf0: 2072 6179 5f63 6f6e 6669 675b 2770 726f   ray_config['pro
+0000eb00: 7669 6465 7227 5d29 0a20 2020 2020 2020  vider']).       
+0000eb10: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000eb20: 6e20 6173 2065 3a20 2023 2070 796c 696e  n as e:  # pylin
+0000eb30: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
+0000eb40: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
+0000eb50: 2020 2020 2320 5468 6973 2063 6f75 6c64      # This could
+0000eb60: 2068 6170 7065 6e20 7768 656e 2074 6865   happen when the
+0000eb70: 2056 4d20 6973 206e 6f74 2066 756c 6c79   VM is not fully
+0000eb80: 206c 6175 6e63 6865 642c 2061 6e64 2061   launched, and a
+0000eb90: 2075 7365 720a 2020 2020 2020 2020 2020   user.          
+0000eba0: 2020 2320 6973 2074 7279 696e 6720 746f    # is trying to
+0000ebb0: 2074 6572 6d69 6e61 7465 2069 7420 7769   terminate it wi
+0000ebc0: 7468 2060 736b 7920 646f 776e 602e 0a20  th `sky down`.. 
+0000ebd0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000ebe0: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+0000ebf0: 2020 2020 2020 2020 2027 4661 696c 6564           'Failed
+0000ec00: 2074 6f20 6765 7420 636c 7573 7465 7220   to get cluster 
+0000ec10: 696e 666f 2066 6f72 2027 0a20 2020 2020  info for '.     
+0000ec20: 2020 2020 2020 2020 2020 2066 277b 7261             f'{ra
+0000ec30: 795f 636f 6e66 6967 5b22 636c 7573 7465  y_config["cluste
+0000ec40: 725f 6e61 6d65 225d 7d20 6672 6f6d 2074  r_name"]} from t
+0000ec50: 6865 206e 6577 2070 726f 7669 7369 6f6e  he new provision
+0000ec60: 6572 2027 0a20 2020 2020 2020 2020 2020  er '.           
+0000ec70: 2020 2020 2066 2777 6974 6820 7b63 6f6d       f'with {com
+0000ec80: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
+0000ec90: 5f65 7863 6570 7469 6f6e 2865 297d 2e27  _exception(e)}.'
+0000eca0: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
+0000ecb0: 6973 6520 6578 6365 7074 696f 6e73 2e46  ise exceptions.F
+0000ecc0: 6574 6368 4950 4572 726f 7228 0a20 2020  etchIPError(.   
+0000ecd0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000ece0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000ecf0: 7272 6f72 2e52 6561 736f 6e2e 4845 4144  rror.Reason.HEAD
+0000ed00: 2920 6672 6f6d 2065 0a20 2020 2020 2020  ) from e.       
+0000ed10: 2069 6620 6c65 6e28 6d65 7461 6461 7461   if len(metadata
+0000ed20: 2e69 6e73 7461 6e63 6573 2920 3c20 6578  .instances) < ex
+0000ed30: 7065 6374 6564 5f6e 756d 5f6e 6f64 6573  pected_num_nodes
+0000ed40: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000ed50: 5369 6d75 6c61 7465 2074 6865 2065 7863  Simulate the exc
+0000ed60: 6570 7469 6f6e 2077 6865 6e20 5261 7920  eption when Ray 
+0000ed70: 6865 6164 206e 6f64 6520 6973 206e 6f74  head node is not
+0000ed80: 2075 702e 0a20 2020 2020 2020 2020 2020   up..           
+0000ed90: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+0000eda0: 732e 4665 7463 6849 5045 7272 6f72 2865  s.FetchIPError(e
+0000edb0: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
+0000edc0: 5045 7272 6f72 2e52 6561 736f 6e2e 4845  PError.Reason.HE
+0000edd0: 4144 290a 2020 2020 2020 2020 7265 7475  AD).        retu
+0000ede0: 726e 206d 6574 6164 6174 612e 6765 745f  rn metadata.get_
+0000edf0: 6665 6173 6962 6c65 5f69 7073 2867 6574  feasible_ips(get
+0000ee00: 5f69 6e74 6572 6e61 6c5f 6970 7329 0a0a  _internal_ips)..
+0000ee10: 2020 2020 6966 2067 6574 5f69 6e74 6572      if get_inter
+0000ee20: 6e61 6c5f 6970 733a 0a20 2020 2020 2020  nal_ips:.       
+0000ee30: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
+0000ee40: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+0000ee50: 6528 6d6f 6465 3d27 7727 2c20 6465 6c65  e(mode='w', dele
+0000ee60: 7465 3d46 616c 7365 2920 6173 2066 3a0a  te=False) as f:.
+0000ee70: 2020 2020 2020 2020 2020 2020 7261 795f              ray_
+0000ee80: 636f 6e66 6967 5b27 7072 6f76 6964 6572  config['provider
+0000ee90: 275d 5b27 7573 655f 696e 7465 726e 616c  ']['use_internal
+0000eea0: 5f69 7073 275d 203d 2054 7275 650a 2020  _ips'] = True.  
+0000eeb0: 2020 2020 2020 2020 2020 7961 6d6c 2e64            yaml.d
+0000eec0: 756d 7028 7261 795f 636f 6e66 6967 2c20  ump(ray_config, 
+0000eed0: 6629 0a20 2020 2020 2020 2020 2020 2063  f).            c
+0000eee0: 6c75 7374 6572 5f79 616d 6c20 3d20 662e  luster_yaml = f.
+0000eef0: 6e61 6d65 0a0a 2020 2020 2320 4368 6563  name..    # Chec
+0000ef00: 6b20 7468 6520 6e65 7477 6f72 6b20 636f  k the network co
+0000ef10: 6e6e 6563 7469 6f6e 2066 6972 7374 2074  nnection first t
+0000ef20: 6f20 6176 6f69 6420 6c6f 6e67 2068 616e  o avoid long han
+0000ef30: 6769 6e67 2074 696d 6520 666f 720a 2020  ging time for.  
+0000ef40: 2020 2320 7261 7920 6765 742d 6865 6164    # ray get-head
+0000ef50: 2d69 7020 6265 6c6f 772c 2069 6620 6120  -ip below, if a 
+0000ef60: 6c6f 6e67 2d6c 6173 7469 6e67 206e 6574  long-lasting net
+0000ef70: 776f 726b 2063 6f6e 6e65 6374 696f 6e20  work connection 
+0000ef80: 6661 696c 7572 650a 2020 2020 2320 6861  failure.    # ha
+0000ef90: 7070 656e 732e 0a20 2020 2063 6865 636b  ppens..    check
+0000efa0: 5f6e 6574 776f 726b 5f63 6f6e 6e65 6374  _network_connect
+0000efb0: 696f 6e28 290a 2020 2020 6865 6164 5f69  ion().    head_i
+0000efc0: 7020 3d20 5f71 7565 7279 5f68 6561 645f  p = _query_head_
+0000efd0: 6970 5f77 6974 685f 7265 7472 6965 7328  ip_with_retries(
+0000efe0: 636c 7573 7465 725f 7961 6d6c 2c0a 2020  cluster_yaml,.  
+0000eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f010: 2020 2020 2020 2020 6d61 785f 6174 7465          max_atte
+0000f020: 6d70 7473 3d68 6561 645f 6970 5f6d 6178  mpts=head_ip_max
+0000f030: 5f61 7474 656d 7074 7329 0a20 2020 2068  _attempts).    h
+0000f040: 6561 645f 6970 5f6c 6973 7420 3d20 5b68  ead_ip_list = [h
+0000f050: 6561 645f 6970 5d0a 2020 2020 6966 2065  ead_ip].    if e
+0000f060: 7870 6563 7465 645f 6e75 6d5f 6e6f 6465  xpected_num_node
+0000f070: 7320 3e20 313a 0a20 2020 2020 2020 2062  s > 1:.        b
+0000f080: 6163 6b6f 6666 203d 2063 6f6d 6d6f 6e5f  ackoff = common_
+0000f090: 7574 696c 732e 4261 636b 6f66 6628 696e  utils.Backoff(in
+0000f0a0: 6974 6961 6c5f 6261 636b 6f66 663d 352c  itial_backoff=5,
+0000f0b0: 206d 6178 5f62 6163 6b6f 6666 5f66 6163   max_backoff_fac
+0000f0c0: 746f 723d 3529 0a0a 2020 2020 2020 2020  tor=5)..        
+0000f0d0: 666f 7220 7265 7472 795f 636e 7420 696e  for retry_cnt in
+0000f0e0: 2072 616e 6765 2877 6f72 6b65 725f 6970   range(worker_ip
+0000f0f0: 5f6d 6178 5f61 7474 656d 7074 7329 3a0a  _max_attempts):.
+0000f100: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000f110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f120: 2066 756c 6c5f 636c 7573 7465 725f 7961   full_cluster_ya
+0000f130: 6d6c 203d 2073 7472 2870 6174 686c 6962  ml = str(pathlib
+0000f140: 2e50 6174 6828 636c 7573 7465 725f 7961  .Path(cluster_ya
+0000f150: 6d6c 292e 6578 7061 6e64 7573 6572 2829  ml).expanduser()
+0000f160: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f170: 2020 7072 6f63 203d 2073 7562 7072 6f63    proc = subproc
+0000f180: 6573 735f 7574 696c 732e 7275 6e28 0a20  ess_utils.run(. 
 0000f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1a0: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
-0000f1b0: 4950 4572 726f 722e 5265 6173 6f6e 2e57  IPError.Reason.W
-0000f1c0: 4f52 4b45 5229 2066 726f 6d20 650a 2020  ORKER) from e.  
-0000f1d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000f1e0: 5265 7472 7920 6966 2074 6865 2073 7368  Retry if the ssh
-0000f1f0: 2069 7320 6e6f 7420 7265 6164 7920 666f   is not ready fo
-0000f200: 7220 7468 6520 776f 726b 6572 7320 7965  r the workers ye
-0000f210: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
-0000f220: 2020 2062 6163 6b6f 6666 5f74 696d 6520     backoff_time 
-0000f230: 3d20 6261 636b 6f66 662e 6375 7272 656e  = backoff.curren
-0000f240: 745f 6261 636b 6f66 6628 290a 2020 2020  t_backoff().    
-0000f250: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0000f260: 6572 2e64 6562 7567 2827 5265 7472 7969  er.debug('Retryi
-0000f270: 6e67 2074 6f20 6765 7420 776f 726b 6572  ng to get worker
-0000f280: 2069 7020 270a 2020 2020 2020 2020 2020   ip '.          
-0000f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2a0: 2020 2066 275b 7b72 6574 7279 5f63 6e74     f'[{retry_cnt
-0000f2b0: 7d2f 7b77 6f72 6b65 725f 6970 5f6d 6178  }/{worker_ip_max
-0000f2c0: 5f61 7474 656d 7074 737d 5d20 696e 2027  _attempts}] in '
-0000f2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f2e0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000f2f0: 7b62 6163 6b6f 6666 5f74 696d 657d 2073  {backoff_time} s
-0000f300: 6563 6f6e 6473 2e27 290a 2020 2020 2020  econds.').      
-0000f310: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-0000f320: 6c65 6570 2862 6163 6b6f 6666 5f74 696d  leep(backoff_tim
-0000f330: 6529 0a20 2020 2020 2020 2077 6f72 6b65  e).        worke
-0000f340: 725f 6970 7320 3d20 7265 2e66 696e 6461  r_ips = re.finda
-0000f350: 6c6c 2849 505f 4144 4452 5f52 4547 4558  ll(IP_ADDR_REGEX
-0000f360: 2c20 6f75 7429 0a20 2020 2020 2020 2069  , out).        i
-0000f370: 6620 6c65 6e28 776f 726b 6572 5f69 7073  f len(worker_ips
-0000f380: 2920 213d 2065 7870 6563 7465 645f 6e75  ) != expected_nu
-0000f390: 6d5f 6e6f 6465 7320 2d20 313a 0a20 2020  m_nodes - 1:.   
-0000f3a0: 2020 2020 2020 2020 206e 203d 2065 7870           n = exp
-0000f3b0: 6563 7465 645f 6e75 6d5f 6e6f 6465 7320  ected_num_nodes 
-0000f3c0: 2d20 310a 2020 2020 2020 2020 2020 2020  - 1.            
-0000f3d0: 6966 206c 656e 2877 6f72 6b65 725f 6970  if len(worker_ip
-0000f3e0: 7329 203e 206e 3a0a 2020 2020 2020 2020  s) > n:.        
-0000f3f0: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
-0000f400: 6f75 6c64 2062 6520 7472 6967 6765 7265  ould be triggere
-0000f410: 6420 6966 2065 2e67 2e2c 2073 6f6d 6520  d if e.g., some 
-0000f420: 6c6f 6767 696e 6720 6973 2061 6464 6564  logging is added
-0000f430: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
-0000f440: 2020 2020 2320 736b 7970 696c 6f74 5f63      # skypilot_c
-0000f450: 6f6e 6669 672c 2061 206d 6f64 756c 6520  onfig, a module 
-0000f460: 7468 6174 2068 6173 2073 6f6d 6520 636f  that has some co
-0000f470: 6465 2065 7865 6375 7465 6420 7768 656e  de executed when
-0000f480: 6576 6572 0a20 2020 2020 2020 2020 2020  ever.           
-0000f490: 2020 2020 2023 2060 736b 7960 2069 7320       # `sky` is 
-0000f4a0: 696d 706f 7274 6564 2e0a 2020 2020 2020  imported..      
-0000f4b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000f4c0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000f4e0: 4578 7065 6374 6564 207b 6e7d 2077 6f72  Expected {n} wor
-0000f4f0: 6b65 7220 4950 2873 293b 2066 6f75 6e64  ker IP(s); found
-0000f500: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000f510: 2020 2020 2020 2066 277b 6c65 6e28 776f         f'{len(wo
-0000f520: 726b 6572 5f69 7073 297d 3a20 7b77 6f72  rker_ips)}: {wor
-0000f530: 6b65 725f 6970 737d 270a 2020 2020 2020  ker_ips}'.      
-0000f540: 2020 2020 2020 2020 2020 2020 2020 275c                '\
-0000f550: 6e54 6869 7320 636f 756c 6420 6861 7070  nThis could happ
-0000f560: 656e 2069 6620 7468 6572 6520 6973 2065  en if there is e
-0000f570: 7874 7261 206f 7574 7075 7420 6672 6f6d  xtra output from
-0000f580: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000f590: 2020 2020 2020 2027 6072 6179 2067 6574         '`ray get
-0000f5a0: 2d77 6f72 6b65 722d 6970 7360 2c20 7768  -worker-ips`, wh
-0000f5b0: 6963 6820 7368 6f75 6c64 2062 6520 696e  ich should be in
-0000f5c0: 7370 6563 7465 6420 6265 6c6f 772e 270a  spected below.'.
-0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5e0: 2020 2020 6627 5c6e 3d3d 204f 7574 7075      f'\n== Outpu
-0000f5f0: 7420 3d3d 5c6e 7b6f 7574 7d27 0a20 2020  t ==\n{out}'.   
-0000f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f610: 2066 275c 6e3d 3d20 4f75 7470 7574 2065   f'\n== Output e
-0000f620: 6e64 7320 3d3d 2729 0a20 2020 2020 2020  nds ==').       
-0000f630: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000f640: 7761 726e 696e 6728 6627 5c6e 5072 6f63  warning(f'\nProc
-0000f650: 6565 6469 6e67 2077 6974 6820 7468 6520  eeding with the 
-0000f660: 6c61 7374 207b 6e7d 2027 0a20 2020 2020  last {n} '.     
-0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f680: 2020 2020 2020 2020 2020 6627 6465 7465            f'dete
-0000f690: 6374 6564 2049 5028 7329 3a20 7b77 6f72  cted IP(s): {wor
-0000f6a0: 6b65 725f 6970 735b 2d6e 3a5d 7d2e 2729  ker_ips[-n:]}.')
-0000f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f6c0: 2077 6f72 6b65 725f 6970 7320 3d20 776f   worker_ips = wo
-0000f6d0: 726b 6572 5f69 7073 5b2d 6e3a 5d0a 2020  rker_ips[-n:].  
-0000f6e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f700: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
-0000f710: 2e46 6574 6368 4950 4572 726f 7228 0a20  .FetchIPError(. 
-0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f730: 2020 2065 7863 6570 7469 6f6e 732e 4665     exceptions.Fe
-0000f740: 7463 6849 5045 7272 6f72 2e52 6561 736f  tchIPError.Reaso
-0000f750: 6e2e 574f 524b 4552 290a 2020 2020 656c  n.WORKER).    el
-0000f760: 7365 3a0a 2020 2020 2020 2020 776f 726b  se:.        work
-0000f770: 6572 5f69 7073 203d 205b 5d0a 2020 2020  er_ips = [].    
-0000f780: 7265 7475 726e 2068 6561 645f 6970 5f6c  return head_ip_l
-0000f790: 6973 7420 2b20 776f 726b 6572 5f69 7073  ist + worker_ips
-0000f7a0: 0a0a 0a64 6566 2063 6865 636b 5f6e 6574  ...def check_net
-0000f7b0: 776f 726b 5f63 6f6e 6e65 6374 696f 6e28  work_connection(
-0000f7c0: 293a 0a20 2020 2023 2054 6f6c 6572 6174  ):.    # Tolerat
-0000f7d0: 6520 3320 7265 7472 6965 7320 6173 2069  e 3 retries as i
-0000f7e0: 7420 6973 206f 6273 6572 7665 6420 7468  t is observed th
-0000f7f0: 6174 2063 6f6e 6e65 6374 696f 6e73 2063  at connections c
-0000f800: 616e 2066 6169 6c2e 0a20 2020 2061 6461  an fail..    ada
-0000f810: 7074 6572 203d 2061 6461 7074 6572 732e  pter = adapters.
-0000f820: 4854 5450 4164 6170 7465 7228 6d61 785f  HTTPAdapter(max_
-0000f830: 7265 7472 6965 733d 7265 7472 795f 6c69  retries=retry_li
-0000f840: 622e 5265 7472 7928 746f 7461 6c3d 3329  b.Retry(total=3)
-0000f850: 290a 2020 2020 6874 7470 203d 2072 6571  ).    http = req
-0000f860: 7565 7374 732e 5365 7373 696f 6e28 290a  uests.Session().
-0000f870: 2020 2020 6874 7470 2e6d 6f75 6e74 2827      http.mount('
-0000f880: 6874 7470 733a 2f2f 272c 2061 6461 7074  https://', adapt
-0000f890: 6572 290a 2020 2020 6874 7470 2e6d 6f75  er).    http.mou
-0000f8a0: 6e74 2827 6874 7470 3a2f 2f27 2c20 6164  nt('http://', ad
-0000f8b0: 6170 7465 7229 0a20 2020 2066 6f72 2069  apter).    for i
-0000f8c0: 2c20 6970 2069 6e20 656e 756d 6572 6174  , ip in enumerat
-0000f8d0: 6528 5f54 4553 545f 4950 5f4c 4953 5429  e(_TEST_IP_LIST)
-0000f8e0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0000f8f0: 2020 2020 2020 2020 2020 2068 7474 702e             http.
-0000f900: 6865 6164 2869 702c 2074 696d 656f 7574  head(ip, timeout
-0000f910: 3d33 290a 2020 2020 2020 2020 2020 2020  =3).            
-0000f920: 7265 7475 726e 0a20 2020 2020 2020 2065  return.        e
-0000f930: 7863 6570 7420 2872 6571 7565 7374 732e  xcept (requests.
-0000f940: 5469 6d65 6f75 742c 2072 6571 7565 7374  Timeout, request
-0000f950: 732e 6578 6365 7074 696f 6e73 2e43 6f6e  s.exceptions.Con
-0000f960: 6e65 6374 696f 6e45 7272 6f72 2920 6173  nectionError) as
-0000f970: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0000f980: 6966 2069 203d 3d20 6c65 6e28 5f54 4553  if i == len(_TES
-0000f990: 545f 4950 5f4c 4953 5429 202d 2031 3a0a  T_IP_LIST) - 1:.
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9b0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
-0000f9c0: 2e4e 6574 776f 726b 4572 726f 7228 2743  .NetworkError('C
-0000f9d0: 6f75 6c64 206e 6f74 2072 6566 7265 7368  ould not refresh
-0000f9e0: 2074 6865 2063 6c75 7374 6572 2e20 270a   the cluster. '.
-0000f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa10: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-0000fa20: 6574 776f 726b 2073 6565 6d73 2064 6f77  etwork seems dow
-0000fa30: 6e2e 2729 2066 726f 6d20 650a 0a0a 6465  n.') from e...de
-0000fa40: 6620 6368 6563 6b5f 6f77 6e65 725f 6964  f check_owner_id
-0000fa50: 656e 7469 7479 2863 6c75 7374 6572 5f6e  entity(cluster_n
-0000fa60: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
-0000fa70: 653a 0a20 2020 2022 2222 4368 6563 6b20  e:.    """Check 
-0000fa80: 6966 2063 7572 7265 6e74 2075 7365 7220  if current user 
-0000fa90: 6973 2074 6865 2073 616d 6520 6173 2074  is the same as t
-0000faa0: 6865 2075 7365 7220 7768 6f20 6372 6561  he user who crea
-0000fab0: 7465 6420 7468 6520 636c 7573 7465 722e  ted the cluster.
-0000fac0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-0000fad0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-0000fae0: 2e43 6c75 7374 6572 4f77 6e65 7249 6465  .ClusterOwnerIde
-0000faf0: 6e74 6974 794d 6973 6d61 7463 6845 7272  ntityMismatchErr
-0000fb00: 6f72 3a20 6966 2074 6865 2063 7572 7265  or: if the curre
-0000fb10: 6e74 2075 7365 7220 6973 0a20 2020 2020  nt user is.     
-0000fb20: 2020 2020 206e 6f74 2074 6865 2073 616d       not the sam
-0000fb30: 6520 6173 2074 6865 2075 7365 7220 7768  e as the user wh
-0000fb40: 6f20 6372 6561 7465 6420 7468 6520 636c  o created the cl
-0000fb50: 7573 7465 722e 0a20 2020 2020 2020 2065  uster..        e
-0000fb60: 7863 6570 7469 6f6e 732e 436c 6f75 6455  xceptions.CloudU
-0000fb70: 7365 7249 6465 6e74 6974 7945 7272 6f72  serIdentityError
-0000fb80: 3a20 6966 2077 6520 6661 696c 2074 6f20  : if we fail to 
-0000fb90: 6765 7420 7468 6520 6375 7272 656e 7420  get the current 
-0000fba0: 7573 6572 0a20 2020 2020 2020 2020 2069  user.          i
-0000fbb0: 6465 6e74 6974 792e 0a20 2020 2022 2222  dentity..    """
-0000fbc0: 0a20 2020 2069 6620 656e 765f 6f70 7469  .    if env_opti
-0000fbd0: 6f6e 732e 4f70 7469 6f6e 732e 534b 4950  ons.Options.SKIP
-0000fbe0: 5f43 4c4f 5544 5f49 4445 4e54 4954 595f  _CLOUD_IDENTITY_
-0000fbf0: 4348 4543 4b2e 6765 7428 293a 0a20 2020  CHECK.get():.   
-0000fc00: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0000fc10: 7265 636f 7264 203d 2067 6c6f 6261 6c5f  record = global_
-0000fc20: 7573 6572 5f73 7461 7465 2e67 6574 5f63  user_state.get_c
-0000fc30: 6c75 7374 6572 5f66 726f 6d5f 6e61 6d65  luster_from_name
-0000fc40: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
-0000fc50: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
-0000fc60: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
-0000fc70: 7475 726e 0a20 2020 2068 616e 646c 6520  turn.    handle 
-0000fc80: 3d20 7265 636f 7264 5b27 6861 6e64 6c65  = record['handle
-0000fc90: 275d 0a20 2020 2069 6620 6e6f 7420 6973  '].    if not is
-0000fca0: 696e 7374 616e 6365 2868 616e 646c 652c  instance(handle,
-0000fcb0: 2062 6163 6b65 6e64 732e 436c 6f75 6456   backends.CloudV
-0000fcc0: 6d52 6179 5265 736f 7572 6365 4861 6e64  mRayResourceHand
-0000fcd0: 6c65 293a 0a20 2020 2020 2020 2072 6574  le):.        ret
-0000fce0: 7572 6e0a 0a20 2020 2063 6c6f 7564 203d  urn..    cloud =
-0000fcf0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-0000fd00: 5f72 6573 6f75 7263 6573 2e63 6c6f 7564  _resources.cloud
-0000fd10: 0a20 2020 2063 7572 7265 6e74 5f75 7365  .    current_use
-0000fd20: 725f 6964 656e 7469 7479 203d 2063 6c6f  r_identity = clo
-0000fd30: 7564 2e67 6574 5f63 7572 7265 6e74 5f75  ud.get_current_u
-0000fd40: 7365 725f 6964 656e 7469 7479 2829 0a20  ser_identity(). 
-0000fd50: 2020 206f 776e 6572 5f69 6465 6e74 6974     owner_identit
-0000fd60: 7920 3d20 7265 636f 7264 5b27 6f77 6e65  y = record['owne
-0000fd70: 7227 5d0a 2020 2020 6966 2063 7572 7265  r'].    if curre
-0000fd80: 6e74 5f75 7365 725f 6964 656e 7469 7479  nt_user_identity
-0000fd90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000fda0: 2020 2320 536b 6970 2074 6865 2063 6865    # Skip the che
-0000fdb0: 636b 2069 6620 7468 6520 636c 6f75 6420  ck if the cloud 
-0000fdc0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0000fdd0: 2075 7365 7220 6964 656e 7469 7479 2e0a   user identity..
-0000fde0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000fdf0: 2020 2023 2054 6865 2075 7365 7220 6964     # The user id
-0000fe00: 656e 7469 7479 2063 616e 2062 6520 4e6f  entity can be No
-0000fe10: 6e65 2c20 6966 2074 6865 2063 6c75 7374  ne, if the clust
-0000fe20: 6572 2069 7320 6372 6561 7465 6420 6279  er is created by
-0000fe30: 2061 6e20 6f6c 6465 720a 2020 2020 2320   an older.    # 
-0000fe40: 7665 7273 696f 6e20 6f66 2053 6b79 5069  version of SkyPi
-0000fe50: 6c6f 742e 2049 6e20 7468 6174 2063 6173  lot. In that cas
-0000fe60: 652c 2077 6520 7365 7420 7468 6520 7573  e, we set the us
-0000fe70: 6572 2069 6465 6e74 6974 7920 746f 2074  er identity to t
-0000fe80: 6865 0a20 2020 2023 2063 7572 7265 6e74  he.    # current
-0000fe90: 206f 6e65 2e0a 2020 2020 2320 4e4f 5445   one..    # NOTE
-0000fea0: 3a20 6120 7573 6572 2077 686f 2075 7067  : a user who upg
-0000feb0: 7261 6465 7320 536b 7950 696c 6f74 2061  rades SkyPilot a
-0000fec0: 6e64 2073 7769 7463 6865 7320 746f 2061  nd switches to a
-0000fed0: 206e 6577 2063 6c6f 7564 2069 6465 6e74   new cloud ident
-0000fee0: 6974 790a 2020 2020 2320 696d 6d65 6469  ity.    # immedi
-0000fef0: 6174 656c 7920 7769 7468 6f75 7420 6073  ately without `s
-0000ff00: 6b79 2073 7461 7475 7320 2d2d 7265 6672  ky status --refr
-0000ff10: 6573 6860 2066 6972 7374 2c20 7769 6c6c  esh` first, will
-0000ff20: 2063 6175 7365 2061 206c 6561 6b61 6765   cause a leakage
-0000ff30: 0a20 2020 2023 206f 6620 7468 6520 6578  .    # of the ex
-0000ff40: 6973 7469 6e67 2063 6c75 7374 6572 2e20  isting cluster. 
-0000ff50: 5765 2064 6565 6d20 7468 6973 2061 6e20  We deem this an 
-0000ff60: 6163 6365 7074 6162 6c65 2074 7261 6465  acceptable trade
-0000ff70: 6f66 6620 6d61 696e 6c79 0a20 2020 2023  off mainly.    #
-0000ff80: 2062 6563 6175 7365 206d 756c 7469 2d69   because multi-i
-0000ff90: 6465 6e74 6974 7920 6973 206e 6f74 2063  dentity is not c
-0000ffa0: 6f6d 6d6f 6e20 2861 7420 6c65 6173 7420  ommon (at least 
-0000ffb0: 6174 2074 6865 206d 6f6d 656e 7429 2e0a  at the moment)..
-0000ffc0: 2020 2020 6966 206f 776e 6572 5f69 6465      if owner_ide
-0000ffd0: 6e74 6974 7920 6973 204e 6f6e 653a 0a20  ntity is None:. 
-0000ffe0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
-0000fff0: 6572 5f73 7461 7465 2e73 6574 5f6f 776e  er_state.set_own
-00010000: 6572 5f69 6465 6e74 6974 795f 666f 725f  er_identity_for_
-00010010: 636c 7573 7465 7228 0a20 2020 2020 2020  cluster(.       
-00010020: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-00010030: 652c 2063 7572 7265 6e74 5f75 7365 725f  e, current_user_
-00010040: 6964 656e 7469 7479 290a 2020 2020 656c  identity).    el
-00010050: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
-00010060: 7274 2069 7369 6e73 7461 6e63 6528 6f77  rt isinstance(ow
-00010070: 6e65 725f 6964 656e 7469 7479 2c20 6c69  ner_identity, li
-00010080: 7374 290a 2020 2020 2020 2020 2320 4974  st).        # It
-00010090: 2069 7320 4f4b 2069 6620 7468 6520 6f77   is OK if the ow
-000100a0: 6e65 7220 6964 656e 7469 7479 2069 7320  ner identity is 
-000100b0: 7368 6f72 7465 722c 2077 6869 6368 2077  shorter, which w
-000100c0: 696c 6c20 6861 7070 656e 2077 6865 6e0a  ill happen when.
-000100d0: 2020 2020 2020 2020 2320 7468 6520 636c          # the cl
-000100e0: 7573 7465 7220 6973 206c 6175 6e63 6865  uster is launche
-000100f0: 6420 6265 666f 7265 2023 3138 3038 2e20  d before #1808. 
-00010100: 496e 2074 6861 7420 6361 7365 2c20 7765  In that case, we
-00010110: 206f 6e6c 7920 6368 6563 6b0a 2020 2020   only check.    
-00010120: 2020 2020 2320 7468 6520 7361 6d65 206c      # the same l
-00010130: 656e 6774 6820 287a 6970 2077 696c 6c20  ength (zip will 
-00010140: 7374 6f70 2061 7420 7468 6520 7368 6f72  stop at the shor
-00010150: 7465 7220 6f6e 6529 2e0a 2020 2020 2020  ter one)..      
-00010160: 2020 666f 7220 692c 2028 6f77 6e65 722c    for i, (owner,
-00010170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010180: 2063 7572 7265 6e74 2920 696e 2065 6e75   current) in enu
-00010190: 6d65 7261 7465 287a 6970 286f 776e 6572  merate(zip(owner
-000101a0: 5f69 6465 6e74 6974 792c 0a20 2020 2020  _identity,.     
-000101b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101d0: 2020 2020 2063 7572 7265 6e74 5f75 7365       current_use
-000101e0: 725f 6964 656e 7469 7479 2929 3a0a 2020  r_identity)):.  
-000101f0: 2020 2020 2020 2020 2020 2320 436c 6561            # Clea
-00010200: 6e20 7570 2074 6865 206f 776e 6572 2069  n up the owner i
-00010210: 6465 6e74 6979 2066 6f72 2074 6865 2062  dentiy for the b
-00010220: 6163 6b73 6c61 7368 2061 6e64 206e 6577  ackslash and new
-00010230: 6c69 6e65 732c 2063 6175 7365 640a 2020  lines, caused.  
-00010240: 2020 2020 2020 2020 2020 2320 6279 2074            # by t
-00010250: 6865 2063 6c6f 7564 2043 4c49 206f 7574  he cloud CLI out
-00010260: 7075 742c 2065 2e67 2e20 6763 6c6f 7564  put, e.g. gcloud
-00010270: 2e0a 2020 2020 2020 2020 2020 2020 6f77  ..            ow
-00010280: 6e65 7220 3d20 6f77 6e65 722e 7265 706c  ner = owner.repl
-00010290: 6163 6528 275c 6e27 2c20 2727 292e 7265  ace('\n', '').re
-000102a0: 706c 6163 6528 275c 5c27 2c20 2727 290a  place('\\', '').
-000102b0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
-000102c0: 776e 6572 203d 3d20 6375 7272 656e 743a  wner == current:
-000102d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000102e0: 2069 6620 6920 213d 2030 3a0a 2020 2020   if i != 0:.    
-000102f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010300: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010320: 2020 2020 2020 2020 6627 5468 6520 636c          f'The cl
-00010330: 7573 7465 7220 7761 7320 6f77 6e65 6420  uster was owned 
-00010340: 6279 207b 6f77 6e65 725f 6964 656e 7469  by {owner_identi
-00010350: 7479 7d2c 2062 7574 2027 0a20 2020 2020  ty}, but '.     
-00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010370: 2020 2066 2761 206e 6577 2069 6465 6e74     f'a new ident
-00010380: 6974 7920 7b63 7572 7265 6e74 5f75 7365  ity {current_use
-00010390: 725f 6964 656e 7469 7479 7d20 6973 2061  r_identity} is a
-000103a0: 6374 6976 6174 6564 2e20 5765 2073 7469  ctivated. We sti
-000103b0: 6c6c 2027 0a20 2020 2020 2020 2020 2020  ll '.           
-000103c0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-000103d0: 6c6f 7720 7468 6520 6f70 6572 6174 696f  low the operatio
-000103e0: 6e20 6173 2074 6865 2074 776f 2069 6465  n as the two ide
-000103f0: 6e74 6974 6965 7320 6172 6520 6c69 6b65  ntities are like
-00010400: 6c79 2074 6f20 6861 7665 2027 0a20 2020  ly to have '.   
-00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010420: 2020 2020 2027 7468 6520 7361 6d65 2061       'the same a
-00010430: 6363 6573 7320 746f 2074 6865 2063 6c75  ccess to the clu
-00010440: 7374 6572 2e20 506c 6561 7365 2062 6520  ster. Please be 
-00010450: 6177 6172 6520 7468 6174 2074 6869 7320  aware that this 
-00010460: 6361 6e20 270a 2020 2020 2020 2020 2020  can '.          
-00010470: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00010480: 6175 7365 2075 6e65 7870 6563 7465 6420  ause unexpected 
-00010490: 636c 7573 7465 7220 6c65 616b 6167 6520  cluster leakage 
-000104a0: 6966 2074 6865 2074 776f 2069 6465 6e74  if the two ident
-000104b0: 6974 6965 7320 6172 6520 6e6f 7420 270a  ities are not '.
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104d0: 2020 2020 2020 2020 2761 6374 7561 6c6c          'actuall
-000104e0: 7920 6571 7569 7661 6c65 6e74 2028 652e  y equivalent (e.
-000104f0: 672e 2c20 6265 6c6f 6e67 2074 6f20 7468  g., belong to th
-00010500: 6520 7361 6d65 2070 6572 736f 6e29 2e27  e same person).'
-00010510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010520: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00010530: 2020 2020 2020 2069 6620 6920 213d 2030         if i != 0
-00010540: 206f 7220 6c65 6e28 6f77 6e65 725f 6964   or len(owner_id
-00010550: 656e 7469 7479 2920 213d 206c 656e 2863  entity) != len(c
-00010560: 7572 7265 6e74 5f75 7365 725f 6964 656e  urrent_user_iden
-00010570: 7469 7479 293a 0a20 2020 2020 2020 2020  tity):.         
-00010580: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-00010590: 7570 6461 7465 2074 6865 206f 776e 6572  update the owner
-000105a0: 206f 6620 6120 636c 7573 7465 722c 2077   of a cluster, w
-000105b0: 6865 6e3a 0a20 2020 2020 2020 2020 2020  hen:.           
-000105c0: 2020 2020 2020 2020 2023 2031 2e20 5468           # 1. Th
-000105d0: 6520 7374 7269 6374 6573 7420 6964 656e  e strictest iden
-000105e0: 7474 7920 2869 2e65 2e20 7468 6520 6669  tty (i.e. the fi
-000105f0: 7273 7420 6f6e 6529 2064 6f65 7320 6e6f  rst one) does no
-00010600: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00010610: 2020 2020 2020 2320 6d61 7463 682c 2062        # match, b
-00010620: 7574 2074 6865 206c 6174 7465 7220 6f6e  ut the latter on
-00010630: 6573 206d 6174 6368 2e0a 2020 2020 2020  es match..      
-00010640: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010650: 322e 2054 6865 206c 656e 6774 6820 6f66  2. The length of
-00010660: 2074 6865 2074 776f 2069 6465 6e74 6974   the two identit
-00010670: 6965 7320 6172 6520 6469 6666 6572 656e  ies are differen
-00010680: 742c 2077 6869 6368 0a20 2020 2020 2020  t, which.       
-00010690: 2020 2020 2020 2020 2020 2020 2023 2077               # w
-000106a0: 696c 6c20 6f6e 6c79 2068 6170 7065 6e20  ill only happen 
-000106b0: 7768 656e 2074 6865 2063 6c75 7374 6572  when the cluster
-000106c0: 2069 7320 6c61 756e 6368 6564 2062 6566   is launched bef
-000106d0: 6f72 6520 2331 3830 382e 0a20 2020 2020  ore #1808..     
-000106e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000106f0: 2055 7064 6174 6520 7468 6520 7573 6572   Update the user
-00010700: 2069 6465 6e74 6974 7920 746f 2061 766f   identity to avo
-00010710: 6964 2073 686f 7769 6e67 2074 6865 2077  id showing the w
-00010720: 6172 6e69 6e67 2061 626f 7665 0a20 2020  arning above.   
-00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010740: 2023 2061 6761 696e 2e0a 2020 2020 2020   # again..      
-00010750: 2020 2020 2020 2020 2020 2020 2020 676c                gl
-00010760: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-00010770: 7365 745f 6f77 6e65 725f 6964 656e 7469  set_owner_identi
-00010780: 7479 5f66 6f72 5f63 6c75 7374 6572 280a  ty_for_cluster(.
-00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107a0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-000107b0: 6e61 6d65 2c20 6375 7272 656e 745f 7573  name, current_us
-000107c0: 6572 5f69 6465 6e74 6974 7929 0a20 2020  er_identity).   
-000107d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000107e0: 7572 6e20 2023 2054 6865 2075 7365 7220  urn  # The user 
-000107f0: 6964 656e 7469 7479 206d 6174 6368 6573  identity matches
-00010800: 2e0a 2020 2020 2020 2020 7769 7468 2075  ..        with u
-00010810: 785f 7574 696c 732e 7072 696e 745f 6578  x_utils.print_ex
-00010820: 6365 7074 696f 6e5f 6e6f 5f74 7261 6365  ception_no_trace
-00010830: 6261 636b 2829 3a0a 2020 2020 2020 2020  back():.        
-00010840: 2020 2020 7261 6973 6520 6578 6365 7074      raise except
-00010850: 696f 6e73 2e43 6c75 7374 6572 4f77 6e65  ions.ClusterOwne
-00010860: 7249 6465 6e74 6974 794d 6973 6d61 7463  rIdentityMismatc
-00010870: 6845 7272 6f72 280a 2020 2020 2020 2020  hError(.        
-00010880: 2020 2020 2020 2020 6627 7b63 6c75 7374          f'{clust
-00010890: 6572 5f6e 616d 6521 727d 2028 7b63 6c6f  er_name!r} ({clo
-000108a0: 7564 7d29 2069 7320 6f77 6e65 6420 6279  ud}) is owned by
-000108b0: 2061 6363 6f75 6e74 2027 0a20 2020 2020   account '.     
-000108c0: 2020 2020 2020 2020 2020 2066 277b 6f77             f'{ow
-000108d0: 6e65 725f 6964 656e 7469 7479 2172 7d2c  ner_identity!r},
-000108e0: 2062 7574 2074 6865 2061 6374 6976 6174   but the activat
-000108f0: 6564 2061 6363 6f75 6e74 2027 0a20 2020  ed account '.   
-00010900: 2020 2020 2020 2020 2020 2020 2066 2769               f'i
-00010910: 7320 7b63 7572 7265 6e74 5f75 7365 725f  s {current_user_
-00010920: 6964 656e 7469 7479 2172 7d2e 2729 0a0a  identity!r}.')..
-00010930: 0a64 6566 2074 6167 5f66 696c 7465 725f  .def tag_filter_
-00010940: 666f 725f 636c 7573 7465 7228 636c 7573  for_cluster(clus
-00010950: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
-00010960: 3e20 4469 6374 5b73 7472 2c20 7374 725d  > Dict[str, str]
-00010970: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
-00010980: 2061 2074 6167 2066 696c 7465 7220 666f   a tag filter fo
-00010990: 7220 7468 6520 636c 7573 7465 722e 2222  r the cluster.""
-000109a0: 220a 2020 2020 7265 7475 726e 207b 0a20  ".    return {. 
-000109b0: 2020 2020 2020 2027 7261 792d 636c 7573         'ray-clus
-000109c0: 7465 722d 6e61 6d65 273a 2063 6c75 7374  ter-name': clust
-000109d0: 6572 5f6e 616d 652c 0a20 2020 207d 0a0a  er_name,.    }..
-000109e0: 0a64 6566 205f 7175 6572 795f 636c 7573  .def _query_clus
-000109f0: 7465 725f 7374 6174 7573 5f76 6961 5f63  ter_status_via_c
-00010a00: 6c6f 7564 5f61 7069 280a 2020 2020 6861  loud_api(.    ha
-00010a10: 6e64 6c65 3a20 2763 6c6f 7564 5f76 6d5f  ndle: 'cloud_vm_
-00010a20: 7261 795f 6261 636b 656e 642e 436c 6f75  ray_backend.Clou
-00010a30: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
-00010a40: 6e64 6c65 270a 2920 2d3e 204c 6973 745b  ndle'.) -> List[
-00010a50: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
-00010a60: 6572 5374 6174 7573 5d3a 0a20 2020 2022  erStatus]:.    "
-00010a70: 2222 5265 7475 726e 7320 7468 6520 7374  ""Returns the st
-00010a80: 6174 7573 206f 6620 7468 6520 636c 7573  atus of the clus
-00010a90: 7465 722e 0a0a 2020 2020 5261 6973 6573  ter...    Raises
-00010aa0: 3a0a 2020 2020 2020 2020 6578 6365 7074  :.        except
-00010ab0: 696f 6e73 2e43 6c75 7374 6572 5374 6174  ions.ClusterStat
-00010ac0: 7573 4665 7463 6869 6e67 4572 726f 723a  usFetchingError:
-00010ad0: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
-00010ae0: 7475 7320 6361 6e6e 6f74 2062 650a 2020  tus cannot be.  
-00010af0: 2020 2020 2020 2020 6665 7463 6865 6420          fetched 
-00010b00: 6672 6f6d 2074 6865 2063 6c6f 7564 2070  from the cloud p
-00010b10: 726f 7669 6465 722e 0a20 2020 2022 2222  rovider..    """
-00010b20: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
-00010b30: 655f 6f6e 5f63 6c6f 7564 203d 2068 616e  e_on_cloud = han
-00010b40: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
-00010b50: 5f6f 6e5f 636c 6f75 640a 2020 2020 636c  _on_cloud.    cl
-00010b60: 7573 7465 725f 6e61 6d65 5f69 6e5f 6869  uster_name_in_hi
-00010b70: 6e74 203d 2063 6f6d 6d6f 6e5f 7574 696c  nt = common_util
-00010b80: 732e 636c 7573 7465 725f 6e61 6d65 5f69  s.cluster_name_i
-00010b90: 6e5f 6869 6e74 280a 2020 2020 2020 2020  n_hint(.        
-00010ba0: 6861 6e64 6c65 2e63 6c75 7374 6572 5f6e  handle.cluster_n
-00010bb0: 616d 652c 2063 6c75 7374 6572 5f6e 616d  ame, cluster_nam
-00010bc0: 655f 6f6e 5f63 6c6f 7564 290a 2020 2020  e_on_cloud).    
-00010bd0: 2320 5573 6520 7265 6769 6f6e 2061 6e64  # Use region and
-00010be0: 207a 6f6e 6520 6672 6f6d 2074 6865 2063   zone from the c
-00010bf0: 6c75 7374 6572 2063 6f6e 6669 672c 2069  luster config, i
-00010c00: 6e73 7465 6164 206f 6620 7468 650a 2020  nstead of the.  
-00010c10: 2020 2320 6861 6e64 6c65 2e6c 6175 6e63    # handle.launc
-00010c20: 6865 645f 7265 736f 7572 6365 732c 2062  hed_resources, b
-00010c30: 6563 6175 7365 2074 6865 206c 6174 7465  ecause the latte
-00010c40: 7220 6d61 7920 6e6f 7420 6265 2073 6574  r may not be set
-00010c50: 0a20 2020 2023 2063 6f72 7265 6374 6c79  .    # correctly
-00010c60: 2079 6574 2e0a 2020 2020 7261 795f 636f   yet..    ray_co
-00010c70: 6e66 6967 203d 2063 6f6d 6d6f 6e5f 7574  nfig = common_ut
-00010c80: 696c 732e 7265 6164 5f79 616d 6c28 6861  ils.read_yaml(ha
-00010c90: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
-00010ca0: 6c29 0a20 2020 2070 726f 7669 6465 725f  l).    provider_
-00010cb0: 636f 6e66 6967 203d 2072 6179 5f63 6f6e  config = ray_con
-00010cc0: 6669 675b 2770 726f 7669 6465 7227 5d0a  fig['provider'].
-00010cd0: 0a20 2020 2023 2051 7565 7279 2074 6865  .    # Query the
-00010ce0: 2063 6c6f 7564 2070 726f 7669 6465 722e   cloud provider.
-00010cf0: 0a20 2020 2023 2054 4f44 4f28 7375 7175  .    # TODO(suqu
-00010d00: 6172 6b29 3a20 6d6f 7665 2069 6d70 6c65  ark): move imple
-00010d10: 6d65 6e74 6174 696f 6e73 206f 6620 6d6f  mentations of mo
-00010d20: 7265 2063 6c6f 7564 7320 6865 7265 0a20  re clouds here. 
-00010d30: 2020 2063 6c6f 7564 203d 2068 616e 646c     cloud = handl
-00010d40: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
-00010d50: 7263 6573 2e63 6c6f 7564 0a20 2020 2061  rces.cloud.    a
-00010d60: 7373 6572 7420 636c 6f75 6420 6973 206e  ssert cloud is n
-00010d70: 6f74 204e 6f6e 652c 2068 616e 646c 650a  ot None, handle.
-00010d80: 2020 2020 6966 2063 6c6f 7564 2e53 5441      if cloud.STA
-00010d90: 5455 535f 5645 5253 494f 4e20 3e3d 2063  TUS_VERSION >= c
-00010da0: 6c6f 7564 732e 5374 6174 7573 5665 7273  louds.StatusVers
-00010db0: 696f 6e2e 534b 5950 494c 4f54 3a0a 2020  ion.SKYPILOT:.  
-00010dc0: 2020 2020 2020 636c 6f75 645f 6e61 6d65        cloud_name
-00010dd0: 203d 2072 6570 7228 6861 6e64 6c65 2e6c   = repr(handle.l
-00010de0: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
-00010df0: 732e 636c 6f75 6429 0a20 2020 2020 2020  s.cloud).       
-00010e00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00010e10: 2020 6e6f 6465 5f73 7461 7475 735f 6469    node_status_di
-00010e20: 6374 203d 2070 726f 7669 7369 6f6e 5f6c  ct = provision_l
-00010e30: 6962 2e71 7565 7279 5f69 6e73 7461 6e63  ib.query_instanc
-00010e40: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-00010e50: 2020 2020 636c 6f75 645f 6e61 6d65 2c20      cloud_name, 
-00010e60: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00010e70: 636c 6f75 642c 2070 726f 7669 6465 725f  cloud, provider_
-00010e80: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-00010e90: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00010ea0: 2866 2751 7565 7279 696e 6720 7b63 6c6f  (f'Querying {clo
-00010eb0: 7564 5f6e 616d 657d 2063 6c75 7374 6572  ud_name} cluster
-00010ec0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00010ed0: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
-00010ee0: 6c75 7374 6572 5f6e 616d 655f 696e 5f68  luster_name_in_h
-00010ef0: 696e 747d 2027 0a20 2020 2020 2020 2020  int} '.         
-00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f10: 6627 7374 6174 7573 3a5c 6e7b 7070 7269  f'status:\n{ppri
-00010f20: 6e74 2e70 666f 726d 6174 286e 6f64 655f  nt.pformat(node_
-00010f30: 7374 6174 7573 5f64 6963 7429 7d27 290a  status_dict)}').
-00010f40: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00010f50: 5f73 7461 7475 7365 7320 3d20 6c69 7374  _statuses = list
-00010f60: 286e 6f64 655f 7374 6174 7573 5f64 6963  (node_status_dic
-00010f70: 742e 7661 6c75 6573 2829 290a 2020 2020  t.values()).    
-00010f80: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00010f90: 7469 6f6e 2061 7320 653a 2020 2320 7079  tion as e:  # py
-00010fa0: 6c69 6e74 3a20 6469 7361 626c 653d 6272  lint: disable=br
-00010fb0: 6f61 642d 6578 6365 7074 0a20 2020 2020  oad-except.     
-00010fc0: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
-00010fd0: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
-00010fe0: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
-00010ff0: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
-00011000: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-00011010: 7469 6f6e 732e 436c 7573 7465 7253 7461  tions.ClusterSta
-00011020: 7475 7346 6574 6368 696e 6745 7272 6f72  tusFetchingError
-00011030: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011040: 2020 2020 2020 6627 4661 696c 6564 2074        f'Failed t
-00011050: 6f20 7175 6572 7920 7b63 6c6f 7564 5f6e  o query {cloud_n
-00011060: 616d 657d 2063 6c75 7374 6572 2027 0a20  ame} cluster '. 
-00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011080: 2020 2066 277b 636c 7573 7465 725f 6e61     f'{cluster_na
-00011090: 6d65 5f69 6e5f 6869 6e74 7d20 270a 2020  me_in_hint} '.  
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110b0: 2020 6627 7374 6174 7573 3a20 7b63 6f6d    f'status: {com
-000110c0: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
-000110d0: 5f65 7863 6570 7469 6f6e 2865 2c20 7573  _exception(e, us
-000110e0: 655f 6272 6163 6b65 743d 5472 7565 297d  e_bracket=True)}
-000110f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00011100: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
-00011110: 2020 2020 2020 7265 6769 6f6e 203d 2070        region = p
-00011120: 726f 7669 6465 725f 636f 6e66 6967 2e67  rovider_config.g
-00011130: 6574 2827 7265 6769 6f6e 2729 206f 7220  et('region') or 
-00011140: 7072 6f76 6964 6572 5f63 6f6e 6669 672e  provider_config.
-00011150: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00011160: 2027 6c6f 6361 7469 6f6e 2729 0a20 2020   'location').   
-00011170: 2020 2020 207a 6f6e 6520 3d20 7261 795f       zone = ray_
-00011180: 636f 6e66 6967 5b27 7072 6f76 6964 6572  config['provider
-00011190: 275d 2e67 6574 2827 6176 6169 6c61 6269  '].get('availabi
-000111a0: 6c69 7479 5f7a 6f6e 6527 290a 2020 2020  lity_zone').    
-000111b0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
-000111c0: 7320 3d20 636c 6f75 642e 7175 6572 795f  s = cloud.query_
-000111d0: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
-000111e0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-000111f0: 5f6f 6e5f 636c 6f75 642c 0a20 2020 2020  _on_cloud,.     
-00011200: 2020 2020 2020 2074 6167 5f66 696c 7465         tag_filte
-00011210: 725f 666f 725f 636c 7573 7465 7228 636c  r_for_cluster(cl
-00011220: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00011230: 6f75 6429 2c20 7265 6769 6f6e 2c20 7a6f  oud), region, zo
-00011240: 6e65 290a 2020 2020 7265 7475 726e 206e  ne).    return n
-00011250: 6f64 655f 7374 6174 7573 6573 0a0a 0a64  ode_statuses...d
-00011260: 6566 2063 6865 636b 5f63 616e 5f63 6c6f  ef check_can_clo
-00011270: 6e65 5f64 6973 6b5f 616e 645f 6f76 6572  ne_disk_and_over
-00011280: 7269 6465 5f74 6173 6b28 0a20 2020 2063  ride_task(.    c
-00011290: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
-000112a0: 2c20 7461 7267 6574 5f63 6c75 7374 6572  , target_cluster
-000112b0: 5f6e 616d 653a 204f 7074 696f 6e61 6c5b  _name: Optional[
-000112c0: 7374 725d 2c20 7461 736b 3a20 2774 6173  str], task: 'tas
-000112d0: 6b5f 6c69 622e 5461 736b 270a 2920 2d3e  k_lib.Task'.) ->
-000112e0: 2054 7570 6c65 5b27 7461 736b 5f6c 6962   Tuple['task_lib
-000112f0: 2e54 6173 6b27 2c20 2763 6c6f 7564 5f76  .Task', 'cloud_v
-00011300: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
-00011310: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
-00011320: 4861 6e64 6c65 275d 3a0a 2020 2020 2222  Handle']:.    ""
-00011330: 2243 6865 636b 2069 6620 7468 6520 7461  "Check if the ta
-00011340: 736b 2069 7320 636f 6d70 6174 6962 6c65  sk is compatible
-00011350: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
-00011360: 726f 6d20 7468 6520 736f 7572 6365 2063  rom the source c
-00011370: 6c75 7374 6572 2e0a 0a20 2020 2041 7267  luster...    Arg
-00011380: 733a 0a20 2020 2020 2020 2063 6c75 7374  s:.        clust
-00011390: 6572 5f6e 616d 653a 2054 6865 206e 616d  er_name: The nam
-000113a0: 6520 6f66 2074 6865 2063 6c75 7374 6572  e of the cluster
-000113b0: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
-000113c0: 726f 6d2e 0a20 2020 2020 2020 2074 6172  rom..        tar
-000113d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000113e0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
-000113f0: 6520 7461 7267 6574 2063 6c75 7374 6572  e target cluster
-00011400: 2e0a 2020 2020 2020 2020 7461 736b 3a20  ..        task: 
-00011410: 5468 6520 7461 736b 2074 6f20 6368 6563  The task to chec
-00011420: 6b2e 0a0a 2020 2020 5265 7475 726e 733a  k...    Returns:
-00011430: 0a20 2020 2020 2020 2054 6865 2074 6173  .        The tas
-00011440: 6b20 746f 2075 7365 2061 6e64 2074 6865  k to use and the
-00011450: 2072 6573 6f75 7263 6520 6861 6e64 6c65   resource handle
-00011460: 206f 6620 7468 6520 736f 7572 6365 2063   of the source c
-00011470: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
-00011480: 7365 733a 0a20 2020 2020 2020 2056 616c  ses:.        Val
-00011490: 7565 4572 726f 723a 2049 6620 7468 6520  ueError: If the 
-000114a0: 736f 7572 6365 2063 6c75 7374 6572 2064  source cluster d
-000114b0: 6f65 7320 6e6f 7420 6578 6973 742e 0a20  oes not exist.. 
-000114c0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-000114d0: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
-000114e0: 726f 723a 2049 6620 7468 6520 736f 7572  ror: If the sour
-000114f0: 6365 2063 6c75 7374 6572 2069 7320 6e6f  ce cluster is no
-00011500: 7420 7661 6c69 6420 6f72 2074 6865 0a20  t valid or the. 
-00011510: 2020 2020 2020 2020 2020 2074 6173 6b20             task 
-00011520: 6973 206e 6f74 2063 6f6d 7061 7469 626c  is not compatibl
-00011530: 6520 746f 2063 6c6f 6e65 2064 6973 6b20  e to clone disk 
-00011540: 6672 6f6d 2074 6865 2073 6f75 7263 6520  from the source 
-00011550: 636c 7573 7465 722e 0a20 2020 2022 2222  cluster..    """
-00011560: 0a20 2020 2073 6f75 7263 655f 636c 7573  .    source_clus
-00011570: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
-00011580: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
-00011590: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
-000115a0: 6c65 2863 6c75 7374 6572 5f6e 616d 6529  le(cluster_name)
-000115b0: 0a20 2020 2069 6620 736f 7572 6365 5f63  .    if source_c
-000115c0: 6c75 7374 6572 5f73 7461 7475 7320 6973  luster_status is
-000115d0: 204e 6f6e 653a 0a20 2020 2020 2020 2077   None:.        w
-000115e0: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-000115f0: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-00011600: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-00011610: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00011620: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-00011630: 2020 2020 2020 2020 2020 2066 2743 616e             f'Can
-00011640: 6e6f 7420 6669 6e64 2063 6c75 7374 6572  not find cluster
-00011650: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
-00011660: 7d20 746f 2063 6c6f 6e65 2064 6973 6b20  } to clone disk 
-00011670: 6672 6f6d 2e27 290a 0a20 2020 2069 6620  from.')..    if 
-00011680: 6e6f 7420 6973 696e 7374 616e 6365 2868  not isinstance(h
-00011690: 616e 646c 652c 2062 6163 6b65 6e64 732e  andle, backends.
-000116a0: 436c 6f75 6456 6d52 6179 5265 736f 7572  CloudVmRayResour
-000116b0: 6365 4861 6e64 6c65 293a 0a20 2020 2020  ceHandle):.     
-000116c0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-000116d0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-000116e0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-000116f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00011700: 7365 2065 7863 6570 7469 6f6e 732e 4e6f  se exceptions.No
-00011710: 7453 7570 706f 7274 6564 4572 726f 7228  tSupportedError(
-00011720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011730: 2066 2743 616e 6e6f 7420 636c 6f6e 6520   f'Cannot clone 
-00011740: 6469 736b 2066 726f 6d20 6120 6e6f 6e2d  disk from a non-
-00011750: 636c 6f75 6420 636c 7573 7465 7220 7b63  cloud cluster {c
-00011760: 6c75 7374 6572 5f6e 616d 6521 727d 2e27  luster_name!r}.'
-00011770: 290a 0a20 2020 2069 6620 736f 7572 6365  )..    if source
-00011780: 5f63 6c75 7374 6572 5f73 7461 7475 7320  _cluster_status 
-00011790: 213d 2073 7461 7475 735f 6c69 622e 436c  != status_lib.Cl
-000117a0: 7573 7465 7253 7461 7475 732e 5354 4f50  usterStatus.STOP
-000117b0: 5045 443a 0a20 2020 2020 2020 2077 6974  PED:.        wit
-000117c0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-000117d0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-000117e0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-000117f0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-00011800: 6570 7469 6f6e 732e 4e6f 7453 7570 706f  eptions.NotSuppo
-00011810: 7274 6564 4572 726f 7228 0a20 2020 2020  rtedError(.     
-00011820: 2020 2020 2020 2020 2020 2066 2743 616e             f'Can
-00011830: 6e6f 7420 636c 6f6e 6520 6469 736b 2066  not clone disk f
-00011840: 726f 6d20 636c 7573 7465 7220 7b63 6c75  rom cluster {clu
-00011850: 7374 6572 5f6e 616d 6521 727d 2027 0a20  ster_name!r} '. 
-00011860: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011870: 2728 7b73 6f75 7263 655f 636c 7573 7465  '({source_cluste
-00011880: 725f 7374 6174 7573 2172 7d29 2e20 506c  r_status!r}). Pl
-00011890: 6561 7365 2073 746f 7020 7468 6520 270a  ease stop the '.
-000118a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118b0: 6627 636c 7573 7465 7220 6669 7273 743a  f'cluster first:
-000118c0: 2073 6b79 2073 746f 7020 7b63 6c75 7374   sky stop {clust
-000118d0: 6572 5f6e 616d 657d 2729 0a0a 2020 2020  er_name}')..    
-000118e0: 6966 2074 6172 6765 745f 636c 7573 7465  if target_cluste
-000118f0: 725f 6e61 6d65 2069 7320 6e6f 7420 4e6f  r_name is not No
-00011900: 6e65 3a0a 2020 2020 2020 2020 7461 7267  ne:.        targ
-00011910: 6574 5f63 6c75 7374 6572 5f73 7461 7475  et_cluster_statu
-00011920: 732c 205f 203d 2072 6566 7265 7368 5f63  s, _ = refresh_c
-00011930: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
-00011940: 6e64 6c65 280a 2020 2020 2020 2020 2020  ndle(.          
-00011950: 2020 7461 7267 6574 5f63 6c75 7374 6572    target_cluster
-00011960: 5f6e 616d 6529 0a20 2020 2020 2020 2069  _name).        i
-00011970: 6620 7461 7267 6574 5f63 6c75 7374 6572  f target_cluster
-00011980: 5f73 7461 7475 7320 6973 206e 6f74 204e  _status is not N
-00011990: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000119a0: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-000119b0: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-000119c0: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-000119d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000119e0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-000119f0: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
-00011a00: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00011a10: 2020 2020 2020 2066 2754 6865 2074 6172         f'The tar
-00011a20: 6765 7420 636c 7573 7465 7220 7b74 6172  get cluster {tar
-00011a30: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00011a40: 2172 7d20 616c 7265 6164 7920 6578 6973  !r} already exis
-00011a50: 7473 2e20 436c 6f6e 696e 6720 270a 2020  ts. Cloning '.  
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a70: 2020 2764 6973 6b20 6973 206f 6e6c 7920    'disk is only 
-00011a80: 7375 7070 6f72 7465 6420 7768 656e 2063  supported when c
-00011a90: 7265 6174 696e 6720 6120 6e65 7720 636c  reating a new cl
-00011aa0: 7573 7465 722e 2054 6f20 6669 783a 2073  uster. To fix: s
-00011ab0: 7065 6369 6679 2027 0a20 2020 2020 2020  pecify '.       
-00011ac0: 2020 2020 2020 2020 2020 2020 2027 6120               'a 
-00011ad0: 6e65 7720 7461 7267 6574 2063 6c75 7374  new target clust
-00011ae0: 6572 206e 616d 652e 2729 0a0a 2020 2020  er name.')..    
-00011af0: 6e65 775f 7461 736b 5f72 6573 6f75 7263  new_task_resourc
-00011b00: 6573 203d 205b 5d0a 2020 2020 6f72 6967  es = [].    orig
-00011b10: 696e 616c 5f63 6c6f 7564 203d 2068 616e  inal_cloud = han
-00011b20: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00011b30: 6f75 7263 6573 2e63 6c6f 7564 0a20 2020  ources.cloud.   
-00011b40: 206f 7269 6769 6e61 6c5f 636c 6f75 642e   original_cloud.
-00011b50: 6368 6563 6b5f 6665 6174 7572 6573 5f61  check_features_a
-00011b60: 7265 5f73 7570 706f 7274 6564 280a 2020  re_supported(.  
-00011b70: 2020 2020 2020 6861 6e64 6c65 2e6c 6175        handle.lau
-00011b80: 6e63 6865 645f 7265 736f 7572 6365 732c  nched_resources,
-00011b90: 0a20 2020 2020 2020 207b 636c 6f75 6473  .        {clouds
-00011ba0: 2e43 6c6f 7564 496d 706c 656d 656e 7461  .CloudImplementa
-00011bb0: 7469 6f6e 4665 6174 7572 6573 2e43 4c4f  tionFeatures.CLO
-00011bc0: 4e45 5f44 4953 4b5f 4652 4f4d 5f43 4c55  NE_DISK_FROM_CLU
-00011bd0: 5354 4552 7d29 0a0a 2020 2020 6173 7365  STER})..    asse
-00011be0: 7274 206f 7269 6769 6e61 6c5f 636c 6f75  rt original_clou
-00011bf0: 6420 6973 206e 6f74 204e 6f6e 652c 2068  d is not None, h
-00011c00: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
-00011c10: 6573 6f75 7263 6573 0a20 2020 2068 6173  esources.    has
-00011c20: 5f6f 7665 7272 6964 6520 3d20 4661 6c73  _override = Fals
-00011c30: 650a 2020 2020 6861 735f 6469 736b 5f73  e.    has_disk_s
-00011c40: 697a 655f 6d65 7420 3d20 4661 6c73 650a  ize_met = False.
-00011c50: 2020 2020 6861 735f 636c 6f75 645f 6d65      has_cloud_me
-00011c60: 7420 3d20 4661 6c73 650a 2020 2020 666f  t = False.    fo
-00011c70: 7220 7461 736b 5f72 6573 6f75 7263 6573  r task_resources
-00011c80: 2069 6e20 7461 736b 2e72 6573 6f75 7263   in task.resourc
-00011c90: 6573 3a0a 2020 2020 2020 2020 6966 2068  es:.        if h
-00011ca0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
-00011cb0: 6573 6f75 7263 6573 2e64 6973 6b5f 7369  esources.disk_si
-00011cc0: 7a65 203e 2074 6173 6b5f 7265 736f 7572  ze > task_resour
-00011cd0: 6365 732e 6469 736b 5f73 697a 653a 0a20  ces.disk_size:. 
-00011ce0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00011cf0: 2074 6172 6765 7420 636c 7573 7465 7227   target cluster'
-00011d00: 7320 6469 736b 2073 686f 756c 6420 6265  s disk should be
-00011d10: 2061 7420 6c65 6173 7420 6173 206c 6172   at least as lar
-00011d20: 6765 2061 7320 7468 6520 736f 7572 6365  ge as the source
-00011d30: 2e0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-00011d40: 6e74 696e 7565 0a20 2020 2020 2020 2068  ntinue.        h
-00011d50: 6173 5f64 6973 6b5f 7369 7a65 5f6d 6574  as_disk_size_met
-00011d60: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00011d70: 6966 2074 6173 6b5f 7265 736f 7572 6365  if task_resource
-00011d80: 732e 636c 6f75 6420 6973 206e 6f74 204e  s.cloud is not N
-00011d90: 6f6e 6520 616e 6420 6e6f 7420 6f72 6967  one and not orig
-00011da0: 696e 616c 5f63 6c6f 7564 2e69 735f 7361  inal_cloud.is_sa
-00011db0: 6d65 5f63 6c6f 7564 280a 2020 2020 2020  me_cloud(.      
-00011dc0: 2020 2020 2020 2020 2020 7461 736b 5f72            task_r
-00011dd0: 6573 6f75 7263 6573 2e63 6c6f 7564 293a  esources.cloud):
-00011de0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00011df0: 7469 6e75 650a 2020 2020 2020 2020 6861  tinue.        ha
-00011e00: 735f 636c 6f75 645f 6d65 7420 3d20 5472  s_cloud_met = Tr
-00011e10: 7565 0a0a 2020 2020 2020 2020 6f76 6572  ue..        over
-00011e20: 7269 6465 5f70 6172 616d 203d 207b 7d0a  ride_param = {}.
-00011e30: 2020 2020 2020 2020 6966 2074 6173 6b5f          if task_
-00011e40: 7265 736f 7572 6365 732e 636c 6f75 6420  resources.cloud 
-00011e50: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00011e60: 2020 2020 206f 7665 7272 6964 655f 7061       override_pa
-00011e70: 7261 6d5b 2763 6c6f 7564 275d 203d 206f  ram['cloud'] = o
-00011e80: 7269 6769 6e61 6c5f 636c 6f75 640a 2020  riginal_cloud.  
-00011e90: 2020 2020 2020 6966 2074 6173 6b5f 7265        if task_re
-00011ea0: 736f 7572 6365 732e 7265 6769 6f6e 2069  sources.region i
-00011eb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00011ec0: 2020 2020 6f76 6572 7269 6465 5f70 6172      override_par
-00011ed0: 616d 5b27 7265 6769 6f6e 275d 203d 2068  am['region'] = h
-00011ee0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
-00011ef0: 6573 6f75 7263 6573 2e72 6567 696f 6e0a  esources.region.
-00011f00: 0a20 2020 2020 2020 2069 6620 6f76 6572  .        if over
-00011f10: 7269 6465 5f70 6172 616d 3a0a 2020 2020  ride_param:.    
-00011f20: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00011f30: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-00011f40: 2020 2020 2066 274e 6f20 636c 6f75 642f       f'No cloud/
-00011f50: 7265 6769 6f6e 2073 7065 6369 6669 6564  region specified
-00011f60: 2066 6f72 2074 6865 2074 6173 6b20 7b74   for the task {t
-00011f70: 6173 6b5f 7265 736f 7572 6365 737d 2e20  ask_resources}. 
-00011f80: 5573 696e 6720 7468 6520 7361 6d65 2072  Using the same r
-00011f90: 6567 696f 6e20 270a 2020 2020 2020 2020  egion '.        
-00011fa0: 2020 2020 2020 2020 6627 6173 2073 6f75          f'as sou
-00011fb0: 7263 6520 636c 7573 7465 7220 7b63 6c75  rce cluster {clu
-00011fc0: 7374 6572 5f6e 616d 6521 727d 3a20 270a  ster_name!r}: '.
-00011fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011fe0: 6627 7b68 616e 646c 652e 6c61 756e 6368  f'{handle.launch
-00011ff0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
-00012000: 7564 7d27 0a20 2020 2020 2020 2020 2020  ud}'.           
-00012010: 2020 2020 2066 2728 7b68 616e 646c 652e       f'({handle.
-00012020: 6c61 756e 6368 6564 5f72 6573 6f75 7263  launched_resourc
-00012030: 6573 2e72 6567 696f 6e7d 292e 2729 0a20  es.region}).'). 
-00012040: 2020 2020 2020 2020 2020 2068 6173 5f6f             has_o
-00012050: 7665 7272 6964 6520 3d20 5472 7565 0a20  verride = True. 
-00012060: 2020 2020 2020 2074 6173 6b5f 7265 736f         task_reso
-00012070: 7572 6365 7320 3d20 7461 736b 5f72 6573  urces = task_res
-00012080: 6f75 7263 6573 2e63 6f70 7928 2a2a 6f76  ources.copy(**ov
-00012090: 6572 7269 6465 5f70 6172 616d 290a 2020  erride_param).  
-000120a0: 2020 2020 2020 6e65 775f 7461 736b 5f72        new_task_r
-000120b0: 6573 6f75 7263 6573 2e61 7070 656e 6428  esources.append(
-000120c0: 7461 736b 5f72 6573 6f75 7263 6573 290a  task_resources).
-000120d0: 0a20 2020 2069 6620 6e6f 7420 6e65 775f  .    if not new_
-000120e0: 7461 736b 5f72 6573 6f75 7263 6573 3a0a  task_resources:.
-000120f0: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-00012100: 6173 5f64 6973 6b5f 7369 7a65 5f6d 6574  as_disk_size_met
-00012110: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00012120: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
-00012130: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
-00012140: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
-00012150: 2020 2020 2020 2020 2020 2020 7461 7267              targ
-00012160: 6574 5f63 6c75 7374 6572 5f6e 616d 655f  et_cluster_name_
-00012170: 7374 7220 3d20 6627 207b 7461 7267 6574  str = f' {target
-00012180: 5f63 6c75 7374 6572 5f6e 616d 6521 727d  _cluster_name!r}
-00012190: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000121a0: 2020 6966 2074 6172 6765 745f 636c 7573    if target_clus
-000121b0: 7465 725f 6e61 6d65 2069 7320 4e6f 6e65  ter_name is None
-000121c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000121d0: 2020 2020 2020 7461 7267 6574 5f63 6c75        target_clu
-000121e0: 7374 6572 5f6e 616d 655f 7374 7220 3d20  ster_name_str = 
-000121f0: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
-00012200: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
-00012210: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
-00012220: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00012230: 2020 2020 2020 2020 2020 2066 2754 6865             f'The
-00012240: 2074 6172 6765 7420 636c 7573 7465 727b   target cluster{
-00012250: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
-00012260: 616d 655f 7374 727d 2073 686f 756c 6420  ame_str} should 
-00012270: 6861 7665 2061 2064 6973 6b20 7369 7a65  have a disk size
-00012280: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00012290: 2020 2020 2020 2066 276f 6620 6174 206c         f'of at l
-000122a0: 6561 7374 207b 6861 6e64 6c65 2e6c 6175  east {handle.lau
-000122b0: 6e63 6865 645f 7265 736f 7572 6365 732e  nched_resources.
-000122c0: 6469 736b 5f73 697a 657d 2047 4220 746f  disk_size} GB to
-000122d0: 2063 6c6f 6e65 2074 6865 2027 0a20 2020   clone the '.   
-000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122f0: 2066 2764 6973 6b20 6672 6f6d 207b 636c   f'disk from {cl
-00012300: 7573 7465 725f 6e61 6d65 2172 7d2e 2729  uster_name!r}.')
-00012310: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00012320: 6861 735f 636c 6f75 645f 6d65 743a 0a20  has_cloud_met:. 
-00012330: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
-00012340: 7265 736f 7572 6365 735f 636c 6f75 645f  resources_cloud_
-00012350: 7374 7220 3d20 275b 2720 2b20 272c 272e  str = '[' + ','.
-00012360: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00012370: 2020 2020 2020 5b66 277b 7265 732e 636c        [f'{res.cl
-00012380: 6f75 647d 2720 666f 7220 7265 7320 696e  oud}' for res in
-00012390: 2074 6173 6b2e 7265 736f 7572 6365 735d   task.resources]
-000123a0: 2920 2b20 275d 270a 2020 2020 2020 2020  ) + ']'.        
-000123b0: 2020 2020 7461 736b 5f72 6573 6f75 7263      task_resourc
-000123c0: 6573 5f73 7472 203d 2027 5b27 202b 2027  es_str = '[' + '
-000123d0: 2c27 2e6a 6f69 6e28 0a20 2020 2020 2020  ,'.join(.       
-000123e0: 2020 2020 2020 2020 205b 6627 7b72 6573           [f'{res
-000123f0: 7d27 2066 6f72 2072 6573 2069 6e20 7461  }' for res in ta
-00012400: 736b 2e72 6573 6f75 7263 6573 5d29 202b  sk.resources]) +
-00012410: 2027 5d27 0a20 2020 2020 2020 2020 2020   ']'.           
-00012420: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-00012430: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-00012440: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-00012450: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012460: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00012470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012480: 2020 2020 2066 2743 616e 6e6f 7420 636c       f'Cannot cl
-00012490: 6f6e 6520 6469 736b 2061 6372 6f73 7320  one disk across 
-000124a0: 636c 6f75 6420 6672 6f6d 207b 6f72 6967  cloud from {orig
-000124b0: 696e 616c 5f63 6c6f 7564 7d20 746f 2027  inal_cloud} to '
-000124c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000124d0: 2020 2020 2066 277b 7461 736b 5f72 6573       f'{task_res
-000124e0: 6f75 7263 6573 5f63 6c6f 7564 5f73 7472  ources_cloud_str
-000124f0: 7d20 666f 7220 7265 736f 7572 6365 7320  } for resources 
-00012500: 7b74 6173 6b5f 7265 736f 7572 6365 735f  {task_resources_
-00012510: 7374 727d 2e27 0a20 2020 2020 2020 2020  str}.'.         
-00012520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00012530: 2061 7373 6572 7420 4661 6c73 652c 2027   assert False, '
-00012540: 5368 6f75 6c64 206e 6f74 2072 6561 6368  Should not reach
-00012550: 2068 6572 652e 270a 2020 2020 2320 7365   here.'.    # se
-00012560: 7420 7468 6520 6e65 775f 7461 736b 5f72  t the new_task_r
-00012570: 6573 6f75 7263 6573 2074 6f20 6265 2074  esources to be t
-00012580: 6865 2073 616d 6520 7479 7065 2028 6c69  he same type (li
-00012590: 7374 206f 7220 7365 7429 2061 7320 7468  st or set) as th
-000125a0: 650a 2020 2020 2320 6f72 6967 696e 616c  e.    # original
-000125b0: 2074 6173 6b2e 7265 736f 7572 6365 730a   task.resources.
-000125c0: 2020 2020 6966 2068 6173 5f6f 7665 7272      if has_overr
-000125d0: 6964 653a 0a20 2020 2020 2020 2074 6173  ide:.        tas
-000125e0: 6b2e 7365 745f 7265 736f 7572 6365 7328  k.set_resources(
-000125f0: 7479 7065 2874 6173 6b2e 7265 736f 7572  type(task.resour
-00012600: 6365 7329 286e 6577 5f74 6173 6b5f 7265  ces)(new_task_re
-00012610: 736f 7572 6365 7329 290a 2020 2020 2020  sources)).      
-00012620: 2020 2320 5265 7365 7420 7468 6520 6265    # Reset the be
-00012630: 7374 5f72 6573 6f75 7263 6573 2074 6f20  st_resources to 
-00012640: 7472 6967 6572 2072 652d 6f70 7469 6d69  triger re-optimi
-00012650: 7a61 7469 6f6e 0a20 2020 2020 2020 2023  zation.        #
-00012660: 206c 6174 6572 2c20 736f 2074 6861 7420   later, so that 
-00012670: 7468 6520 6e65 7720 7461 736b 5f72 6573  the new task_res
-00012680: 6f75 7263 6573 2077 696c 6c20 6265 2075  ources will be u
-00012690: 7365 642e 0a20 2020 2020 2020 2074 6173  sed..        tas
-000126a0: 6b2e 6265 7374 5f72 6573 6f75 7263 6573  k.best_resources
-000126b0: 203d 204e 6f6e 650a 2020 2020 7265 7475   = None.    retu
-000126c0: 726e 2074 6173 6b2c 2068 616e 646c 650a  rn task, handle.
-000126d0: 0a0a 6465 6620 5f75 7064 6174 655f 636c  ..def _update_cl
-000126e0: 7573 7465 725f 7374 6174 7573 5f6e 6f5f  uster_status_no_
-000126f0: 6c6f 636b 280a 2020 2020 2020 2020 636c  lock(.        cl
-00012700: 7573 7465 725f 6e61 6d65 3a20 7374 7229  uster_name: str)
-00012710: 202d 3e20 4f70 7469 6f6e 616c 5b44 6963   -> Optional[Dic
-00012720: 745b 7374 722c 2041 6e79 5d5d 3a0a 2020  t[str, Any]]:.  
-00012730: 2020 2222 2255 7064 6174 6573 2074 6865    """Updates the
-00012740: 2073 7461 7475 7320 6f66 2074 6865 2063   status of the c
-00012750: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
-00012760: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
-00012770: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00012780: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00012790: 6f72 3a20 7468 6520 636c 7573 7465 7220  or: the cluster 
-000127a0: 7374 6174 7573 2063 616e 6e6f 7420 6265  status cannot be
-000127b0: 0a20 2020 2020 2020 2020 2066 6574 6368  .          fetch
-000127c0: 6564 2066 726f 6d20 7468 6520 636c 6f75  ed from the clou
-000127d0: 6420 7072 6f76 6964 6572 2e0a 2020 2020  d provider..    
-000127e0: 2222 220a 2020 2020 7265 636f 7264 203d  """.    record =
-000127f0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-00012800: 7465 2e67 6574 5f63 6c75 7374 6572 5f66  te.get_cluster_f
-00012810: 726f 6d5f 6e61 6d65 2863 6c75 7374 6572  rom_name(cluster
-00012820: 5f6e 616d 6529 0a20 2020 2069 6620 7265  _name).    if re
-00012830: 636f 7264 2069 7320 4e6f 6e65 3a0a 2020  cord is None:.  
-00012840: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00012850: 650a 2020 2020 6861 6e64 6c65 203d 2072  e.    handle = r
-00012860: 6563 6f72 645b 2768 616e 646c 6527 5d0a  ecord['handle'].
-00012870: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00012880: 7461 6e63 6528 6861 6e64 6c65 2c20 6261  tance(handle, ba
-00012890: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
-000128a0: 7952 6573 6f75 7263 6548 616e 646c 6529  yResourceHandle)
-000128b0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000128c0: 2072 6563 6f72 640a 2020 2020 636c 7573   record.    clus
-000128d0: 7465 725f 6e61 6d65 203d 2068 616e 646c  ter_name = handl
-000128e0: 652e 636c 7573 7465 725f 6e61 6d65 0a0a  e.cluster_name..
-000128f0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
-00012900: 7320 3d20 5f71 7565 7279 5f63 6c75 7374  s = _query_clust
-00012910: 6572 5f73 7461 7475 735f 7669 615f 636c  er_status_via_cl
-00012920: 6f75 645f 6170 6928 6861 6e64 6c65 290a  oud_api(handle).
-00012930: 0a20 2020 2061 6c6c 5f6e 6f64 6573 5f75  .    all_nodes_u
-00012940: 7020 3d20 2861 6c6c 280a 2020 2020 2020  p = (all(.      
-00012950: 2020 7374 6174 7573 203d 3d20 7374 6174    status == stat
-00012960: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-00012970: 6174 7573 2e55 5020 666f 7220 7374 6174  atus.UP for stat
-00012980: 7573 2069 6e20 6e6f 6465 5f73 7461 7475  us in node_statu
-00012990: 7365 7329 2061 6e64 0a20 2020 2020 2020  ses) and.       
-000129a0: 2020 2020 2020 2020 2020 2020 206c 656e               len
-000129b0: 286e 6f64 655f 7374 6174 7573 6573 2920  (node_statuses) 
-000129c0: 3d3d 2068 616e 646c 652e 6c61 756e 6368  == handle.launch
-000129d0: 6564 5f6e 6f64 6573 290a 0a20 2020 2064  ed_nodes)..    d
-000129e0: 6566 2072 756e 5f72 6179 5f73 7461 7475  ef run_ray_statu
-000129f0: 735f 746f 5f63 6865 636b 5f72 6179 5f63  s_to_check_ray_c
-00012a00: 6c75 7374 6572 5f68 6561 6c74 6879 2829  luster_healthy()
-00012a10: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00012a20: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00012a30: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-00012a40: 2054 6869 7320 6675 6e63 7469 6f6e 2063   This function c
-00012a50: 616e 6e6f 7420 6469 7374 696e 6775 6973  annot distinguis
-00012a60: 6820 7472 616e 7369 656e 7420 6e65 7477  h transient netw
-00012a70: 6f72 6b0a 2020 2020 2020 2020 2020 2020  ork.            
-00012a80: 2320 6572 726f 7220 696e 2072 6179 2773  # error in ray's
-00012a90: 2067 6574 2049 5073 2076 732e 2072 6179   get IPs vs. ray
-00012aa0: 2072 756e 7469 6d65 2066 6169 6c69 6e67   runtime failing
-00012ab0: 2e0a 0a20 2020 2020 2020 2020 2020 2023  ...            #
-00012ac0: 204e 4f54 453a 2066 6574 6368 696e 6720   NOTE: fetching 
-00012ad0: 7468 6520 4950 7320 6973 2076 6572 7920  the IPs is very 
-00012ae0: 736c 6f77 2061 7320 6974 2063 616c 6c73  slow as it calls
-00012af0: 2069 6e74 6f0a 2020 2020 2020 2020 2020   into.          
-00012b00: 2020 2320 6072 6179 2067 6574 2068 6561    # `ray get hea
-00012b10: 642d 6970 2f77 6f72 6b65 722d 6970 7360  d-ip/worker-ips`
-00012b20: 2e20 5573 696e 6720 6361 6368 6564 2049  . Using cached I
-00012b30: 5073 2069 7320 7361 6665 2062 6563 6175  Ps is safe becau
-00012b40: 7365 0a20 2020 2020 2020 2020 2020 2023  se.            #
-00012b50: 2069 6e20 7468 6520 776f 7273 7420 6361   in the worst ca
-00012b60: 7365 2077 6520 7469 6d65 206f 7574 2069  se we time out i
-00012b70: 6e20 7468 6520 6072 6179 2073 7461 7475  n the `ray statu
-00012b80: 7360 2053 5348 2063 6f6d 6d61 6e64 0a20  s` SSH command. 
-00012b90: 2020 2020 2020 2020 2020 2023 2062 656c             # bel
-00012ba0: 6f77 2e0a 2020 2020 2020 2020 2020 2020  ow..            
-00012bb0: 6578 7465 726e 616c 5f69 7073 203d 2068  external_ips = h
-00012bc0: 616e 646c 652e 6361 6368 6564 5f65 7874  andle.cached_ext
-00012bd0: 6572 6e61 6c5f 6970 730a 2020 2020 2020  ernal_ips.      
-00012be0: 2020 2020 2020 2320 5468 6973 2068 6170        # This hap
-00012bf0: 7065 6e73 2077 6865 6e20 7573 6572 2069  pens when user i
-00012c00: 6e74 6572 7275 7074 2074 6865 2060 736b  nterrupt the `sk
-00012c10: 7920 6c61 756e 6368 6020 7072 6f63 6573  y launch` proces
-00012c20: 7320 6265 666f 7265 0a20 2020 2020 2020  s before.       
-00012c30: 2020 2020 2023 2074 6865 2066 6972 7374       # the first
-00012c40: 2074 696d 6520 7265 736f 7572 6365 7320   time resources 
-00012c50: 6861 6e64 6c65 2069 7320 7772 6974 7465  handle is writte
-00012c60: 6e20 6261 636b 2074 6f20 6c6f 6361 6c20  n back to local 
-00012c70: 6461 7461 6261 7365 2e0a 2020 2020 2020  database..      
-00012c80: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
-00012c90: 6865 6c70 6675 6c20 7768 656e 2075 7365  helpful when use
-00012ca0: 7220 696e 7465 7272 7570 7420 6166 7465  r interrupt afte
-00012cb0: 7220 7468 6520 7072 6f76 6973 696f 6e20  r the provision 
-00012cc0: 6973 2064 6f6e 650a 2020 2020 2020 2020  is done.        
-00012cd0: 2020 2020 2320 616e 6420 6265 666f 7265      # and before
-00012ce0: 2074 6865 2073 6b79 6c65 7420 6973 2072   the skylet is r
-00012cf0: 6573 7461 7274 6564 2e20 4166 7465 7220  estarted. After 
-00012d00: 2332 3330 3420 6973 206d 6572 6765 642c  #2304 is merged,
-00012d10: 2074 6869 730a 2020 2020 2020 2020 2020   this.          
-00012d20: 2020 2320 6865 6c70 7320 6b65 6570 2074    # helps keep t
-00012d30: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
-00012d40: 7320 746f 2049 4e49 5420 6166 7465 7220  s to INIT after 
-00012d50: 6073 6b79 2073 7461 7475 7320 2d72 602c  `sky status -r`,
-00012d60: 2073 6f0a 2020 2020 2020 2020 2020 2020   so.            
-00012d70: 2320 7573 6572 2077 696c 6c20 6265 206e  # user will be n
-00012d80: 6f74 6966 6965 6420 7468 6174 2061 6e79  otified that any
-00012d90: 2061 7574 6f20 7374 6f70 2f64 6f77 6e20   auto stop/down 
-00012da0: 6d69 6768 7420 6e6f 7420 6265 0a20 2020  might not be.   
-00012db0: 2020 2020 2020 2020 2023 2074 7269 6767           # trigg
-00012dc0: 6572 6564 2e0a 2020 2020 2020 2020 2020  ered..          
-00012dd0: 2020 6966 2065 7874 6572 6e61 6c5f 6970    if external_ip
-00012de0: 7320 6973 204e 6f6e 6520 6f72 206c 656e  s is None or len
-00012df0: 2865 7874 6572 6e61 6c5f 6970 7329 203d  (external_ips) =
-00012e00: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00012e10: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00012e20: 6728 6627 5265 6672 6573 6869 6e67 2073  g(f'Refreshing s
-00012e30: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
-00012e40: 6e61 6d65 2172 7d29 3a20 4e6f 2063 6163  name!r}): No cac
-00012e50: 6865 6420 270a 2020 2020 2020 2020 2020  hed '.          
-00012e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e70: 2020 2066 2749 5073 2066 6f75 6e64 2e20     f'IPs found. 
-00012e80: 4861 6e64 6c65 3a20 7b68 616e 646c 657d  Handle: {handle}
-00012e90: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00012ea0: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
-00012eb0: 6f6e 732e 4665 7463 6849 5045 7272 6f72  ons.FetchIPError
-00012ec0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00012ed0: 2020 2020 2020 7265 6173 6f6e 3d65 7863        reason=exc
-00012ee0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
-00012ef0: 7272 6f72 2e52 6561 736f 6e2e 4845 4144  rror.Reason.HEAD
-00012f00: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00012f10: 2050 6f74 656e 7469 616c 6c79 2072 6566   Potentially ref
-00012f20: 7265 7368 2074 6865 2065 7874 6572 6e61  resh the externa
-00012f30: 6c20 5353 4820 706f 7274 732c 2069 6e20  l SSH ports, in 
-00012f40: 6361 7365 2074 6865 2065 7869 7374 696e  case the existin
-00012f50: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
-00012f60: 636c 7573 7465 7220 6265 666f 7265 2023  cluster before #
-00012f70: 3234 3931 2077 6173 206c 6175 6e63 6865  2491 was launche
-00012f80: 6420 7769 7468 6f75 7420 6578 7465 726e  d without extern
-00012f90: 616c 2053 5348 2070 6f72 7473 0a20 2020  al SSH ports.   
-00012fa0: 2020 2020 2020 2020 2023 2063 6163 6865           # cache
-00012fb0: 642e 0a20 2020 2020 2020 2020 2020 2065  d..            e
-00012fc0: 7874 6572 6e61 6c5f 7373 685f 706f 7274  xternal_ssh_port
-00012fd0: 7320 3d20 6861 6e64 6c65 2e65 7874 6572  s = handle.exter
-00012fe0: 6e61 6c5f 7373 685f 706f 7274 7328 290a  nal_ssh_ports().
-00012ff0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00013000: 5f73 7368 5f70 6f72 7420 3d20 6578 7465  _ssh_port = exte
-00013010: 726e 616c 5f73 7368 5f70 6f72 7473 5b30  rnal_ssh_ports[0
-00013020: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-00013030: 2043 6865 636b 2069 6620 7261 7920 636c   Check if ray cl
-00013040: 7573 7465 7220 7374 6174 7573 2069 7320  uster status is 
-00013050: 6865 616c 7468 792e 0a20 2020 2020 2020  healthy..       
-00013060: 2020 2020 2073 7368 5f63 7265 6465 6e74       ssh_credent
-00013070: 6961 6c73 203d 2073 7368 5f63 7265 6465  ials = ssh_crede
-00013080: 6e74 6961 6c5f 6672 6f6d 5f79 616d 6c28  ntial_from_yaml(
-00013090: 6861 6e64 6c65 2e63 6c75 7374 6572 5f79  handle.cluster_y
-000130a0: 616d 6c2c 0a20 2020 2020 2020 2020 2020  aml,.           
-000130b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130d0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
-000130e0: 6c65 2e64 6f63 6b65 725f 7573 6572 2c0a  le.docker_user,.
-000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013120: 2020 2020 2020 2068 616e 646c 652e 7373         handle.ss
-00013130: 685f 7573 6572 290a 0a20 2020 2020 2020  h_user)..       
-00013140: 2020 2020 2072 756e 6e65 7220 3d20 636f       runner = co
-00013150: 6d6d 616e 645f 7275 6e6e 6572 2e53 5348  mmand_runner.SSH
-00013160: 436f 6d6d 616e 6452 756e 6e65 7228 6578  CommandRunner(ex
-00013170: 7465 726e 616c 5f69 7073 5b30 5d2c 0a20  ternal_ips[0],. 
-00013180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131b0: 2020 2020 2a2a 7373 685f 6372 6564 656e      **ssh_creden
-000131c0: 7469 616c 732c 0a20 2020 2020 2020 2020  tials,.         
-000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131f0: 2020 2020 2020 2020 2020 2020 706f 7274              port
-00013200: 3d68 6561 645f 7373 685f 706f 7274 290a  =head_ssh_port).
-00013210: 2020 2020 2020 2020 2020 2020 7263 2c20              rc, 
-00013220: 6f75 7470 7574 2c20 7374 6465 7272 203d  output, stderr =
-00013230: 2072 756e 6e65 722e 7275 6e28 0a20 2020   runner.run(.   
-00013240: 2020 2020 2020 2020 2020 2020 2069 6e73               ins
-00013250: 7461 6e63 655f 7365 7475 702e 5241 595f  tance_setup.RAY_
-00013260: 5354 4154 5553 5f57 4954 485f 534b 595f  STATUS_WITH_SKY_
-00013270: 5241 595f 504f 5254 5f43 4f4d 4d41 4e44  RAY_PORT_COMMAND
-00013280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013290: 2020 7374 7265 616d 5f6c 6f67 733d 4661    stream_logs=Fa
-000132a0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-000132b0: 2020 2020 2072 6571 7569 7265 5f6f 7574       require_out
-000132c0: 7075 7473 3d54 7275 652c 0a20 2020 2020  puts=True,.     
-000132d0: 2020 2020 2020 2020 2020 2073 6570 6172             separ
-000132e0: 6174 655f 7374 6465 7272 3d54 7275 6529  ate_stderr=True)
-000132f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013300: 7263 3a0a 2020 2020 2020 2020 2020 2020  rc:.            
-00013310: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-00013320: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00013330: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-00013340: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
-00013350: 287b 636c 7573 7465 725f 6e61 6d65 2172  ({cluster_name!r
-00013360: 7d29 3a20 4661 696c 6564 2074 6f20 6368  }): Failed to ch
-00013370: 6563 6b20 270a 2020 2020 2020 2020 2020  eck '.          
-00013380: 2020 2020 2020 2020 2020 6627 7261 7920            f'ray 
-00013390: 636c 7573 7465 725c 2773 2068 6561 6c74  cluster\'s healt
-000133a0: 6869 6e65 7373 2077 6974 6820 270a 2020  hiness with '.  
-000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133c0: 2020 6627 7b69 6e73 7461 6e63 655f 7365    f'{instance_se
-000133d0: 7475 702e 5241 595f 5354 4154 5553 5f57  tup.RAY_STATUS_W
-000133e0: 4954 485f 534b 595f 5241 595f 504f 5254  ITH_SKY_RAY_PORT
-000133f0: 5f43 4f4d 4d41 4e44 7d2e 5c6e 270a 2020  _COMMAND}.\n'.  
-00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013410: 2020 6627 2d2d 2073 7464 6f75 7420 2d2d    f'-- stdout --
-00013420: 5c6e 7b6f 7574 7075 747d 5c6e 2d2d 2073  \n{output}\n-- s
-00013430: 7464 6572 7220 2d2d 5c6e 7b73 7464 6572  tderr --\n{stder
-00013440: 727d 2729 0a0a 2020 2020 2020 2020 2020  r}')..          
-00013450: 2020 7265 6164 795f 6865 6164 2c20 7265    ready_head, re
-00013460: 6164 795f 776f 726b 6572 7320 3d20 5f63  ady_workers = _c
-00013470: 6f75 6e74 5f68 6561 6c74 6879 5f6e 6f64  ount_healthy_nod
-00013480: 6573 5f66 726f 6d5f 7261 7928 6f75 7470  es_from_ray(outp
-00013490: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
-000134a0: 746f 7461 6c5f 6e6f 6465 7320 3d20 6861  total_nodes = ha
-000134b0: 6e64 6c65 2e6c 6175 6e63 6865 645f 6e6f  ndle.launched_no
-000134c0: 6465 7320 2a20 6861 6e64 6c65 2e6e 756d  des * handle.num
-000134d0: 5f69 7073 5f70 6572 5f6e 6f64 650a 2020  _ips_per_node.  
-000134e0: 2020 2020 2020 2020 2020 6966 2072 6561            if rea
-000134f0: 6479 5f68 6561 6420 2b20 7265 6164 795f  dy_head + ready_
-00013500: 776f 726b 6572 7320 3d3d 2074 6f74 616c  workers == total
-00013510: 5f6e 6f64 6573 3a0a 2020 2020 2020 2020  _nodes:.        
-00013520: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00013530: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00013540: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00013550: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00013560: 2020 2020 6627 5265 6672 6573 6869 6e67      f'Refreshing
-00013570: 2073 7461 7475 7320 287b 636c 7573 7465   status ({cluste
-00013580: 725f 6e61 6d65 2172 7d29 3a20 7261 7920  r_name!r}): ray 
-00013590: 7374 6174 7573 206e 6f74 2073 686f 7769  status not showi
-000135a0: 6e67 2027 0a20 2020 2020 2020 2020 2020  ng '.           
-000135b0: 2020 2020 2066 2761 6c6c 206e 6f64 6573       f'all nodes
-000135c0: 2028 7b72 6561 6479 5f68 6561 6420 2b20   ({ready_head + 
-000135d0: 7265 6164 795f 776f 726b 6572 737d 2f27  ready_workers}/'
-000135e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000135f0: 2066 277b 746f 7461 6c5f 6e6f 6465 737d   f'{total_nodes}
-00013600: 293b 206f 7574 7075 743a 207b 6f75 7470  ); output: {outp
-00013610: 7574 7d3b 2073 7464 6572 723a 207b 7374  ut}; stderr: {st
-00013620: 6465 7272 7d27 290a 2020 2020 2020 2020  derr}').        
-00013630: 6578 6365 7074 2065 7863 6570 7469 6f6e  except exception
-00013640: 732e 4665 7463 6849 5045 7272 6f72 3a0a  s.FetchIPError:.
-00013650: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00013660: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-00013670: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
-00013680: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
-00013690: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
-000136a0: 2066 6169 6c65 6420 746f 2067 6574 2049   failed to get I
-000136b0: 5073 2e27 290a 2020 2020 2020 2020 6578  Ps.').        ex
-000136c0: 6365 7074 2052 756e 7469 6d65 4572 726f  cept RuntimeErro
-000136d0: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-000136e0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-000136f0: 2873 7472 2865 2929 0a20 2020 2020 2020  (str(e)).       
-00013700: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00013710: 6e20 6173 2065 3a20 2023 2070 796c 696e  n as e:  # pylin
-00013720: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
-00013730: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
-00013740: 2020 2020 2320 5468 6973 2063 616e 2062      # This can b
-00013750: 6520 7261 6973 6564 2062 7920 6065 7874  e raised by `ext
-00013760: 6572 6e61 6c5f 7373 685f 706f 7274 7328  ernal_ssh_ports(
-00013770: 2960 2c20 6475 6520 746f 2074 6865 0a20  )`, due to the. 
-00013780: 2020 2020 2020 2020 2020 2023 2075 6e64             # und
-00013790: 6572 6c79 696e 6720 6361 6c6c 2074 6f20  erlying call to 
-000137a0: 6b75 6265 726e 6574 6573 2041 5049 2e0a  kubernetes API..
-000137b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-000137c0: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-000137d0: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
-000137e0: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
-000137f0: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
-00013800: 2066 6169 6c65 643a 2027 0a20 2020 2020   failed: '.     
-00013810: 2020 2020 2020 2020 2020 2066 277b 636f             f'{co
-00013820: 6d6d 6f6e 5f75 7469 6c73 2e66 6f72 6d61  mmon_utils.forma
-00013830: 745f 6578 6365 7074 696f 6e28 652c 2075  t_exception(e, u
-00013840: 7365 5f62 7261 636b 6574 3d54 7275 6529  se_bracket=True)
-00013850: 7d27 290a 2020 2020 2020 2020 7265 7475  }').        retu
-00013860: 726e 2046 616c 7365 0a0a 2020 2020 2320  rn False..    # 
-00013870: 4465 7465 726d 696e 696e 6720 6966 2074  Determining if t
-00013880: 6865 2063 6c75 7374 6572 2069 7320 6865  he cluster is he
-00013890: 616c 7468 7920 2855 5029 3a0a 2020 2020  althy (UP):.    
-000138a0: 230a 2020 2020 2320 466f 7220 6e6f 6e2d  #.    # For non-
-000138b0: 7370 6f74 2063 6c75 7374 6572 733a 2049  spot clusters: I
-000138c0: 6620 7261 7920 7374 6174 7573 2073 686f  f ray status sho
-000138d0: 7773 2061 6c6c 206e 6f64 6573 2061 7265  ws all nodes are
-000138e0: 2068 6561 6c74 6879 2c20 6974 2069 730a   healthy, it is.
-000138f0: 2020 2020 2320 7361 6665 2074 6f20 7365      # safe to se
-00013900: 7420 7468 6520 7374 6174 7573 2074 6f20  t the status to 
-00013910: 5550 2061 7320 7374 6172 7469 6e67 2072  UP as starting r
-00013920: 6179 2069 7320 7468 6520 6669 6e61 6c20  ay is the final 
-00013930: 7374 6570 206f 6620 736b 790a 2020 2020  step of sky.    
-00013940: 2320 6c61 756e 6368 2e20 4275 7420 7765  # launch. But we
-00013950: 2066 6f75 6e64 2074 6861 7420 7261 7920   found that ray 
-00013960: 7374 6174 7573 2069 7320 7761 7920 746f  status is way to
-00013970: 6f20 736c 6f77 2028 7365 6520 4e4f 5445  o slow (see NOTE
-00013980: 2062 656c 6f77 2920 736f 0a20 2020 2023   below) so.    #
-00013990: 2077 6520 616c 7761 7973 2071 7565 7279   we always query
-000139a0: 2074 6865 2063 6c6f 7564 2070 726f 7669   the cloud provi
-000139b0: 6465 7220 6669 7273 7420 7768 6963 6820  der first which 
-000139c0: 6973 2066 6173 7465 722e 0a20 2020 2023  is faster..    #
-000139d0: 0a20 2020 2023 2046 6f72 2073 706f 7420  .    # For spot 
-000139e0: 636c 7573 7465 7273 3a20 7468 6520 6162  clusters: the ab
-000139f0: 6f76 6520 6361 6e20 6265 2075 6e73 6166  ove can be unsaf
-00013a00: 6520 6265 6361 7573 6520 7468 6520 5261  e because the Ra
-00013a10: 7920 636c 7573 7465 7220 6d61 790a 2020  y cluster may.  
-00013a20: 2020 2320 7265 6d61 696e 2068 6561 6c74    # remain healt
-00013a30: 6879 2066 6f72 2061 2077 6869 6c65 2062  hy for a while b
-00013a40: 6566 6f72 6520 7468 6520 636c 6f75 6420  efore the cloud 
-00013a50: 636f 6d70 6c65 7465 6c79 2070 7265 656d  completely preem
-00013a60: 7074 7320 7468 6520 564d 732e 0a20 2020  pts the VMs..   
-00013a70: 2023 2057 6520 6861 7665 206d 6974 6967   # We have mitig
-00013a80: 6174 6564 2074 6869 7320 6279 2061 6761  ated this by aga
-00013a90: 696e 2066 6972 7374 2071 7565 7279 696e  in first queryin
-00013aa0: 6720 7468 6520 564d 2073 7461 7465 2066  g the VM state f
-00013ab0: 726f 6d20 7468 6520 636c 6f75 640a 2020  rom the cloud.  
-00013ac0: 2020 2320 7072 6f76 6964 6572 2e0a 2020    # provider..  
-00013ad0: 2020 6966 2061 6c6c 5f6e 6f64 6573 5f75    if all_nodes_u
-00013ae0: 7020 616e 6420 7275 6e5f 7261 795f 7374  p and run_ray_st
-00013af0: 6174 7573 5f74 6f5f 6368 6563 6b5f 7261  atus_to_check_ra
-00013b00: 795f 636c 7573 7465 725f 6865 616c 7468  y_cluster_health
-00013b10: 7928 293a 0a20 2020 2020 2020 2023 204e  y():.        # N
-00013b20: 4f54 453a 2061 6c6c 5f6e 6f64 6573 5f75  OTE: all_nodes_u
-00013b30: 7020 6361 6c63 756c 6174 696f 6e20 6973  p calculation is
-00013b40: 2066 6173 7420 6475 6520 746f 2063 616c   fast due to cal
-00013b50: 6c69 6e67 2063 6c6f 7564 2043 4c49 3b0a  ling cloud CLI;.
-00013b60: 2020 2020 2020 2020 2320 7275 6e5f 7261          # run_ra
-00013b70: 795f 7374 6174 7573 5f74 6f5f 6368 6563  y_status_to_chec
-00013b80: 6b5f 616c 6c5f 6e6f 6465 735f 7570 2829  k_all_nodes_up()
-00013b90: 2069 7320 736c 6f77 2064 7565 2074 6f20   is slow due to 
-00013ba0: 6361 6c6c 696e 6720 6072 6179 2067 6574  calling `ray get
-00013bb0: 0a20 2020 2020 2020 2023 2068 6561 642d  .        # head-
-00013bc0: 6970 2f77 6f72 6b65 722d 6970 7360 2e0a  ip/worker-ips`..
-00013bd0: 2020 2020 2020 2020 7265 636f 7264 5b27          record['
-00013be0: 7374 6174 7573 275d 203d 2073 7461 7475  status'] = statu
-00013bf0: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
-00013c00: 7475 732e 5550 0a20 2020 2020 2020 2067  tus.UP.        g
-00013c10: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-00013c20: 2e61 6464 5f6f 725f 7570 6461 7465 5f63  .add_or_update_c
-00013c30: 6c75 7374 6572 2863 6c75 7374 6572 5f6e  luster(cluster_n
-00013c40: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00013c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c70: 2020 2020 2068 616e 646c 652c 0a20 2020       handle,.   
-00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ca0: 2020 2020 2020 2020 2020 2020 2072 6571               req
-00013cb0: 7565 7374 6564 5f72 6573 6f75 7263 6573  uested_resources
-00013cc0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00013cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cf0: 2020 2020 2020 2072 6561 6479 3d54 7275         ready=Tru
-00013d00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00013d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d30: 2020 2069 735f 6c61 756e 6368 3d46 616c     is_launch=Fal
-00013d40: 7365 290a 2020 2020 2020 2020 7265 7475  se).        retu
-00013d50: 726e 2072 6563 6f72 640a 0a20 2020 2023  rn record..    #
-00013d60: 2041 6c6c 2063 6173 6573 2062 656c 6f77   All cases below
-00013d70: 2061 7265 2074 7261 6e73 6974 696f 6e69   are transitioni
-00013d80: 6e67 2074 6865 2063 6c75 7374 6572 2074  ng the cluster t
-00013d90: 6f20 6e6f 6e2d 5550 2073 7461 7465 732e  o non-UP states.
-00013da0: 0a20 2020 2069 6620 6c65 6e28 6e6f 6465  .    if len(node
-00013db0: 5f73 7461 7475 7365 7329 203e 2068 616e  _statuses) > han
-00013dc0: 646c 652e 6c61 756e 6368 6564 5f6e 6f64  dle.launched_nod
-00013dd0: 6573 3a0a 2020 2020 2020 2020 2320 556e  es:.        # Un
-00013de0: 6578 7065 6374 6564 3a20 696e 2074 6865  expected: in the
-00013df0: 2071 7565 7269 6564 2072 6567 696f 6e20   queried region 
-00013e00: 6d6f 7265 2074 6861 6e20 3120 636c 7573  more than 1 clus
-00013e10: 7465 7220 7769 7468 2074 6865 2073 616d  ter with the sam
-00013e20: 650a 2020 2020 2020 2020 2320 636f 6e73  e.        # cons
-00013e30: 7472 7563 7465 6420 6e61 6d65 2074 6167  tructed name tag
-00013e40: 2072 6574 7572 6e65 642e 2054 6869 7320   returned. This 
-00013e50: 7769 6c6c 2074 7970 6963 616c 6c79 206e  will typically n
-00013e60: 6f74 2068 6170 7065 6e20 756e 6c65 7373  ot happen unless
-00013e70: 0a20 2020 2020 2020 2023 2075 7365 7273  .        # users
-00013e80: 206d 616e 7561 6c6c 7920 6372 6561 7465   manually create
-00013e90: 2061 2063 6c75 7374 6572 2077 6974 6820   a cluster with 
-00013ea0: 7468 6174 2063 6f6e 7374 7275 6374 6564  that constructed
-00013eb0: 206e 616d 6520 6f72 2074 6865 7265 0a20   name or there. 
-00013ec0: 2020 2020 2020 2023 2077 6173 2061 2072         # was a r
-00013ed0: 6573 6f75 7263 6520 6c65 616b 2063 6175  esource leak cau
-00013ee0: 7365 6420 6279 2064 6966 6665 7265 6e74  sed by different
-00013ef0: 206c 6175 6e63 6820 6861 7368 2062 6566   launch hash bef
-00013f00: 6f72 6520 2331 3637 310a 2020 2020 2020  ore #1671.      
-00013f10: 2020 2320 7761 7320 6d65 7267 6564 2e0a    # was merged..
-00013f20: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00013f30: 2020 2320 2854 6563 686e 6963 616c 6c79    # (Technically
-00013f40: 2073 7065 616b 696e 672c 2065 7665 6e20   speaking, even 
-00013f50: 6966 2072 6574 7572 6e65 6420 6e75 6d20  if returned num 
-00013f60: 6e6f 6465 7320 3c3d 206e 756d 0a20 2020  nodes <= num.   
-00013f70: 2020 2020 2023 2068 616e 646c 652e 6c61       # handle.la
-00013f80: 756e 6368 6564 5f6e 6f64 6573 292c 206e  unched_nodes), n
-00013f90: 6f74 2069 6e63 6c75 6469 6e67 2074 6865  ot including the
-00013fa0: 206c 6175 6e63 6820 6861 7368 2063 6f75   launch hash cou
-00013fb0: 6c64 206d 6561 6e20 7468 650a 2020 2020  ld mean the.    
-00013fc0: 2020 2020 2320 7265 7475 726e 6564 206e      # returned n
-00013fd0: 6f64 6573 2063 6f6e 7461 696e 2073 6f6d  odes contain som
-00013fe0: 6520 6e6f 6465 7320 7468 6174 2064 6f20  e nodes that do 
-00013ff0: 6e6f 7420 6265 6c6f 6e67 2074 6f20 7468  not belong to th
-00014000: 6520 6c6f 6769 6361 6c0a 2020 2020 2020  e logical.      
-00014010: 2020 2320 736b 7970 696c 6f74 2063 6c75    # skypilot clu
-00014020: 7374 6572 2e20 446f 6573 6e27 7420 7365  ster. Doesn't se
-00014030: 656d 2074 6f20 6265 2061 2067 6f6f 6420  em to be a good 
-00014040: 7761 7920 746f 2068 616e 646c 6520 7468  way to handle th
-00014050: 6973 2066 6f72 0a20 2020 2020 2020 2023  is for.        #
-00014060: 206e 6f77 3f29 0a20 2020 2020 2020 2023   now?).        #
-00014070: 0a20 2020 2020 2020 2023 2057 6520 6861  .        # We ha
-00014080: 7665 206e 6f74 2065 7870 6572 6965 6e63  ve not experienc
-00014090: 6564 2074 6865 2061 626f 7665 3b20 6164  ed the above; ad
-000140a0: 6469 6e67 2061 7320 6120 7361 6665 6775  ding as a safegu
-000140b0: 6172 642e 0a20 2020 2020 2020 2023 0a20  ard..        #. 
-000140c0: 2020 2020 2020 2023 2053 696e 6365 2077         # Since w
-000140d0: 6520 6661 696c 6564 2074 6f20 7265 6672  e failed to refr
-000140e0: 6573 682c 2072 6169 7365 2074 6865 2073  esh, raise the s
-000140f0: 7461 7475 7320 6665 7463 6869 6e67 2065  tatus fetching e
-00014100: 7272 6f72 2e0a 2020 2020 2020 2020 7769  rror..        wi
-00014110: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
-00014120: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
-00014130: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
-00014140: 2020 2020 2020 2020 7261 6973 6520 6578          raise ex
-00014150: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
-00014160: 5374 6174 7573 4665 7463 6869 6e67 4572  StatusFetchingEr
-00014170: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00014180: 2020 2020 2066 2746 6f75 6e64 207b 6c65       f'Found {le
-00014190: 6e28 6e6f 6465 5f73 7461 7475 7365 7329  n(node_statuses)
-000141a0: 7d20 6e6f 6465 2873 2920 7769 7468 2074  } node(s) with t
-000141b0: 6865 2073 616d 6520 636c 7573 7465 7220  he same cluster 
-000141c0: 6e61 6d65 270a 2020 2020 2020 2020 2020  name'.          
-000141d0: 2020 2020 2020 6627 2074 6167 2069 6e20        f' tag in 
-000141e0: 7468 6520 636c 6f75 6420 7072 6f76 6964  the cloud provid
-000141f0: 6572 2066 6f72 2063 6c75 7374 6572 207b  er for cluster {
-00014200: 636c 7573 7465 725f 6e61 6d65 2172 7d2c  cluster_name!r},
-00014210: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00014220: 2020 2066 2777 6869 6368 2073 686f 756c     f'which shoul
-00014230: 6420 6861 7665 207b 6861 6e64 6c65 2e6c  d have {handle.l
-00014240: 6175 6e63 6865 645f 6e6f 6465 737d 206e  aunched_nodes} n
-00014250: 6f64 6573 2e20 5468 6973 2027 0a20 2020  odes. This '.   
-00014260: 2020 2020 2020 2020 2020 2020 2066 276e               f'n
-00014270: 6f72 6d61 6c6c 7920 7368 6f75 6c64 206e  ormally should n
-00014280: 6f74 2068 6170 7065 6e2e 207b 636f 6c6f  ot happen. {colo
-00014290: 7261 6d61 2e46 6f72 652e 5245 447d 506c  rama.Fore.RED}Pl
-000142a0: 6561 7365 2063 6865 636b 2027 0a20 2020  ease check '.   
-000142b0: 2020 2020 2020 2020 2020 2020 2027 7468               'th
-000142c0: 6520 636c 6f75 6420 636f 6e73 6f6c 6520  e cloud console 
-000142d0: 616e 6420 6669 7820 616e 7920 706f 7373  and fix any poss
-000142e0: 6962 6c65 2072 6573 6f75 7263 6573 206c  ible resources l
-000142f0: 6561 6b61 6765 2027 0a20 2020 2020 2020  eakage '.       
-00014300: 2020 2020 2020 2020 2027 2865 2e67 2e2c           '(e.g.,
-00014310: 2069 6620 7468 6572 6520 6172 6520 616e   if there are an
-00014320: 7920 7374 6f70 7065 6420 6e6f 6465 7320  y stopped nodes 
-00014330: 616e 6420 7468 6579 2064 6f20 6e6f 7420  and they do not 
-00014340: 6861 7665 2027 0a20 2020 2020 2020 2020  have '.         
-00014350: 2020 2020 2020 2027 6461 7461 206f 7220         'data or 
-00014360: 6172 6520 756e 6865 616c 7468 792c 2074  are unhealthy, t
-00014370: 6572 6d69 6e61 7465 2074 6865 6d29 2e27  erminate them).'
-00014380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014390: 2066 277b 636f 6c6f 7261 6d61 2e53 7479   f'{colorama.Sty
-000143a0: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
-000143b0: 2020 2020 6173 7365 7274 206c 656e 286e      assert len(n
-000143c0: 6f64 655f 7374 6174 7573 6573 2920 3c3d  ode_statuses) <=
-000143d0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-000143e0: 5f6e 6f64 6573 0a0a 2020 2020 2320 4966  _nodes..    # If
-000143f0: 2074 6865 206e 6f64 655f 7374 6174 7573   the node_status
-00014400: 6573 2069 7320 656d 7074 792c 2061 6c6c  es is empty, all
-00014410: 2074 6865 206e 6f64 6573 2061 7265 2074   the nodes are t
-00014420: 6572 6d69 6e61 7465 642e 2057 6520 6361  erminated. We ca
-00014430: 6e0a 2020 2020 2320 7361 6665 6c79 2073  n.    # safely s
-00014440: 6574 2074 6865 2063 6c75 7374 6572 2073  et the cluster s
-00014450: 7461 7475 7320 746f 2054 4552 4d49 4e41  tatus to TERMINA
-00014460: 5445 442e 2054 6869 7320 6861 6e64 6c65  TED. This handle
-00014470: 7320 7468 6520 6564 6765 2063 6173 650a  s the edge case.
-00014480: 2020 2020 2320 7768 6572 6520 7468 6520      # where the 
-00014490: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
-000144a0: 6e61 7465 6420 6279 2074 6865 2075 7365  nated by the use
-000144b0: 7220 6d61 6e75 616c 6c79 2074 6872 6f75  r manually throu
-000144c0: 6768 2074 6865 2055 492e 0a20 2020 2074  gh the UI..    t
-000144d0: 6f5f 7465 726d 696e 6174 6520 3d20 6e6f  o_terminate = no
-000144e0: 7420 6e6f 6465 5f73 7461 7475 7365 730a  t node_statuses.
-000144f0: 0a20 2020 2023 2041 2063 6c75 7374 6572  .    # A cluster
-00014500: 2069 7320 636f 6e73 6964 6572 6564 2022   is considered "
-00014510: 6162 6e6f 726d 616c 222c 2069 6620 6e6f  abnormal", if no
-00014520: 7420 616c 6c20 6e6f 6465 7320 6172 6520  t all nodes are 
-00014530: 5445 524d 494e 4154 4544 206f 720a 2020  TERMINATED or.  
-00014540: 2020 2320 6e6f 7420 616c 6c20 6e6f 6465    # not all node
-00014550: 7320 6172 6520 5354 4f50 5045 442e 2057  s are STOPPED. W
-00014560: 6520 6368 6563 6b20 7468 6174 2077 6974  e check that wit
-00014570: 6820 7468 6520 666f 6c6c 6f77 696e 6720  h the following 
-00014580: 6c6f 6769 633a 0a20 2020 2023 2020 202a  logic:.    #   *
-00014590: 204e 6f74 2061 6c6c 206e 6f64 6573 2061   Not all nodes a
-000145a0: 7265 2074 6572 6d69 6e61 7465 6420 616e  re terminated an
-000145b0: 6420 7468 6572 6527 7320 6174 206c 6561  d there's at lea
-000145c0: 7374 206f 6e65 206e 6f64 650a 2020 2020  st one node.    
-000145d0: 2320 2020 2020 7465 726d 696e 6174 6564  #     terminated
-000145e0: 3b20 6f72 0a20 2020 2023 2020 202a 2041  ; or.    #   * A
-000145f0: 6e79 206f 6620 7468 6520 6e6f 6e2d 5445  ny of the non-TE
-00014600: 524d 494e 4154 4544 206e 6f64 6573 2069  RMINATED nodes i
-00014610: 7320 696e 2061 206e 6f6e 2d53 544f 5050  s in a non-STOPP
-00014620: 4544 2073 7461 7475 732e 0a20 2020 2023  ED status..    #
-00014630: 0a20 2020 2023 2054 6869 7320 696e 636c  .    # This incl
-00014640: 7564 6573 2074 6865 7365 2073 7065 6369  udes these speci
-00014650: 616c 2063 6173 6573 3a0a 2020 2020 2320  al cases:.    # 
-00014660: 2020 2a20 416c 6c20 7374 6f70 7065 6420    * All stopped 
-00014670: 6172 6520 636f 6e73 6964 6572 6564 206e  are considered n
-00014680: 6f72 6d61 6c20 616e 6420 7769 6c6c 2062  ormal and will b
-00014690: 6520 636c 6561 6e65 6420 7570 2061 7420  e cleaned up at 
-000146a0: 7468 6520 656e 640a 2020 2020 2320 2020  the end.    #   
-000146b0: 2020 6f66 2074 6865 2066 756e 6374 696f    of the functio
-000146c0: 6e2e 0a20 2020 2023 2020 202a 2053 6f6d  n..    #   * Som
-000146d0: 6520 6f66 2074 6865 206e 6f64 6573 2055  e of the nodes U
-000146e0: 5020 7368 6f75 6c64 2062 6520 636f 6e73  P should be cons
-000146f0: 6964 6572 6564 2061 626e 6f72 6d61 6c2c  idered abnormal,
-00014700: 2062 6563 6175 7365 2074 6865 2072 6179   because the ray
-00014710: 0a20 2020 2023 2020 2020 2063 6c75 7374  .    #     clust
-00014720: 6572 2069 7320 7072 6f62 6162 6c79 2064  er is probably d
-00014730: 6f77 6e2e 0a20 2020 2023 2020 202a 2054  own..    #   * T
-00014740: 6865 2063 6c75 7374 6572 2069 7320 7061  he cluster is pa
-00014750: 7274 6961 6c6c 7920 7465 726d 696e 6174  rtially terminat
-00014760: 6564 206f 7220 7374 6f70 7065 6420 7368  ed or stopped sh
-00014770: 6f75 6c64 2062 6520 636f 6e73 6964 6572  ould be consider
-00014780: 6564 0a20 2020 2023 2020 2020 2061 626e  ed.    #     abn
-00014790: 6f72 6d61 6c2e 0a20 2020 2023 0a20 2020  ormal..    #.   
-000147a0: 2023 2041 6e20 6162 6e6f 726d 616c 2063   # An abnormal c
-000147b0: 6c75 7374 6572 2077 696c 6c20 7472 616e  luster will tran
-000147c0: 7369 7469 6f6e 2074 6f20 494e 4954 2061  sition to INIT a
-000147d0: 6e64 2068 6176 6520 616e 7920 6175 746f  nd have any auto
-000147e0: 7374 6f70 2073 6574 7469 6e67 0a20 2020  stop setting.   
-000147f0: 2023 2072 6573 6574 2028 756e 6c65 7373   # reset (unless
-00014800: 2069 7427 7320 6175 746f 7374 6f70 7069   it's autostoppi
-00014810: 6e67 2f61 7574 6f64 6f77 6e69 6e67 292e  ng/autodowning).
-00014820: 0a20 2020 2069 735f 6162 6e6f 726d 616c  .    is_abnormal
-00014830: 203d 2028 2830 203c 206c 656e 286e 6f64   = ((0 < len(nod
-00014840: 655f 7374 6174 7573 6573 2920 3c20 6861  e_statuses) < ha
-00014850: 6e64 6c65 2e6c 6175 6e63 6865 645f 6e6f  ndle.launched_no
-00014860: 6465 7329 206f 7220 616e 7928 0a20 2020  des) or any(.   
-00014870: 2020 2020 2073 7461 7475 7320 213d 2073       status != s
-00014880: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
-00014890: 7253 7461 7475 732e 5354 4f50 5045 4420  rStatus.STOPPED 
-000148a0: 666f 7220 7374 6174 7573 2069 6e20 6e6f  for status in no
-000148b0: 6465 5f73 7461 7475 7365 7329 290a 2020  de_statuses)).  
-000148c0: 2020 6966 2069 735f 6162 6e6f 726d 616c    if is_abnormal
-000148d0: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
-000148e0: 2e64 6562 7567 2827 5468 6520 636c 7573  .debug('The clus
-000148f0: 7465 7220 6973 2061 626e 6f72 6d61 6c2e  ter is abnormal.
-00014900: 2053 6574 7469 6e67 2074 6f20 494e 4954   Setting to INIT
-00014910: 2073 7461 7475 732e 2027 0a20 2020 2020   status. '.     
-00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014930: 6627 6e6f 6465 5f73 7461 7475 7365 733a  f'node_statuses:
-00014940: 207b 6e6f 6465 5f73 7461 7475 7365 737d   {node_statuses}
-00014950: 2729 0a20 2020 2020 2020 2062 6163 6b65  ').        backe
-00014960: 6e64 203d 2067 6574 5f62 6163 6b65 6e64  nd = get_backend
-00014970: 5f66 726f 6d5f 6861 6e64 6c65 2868 616e  _from_handle(han
-00014980: 646c 6529 0a20 2020 2020 2020 2069 6620  dle).        if 
-00014990: 6973 696e 7374 616e 6365 2862 6163 6b65  isinstance(backe
-000149a0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-000149b0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
-000149c0: 6473 2e43 6c6f 7564 566d 5261 7942 6163  ds.CloudVmRayBac
-000149d0: 6b65 6e64 2920 616e 6420 7265 636f 7264  kend) and record
-000149e0: 5b27 6175 746f 7374 6f70 275d 203e 3d20  ['autostop'] >= 
-000149f0: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
-00014a00: 6620 6e6f 7420 6261 636b 656e 642e 6973  f not backend.is
-00014a10: 5f64 6566 696e 6974 656c 795f 6175 746f  _definitely_auto
-00014a20: 7374 6f70 7069 6e67 2868 616e 646c 652c  stopping(handle,
-00014a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a60: 2020 2020 2020 2073 7472 6561 6d5f 6c6f         stream_lo
-00014a70: 6773 3d46 616c 7365 293a 0a20 2020 2020  gs=False):.     
-00014a80: 2020 2020 2020 2020 2020 2023 2046 7269             # Fri
-00014a90: 656e 646c 7920 6869 6e74 2e0a 2020 2020  endly hint..    
-00014aa0: 2020 2020 2020 2020 2020 2020 6175 746f              auto
-00014ab0: 7374 6f70 203d 2072 6563 6f72 645b 2761  stop = record['a
-00014ac0: 7574 6f73 746f 7027 5d0a 2020 2020 2020  utostop'].      
-00014ad0: 2020 2020 2020 2020 2020 6d61 7962 655f            maybe_
-00014ae0: 646f 776e 5f73 7472 203d 2027 202d 2d64  down_str = ' --d
-00014af0: 6f77 6e27 2069 6620 7265 636f 7264 5b27  own' if record['
-00014b00: 746f 5f64 6f77 6e27 5d20 656c 7365 2027  to_down'] else '
-00014b10: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014b20: 2020 6e6f 756e 203d 2027 6175 746f 646f    noun = 'autodo
-00014b30: 776e 2720 6966 2072 6563 6f72 645b 2774  wn' if record['t
-00014b40: 6f5f 646f 776e 275d 2065 6c73 6520 2761  o_down'] else 'a
-00014b50: 7574 6f73 746f 7027 0a0a 2020 2020 2020  utostop'..      
-00014b60: 2020 2020 2020 2020 2020 2320 5265 7365            # Rese
-00014b70: 7420 7468 6520 6175 746f 7374 6f70 7069  t the autostoppi
-00014b80: 6e67 2061 7320 7468 6520 636c 7573 7465  ng as the cluste
-00014b90: 7220 6973 2061 626e 6f72 6d61 6c2c 2061  r is abnormal, a
-00014ba0: 6e64 206d 6179 0a20 2020 2020 2020 2020  nd may.         
-00014bb0: 2020 2020 2020 2023 206e 6f74 2063 6f72         # not cor
-00014bc0: 7265 6374 6c79 2061 7574 6f73 746f 702e  rectly autostop.
-00014bd0: 2052 6573 6574 7469 6e67 2074 6865 2061   Resetting the a
-00014be0: 7574 6f73 746f 7020 7769 6c6c 206c 6574  utostop will let
-00014bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014c00: 2023 2074 6865 2075 7365 7220 6b6e 6f77   # the user know
-00014c10: 2074 6861 7420 7468 6520 6175 746f 7374   that the autost
-00014c20: 6f70 206d 6179 206e 6f74 2068 6170 7065  op may not happe
-00014c30: 6e20 746f 2061 766f 6964 0a20 2020 2020  n to avoid.     
-00014c40: 2020 2020 2020 2020 2020 2023 206c 6561             # lea
-00014c50: 6b61 6765 7320 6672 6f6d 2074 6865 2061  kages from the a
-00014c60: 7373 756d 7074 696f 6e20 7468 6174 2074  ssumption that t
-00014c70: 6865 2063 6c75 7374 6572 2077 696c 6c20  he cluster will 
-00014c80: 6175 746f 7374 6f70 2e0a 2020 2020 2020  autostop..      
-00014c90: 2020 2020 2020 2020 2020 7375 6363 6573            succes
-00014ca0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-00014cb0: 2020 2020 2020 2020 2072 6573 6574 5f6c           reset_l
-00014cc0: 6f63 616c 5f61 7574 6f73 746f 7020 3d20  ocal_autostop = 
-00014cd0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00014ce0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00014cf0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00014d00: 636b 656e 642e 7365 745f 6175 746f 7374  ckend.set_autost
-00014d10: 6f70 2868 616e 646c 652c 202d 312c 2073  op(handle, -1, s
-00014d20: 7472 6561 6d5f 6c6f 6773 3d46 616c 7365  tream_logs=False
-00014d30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014d40: 2020 6578 6365 7074 2065 7863 6570 7469    except excepti
-00014d50: 6f6e 732e 436f 6d6d 616e 6445 7272 6f72  ons.CommandError
-00014d60: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00014d70: 2020 2020 2020 2020 2020 2073 7563 6365             succe
-00014d80: 7373 203d 2046 616c 7365 0a20 2020 2020  ss = False.     
-00014d90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014da0: 6620 652e 7265 7475 726e 636f 6465 203d  f e.returncode =
-00014db0: 3d20 3235 353a 0a20 2020 2020 2020 2020  = 255:.         
-00014dc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00014dd0: 6f67 6765 722e 6465 6275 6728 6627 5468  ogger.debug(f'Th
-00014de0: 6520 636c 7573 7465 7220 6973 206c 696b  e cluster is lik
-00014df0: 656c 7920 7b6e 6f75 6e7d 6564 2e27 290a  ely {noun}ed.').
-00014e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e10: 2020 2020 2020 2020 7265 7365 745f 6c6f          reset_lo
-00014e20: 6361 6c5f 6175 746f 7374 6f70 203d 2046  cal_autostop = F
-00014e30: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00014e40: 2020 2020 2065 7863 6570 7420 2845 7863       except (Exc
-00014e50: 6570 7469 6f6e 2c20 5379 7374 656d 4578  eption, SystemEx
-00014e60: 6974 2920 6173 2065 3a20 2023 2070 796c  it) as e:  # pyl
-00014e70: 696e 743a 2064 6973 6162 6c65 3d62 726f  int: disable=bro
-00014e80: 6164 2d65 7863 6570 740a 2020 2020 2020  ad-except.      
-00014e90: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00014ea0: 6363 6573 7320 3d20 4661 6c73 650a 2020  ccess = False.  
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ec0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00014ed0: 2746 6169 6c65 6420 746f 2072 6573 6574  'Failed to reset
-00014ee0: 2061 7574 6f73 746f 702e 2044 7565 2074   autostop. Due t
-00014ef0: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
-00014f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f10: 2020 2020 2066 277b 636f 6d6d 6f6e 5f75       f'{common_u
-00014f20: 7469 6c73 2e66 6f72 6d61 745f 6578 6365  tils.format_exce
-00014f30: 7074 696f 6e28 6529 7d27 290a 2020 2020  ption(e)}').    
-00014f40: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00014f50: 6573 6574 5f6c 6f63 616c 5f61 7574 6f73  eset_local_autos
-00014f60: 746f 703a 0a20 2020 2020 2020 2020 2020  top:.           
-00014f70: 2020 2020 2020 2020 2067 6c6f 6261 6c5f           global_
-00014f80: 7573 6572 5f73 7461 7465 2e73 6574 5f63  user_state.set_c
-00014f90: 6c75 7374 6572 5f61 7574 6f73 746f 705f  luster_autostop_
-00014fa0: 7661 6c75 6528 0a20 2020 2020 2020 2020  value(.         
-00014fb0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00014fc0: 616e 646c 652e 636c 7573 7465 725f 6e61  andle.cluster_na
-00014fd0: 6d65 2c20 2d31 2c20 746f 5f64 6f77 6e3d  me, -1, to_down=
-00014fe0: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
-00014ff0: 2020 2020 2020 2020 6966 2073 7563 6365          if succe
-00015000: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-00015010: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
-00015020: 6e5f 7374 7220 3d20 2866 2743 616e 6365  n_str = (f'Cance
-00015030: 6c65 6420 7b6e 6f75 6e7d 206f 6e20 7468  led {noun} on th
-00015040: 6520 636c 7573 7465 7220 270a 2020 2020  e cluster '.    
-00015050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015070: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
-00015080: 2172 7d27 290a 2020 2020 2020 2020 2020  !r}').          
-00015090: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150b0: 6f70 6572 6174 696f 6e5f 7374 7220 3d20  operation_str = 
-000150c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000150d0: 2020 2020 2020 2020 2020 6627 4174 7465            f'Atte
-000150e0: 6d70 7465 6420 746f 2063 616e 6365 6c20  mpted to cancel 
-000150f0: 7b6e 6f75 6e7d 206f 6e20 7468 6520 270a  {noun} on the '.
-00015100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015110: 2020 2020 2020 2020 6627 636c 7573 7465          f'cluste
-00015120: 7220 7b63 6c75 7374 6572 5f6e 616d 6521  r {cluster_name!
-00015130: 727d 2077 6974 6820 6265 7374 2065 6666  r} with best eff
-00015140: 6f72 7427 290a 2020 2020 2020 2020 2020  ort').          
-00015150: 2020 2020 2020 7965 6c6c 6f77 203d 2063        yellow = c
-00015160: 6f6c 6f72 616d 612e 466f 7265 2e59 454c  olorama.Fore.YEL
-00015170: 4c4f 570a 2020 2020 2020 2020 2020 2020  LOW.            
-00015180: 2020 2020 6272 6967 6874 203d 2063 6f6c      bright = col
-00015190: 6f72 616d 612e 5374 796c 652e 4252 4947  orama.Style.BRIG
-000151a0: 4854 0a20 2020 2020 2020 2020 2020 2020  HT.             
-000151b0: 2020 2072 6573 6574 203d 2063 6f6c 6f72     reset = color
-000151c0: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
-000151d0: 414c 4c0a 2020 2020 2020 2020 2020 2020  ALL.            
-000151e0: 2020 2020 7578 5f75 7469 6c73 2e63 6f6e      ux_utils.con
-000151f0: 736f 6c65 5f6e 6577 6c69 6e65 2829 0a20  sole_newline(). 
-00015200: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015210: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
-00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015230: 2020 2066 277b 7965 6c6c 6f77 7d7b 6f70     f'{yellow}{op
-00015240: 6572 6174 696f 6e5f 7374 727d 2c20 7369  eration_str}, si
-00015250: 6e63 6520 6974 2069 7320 666f 756e 6420  nce it is found 
-00015260: 746f 2062 6520 696e 2061 6e20 270a 2020  to be in an '.  
-00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015280: 2020 6627 6162 6e6f 726d 616c 2073 7461    f'abnormal sta
-00015290: 7465 2e20 546f 2066 6978 2c20 7472 7920  te. To fix, try 
-000152a0: 7275 6e6e 696e 673a 207b 7265 7365 747d  running: {reset}
-000152b0: 7b62 7269 6768 747d 736b 7920 270a 2020  {bright}sky '.  
-000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152d0: 2020 6627 7374 6172 7420 2d66 202d 6920    f'start -f -i 
-000152e0: 7b61 7574 6f73 746f 707d 7b6d 6179 6265  {autostop}{maybe
-000152f0: 5f64 6f77 6e5f 7374 727d 207b 636c 7573  _down_str} {clus
-00015300: 7465 725f 6e61 6d65 7d27 0a20 2020 2020  ter_name}'.     
-00015310: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015320: 277b 7265 7365 747d 2729 0a20 2020 2020  '{reset}').     
-00015330: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00015340: 2020 2020 2020 2020 2020 2020 2075 785f               ux_
-00015350: 7574 696c 732e 636f 6e73 6f6c 655f 6e65  utils.console_ne
-00015360: 776c 696e 6528 290a 2020 2020 2020 2020  wline().        
-00015370: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
-00015380: 6e5f 7374 7220 3d20 2761 7574 6f64 6f77  n_str = 'autodow
-00015390: 6e69 6e67 2720 6966 2072 6563 6f72 645b  ning' if record[
-000153a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000153b0: 2020 2020 2027 746f 5f64 6f77 6e27 5d20       'to_down'] 
-000153c0: 656c 7365 2027 6175 746f 7374 6f70 7069  else 'autostoppi
-000153d0: 6e67 270a 2020 2020 2020 2020 2020 2020  ng'.            
-000153e0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-000153f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015400: 2020 2020 2066 2743 6c75 7374 6572 207b       f'Cluster {
-00015410: 636c 7573 7465 725f 6e61 6d65 2172 7d20  cluster_name!r} 
-00015420: 6973 207b 6f70 6572 6174 696f 6e5f 7374  is {operation_st
-00015430: 727d 2e20 5365 7474 696e 6720 746f 2027  r}. Setting to '
-00015440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015450: 2020 2020 2027 494e 4954 2073 7461 7475       'INIT statu
-00015460: 733b 2074 7279 2072 6566 7265 7368 2061  s; try refresh a
-00015470: 6761 696e 2069 6e20 6120 7768 696c 652e  gain in a while.
-00015480: 2729 0a0a 2020 2020 2020 2020 2320 4966  ')..        # If
-00015490: 2074 6865 2075 7365 7220 7374 6172 7473   the user starts
-000154a0: 2070 6172 7420 6f66 2061 2053 544f 5050   part of a STOPP
-000154b0: 4544 2063 6c75 7374 6572 2c20 7765 2073  ED cluster, we s
-000154c0: 7469 6c6c 206e 6565 6420 6120 7374 6174  till need a stat
-000154d0: 7573 0a20 2020 2020 2020 2023 2074 6f20  us.        # to 
-000154e0: 7265 7072 6573 656e 7420 7468 6520 6162  represent the ab
-000154f0: 6e6f 726d 616c 2073 7461 7475 732e 2046  normal status. F
-00015500: 6f72 2073 706f 7420 636c 7573 7465 722c  or spot cluster,
-00015510: 2069 7420 6361 6e20 616c 736f 0a20 2020   it can also.   
-00015520: 2020 2020 2023 2072 6570 7265 7365 6e74       # represent
-00015530: 2074 6861 7420 7468 6520 636c 7573 7465   that the cluste
-00015540: 7220 6973 2070 6172 7469 616c 6c79 2070  r is partially p
-00015550: 7265 656d 7074 6564 2e0a 2020 2020 2020  reempted..      
-00015560: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00015570: 7468 6520 6465 6669 6e69 7469 6f6e 206f  the definition o
-00015580: 6620 494e 4954 2073 686f 756c 6420 6265  f INIT should be
-00015590: 2061 7564 6974 6564 2f63 6861 6e67 6564   audited/changed
-000155a0: 2e0a 2020 2020 2020 2020 2320 4164 6469  ..        # Addi
-000155b0: 6e67 2061 206e 6577 2073 7461 7475 7320  ng a new status 
-000155c0: 554e 4845 414c 5448 5920 666f 7220 6162  UNHEALTHY for ab
-000155d0: 6e6f 726d 616c 2073 7461 7475 7320 6361  normal status ca
-000155e0: 6e20 6265 2061 2063 686f 6963 652e 0a20  n be a choice.. 
-000155f0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
-00015600: 6572 5f73 7461 7465 2e61 6464 5f6f 725f  er_state.add_or_
-00015610: 7570 6461 7465 5f63 6c75 7374 6572 2863  update_cluster(c
-00015620: 6c75 7374 6572 5f6e 616d 652c 0a20 2020  luster_name,.   
-00015630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015650: 2020 2020 2020 2020 2020 2020 2068 616e               han
-00015660: 646c 652c 0a20 2020 2020 2020 2020 2020  dle,.           
-00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015690: 2020 2020 2072 6571 7565 7374 6564 5f72       requested_r
-000156a0: 6573 6f75 7263 6573 3d4e 6f6e 652c 0a20  esources=None,. 
-000156b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000156e0: 6561 6479 3d46 616c 7365 2c0a 2020 2020  eady=False,.    
-000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015710: 2020 2020 2020 2020 2020 2020 6973 5f6c              is_l
-00015720: 6175 6e63 683d 4661 6c73 6529 0a20 2020  aunch=False).   
-00015730: 2020 2020 2072 6574 7572 6e20 676c 6f62       return glob
-00015740: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-00015750: 745f 636c 7573 7465 725f 6672 6f6d 5f6e  t_cluster_from_n
-00015760: 616d 6528 636c 7573 7465 725f 6e61 6d65  ame(cluster_name
-00015770: 290a 2020 2020 2320 4e6f 7720 6973 5f61  ).    # Now is_a
-00015780: 626e 6f72 6d61 6c20 6973 2046 616c 7365  bnormal is False
-00015790: 3a20 6569 7468 6572 206e 6f64 655f 7374  : either node_st
-000157a0: 6174 7573 6573 2069 7320 656d 7074 7920  atuses is empty 
-000157b0: 6f72 2061 6c6c 206e 6f64 6573 2061 7265  or all nodes are
-000157c0: 0a20 2020 2023 2053 544f 5050 4544 2e0a  .    # STOPPED..
-000157d0: 2020 2020 6261 636b 656e 6420 3d20 6261      backend = ba
-000157e0: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
-000157f0: 7942 6163 6b65 6e64 2829 0a20 2020 2062  yBackend().    b
-00015800: 6163 6b65 6e64 2e70 6f73 745f 7465 6172  ackend.post_tear
-00015810: 646f 776e 5f63 6c65 616e 7570 2868 616e  down_cleanup(han
-00015820: 646c 652c 2074 6572 6d69 6e61 7465 3d74  dle, terminate=t
-00015830: 6f5f 7465 726d 696e 6174 652c 2070 7572  o_terminate, pur
-00015840: 6765 3d46 616c 7365 290a 2020 2020 7265  ge=False).    re
-00015850: 7475 726e 2067 6c6f 6261 6c5f 7573 6572  turn global_user
-00015860: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
-00015870: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
-00015880: 7374 6572 5f6e 616d 6529 0a0a 0a64 6566  ster_name)...def
-00015890: 205f 7570 6461 7465 5f63 6c75 7374 6572   _update_cluster
-000158a0: 5f73 7461 7475 7328 0a20 2020 2063 6c75  _status(.    clu
-000158b0: 7374 6572 5f6e 616d 653a 2073 7472 2c0a  ster_name: str,.
-000158c0: 2020 2020 6163 7175 6972 655f 7065 725f      acquire_per_
-000158d0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
-000158e0: 6f63 6b3a 2062 6f6f 6c2c 0a20 2020 2063  ock: bool,.    c
-000158f0: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
-00015900: 636b 5f74 696d 656f 7574 3a20 696e 7420  ck_timeout: int 
-00015910: 3d20 434c 5553 5445 525f 5354 4154 5553  = CLUSTER_STATUS
-00015920: 5f4c 4f43 4b5f 5449 4d45 4f55 545f 5345  _LOCK_TIMEOUT_SE
-00015930: 434f 4e44 530a 2920 2d3e 204f 7074 696f  CONDS.) -> Optio
-00015940: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
-00015950: 795d 5d3a 0a20 2020 2022 2222 5570 6461  y]]:.    """Upda
-00015960: 7465 2074 6865 2063 6c75 7374 6572 2073  te the cluster s
-00015970: 7461 7475 732e 0a0a 2020 2020 5468 6520  tatus...    The 
-00015980: 636c 7573 7465 7220 7374 6174 7573 2069  cluster status i
-00015990: 7320 7570 6461 7465 6420 6279 2063 6865  s updated by che
-000159a0: 636b 696e 6720 7261 7920 636c 7573 7465  cking ray cluste
-000159b0: 7220 616e 6420 7265 616c 2073 7461 7475  r and real statu
-000159c0: 7320 6672 6f6d 0a20 2020 2063 6c6f 7564  s from.    cloud
-000159d0: 2e0a 0a20 2020 2054 6865 2066 756e 6374  ...    The funct
-000159e0: 696f 6e20 7769 6c6c 2075 7064 6174 6520  ion will update 
-000159f0: 7468 6520 6361 6368 6564 2063 6c75 7374  the cached clust
-00015a00: 6572 2073 7461 7475 7320 696e 2074 6865  er status in the
-00015a10: 2067 6c6f 6261 6c20 7374 6174 652e 2046   global state. F
-00015a20: 6f72 0a20 2020 2074 6865 2064 6573 6967  or.    the desig
-00015a30: 6e20 6f66 2074 6865 2063 6c75 7374 6572  n of the cluster
-00015a40: 2073 7461 7475 7320 616e 6420 7472 616e   status and tran
-00015a50: 7369 7469 6f6e 2c20 706c 6561 7365 2072  sition, please r
-00015a60: 6566 6572 2074 6f20 7468 650a 2020 2020  efer to the.    
-00015a70: 736b 792f 6465 7369 676e 5f64 6f63 732f  sky/design_docs/
-00015a80: 636c 7573 7465 725f 7374 6174 7573 2e6d  cluster_status.m
-00015a90: 640a 0a20 2020 2041 7267 733a 0a20 2020  d..    Args:.   
-00015aa0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-00015ab0: 653a 2054 6865 206e 616d 6520 6f66 2074  e: The name of t
-00015ac0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-00015ad0: 2020 2020 6163 7175 6972 655f 7065 725f      acquire_per_
-00015ae0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
-00015af0: 6f63 6b3a 2057 6865 7468 6572 2074 6f20  ock: Whether to 
-00015b00: 6163 7175 6972 6520 7468 6520 7065 722d  acquire the per-
-00015b10: 636c 7573 7465 7220 6c6f 636b 0a20 2020  cluster lock.   
-00015b20: 2020 2020 2020 2062 6566 6f72 6520 7570         before up
-00015b30: 6461 7469 6e67 2074 6865 2073 7461 7475  dating the statu
-00015b40: 732e 0a20 2020 2020 2020 2063 6c75 7374  s..        clust
-00015b50: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
-00015b60: 696d 656f 7574 3a20 5468 6520 7469 6d65  imeout: The time
-00015b70: 6f75 7420 746f 2061 6371 7569 7265 2074  out to acquire t
-00015b80: 6865 2070 6572 2d63 6c75 7374 6572 0a20  he per-cluster. 
-00015b90: 2020 2020 2020 2020 206c 6f63 6b2e 0a0a           lock...
-00015ba0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00015bb0: 2020 2020 2049 6620 7468 6520 636c 7573       If the clus
-00015bc0: 7465 7220 6973 2074 6572 6d69 6e61 7465  ter is terminate
-00015bd0: 6420 6f72 2064 6f65 7320 6e6f 7420 6578  d or does not ex
-00015be0: 6973 742c 2072 6574 7572 6e20 4e6f 6e65  ist, return None
-00015bf0: 2e20 4f74 6865 7277 6973 650a 2020 2020  . Otherwise.    
-00015c00: 2020 2020 7265 7475 726e 7320 7468 6520      returns the 
-00015c10: 696e 7075 7420 7265 636f 7264 2077 6974  input record wit
-00015c20: 6820 7374 6174 7573 2061 6e64 2068 616e  h status and han
-00015c30: 646c 6520 706f 7465 6e74 6961 6c6c 7920  dle potentially 
-00015c40: 7570 6461 7465 642e 0a0a 2020 2020 5261  updated...    Ra
-00015c50: 6973 6573 3a0a 2020 2020 2020 2020 6578  ises:.        ex
-00015c60: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
-00015c70: 4f77 6e65 7249 6465 6e74 6974 794d 6973  OwnerIdentityMis
-00015c80: 6d61 7463 6845 7272 6f72 3a20 6966 2074  matchError: if t
-00015c90: 6865 2063 7572 7265 6e74 2075 7365 7220  he current user 
-00015ca0: 6973 0a20 2020 2020 2020 2020 206e 6f74  is.          not
-00015cb0: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
-00015cc0: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
-00015cd0: 6420 7468 6520 636c 7573 7465 722e 0a20  d the cluster.. 
-00015ce0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-00015cf0: 732e 436c 6f75 6455 7365 7249 6465 6e74  s.CloudUserIdent
-00015d00: 6974 7945 7272 6f72 3a20 6966 2077 6520  ityError: if we 
-00015d10: 6661 696c 2074 6f20 6765 7420 7468 6520  fail to get the 
-00015d20: 6375 7272 656e 7420 7573 6572 0a20 2020  current user.   
-00015d30: 2020 2020 2020 2069 6465 6e74 6974 792e         identity.
-00015d40: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00015d50: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
-00015d60: 7346 6574 6368 696e 6745 7272 6f72 3a20  sFetchingError: 
-00015d70: 7468 6520 636c 7573 7465 7220 7374 6174  the cluster stat
-00015d80: 7573 2063 616e 6e6f 7420 6265 0a20 2020  us cannot be.   
-00015d90: 2020 2020 2020 2066 6574 6368 6564 2066         fetched f
-00015da0: 726f 6d20 7468 6520 636c 6f75 6420 7072  rom the cloud pr
-00015db0: 6f76 6964 6572 206f 7220 7468 6572 6520  ovider or there 
-00015dc0: 6172 6520 6c65 616b 6564 206e 6f64 6573  are leaked nodes
-00015dd0: 2063 6175 7369 6e67 0a20 2020 2020 2020   causing.       
-00015de0: 2020 2074 6865 206e 6f64 6520 6e75 6d62     the node numb
-00015df0: 6572 206c 6172 6765 7220 7468 616e 2065  er larger than e
-00015e00: 7870 6563 7465 642e 0a20 2020 2022 2222  xpected..    """
-00015e10: 0a20 2020 2069 6620 6e6f 7420 6163 7175  .    if not acqu
-00015e20: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00015e30: 7374 6174 7573 5f6c 6f63 6b3a 0a20 2020  status_lock:.   
-00015e40: 2020 2020 2072 6574 7572 6e20 5f75 7064       return _upd
-00015e50: 6174 655f 636c 7573 7465 725f 7374 6174  ate_cluster_stat
-00015e60: 7573 5f6e 6f5f 6c6f 636b 2863 6c75 7374  us_no_lock(clust
-00015e70: 6572 5f6e 616d 6529 0a0a 2020 2020 7472  er_name)..    tr
-00015e80: 793a 0a20 2020 2020 2020 2077 6974 6820  y:.        with 
-00015e90: 6669 6c65 6c6f 636b 2e46 696c 654c 6f63  filelock.FileLoc
-00015ea0: 6b28 434c 5553 5445 525f 5354 4154 5553  k(CLUSTER_STATUS
-00015eb0: 5f4c 4f43 4b5f 5041 5448 2e66 6f72 6d61  _LOCK_PATH.forma
-00015ec0: 7428 636c 7573 7465 725f 6e61 6d65 292c  t(cluster_name),
-00015ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ef0: 7469 6d65 6f75 743d 636c 7573 7465 725f  timeout=cluster_
-00015f00: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
-00015f10: 6f75 7429 3a0a 2020 2020 2020 2020 2020  out):.          
-00015f20: 2020 7265 7475 726e 205f 7570 6461 7465    return _update
-00015f30: 5f63 6c75 7374 6572 5f73 7461 7475 735f  _cluster_status_
-00015f40: 6e6f 5f6c 6f63 6b28 636c 7573 7465 725f  no_lock(cluster_
-00015f50: 6e61 6d65 290a 2020 2020 6578 6365 7074  name).    except
-00015f60: 2066 696c 656c 6f63 6b2e 5469 6d65 6f75   filelock.Timeou
-00015f70: 743a 0a20 2020 2020 2020 206c 6f67 6765  t:.        logge
-00015f80: 722e 6465 6275 6728 2752 6566 7265 7368  r.debug('Refresh
-00015f90: 696e 6720 7374 6174 7573 3a20 4661 696c  ing status: Fail
-00015fa0: 6564 2067 6574 2074 6865 206c 6f63 6b20  ed get the lock 
-00015fb0: 666f 7220 636c 7573 7465 7220 270a 2020  for cluster '.  
-00015fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fd0: 2020 2066 277b 636c 7573 7465 725f 6e61     f'{cluster_na
-00015fe0: 6d65 2172 7d2e 2055 7369 6e67 2074 6865  me!r}. Using the
-00015ff0: 2063 6163 6865 6420 7374 6174 7573 2e27   cached status.'
-00016000: 290a 2020 2020 2020 2020 7265 636f 7264  ).        record
-00016010: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-00016020: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-00016030: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-00016040: 6572 5f6e 616d 6529 0a20 2020 2020 2020  er_name).       
-00016050: 2072 6574 7572 6e20 7265 636f 7264 0a0a   return record..
-00016060: 0a64 6566 2072 6566 7265 7368 5f63 6c75  .def refresh_clu
-00016070: 7374 6572 5f72 6563 6f72 6428 0a20 2020  ster_record(.   
-00016080: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
-00016090: 7472 2c0a 2020 2020 2a2c 0a20 2020 2066  tr,.    *,.    f
-000160a0: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
-000160b0: 7475 7365 733a 204f 7074 696f 6e61 6c5b  tuses: Optional[
-000160c0: 5365 745b 7374 6174 7573 5f6c 6962 2e43  Set[status_lib.C
-000160d0: 6c75 7374 6572 5374 6174 7573 5d5d 203d  lusterStatus]] =
-000160e0: 204e 6f6e 652c 0a20 2020 2061 6371 7569   None,.    acqui
-000160f0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-00016100: 7461 7475 735f 6c6f 636b 3a20 626f 6f6c  tatus_lock: bool
-00016110: 203d 2054 7275 652c 0a20 2020 2063 6c75   = True,.    clu
-00016120: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00016130: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
-00016140: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
-00016150: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
-00016160: 4e44 530a 2920 2d3e 204f 7074 696f 6e61  NDS.) -> Optiona
-00016170: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
-00016180: 5d3a 0a20 2020 2022 2222 5265 6672 6573  ]:.    """Refres
-00016190: 6820 7468 6520 636c 7573 7465 722c 2061  h the cluster, a
-000161a0: 6e64 2072 6574 7572 6e20 7468 6520 706f  nd return the po
-000161b0: 7373 6962 6c79 2075 7064 6174 6564 2072  ssibly updated r
-000161c0: 6563 6f72 642e 0a0a 2020 2020 5468 6973  ecord...    This
-000161d0: 2066 756e 6374 696f 6e20 7769 6c6c 2061   function will a
-000161e0: 6c73 6f20 6368 6563 6b20 7468 6520 6f77  lso check the ow
-000161f0: 6e65 7220 6964 656e 7469 7479 206f 6620  ner identity of 
-00016200: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
-00016210: 2072 6169 7365 0a20 2020 2065 7863 6570   raise.    excep
-00016220: 7469 6f6e 7320 6966 2074 6865 2063 7572  tions if the cur
-00016230: 7265 6e74 2075 7365 7220 6973 206e 6f74  rent user is not
-00016240: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
-00016250: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
-00016260: 6420 7468 650a 2020 2020 636c 7573 7465  d the.    cluste
-00016270: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
-00016280: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
-00016290: 6d65 3a20 5468 6520 6e61 6d65 206f 6620  me: The name of 
-000162a0: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
-000162b0: 2020 2020 2066 6f72 6365 5f72 6566 7265       force_refre
-000162c0: 7368 5f73 7461 7475 7365 733a 2069 6620  sh_statuses: if 
-000162d0: 7370 6563 6966 6965 642c 2072 6566 7265  specified, refre
-000162e0: 7368 2074 6865 2063 6c75 7374 6572 2069  sh the cluster i
-000162f0: 6620 6974 2068 6173 206f 6e65 206f 660a  f it has one of.
-00016300: 2020 2020 2020 2020 2020 7468 6520 7370            the sp
-00016310: 6563 6966 6965 6420 7374 6174 7573 6573  ecified statuses
-00016320: 2e20 4164 6469 7469 6f6e 616c 6c79 2c20  . Additionally, 
-00016330: 636c 7573 7465 7273 2073 6174 6973 6679  clusters satisfy
-00016340: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
-00016350: 2020 666f 6c6c 6f77 696e 6720 636f 6e64    following cond
-00016360: 6974 696f 6e73 2077 696c 6c20 616c 7761  itions will alwa
-00016370: 7973 2062 6520 7265 6672 6573 6865 6420  ys be refreshed 
-00016380: 6e6f 206d 6174 7465 7220 7468 650a 2020  no matter the.  
-00016390: 2020 2020 2020 2020 6172 6775 6d65 6e74          argument
-000163a0: 2069 7320 7370 6563 6966 6965 6420 6f72   is specified or
-000163b0: 206e 6f74 3a0a 2020 2020 2020 2020 2020   not:.          
-000163c0: 2020 312e 2069 7320 6120 7370 6f74 2063    1. is a spot c
-000163d0: 6c75 7374 6572 2c20 6f72 0a20 2020 2020  luster, or.     
-000163e0: 2020 2020 2020 2032 2e20 6973 2061 206e         2. is a n
-000163f0: 6f6e 2d73 706f 7420 636c 7573 7465 722c  on-spot cluster,
-00016400: 2069 7320 6e6f 7420 5354 4f50 5045 442c   is not STOPPED,
-00016410: 2061 6e64 2061 7574 6f73 746f 7020 6973   and autostop is
-00016420: 2073 6574 2e0a 2020 2020 2020 2020 6163   set..        ac
-00016430: 7175 6972 655f 7065 725f 636c 7573 7465  quire_per_cluste
-00016440: 725f 7374 6174 7573 5f6c 6f63 6b3a 2057  r_status_lock: W
-00016450: 6865 7468 6572 2074 6f20 6163 7175 6972  hether to acquir
-00016460: 6520 7468 6520 7065 722d 636c 7573 7465  e the per-cluste
-00016470: 7220 6c6f 636b 0a20 2020 2020 2020 2020  r lock.         
-00016480: 2062 6566 6f72 6520 7570 6461 7469 6e67   before updating
-00016490: 2074 6865 2073 7461 7475 732e 0a20 2020   the status..   
-000164a0: 2020 2020 2063 6c75 7374 6572 5f73 7461       cluster_sta
-000164b0: 7475 735f 6c6f 636b 5f74 696d 656f 7574  tus_lock_timeout
-000164c0: 3a20 5468 6520 7469 6d65 6f75 7420 746f  : The timeout to
-000164d0: 2061 6371 7569 7265 2074 6865 2070 6572   acquire the per
-000164e0: 2d63 6c75 7374 6572 0a20 2020 2020 2020  -cluster.       
-000164f0: 2020 206c 6f63 6b2e 2049 6620 7469 6d65     lock. If time
-00016500: 6f75 742c 2074 6865 2066 756e 6374 696f  out, the functio
-00016510: 6e20 7769 6c6c 2075 7365 2074 6865 2063  n will use the c
-00016520: 6163 6865 6420 7374 6174 7573 2e0a 0a20  ached status... 
-00016530: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00016540: 2020 2020 4966 2074 6865 2063 6c75 7374      If the clust
-00016550: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-00016560: 206f 7220 646f 6573 206e 6f74 2065 7869   or does not exi
-00016570: 7374 2c20 7265 7475 726e 204e 6f6e 652e  st, return None.
-00016580: 0a20 2020 2020 2020 204f 7468 6572 7769  .        Otherwi
-00016590: 7365 2072 6574 7572 6e73 2074 6865 2063  se returns the c
-000165a0: 6c75 7374 6572 2072 6563 6f72 642e 0a0a  luster record...
-000165b0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-000165c0: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-000165d0: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
-000165e0: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
-000165f0: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
-00016600: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
-00016610: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
-00016620: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
-00016630: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
-00016640: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
-00016650: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
-00016660: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
-00016670: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
-00016680: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
-00016690: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
-000166a0: 6e74 6974 792e 0a20 2020 2020 2020 2065  ntity..        e
-000166b0: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-000166c0: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
-000166d0: 7272 6f72 3a20 7468 6520 636c 7573 7465  rror: the cluste
-000166e0: 7220 7374 6174 7573 2063 616e 6e6f 7420  r status cannot 
-000166f0: 6265 0a20 2020 2020 2020 2020 2066 6574  be.          fet
-00016700: 6368 6564 2066 726f 6d20 7468 6520 636c  ched from the cl
-00016710: 6f75 6420 7072 6f76 6964 6572 206f 7220  oud provider or 
-00016720: 7468 6572 6520 6172 6520 6c65 616b 6564  there are leaked
-00016730: 206e 6f64 6573 2063 6175 7369 6e67 0a20   nodes causing. 
-00016740: 2020 2020 2020 2020 2074 6865 206e 6f64           the nod
-00016750: 6520 6e75 6d62 6572 206c 6172 6765 7220  e number larger 
-00016760: 7468 616e 2065 7870 6563 7465 642e 0a20  than expected.. 
-00016770: 2020 2022 2222 0a0a 2020 2020 7265 636f     """..    reco
-00016780: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
-00016790: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
-000167a0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
-000167b0: 7374 6572 5f6e 616d 6529 0a20 2020 2069  ster_name).    i
-000167c0: 6620 7265 636f 7264 2069 7320 4e6f 6e65  f record is None
-000167d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000167e0: 204e 6f6e 650a 2020 2020 6368 6563 6b5f   None.    check_
-000167f0: 6f77 6e65 725f 6964 656e 7469 7479 2863  owner_identity(c
-00016800: 6c75 7374 6572 5f6e 616d 6529 0a0a 2020  luster_name)..  
-00016810: 2020 6861 6e64 6c65 203d 2072 6563 6f72    handle = recor
-00016820: 645b 2768 616e 646c 6527 5d0a 2020 2020  d['handle'].    
-00016830: 6966 2069 7369 6e73 7461 6e63 6528 6861  if isinstance(ha
-00016840: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
-00016850: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
-00016860: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
-00016870: 2020 7573 655f 7370 6f74 203d 2068 616e    use_spot = han
-00016880: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00016890: 6f75 7263 6573 2e75 7365 5f73 706f 740a  ources.use_spot.
-000168a0: 2020 2020 2020 2020 6861 735f 6175 746f          has_auto
-000168b0: 7374 6f70 203d 2028 7265 636f 7264 5b27  stop = (record['
-000168c0: 7374 6174 7573 275d 2021 3d20 7374 6174  status'] != stat
-000168d0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-000168e0: 6174 7573 2e53 544f 5050 4544 2061 6e64  atus.STOPPED and
-000168f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016900: 2020 2020 2020 2020 2072 6563 6f72 645b           record[
-00016910: 2761 7574 6f73 746f 7027 5d20 3e3d 2030  'autostop'] >= 0
-00016920: 290a 2020 2020 2020 2020 666f 7263 655f  ).        force_
-00016930: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
-00016940: 7465 7220 3d20 2866 6f72 6365 5f72 6566  ter = (force_ref
-00016950: 7265 7368 5f73 7461 7475 7365 7320 6973  resh_statuses is
-00016960: 206e 6f74 204e 6f6e 6520 616e 640a 2020   not None and.  
-00016970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016990: 2020 2072 6563 6f72 645b 2773 7461 7475     record['statu
-000169a0: 7327 5d20 696e 2066 6f72 6365 5f72 6566  s'] in force_ref
-000169b0: 7265 7368 5f73 7461 7475 7365 7329 0a20  resh_statuses). 
-000169c0: 2020 2020 2020 2069 6620 666f 7263 655f         if force_
-000169d0: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
-000169e0: 7465 7220 6f72 2068 6173 5f61 7574 6f73  ter or has_autos
-000169f0: 746f 7020 6f72 2075 7365 5f73 706f 743a  top or use_spot:
-00016a00: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00016a10: 6f72 6420 3d20 5f75 7064 6174 655f 636c  ord = _update_cl
-00016a20: 7573 7465 725f 7374 6174 7573 280a 2020  uster_status(.  
-00016a30: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00016a40: 7573 7465 725f 6e61 6d65 2c0a 2020 2020  uster_name,.    
-00016a50: 2020 2020 2020 2020 2020 2020 6163 7175              acqu
-00016a60: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00016a70: 7374 6174 7573 5f6c 6f63 6b3d 6163 7175  status_lock=acqu
-00016a80: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00016a90: 7374 6174 7573 5f6c 6f63 6b2c 0a20 2020  status_lock,.   
-00016aa0: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-00016ab0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00016ac0: 5f74 696d 656f 7574 3d63 6c75 7374 6572  _timeout=cluster
-00016ad0: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
-00016ae0: 656f 7574 290a 2020 2020 7265 7475 726e  eout).    return
-00016af0: 2072 6563 6f72 640a 0a0a 4074 696d 656c   record...@timel
-00016b00: 696e 652e 6576 656e 740a 6465 6620 7265  ine.event.def re
-00016b10: 6672 6573 685f 636c 7573 7465 725f 7374  fresh_cluster_st
-00016b20: 6174 7573 5f68 616e 646c 6528 0a20 2020  atus_handle(.   
-00016b30: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
-00016b40: 7472 2c0a 2020 2020 2a2c 0a20 2020 2066  tr,.    *,.    f
-00016b50: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
-00016b60: 7475 7365 733a 204f 7074 696f 6e61 6c5b  tuses: Optional[
-00016b70: 5365 745b 7374 6174 7573 5f6c 6962 2e43  Set[status_lib.C
-00016b80: 6c75 7374 6572 5374 6174 7573 5d5d 203d  lusterStatus]] =
-00016b90: 204e 6f6e 652c 0a20 2020 2061 6371 7569   None,.    acqui
-00016ba0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-00016bb0: 7461 7475 735f 6c6f 636b 3a20 626f 6f6c  tatus_lock: bool
-00016bc0: 203d 2054 7275 652c 0a20 2020 2063 6c75   = True,.    clu
-00016bd0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00016be0: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
-00016bf0: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
-00016c00: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
-00016c10: 4e44 530a 2920 2d3e 2054 7570 6c65 5b4f  NDS.) -> Tuple[O
-00016c20: 7074 696f 6e61 6c5b 7374 6174 7573 5f6c  ptional[status_l
-00016c30: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
-00016c40: 5d2c 0a20 2020 2020 2020 2020 2020 4f70  ],.           Op
-00016c50: 7469 6f6e 616c 5b62 6163 6b65 6e64 732e  tional[backends.
-00016c60: 5265 736f 7572 6365 4861 6e64 6c65 5d5d  ResourceHandle]]
-00016c70: 3a0a 2020 2020 2222 2252 6566 7265 7368  :.    """Refresh
-00016c80: 2074 6865 2063 6c75 7374 6572 2c20 616e   the cluster, an
-00016c90: 6420 7265 7475 726e 2074 6865 2070 6f73  d return the pos
-00016ca0: 7369 626c 7920 7570 6461 7465 6420 7374  sibly updated st
-00016cb0: 6174 7573 2061 6e64 2068 616e 646c 652e  atus and handle.
-00016cc0: 0a0a 2020 2020 5468 6973 2069 7320 6120  ..    This is a 
-00016cd0: 7772 6170 7065 7220 6f66 2072 6566 7265  wrapper of refre
-00016ce0: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
-00016cf0: 642c 2077 6869 6368 2072 6574 7572 6e73  d, which returns
-00016d00: 2074 6865 2073 7461 7475 7320 616e 640a   the status and.
-00016d10: 2020 2020 6861 6e64 6c65 206f 6620 7468      handle of th
-00016d20: 6520 636c 7573 7465 722e 0a20 2020 2050  e cluster..    P
-00016d30: 6c65 6173 6520 7265 6665 7220 746f 2074  lease refer to t
-00016d40: 6865 2064 6f63 7374 7269 6e67 206f 6620  he docstring of 
-00016d50: 7265 6672 6573 685f 636c 7573 7465 725f  refresh_cluster_
-00016d60: 7265 636f 7264 2066 6f72 2074 6865 2064  record for the d
-00016d70: 6574 6169 6c73 2e0a 2020 2020 2222 220a  etails..    """.
-00016d80: 2020 2020 7265 636f 7264 203d 2072 6566      record = ref
-00016d90: 7265 7368 5f63 6c75 7374 6572 5f72 6563  resh_cluster_rec
-00016da0: 6f72 6428 0a20 2020 2020 2020 2063 6c75  ord(.        clu
-00016db0: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
-00016dc0: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
-00016dd0: 5f73 7461 7475 7365 733d 666f 7263 655f  _statuses=force_
-00016de0: 7265 6672 6573 685f 7374 6174 7573 6573  refresh_statuses
-00016df0: 2c0a 2020 2020 2020 2020 6163 7175 6972  ,.        acquir
-00016e00: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-00016e10: 6174 7573 5f6c 6f63 6b3d 6163 7175 6972  atus_lock=acquir
-00016e20: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-00016e30: 6174 7573 5f6c 6f63 6b2c 0a20 2020 2020  atus_lock,.     
-00016e40: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
-00016e50: 735f 6c6f 636b 5f74 696d 656f 7574 3d63  s_lock_timeout=c
-00016e60: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
-00016e70: 636b 5f74 696d 656f 7574 290a 2020 2020  ck_timeout).    
-00016e80: 6966 2072 6563 6f72 6420 6973 204e 6f6e  if record is Non
-00016e90: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00016ea0: 6e20 4e6f 6e65 2c20 4e6f 6e65 0a20 2020  n None, None.   
-00016eb0: 2072 6574 7572 6e20 7265 636f 7264 5b27   return record['
-00016ec0: 7374 6174 7573 275d 2c20 7265 636f 7264  status'], record
-00016ed0: 5b27 6861 6e64 6c65 275d 0a0a 0a23 203d  ['handle']...# =
-00016ee0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016ef0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016f00: 3d3d 3d3d 0a0a 0a40 7479 7069 6e67 2e6f  ====...@typing.o
-00016f10: 7665 726c 6f61 640a 6465 6620 6368 6563  verload.def chec
-00016f20: 6b5f 636c 7573 7465 725f 6176 6169 6c61  k_cluster_availa
-00016f30: 626c 6528 0a20 2020 2063 6c75 7374 6572  ble(.    cluster
-00016f40: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
-00016f50: 2a2c 0a20 2020 206f 7065 7261 7469 6f6e  *,.    operation
-00016f60: 3a20 7374 722c 0a20 2020 2063 6865 636b  : str,.    check
-00016f70: 5f63 6c6f 7564 5f76 6d5f 7261 795f 6261  _cloud_vm_ray_ba
-00016f80: 636b 656e 643a 204c 6974 6572 616c 5b54  ckend: Literal[T
-00016f90: 7275 655d 203d 2054 7275 652c 0a20 2020  rue] = True,.   
-00016fa0: 2064 7279 7275 6e3a 2062 6f6f 6c20 3d20   dryrun: bool = 
-00016fb0: 2e2e 2e2c 0a29 202d 3e20 2763 6c6f 7564  ...,.) -> 'cloud
-00016fc0: 5f76 6d5f 7261 795f 6261 636b 656e 642e  _vm_ray_backend.
-00016fd0: 436c 6f75 6456 6d52 6179 5265 736f 7572  CloudVmRayResour
-00016fe0: 6365 4861 6e64 6c65 273a 0a20 2020 202e  ceHandle':.    .
-00016ff0: 2e2e 0a0a 0a40 7479 7069 6e67 2e6f 7665  .....@typing.ove
-00017000: 726c 6f61 640a 6465 6620 6368 6563 6b5f  rload.def check_
-00017010: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
-00017020: 6528 0a20 2020 2063 6c75 7374 6572 5f6e  e(.    cluster_n
-00017030: 616d 653a 2073 7472 2c0a 2020 2020 2a2c  ame: str,.    *,
-00017040: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
-00017050: 7374 722c 0a20 2020 2063 6865 636b 5f63  str,.    check_c
-00017060: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
-00017070: 656e 643a 204c 6974 6572 616c 5b46 616c  end: Literal[Fal
-00017080: 7365 5d2c 0a20 2020 2064 7279 7275 6e3a  se],.    dryrun:
-00017090: 2062 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d   bool = ...,.) -
-000170a0: 3e20 6261 636b 656e 6473 2e52 6573 6f75  > backends.Resou
-000170b0: 7263 6548 616e 646c 653a 0a20 2020 202e  rceHandle:.    .
-000170c0: 2e2e 0a0a 0a64 6566 2063 6865 636b 5f63  .....def check_c
-000170d0: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
-000170e0: 280a 2020 2020 636c 7573 7465 725f 6e61  (.    cluster_na
-000170f0: 6d65 3a20 7374 722c 0a20 2020 202a 2c0a  me: str,.    *,.
-00017100: 2020 2020 6f70 6572 6174 696f 6e3a 2073      operation: s
-00017110: 7472 2c0a 2020 2020 6368 6563 6b5f 636c  tr,.    check_cl
-00017120: 6f75 645f 766d 5f72 6179 5f62 6163 6b65  oud_vm_ray_backe
-00017130: 6e64 3a20 626f 6f6c 203d 2054 7275 652c  nd: bool = True,
-00017140: 0a20 2020 2064 7279 7275 6e3a 2062 6f6f  .    dryrun: boo
-00017150: 6c20 3d20 4661 6c73 652c 0a29 202d 3e20  l = False,.) -> 
-00017160: 6261 636b 656e 6473 2e52 6573 6f75 7263  backends.Resourc
-00017170: 6548 616e 646c 653a 0a20 2020 2022 2222  eHandle:.    """
-00017180: 4368 6563 6b20 6966 2074 6865 2063 6c75  Check if the clu
-00017190: 7374 6572 2069 7320 6176 6169 6c61 626c  ster is availabl
-000171a0: 652e 0a0a 2020 2020 5261 6973 6573 3a0a  e...    Raises:.
-000171b0: 2020 2020 2020 2020 5661 6c75 6545 7272          ValueErr
-000171c0: 6f72 3a20 6966 2074 6865 2063 6c75 7374  or: if the clust
-000171d0: 6572 2064 6f65 7320 6e6f 7420 6578 6973  er does not exis
-000171e0: 742e 0a20 2020 2020 2020 2065 7863 6570  t..        excep
-000171f0: 7469 6f6e 732e 436c 7573 7465 724e 6f74  tions.ClusterNot
-00017200: 5570 4572 726f 723a 2069 6620 7468 6520  UpError: if the 
-00017210: 636c 7573 7465 7220 6973 206e 6f74 2055  cluster is not U
-00017220: 502e 0a20 2020 2020 2020 2065 7863 6570  P..        excep
-00017230: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
-00017240: 6564 4572 726f 723a 2069 6620 7468 6520  edError: if the 
-00017250: 636c 7573 7465 7220 6973 206e 6f74 2062  cluster is not b
-00017260: 6173 6564 206f 6e0a 2020 2020 2020 2020  ased on.        
-00017270: 2020 436c 6f75 6456 6d52 6179 4261 636b    CloudVmRayBack
-00017280: 656e 642e 0a20 2020 2020 2020 2065 7863  end..        exc
-00017290: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
-000172a0: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
-000172b0: 6174 6368 4572 726f 723a 2069 6620 7468  atchError: if th
-000172c0: 6520 6375 7272 656e 7420 7573 6572 2069  e current user i
-000172d0: 730a 2020 2020 2020 2020 2020 6e6f 7420  s.          not 
-000172e0: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
-000172f0: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
-00017300: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
-00017310: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00017320: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
-00017330: 7479 4572 726f 723a 2069 6620 7765 2066  tyError: if we f
-00017340: 6169 6c20 746f 2067 6574 2074 6865 2063  ail to get the c
-00017350: 7572 7265 6e74 2075 7365 720a 2020 2020  urrent user.    
-00017360: 2020 2020 2020 6964 656e 7469 7479 2e0a        identity..
-00017370: 2020 2020 2222 220a 2020 2020 7265 636f      """.    reco
-00017380: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
-00017390: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
-000173a0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
-000173b0: 7374 6572 5f6e 616d 6529 0a20 2020 2069  ster_name).    i
-000173c0: 6620 6472 7972 756e 3a0a 2020 2020 2020  f dryrun:.      
-000173d0: 2020 6173 7365 7274 2072 6563 6f72 6420    assert record 
-000173e0: 6973 206e 6f74 204e 6f6e 652c 2063 6c75  is not None, clu
-000173f0: 7374 6572 5f6e 616d 650a 2020 2020 2020  ster_name.      
-00017400: 2020 7265 7475 726e 2072 6563 6f72 645b    return record[
-00017410: 2768 616e 646c 6527 5d0a 0a20 2020 2070  'handle']..    p
-00017420: 7265 7669 6f75 735f 636c 7573 7465 725f  revious_cluster_
-00017430: 7374 6174 7573 203d 204e 6f6e 650a 2020  status = None.  
-00017440: 2020 6966 2072 6563 6f72 6420 6973 206e    if record is n
-00017450: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00017460: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
-00017470: 725f 7374 6174 7573 203d 2072 6563 6f72  r_status = recor
-00017480: 645b 2773 7461 7475 7327 5d0a 0a20 2020  d['status']..   
-00017490: 2074 7279 3a0a 2020 2020 2020 2020 636c   try:.        cl
-000174a0: 7573 7465 725f 7374 6174 7573 2c20 6861  uster_status, ha
-000174b0: 6e64 6c65 203d 2072 6566 7265 7368 5f63  ndle = refresh_c
-000174c0: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
-000174d0: 6e64 6c65 2863 6c75 7374 6572 5f6e 616d  ndle(cluster_nam
-000174e0: 6529 0a20 2020 2065 7863 6570 7420 6578  e).    except ex
-000174f0: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
-00017500: 5374 6174 7573 4665 7463 6869 6e67 4572  StatusFetchingEr
-00017510: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-00017520: 2020 2320 4661 696c 6564 2074 6f20 7265    # Failed to re
-00017530: 6672 6573 6820 7468 6520 636c 7573 7465  fresh the cluste
-00017540: 7220 7374 6174 7573 2069 7320 6e6f 7420  r status is not 
-00017550: 6661 7461 6c20 6572 726f 7220 6173 2074  fatal error as t
-00017560: 6865 2063 616c 6c65 7273 0a20 2020 2020  he callers.     
-00017570: 2020 2023 2063 616e 2073 7469 6c6c 2062     # can still b
-00017580: 6520 646f 6e65 2062 7920 6f6e 6c79 2075  e done by only u
-00017590: 7369 6e67 2073 7368 2c20 6275 7420 7468  sing ssh, but th
-000175a0: 6520 7373 6820 6361 6e20 6861 6e67 2069  e ssh can hang i
-000175b0: 6620 7468 650a 2020 2020 2020 2020 2320  f the.        # 
-000175c0: 636c 7573 7465 7220 6973 206e 6f74 2075  cluster is not u
-000175d0: 7020 2865 2e67 2e2c 2061 7574 6f73 746f  p (e.g., autosto
-000175e0: 7070 6564 292e 0a0a 2020 2020 2020 2020  pped)...        
-000175f0: 2320 5765 2064 6f20 6e6f 7420 6361 7463  # We do not catc
-00017600: 6820 7468 6520 6578 6365 7074 696f 6e20  h the exception 
-00017610: 666f 7220 636c 6f75 6420 6964 656e 7469  for cloud identi
-00017620: 7479 2063 6865 636b 696e 6720 666f 7220  ty checking for 
-00017630: 6e6f 772c 2069 6e0a 2020 2020 2020 2020  now, in.        
-00017640: 2320 6f72 6465 7220 746f 2064 6973 6162  # order to disab
-00017650: 6c65 2061 6c6c 206f 7065 7261 7469 6f6e  le all operation
-00017660: 7320 6f6e 2063 6c75 7374 6572 7320 6372  s on clusters cr
-00017670: 6561 7465 6420 6279 2061 6e6f 7468 6572  eated by another
-00017680: 2075 7365 720a 2020 2020 2020 2020 2320   user.        # 
-00017690: 6964 656e 7469 7479 2e20 2054 6861 7420  identity.  That 
-000176a0: 7769 6c6c 206d 616b 6520 7468 6520 6465  will make the de
-000176b0: 7369 676e 2073 696d 706c 6572 2061 6e64  sign simpler and
-000176c0: 2065 6173 6965 7220 746f 0a20 2020 2020   easier to.     
-000176d0: 2020 2023 2075 6e64 6572 7374 616e 642c     # understand,
-000176e0: 2062 7574 2069 7420 6d69 6768 7420 6265   but it might be
-000176f0: 2075 7365 6675 6c20 746f 2061 6c6c 6f77   useful to allow
-00017700: 2074 6865 2075 7365 7220 746f 2075 7365   the user to use
-00017710: 0a20 2020 2020 2020 2023 206f 7065 7261  .        # opera
-00017720: 7469 6f6e 7320 7468 6174 206f 6e6c 7920  tions that only 
-00017730: 696e 766f 6c76 6520 7373 6820 2865 2e67  involve ssh (e.g
-00017740: 2e2c 2073 6b79 2065 7865 632c 2073 6b79  ., sky exec, sky
-00017750: 206c 6f67 732c 2065 7463 2920 6576 656e   logs, etc) even
-00017760: 0a20 2020 2020 2020 2023 2069 6620 7468  .        # if th
-00017770: 6520 7573 6572 2069 7320 6e6f 7420 7468  e user is not th
-00017780: 6520 6f77 6e65 7220 6f66 2074 6865 2063  e owner of the c
-00017790: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
-000177a0: 7578 5f75 7469 6c73 2e63 6f6e 736f 6c65  ux_utils.console
-000177b0: 5f6e 6577 6c69 6e65 2829 0a20 2020 2020  _newline().     
-000177c0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-000177d0: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
-000177e0: 2746 6169 6c65 6420 746f 2072 6566 7265  'Failed to refre
-000177f0: 7368 2074 6865 2073 7461 7475 7320 666f  sh the status fo
-00017800: 7220 636c 7573 7465 7220 7b63 6c75 7374  r cluster {clust
-00017810: 6572 5f6e 616d 6521 727d 2e20 4974 2069  er_name!r}. It i
-00017820: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-00017830: 6627 6e6f 7420 6661 7461 6c2c 2062 7574  f'not fatal, but
-00017840: 207b 6f70 6572 6174 696f 6e7d 206d 6967   {operation} mig
-00017850: 6874 2068 616e 6720 6966 2074 6865 2063  ht hang if the c
-00017860: 6c75 7374 6572 2069 7320 6e6f 7420 7570  luster is not up
-00017870: 2e5c 6e27 0a20 2020 2020 2020 2020 2020  .\n'.           
-00017880: 2066 2744 6574 6169 6c65 6420 7265 6173   f'Detailed reas
-00017890: 6f6e 3a20 7b65 7d27 290a 2020 2020 2020  on: {e}').      
-000178a0: 2020 6966 2072 6563 6f72 6420 6973 204e    if record is N
-000178b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000178c0: 2063 6c75 7374 6572 5f73 7461 7475 732c   cluster_status,
-000178d0: 2068 616e 646c 6520 3d20 4e6f 6e65 2c20   handle = None, 
-000178e0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
-000178f0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00017900: 6c75 7374 6572 5f73 7461 7475 732c 2068  luster_status, h
-00017910: 616e 646c 6520 3d20 7265 636f 7264 5b27  andle = record['
-00017920: 7374 6174 7573 275d 2c20 7265 636f 7264  status'], record
-00017930: 5b27 6861 6e64 6c65 275d 0a0a 2020 2020  ['handle']..    
-00017940: 6272 6967 6874 203d 2063 6f6c 6f72 616d  bright = coloram
-00017950: 612e 5374 796c 652e 4252 4947 4854 0a20  a.Style.BRIGHT. 
-00017960: 2020 2072 6573 6574 203d 2063 6f6c 6f72     reset = color
-00017970: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
-00017980: 414c 4c0a 2020 2020 6966 2068 616e 646c  ALL.    if handl
-00017990: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-000179a0: 2020 2069 6620 7072 6576 696f 7573 5f63     if previous_c
-000179b0: 6c75 7374 6572 5f73 7461 7475 7320 6973  luster_status is
-000179c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000179d0: 2020 2065 7272 6f72 5f6d 7367 203d 2066     error_msg = f
-000179e0: 2743 6c75 7374 6572 207b 636c 7573 7465  'Cluster {cluste
-000179f0: 725f 6e61 6d65 2172 7d20 646f 6573 206e  r_name!r} does n
-00017a00: 6f74 2065 7869 7374 2e27 0a20 2020 2020  ot exist.'.     
-00017a10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00017a20: 2020 2020 2065 7272 6f72 5f6d 7367 203d       error_msg =
-00017a30: 2028 6627 436c 7573 7465 7220 7b63 6c75   (f'Cluster {clu
-00017a40: 7374 6572 5f6e 616d 6521 727d 206e 6f74  ster_name!r} not
-00017a50: 2066 6f75 6e64 206f 6e20 7468 6520 636c   found on the cl
-00017a60: 6f75 6420 270a 2020 2020 2020 2020 2020  oud '.          
-00017a70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00017a80: 7072 6f76 6964 6572 2e27 290a 2020 2020  provider.').    
-00017a90: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00017aa0: 6563 6f72 6420 6973 206e 6f74 204e 6f6e  ecord is not Non
-00017ab0: 652c 2070 7265 7669 6f75 735f 636c 7573  e, previous_clus
-00017ac0: 7465 725f 7374 6174 7573 0a20 2020 2020  ter_status.     
-00017ad0: 2020 2020 2020 2061 6374 696f 6e73 203d         actions =
-00017ae0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00017af0: 6966 2072 6563 6f72 645b 2768 616e 646c  if record['handl
-00017b00: 6527 5d2e 6c61 756e 6368 6564 5f72 6573  e'].launched_res
-00017b10: 6f75 7263 6573 2e75 7365 5f73 706f 743a  ources.use_spot:
-00017b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017b30: 2061 6374 696f 6e73 2e61 7070 656e 6428   actions.append(
-00017b40: 2770 7265 656d 7074 6564 2729 0a20 2020  'preempted').   
-00017b50: 2020 2020 2020 2020 2069 6620 7265 636f           if reco
-00017b60: 7264 5b27 6175 746f 7374 6f70 275d 203e  rd['autostop'] >
-00017b70: 2030 2061 6e64 2072 6563 6f72 645b 2774   0 and record['t
-00017b80: 6f5f 646f 776e 275d 3a0a 2020 2020 2020  o_down']:.      
-00017b90: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
-00017ba0: 732e 6170 7065 6e64 2827 6175 746f 646f  s.append('autodo
-00017bb0: 776e 6564 2729 0a20 2020 2020 2020 2020  wned').         
-00017bc0: 2020 2061 6374 696f 6e73 2e61 7070 656e     actions.appen
-00017bd0: 6428 276d 616e 7561 6c6c 7920 7465 726d  d('manually term
-00017be0: 696e 6174 6564 2069 6e20 636f 6e73 6f6c  inated in consol
-00017bf0: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-00017c00: 6966 206c 656e 2861 6374 696f 6e73 2920  if len(actions) 
-00017c10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00017c20: 2020 2020 2061 6374 696f 6e73 5b2d 315d       actions[-1]
-00017c30: 203d 2027 6f72 2027 202b 2061 6374 696f   = 'or ' + actio
-00017c40: 6e73 5b2d 315d 0a20 2020 2020 2020 2020  ns[-1].         
-00017c50: 2020 2061 6374 696f 6e73 5f73 7472 203d     actions_str =
-00017c60: 2027 2c20 272e 6a6f 696e 2861 6374 696f   ', '.join(actio
-00017c70: 6e73 290a 2020 2020 2020 2020 2020 2020  ns).            
-00017c80: 6d65 7373 6167 6520 3d20 6627 2049 7420  message = f' It 
-00017c90: 7761 7320 6c69 6b65 6c79 207b 6163 7469  was likely {acti
-00017ca0: 6f6e 735f 7374 727d 2e27 0a20 2020 2020  ons_str}.'.     
-00017cb0: 2020 2020 2020 2069 6620 6c65 6e28 6163         if len(ac
-00017cc0: 7469 6f6e 7329 203e 2031 3a0a 2020 2020  tions) > 1:.    
-00017cd0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-00017ce0: 6167 6520 3d20 6d65 7373 6167 652e 7265  age = message.re
-00017cf0: 706c 6163 6528 276c 696b 656c 7927 2c20  place('likely', 
-00017d00: 2765 6974 6865 7227 290a 2020 2020 2020  'either').      
-00017d10: 2020 2020 2020 6572 726f 725f 6d73 6720        error_msg 
-00017d20: 2b3d 206d 6573 7361 6765 0a0a 2020 2020  += message..    
-00017d30: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-00017d40: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-00017d50: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-00017d60: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00017d70: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00017d80: 277b 636f 6c6f 7261 6d61 2e46 6f72 652e  '{colorama.Fore.
-00017d90: 5945 4c4c 4f57 7d7b 6572 726f 725f 6d73  YELLOW}{error_ms
-00017da0: 677d 7b72 6573 6574 7d27 290a 2020 2020  g}{reset}').    
-00017db0: 6173 7365 7274 2063 6c75 7374 6572 5f73  assert cluster_s
-00017dc0: 7461 7475 7320 6973 206e 6f74 204e 6f6e  tatus is not Non
-00017dd0: 652c 2027 6861 6e64 6c65 2069 7320 6e6f  e, 'handle is no
-00017de0: 7420 4e6f 6e65 2062 7574 2073 7461 7475  t None but statu
-00017df0: 7320 6973 204e 6f6e 6527 0a20 2020 2062  s is None'.    b
-00017e00: 6163 6b65 6e64 203d 2067 6574 5f62 6163  ackend = get_bac
-00017e10: 6b65 6e64 5f66 726f 6d5f 6861 6e64 6c65  kend_from_handle
-00017e20: 2868 616e 646c 6529 0a20 2020 2069 6620  (handle).    if 
-00017e30: 6368 6563 6b5f 636c 6f75 645f 766d 5f72  check_cloud_vm_r
-00017e40: 6179 5f62 6163 6b65 6e64 2061 6e64 206e  ay_backend and n
-00017e50: 6f74 2069 7369 6e73 7461 6e63 6528 0a20  ot isinstance(. 
-00017e60: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-00017e70: 6e64 2c20 6261 636b 656e 6473 2e43 6c6f  nd, backends.Clo
-00017e80: 7564 566d 5261 7942 6163 6b65 6e64 293a  udVmRayBackend):
-00017e90: 0a20 2020 2020 2020 2077 6974 6820 7578  .        with ux
-00017ea0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
-00017eb0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
-00017ec0: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
-00017ed0: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
-00017ee0: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
-00017ef0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00017f00: 2020 2020 2020 2066 277b 636f 6c6f 7261         f'{colora
+0000f1a0: 2020 2066 2772 6179 2067 6574 2d77 6f72     f'ray get-wor
+0000f1b0: 6b65 722d 6970 7320 7b66 756c 6c5f 636c  ker-ips {full_cl
+0000f1c0: 7573 7465 725f 7961 6d6c 2172 7d27 2c0a  uster_yaml!r}',.
+0000f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f1e0: 2020 2020 7374 646f 7574 3d73 7562 7072      stdout=subpr
+0000f1f0: 6f63 6573 732e 5049 5045 2c0a 2020 2020  ocess.PIPE,.    
+0000f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f210: 7374 6465 7272 3d73 7562 7072 6f63 6573  stderr=subproces
+0000f220: 732e 5049 5045 290a 2020 2020 2020 2020  s.PIPE).        
+0000f230: 2020 2020 2020 2020 6f75 7420 3d20 7072          out = pr
+0000f240: 6f63 2e73 7464 6f75 742e 6465 636f 6465  oc.stdout.decode
+0000f250: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000f260: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+0000f270: 2020 2020 2065 7863 6570 7420 7375 6270       except subp
+0000f280: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
+0000f290: 6365 7373 4572 726f 7220 6173 2065 3a0a  cessError as e:.
+0000f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2b0: 6966 2072 6574 7279 5f63 6e74 203d 3d20  if retry_cnt == 
+0000f2c0: 776f 726b 6572 5f69 705f 6d61 785f 6174  worker_ip_max_at
+0000f2d0: 7465 6d70 7473 202d 2031 3a0a 2020 2020  tempts - 1:.    
+0000f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2f0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+0000f300: 2e46 6574 6368 4950 4572 726f 7228 0a20  .FetchIPError(. 
+0000f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f320: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0000f330: 732e 4665 7463 6849 5045 7272 6f72 2e52  s.FetchIPError.R
+0000f340: 6561 736f 6e2e 574f 524b 4552 2920 6672  eason.WORKER) fr
+0000f350: 6f6d 2065 0a20 2020 2020 2020 2020 2020  om e.           
+0000f360: 2020 2020 2023 2052 6574 7279 2069 6620       # Retry if 
+0000f370: 7468 6520 7373 6820 6973 206e 6f74 2072  the ssh is not r
+0000f380: 6561 6479 2066 6f72 2074 6865 2077 6f72  eady for the wor
+0000f390: 6b65 7273 2079 6574 2e0a 2020 2020 2020  kers yet..      
+0000f3a0: 2020 2020 2020 2020 2020 6261 636b 6f66            backof
+0000f3b0: 665f 7469 6d65 203d 2062 6163 6b6f 6666  f_time = backoff
+0000f3c0: 2e63 7572 7265 6e74 5f62 6163 6b6f 6666  .current_backoff
+0000f3d0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000f3e0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0000f3f0: 2752 6574 7279 696e 6720 746f 2067 6574  'Retrying to get
+0000f400: 2077 6f72 6b65 7220 6970 2027 0a20 2020   worker ip '.   
+0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f420: 2020 2020 2020 2020 2020 6627 5b7b 7265            f'[{re
+0000f430: 7472 795f 636e 747d 2f7b 776f 726b 6572  try_cnt}/{worker
+0000f440: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
+0000f450: 7d5d 2069 6e20 270a 2020 2020 2020 2020  }] in '.        
+0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f470: 2020 2020 2066 277b 6261 636b 6f66 665f       f'{backoff_
+0000f480: 7469 6d65 7d20 7365 636f 6e64 732e 2729  time} seconds.')
+0000f490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f4a0: 2074 696d 652e 736c 6565 7028 6261 636b   time.sleep(back
+0000f4b0: 6f66 665f 7469 6d65 290a 2020 2020 2020  off_time).      
+0000f4c0: 2020 776f 726b 6572 5f69 7073 203d 2072    worker_ips = r
+0000f4d0: 652e 6669 6e64 616c 6c28 4950 5f41 4444  e.findall(IP_ADD
+0000f4e0: 525f 5245 4745 582c 206f 7574 290a 2020  R_REGEX, out).  
+0000f4f0: 2020 2020 2020 6966 206c 656e 2877 6f72        if len(wor
+0000f500: 6b65 725f 6970 7329 2021 3d20 6578 7065  ker_ips) != expe
+0000f510: 6374 6564 5f6e 756d 5f6e 6f64 6573 202d  cted_num_nodes -
+0000f520: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0000f530: 6e20 3d20 6578 7065 6374 6564 5f6e 756d  n = expected_num
+0000f540: 5f6e 6f64 6573 202d 2031 0a20 2020 2020  _nodes - 1.     
+0000f550: 2020 2020 2020 2069 6620 6c65 6e28 776f         if len(wo
+0000f560: 726b 6572 5f69 7073 2920 3e20 6e3a 0a20  rker_ips) > n:. 
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000f580: 2054 6869 7320 636f 756c 6420 6265 2074   This could be t
+0000f590: 7269 6767 6572 6564 2069 6620 652e 672e  riggered if e.g.
+0000f5a0: 2c20 736f 6d65 206c 6f67 6769 6e67 2069  , some logging i
+0000f5b0: 7320 6164 6465 6420 696e 0a20 2020 2020  s added in.     
+0000f5c0: 2020 2020 2020 2020 2020 2023 2073 6b79             # sky
+0000f5d0: 7069 6c6f 745f 636f 6e66 6967 2c20 6120  pilot_config, a 
+0000f5e0: 6d6f 6475 6c65 2074 6861 7420 6861 7320  module that has 
+0000f5f0: 736f 6d65 2063 6f64 6520 6578 6563 7574  some code execut
+0000f600: 6564 2077 6865 6e65 7665 720a 2020 2020  ed whenever.    
+0000f610: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
+0000f620: 6b79 6020 6973 2069 6d70 6f72 7465 642e  ky` is imported.
+0000f630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f640: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+0000f650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f660: 2020 2020 2066 2745 7870 6563 7465 6420       f'Expected 
+0000f670: 7b6e 7d20 776f 726b 6572 2049 5028 7329  {n} worker IP(s)
+0000f680: 3b20 666f 756e 6420 270a 2020 2020 2020  ; found '.      
+0000f690: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000f6a0: 7b6c 656e 2877 6f72 6b65 725f 6970 7329  {len(worker_ips)
+0000f6b0: 7d3a 207b 776f 726b 6572 5f69 7073 7d27  }: {worker_ips}'
+0000f6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f6d0: 2020 2020 2027 5c6e 5468 6973 2063 6f75       '\nThis cou
+0000f6e0: 6c64 2068 6170 7065 6e20 6966 2074 6865  ld happen if the
+0000f6f0: 7265 2069 7320 6578 7472 6120 6f75 7470  re is extra outp
+0000f700: 7574 2066 726f 6d20 270a 2020 2020 2020  ut from '.      
+0000f710: 2020 2020 2020 2020 2020 2020 2020 2760                '`
+0000f720: 7261 7920 6765 742d 776f 726b 6572 2d69  ray get-worker-i
+0000f730: 7073 602c 2077 6869 6368 2073 686f 756c  ps`, which shoul
+0000f740: 6420 6265 2069 6e73 7065 6374 6564 2062  d be inspected b
+0000f750: 656c 6f77 2e27 0a20 2020 2020 2020 2020  elow.'.         
+0000f760: 2020 2020 2020 2020 2020 2066 275c 6e3d             f'\n=
+0000f770: 3d20 4f75 7470 7574 203d 3d5c 6e7b 6f75  = Output ==\n{ou
+0000f780: 747d 270a 2020 2020 2020 2020 2020 2020  t}'.            
+0000f790: 2020 2020 2020 2020 6627 5c6e 3d3d 204f          f'\n== O
+0000f7a0: 7574 7075 7420 656e 6473 203d 3d27 290a  utput ends ==').
+0000f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7c0: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
+0000f7d0: 275c 6e50 726f 6365 6564 696e 6720 7769  '\nProceeding wi
+0000f7e0: 7468 2074 6865 206c 6173 7420 7b6e 7d20  th the last {n} 
+0000f7f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f810: 2066 2764 6574 6563 7465 6420 4950 2873   f'detected IP(s
+0000f820: 293a 207b 776f 726b 6572 5f69 7073 5b2d  ): {worker_ips[-
+0000f830: 6e3a 5d7d 2e27 290a 2020 2020 2020 2020  n:]}.').        
+0000f840: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
+0000f850: 7073 203d 2077 6f72 6b65 725f 6970 735b  ps = worker_ips[
+0000f860: 2d6e 3a5d 0a20 2020 2020 2020 2020 2020  -n:].           
+0000f870: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000f880: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000f890: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000f8a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000f8b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000f8c0: 696f 6e73 2e46 6574 6368 4950 4572 726f  ions.FetchIPErro
+0000f8d0: 722e 5265 6173 6f6e 2e57 4f52 4b45 5229  r.Reason.WORKER)
+0000f8e0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000f8f0: 2020 2077 6f72 6b65 725f 6970 7320 3d20     worker_ips = 
+0000f900: 5b5d 0a20 2020 2072 6574 7572 6e20 6865  [].    return he
+0000f910: 6164 5f69 705f 6c69 7374 202b 2077 6f72  ad_ip_list + wor
+0000f920: 6b65 725f 6970 730a 0a0a 6465 6620 6368  ker_ips...def ch
+0000f930: 6563 6b5f 6e65 7477 6f72 6b5f 636f 6e6e  eck_network_conn
+0000f940: 6563 7469 6f6e 2829 3a0a 2020 2020 2320  ection():.    # 
+0000f950: 546f 6c65 7261 7465 2033 2072 6574 7269  Tolerate 3 retri
+0000f960: 6573 2061 7320 6974 2069 7320 6f62 7365  es as it is obse
+0000f970: 7276 6564 2074 6861 7420 636f 6e6e 6563  rved that connec
+0000f980: 7469 6f6e 7320 6361 6e20 6661 696c 2e0a  tions can fail..
+0000f990: 2020 2020 6164 6170 7465 7220 3d20 6164      adapter = ad
+0000f9a0: 6170 7465 7273 2e48 5454 5041 6461 7074  apters.HTTPAdapt
+0000f9b0: 6572 286d 6178 5f72 6574 7269 6573 3d72  er(max_retries=r
+0000f9c0: 6574 7279 5f6c 6962 2e52 6574 7279 2874  etry_lib.Retry(t
+0000f9d0: 6f74 616c 3d33 2929 0a20 2020 2068 7474  otal=3)).    htt
+0000f9e0: 7020 3d20 7265 7175 6573 7473 2e53 6573  p = requests.Ses
+0000f9f0: 7369 6f6e 2829 0a20 2020 2068 7474 702e  sion().    http.
+0000fa00: 6d6f 756e 7428 2768 7474 7073 3a2f 2f27  mount('https://'
+0000fa10: 2c20 6164 6170 7465 7229 0a20 2020 2068  , adapter).    h
+0000fa20: 7474 702e 6d6f 756e 7428 2768 7474 703a  ttp.mount('http:
+0000fa30: 2f2f 272c 2061 6461 7074 6572 290a 2020  //', adapter).  
+0000fa40: 2020 666f 7220 692c 2069 7020 696e 2065    for i, ip in e
+0000fa50: 6e75 6d65 7261 7465 285f 5445 5354 5f49  numerate(_TEST_I
+0000fa60: 505f 4c49 5354 293a 0a20 2020 2020 2020  P_LIST):.       
+0000fa70: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000fa80: 2020 6874 7470 2e68 6561 6428 6970 2c20    http.head(ip, 
+0000fa90: 7469 6d65 6f75 743d 3329 0a20 2020 2020  timeout=3).     
+0000faa0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0000fab0: 2020 2020 2020 6578 6365 7074 2028 7265        except (re
+0000fac0: 7175 6573 7473 2e54 696d 656f 7574 2c20  quests.Timeout, 
+0000fad0: 7265 7175 6573 7473 2e65 7863 6570 7469  requests.excepti
+0000fae0: 6f6e 732e 436f 6e6e 6563 7469 6f6e 4572  ons.ConnectionEr
+0000faf0: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
+0000fb00: 2020 2020 2020 2069 6620 6920 3d3d 206c         if i == l
+0000fb10: 656e 285f 5445 5354 5f49 505f 4c49 5354  en(_TEST_IP_LIST
+0000fb20: 2920 2d20 313a 0a20 2020 2020 2020 2020  ) - 1:.         
+0000fb30: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000fb40: 6570 7469 6f6e 732e 4e65 7477 6f72 6b45  eptions.NetworkE
+0000fb50: 7272 6f72 2827 436f 756c 6420 6e6f 7420  rror('Could not 
+0000fb60: 7265 6672 6573 6820 7468 6520 636c 7573  refresh the clus
+0000fb70: 7465 722e 2027 0a20 2020 2020 2020 2020  ter. '.         
+0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fba0: 2020 2020 2027 4e65 7477 6f72 6b20 7365       'Network se
+0000fbb0: 656d 7320 646f 776e 2e27 2920 6672 6f6d  ems down.') from
+0000fbc0: 2065 0a0a 0a64 6566 2063 6865 636b 5f6f   e...def check_o
+0000fbd0: 776e 6572 5f69 6465 6e74 6974 7928 636c  wner_identity(cl
+0000fbe0: 7573 7465 725f 6e61 6d65 3a20 7374 7229  uster_name: str)
+0000fbf0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+0000fc00: 2243 6865 636b 2069 6620 6375 7272 656e  "Check if curren
+0000fc10: 7420 7573 6572 2069 7320 7468 6520 7361  t user is the sa
+0000fc20: 6d65 2061 7320 7468 6520 7573 6572 2077  me as the user w
+0000fc30: 686f 2063 7265 6174 6564 2074 6865 2063  ho created the c
+0000fc40: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
+0000fc50: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
+0000fc60: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
+0000fc70: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
+0000fc80: 6174 6368 4572 726f 723a 2069 6620 7468  atchError: if th
+0000fc90: 6520 6375 7272 656e 7420 7573 6572 2069  e current user i
+0000fca0: 730a 2020 2020 2020 2020 2020 6e6f 7420  s.          not 
+0000fcb0: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
+0000fcc0: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
+0000fcd0: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
+0000fce0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+0000fcf0: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
+0000fd00: 7479 4572 726f 723a 2069 6620 7765 2066  tyError: if we f
+0000fd10: 6169 6c20 746f 2067 6574 2074 6865 2063  ail to get the c
+0000fd20: 7572 7265 6e74 2075 7365 720a 2020 2020  urrent user.    
+0000fd30: 2020 2020 2020 6964 656e 7469 7479 2e0a        identity..
+0000fd40: 2020 2020 2222 220a 2020 2020 6966 2065      """.    if e
+0000fd50: 6e76 5f6f 7074 696f 6e73 2e4f 7074 696f  nv_options.Optio
+0000fd60: 6e73 2e53 4b49 505f 434c 4f55 445f 4944  ns.SKIP_CLOUD_ID
+0000fd70: 454e 5449 5459 5f43 4845 434b 2e67 6574  ENTITY_CHECK.get
+0000fd80: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
+0000fd90: 726e 0a20 2020 2072 6563 6f72 6420 3d20  rn.    record = 
+0000fda0: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+0000fdb0: 652e 6765 745f 636c 7573 7465 725f 6672  e.get_cluster_fr
+0000fdc0: 6f6d 5f6e 616d 6528 636c 7573 7465 725f  om_name(cluster_
+0000fdd0: 6e61 6d65 290a 2020 2020 6966 2072 6563  name).    if rec
+0000fde0: 6f72 6420 6973 204e 6f6e 653a 0a20 2020  ord is None:.   
+0000fdf0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000fe00: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
+0000fe10: 2768 616e 646c 6527 5d0a 2020 2020 6966  'handle'].    if
+0000fe20: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000fe30: 6861 6e64 6c65 2c20 6261 636b 656e 6473  handle, backends
+0000fe40: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
+0000fe50: 7263 6548 616e 646c 6529 3a0a 2020 2020  rceHandle):.    
+0000fe60: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0000fe70: 636c 6f75 6420 3d20 6861 6e64 6c65 2e6c  cloud = handle.l
+0000fe80: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
+0000fe90: 732e 636c 6f75 640a 2020 2020 6375 7272  s.cloud.    curr
+0000fea0: 656e 745f 7573 6572 5f69 6465 6e74 6974  ent_user_identit
+0000feb0: 7920 3d20 636c 6f75 642e 6765 745f 6375  y = cloud.get_cu
+0000fec0: 7272 656e 745f 7573 6572 5f69 6465 6e74  rrent_user_ident
+0000fed0: 6974 7928 290a 2020 2020 6f77 6e65 725f  ity().    owner_
+0000fee0: 6964 656e 7469 7479 203d 2072 6563 6f72  identity = recor
+0000fef0: 645b 276f 776e 6572 275d 0a20 2020 2069  d['owner'].    i
+0000ff00: 6620 6375 7272 656e 745f 7573 6572 5f69  f current_user_i
+0000ff10: 6465 6e74 6974 7920 6973 204e 6f6e 653a  dentity is None:
+0000ff20: 0a20 2020 2020 2020 2023 2053 6b69 7020  .        # Skip 
+0000ff30: 7468 6520 6368 6563 6b20 6966 2074 6865  the check if the
+0000ff40: 2063 6c6f 7564 2064 6f65 7320 6e6f 7420   cloud does not 
+0000ff50: 7375 7070 6f72 7420 7573 6572 2069 6465  support user ide
+0000ff60: 6e74 6974 792e 0a20 2020 2020 2020 2072  ntity..        r
+0000ff70: 6574 7572 6e0a 2020 2020 2320 5468 6520  eturn.    # The 
+0000ff80: 7573 6572 2069 6465 6e74 6974 7920 6361  user identity ca
+0000ff90: 6e20 6265 204e 6f6e 652c 2069 6620 7468  n be None, if th
+0000ffa0: 6520 636c 7573 7465 7220 6973 2063 7265  e cluster is cre
+0000ffb0: 6174 6564 2062 7920 616e 206f 6c64 6572  ated by an older
+0000ffc0: 0a20 2020 2023 2076 6572 7369 6f6e 206f  .    # version o
+0000ffd0: 6620 536b 7950 696c 6f74 2e20 496e 2074  f SkyPilot. In t
+0000ffe0: 6861 7420 6361 7365 2c20 7765 2073 6574  hat case, we set
+0000fff0: 2074 6865 2075 7365 7220 6964 656e 7469   the user identi
+00010000: 7479 2074 6f20 7468 650a 2020 2020 2320  ty to the.    # 
+00010010: 6375 7272 656e 7420 6f6e 652e 0a20 2020  current one..   
+00010020: 2023 204e 4f54 453a 2061 2075 7365 7220   # NOTE: a user 
+00010030: 7768 6f20 7570 6772 6164 6573 2053 6b79  who upgrades Sky
+00010040: 5069 6c6f 7420 616e 6420 7377 6974 6368  Pilot and switch
+00010050: 6573 2074 6f20 6120 6e65 7720 636c 6f75  es to a new clou
+00010060: 6420 6964 656e 7469 7479 0a20 2020 2023  d identity.    #
+00010070: 2069 6d6d 6564 6961 7465 6c79 2077 6974   immediately wit
+00010080: 686f 7574 2060 736b 7920 7374 6174 7573  hout `sky status
+00010090: 202d 2d72 6566 7265 7368 6020 6669 7273   --refresh` firs
+000100a0: 742c 2077 696c 6c20 6361 7573 6520 6120  t, will cause a 
+000100b0: 6c65 616b 6167 650a 2020 2020 2320 6f66  leakage.    # of
+000100c0: 2074 6865 2065 7869 7374 696e 6720 636c   the existing cl
+000100d0: 7573 7465 722e 2057 6520 6465 656d 2074  uster. We deem t
+000100e0: 6869 7320 616e 2061 6363 6570 7461 626c  his an acceptabl
+000100f0: 6520 7472 6164 656f 6666 206d 6169 6e6c  e tradeoff mainl
+00010100: 790a 2020 2020 2320 6265 6361 7573 6520  y.    # because 
+00010110: 6d75 6c74 692d 6964 656e 7469 7479 2069  multi-identity i
+00010120: 7320 6e6f 7420 636f 6d6d 6f6e 2028 6174  s not common (at
+00010130: 206c 6561 7374 2061 7420 7468 6520 6d6f   least at the mo
+00010140: 6d65 6e74 292e 0a20 2020 2069 6620 6f77  ment)..    if ow
+00010150: 6e65 725f 6964 656e 7469 7479 2069 7320  ner_identity is 
+00010160: 4e6f 6e65 3a0a 2020 2020 2020 2020 676c  None:.        gl
+00010170: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00010180: 7365 745f 6f77 6e65 725f 6964 656e 7469  set_owner_identi
+00010190: 7479 5f66 6f72 5f63 6c75 7374 6572 280a  ty_for_cluster(.
+000101a0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+000101b0: 7465 725f 6e61 6d65 2c20 6375 7272 656e  ter_name, curren
+000101c0: 745f 7573 6572 5f69 6465 6e74 6974 7929  t_user_identity)
+000101d0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000101e0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+000101f0: 616e 6365 286f 776e 6572 5f69 6465 6e74  ance(owner_ident
+00010200: 6974 792c 206c 6973 7429 0a20 2020 2020  ity, list).     
+00010210: 2020 2023 2049 7420 6973 204f 4b20 6966     # It is OK if
+00010220: 2074 6865 206f 776e 6572 2069 6465 6e74   the owner ident
+00010230: 6974 7920 6973 2073 686f 7274 6572 2c20  ity is shorter, 
+00010240: 7768 6963 6820 7769 6c6c 2068 6170 7065  which will happe
+00010250: 6e20 7768 656e 0a20 2020 2020 2020 2023  n when.        #
+00010260: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00010270: 6c61 756e 6368 6564 2062 6566 6f72 6520  launched before 
+00010280: 2331 3830 382e 2049 6e20 7468 6174 2063  #1808. In that c
+00010290: 6173 652c 2077 6520 6f6e 6c79 2063 6865  ase, we only che
+000102a0: 636b 0a20 2020 2020 2020 2023 2074 6865  ck.        # the
+000102b0: 2073 616d 6520 6c65 6e67 7468 2028 7a69   same length (zi
+000102c0: 7020 7769 6c6c 2073 746f 7020 6174 2074  p will stop at t
+000102d0: 6865 2073 686f 7274 6572 206f 6e65 292e  he shorter one).
+000102e0: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
+000102f0: 286f 776e 6572 2c0a 2020 2020 2020 2020  (owner,.        
+00010300: 2020 2020 2020 2020 6375 7272 656e 7429          current)
+00010310: 2069 6e20 656e 756d 6572 6174 6528 7a69   in enumerate(zi
+00010320: 7028 6f77 6e65 725f 6964 656e 7469 7479  p(owner_identity
+00010330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010350: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00010360: 656e 745f 7573 6572 5f69 6465 6e74 6974  ent_user_identit
+00010370: 7929 293a 0a20 2020 2020 2020 2020 2020  y)):.           
+00010380: 2023 2043 6c65 616e 2075 7020 7468 6520   # Clean up the 
+00010390: 6f77 6e65 7220 6964 656e 7469 7479 2066  owner identity f
+000103a0: 6f72 2074 6865 2062 6163 6b73 6c61 7368  or the backslash
+000103b0: 2061 6e64 206e 6577 6c69 6e65 732c 2063   and newlines, c
+000103c0: 6175 7365 640a 2020 2020 2020 2020 2020  aused.          
+000103d0: 2020 2320 6279 2074 6865 2063 6c6f 7564    # by the cloud
+000103e0: 2043 4c49 206f 7574 7075 742c 2065 2e67   CLI output, e.g
+000103f0: 2e20 6763 6c6f 7564 2e0a 2020 2020 2020  . gcloud..      
+00010400: 2020 2020 2020 6f77 6e65 7220 3d20 6f77        owner = ow
+00010410: 6e65 722e 7265 706c 6163 6528 275c 6e27  ner.replace('\n'
+00010420: 2c20 2727 292e 7265 706c 6163 6528 275c  , '').replace('\
+00010430: 5c27 2c20 2727 290a 2020 2020 2020 2020  \', '').        
+00010440: 2020 2020 6966 206f 776e 6572 203d 3d20      if owner == 
+00010450: 6375 7272 656e 743a 0a20 2020 2020 2020  current:.       
+00010460: 2020 2020 2020 2020 2069 6620 6920 213d           if i !=
+00010470: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00010480: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+00010490: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+000104a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104b0: 6627 5468 6520 636c 7573 7465 7220 7761  f'The cluster wa
+000104c0: 7320 6f77 6e65 6420 6279 207b 6f77 6e65  s owned by {owne
+000104d0: 725f 6964 656e 7469 7479 7d2c 2062 7574  r_identity}, but
+000104e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000104f0: 2020 2020 2020 2020 2020 2066 2761 206e             f'a n
+00010500: 6577 2069 6465 6e74 6974 7920 7b63 7572  ew identity {cur
+00010510: 7265 6e74 5f75 7365 725f 6964 656e 7469  rent_user_identi
+00010520: 7479 7d20 6973 2061 6374 6976 6174 6564  ty} is activated
+00010530: 2e20 5765 2073 7469 6c6c 2027 0a20 2020  . We still '.   
+00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010550: 2020 2020 2027 616c 6c6f 7720 7468 6520       'allow the 
+00010560: 6f70 6572 6174 696f 6e20 6173 2074 6865  operation as the
+00010570: 2074 776f 2069 6465 6e74 6974 6965 7320   two identities 
+00010580: 6172 6520 6c69 6b65 6c79 2074 6f20 6861  are likely to ha
+00010590: 7665 2027 0a20 2020 2020 2020 2020 2020  ve '.           
+000105a0: 2020 2020 2020 2020 2020 2020 2027 7468               'th
+000105b0: 6520 7361 6d65 2061 6363 6573 7320 746f  e same access to
+000105c0: 2074 6865 2063 6c75 7374 6572 2e20 506c   the cluster. Pl
+000105d0: 6561 7365 2062 6520 6177 6172 6520 7468  ease be aware th
+000105e0: 6174 2074 6869 7320 6361 6e20 270a 2020  at this can '.  
+000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010600: 2020 2020 2020 2763 6175 7365 2075 6e65        'cause une
+00010610: 7870 6563 7465 6420 636c 7573 7465 7220  xpected cluster 
+00010620: 6c65 616b 6167 6520 6966 2074 6865 2074  leakage if the t
+00010630: 776f 2069 6465 6e74 6974 6965 7320 6172  wo identities ar
+00010640: 6520 6e6f 7420 270a 2020 2020 2020 2020  e not '.        
+00010650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010660: 2761 6374 7561 6c6c 7920 6571 7569 7661  'actually equiva
+00010670: 6c65 6e74 2028 652e 672e 2c20 6265 6c6f  lent (e.g., belo
+00010680: 6e67 2074 6f20 7468 6520 7361 6d65 2070  ng to the same p
+00010690: 6572 736f 6e29 2e27 0a20 2020 2020 2020  erson).'.       
+000106a0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000106b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000106c0: 6620 6920 213d 2030 206f 7220 6c65 6e28  f i != 0 or len(
+000106d0: 6f77 6e65 725f 6964 656e 7469 7479 2920  owner_identity) 
+000106e0: 213d 206c 656e 2863 7572 7265 6e74 5f75  != len(current_u
+000106f0: 7365 725f 6964 656e 7469 7479 293a 0a20  ser_identity):. 
+00010700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010710: 2020 2023 2057 6520 7570 6461 7465 2074     # We update t
+00010720: 6865 206f 776e 6572 206f 6620 6120 636c  he owner of a cl
+00010730: 7573 7465 722c 2077 6865 6e3a 0a20 2020  uster, when:.   
+00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010750: 2023 2031 2e20 5468 6520 7374 7269 6374   # 1. The strict
+00010760: 6573 7420 6964 656e 7474 7920 2869 2e65  est identty (i.e
+00010770: 2e20 7468 6520 6669 7273 7420 6f6e 6529  . the first one)
+00010780: 2064 6f65 7320 6e6f 740a 2020 2020 2020   does not.      
+00010790: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000107a0: 6d61 7463 682c 2062 7574 2074 6865 206c  match, but the l
+000107b0: 6174 7465 7220 6f6e 6573 206d 6174 6368  atter ones match
+000107c0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000107d0: 2020 2020 2020 2320 322e 2054 6865 206c        # 2. The l
+000107e0: 656e 6774 6820 6f66 2074 6865 2074 776f  ength of the two
+000107f0: 2069 6465 6e74 6974 6965 7320 6172 6520   identities are 
+00010800: 6469 6666 6572 656e 742c 2077 6869 6368  different, which
+00010810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010820: 2020 2020 2023 2077 696c 6c20 6f6e 6c79       # will only
+00010830: 2068 6170 7065 6e20 7768 656e 2074 6865   happen when the
+00010840: 2063 6c75 7374 6572 2069 7320 6c61 756e   cluster is laun
+00010850: 6368 6564 2062 6566 6f72 6520 2331 3830  ched before #180
+00010860: 382e 0a20 2020 2020 2020 2020 2020 2020  8..             
+00010870: 2020 2020 2020 2023 2055 7064 6174 6520         # Update 
+00010880: 7468 6520 7573 6572 2069 6465 6e74 6974  the user identit
+00010890: 7920 746f 2061 766f 6964 2073 686f 7769  y to avoid showi
+000108a0: 6e67 2074 6865 2077 6172 6e69 6e67 2061  ng the warning a
+000108b0: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
+000108c0: 2020 2020 2020 2020 2023 2061 6761 696e           # again
+000108d0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000108e0: 2020 2020 2020 676c 6f62 616c 5f75 7365        global_use
+000108f0: 725f 7374 6174 652e 7365 745f 6f77 6e65  r_state.set_owne
+00010900: 725f 6964 656e 7469 7479 5f66 6f72 5f63  r_identity_for_c
+00010910: 6c75 7374 6572 280a 2020 2020 2020 2020  luster(.        
+00010920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010930: 636c 7573 7465 725f 6e61 6d65 2c20 6375  cluster_name, cu
+00010940: 7272 656e 745f 7573 6572 5f69 6465 6e74  rrent_user_ident
+00010950: 6974 7929 0a20 2020 2020 2020 2020 2020  ity).           
+00010960: 2020 2020 2072 6574 7572 6e20 2023 2054       return  # T
+00010970: 6865 2075 7365 7220 6964 656e 7469 7479  he user identity
+00010980: 206d 6174 6368 6573 2e0a 2020 2020 2020   matches..      
+00010990: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
+000109a0: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
+000109b0: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
+000109c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000109d0: 6520 6578 6365 7074 696f 6e73 2e43 6c75  e exceptions.Clu
+000109e0: 7374 6572 4f77 6e65 7249 6465 6e74 6974  sterOwnerIdentit
+000109f0: 794d 6973 6d61 7463 6845 7272 6f72 280a  yMismatchError(.
+00010a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a10: 6627 7b63 6c75 7374 6572 5f6e 616d 6521  f'{cluster_name!
+00010a20: 727d 2028 7b63 6c6f 7564 7d29 2069 7320  r} ({cloud}) is 
+00010a30: 6f77 6e65 6420 6279 2061 6363 6f75 6e74  owned by account
+00010a40: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00010a50: 2020 2066 277b 6f77 6e65 725f 6964 656e     f'{owner_iden
+00010a60: 7469 7479 2172 7d2c 2062 7574 2074 6865  tity!r}, but the
+00010a70: 2061 6374 6976 6174 6564 2061 6363 6f75   activated accou
+00010a80: 6e74 2027 0a20 2020 2020 2020 2020 2020  nt '.           
+00010a90: 2020 2020 2066 2769 7320 7b63 7572 7265       f'is {curre
+00010aa0: 6e74 5f75 7365 725f 6964 656e 7469 7479  nt_user_identity
+00010ab0: 2172 7d2e 2729 0a0a 0a64 6566 2074 6167  !r}.')...def tag
+00010ac0: 5f66 696c 7465 725f 666f 725f 636c 7573  _filter_for_clus
+00010ad0: 7465 7228 636c 7573 7465 725f 6e61 6d65  ter(cluster_name
+00010ae0: 3a20 7374 7229 202d 3e20 4469 6374 5b73  : str) -> Dict[s
+00010af0: 7472 2c20 7374 725d 3a0a 2020 2020 2222  tr, str]:.    ""
+00010b00: 2252 6574 7572 6e73 2061 2074 6167 2066  "Returns a tag f
+00010b10: 696c 7465 7220 666f 7220 7468 6520 636c  ilter for the cl
+00010b20: 7573 7465 722e 2222 220a 2020 2020 7265  uster.""".    re
+00010b30: 7475 726e 207b 0a20 2020 2020 2020 2027  turn {.        '
+00010b40: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+00010b50: 273a 2063 6c75 7374 6572 5f6e 616d 652c  ': cluster_name,
+00010b60: 0a20 2020 207d 0a0a 0a64 6566 205f 7175  .    }...def _qu
+00010b70: 6572 795f 636c 7573 7465 725f 7374 6174  ery_cluster_stat
+00010b80: 7573 5f76 6961 5f63 6c6f 7564 5f61 7069  us_via_cloud_api
+00010b90: 280a 2020 2020 6861 6e64 6c65 3a20 2763  (.    handle: 'c
+00010ba0: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+00010bb0: 656e 642e 436c 6f75 6456 6d52 6179 5265  end.CloudVmRayRe
+00010bc0: 736f 7572 6365 4861 6e64 6c65 270a 2920  sourceHandle'.) 
+00010bd0: 2d3e 204c 6973 745b 7374 6174 7573 5f6c  -> List[status_l
+00010be0: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
+00010bf0: 5d3a 0a20 2020 2022 2222 5265 7475 726e  ]:.    """Return
+00010c00: 7320 7468 6520 7374 6174 7573 206f 6620  s the status of 
+00010c10: 7468 6520 636c 7573 7465 722e 0a0a 2020  the cluster...  
+00010c20: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00010c30: 2020 6578 6365 7074 696f 6e73 2e43 6c75    exceptions.Clu
+00010c40: 7374 6572 5374 6174 7573 4665 7463 6869  sterStatusFetchi
+00010c50: 6e67 4572 726f 723a 2074 6865 2063 6c75  ngError: the clu
+00010c60: 7374 6572 2073 7461 7475 7320 6361 6e6e  ster status cann
+00010c70: 6f74 2062 650a 2020 2020 2020 2020 2020  ot be.          
+00010c80: 6665 7463 6865 6420 6672 6f6d 2074 6865  fetched from the
+00010c90: 2063 6c6f 7564 2070 726f 7669 6465 722e   cloud provider.
+00010ca0: 0a20 2020 2022 2222 0a20 2020 2063 6c75  .    """.    clu
+00010cb0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00010cc0: 7564 203d 2068 616e 646c 652e 636c 7573  ud = handle.clus
+00010cd0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00010ce0: 640a 2020 2020 636c 7573 7465 725f 6e61  d.    cluster_na
+00010cf0: 6d65 5f69 6e5f 6869 6e74 203d 2063 6f6d  me_in_hint = com
+00010d00: 6d6f 6e5f 7574 696c 732e 636c 7573 7465  mon_utils.cluste
+00010d10: 725f 6e61 6d65 5f69 6e5f 6869 6e74 280a  r_name_in_hint(.
+00010d20: 2020 2020 2020 2020 6861 6e64 6c65 2e63          handle.c
+00010d30: 6c75 7374 6572 5f6e 616d 652c 2063 6c75  luster_name, clu
+00010d40: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00010d50: 7564 290a 2020 2020 2320 5573 6520 7265  ud).    # Use re
+00010d60: 6769 6f6e 2061 6e64 207a 6f6e 6520 6672  gion and zone fr
+00010d70: 6f6d 2074 6865 2063 6c75 7374 6572 2063  om the cluster c
+00010d80: 6f6e 6669 672c 2069 6e73 7465 6164 206f  onfig, instead o
+00010d90: 6620 7468 650a 2020 2020 2320 6861 6e64  f the.    # hand
+00010da0: 6c65 2e6c 6175 6e63 6865 645f 7265 736f  le.launched_reso
+00010db0: 7572 6365 732c 2062 6563 6175 7365 2074  urces, because t
+00010dc0: 6865 206c 6174 7465 7220 6d61 7920 6e6f  he latter may no
+00010dd0: 7420 6265 2073 6574 0a20 2020 2023 2063  t be set.    # c
+00010de0: 6f72 7265 6374 6c79 2079 6574 2e0a 2020  orrectly yet..  
+00010df0: 2020 7261 795f 636f 6e66 6967 203d 2063    ray_config = c
+00010e00: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
+00010e10: 5f79 616d 6c28 6861 6e64 6c65 2e63 6c75  _yaml(handle.clu
+00010e20: 7374 6572 5f79 616d 6c29 0a20 2020 2070  ster_yaml).    p
+00010e30: 726f 7669 6465 725f 636f 6e66 6967 203d  rovider_config =
+00010e40: 2072 6179 5f63 6f6e 6669 675b 2770 726f   ray_config['pro
+00010e50: 7669 6465 7227 5d0a 0a20 2020 2023 2051  vider']..    # Q
+00010e60: 7565 7279 2074 6865 2063 6c6f 7564 2070  uery the cloud p
+00010e70: 726f 7669 6465 722e 0a20 2020 2023 2054  rovider..    # T
+00010e80: 4f44 4f28 7375 7175 6172 6b29 3a20 6d6f  ODO(suquark): mo
+00010e90: 7665 2069 6d70 6c65 6d65 6e74 6174 696f  ve implementatio
+00010ea0: 6e73 206f 6620 6d6f 7265 2063 6c6f 7564  ns of more cloud
+00010eb0: 7320 6865 7265 0a20 2020 2063 6c6f 7564  s here.    cloud
+00010ec0: 203d 2068 616e 646c 652e 6c61 756e 6368   = handle.launch
+00010ed0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
+00010ee0: 7564 0a20 2020 2061 7373 6572 7420 636c  ud.    assert cl
+00010ef0: 6f75 6420 6973 206e 6f74 204e 6f6e 652c  oud is not None,
+00010f00: 2068 616e 646c 650a 2020 2020 6966 2063   handle.    if c
+00010f10: 6c6f 7564 2e53 5441 5455 535f 5645 5253  loud.STATUS_VERS
+00010f20: 494f 4e20 3e3d 2063 6c6f 7564 732e 5374  ION >= clouds.St
+00010f30: 6174 7573 5665 7273 696f 6e2e 534b 5950  atusVersion.SKYP
+00010f40: 494c 4f54 3a0a 2020 2020 2020 2020 636c  ILOT:.        cl
+00010f50: 6f75 645f 6e61 6d65 203d 2072 6570 7228  oud_name = repr(
+00010f60: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
+00010f70: 7265 736f 7572 6365 732e 636c 6f75 6429  resources.cloud)
+00010f80: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00010f90: 2020 2020 2020 2020 2020 6e6f 6465 5f73            node_s
+00010fa0: 7461 7475 735f 6469 6374 203d 2070 726f  tatus_dict = pro
+00010fb0: 7669 7369 6f6e 5f6c 6962 2e71 7565 7279  vision_lib.query
+00010fc0: 5f69 6e73 7461 6e63 6573 280a 2020 2020  _instances(.    
+00010fd0: 2020 2020 2020 2020 2020 2020 636c 6f75              clou
+00010fe0: 645f 6e61 6d65 2c20 636c 7573 7465 725f  d_name, cluster_
+00010ff0: 6e61 6d65 5f6f 6e5f 636c 6f75 642c 2070  name_on_cloud, p
+00011000: 726f 7669 6465 725f 636f 6e66 6967 290a  rovider_config).
+00011010: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00011020: 6572 2e64 6562 7567 2866 2751 7565 7279  er.debug(f'Query
+00011030: 696e 6720 7b63 6c6f 7564 5f6e 616d 657d  ing {cloud_name}
+00011040: 2063 6c75 7374 6572 2027 0a20 2020 2020   cluster '.     
+00011050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011060: 2020 2020 6627 7b63 6c75 7374 6572 5f6e      f'{cluster_n
+00011070: 616d 655f 696e 5f68 696e 747d 2027 0a20  ame_in_hint} '. 
+00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011090: 2020 2020 2020 2020 6627 7374 6174 7573          f'status
+000110a0: 3a5c 6e7b 7070 7269 6e74 2e70 666f 726d  :\n{pprint.pform
+000110b0: 6174 286e 6f64 655f 7374 6174 7573 5f64  at(node_status_d
+000110c0: 6963 7429 7d27 290a 2020 2020 2020 2020  ict)}').        
+000110d0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
+000110e0: 7320 3d20 6c69 7374 286e 6f64 655f 7374  s = list(node_st
+000110f0: 6174 7573 5f64 6963 742e 7661 6c75 6573  atus_dict.values
+00011100: 2829 290a 2020 2020 2020 2020 6578 6365  ()).        exce
+00011110: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00011120: 653a 2020 2320 7079 6c69 6e74 3a20 6469  e:  # pylint: di
+00011130: 7361 626c 653d 6272 6f61 642d 6578 6365  sable=broad-exce
+00011140: 7074 0a20 2020 2020 2020 2020 2020 2077  pt.            w
+00011150: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+00011160: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+00011170: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+00011180: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00011190: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
+000111a0: 7573 7465 7253 7461 7475 7346 6574 6368  usterStatusFetch
+000111b0: 696e 6745 7272 6f72 280a 2020 2020 2020  ingError(.      
+000111c0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000111d0: 4661 696c 6564 2074 6f20 7175 6572 7920  Failed to query 
+000111e0: 7b63 6c6f 7564 5f6e 616d 657d 2063 6c75  {cloud_name} clu
+000111f0: 7374 6572 2027 0a20 2020 2020 2020 2020  ster '.         
+00011200: 2020 2020 2020 2020 2020 2066 277b 636c             f'{cl
+00011210: 7573 7465 725f 6e61 6d65 5f69 6e5f 6869  uster_name_in_hi
+00011220: 6e74 7d20 270a 2020 2020 2020 2020 2020  nt} '.          
+00011230: 2020 2020 2020 2020 2020 6627 7374 6174            f'stat
+00011240: 7573 3a20 7b63 6f6d 6d6f 6e5f 7574 696c  us: {common_util
+00011250: 732e 666f 726d 6174 5f65 7863 6570 7469  s.format_excepti
+00011260: 6f6e 2865 2c20 7573 655f 6272 6163 6b65  on(e, use_bracke
+00011270: 743d 5472 7565 297d 270a 2020 2020 2020  t=True)}'.      
+00011280: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00011290: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+000112a0: 6769 6f6e 203d 2070 726f 7669 6465 725f  gion = provider_
+000112b0: 636f 6e66 6967 2e67 6574 2827 7265 6769  config.get('regi
+000112c0: 6f6e 2729 206f 7220 7072 6f76 6964 6572  on') or provider
+000112d0: 5f63 6f6e 6669 672e 6765 7428 0a20 2020  _config.get(.   
+000112e0: 2020 2020 2020 2020 2027 6c6f 6361 7469           'locati
+000112f0: 6f6e 2729 0a20 2020 2020 2020 207a 6f6e  on').        zon
+00011300: 6520 3d20 7261 795f 636f 6e66 6967 5b27  e = ray_config['
+00011310: 7072 6f76 6964 6572 275d 2e67 6574 2827  provider'].get('
+00011320: 6176 6169 6c61 6269 6c69 7479 5f7a 6f6e  availability_zon
+00011330: 6527 290a 2020 2020 2020 2020 6e6f 6465  e').        node
+00011340: 5f73 7461 7475 7365 7320 3d20 636c 6f75  _statuses = clou
+00011350: 642e 7175 6572 795f 7374 6174 7573 280a  d.query_status(.
+00011360: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00011370: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00011380: 642c 0a20 2020 2020 2020 2020 2020 2074  d,.            t
+00011390: 6167 5f66 696c 7465 725f 666f 725f 636c  ag_filter_for_cl
+000113a0: 7573 7465 7228 636c 7573 7465 725f 6e61  uster(cluster_na
+000113b0: 6d65 5f6f 6e5f 636c 6f75 6429 2c20 7265  me_on_cloud), re
+000113c0: 6769 6f6e 2c20 7a6f 6e65 290a 2020 2020  gion, zone).    
+000113d0: 7265 7475 726e 206e 6f64 655f 7374 6174  return node_stat
+000113e0: 7573 6573 0a0a 0a64 6566 2063 6865 636b  uses...def check
+000113f0: 5f63 616e 5f63 6c6f 6e65 5f64 6973 6b5f  _can_clone_disk_
+00011400: 616e 645f 6f76 6572 7269 6465 5f74 6173  and_override_tas
+00011410: 6b28 0a20 2020 2063 6c75 7374 6572 5f6e  k(.    cluster_n
+00011420: 616d 653a 2073 7472 2c20 7461 7267 6574  ame: str, target
+00011430: 5f63 6c75 7374 6572 5f6e 616d 653a 204f  _cluster_name: O
+00011440: 7074 696f 6e61 6c5b 7374 725d 2c20 7461  ptional[str], ta
+00011450: 736b 3a20 2774 6173 6b5f 6c69 622e 5461  sk: 'task_lib.Ta
+00011460: 736b 270a 2920 2d3e 2054 7570 6c65 5b27  sk'.) -> Tuple['
+00011470: 7461 736b 5f6c 6962 2e54 6173 6b27 2c20  task_lib.Task', 
+00011480: 2763 6c6f 7564 5f76 6d5f 7261 795f 6261  'cloud_vm_ray_ba
+00011490: 636b 656e 642e 436c 6f75 6456 6d52 6179  ckend.CloudVmRay
+000114a0: 5265 736f 7572 6365 4861 6e64 6c65 275d  ResourceHandle']
+000114b0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
+000114c0: 6620 7468 6520 7461 736b 2069 7320 636f  f the task is co
+000114d0: 6d70 6174 6962 6c65 2074 6f20 636c 6f6e  mpatible to clon
+000114e0: 6520 6469 736b 2066 726f 6d20 7468 6520  e disk from the 
+000114f0: 736f 7572 6365 2063 6c75 7374 6572 2e0a  source cluster..
+00011500: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00011510: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
+00011520: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+00011530: 2063 6c75 7374 6572 2074 6f20 636c 6f6e   cluster to clon
+00011540: 6520 6469 736b 2066 726f 6d2e 0a20 2020  e disk from..   
+00011550: 2020 2020 2074 6172 6765 745f 636c 7573       target_clus
+00011560: 7465 725f 6e61 6d65 3a20 5468 6520 6e61  ter_name: The na
+00011570: 6d65 206f 6620 7468 6520 7461 7267 6574  me of the target
+00011580: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00011590: 2020 7461 736b 3a20 5468 6520 7461 736b    task: The task
+000115a0: 2074 6f20 6368 6563 6b2e 0a0a 2020 2020   to check...    
+000115b0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000115c0: 2054 6865 2074 6173 6b20 746f 2075 7365   The task to use
+000115d0: 2061 6e64 2074 6865 2072 6573 6f75 7263   and the resourc
+000115e0: 6520 6861 6e64 6c65 206f 6620 7468 6520  e handle of the 
+000115f0: 736f 7572 6365 2063 6c75 7374 6572 2e0a  source cluster..
+00011600: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+00011610: 2020 2020 2056 616c 7565 4572 726f 723a       ValueError:
+00011620: 2049 6620 7468 6520 736f 7572 6365 2063   If the source c
+00011630: 6c75 7374 6572 2064 6f65 7320 6e6f 7420  luster does not 
+00011640: 6578 6973 742e 0a20 2020 2020 2020 2065  exist..        e
+00011650: 7863 6570 7469 6f6e 732e 4e6f 7453 7570  xceptions.NotSup
+00011660: 706f 7274 6564 4572 726f 723a 2049 6620  portedError: If 
+00011670: 7468 6520 736f 7572 6365 2063 6c75 7374  the source clust
+00011680: 6572 2069 7320 6e6f 7420 7661 6c69 6420  er is not valid 
+00011690: 6f72 2074 6865 0a20 2020 2020 2020 2020  or the.         
+000116a0: 2020 2074 6173 6b20 6973 206e 6f74 2063     task is not c
+000116b0: 6f6d 7061 7469 626c 6520 746f 2063 6c6f  ompatible to clo
+000116c0: 6e65 2064 6973 6b20 6672 6f6d 2074 6865  ne disk from the
+000116d0: 2073 6f75 7263 6520 636c 7573 7465 722e   source cluster.
+000116e0: 0a20 2020 2022 2222 0a20 2020 2073 6f75  .    """.    sou
+000116f0: 7263 655f 636c 7573 7465 725f 7374 6174  rce_cluster_stat
+00011700: 7573 2c20 6861 6e64 6c65 203d 2072 6566  us, handle = ref
+00011710: 7265 7368 5f63 6c75 7374 6572 5f73 7461  resh_cluster_sta
+00011720: 7475 735f 6861 6e64 6c65 2863 6c75 7374  tus_handle(clust
+00011730: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+00011740: 736f 7572 6365 5f63 6c75 7374 6572 5f73  source_cluster_s
+00011750: 7461 7475 7320 6973 204e 6f6e 653a 0a20  tatus is None:. 
+00011760: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+00011770: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+00011780: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+00011790: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+000117a0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000117b0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000117c0: 2020 2066 2743 616e 6e6f 7420 6669 6e64     f'Cannot find
+000117d0: 2063 6c75 7374 6572 207b 636c 7573 7465   cluster {cluste
+000117e0: 725f 6e61 6d65 2172 7d20 746f 2063 6c6f  r_name!r} to clo
+000117f0: 6e65 2064 6973 6b20 6672 6f6d 2e27 290a  ne disk from.').
+00011800: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
+00011810: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
+00011820: 6163 6b65 6e64 732e 436c 6f75 6456 6d52  ackends.CloudVmR
+00011830: 6179 5265 736f 7572 6365 4861 6e64 6c65  ayResourceHandle
+00011840: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
+00011850: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+00011860: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+00011870: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+00011880: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+00011890: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
+000118a0: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
+000118b0: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
+000118c0: 7420 636c 6f6e 6520 6469 736b 2066 726f  t clone disk fro
+000118d0: 6d20 6120 6e6f 6e2d 636c 6f75 6420 636c  m a non-cloud cl
+000118e0: 7573 7465 7220 7b63 6c75 7374 6572 5f6e  uster {cluster_n
+000118f0: 616d 6521 727d 2e27 290a 0a20 2020 2069  ame!r}.')..    i
+00011900: 6620 736f 7572 6365 5f63 6c75 7374 6572  f source_cluster
+00011910: 5f73 7461 7475 7320 213d 2073 7461 7475  _status != statu
+00011920: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
+00011930: 7475 732e 5354 4f50 5045 443a 0a20 2020  tus.STOPPED:.   
+00011940: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+00011950: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+00011960: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+00011970: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00011980: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
+00011990: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
+000119a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000119b0: 2020 2066 2743 616e 6e6f 7420 636c 6f6e     f'Cannot clon
+000119c0: 6520 6469 736b 2066 726f 6d20 636c 7573  e disk from clus
+000119d0: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
+000119e0: 6521 727d 2027 0a20 2020 2020 2020 2020  e!r} '.         
+000119f0: 2020 2020 2020 2066 2728 7b73 6f75 7263         f'({sourc
+00011a00: 655f 636c 7573 7465 725f 7374 6174 7573  e_cluster_status
+00011a10: 2172 7d29 2e20 506c 6561 7365 2073 746f  !r}). Please sto
+00011a20: 7020 7468 6520 270a 2020 2020 2020 2020  p the '.        
+00011a30: 2020 2020 2020 2020 6627 636c 7573 7465          f'cluste
+00011a40: 7220 6669 7273 743a 2073 6b79 2073 746f  r first: sky sto
+00011a50: 7020 7b63 6c75 7374 6572 5f6e 616d 657d  p {cluster_name}
+00011a60: 2729 0a0a 2020 2020 6966 2074 6172 6765  ')..    if targe
+00011a70: 745f 636c 7573 7465 725f 6e61 6d65 2069  t_cluster_name i
+00011a80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00011a90: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
+00011aa0: 6572 5f73 7461 7475 732c 205f 203d 2072  er_status, _ = r
+00011ab0: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
+00011ac0: 7461 7475 735f 6861 6e64 6c65 280a 2020  tatus_handle(.  
+00011ad0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+00011ae0: 5f63 6c75 7374 6572 5f6e 616d 6529 0a20  _cluster_name). 
+00011af0: 2020 2020 2020 2069 6620 7461 7267 6574         if target
+00011b00: 5f63 6c75 7374 6572 5f73 7461 7475 7320  _cluster_status 
+00011b10: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00011b20: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
+00011b30: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+00011b40: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+00011b50: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+00011b60: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+00011b70: 6570 7469 6f6e 732e 4e6f 7453 7570 706f  eptions.NotSuppo
+00011b80: 7274 6564 4572 726f 7228 0a20 2020 2020  rtedError(.     
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011ba0: 2754 6865 2074 6172 6765 7420 636c 7573  'The target clus
+00011bb0: 7465 7220 7b74 6172 6765 745f 636c 7573  ter {target_clus
+00011bc0: 7465 725f 6e61 6d65 2172 7d20 616c 7265  ter_name!r} alre
+00011bd0: 6164 7920 6578 6973 7473 2e20 436c 6f6e  ady exists. Clon
+00011be0: 696e 6720 270a 2020 2020 2020 2020 2020  ing '.          
+00011bf0: 2020 2020 2020 2020 2020 2764 6973 6b20            'disk 
+00011c00: 6973 206f 6e6c 7920 7375 7070 6f72 7465  is only supporte
+00011c10: 6420 7768 656e 2063 7265 6174 696e 6720  d when creating 
+00011c20: 6120 6e65 7720 636c 7573 7465 722e 2054  a new cluster. T
+00011c30: 6f20 6669 783a 2073 7065 6369 6679 2027  o fix: specify '
+00011c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011c50: 2020 2020 2027 6120 6e65 7720 7461 7267       'a new targ
+00011c60: 6574 2063 6c75 7374 6572 206e 616d 652e  et cluster name.
+00011c70: 2729 0a0a 2020 2020 6e65 775f 7461 736b  ')..    new_task
+00011c80: 5f72 6573 6f75 7263 6573 203d 205b 5d0a  _resources = [].
+00011c90: 2020 2020 6f72 6967 696e 616c 5f63 6c6f      original_clo
+00011ca0: 7564 203d 2068 616e 646c 652e 6c61 756e  ud = handle.laun
+00011cb0: 6368 6564 5f72 6573 6f75 7263 6573 2e63  ched_resources.c
+00011cc0: 6c6f 7564 0a20 2020 206f 7269 6769 6e61  loud.    origina
+00011cd0: 6c5f 636c 6f75 642e 6368 6563 6b5f 6665  l_cloud.check_fe
+00011ce0: 6174 7572 6573 5f61 7265 5f73 7570 706f  atures_are_suppo
+00011cf0: 7274 6564 280a 2020 2020 2020 2020 6861  rted(.        ha
+00011d00: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+00011d10: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
+00011d20: 207b 636c 6f75 6473 2e43 6c6f 7564 496d   {clouds.CloudIm
+00011d30: 706c 656d 656e 7461 7469 6f6e 4665 6174  plementationFeat
+00011d40: 7572 6573 2e43 4c4f 4e45 5f44 4953 4b5f  ures.CLONE_DISK_
+00011d50: 4652 4f4d 5f43 4c55 5354 4552 7d29 0a0a  FROM_CLUSTER})..
+00011d60: 2020 2020 6173 7365 7274 206f 7269 6769      assert origi
+00011d70: 6e61 6c5f 636c 6f75 6420 6973 206e 6f74  nal_cloud is not
+00011d80: 204e 6f6e 652c 2068 616e 646c 652e 6c61   None, handle.la
+00011d90: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00011da0: 0a20 2020 2068 6173 5f6f 7665 7272 6964  .    has_overrid
+00011db0: 6520 3d20 4661 6c73 650a 2020 2020 6861  e = False.    ha
+00011dc0: 735f 6469 736b 5f73 697a 655f 6d65 7420  s_disk_size_met 
+00011dd0: 3d20 4661 6c73 650a 2020 2020 6861 735f  = False.    has_
+00011de0: 636c 6f75 645f 6d65 7420 3d20 4661 6c73  cloud_met = Fals
+00011df0: 650a 2020 2020 666f 7220 7461 736b 5f72  e.    for task_r
+00011e00: 6573 6f75 7263 6573 2069 6e20 7461 736b  esources in task
+00011e10: 2e72 6573 6f75 7263 6573 3a0a 2020 2020  .resources:.    
+00011e20: 2020 2020 6966 2068 616e 646c 652e 6c61      if handle.la
+00011e30: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00011e40: 2e64 6973 6b5f 7369 7a65 203e 2074 6173  .disk_size > tas
+00011e50: 6b5f 7265 736f 7572 6365 732e 6469 736b  k_resources.disk
+00011e60: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
+00011e70: 2020 2023 2054 6865 2074 6172 6765 7420     # The target 
+00011e80: 636c 7573 7465 7227 7320 6469 736b 2073  cluster's disk s
+00011e90: 686f 756c 6420 6265 2061 7420 6c65 6173  hould be at leas
+00011ea0: 7420 6173 206c 6172 6765 2061 7320 7468  t as large as th
+00011eb0: 6520 736f 7572 6365 2e0a 2020 2020 2020  e source..      
+00011ec0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00011ed0: 2020 2020 2020 2068 6173 5f64 6973 6b5f         has_disk_
+00011ee0: 7369 7a65 5f6d 6574 203d 2054 7275 650a  size_met = True.
+00011ef0: 2020 2020 2020 2020 6966 2074 6173 6b5f          if task_
+00011f00: 7265 736f 7572 6365 732e 636c 6f75 6420  resources.cloud 
+00011f10: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00011f20: 6e6f 7420 6f72 6967 696e 616c 5f63 6c6f  not original_clo
+00011f30: 7564 2e69 735f 7361 6d65 5f63 6c6f 7564  ud.is_same_cloud
+00011f40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011f50: 2020 7461 736b 5f72 6573 6f75 7263 6573    task_resources
+00011f60: 2e63 6c6f 7564 293a 0a20 2020 2020 2020  .cloud):.       
+00011f70: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00011f80: 2020 2020 2020 6861 735f 636c 6f75 645f        has_cloud_
+00011f90: 6d65 7420 3d20 5472 7565 0a0a 2020 2020  met = True..    
+00011fa0: 2020 2020 6f76 6572 7269 6465 5f70 6172      override_par
+00011fb0: 616d 203d 207b 7d0a 2020 2020 2020 2020  am = {}.        
+00011fc0: 6966 2074 6173 6b5f 7265 736f 7572 6365  if task_resource
+00011fd0: 732e 636c 6f75 6420 6973 204e 6f6e 653a  s.cloud is None:
+00011fe0: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
+00011ff0: 7272 6964 655f 7061 7261 6d5b 2763 6c6f  rride_param['clo
+00012000: 7564 275d 203d 206f 7269 6769 6e61 6c5f  ud'] = original_
+00012010: 636c 6f75 640a 2020 2020 2020 2020 6966  cloud.        if
+00012020: 2074 6173 6b5f 7265 736f 7572 6365 732e   task_resources.
+00012030: 7265 6769 6f6e 2069 7320 4e6f 6e65 3a0a  region is None:.
+00012040: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+00012050: 7269 6465 5f70 6172 616d 5b27 7265 6769  ride_param['regi
+00012060: 6f6e 275d 203d 2068 616e 646c 652e 6c61  on'] = handle.la
+00012070: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00012080: 2e72 6567 696f 6e0a 0a20 2020 2020 2020  .region..       
+00012090: 2069 6620 6f76 6572 7269 6465 5f70 6172   if override_par
+000120a0: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
+000120b0: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+000120c0: 2020 2020 2020 2020 2020 2020 2066 274e               f'N
+000120d0: 6f20 636c 6f75 642f 7265 6769 6f6e 2073  o cloud/region s
+000120e0: 7065 6369 6669 6564 2066 6f72 2074 6865  pecified for the
+000120f0: 2074 6173 6b20 7b74 6173 6b5f 7265 736f   task {task_reso
+00012100: 7572 6365 737d 2e20 5573 696e 6720 7468  urces}. Using th
+00012110: 6520 7361 6d65 2072 6567 696f 6e20 270a  e same region '.
+00012120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012130: 6627 6173 2073 6f75 7263 6520 636c 7573  f'as source clus
+00012140: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
+00012150: 6521 727d 3a20 270a 2020 2020 2020 2020  e!r}: '.        
+00012160: 2020 2020 2020 2020 6627 7b68 616e 646c          f'{handl
+00012170: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+00012180: 7263 6573 2e63 6c6f 7564 7d27 0a20 2020  rces.cloud}'.   
+00012190: 2020 2020 2020 2020 2020 2020 2066 2728               f'(
+000121a0: 7b68 616e 646c 652e 6c61 756e 6368 6564  {handle.launched
+000121b0: 5f72 6573 6f75 7263 6573 2e72 6567 696f  _resources.regio
+000121c0: 6e7d 292e 2729 0a20 2020 2020 2020 2020  n}).').         
+000121d0: 2020 2068 6173 5f6f 7665 7272 6964 6520     has_override 
+000121e0: 3d20 5472 7565 0a20 2020 2020 2020 2074  = True.        t
+000121f0: 6173 6b5f 7265 736f 7572 6365 7320 3d20  ask_resources = 
+00012200: 7461 736b 5f72 6573 6f75 7263 6573 2e63  task_resources.c
+00012210: 6f70 7928 2a2a 6f76 6572 7269 6465 5f70  opy(**override_p
+00012220: 6172 616d 290a 2020 2020 2020 2020 6e65  aram).        ne
+00012230: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
+00012240: 2e61 7070 656e 6428 7461 736b 5f72 6573  .append(task_res
+00012250: 6f75 7263 6573 290a 0a20 2020 2069 6620  ources)..    if 
+00012260: 6e6f 7420 6e65 775f 7461 736b 5f72 6573  not new_task_res
+00012270: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+00012280: 6966 206e 6f74 2068 6173 5f64 6973 6b5f  if not has_disk_
+00012290: 7369 7a65 5f6d 6574 3a0a 2020 2020 2020  size_met:.      
+000122a0: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
+000122b0: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
+000122c0: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
+000122d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000122e0: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
+000122f0: 6572 5f6e 616d 655f 7374 7220 3d20 6627  er_name_str = f'
+00012300: 207b 7461 7267 6574 5f63 6c75 7374 6572   {target_cluster
+00012310: 5f6e 616d 6521 727d 270a 2020 2020 2020  _name!r}'.      
+00012320: 2020 2020 2020 2020 2020 6966 2074 6172            if tar
+00012330: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00012340: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00012350: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00012360: 7267 6574 5f63 6c75 7374 6572 5f6e 616d  rget_cluster_nam
+00012370: 655f 7374 7220 3d20 2727 0a20 2020 2020  e_str = ''.     
+00012380: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012390: 2065 7863 6570 7469 6f6e 732e 4e6f 7453   exceptions.NotS
+000123a0: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
+000123b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123c0: 2020 2066 2754 6865 2074 6172 6765 7420     f'The target 
+000123d0: 636c 7573 7465 727b 7461 7267 6574 5f63  cluster{target_c
+000123e0: 6c75 7374 6572 5f6e 616d 655f 7374 727d  luster_name_str}
+000123f0: 2073 686f 756c 6420 6861 7665 2061 2064   should have a d
+00012400: 6973 6b20 7369 7a65 2027 0a20 2020 2020  isk size '.     
+00012410: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012420: 276f 6620 6174 206c 6561 7374 207b 6861  'of at least {ha
+00012430: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+00012440: 736f 7572 6365 732e 6469 736b 5f73 697a  sources.disk_siz
+00012450: 657d 2047 4220 746f 2063 6c6f 6e65 2074  e} GB to clone t
+00012460: 6865 2027 0a20 2020 2020 2020 2020 2020  he '.           
+00012470: 2020 2020 2020 2020 2066 2764 6973 6b20           f'disk 
+00012480: 6672 6f6d 207b 636c 7573 7465 725f 6e61  from {cluster_na
+00012490: 6d65 2172 7d2e 2729 0a20 2020 2020 2020  me!r}.').       
+000124a0: 2069 6620 6e6f 7420 6861 735f 636c 6f75   if not has_clou
+000124b0: 645f 6d65 743a 0a20 2020 2020 2020 2020  d_met:.         
+000124c0: 2020 2074 6173 6b5f 7265 736f 7572 6365     task_resource
+000124d0: 735f 636c 6f75 645f 7374 7220 3d20 275b  s_cloud_str = '[
+000124e0: 2720 2b20 272c 272e 6a6f 696e 280a 2020  ' + ','.join(.  
+000124f0: 2020 2020 2020 2020 2020 2020 2020 5b66                [f
+00012500: 277b 7265 732e 636c 6f75 647d 2720 666f  '{res.cloud}' fo
+00012510: 7220 7265 7320 696e 2074 6173 6b2e 7265  r res in task.re
+00012520: 736f 7572 6365 735d 2920 2b20 275d 270a  sources]) + ']'.
+00012530: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00012540: 5f72 6573 6f75 7263 6573 5f73 7472 203d  _resources_str =
+00012550: 2027 5b27 202b 2027 2c27 2e6a 6f69 6e28   '[' + ','.join(
+00012560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012570: 205b 6627 7b72 6573 7d27 2066 6f72 2072   [f'{res}' for r
+00012580: 6573 2069 6e20 7461 736b 2e72 6573 6f75  es in task.resou
+00012590: 7263 6573 5d29 202b 2027 5d27 0a20 2020  rces]) + ']'.   
+000125a0: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
+000125b0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+000125c0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+000125d0: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+000125e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000125f0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00012600: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
+00012610: 616e 6e6f 7420 636c 6f6e 6520 6469 736b  annot clone disk
+00012620: 2061 6372 6f73 7320 636c 6f75 6420 6672   across cloud fr
+00012630: 6f6d 207b 6f72 6967 696e 616c 5f63 6c6f  om {original_clo
+00012640: 7564 7d20 746f 2027 0a20 2020 2020 2020  ud} to '.       
+00012650: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+00012660: 7461 736b 5f72 6573 6f75 7263 6573 5f63  task_resources_c
+00012670: 6c6f 7564 5f73 7472 7d20 666f 7220 7265  loud_str} for re
+00012680: 736f 7572 6365 7320 7b74 6173 6b5f 7265  sources {task_re
+00012690: 736f 7572 6365 735f 7374 727d 2e27 0a20  sources_str}.'. 
+000126a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000126b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000126c0: 4661 6c73 652c 2027 5368 6f75 6c64 206e  False, 'Should n
+000126d0: 6f74 2072 6561 6368 2068 6572 652e 270a  ot reach here.'.
+000126e0: 2020 2020 2320 7365 7420 7468 6520 6e65      # set the ne
+000126f0: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
+00012700: 2074 6f20 6265 2074 6865 2073 616d 6520   to be the same 
+00012710: 7479 7065 2028 6c69 7374 206f 7220 7365  type (list or se
+00012720: 7429 2061 7320 7468 650a 2020 2020 2320  t) as the.    # 
+00012730: 6f72 6967 696e 616c 2074 6173 6b2e 7265  original task.re
+00012740: 736f 7572 6365 730a 2020 2020 6966 2068  sources.    if h
+00012750: 6173 5f6f 7665 7272 6964 653a 0a20 2020  as_override:.   
+00012760: 2020 2020 2074 6173 6b2e 7365 745f 7265       task.set_re
+00012770: 736f 7572 6365 7328 7479 7065 2874 6173  sources(type(tas
+00012780: 6b2e 7265 736f 7572 6365 7329 286e 6577  k.resources)(new
+00012790: 5f74 6173 6b5f 7265 736f 7572 6365 7329  _task_resources)
+000127a0: 290a 2020 2020 2020 2020 2320 5265 7365  ).        # Rese
+000127b0: 7420 7468 6520 6265 7374 5f72 6573 6f75  t the best_resou
+000127c0: 7263 6573 2074 6f20 7472 6967 6572 2072  rces to triger r
+000127d0: 652d 6f70 7469 6d69 7a61 7469 6f6e 0a20  e-optimization. 
+000127e0: 2020 2020 2020 2023 206c 6174 6572 2c20         # later, 
+000127f0: 736f 2074 6861 7420 7468 6520 6e65 7720  so that the new 
+00012800: 7461 736b 5f72 6573 6f75 7263 6573 2077  task_resources w
+00012810: 696c 6c20 6265 2075 7365 642e 0a20 2020  ill be used..   
+00012820: 2020 2020 2074 6173 6b2e 6265 7374 5f72       task.best_r
+00012830: 6573 6f75 7263 6573 203d 204e 6f6e 650a  esources = None.
+00012840: 2020 2020 7265 7475 726e 2074 6173 6b2c      return task,
+00012850: 2068 616e 646c 650a 0a0a 6465 6620 5f75   handle...def _u
+00012860: 7064 6174 655f 636c 7573 7465 725f 7374  pdate_cluster_st
+00012870: 6174 7573 5f6e 6f5f 6c6f 636b 280a 2020  atus_no_lock(.  
+00012880: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+00012890: 6d65 3a20 7374 7229 202d 3e20 4f70 7469  me: str) -> Opti
+000128a0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+000128b0: 6e79 5d5d 3a0a 2020 2020 2222 2255 7064  ny]]:.    """Upd
+000128c0: 6174 6573 2074 6865 2073 7461 7475 7320  ates the status 
+000128d0: 6f66 2074 6865 2063 6c75 7374 6572 2e0a  of the cluster..
+000128e0: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+000128f0: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00012900: 436c 7573 7465 7253 7461 7475 7346 6574  ClusterStatusFet
+00012910: 6368 696e 6745 7272 6f72 3a20 7468 6520  chingError: the 
+00012920: 636c 7573 7465 7220 7374 6174 7573 2063  cluster status c
+00012930: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
+00012940: 2020 2066 6574 6368 6564 2066 726f 6d20     fetched from 
+00012950: 7468 6520 636c 6f75 6420 7072 6f76 6964  the cloud provid
+00012960: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+00012970: 7265 636f 7264 203d 2067 6c6f 6261 6c5f  record = global_
+00012980: 7573 6572 5f73 7461 7465 2e67 6574 5f63  user_state.get_c
+00012990: 6c75 7374 6572 5f66 726f 6d5f 6e61 6d65  luster_from_name
+000129a0: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
+000129b0: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
+000129c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
+000129d0: 7475 726e 204e 6f6e 650a 2020 2020 6861  turn None.    ha
+000129e0: 6e64 6c65 203d 2072 6563 6f72 645b 2768  ndle = record['h
+000129f0: 616e 646c 6527 5d0a 2020 2020 6966 206e  andle'].    if n
+00012a00: 6f74 2069 7369 6e73 7461 6e63 6528 6861  ot isinstance(ha
+00012a10: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
+00012a20: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+00012a30: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
+00012a40: 2020 7265 7475 726e 2072 6563 6f72 640a    return record.
+00012a50: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00012a60: 203d 2068 616e 646c 652e 636c 7573 7465   = handle.cluste
+00012a70: 725f 6e61 6d65 0a0a 2020 2020 6e6f 6465  r_name..    node
+00012a80: 5f73 7461 7475 7365 7320 3d20 5f71 7565  _statuses = _que
+00012a90: 7279 5f63 6c75 7374 6572 5f73 7461 7475  ry_cluster_statu
+00012aa0: 735f 7669 615f 636c 6f75 645f 6170 6928  s_via_cloud_api(
+00012ab0: 6861 6e64 6c65 290a 0a20 2020 2061 6c6c  handle)..    all
+00012ac0: 5f6e 6f64 6573 5f75 7020 3d20 2861 6c6c  _nodes_up = (all
+00012ad0: 280a 2020 2020 2020 2020 7374 6174 7573  (.        status
+00012ae0: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+00012af0: 6c75 7374 6572 5374 6174 7573 2e55 5020  lusterStatus.UP 
+00012b00: 666f 7220 7374 6174 7573 2069 6e20 6e6f  for status in no
+00012b10: 6465 5f73 7461 7475 7365 7329 2061 6e64  de_statuses) and
+00012b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012b30: 2020 2020 206c 656e 286e 6f64 655f 7374       len(node_st
+00012b40: 6174 7573 6573 2920 3d3d 2068 616e 646c  atuses) == handl
+00012b50: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
+00012b60: 290a 0a20 2020 2064 6566 2072 756e 5f72  )..    def run_r
+00012b70: 6179 5f73 7461 7475 735f 746f 5f63 6865  ay_status_to_che
+00012b80: 636b 5f72 6179 5f63 6c75 7374 6572 5f68  ck_ray_cluster_h
+00012b90: 6561 6c74 6879 2829 202d 3e20 626f 6f6c  ealthy() -> bool
+00012ba0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+00012bb0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+00012bc0: 4f28 7a68 7775 293a 2054 6869 7320 6675  O(zhwu): This fu
+00012bd0: 6e63 7469 6f6e 2063 616e 6e6f 7420 6469  nction cannot di
+00012be0: 7374 696e 6775 6973 6820 7472 616e 7369  stinguish transi
+00012bf0: 656e 7420 6e65 7477 6f72 6b0a 2020 2020  ent network.    
+00012c00: 2020 2020 2020 2020 2320 6572 726f 7220          # error 
+00012c10: 696e 2072 6179 2773 2067 6574 2049 5073  in ray's get IPs
+00012c20: 2076 732e 2072 6179 2072 756e 7469 6d65   vs. ray runtime
+00012c30: 2066 6169 6c69 6e67 2e0a 0a20 2020 2020   failing...     
+00012c40: 2020 2020 2020 2023 204e 4f54 453a 2066         # NOTE: f
+00012c50: 6574 6368 696e 6720 7468 6520 4950 7320  etching the IPs 
+00012c60: 6973 2076 6572 7920 736c 6f77 2061 7320  is very slow as 
+00012c70: 6974 2063 616c 6c73 2069 6e74 6f0a 2020  it calls into.  
+00012c80: 2020 2020 2020 2020 2020 2320 6072 6179            # `ray
+00012c90: 2067 6574 2068 6561 642d 6970 2f77 6f72   get head-ip/wor
+00012ca0: 6b65 722d 6970 7360 2e20 5573 696e 6720  ker-ips`. Using 
+00012cb0: 6361 6368 6564 2049 5073 2069 7320 7361  cached IPs is sa
+00012cc0: 6665 2062 6563 6175 7365 0a20 2020 2020  fe because.     
+00012cd0: 2020 2020 2020 2023 2069 6e20 7468 6520         # in the 
+00012ce0: 776f 7273 7420 6361 7365 2077 6520 7469  worst case we ti
+00012cf0: 6d65 206f 7574 2069 6e20 7468 6520 6072  me out in the `r
+00012d00: 6179 2073 7461 7475 7360 2053 5348 2063  ay status` SSH c
+00012d10: 6f6d 6d61 6e64 0a20 2020 2020 2020 2020  ommand.         
+00012d20: 2020 2023 2062 656c 6f77 2e0a 2020 2020     # below..    
+00012d30: 2020 2020 2020 2020 6578 7465 726e 616c          external
+00012d40: 5f69 7073 203d 2068 616e 646c 652e 6361  _ips = handle.ca
+00012d50: 6368 6564 5f65 7874 6572 6e61 6c5f 6970  ched_external_ip
+00012d60: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00012d70: 5468 6973 2068 6170 7065 6e73 2077 6865  This happens whe
+00012d80: 6e20 7573 6572 2069 6e74 6572 7275 7074  n user interrupt
+00012d90: 2074 6865 2060 736b 7920 6c61 756e 6368   the `sky launch
+00012da0: 6020 7072 6f63 6573 7320 6265 666f 7265  ` process before
+00012db0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00012dc0: 6865 2066 6972 7374 2074 696d 6520 7265  he first time re
+00012dd0: 736f 7572 6365 7320 6861 6e64 6c65 2069  sources handle i
+00012de0: 7320 7772 6974 7465 6e20 6261 636b 2074  s written back t
+00012df0: 6f20 6c6f 6361 6c20 6461 7461 6261 7365  o local database
+00012e00: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00012e10: 5468 6973 2069 7320 6865 6c70 6675 6c20  This is helpful 
+00012e20: 7768 656e 2075 7365 7220 696e 7465 7272  when user interr
+00012e30: 7570 7420 6166 7465 7220 7468 6520 7072  upt after the pr
+00012e40: 6f76 6973 696f 6e20 6973 2064 6f6e 650a  ovision is done.
+00012e50: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+00012e60: 6420 6265 666f 7265 2074 6865 2073 6b79  d before the sky
+00012e70: 6c65 7420 6973 2072 6573 7461 7274 6564  let is restarted
+00012e80: 2e20 4166 7465 7220 2332 3330 3420 6973  . After #2304 is
+00012e90: 206d 6572 6765 642c 2074 6869 730a 2020   merged, this.  
+00012ea0: 2020 2020 2020 2020 2020 2320 6865 6c70            # help
+00012eb0: 7320 6b65 6570 2074 6865 2063 6c75 7374  s keep the clust
+00012ec0: 6572 2073 7461 7475 7320 746f 2049 4e49  er status to INI
+00012ed0: 5420 6166 7465 7220 6073 6b79 2073 7461  T after `sky sta
+00012ee0: 7475 7320 2d72 602c 2073 6f0a 2020 2020  tus -r`, so.    
+00012ef0: 2020 2020 2020 2020 2320 7573 6572 2077          # user w
+00012f00: 696c 6c20 6265 206e 6f74 6966 6965 6420  ill be notified 
+00012f10: 7468 6174 2061 6e79 2061 7574 6f20 7374  that any auto st
+00012f20: 6f70 2f64 6f77 6e20 6d69 6768 7420 6e6f  op/down might no
+00012f30: 7420 6265 0a20 2020 2020 2020 2020 2020  t be.           
+00012f40: 2023 2074 7269 6767 6572 6564 2e0a 2020   # triggered..  
+00012f50: 2020 2020 2020 2020 2020 6966 2065 7874            if ext
+00012f60: 6572 6e61 6c5f 6970 7320 6973 204e 6f6e  ernal_ips is Non
+00012f70: 6520 6f72 206c 656e 2865 7874 6572 6e61  e or len(externa
+00012f80: 6c5f 6970 7329 203d 3d20 303a 0a20 2020  l_ips) == 0:.   
+00012f90: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00012fa0: 6765 722e 6465 6275 6728 6627 5265 6672  ger.debug(f'Refr
+00012fb0: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
+00012fc0: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
+00012fd0: 3a20 4e6f 2063 6163 6865 6420 270a 2020  : No cached '.  
+00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ff0: 2020 2020 2020 2020 2020 2066 2749 5073             f'IPs
+00013000: 2066 6f75 6e64 2e20 4861 6e64 6c65 3a20   found. Handle: 
+00013010: 7b68 616e 646c 657d 2729 0a20 2020 2020  {handle}').     
+00013020: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013030: 2065 7863 6570 7469 6f6e 732e 4665 7463   exceptions.Fetc
+00013040: 6849 5045 7272 6f72 280a 2020 2020 2020  hIPError(.      
+00013050: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00013060: 6173 6f6e 3d65 7863 6570 7469 6f6e 732e  ason=exceptions.
+00013070: 4665 7463 6849 5045 7272 6f72 2e52 6561  FetchIPError.Rea
+00013080: 736f 6e2e 4845 4144 290a 0a20 2020 2020  son.HEAD)..     
+00013090: 2020 2020 2020 2023 2050 6f74 656e 7469         # Potenti
+000130a0: 616c 6c79 2072 6566 7265 7368 2074 6865  ally refresh the
+000130b0: 2065 7874 6572 6e61 6c20 5353 4820 706f   external SSH po
+000130c0: 7274 732c 2069 6e20 6361 7365 2074 6865  rts, in case the
+000130d0: 2065 7869 7374 696e 670a 2020 2020 2020   existing.      
+000130e0: 2020 2020 2020 2320 636c 7573 7465 7220        # cluster 
+000130f0: 6265 666f 7265 2023 3234 3931 2077 6173  before #2491 was
+00013100: 206c 6175 6e63 6865 6420 7769 7468 6f75   launched withou
+00013110: 7420 6578 7465 726e 616c 2053 5348 2070  t external SSH p
+00013120: 6f72 7473 0a20 2020 2020 2020 2020 2020  orts.           
+00013130: 2023 2063 6163 6865 642e 0a20 2020 2020   # cached..     
+00013140: 2020 2020 2020 2065 7874 6572 6e61 6c5f         external_
+00013150: 7373 685f 706f 7274 7320 3d20 6861 6e64  ssh_ports = hand
+00013160: 6c65 2e65 7874 6572 6e61 6c5f 7373 685f  le.external_ssh_
+00013170: 706f 7274 7328 290a 2020 2020 2020 2020  ports().        
+00013180: 2020 2020 6865 6164 5f73 7368 5f70 6f72      head_ssh_por
+00013190: 7420 3d20 6578 7465 726e 616c 5f73 7368  t = external_ssh
+000131a0: 5f70 6f72 7473 5b30 5d0a 0a20 2020 2020  _ports[0]..     
+000131b0: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
+000131c0: 6620 7261 7920 636c 7573 7465 7220 7374  f ray cluster st
+000131d0: 6174 7573 2069 7320 6865 616c 7468 792e  atus is healthy.
+000131e0: 0a20 2020 2020 2020 2020 2020 2073 7368  .            ssh
+000131f0: 5f63 7265 6465 6e74 6961 6c73 203d 2073  _credentials = s
+00013200: 7368 5f63 7265 6465 6e74 6961 6c5f 6672  sh_credential_fr
+00013210: 6f6d 5f79 616d 6c28 6861 6e64 6c65 2e63  om_yaml(handle.c
+00013220: 6c75 7374 6572 5f79 616d 6c2c 0a20 2020  luster_yaml,.   
+00013230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013260: 2020 2020 6861 6e64 6c65 2e64 6f63 6b65      handle.docke
+00013270: 725f 7573 6572 2c0a 2020 2020 2020 2020  r_user,.        
+00013280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132a0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000132b0: 616e 646c 652e 7373 685f 7573 6572 290a  andle.ssh_user).
+000132c0: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+000132d0: 6e65 7220 3d20 636f 6d6d 616e 645f 7275  ner = command_ru
+000132e0: 6e6e 6572 2e53 5348 436f 6d6d 616e 6452  nner.SSHCommandR
+000132f0: 756e 6e65 7228 6578 7465 726e 616c 5f69  unner(external_i
+00013300: 7073 5b30 5d2c 0a20 2020 2020 2020 2020  ps[0],.         
+00013310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013330: 2020 2020 2020 2020 2020 2020 2a2a 7373              **ss
+00013340: 685f 6372 6564 656e 7469 616c 732c 0a20  h_credentials,. 
+00013350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013380: 2020 2020 706f 7274 3d68 6561 645f 7373      port=head_ss
+00013390: 685f 706f 7274 290a 2020 2020 2020 2020  h_port).        
+000133a0: 2020 2020 7263 2c20 6f75 7470 7574 2c20      rc, output, 
+000133b0: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
+000133c0: 7275 6e28 0a20 2020 2020 2020 2020 2020  run(.           
+000133d0: 2020 2020 2069 6e73 7461 6e63 655f 7365       instance_se
+000133e0: 7475 702e 5241 595f 5354 4154 5553 5f57  tup.RAY_STATUS_W
+000133f0: 4954 485f 534b 595f 5241 595f 504f 5254  ITH_SKY_RAY_PORT
+00013400: 5f43 4f4d 4d41 4e44 2c0a 2020 2020 2020  _COMMAND,.      
+00013410: 2020 2020 2020 2020 2020 7374 7265 616d            stream
+00013420: 5f6c 6f67 733d 4661 6c73 652c 0a20 2020  _logs=False,.   
+00013430: 2020 2020 2020 2020 2020 2020 2072 6571               req
+00013440: 7569 7265 5f6f 7574 7075 7473 3d54 7275  uire_outputs=Tru
+00013450: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013460: 2020 2073 6570 6172 6174 655f 7374 6465     separate_stde
+00013470: 7272 3d54 7275 6529 0a20 2020 2020 2020  rr=True).       
+00013480: 2020 2020 2069 6620 7263 3a0a 2020 2020       if rc:.    
+00013490: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000134a0: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+000134b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134c0: 2020 2020 6627 5265 6672 6573 6869 6e67      f'Refreshing
+000134d0: 2073 7461 7475 7320 287b 636c 7573 7465   status ({cluste
+000134e0: 725f 6e61 6d65 2172 7d29 3a20 4661 696c  r_name!r}): Fail
+000134f0: 6564 2074 6f20 6368 6563 6b20 270a 2020  ed to check '.  
+00013500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013510: 2020 6627 7261 7920 636c 7573 7465 725c    f'ray cluster\
+00013520: 2773 2068 6561 6c74 6869 6e65 7373 2077  's healthiness w
+00013530: 6974 6820 270a 2020 2020 2020 2020 2020  ith '.          
+00013540: 2020 2020 2020 2020 2020 6627 7b69 6e73            f'{ins
+00013550: 7461 6e63 655f 7365 7475 702e 5241 595f  tance_setup.RAY_
+00013560: 5354 4154 5553 5f57 4954 485f 534b 595f  STATUS_WITH_SKY_
+00013570: 5241 595f 504f 5254 5f43 4f4d 4d41 4e44  RAY_PORT_COMMAND
+00013580: 7d2e 5c6e 270a 2020 2020 2020 2020 2020  }.\n'.          
+00013590: 2020 2020 2020 2020 2020 6627 2d2d 2073            f'-- s
+000135a0: 7464 6f75 7420 2d2d 5c6e 7b6f 7574 7075  tdout --\n{outpu
+000135b0: 747d 5c6e 2d2d 2073 7464 6572 7220 2d2d  t}\n-- stderr --
+000135c0: 5c6e 7b73 7464 6572 727d 2729 0a0a 2020  \n{stderr}')..  
+000135d0: 2020 2020 2020 2020 2020 7265 6164 795f            ready_
+000135e0: 6865 6164 2c20 7265 6164 795f 776f 726b  head, ready_work
+000135f0: 6572 7320 3d20 5f63 6f75 6e74 5f68 6561  ers = _count_hea
+00013600: 6c74 6879 5f6e 6f64 6573 5f66 726f 6d5f  lthy_nodes_from_
+00013610: 7261 7928 6f75 7470 7574 290a 2020 2020  ray(output).    
+00013620: 2020 2020 2020 2020 746f 7461 6c5f 6e6f          total_no
+00013630: 6465 7320 3d20 6861 6e64 6c65 2e6c 6175  des = handle.lau
+00013640: 6e63 6865 645f 6e6f 6465 7320 2a20 6861  nched_nodes * ha
+00013650: 6e64 6c65 2e6e 756d 5f69 7073 5f70 6572  ndle.num_ips_per
+00013660: 5f6e 6f64 650a 2020 2020 2020 2020 2020  _node.          
+00013670: 2020 6966 2072 6561 6479 5f68 6561 6420    if ready_head 
+00013680: 2b20 7265 6164 795f 776f 726b 6572 7320  + ready_workers 
+00013690: 3d3d 2074 6f74 616c 5f6e 6f64 6573 3a0a  == total_nodes:.
+000136a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136b0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
+000136c0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+000136d0: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
+000136e0: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
+000136f0: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
+00013700: 287b 636c 7573 7465 725f 6e61 6d65 2172  ({cluster_name!r
+00013710: 7d29 3a20 7261 7920 7374 6174 7573 206e  }): ray status n
+00013720: 6f74 2073 686f 7769 6e67 2027 0a20 2020  ot showing '.   
+00013730: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+00013740: 6c6c 206e 6f64 6573 2028 7b72 6561 6479  ll nodes ({ready
+00013750: 5f68 6561 6420 2b20 7265 6164 795f 776f  _head + ready_wo
+00013760: 726b 6572 737d 2f27 0a20 2020 2020 2020  rkers}/'.       
+00013770: 2020 2020 2020 2020 2066 277b 746f 7461           f'{tota
+00013780: 6c5f 6e6f 6465 737d 293b 206f 7574 7075  l_nodes}); outpu
+00013790: 743a 207b 6f75 7470 7574 7d3b 2073 7464  t: {output}; std
+000137a0: 6572 723a 207b 7374 6465 7272 7d27 290a  err: {stderr}').
+000137b0: 2020 2020 2020 2020 6578 6365 7074 2065          except e
+000137c0: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
+000137d0: 5045 7272 6f72 3a0a 2020 2020 2020 2020  PError:.        
+000137e0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+000137f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013800: 2020 6627 5265 6672 6573 6869 6e67 2073    f'Refreshing s
+00013810: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
+00013820: 6e61 6d65 2172 7d29 2066 6169 6c65 6420  name!r}) failed 
+00013830: 746f 2067 6574 2049 5073 2e27 290a 2020  to get IPs.').  
+00013840: 2020 2020 2020 6578 6365 7074 2052 756e        except Run
+00013850: 7469 6d65 4572 726f 7220 6173 2065 3a0a  timeError as e:.
+00013860: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013870: 6572 2e64 6562 7567 2873 7472 2865 2929  er.debug(str(e))
+00013880: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00013890: 4578 6365 7074 696f 6e20 6173 2065 3a20  Exception as e: 
+000138a0: 2023 2070 796c 696e 743a 2064 6973 6162   # pylint: disab
+000138b0: 6c65 3d62 726f 6164 2d65 7863 6570 740a  le=broad-except.
+000138c0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+000138d0: 6973 2063 616e 2062 6520 7261 6973 6564  is can be raised
+000138e0: 2062 7920 6065 7874 6572 6e61 6c5f 7373   by `external_ss
+000138f0: 685f 706f 7274 7328 2960 2c20 6475 6520  h_ports()`, due 
+00013900: 746f 2074 6865 0a20 2020 2020 2020 2020  to the.         
+00013910: 2020 2023 2075 6e64 6572 6c79 696e 6720     # underlying 
+00013920: 6361 6c6c 2074 6f20 6b75 6265 726e 6574  call to kubernet
+00013930: 6573 2041 5049 2e0a 2020 2020 2020 2020  es API..        
+00013940: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00013950: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013960: 2020 6627 5265 6672 6573 6869 6e67 2073    f'Refreshing s
+00013970: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
+00013980: 6e61 6d65 2172 7d29 2066 6169 6c65 643a  name!r}) failed:
+00013990: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000139a0: 2020 2066 277b 636f 6d6d 6f6e 5f75 7469     f'{common_uti
+000139b0: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+000139c0: 696f 6e28 652c 2075 7365 5f62 7261 636b  ion(e, use_brack
+000139d0: 6574 3d54 7275 6529 7d27 290a 2020 2020  et=True)}').    
+000139e0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+000139f0: 0a0a 2020 2020 2320 4465 7465 726d 696e  ..    # Determin
+00013a00: 696e 6720 6966 2074 6865 2063 6c75 7374  ing if the clust
+00013a10: 6572 2069 7320 6865 616c 7468 7920 2855  er is healthy (U
+00013a20: 5029 3a0a 2020 2020 230a 2020 2020 2320  P):.    #.    # 
+00013a30: 466f 7220 6e6f 6e2d 7370 6f74 2063 6c75  For non-spot clu
+00013a40: 7374 6572 733a 2049 6620 7261 7920 7374  sters: If ray st
+00013a50: 6174 7573 2073 686f 7773 2061 6c6c 206e  atus shows all n
+00013a60: 6f64 6573 2061 7265 2068 6561 6c74 6879  odes are healthy
+00013a70: 2c20 6974 2069 730a 2020 2020 2320 7361  , it is.    # sa
+00013a80: 6665 2074 6f20 7365 7420 7468 6520 7374  fe to set the st
+00013a90: 6174 7573 2074 6f20 5550 2061 7320 7374  atus to UP as st
+00013aa0: 6172 7469 6e67 2072 6179 2069 7320 7468  arting ray is th
+00013ab0: 6520 6669 6e61 6c20 7374 6570 206f 6620  e final step of 
+00013ac0: 736b 790a 2020 2020 2320 6c61 756e 6368  sky.    # launch
+00013ad0: 2e20 4275 7420 7765 2066 6f75 6e64 2074  . But we found t
+00013ae0: 6861 7420 7261 7920 7374 6174 7573 2069  hat ray status i
+00013af0: 7320 7761 7920 746f 6f20 736c 6f77 2028  s way too slow (
+00013b00: 7365 6520 4e4f 5445 2062 656c 6f77 2920  see NOTE below) 
+00013b10: 736f 0a20 2020 2023 2077 6520 616c 7761  so.    # we alwa
+00013b20: 7973 2071 7565 7279 2074 6865 2063 6c6f  ys query the clo
+00013b30: 7564 2070 726f 7669 6465 7220 6669 7273  ud provider firs
+00013b40: 7420 7768 6963 6820 6973 2066 6173 7465  t which is faste
+00013b50: 722e 0a20 2020 2023 0a20 2020 2023 2046  r..    #.    # F
+00013b60: 6f72 2073 706f 7420 636c 7573 7465 7273  or spot clusters
+00013b70: 3a20 7468 6520 6162 6f76 6520 6361 6e20  : the above can 
+00013b80: 6265 2075 6e73 6166 6520 6265 6361 7573  be unsafe becaus
+00013b90: 6520 7468 6520 5261 7920 636c 7573 7465  e the Ray cluste
+00013ba0: 7220 6d61 790a 2020 2020 2320 7265 6d61  r may.    # rema
+00013bb0: 696e 2068 6561 6c74 6879 2066 6f72 2061  in healthy for a
+00013bc0: 2077 6869 6c65 2062 6566 6f72 6520 7468   while before th
+00013bd0: 6520 636c 6f75 6420 636f 6d70 6c65 7465  e cloud complete
+00013be0: 6c79 2070 7265 656d 7074 7320 7468 6520  ly preempts the 
+00013bf0: 564d 732e 0a20 2020 2023 2057 6520 6861  VMs..    # We ha
+00013c00: 7665 206d 6974 6967 6174 6564 2074 6869  ve mitigated thi
+00013c10: 7320 6279 2061 6761 696e 2066 6972 7374  s by again first
+00013c20: 2071 7565 7279 696e 6720 7468 6520 564d   querying the VM
+00013c30: 2073 7461 7465 2066 726f 6d20 7468 6520   state from the 
+00013c40: 636c 6f75 640a 2020 2020 2320 7072 6f76  cloud.    # prov
+00013c50: 6964 6572 2e0a 2020 2020 6966 2061 6c6c  ider..    if all
+00013c60: 5f6e 6f64 6573 5f75 7020 616e 6420 7275  _nodes_up and ru
+00013c70: 6e5f 7261 795f 7374 6174 7573 5f74 6f5f  n_ray_status_to_
+00013c80: 6368 6563 6b5f 7261 795f 636c 7573 7465  check_ray_cluste
+00013c90: 725f 6865 616c 7468 7928 293a 0a20 2020  r_healthy():.   
+00013ca0: 2020 2020 2023 204e 4f54 453a 2061 6c6c       # NOTE: all
+00013cb0: 5f6e 6f64 6573 5f75 7020 6361 6c63 756c  _nodes_up calcul
+00013cc0: 6174 696f 6e20 6973 2066 6173 7420 6475  ation is fast du
+00013cd0: 6520 746f 2063 616c 6c69 6e67 2063 6c6f  e to calling clo
+00013ce0: 7564 2043 4c49 3b0a 2020 2020 2020 2020  ud CLI;.        
+00013cf0: 2320 7275 6e5f 7261 795f 7374 6174 7573  # run_ray_status
+00013d00: 5f74 6f5f 6368 6563 6b5f 616c 6c5f 6e6f  _to_check_all_no
+00013d10: 6465 735f 7570 2829 2069 7320 736c 6f77  des_up() is slow
+00013d20: 2064 7565 2074 6f20 6361 6c6c 696e 6720   due to calling 
+00013d30: 6072 6179 2067 6574 0a20 2020 2020 2020  `ray get.       
+00013d40: 2023 2068 6561 642d 6970 2f77 6f72 6b65   # head-ip/worke
+00013d50: 722d 6970 7360 2e0a 2020 2020 2020 2020  r-ips`..        
+00013d60: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
+00013d70: 203d 2073 7461 7475 735f 6c69 622e 436c   = status_lib.Cl
+00013d80: 7573 7465 7253 7461 7475 732e 5550 0a20  usterStatus.UP. 
+00013d90: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
+00013da0: 6572 5f73 7461 7465 2e61 6464 5f6f 725f  er_state.add_or_
+00013db0: 7570 6461 7465 5f63 6c75 7374 6572 2863  update_cluster(c
+00013dc0: 6c75 7374 6572 5f6e 616d 652c 0a20 2020  luster_name,.   
+00013dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013df0: 2020 2020 2020 2020 2020 2020 2068 616e               han
+00013e00: 646c 652c 0a20 2020 2020 2020 2020 2020  dle,.           
+00013e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e30: 2020 2020 2072 6571 7565 7374 6564 5f72       requested_r
+00013e40: 6573 6f75 7263 6573 3d4e 6f6e 652c 0a20  esources=None,. 
+00013e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013e80: 6561 6479 3d54 7275 652c 0a20 2020 2020  eady=True,.     
+00013e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013eb0: 2020 2020 2020 2020 2020 2069 735f 6c61             is_la
+00013ec0: 756e 6368 3d46 616c 7365 290a 2020 2020  unch=False).    
+00013ed0: 2020 2020 7265 7475 726e 2072 6563 6f72      return recor
+00013ee0: 640a 0a20 2020 2023 2041 6c6c 2063 6173  d..    # All cas
+00013ef0: 6573 2062 656c 6f77 2061 7265 2074 7261  es below are tra
+00013f00: 6e73 6974 696f 6e69 6e67 2074 6865 2063  nsitioning the c
+00013f10: 6c75 7374 6572 2074 6f20 6e6f 6e2d 5550  luster to non-UP
+00013f20: 2073 7461 7465 732e 0a20 2020 2069 6620   states..    if 
+00013f30: 6c65 6e28 6e6f 6465 5f73 7461 7475 7365  len(node_statuse
+00013f40: 7329 203e 2068 616e 646c 652e 6c61 756e  s) > handle.laun
+00013f50: 6368 6564 5f6e 6f64 6573 3a0a 2020 2020  ched_nodes:.    
+00013f60: 2020 2020 2320 556e 6578 7065 6374 6564      # Unexpected
+00013f70: 3a20 696e 2074 6865 2071 7565 7269 6564  : in the queried
+00013f80: 2072 6567 696f 6e20 6d6f 7265 2074 6861   region more tha
+00013f90: 6e20 3120 636c 7573 7465 7220 7769 7468  n 1 cluster with
+00013fa0: 2074 6865 2073 616d 650a 2020 2020 2020   the same.      
+00013fb0: 2020 2320 636f 6e73 7472 7563 7465 6420    # constructed 
+00013fc0: 6e61 6d65 2074 6167 2072 6574 7572 6e65  name tag returne
+00013fd0: 642e 2054 6869 7320 7769 6c6c 2074 7970  d. This will typ
+00013fe0: 6963 616c 6c79 206e 6f74 2068 6170 7065  ically not happe
+00013ff0: 6e20 756e 6c65 7373 0a20 2020 2020 2020  n unless.       
+00014000: 2023 2075 7365 7273 206d 616e 7561 6c6c   # users manuall
+00014010: 7920 6372 6561 7465 2061 2063 6c75 7374  y create a clust
+00014020: 6572 2077 6974 6820 7468 6174 2063 6f6e  er with that con
+00014030: 7374 7275 6374 6564 206e 616d 6520 6f72  structed name or
+00014040: 2074 6865 7265 0a20 2020 2020 2020 2023   there.        #
+00014050: 2077 6173 2061 2072 6573 6f75 7263 6520   was a resource 
+00014060: 6c65 616b 2063 6175 7365 6420 6279 2064  leak caused by d
+00014070: 6966 6665 7265 6e74 206c 6175 6e63 6820  ifferent launch 
+00014080: 6861 7368 2062 6566 6f72 6520 2331 3637  hash before #167
+00014090: 310a 2020 2020 2020 2020 2320 7761 7320  1.        # was 
+000140a0: 6d65 7267 6564 2e0a 2020 2020 2020 2020  merged..        
+000140b0: 230a 2020 2020 2020 2020 2320 2854 6563  #.        # (Tec
+000140c0: 686e 6963 616c 6c79 2073 7065 616b 696e  hnically speakin
+000140d0: 672c 2065 7665 6e20 6966 2072 6574 7572  g, even if retur
+000140e0: 6e65 6420 6e75 6d20 6e6f 6465 7320 3c3d  ned num nodes <=
+000140f0: 206e 756d 0a20 2020 2020 2020 2023 2068   num.        # h
+00014100: 616e 646c 652e 6c61 756e 6368 6564 5f6e  andle.launched_n
+00014110: 6f64 6573 292c 206e 6f74 2069 6e63 6c75  odes), not inclu
+00014120: 6469 6e67 2074 6865 206c 6175 6e63 6820  ding the launch 
+00014130: 6861 7368 2063 6f75 6c64 206d 6561 6e20  hash could mean 
+00014140: 7468 650a 2020 2020 2020 2020 2320 7265  the.        # re
+00014150: 7475 726e 6564 206e 6f64 6573 2063 6f6e  turned nodes con
+00014160: 7461 696e 2073 6f6d 6520 6e6f 6465 7320  tain some nodes 
+00014170: 7468 6174 2064 6f20 6e6f 7420 6265 6c6f  that do not belo
+00014180: 6e67 2074 6f20 7468 6520 6c6f 6769 6361  ng to the logica
+00014190: 6c0a 2020 2020 2020 2020 2320 736b 7970  l.        # skyp
+000141a0: 696c 6f74 2063 6c75 7374 6572 2e20 446f  ilot cluster. Do
+000141b0: 6573 6e27 7420 7365 656d 2074 6f20 6265  esn't seem to be
+000141c0: 2061 2067 6f6f 6420 7761 7920 746f 2068   a good way to h
+000141d0: 616e 646c 6520 7468 6973 2066 6f72 0a20  andle this for. 
+000141e0: 2020 2020 2020 2023 206e 6f77 3f29 0a20         # now?). 
+000141f0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00014200: 2023 2057 6520 6861 7665 206e 6f74 2065   # We have not e
+00014210: 7870 6572 6965 6e63 6564 2074 6865 2061  xperienced the a
+00014220: 626f 7665 3b20 6164 6469 6e67 2061 7320  bove; adding as 
+00014230: 6120 7361 6665 6775 6172 642e 0a20 2020  a safeguard..   
+00014240: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00014250: 2053 696e 6365 2077 6520 6661 696c 6564   Since we failed
+00014260: 2074 6f20 7265 6672 6573 682c 2072 6169   to refresh, rai
+00014270: 7365 2074 6865 2073 7461 7475 7320 6665  se the status fe
+00014280: 7463 6869 6e67 2065 7272 6f72 2e0a 2020  tching error..  
+00014290: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
+000142a0: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
+000142b0: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
+000142c0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000142d0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+000142e0: 2e43 6c75 7374 6572 5374 6174 7573 4665  .ClusterStatusFe
+000142f0: 7463 6869 6e67 4572 726f 7228 0a20 2020  tchingError(.   
+00014300: 2020 2020 2020 2020 2020 2020 2066 2746               f'F
+00014310: 6f75 6e64 207b 6c65 6e28 6e6f 6465 5f73  ound {len(node_s
+00014320: 7461 7475 7365 7329 7d20 6e6f 6465 2873  tatuses)} node(s
+00014330: 2920 7769 7468 2074 6865 2073 616d 6520  ) with the same 
+00014340: 636c 7573 7465 7220 6e61 6d65 270a 2020  cluster name'.  
+00014350: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014360: 2074 6167 2069 6e20 7468 6520 636c 6f75   tag in the clou
+00014370: 6420 7072 6f76 6964 6572 2066 6f72 2063  d provider for c
+00014380: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
+00014390: 6e61 6d65 2172 7d2c 2027 0a20 2020 2020  name!r}, '.     
+000143a0: 2020 2020 2020 2020 2020 2066 2777 6869             f'whi
+000143b0: 6368 2073 686f 756c 6420 6861 7665 207b  ch should have {
+000143c0: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
+000143d0: 6e6f 6465 737d 206e 6f64 6573 2e20 5468  nodes} nodes. Th
+000143e0: 6973 2027 0a20 2020 2020 2020 2020 2020  is '.           
+000143f0: 2020 2020 2066 276e 6f72 6d61 6c6c 7920       f'normally 
+00014400: 7368 6f75 6c64 206e 6f74 2068 6170 7065  should not happe
+00014410: 6e2e 207b 636f 6c6f 7261 6d61 2e46 6f72  n. {colorama.For
+00014420: 652e 5245 447d 506c 6561 7365 2063 6865  e.RED}Please che
+00014430: 636b 2027 0a20 2020 2020 2020 2020 2020  ck '.           
+00014440: 2020 2020 2027 7468 6520 636c 6f75 6420       'the cloud 
+00014450: 636f 6e73 6f6c 6520 616e 6420 6669 7820  console and fix 
+00014460: 616e 7920 706f 7373 6962 6c65 2072 6573  any possible res
+00014470: 6f75 7263 6573 206c 6561 6b61 6765 2027  ources leakage '
+00014480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014490: 2027 2865 2e67 2e2c 2069 6620 7468 6572   '(e.g., if ther
+000144a0: 6520 6172 6520 616e 7920 7374 6f70 7065  e are any stoppe
+000144b0: 6420 6e6f 6465 7320 616e 6420 7468 6579  d nodes and they
+000144c0: 2064 6f20 6e6f 7420 6861 7665 2027 0a20   do not have '. 
+000144d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000144e0: 6461 7461 206f 7220 6172 6520 756e 6865  data or are unhe
+000144f0: 616c 7468 792c 2074 6572 6d69 6e61 7465  althy, terminate
+00014500: 2074 6865 6d29 2e27 0a20 2020 2020 2020   them).'.       
+00014510: 2020 2020 2020 2020 2066 277b 636f 6c6f           f'{colo
+00014520: 7261 6d61 2e53 7479 6c65 2e52 4553 4554  rama.Style.RESET
+00014530: 5f41 4c4c 7d27 290a 2020 2020 6173 7365  _ALL}').    asse
+00014540: 7274 206c 656e 286e 6f64 655f 7374 6174  rt len(node_stat
+00014550: 7573 6573 2920 3c3d 2068 616e 646c 652e  uses) <= handle.
+00014560: 6c61 756e 6368 6564 5f6e 6f64 6573 0a0a  launched_nodes..
+00014570: 2020 2020 2320 4966 2074 6865 206e 6f64      # If the nod
+00014580: 655f 7374 6174 7573 6573 2069 7320 656d  e_statuses is em
+00014590: 7074 792c 2061 6c6c 2074 6865 206e 6f64  pty, all the nod
+000145a0: 6573 2061 7265 2074 6572 6d69 6e61 7465  es are terminate
+000145b0: 642e 2057 6520 6361 6e0a 2020 2020 2320  d. We can.    # 
+000145c0: 7361 6665 6c79 2073 6574 2074 6865 2063  safely set the c
+000145d0: 6c75 7374 6572 2073 7461 7475 7320 746f  luster status to
+000145e0: 2054 4552 4d49 4e41 5445 442e 2054 6869   TERMINATED. Thi
+000145f0: 7320 6861 6e64 6c65 7320 7468 6520 6564  s handles the ed
+00014600: 6765 2063 6173 650a 2020 2020 2320 7768  ge case.    # wh
+00014610: 6572 6520 7468 6520 636c 7573 7465 7220  ere the cluster 
+00014620: 6973 2074 6572 6d69 6e61 7465 6420 6279  is terminated by
+00014630: 2074 6865 2075 7365 7220 6d61 6e75 616c   the user manual
+00014640: 6c79 2074 6872 6f75 6768 2074 6865 2055  ly through the U
+00014650: 492e 0a20 2020 2074 6f5f 7465 726d 696e  I..    to_termin
+00014660: 6174 6520 3d20 6e6f 7420 6e6f 6465 5f73  ate = not node_s
+00014670: 7461 7475 7365 730a 0a20 2020 2023 2041  tatuses..    # A
+00014680: 2063 6c75 7374 6572 2069 7320 636f 6e73   cluster is cons
+00014690: 6964 6572 6564 2022 6162 6e6f 726d 616c  idered "abnormal
+000146a0: 222c 2069 6620 6e6f 7420 616c 6c20 6e6f  ", if not all no
+000146b0: 6465 7320 6172 6520 5445 524d 494e 4154  des are TERMINAT
+000146c0: 4544 206f 720a 2020 2020 2320 6e6f 7420  ED or.    # not 
+000146d0: 616c 6c20 6e6f 6465 7320 6172 6520 5354  all nodes are ST
+000146e0: 4f50 5045 442e 2057 6520 6368 6563 6b20  OPPED. We check 
+000146f0: 7468 6174 2077 6974 6820 7468 6520 666f  that with the fo
+00014700: 6c6c 6f77 696e 6720 6c6f 6769 633a 0a20  llowing logic:. 
+00014710: 2020 2023 2020 202a 204e 6f74 2061 6c6c     #   * Not all
+00014720: 206e 6f64 6573 2061 7265 2074 6572 6d69   nodes are termi
+00014730: 6e61 7465 6420 616e 6420 7468 6572 6527  nated and there'
+00014740: 7320 6174 206c 6561 7374 206f 6e65 206e  s at least one n
+00014750: 6f64 650a 2020 2020 2320 2020 2020 7465  ode.    #     te
+00014760: 726d 696e 6174 6564 3b20 6f72 0a20 2020  rminated; or.   
+00014770: 2023 2020 202a 2041 6e79 206f 6620 7468   #   * Any of th
+00014780: 6520 6e6f 6e2d 5445 524d 494e 4154 4544  e non-TERMINATED
+00014790: 206e 6f64 6573 2069 7320 696e 2061 206e   nodes is in a n
+000147a0: 6f6e 2d53 544f 5050 4544 2073 7461 7475  on-STOPPED statu
+000147b0: 732e 0a20 2020 2023 0a20 2020 2023 2054  s..    #.    # T
+000147c0: 6869 7320 696e 636c 7564 6573 2074 6865  his includes the
+000147d0: 7365 2073 7065 6369 616c 2063 6173 6573  se special cases
+000147e0: 3a0a 2020 2020 2320 2020 2a20 416c 6c20  :.    #   * All 
+000147f0: 7374 6f70 7065 6420 6172 6520 636f 6e73  stopped are cons
+00014800: 6964 6572 6564 206e 6f72 6d61 6c20 616e  idered normal an
+00014810: 6420 7769 6c6c 2062 6520 636c 6561 6e65  d will be cleane
+00014820: 6420 7570 2061 7420 7468 6520 656e 640a  d up at the end.
+00014830: 2020 2020 2320 2020 2020 6f66 2074 6865      #     of the
+00014840: 2066 756e 6374 696f 6e2e 0a20 2020 2023   function..    #
+00014850: 2020 202a 2053 6f6d 6520 6f66 2074 6865     * Some of the
+00014860: 206e 6f64 6573 2055 5020 7368 6f75 6c64   nodes UP should
+00014870: 2062 6520 636f 6e73 6964 6572 6564 2061   be considered a
+00014880: 626e 6f72 6d61 6c2c 2062 6563 6175 7365  bnormal, because
+00014890: 2074 6865 2072 6179 0a20 2020 2023 2020   the ray.    #  
+000148a0: 2020 2063 6c75 7374 6572 2069 7320 7072     cluster is pr
+000148b0: 6f62 6162 6c79 2064 6f77 6e2e 0a20 2020  obably down..   
+000148c0: 2023 2020 202a 2054 6865 2063 6c75 7374   #   * The clust
+000148d0: 6572 2069 7320 7061 7274 6961 6c6c 7920  er is partially 
+000148e0: 7465 726d 696e 6174 6564 206f 7220 7374  terminated or st
+000148f0: 6f70 7065 6420 7368 6f75 6c64 2062 6520  opped should be 
+00014900: 636f 6e73 6964 6572 6564 0a20 2020 2023  considered.    #
+00014910: 2020 2020 2061 626e 6f72 6d61 6c2e 0a20       abnormal.. 
+00014920: 2020 2023 0a20 2020 2023 2041 6e20 6162     #.    # An ab
+00014930: 6e6f 726d 616c 2063 6c75 7374 6572 2077  normal cluster w
+00014940: 696c 6c20 7472 616e 7369 7469 6f6e 2074  ill transition t
+00014950: 6f20 494e 4954 2061 6e64 2068 6176 6520  o INIT and have 
+00014960: 616e 7920 6175 746f 7374 6f70 2073 6574  any autostop set
+00014970: 7469 6e67 0a20 2020 2023 2072 6573 6574  ting.    # reset
+00014980: 2028 756e 6c65 7373 2069 7427 7320 6175   (unless it's au
+00014990: 746f 7374 6f70 7069 6e67 2f61 7574 6f64  tostopping/autod
+000149a0: 6f77 6e69 6e67 292e 0a20 2020 2069 735f  owning)..    is_
+000149b0: 6162 6e6f 726d 616c 203d 2028 2830 203c  abnormal = ((0 <
+000149c0: 206c 656e 286e 6f64 655f 7374 6174 7573   len(node_status
+000149d0: 6573 2920 3c20 6861 6e64 6c65 2e6c 6175  es) < handle.lau
+000149e0: 6e63 6865 645f 6e6f 6465 7329 206f 7220  nched_nodes) or 
+000149f0: 616e 7928 0a20 2020 2020 2020 2073 7461  any(.        sta
+00014a00: 7475 7320 213d 2073 7461 7475 735f 6c69  tus != status_li
+00014a10: 622e 436c 7573 7465 7253 7461 7475 732e  b.ClusterStatus.
+00014a20: 5354 4f50 5045 4420 666f 7220 7374 6174  STOPPED for stat
+00014a30: 7573 2069 6e20 6e6f 6465 5f73 7461 7475  us in node_statu
+00014a40: 7365 7329 290a 2020 2020 6966 2069 735f  ses)).    if is_
+00014a50: 6162 6e6f 726d 616c 3a0a 2020 2020 2020  abnormal:.      
+00014a60: 2020 6c6f 6767 6572 2e64 6562 7567 2827    logger.debug('
+00014a70: 5468 6520 636c 7573 7465 7220 6973 2061  The cluster is a
+00014a80: 626e 6f72 6d61 6c2e 2053 6574 7469 6e67  bnormal. Setting
+00014a90: 2074 6f20 494e 4954 2073 7461 7475 732e   to INIT status.
+00014aa0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00014ab0: 2020 2020 2020 2020 6627 6e6f 6465 5f73          f'node_s
+00014ac0: 7461 7475 7365 733a 207b 6e6f 6465 5f73  tatuses: {node_s
+00014ad0: 7461 7475 7365 737d 2729 0a20 2020 2020  tatuses}').     
+00014ae0: 2020 2062 6163 6b65 6e64 203d 2067 6574     backend = get
+00014af0: 5f62 6163 6b65 6e64 5f66 726f 6d5f 6861  _backend_from_ha
+00014b00: 6e64 6c65 2868 616e 646c 6529 0a20 2020  ndle(handle).   
+00014b10: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00014b20: 6365 2862 6163 6b65 6e64 2c0a 2020 2020  ce(backend,.    
+00014b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b40: 2020 6261 636b 656e 6473 2e43 6c6f 7564    backends.Cloud
+00014b50: 566d 5261 7942 6163 6b65 6e64 2920 616e  VmRayBackend) an
+00014b60: 6420 7265 636f 7264 5b27 6175 746f 7374  d record['autost
+00014b70: 6f70 275d 203e 3d20 303a 0a20 2020 2020  op'] >= 0:.     
+00014b80: 2020 2020 2020 2069 6620 6e6f 7420 6261         if not ba
+00014b90: 636b 656e 642e 6973 5f64 6566 696e 6974  ckend.is_definit
+00014ba0: 656c 795f 6175 746f 7374 6f70 7069 6e67  ely_autostopping
+00014bb0: 2868 616e 646c 652c 0a20 2020 2020 2020  (handle,.       
+00014bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014be0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014bf0: 7472 6561 6d5f 6c6f 6773 3d46 616c 7365  tream_logs=False
+00014c00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00014c10: 2020 2023 2046 7269 656e 646c 7920 6869     # Friendly hi
+00014c20: 6e74 2e0a 2020 2020 2020 2020 2020 2020  nt..            
+00014c30: 2020 2020 6175 746f 7374 6f70 203d 2072      autostop = r
+00014c40: 6563 6f72 645b 2761 7574 6f73 746f 7027  ecord['autostop'
+00014c50: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00014c60: 2020 6d61 7962 655f 646f 776e 5f73 7472    maybe_down_str
+00014c70: 203d 2027 202d 2d64 6f77 6e27 2069 6620   = ' --down' if 
+00014c80: 7265 636f 7264 5b27 746f 5f64 6f77 6e27  record['to_down'
+00014c90: 5d20 656c 7365 2027 270a 2020 2020 2020  ] else ''.      
+00014ca0: 2020 2020 2020 2020 2020 6e6f 756e 203d            noun =
+00014cb0: 2027 6175 746f 646f 776e 2720 6966 2072   'autodown' if r
+00014cc0: 6563 6f72 645b 2774 6f5f 646f 776e 275d  ecord['to_down']
+00014cd0: 2065 6c73 6520 2761 7574 6f73 746f 7027   else 'autostop'
+00014ce0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00014cf0: 2020 2320 5265 7365 7420 7468 6520 6175    # Reset the au
+00014d00: 746f 7374 6f70 7069 6e67 2061 7320 7468  tostopping as th
+00014d10: 6520 636c 7573 7465 7220 6973 2061 626e  e cluster is abn
+00014d20: 6f72 6d61 6c2c 2061 6e64 206d 6179 0a20  ormal, and may. 
+00014d30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014d40: 206e 6f74 2063 6f72 7265 6374 6c79 2061   not correctly a
+00014d50: 7574 6f73 746f 702e 2052 6573 6574 7469  utostop. Resetti
+00014d60: 6e67 2074 6865 2061 7574 6f73 746f 7020  ng the autostop 
+00014d70: 7769 6c6c 206c 6574 0a20 2020 2020 2020  will let.       
+00014d80: 2020 2020 2020 2020 2023 2074 6865 2075           # the u
+00014d90: 7365 7220 6b6e 6f77 2074 6861 7420 7468  ser know that th
+00014da0: 6520 6175 746f 7374 6f70 206d 6179 206e  e autostop may n
+00014db0: 6f74 2068 6170 7065 6e20 746f 2061 766f  ot happen to avo
+00014dc0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+00014dd0: 2020 2023 206c 6561 6b61 6765 7320 6672     # leakages fr
+00014de0: 6f6d 2074 6865 2061 7373 756d 7074 696f  om the assumptio
+00014df0: 6e20 7468 6174 2074 6865 2063 6c75 7374  n that the clust
+00014e00: 6572 2077 696c 6c20 6175 746f 7374 6f70  er will autostop
+00014e10: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00014e20: 2020 7375 6363 6573 7320 3d20 5472 7565    success = True
+00014e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e40: 2072 6573 6574 5f6c 6f63 616c 5f61 7574   reset_local_aut
+00014e50: 6f73 746f 7020 3d20 5472 7565 0a20 2020  ostop = True.   
+00014e60: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00014e70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014e80: 2020 2020 2020 6261 636b 656e 642e 7365        backend.se
+00014e90: 745f 6175 746f 7374 6f70 2868 616e 646c  t_autostop(handl
+00014ea0: 652c 202d 312c 2073 7472 6561 6d5f 6c6f  e, -1, stream_lo
+00014eb0: 6773 3d46 616c 7365 290a 2020 2020 2020  gs=False).      
+00014ec0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00014ed0: 2065 7863 6570 7469 6f6e 732e 436f 6d6d   exceptions.Comm
+00014ee0: 616e 6445 7272 6f72 2061 7320 653a 0a20  andError as e:. 
+00014ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f00: 2020 2073 7563 6365 7373 203d 2046 616c     success = Fal
+00014f10: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00014f20: 2020 2020 2020 2069 6620 652e 7265 7475         if e.retu
+00014f30: 726e 636f 6465 203d 3d20 3235 353a 0a20  rncode == 255:. 
+00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f50: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00014f60: 6275 6728 6627 5468 6520 636c 7573 7465  bug(f'The cluste
+00014f70: 7220 6973 206c 696b 656c 7920 7b6e 6f75  r is likely {nou
+00014f80: 6e7d 6564 2e27 290a 2020 2020 2020 2020  n}ed.').        
+00014f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014fa0: 7265 7365 745f 6c6f 6361 6c5f 6175 746f  reset_local_auto
+00014fb0: 7374 6f70 203d 2046 616c 7365 0a20 2020  stop = False.   
+00014fc0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00014fd0: 6570 7420 2845 7863 6570 7469 6f6e 2c20  ept (Exception, 
+00014fe0: 5379 7374 656d 4578 6974 2920 6173 2065  SystemExit) as e
+00014ff0: 3a20 2023 2070 796c 696e 743a 2064 6973  :  # pylint: dis
+00015000: 6162 6c65 3d62 726f 6164 2d65 7863 6570  able=broad-excep
+00015010: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00015020: 2020 2020 2020 7375 6363 6573 7320 3d20        success = 
+00015030: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00015040: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00015050: 2e64 6562 7567 2866 2746 6169 6c65 6420  .debug(f'Failed 
+00015060: 746f 2072 6573 6574 2061 7574 6f73 746f  to reset autosto
+00015070: 702e 2044 7565 2074 6f20 270a 2020 2020  p. Due to '.    
+00015080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015090: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+000150a0: 636f 6d6d 6f6e 5f75 7469 6c73 2e66 6f72  common_utils.for
+000150b0: 6d61 745f 6578 6365 7074 696f 6e28 6529  mat_exception(e)
+000150c0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+000150d0: 2020 2020 6966 2072 6573 6574 5f6c 6f63      if reset_loc
+000150e0: 616c 5f61 7574 6f73 746f 703a 0a20 2020  al_autostop:.   
+000150f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015100: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+00015110: 7465 2e73 6574 5f63 6c75 7374 6572 5f61  te.set_cluster_a
+00015120: 7574 6f73 746f 705f 7661 6c75 6528 0a20  utostop_value(. 
+00015130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015140: 2020 2020 2020 2068 616e 646c 652e 636c         handle.cl
+00015150: 7573 7465 725f 6e61 6d65 2c20 2d31 2c20  uster_name, -1, 
+00015160: 746f 5f64 6f77 6e3d 4661 6c73 6529 0a0a  to_down=False)..
+00015170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015180: 6966 2073 7563 6365 7373 3a0a 2020 2020  if success:.    
+00015190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151a0: 6f70 6572 6174 696f 6e5f 7374 7220 3d20  operation_str = 
+000151b0: 2866 2743 616e 6365 6c65 6420 7b6e 6f75  (f'Canceled {nou
+000151c0: 6e7d 206f 6e20 7468 6520 636c 7573 7465  n} on the cluste
+000151d0: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+000151e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151f0: 2020 2020 2020 2020 2066 277b 636c 7573           f'{clus
+00015200: 7465 725f 6e61 6d65 2172 7d27 290a 2020  ter_name!r}').  
+00015210: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00015220: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015230: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00015240: 6e5f 7374 7220 3d20 280a 2020 2020 2020  n_str = (.      
+00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015260: 2020 6627 4174 7465 6d70 7465 6420 746f    f'Attempted to
+00015270: 2063 616e 6365 6c20 7b6e 6f75 6e7d 206f   cancel {noun} o
+00015280: 6e20 7468 6520 270a 2020 2020 2020 2020  n the '.        
+00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152a0: 6627 636c 7573 7465 7220 7b63 6c75 7374  f'cluster {clust
+000152b0: 6572 5f6e 616d 6521 727d 2077 6974 6820  er_name!r} with 
+000152c0: 6265 7374 2065 6666 6f72 7427 290a 2020  best effort').  
+000152d0: 2020 2020 2020 2020 2020 2020 2020 7965                ye
+000152e0: 6c6c 6f77 203d 2063 6f6c 6f72 616d 612e  llow = colorama.
+000152f0: 466f 7265 2e59 454c 4c4f 570a 2020 2020  Fore.YELLOW.    
+00015300: 2020 2020 2020 2020 2020 2020 6272 6967              brig
+00015310: 6874 203d 2063 6f6c 6f72 616d 612e 5374  ht = colorama.St
+00015320: 796c 652e 4252 4947 4854 0a20 2020 2020  yle.BRIGHT.     
+00015330: 2020 2020 2020 2020 2020 2072 6573 6574             reset
+00015340: 203d 2063 6f6c 6f72 616d 612e 5374 796c   = colorama.Styl
+00015350: 652e 5245 5345 545f 414c 4c0a 2020 2020  e.RESET_ALL.    
+00015360: 2020 2020 2020 2020 2020 2020 7578 5f75              ux_u
+00015370: 7469 6c73 2e63 6f6e 736f 6c65 5f6e 6577  tils.console_new
+00015380: 6c69 6e65 2829 0a20 2020 2020 2020 2020  line().         
+00015390: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+000153a0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+000153b0: 2020 2020 2020 2020 2020 2066 277b 7965             f'{ye
+000153c0: 6c6c 6f77 7d7b 6f70 6572 6174 696f 6e5f  llow}{operation_
+000153d0: 7374 727d 2c20 7369 6e63 6520 6974 2069  str}, since it i
+000153e0: 7320 666f 756e 6420 746f 2062 6520 696e  s found to be in
+000153f0: 2061 6e20 270a 2020 2020 2020 2020 2020   an '.          
+00015400: 2020 2020 2020 2020 2020 6627 6162 6e6f            f'abno
+00015410: 726d 616c 2073 7461 7465 2e20 546f 2066  rmal state. To f
+00015420: 6978 2c20 7472 7920 7275 6e6e 696e 673a  ix, try running:
+00015430: 207b 7265 7365 747d 7b62 7269 6768 747d   {reset}{bright}
+00015440: 736b 7920 270a 2020 2020 2020 2020 2020  sky '.          
+00015450: 2020 2020 2020 2020 2020 6627 7374 6172            f'star
+00015460: 7420 2d66 202d 6920 7b61 7574 6f73 746f  t -f -i {autosto
+00015470: 707d 7b6d 6179 6265 5f64 6f77 6e5f 7374  p}{maybe_down_st
+00015480: 727d 207b 636c 7573 7465 725f 6e61 6d65  r} {cluster_name
+00015490: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+000154a0: 2020 2020 2020 2066 277b 7265 7365 747d         f'{reset}
+000154b0: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
+000154c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000154d0: 2020 2020 2075 785f 7574 696c 732e 636f       ux_utils.co
+000154e0: 6e73 6f6c 655f 6e65 776c 696e 6528 290a  nsole_newline().
+000154f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015500: 6f70 6572 6174 696f 6e5f 7374 7220 3d20  operation_str = 
+00015510: 2761 7574 6f64 6f77 6e69 6e67 2720 6966  'autodowning' if
+00015520: 2072 6563 6f72 645b 0a20 2020 2020 2020   record[.       
+00015530: 2020 2020 2020 2020 2020 2020 2027 746f               'to
+00015540: 5f64 6f77 6e27 5d20 656c 7365 2027 6175  _down'] else 'au
+00015550: 746f 7374 6f70 7069 6e67 270a 2020 2020  tostopping'.    
+00015560: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00015570: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+00015580: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
+00015590: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
+000155a0: 6e61 6d65 2172 7d20 6973 207b 6f70 6572  name!r} is {oper
+000155b0: 6174 696f 6e5f 7374 727d 2e20 5365 7474  ation_str}. Sett
+000155c0: 696e 6720 746f 2027 0a20 2020 2020 2020  ing to '.       
+000155d0: 2020 2020 2020 2020 2020 2020 2027 494e               'IN
+000155e0: 4954 2073 7461 7475 733b 2074 7279 2072  IT status; try r
+000155f0: 6566 7265 7368 2061 6761 696e 2069 6e20  efresh again in 
+00015600: 6120 7768 696c 652e 2729 0a0a 2020 2020  a while.')..    
+00015610: 2020 2020 2320 4966 2074 6865 2075 7365      # If the use
+00015620: 7220 7374 6172 7473 2070 6172 7420 6f66  r starts part of
+00015630: 2061 2053 544f 5050 4544 2063 6c75 7374   a STOPPED clust
+00015640: 6572 2c20 7765 2073 7469 6c6c 206e 6565  er, we still nee
+00015650: 6420 6120 7374 6174 7573 0a20 2020 2020  d a status.     
+00015660: 2020 2023 2074 6f20 7265 7072 6573 656e     # to represen
+00015670: 7420 7468 6520 6162 6e6f 726d 616c 2073  t the abnormal s
+00015680: 7461 7475 732e 2046 6f72 2073 706f 7420  tatus. For spot 
+00015690: 636c 7573 7465 722c 2069 7420 6361 6e20  cluster, it can 
+000156a0: 616c 736f 0a20 2020 2020 2020 2023 2072  also.        # r
+000156b0: 6570 7265 7365 6e74 2074 6861 7420 7468  epresent that th
+000156c0: 6520 636c 7573 7465 7220 6973 2070 6172  e cluster is par
+000156d0: 7469 616c 6c79 2070 7265 656d 7074 6564  tially preempted
+000156e0: 2e0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
+000156f0: 287a 6877 7529 3a20 7468 6520 6465 6669  (zhwu): the defi
+00015700: 6e69 7469 6f6e 206f 6620 494e 4954 2073  nition of INIT s
+00015710: 686f 756c 6420 6265 2061 7564 6974 6564  hould be audited
+00015720: 2f63 6861 6e67 6564 2e0a 2020 2020 2020  /changed..      
+00015730: 2020 2320 4164 6469 6e67 2061 206e 6577    # Adding a new
+00015740: 2073 7461 7475 7320 554e 4845 414c 5448   status UNHEALTH
+00015750: 5920 666f 7220 6162 6e6f 726d 616c 2073  Y for abnormal s
+00015760: 7461 7475 7320 6361 6e20 6265 2061 2063  tatus can be a c
+00015770: 686f 6963 652e 0a20 2020 2020 2020 2067  hoice..        g
+00015780: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+00015790: 2e61 6464 5f6f 725f 7570 6461 7465 5f63  .add_or_update_c
+000157a0: 6c75 7374 6572 2863 6c75 7374 6572 5f6e  luster(cluster_n
+000157b0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+000157c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157e0: 2020 2020 2068 616e 646c 652c 0a20 2020       handle,.   
+000157f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015810: 2020 2020 2020 2020 2020 2020 2072 6571               req
+00015820: 7565 7374 6564 5f72 6573 6f75 7263 6573  uested_resources
+00015830: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 2020 2020 2020 2072 6561 6479 3d46 616c         ready=Fal
+00015870: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00015880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158a0: 2020 2020 6973 5f6c 6175 6e63 683d 4661      is_launch=Fa
+000158b0: 6c73 6529 0a20 2020 2020 2020 2072 6574  lse).        ret
+000158c0: 7572 6e20 676c 6f62 616c 5f75 7365 725f  urn global_user_
+000158d0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
+000158e0: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
+000158f0: 7465 725f 6e61 6d65 290a 2020 2020 2320  ter_name).    # 
+00015900: 4e6f 7720 6973 5f61 626e 6f72 6d61 6c20  Now is_abnormal 
+00015910: 6973 2046 616c 7365 3a20 6569 7468 6572  is False: either
+00015920: 206e 6f64 655f 7374 6174 7573 6573 2069   node_statuses i
+00015930: 7320 656d 7074 7920 6f72 2061 6c6c 206e  s empty or all n
+00015940: 6f64 6573 2061 7265 0a20 2020 2023 2053  odes are.    # S
+00015950: 544f 5050 4544 2e0a 2020 2020 6261 636b  TOPPED..    back
+00015960: 656e 6420 3d20 6261 636b 656e 6473 2e43  end = backends.C
+00015970: 6c6f 7564 566d 5261 7942 6163 6b65 6e64  loudVmRayBackend
+00015980: 2829 0a20 2020 2062 6163 6b65 6e64 2e70  ().    backend.p
+00015990: 6f73 745f 7465 6172 646f 776e 5f63 6c65  ost_teardown_cle
+000159a0: 616e 7570 2868 616e 646c 652c 2074 6572  anup(handle, ter
+000159b0: 6d69 6e61 7465 3d74 6f5f 7465 726d 696e  minate=to_termin
+000159c0: 6174 652c 2070 7572 6765 3d46 616c 7365  ate, purge=False
+000159d0: 290a 2020 2020 7265 7475 726e 2067 6c6f  ).    return glo
+000159e0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+000159f0: 6574 5f63 6c75 7374 6572 5f66 726f 6d5f  et_cluster_from_
+00015a00: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00015a10: 6529 0a0a 0a64 6566 205f 7570 6461 7465  e)...def _update
+00015a20: 5f63 6c75 7374 6572 5f73 7461 7475 7328  _cluster_status(
+00015a30: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
+00015a40: 653a 2073 7472 2c0a 2020 2020 6163 7175  e: str,.    acqu
+00015a50: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00015a60: 7374 6174 7573 5f6c 6f63 6b3a 2062 6f6f  status_lock: boo
+00015a70: 6c2c 0a20 2020 2063 6c75 7374 6572 5f73  l,.    cluster_s
+00015a80: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
+00015a90: 7574 3a20 696e 7420 3d20 434c 5553 5445  ut: int = CLUSTE
+00015aa0: 525f 5354 4154 5553 5f4c 4f43 4b5f 5449  R_STATUS_LOCK_TI
+00015ab0: 4d45 4f55 545f 5345 434f 4e44 530a 2920  MEOUT_SECONDS.) 
+00015ac0: 2d3e 204f 7074 696f 6e61 6c5b 4469 6374  -> Optional[Dict
+00015ad0: 5b73 7472 2c20 416e 795d 5d3a 0a20 2020  [str, Any]]:.   
+00015ae0: 2022 2222 5570 6461 7465 2074 6865 2063   """Update the c
+00015af0: 6c75 7374 6572 2073 7461 7475 732e 0a0a  luster status...
+00015b00: 2020 2020 5468 6520 636c 7573 7465 7220      The cluster 
+00015b10: 7374 6174 7573 2069 7320 7570 6461 7465  status is update
+00015b20: 6420 6279 2063 6865 636b 696e 6720 7261  d by checking ra
+00015b30: 7920 636c 7573 7465 7220 616e 6420 7265  y cluster and re
+00015b40: 616c 2073 7461 7475 7320 6672 6f6d 0a20  al status from. 
+00015b50: 2020 2063 6c6f 7564 2e0a 0a20 2020 2054     cloud...    T
+00015b60: 6865 2066 756e 6374 696f 6e20 7769 6c6c  he function will
+00015b70: 2075 7064 6174 6520 7468 6520 6361 6368   update the cach
+00015b80: 6564 2063 6c75 7374 6572 2073 7461 7475  ed cluster statu
+00015b90: 7320 696e 2074 6865 2067 6c6f 6261 6c20  s in the global 
+00015ba0: 7374 6174 652e 2046 6f72 0a20 2020 2074  state. For.    t
+00015bb0: 6865 2064 6573 6967 6e20 6f66 2074 6865  he design of the
+00015bc0: 2063 6c75 7374 6572 2073 7461 7475 7320   cluster status 
+00015bd0: 616e 6420 7472 616e 7369 7469 6f6e 2c20  and transition, 
+00015be0: 706c 6561 7365 2072 6566 6572 2074 6f20  please refer to 
+00015bf0: 7468 650a 2020 2020 736b 792f 6465 7369  the.    sky/desi
+00015c00: 676e 5f64 6f63 732f 636c 7573 7465 725f  gn_docs/cluster_
+00015c10: 7374 6174 7573 2e6d 640a 0a20 2020 2041  status.md..    A
+00015c20: 7267 733a 0a20 2020 2020 2020 2063 6c75  rgs:.        clu
+00015c30: 7374 6572 5f6e 616d 653a 2054 6865 206e  ster_name: The n
+00015c40: 616d 6520 6f66 2074 6865 2063 6c75 7374  ame of the clust
+00015c50: 6572 2e0a 2020 2020 2020 2020 6163 7175  er..        acqu
+00015c60: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00015c70: 7374 6174 7573 5f6c 6f63 6b3a 2057 6865  status_lock: Whe
+00015c80: 7468 6572 2074 6f20 6163 7175 6972 6520  ther to acquire 
+00015c90: 7468 6520 7065 722d 636c 7573 7465 7220  the per-cluster 
+00015ca0: 6c6f 636b 0a20 2020 2020 2020 2020 2062  lock.          b
+00015cb0: 6566 6f72 6520 7570 6461 7469 6e67 2074  efore updating t
+00015cc0: 6865 2073 7461 7475 732e 0a20 2020 2020  he status..     
+00015cd0: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
+00015ce0: 735f 6c6f 636b 5f74 696d 656f 7574 3a20  s_lock_timeout: 
+00015cf0: 5468 6520 7469 6d65 6f75 7420 746f 2061  The timeout to a
+00015d00: 6371 7569 7265 2074 6865 2070 6572 2d63  cquire the per-c
+00015d10: 6c75 7374 6572 0a20 2020 2020 2020 2020  luster.         
+00015d20: 206c 6f63 6b2e 0a0a 2020 2020 5265 7475   lock...    Retu
+00015d30: 726e 733a 0a20 2020 2020 2020 2049 6620  rns:.        If 
+00015d40: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
+00015d50: 6572 6d69 6e61 7465 6420 6f72 2064 6f65  erminated or doe
+00015d60: 7320 6e6f 7420 6578 6973 742c 2072 6574  s not exist, ret
+00015d70: 7572 6e20 4e6f 6e65 2e20 4f74 6865 7277  urn None. Otherw
+00015d80: 6973 650a 2020 2020 2020 2020 7265 7475  ise.        retu
+00015d90: 726e 7320 7468 6520 696e 7075 7420 7265  rns the input re
+00015da0: 636f 7264 2077 6974 6820 7374 6174 7573  cord with status
+00015db0: 2061 6e64 2068 616e 646c 6520 706f 7465   and handle pote
+00015dc0: 6e74 6961 6c6c 7920 7570 6461 7465 642e  ntially updated.
+00015dd0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+00015de0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+00015df0: 2e43 6c75 7374 6572 4f77 6e65 7249 6465  .ClusterOwnerIde
+00015e00: 6e74 6974 794d 6973 6d61 7463 6845 7272  ntityMismatchErr
+00015e10: 6f72 3a20 6966 2074 6865 2063 7572 7265  or: if the curre
+00015e20: 6e74 2075 7365 7220 6973 0a20 2020 2020  nt user is.     
+00015e30: 2020 2020 206e 6f74 2074 6865 2073 616d       not the sam
+00015e40: 6520 6173 2074 6865 2075 7365 7220 7768  e as the user wh
+00015e50: 6f20 6372 6561 7465 6420 7468 6520 636c  o created the cl
+00015e60: 7573 7465 722e 0a20 2020 2020 2020 2065  uster..        e
+00015e70: 7863 6570 7469 6f6e 732e 436c 6f75 6455  xceptions.CloudU
+00015e80: 7365 7249 6465 6e74 6974 7945 7272 6f72  serIdentityError
+00015e90: 3a20 6966 2077 6520 6661 696c 2074 6f20  : if we fail to 
+00015ea0: 6765 7420 7468 6520 6375 7272 656e 7420  get the current 
+00015eb0: 7573 6572 0a20 2020 2020 2020 2020 2069  user.          i
+00015ec0: 6465 6e74 6974 792e 0a20 2020 2020 2020  dentity..       
+00015ed0: 2065 7863 6570 7469 6f6e 732e 436c 7573   exceptions.Clus
+00015ee0: 7465 7253 7461 7475 7346 6574 6368 696e  terStatusFetchin
+00015ef0: 6745 7272 6f72 3a20 7468 6520 636c 7573  gError: the clus
+00015f00: 7465 7220 7374 6174 7573 2063 616e 6e6f  ter status canno
+00015f10: 7420 6265 0a20 2020 2020 2020 2020 2066  t be.          f
+00015f20: 6574 6368 6564 2066 726f 6d20 7468 6520  etched from the 
+00015f30: 636c 6f75 6420 7072 6f76 6964 6572 206f  cloud provider o
+00015f40: 7220 7468 6572 6520 6172 6520 6c65 616b  r there are leak
+00015f50: 6564 206e 6f64 6573 2063 6175 7369 6e67  ed nodes causing
+00015f60: 0a20 2020 2020 2020 2020 2074 6865 206e  .          the n
+00015f70: 6f64 6520 6e75 6d62 6572 206c 6172 6765  ode number large
+00015f80: 7220 7468 616e 2065 7870 6563 7465 642e  r than expected.
+00015f90: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00015fa0: 6e6f 7420 6163 7175 6972 655f 7065 725f  not acquire_per_
+00015fb0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00015fc0: 6f63 6b3a 0a20 2020 2020 2020 2072 6574  ock:.        ret
+00015fd0: 7572 6e20 5f75 7064 6174 655f 636c 7573  urn _update_clus
+00015fe0: 7465 725f 7374 6174 7573 5f6e 6f5f 6c6f  ter_status_no_lo
+00015ff0: 636b 2863 6c75 7374 6572 5f6e 616d 6529  ck(cluster_name)
+00016000: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+00016010: 2020 2077 6974 6820 6669 6c65 6c6f 636b     with filelock
+00016020: 2e46 696c 654c 6f63 6b28 434c 5553 5445  .FileLock(CLUSTE
+00016030: 525f 5354 4154 5553 5f4c 4f43 4b5f 5041  R_STATUS_LOCK_PA
+00016040: 5448 2e66 6f72 6d61 7428 636c 7573 7465  TH.format(cluste
+00016050: 725f 6e61 6d65 292c 0a20 2020 2020 2020  r_name),.       
+00016060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016070: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00016080: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00016090: 6f63 6b5f 7469 6d65 6f75 7429 3a0a 2020  ock_timeout):.  
+000160a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000160b0: 205f 7570 6461 7465 5f63 6c75 7374 6572   _update_cluster
+000160c0: 5f73 7461 7475 735f 6e6f 5f6c 6f63 6b28  _status_no_lock(
+000160d0: 636c 7573 7465 725f 6e61 6d65 290a 2020  cluster_name).  
+000160e0: 2020 6578 6365 7074 2066 696c 656c 6f63    except fileloc
+000160f0: 6b2e 5469 6d65 6f75 743a 0a20 2020 2020  k.Timeout:.     
+00016100: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00016110: 2752 6566 7265 7368 696e 6720 7374 6174  'Refreshing stat
+00016120: 7573 3a20 4661 696c 6564 2067 6574 2074  us: Failed get t
+00016130: 6865 206c 6f63 6b20 666f 7220 636c 7573  he lock for clus
+00016140: 7465 7220 270a 2020 2020 2020 2020 2020  ter '.          
+00016150: 2020 2020 2020 2020 2020 2066 277b 636c             f'{cl
+00016160: 7573 7465 725f 6e61 6d65 2172 7d2e 2055  uster_name!r}. U
+00016170: 7369 6e67 2074 6865 2063 6163 6865 6420  sing the cached 
+00016180: 7374 6174 7573 2e27 290a 2020 2020 2020  status.').      
+00016190: 2020 7265 636f 7264 203d 2067 6c6f 6261    record = globa
+000161a0: 6c5f 7573 6572 5f73 7461 7465 2e67 6574  l_user_state.get
+000161b0: 5f63 6c75 7374 6572 5f66 726f 6d5f 6e61  _cluster_from_na
+000161c0: 6d65 2863 6c75 7374 6572 5f6e 616d 6529  me(cluster_name)
+000161d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000161e0: 7265 636f 7264 0a0a 0a64 6566 2072 6566  record...def ref
+000161f0: 7265 7368 5f63 6c75 7374 6572 5f72 6563  resh_cluster_rec
+00016200: 6f72 6428 0a20 2020 2063 6c75 7374 6572  ord(.    cluster
+00016210: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
+00016220: 2a2c 0a20 2020 2066 6f72 6365 5f72 6566  *,.    force_ref
+00016230: 7265 7368 5f73 7461 7475 7365 733a 204f  resh_statuses: O
+00016240: 7074 696f 6e61 6c5b 5365 745b 7374 6174  ptional[Set[stat
+00016250: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00016260: 6174 7573 5d5d 203d 204e 6f6e 652c 0a20  atus]] = None,. 
+00016270: 2020 2061 6371 7569 7265 5f70 6572 5f63     acquire_per_c
+00016280: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
+00016290: 636b 3a20 626f 6f6c 203d 2054 7275 652c  ck: bool = True,
+000162a0: 0a20 2020 2063 6c75 7374 6572 5f73 7461  .    cluster_sta
+000162b0: 7475 735f 6c6f 636b 5f74 696d 656f 7574  tus_lock_timeout
+000162c0: 3a20 696e 7420 3d20 434c 5553 5445 525f  : int = CLUSTER_
+000162d0: 5354 4154 5553 5f4c 4f43 4b5f 5449 4d45  STATUS_LOCK_TIME
+000162e0: 4f55 545f 5345 434f 4e44 530a 2920 2d3e  OUT_SECONDS.) ->
+000162f0: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
+00016300: 7472 2c20 416e 795d 5d3a 0a20 2020 2022  tr, Any]]:.    "
+00016310: 2222 5265 6672 6573 6820 7468 6520 636c  ""Refresh the cl
+00016320: 7573 7465 722c 2061 6e64 2072 6574 7572  uster, and retur
+00016330: 6e20 7468 6520 706f 7373 6962 6c79 2075  n the possibly u
+00016340: 7064 6174 6564 2072 6563 6f72 642e 0a0a  pdated record...
+00016350: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+00016360: 6e20 7769 6c6c 2061 6c73 6f20 6368 6563  n will also chec
+00016370: 6b20 7468 6520 6f77 6e65 7220 6964 656e  k the owner iden
+00016380: 7469 7479 206f 6620 7468 6520 636c 7573  tity of the clus
+00016390: 7465 722c 2061 6e64 2072 6169 7365 0a20  ter, and raise. 
+000163a0: 2020 2065 7863 6570 7469 6f6e 7320 6966     exceptions if
+000163b0: 2074 6865 2063 7572 7265 6e74 2075 7365   the current use
+000163c0: 7220 6973 206e 6f74 2074 6865 2073 616d  r is not the sam
+000163d0: 6520 6173 2074 6865 2075 7365 7220 7768  e as the user wh
+000163e0: 6f20 6372 6561 7465 6420 7468 650a 2020  o created the.  
+000163f0: 2020 636c 7573 7465 722e 0a0a 2020 2020    cluster...    
+00016400: 4172 6773 3a0a 2020 2020 2020 2020 636c  Args:.        cl
+00016410: 7573 7465 725f 6e61 6d65 3a20 5468 6520  uster_name: The 
+00016420: 6e61 6d65 206f 6620 7468 6520 636c 7573  name of the clus
+00016430: 7465 722e 0a20 2020 2020 2020 2066 6f72  ter..        for
+00016440: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+00016450: 7365 733a 2069 6620 7370 6563 6966 6965  ses: if specifie
+00016460: 642c 2072 6566 7265 7368 2074 6865 2063  d, refresh the c
+00016470: 6c75 7374 6572 2069 6620 6974 2068 6173  luster if it has
+00016480: 206f 6e65 206f 660a 2020 2020 2020 2020   one of.        
+00016490: 2020 7468 6520 7370 6563 6966 6965 6420    the specified 
+000164a0: 7374 6174 7573 6573 2e20 4164 6469 7469  statuses. Additi
+000164b0: 6f6e 616c 6c79 2c20 636c 7573 7465 7273  onally, clusters
+000164c0: 2073 6174 6973 6679 696e 6720 7468 650a   satisfying the.
+000164d0: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
+000164e0: 696e 6720 636f 6e64 6974 696f 6e73 2077  ing conditions w
+000164f0: 696c 6c20 616c 7761 7973 2062 6520 7265  ill always be re
+00016500: 6672 6573 6865 6420 6e6f 206d 6174 7465  freshed no matte
+00016510: 7220 7468 650a 2020 2020 2020 2020 2020  r the.          
+00016520: 6172 6775 6d65 6e74 2069 7320 7370 6563  argument is spec
+00016530: 6966 6965 6420 6f72 206e 6f74 3a0a 2020  ified or not:.  
+00016540: 2020 2020 2020 2020 2020 312e 2069 7320            1. is 
+00016550: 6120 7370 6f74 2063 6c75 7374 6572 2c20  a spot cluster, 
+00016560: 6f72 0a20 2020 2020 2020 2020 2020 2032  or.            2
+00016570: 2e20 6973 2061 206e 6f6e 2d73 706f 7420  . is a non-spot 
+00016580: 636c 7573 7465 722c 2069 7320 6e6f 7420  cluster, is not 
+00016590: 5354 4f50 5045 442c 2061 6e64 2061 7574  STOPPED, and aut
+000165a0: 6f73 746f 7020 6973 2073 6574 2e0a 2020  ostop is set..  
+000165b0: 2020 2020 2020 6163 7175 6972 655f 7065        acquire_pe
+000165c0: 725f 636c 7573 7465 725f 7374 6174 7573  r_cluster_status
+000165d0: 5f6c 6f63 6b3a 2057 6865 7468 6572 2074  _lock: Whether t
+000165e0: 6f20 6163 7175 6972 6520 7468 6520 7065  o acquire the pe
+000165f0: 722d 636c 7573 7465 7220 6c6f 636b 0a20  r-cluster lock. 
+00016600: 2020 2020 2020 2020 2062 6566 6f72 6520           before 
+00016610: 7570 6461 7469 6e67 2074 6865 2073 7461  updating the sta
+00016620: 7475 732e 0a20 2020 2020 2020 2063 6c75  tus..        clu
+00016630: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00016640: 5f74 696d 656f 7574 3a20 5468 6520 7469  _timeout: The ti
+00016650: 6d65 6f75 7420 746f 2061 6371 7569 7265  meout to acquire
+00016660: 2074 6865 2070 6572 2d63 6c75 7374 6572   the per-cluster
+00016670: 0a20 2020 2020 2020 2020 206c 6f63 6b2e  .          lock.
+00016680: 2049 6620 7469 6d65 6f75 742c 2074 6865   If timeout, the
+00016690: 2066 756e 6374 696f 6e20 7769 6c6c 2075   function will u
+000166a0: 7365 2074 6865 2063 6163 6865 6420 7374  se the cached st
+000166b0: 6174 7573 2e0a 0a20 2020 2052 6574 7572  atus...    Retur
+000166c0: 6e73 3a0a 2020 2020 2020 2020 4966 2074  ns:.        If t
+000166d0: 6865 2063 6c75 7374 6572 2069 7320 7465  he cluster is te
+000166e0: 726d 696e 6174 6564 206f 7220 646f 6573  rminated or does
+000166f0: 206e 6f74 2065 7869 7374 2c20 7265 7475   not exist, retu
+00016700: 726e 204e 6f6e 652e 0a20 2020 2020 2020  rn None..       
+00016710: 204f 7468 6572 7769 7365 2072 6574 7572   Otherwise retur
+00016720: 6e73 2074 6865 2063 6c75 7374 6572 2072  ns the cluster r
+00016730: 6563 6f72 642e 0a0a 2020 2020 5261 6973  ecord...    Rais
+00016740: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
+00016750: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
+00016760: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
+00016770: 7463 6845 7272 6f72 3a20 6966 2074 6865  tchError: if the
+00016780: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
+00016790: 0a20 2020 2020 2020 2020 206e 6f74 2074  .          not t
+000167a0: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
+000167b0: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
+000167c0: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
+000167d0: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+000167e0: 436c 6f75 6455 7365 7249 6465 6e74 6974  CloudUserIdentit
+000167f0: 7945 7272 6f72 3a20 6966 2077 6520 6661  yError: if we fa
+00016800: 696c 2074 6f20 6765 7420 7468 6520 6375  il to get the cu
+00016810: 7272 656e 7420 7573 6572 0a20 2020 2020  rrent user.     
+00016820: 2020 2020 2069 6465 6e74 6974 792e 0a20       identity.. 
+00016830: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00016840: 732e 436c 7573 7465 7253 7461 7475 7346  s.ClusterStatusF
+00016850: 6574 6368 696e 6745 7272 6f72 3a20 7468  etchingError: th
+00016860: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+00016870: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
+00016880: 2020 2020 2066 6574 6368 6564 2066 726f       fetched fro
+00016890: 6d20 7468 6520 636c 6f75 6420 7072 6f76  m the cloud prov
+000168a0: 6964 6572 206f 7220 7468 6572 6520 6172  ider or there ar
+000168b0: 6520 6c65 616b 6564 206e 6f64 6573 2063  e leaked nodes c
+000168c0: 6175 7369 6e67 0a20 2020 2020 2020 2020  ausing.         
+000168d0: 2074 6865 206e 6f64 6520 6e75 6d62 6572   the node number
+000168e0: 206c 6172 6765 7220 7468 616e 2065 7870   larger than exp
+000168f0: 6563 7465 642e 0a20 2020 2022 2222 0a0a  ected..    """..
+00016900: 2020 2020 7265 636f 7264 203d 2067 6c6f      record = glo
+00016910: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+00016920: 6574 5f63 6c75 7374 6572 5f66 726f 6d5f  et_cluster_from_
+00016930: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00016940: 6529 0a20 2020 2069 6620 7265 636f 7264  e).    if record
+00016950: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00016960: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+00016970: 2020 6368 6563 6b5f 6f77 6e65 725f 6964    check_owner_id
+00016980: 656e 7469 7479 2863 6c75 7374 6572 5f6e  entity(cluster_n
+00016990: 616d 6529 0a0a 2020 2020 6861 6e64 6c65  ame)..    handle
+000169a0: 203d 2072 6563 6f72 645b 2768 616e 646c   = record['handl
+000169b0: 6527 5d0a 2020 2020 6966 2069 7369 6e73  e'].    if isins
+000169c0: 7461 6e63 6528 6861 6e64 6c65 2c20 6261  tance(handle, ba
+000169d0: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
+000169e0: 7952 6573 6f75 7263 6548 616e 646c 6529  yResourceHandle)
+000169f0: 3a0a 2020 2020 2020 2020 7573 655f 7370  :.        use_sp
+00016a00: 6f74 203d 2068 616e 646c 652e 6c61 756e  ot = handle.laun
+00016a10: 6368 6564 5f72 6573 6f75 7263 6573 2e75  ched_resources.u
+00016a20: 7365 5f73 706f 740a 2020 2020 2020 2020  se_spot.        
+00016a30: 6861 735f 6175 746f 7374 6f70 203d 2028  has_autostop = (
+00016a40: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
+00016a50: 2021 3d20 7374 6174 7573 5f6c 6962 2e43   != status_lib.C
+00016a60: 6c75 7374 6572 5374 6174 7573 2e53 544f  lusterStatus.STO
+00016a70: 5050 4544 2061 6e64 0a20 2020 2020 2020  PPED and.       
+00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a90: 2072 6563 6f72 645b 2761 7574 6f73 746f   record['autosto
+00016aa0: 7027 5d20 3e3d 2030 290a 2020 2020 2020  p'] >= 0).      
+00016ab0: 2020 666f 7263 655f 7265 6672 6573 685f    force_refresh_
+00016ac0: 666f 725f 636c 7573 7465 7220 3d20 2866  for_cluster = (f
+00016ad0: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
+00016ae0: 7475 7365 7320 6973 206e 6f74 204e 6f6e  tuses is not Non
+00016af0: 6520 616e 640a 2020 2020 2020 2020 2020  e and.          
+00016b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b10: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
+00016b20: 645b 2773 7461 7475 7327 5d20 696e 2066  d['status'] in f
+00016b30: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
+00016b40: 7475 7365 7329 0a20 2020 2020 2020 2069  tuses).        i
+00016b50: 6620 666f 7263 655f 7265 6672 6573 685f  f force_refresh_
+00016b60: 666f 725f 636c 7573 7465 7220 6f72 2068  for_cluster or h
+00016b70: 6173 5f61 7574 6f73 746f 7020 6f72 2075  as_autostop or u
+00016b80: 7365 5f73 706f 743a 0a20 2020 2020 2020  se_spot:.       
+00016b90: 2020 2020 2072 6563 6f72 6420 3d20 5f75       record = _u
+00016ba0: 7064 6174 655f 636c 7573 7465 725f 7374  pdate_cluster_st
+00016bb0: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+00016bc0: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+00016bd0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00016be0: 2020 2020 6163 7175 6972 655f 7065 725f      acquire_per_
+00016bf0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00016c00: 6f63 6b3d 6163 7175 6972 655f 7065 725f  ock=acquire_per_
+00016c10: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00016c20: 6f63 6b2c 0a20 2020 2020 2020 2020 2020  ock,.           
+00016c30: 2020 2020 2063 6c75 7374 6572 5f73 7461       cluster_sta
+00016c40: 7475 735f 6c6f 636b 5f74 696d 656f 7574  tus_lock_timeout
+00016c50: 3d63 6c75 7374 6572 5f73 7461 7475 735f  =cluster_status_
+00016c60: 6c6f 636b 5f74 696d 656f 7574 290a 2020  lock_timeout).  
+00016c70: 2020 7265 7475 726e 2072 6563 6f72 640a    return record.
+00016c80: 0a0a 4074 696d 656c 696e 652e 6576 656e  ..@timeline.even
+00016c90: 740a 6465 6620 7265 6672 6573 685f 636c  t.def refresh_cl
+00016ca0: 7573 7465 725f 7374 6174 7573 5f68 616e  uster_status_han
+00016cb0: 646c 6528 0a20 2020 2063 6c75 7374 6572  dle(.    cluster
+00016cc0: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
+00016cd0: 2a2c 0a20 2020 2066 6f72 6365 5f72 6566  *,.    force_ref
+00016ce0: 7265 7368 5f73 7461 7475 7365 733a 204f  resh_statuses: O
+00016cf0: 7074 696f 6e61 6c5b 5365 745b 7374 6174  ptional[Set[stat
+00016d00: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00016d10: 6174 7573 5d5d 203d 204e 6f6e 652c 0a20  atus]] = None,. 
+00016d20: 2020 2061 6371 7569 7265 5f70 6572 5f63     acquire_per_c
+00016d30: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
+00016d40: 636b 3a20 626f 6f6c 203d 2054 7275 652c  ck: bool = True,
+00016d50: 0a20 2020 2063 6c75 7374 6572 5f73 7461  .    cluster_sta
+00016d60: 7475 735f 6c6f 636b 5f74 696d 656f 7574  tus_lock_timeout
+00016d70: 3a20 696e 7420 3d20 434c 5553 5445 525f  : int = CLUSTER_
+00016d80: 5354 4154 5553 5f4c 4f43 4b5f 5449 4d45  STATUS_LOCK_TIME
+00016d90: 4f55 545f 5345 434f 4e44 530a 2920 2d3e  OUT_SECONDS.) ->
+00016da0: 2054 7570 6c65 5b4f 7074 696f 6e61 6c5b   Tuple[Optional[
+00016db0: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
+00016dc0: 6572 5374 6174 7573 5d2c 0a20 2020 2020  erStatus],.     
+00016dd0: 2020 2020 2020 4f70 7469 6f6e 616c 5b62        Optional[b
+00016de0: 6163 6b65 6e64 732e 5265 736f 7572 6365  ackends.Resource
+00016df0: 4861 6e64 6c65 5d5d 3a0a 2020 2020 2222  Handle]]:.    ""
+00016e00: 2252 6566 7265 7368 2074 6865 2063 6c75  "Refresh the clu
+00016e10: 7374 6572 2c20 616e 6420 7265 7475 726e  ster, and return
+00016e20: 2074 6865 2070 6f73 7369 626c 7920 7570   the possibly up
+00016e30: 6461 7465 6420 7374 6174 7573 2061 6e64  dated status and
+00016e40: 2068 616e 646c 652e 0a0a 2020 2020 5468   handle...    Th
+00016e50: 6973 2069 7320 6120 7772 6170 7065 7220  is is a wrapper 
+00016e60: 6f66 2072 6566 7265 7368 5f63 6c75 7374  of refresh_clust
+00016e70: 6572 5f72 6563 6f72 642c 2077 6869 6368  er_record, which
+00016e80: 2072 6574 7572 6e73 2074 6865 2073 7461   returns the sta
+00016e90: 7475 7320 616e 640a 2020 2020 6861 6e64  tus and.    hand
+00016ea0: 6c65 206f 6620 7468 6520 636c 7573 7465  le of the cluste
+00016eb0: 722e 0a20 2020 2050 6c65 6173 6520 7265  r..    Please re
+00016ec0: 6665 7220 746f 2074 6865 2064 6f63 7374  fer to the docst
+00016ed0: 7269 6e67 206f 6620 7265 6672 6573 685f  ring of refresh_
+00016ee0: 636c 7573 7465 725f 7265 636f 7264 2066  cluster_record f
+00016ef0: 6f72 2074 6865 2064 6574 6169 6c73 2e0a  or the details..
+00016f00: 2020 2020 2222 220a 2020 2020 7265 636f      """.    reco
+00016f10: 7264 203d 2072 6566 7265 7368 5f63 6c75  rd = refresh_clu
+00016f20: 7374 6572 5f72 6563 6f72 6428 0a20 2020  ster_record(.   
+00016f30: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+00016f40: 652c 0a20 2020 2020 2020 2066 6f72 6365  e,.        force
+00016f50: 5f72 6566 7265 7368 5f73 7461 7475 7365  _refresh_statuse
+00016f60: 733d 666f 7263 655f 7265 6672 6573 685f  s=force_refresh_
+00016f70: 7374 6174 7573 6573 2c0a 2020 2020 2020  statuses,.      
+00016f80: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
+00016f90: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00016fa0: 6b3d 6163 7175 6972 655f 7065 725f 636c  k=acquire_per_cl
+00016fb0: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00016fc0: 6b2c 0a20 2020 2020 2020 2063 6c75 7374  k,.        clust
+00016fd0: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016fe0: 696d 656f 7574 3d63 6c75 7374 6572 5f73  imeout=cluster_s
+00016ff0: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
+00017000: 7574 290a 2020 2020 6966 2072 6563 6f72  ut).    if recor
+00017010: 6420 6973 204e 6f6e 653a 0a20 2020 2020  d is None:.     
+00017020: 2020 2072 6574 7572 6e20 4e6f 6e65 2c20     return None, 
+00017030: 4e6f 6e65 0a20 2020 2072 6574 7572 6e20  None.    return 
+00017040: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
+00017050: 2c20 7265 636f 7264 5b27 6861 6e64 6c65  , record['handle
+00017060: 275d 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d  ']...# =========
+00017070: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00017080: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 0a40  ============...@
+00017090: 7479 7069 6e67 2e6f 7665 726c 6f61 640a  typing.overload.
+000170a0: 6465 6620 6368 6563 6b5f 636c 7573 7465  def check_cluste
+000170b0: 725f 6176 6169 6c61 626c 6528 0a20 2020  r_available(.   
+000170c0: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
+000170d0: 7472 2c0a 2020 2020 2a2c 0a20 2020 206f  tr,.    *,.    o
+000170e0: 7065 7261 7469 6f6e 3a20 7374 722c 0a20  peration: str,. 
+000170f0: 2020 2063 6865 636b 5f63 6c6f 7564 5f76     check_cloud_v
+00017100: 6d5f 7261 795f 6261 636b 656e 643a 204c  m_ray_backend: L
+00017110: 6974 6572 616c 5b54 7275 655d 203d 2054  iteral[True] = T
+00017120: 7275 652c 0a20 2020 2064 7279 7275 6e3a  rue,.    dryrun:
+00017130: 2062 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d   bool = ...,.) -
+00017140: 3e20 2763 6c6f 7564 5f76 6d5f 7261 795f  > 'cloud_vm_ray_
+00017150: 6261 636b 656e 642e 436c 6f75 6456 6d52  backend.CloudVmR
+00017160: 6179 5265 736f 7572 6365 4861 6e64 6c65  ayResourceHandle
+00017170: 273a 0a20 2020 202e 2e2e 0a0a 0a40 7479  ':.    ......@ty
+00017180: 7069 6e67 2e6f 7665 726c 6f61 640a 6465  ping.overload.de
+00017190: 6620 6368 6563 6b5f 636c 7573 7465 725f  f check_cluster_
+000171a0: 6176 6169 6c61 626c 6528 0a20 2020 2063  available(.    c
+000171b0: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+000171c0: 2c0a 2020 2020 2a2c 0a20 2020 206f 7065  ,.    *,.    ope
+000171d0: 7261 7469 6f6e 3a20 7374 722c 0a20 2020  ration: str,.   
+000171e0: 2063 6865 636b 5f63 6c6f 7564 5f76 6d5f   check_cloud_vm_
+000171f0: 7261 795f 6261 636b 656e 643a 204c 6974  ray_backend: Lit
+00017200: 6572 616c 5b46 616c 7365 5d2c 0a20 2020  eral[False],.   
+00017210: 2064 7279 7275 6e3a 2062 6f6f 6c20 3d20   dryrun: bool = 
+00017220: 2e2e 2e2c 0a29 202d 3e20 6261 636b 656e  ...,.) -> backen
+00017230: 6473 2e52 6573 6f75 7263 6548 616e 646c  ds.ResourceHandl
+00017240: 653a 0a20 2020 202e 2e2e 0a0a 0a64 6566  e:.    ......def
+00017250: 2063 6865 636b 5f63 6c75 7374 6572 5f61   check_cluster_a
+00017260: 7661 696c 6162 6c65 280a 2020 2020 636c  vailable(.    cl
+00017270: 7573 7465 725f 6e61 6d65 3a20 7374 722c  uster_name: str,
+00017280: 0a20 2020 202a 2c0a 2020 2020 6f70 6572  .    *,.    oper
+00017290: 6174 696f 6e3a 2073 7472 2c0a 2020 2020  ation: str,.    
+000172a0: 6368 6563 6b5f 636c 6f75 645f 766d 5f72  check_cloud_vm_r
+000172b0: 6179 5f62 6163 6b65 6e64 3a20 626f 6f6c  ay_backend: bool
+000172c0: 203d 2054 7275 652c 0a20 2020 2064 7279   = True,.    dry
+000172d0: 7275 6e3a 2062 6f6f 6c20 3d20 4661 6c73  run: bool = Fals
+000172e0: 652c 0a29 202d 3e20 6261 636b 656e 6473  e,.) -> backends
+000172f0: 2e52 6573 6f75 7263 6548 616e 646c 653a  .ResourceHandle:
+00017300: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
+00017310: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00017320: 6176 6169 6c61 626c 652e 0a0a 2020 2020  available...    
+00017330: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+00017340: 5661 6c75 6545 7272 6f72 3a20 6966 2074  ValueError: if t
+00017350: 6865 2063 6c75 7374 6572 2064 6f65 7320  he cluster does 
+00017360: 6e6f 7420 6578 6973 742e 0a20 2020 2020  not exist..     
+00017370: 2020 2065 7863 6570 7469 6f6e 732e 436c     exceptions.Cl
+00017380: 7573 7465 724e 6f74 5570 4572 726f 723a  usterNotUpError:
+00017390: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
+000173a0: 6973 206e 6f74 2055 502e 0a20 2020 2020  is not UP..     
+000173b0: 2020 2065 7863 6570 7469 6f6e 732e 4e6f     exceptions.No
+000173c0: 7453 7570 706f 7274 6564 4572 726f 723a  tSupportedError:
+000173d0: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
+000173e0: 6973 206e 6f74 2062 6173 6564 206f 6e0a  is not based on.
+000173f0: 2020 2020 2020 2020 2020 436c 6f75 6456            CloudV
+00017400: 6d52 6179 4261 636b 656e 642e 0a20 2020  mRayBackend..   
+00017410: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00017420: 436c 7573 7465 724f 776e 6572 4964 656e  ClusterOwnerIden
+00017430: 7469 7479 4d69 736d 6174 6368 4572 726f  tityMismatchErro
+00017440: 723a 2069 6620 7468 6520 6375 7272 656e  r: if the curren
+00017450: 7420 7573 6572 2069 730a 2020 2020 2020  t user is.      
+00017460: 2020 2020 6e6f 7420 7468 6520 7361 6d65      not the same
+00017470: 2061 7320 7468 6520 7573 6572 2077 686f   as the user who
+00017480: 2063 7265 6174 6564 2074 6865 2063 6c75   created the clu
+00017490: 7374 6572 2e0a 2020 2020 2020 2020 6578  ster..        ex
+000174a0: 6365 7074 696f 6e73 2e43 6c6f 7564 5573  ceptions.CloudUs
+000174b0: 6572 4964 656e 7469 7479 4572 726f 723a  erIdentityError:
+000174c0: 2069 6620 7765 2066 6169 6c20 746f 2067   if we fail to g
+000174d0: 6574 2074 6865 2063 7572 7265 6e74 2075  et the current u
+000174e0: 7365 720a 2020 2020 2020 2020 2020 6964  ser.          id
+000174f0: 656e 7469 7479 2e0a 2020 2020 2222 220a  entity..    """.
+00017500: 2020 2020 7265 636f 7264 203d 2067 6c6f      record = glo
+00017510: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+00017520: 6574 5f63 6c75 7374 6572 5f66 726f 6d5f  et_cluster_from_
+00017530: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00017540: 6529 0a20 2020 2069 6620 6472 7972 756e  e).    if dryrun
+00017550: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00017560: 2072 6563 6f72 6420 6973 206e 6f74 204e   record is not N
+00017570: 6f6e 652c 2063 6c75 7374 6572 5f6e 616d  one, cluster_nam
+00017580: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
+00017590: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
+000175a0: 5d0a 0a20 2020 2070 7265 7669 6f75 735f  ]..    previous_
+000175b0: 636c 7573 7465 725f 7374 6174 7573 203d  cluster_status =
+000175c0: 204e 6f6e 650a 2020 2020 6966 2072 6563   None.    if rec
+000175d0: 6f72 6420 6973 206e 6f74 204e 6f6e 653a  ord is not None:
+000175e0: 0a20 2020 2020 2020 2070 7265 7669 6f75  .        previou
+000175f0: 735f 636c 7573 7465 725f 7374 6174 7573  s_cluster_status
+00017600: 203d 2072 6563 6f72 645b 2773 7461 7475   = record['statu
+00017610: 7327 5d0a 0a20 2020 2074 7279 3a0a 2020  s']..    try:.  
+00017620: 2020 2020 2020 636c 7573 7465 725f 7374        cluster_st
+00017630: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
+00017640: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
+00017650: 7461 7475 735f 6861 6e64 6c65 2863 6c75  tatus_handle(clu
+00017660: 7374 6572 5f6e 616d 6529 0a20 2020 2065  ster_name).    e
+00017670: 7863 6570 7420 6578 6365 7074 696f 6e73  xcept exceptions
+00017680: 2e43 6c75 7374 6572 5374 6174 7573 4665  .ClusterStatusFe
+00017690: 7463 6869 6e67 4572 726f 7220 6173 2065  tchingError as e
+000176a0: 3a0a 2020 2020 2020 2020 2320 4661 696c  :.        # Fail
+000176b0: 6564 2074 6f20 7265 6672 6573 6820 7468  ed to refresh th
+000176c0: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+000176d0: 2069 7320 6e6f 7420 6661 7461 6c20 6572   is not fatal er
+000176e0: 726f 7220 6173 2074 6865 2063 616c 6c65  ror as the calle
+000176f0: 7273 0a20 2020 2020 2020 2023 2063 616e  rs.        # can
+00017700: 2073 7469 6c6c 2062 6520 646f 6e65 2062   still be done b
+00017710: 7920 6f6e 6c79 2075 7369 6e67 2073 7368  y only using ssh
+00017720: 2c20 6275 7420 7468 6520 7373 6820 6361  , but the ssh ca
+00017730: 6e20 6861 6e67 2069 6620 7468 650a 2020  n hang if the.  
+00017740: 2020 2020 2020 2320 636c 7573 7465 7220        # cluster 
+00017750: 6973 206e 6f74 2075 7020 2865 2e67 2e2c  is not up (e.g.,
+00017760: 2061 7574 6f73 746f 7070 6564 292e 0a0a   autostopped)...
+00017770: 2020 2020 2020 2020 2320 5765 2064 6f20          # We do 
+00017780: 6e6f 7420 6361 7463 6820 7468 6520 6578  not catch the ex
+00017790: 6365 7074 696f 6e20 666f 7220 636c 6f75  ception for clou
+000177a0: 6420 6964 656e 7469 7479 2063 6865 636b  d identity check
+000177b0: 696e 6720 666f 7220 6e6f 772c 2069 6e0a  ing for now, in.
+000177c0: 2020 2020 2020 2020 2320 6f72 6465 7220          # order 
+000177d0: 746f 2064 6973 6162 6c65 2061 6c6c 206f  to disable all o
+000177e0: 7065 7261 7469 6f6e 7320 6f6e 2063 6c75  perations on clu
+000177f0: 7374 6572 7320 6372 6561 7465 6420 6279  sters created by
+00017800: 2061 6e6f 7468 6572 2075 7365 720a 2020   another user.  
+00017810: 2020 2020 2020 2320 6964 656e 7469 7479        # identity
+00017820: 2e20 2054 6861 7420 7769 6c6c 206d 616b  .  That will mak
+00017830: 6520 7468 6520 6465 7369 676e 2073 696d  e the design sim
+00017840: 706c 6572 2061 6e64 2065 6173 6965 7220  pler and easier 
+00017850: 746f 0a20 2020 2020 2020 2023 2075 6e64  to.        # und
+00017860: 6572 7374 616e 642c 2062 7574 2069 7420  erstand, but it 
+00017870: 6d69 6768 7420 6265 2075 7365 6675 6c20  might be useful 
+00017880: 746f 2061 6c6c 6f77 2074 6865 2075 7365  to allow the use
+00017890: 7220 746f 2075 7365 0a20 2020 2020 2020  r to use.       
+000178a0: 2023 206f 7065 7261 7469 6f6e 7320 7468   # operations th
+000178b0: 6174 206f 6e6c 7920 696e 766f 6c76 6520  at only involve 
+000178c0: 7373 6820 2865 2e67 2e2c 2073 6b79 2065  ssh (e.g., sky e
+000178d0: 7865 632c 2073 6b79 206c 6f67 732c 2065  xec, sky logs, e
+000178e0: 7463 2920 6576 656e 0a20 2020 2020 2020  tc) even.       
+000178f0: 2023 2069 6620 7468 6520 7573 6572 2069   # if the user i
+00017900: 7320 6e6f 7420 7468 6520 6f77 6e65 7220  s not the owner 
+00017910: 6f66 2074 6865 2063 6c75 7374 6572 2e0a  of the cluster..
+00017920: 2020 2020 2020 2020 7578 5f75 7469 6c73          ux_utils
+00017930: 2e63 6f6e 736f 6c65 5f6e 6577 6c69 6e65  .console_newline
+00017940: 2829 0a20 2020 2020 2020 206c 6f67 6765  ().        logge
+00017950: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00017960: 2020 2020 2020 2066 2746 6169 6c65 6420         f'Failed 
+00017970: 746f 2072 6566 7265 7368 2074 6865 2073  to refresh the s
+00017980: 7461 7475 7320 666f 7220 636c 7573 7465  tatus for cluste
+00017990: 7220 7b63 6c75 7374 6572 5f6e 616d 6521  r {cluster_name!
+000179a0: 727d 2e20 4974 2069 7320 270a 2020 2020  r}. It is '.    
+000179b0: 2020 2020 2020 2020 6627 6e6f 7420 6661          f'not fa
+000179c0: 7461 6c2c 2062 7574 207b 6f70 6572 6174  tal, but {operat
+000179d0: 696f 6e7d 206d 6967 6874 2068 616e 6720  ion} might hang 
+000179e0: 6966 2074 6865 2063 6c75 7374 6572 2069  if the cluster i
+000179f0: 7320 6e6f 7420 7570 2e5c 6e27 0a20 2020  s not up.\n'.   
+00017a00: 2020 2020 2020 2020 2066 2744 6574 6169           f'Detai
+00017a10: 6c65 6420 7265 6173 6f6e 3a20 7b65 7d27  led reason: {e}'
+00017a20: 290a 2020 2020 2020 2020 6966 2072 6563  ).        if rec
+00017a30: 6f72 6420 6973 204e 6f6e 653a 0a20 2020  ord is None:.   
+00017a40: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
+00017a50: 5f73 7461 7475 732c 2068 616e 646c 6520  _status, handle 
+00017a60: 3d20 4e6f 6e65 2c20 4e6f 6e65 0a20 2020  = None, None.   
+00017a70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00017a80: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
+00017a90: 7461 7475 732c 2068 616e 646c 6520 3d20  tatus, handle = 
+00017aa0: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
+00017ab0: 2c20 7265 636f 7264 5b27 6861 6e64 6c65  , record['handle
+00017ac0: 275d 0a0a 2020 2020 6272 6967 6874 203d  ']..    bright =
+00017ad0: 2063 6f6c 6f72 616d 612e 5374 796c 652e   colorama.Style.
+00017ae0: 4252 4947 4854 0a20 2020 2072 6573 6574  BRIGHT.    reset
+00017af0: 203d 2063 6f6c 6f72 616d 612e 5374 796c   = colorama.Styl
+00017b00: 652e 5245 5345 545f 414c 4c0a 2020 2020  e.RESET_ALL.    
+00017b10: 6966 2068 616e 646c 6520 6973 204e 6f6e  if handle is Non
+00017b20: 653a 0a20 2020 2020 2020 2069 6620 7072  e:.        if pr
+00017b30: 6576 696f 7573 5f63 6c75 7374 6572 5f73  evious_cluster_s
+00017b40: 7461 7475 7320 6973 204e 6f6e 653a 0a20  tatus is None:. 
+00017b50: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+00017b60: 5f6d 7367 203d 2066 2743 6c75 7374 6572  _msg = f'Cluster
+00017b70: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
+00017b80: 7d20 646f 6573 206e 6f74 2065 7869 7374  } does not exist
+00017b90: 2e27 0a20 2020 2020 2020 2065 6c73 653a  .'.        else:
+00017ba0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+00017bb0: 6f72 5f6d 7367 203d 2028 6627 436c 7573  or_msg = (f'Clus
+00017bc0: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
+00017bd0: 6521 727d 206e 6f74 2066 6f75 6e64 206f  e!r} not found o
+00017be0: 6e20 7468 6520 636c 6f75 6420 270a 2020  n the cloud '.  
+00017bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c00: 2020 2020 2020 2027 7072 6f76 6964 6572         'provider
+00017c10: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+00017c20: 6173 7365 7274 2072 6563 6f72 6420 6973  assert record is
+00017c30: 206e 6f74 204e 6f6e 652c 2070 7265 7669   not None, previ
+00017c40: 6f75 735f 636c 7573 7465 725f 7374 6174  ous_cluster_stat
+00017c50: 7573 0a20 2020 2020 2020 2020 2020 2061  us.            a
+00017c60: 6374 696f 6e73 203d 205b 5d0a 2020 2020  ctions = [].    
+00017c70: 2020 2020 2020 2020 6966 2072 6563 6f72          if recor
+00017c80: 645b 2768 616e 646c 6527 5d2e 6c61 756e  d['handle'].laun
+00017c90: 6368 6564 5f72 6573 6f75 7263 6573 2e75  ched_resources.u
+00017ca0: 7365 5f73 706f 743a 0a20 2020 2020 2020  se_spot:.       
+00017cb0: 2020 2020 2020 2020 2061 6374 696f 6e73           actions
+00017cc0: 2e61 7070 656e 6428 2770 7265 656d 7074  .append('preempt
+00017cd0: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
+00017ce0: 2069 6620 7265 636f 7264 5b27 6175 746f   if record['auto
+00017cf0: 7374 6f70 275d 203e 2030 2061 6e64 2072  stop'] > 0 and r
+00017d00: 6563 6f72 645b 2774 6f5f 646f 776e 275d  ecord['to_down']
+00017d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017d20: 2020 6163 7469 6f6e 732e 6170 7065 6e64    actions.append
+00017d30: 2827 6175 746f 646f 776e 6564 2729 0a20  ('autodowned'). 
+00017d40: 2020 2020 2020 2020 2020 2061 6374 696f             actio
+00017d50: 6e73 2e61 7070 656e 6428 276d 616e 7561  ns.append('manua
+00017d60: 6c6c 7920 7465 726d 696e 6174 6564 2069  lly terminated i
+00017d70: 6e20 636f 6e73 6f6c 6527 290a 2020 2020  n console').    
+00017d80: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
+00017d90: 6374 696f 6e73 2920 3e20 313a 0a20 2020  ctions) > 1:.   
+00017da0: 2020 2020 2020 2020 2020 2020 2061 6374               act
+00017db0: 696f 6e73 5b2d 315d 203d 2027 6f72 2027  ions[-1] = 'or '
+00017dc0: 202b 2061 6374 696f 6e73 5b2d 315d 0a20   + actions[-1]. 
+00017dd0: 2020 2020 2020 2020 2020 2061 6374 696f             actio
+00017de0: 6e73 5f73 7472 203d 2027 2c20 272e 6a6f  ns_str = ', '.jo
+00017df0: 696e 2861 6374 696f 6e73 290a 2020 2020  in(actions).    
+00017e00: 2020 2020 2020 2020 6d65 7373 6167 6520          message 
+00017e10: 3d20 6627 2049 7420 7761 7320 6c69 6b65  = f' It was like
+00017e20: 6c79 207b 6163 7469 6f6e 735f 7374 727d  ly {actions_str}
+00017e30: 2e27 0a20 2020 2020 2020 2020 2020 2069  .'.            i
+00017e40: 6620 6c65 6e28 6163 7469 6f6e 7329 203e  f len(actions) >
+00017e50: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00017e60: 2020 2020 6d65 7373 6167 6520 3d20 6d65      message = me
+00017e70: 7373 6167 652e 7265 706c 6163 6528 276c  ssage.replace('l
+00017e80: 696b 656c 7927 2c20 2765 6974 6865 7227  ikely', 'either'
+00017e90: 290a 2020 2020 2020 2020 2020 2020 6572  ).            er
+00017ea0: 726f 725f 6d73 6720 2b3d 206d 6573 7361  ror_msg += messa
+00017eb0: 6765 0a0a 2020 2020 2020 2020 7769 7468  ge..        with
+00017ec0: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
+00017ed0: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
+00017ee0: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
+00017ef0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00017f00: 6545 7272 6f72 2866 277b 636f 6c6f 7261  eError(f'{colora
 00017f10: 6d61 2e46 6f72 652e 5945 4c4c 4f57 7d7b  ma.Fore.YELLOW}{
-00017f20: 6f70 6572 6174 696f 6e2e 6361 7069 7461  operation.capita
-00017f30: 6c69 7a65 2829 7d3a 2073 6b69 7070 6564  lize()}: skipped
-00017f40: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
-00017f50: 2020 2020 2020 2066 2763 6c75 7374 6572         f'cluster
-00017f60: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
-00017f70: 7d2e 2049 7420 6973 206f 6e6c 7920 7375  }. It is only su
-00017f80: 7070 6f72 7465 6420 6279 2062 6163 6b65  pported by backe
-00017f90: 6e64 3a20 270a 2020 2020 2020 2020 2020  nd: '.          
-00017fa0: 2020 2020 2020 6627 7b62 6163 6b65 6e64        f'{backend
-00017fb0: 732e 436c 6f75 6456 6d52 6179 4261 636b  s.CloudVmRayBack
-00017fc0: 656e 642e 4e41 4d45 7d2e 270a 2020 2020  end.NAME}.'.    
-00017fd0: 2020 2020 2020 2020 2020 2020 6627 7b72              f'{r
-00017fe0: 6573 6574 7d27 290a 2020 2020 6966 2063  eset}').    if c
-00017ff0: 6c75 7374 6572 5f73 7461 7475 7320 213d  luster_status !=
-00018000: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
-00018010: 7465 7253 7461 7475 732e 5550 3a0a 2020  terStatus.UP:.  
-00018020: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
-00018030: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
-00018040: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
-00018050: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00018060: 6869 6e74 5f66 6f72 5f69 6e69 7420 3d20  hint_for_init = 
-00018070: 2727 0a20 2020 2020 2020 2020 2020 2069  ''.            i
-00018080: 6620 636c 7573 7465 725f 7374 6174 7573  f cluster_status
-00018090: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
-000180a0: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
-000180b0: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-000180c0: 2020 2068 696e 745f 666f 725f 696e 6974     hint_for_init
-000180d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000180e0: 2020 2020 2020 2020 2066 277b 7265 7365           f'{rese
-000180f0: 747d 2057 6169 7420 666f 7220 6120 6c61  t} Wait for a la
-00018100: 756e 6368 2074 6f20 6669 6e69 7368 2c20  unch to finish, 
-00018110: 6f72 2075 7365 2074 6869 7320 636f 6d6d  or use this comm
-00018120: 616e 6420 270a 2020 2020 2020 2020 2020  and '.          
-00018130: 2020 2020 2020 2020 2020 6627 746f 2074            f'to t
-00018140: 7279 2074 6f20 7472 616e 7369 7469 6f6e  ry to transition
-00018150: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
-00018160: 5550 3a20 7b62 7269 6768 747d 736b 7920  UP: {bright}sky 
-00018170: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018180: 2020 2020 2020 6627 7374 6172 7420 7b63        f'start {c
-00018190: 6c75 7374 6572 5f6e 616d 657d 7b72 6573  luster_name}{res
-000181a0: 6574 7d27 290a 2020 2020 2020 2020 2020  et}').          
-000181b0: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-000181c0: 6e73 2e43 6c75 7374 6572 4e6f 7455 7045  ns.ClusterNotUpE
-000181d0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000181e0: 2020 2020 2020 6627 7b63 6f6c 6f72 616d        f'{coloram
-000181f0: 612e 466f 7265 2e59 454c 4c4f 577d 7b6f  a.Fore.YELLOW}{o
-00018200: 7065 7261 7469 6f6e 2e63 6170 6974 616c  peration.capital
-00018210: 697a 6528 297d 3a20 736b 6970 7065 6420  ize()}: skipped 
-00018220: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
-00018230: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
-00018240: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-00018250: 2028 7374 6174 7573 3a20 7b63 6c75 7374   (status: {clust
-00018260: 6572 5f73 7461 7475 732e 7661 6c75 657d  er_status.value}
-00018270: 292e 2027 0a20 2020 2020 2020 2020 2020  ). '.           
-00018280: 2020 2020 2027 4974 2069 7320 6f6e 6c79       'It is only
-00018290: 2061 6c6c 6f77 6564 2066 6f72 2027 0a20   allowed for '. 
-000182a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000182b0: 277b 7374 6174 7573 5f6c 6962 2e43 6c75  '{status_lib.Clu
-000182c0: 7374 6572 5374 6174 7573 2e55 502e 7661  sterStatus.UP.va
-000182d0: 6c75 657d 2063 6c75 7374 6572 732e 270a  lue} clusters.'.
-000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182f0: 6627 7b68 696e 745f 666f 725f 696e 6974  f'{hint_for_init
-00018300: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00018310: 2020 2066 277b 7265 7365 747d 272c 0a20     f'{reset}',. 
-00018320: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00018330: 6c75 7374 6572 5f73 7461 7475 733d 636c  luster_status=cl
-00018340: 7573 7465 725f 7374 6174 7573 2c0a 2020  uster_status,.  
-00018350: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00018360: 6e64 6c65 3d68 616e 646c 6529 0a0a 2020  ndle=handle)..  
-00018370: 2020 6966 2068 616e 646c 652e 6865 6164    if handle.head
-00018380: 5f69 7020 6973 204e 6f6e 653a 0a20 2020  _ip is None:.   
-00018390: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-000183a0: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-000183b0: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-000183c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000183d0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-000183e0: 436c 7573 7465 724e 6f74 5570 4572 726f  ClusterNotUpErro
-000183f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00018400: 2020 2066 2743 6c75 7374 6572 207b 636c     f'Cluster {cl
-00018410: 7573 7465 725f 6e61 6d65 2172 7d20 6861  uster_name!r} ha
-00018420: 7320 6265 656e 2073 746f 7070 6564 206f  s been stopped o
-00018430: 7220 6e6f 7420 7072 6f70 6572 6c79 2027  r not properly '
-00018440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018450: 2027 7365 7420 7570 2e20 506c 6561 7365   'set up. Please
-00018460: 2072 652d 6c61 756e 6368 2069 7420 7769   re-launch it wi
-00018470: 7468 2060 736b 7920 7374 6172 7460 2e27  th `sky start`.'
-00018480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018490: 2020 636c 7573 7465 725f 7374 6174 7573    cluster_status
-000184a0: 3d63 6c75 7374 6572 5f73 7461 7475 732c  =cluster_status,
-000184b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000184c0: 2068 616e 646c 653d 6861 6e64 6c65 290a   handle=handle).
-000184d0: 2020 2020 7265 7475 726e 2068 616e 646c      return handl
-000184e0: 650a 0a0a 2320 544f 444f 2874 6961 6e29  e...# TODO(tian)
-000184f0: 3a20 5265 6661 6374 6f72 2074 6f20 636f  : Refactor to co
-00018500: 6e74 726f 6c6c 6572 5f75 7469 6c73 2e20  ntroller_utils. 
-00018510: 4375 7272 656e 7420 626c 6f63 6b65 723a  Current blocker:
-00018520: 2063 6972 6375 6c61 7220 696d 706f 7274   circular import
-00018530: 2e0a 6465 6620 6973 5f63 6f6e 7472 6f6c  ..def is_control
-00018540: 6c65 725f 6163 6365 7373 6962 6c65 280a  ler_accessible(.
-00018550: 2020 2020 636f 6e74 726f 6c6c 6572 3a20      controller: 
-00018560: 636f 6e74 726f 6c6c 6572 5f75 7469 6c73  controller_utils
-00018570: 2e43 6f6e 7472 6f6c 6c65 7273 2c0a 2020  .Controllers,.  
-00018580: 2020 7374 6f70 7065 645f 6d65 7373 6167    stopped_messag
-00018590: 653a 2073 7472 2c0a 2020 2020 6e6f 6e5f  e: str,.    non_
-000185a0: 6578 6973 7465 6e74 5f6d 6573 7361 6765  existent_message
-000185b0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000185c0: 3d20 4e6f 6e65 2c0a 2020 2020 6578 6974  = None,.    exit
-000185d0: 5f69 665f 6e6f 745f 6163 6365 7373 6962  _if_not_accessib
-000185e0: 6c65 3a20 626f 6f6c 203d 2046 616c 7365  le: bool = False
-000185f0: 2c0a 2920 2d3e 2027 6261 636b 656e 6473  ,.) -> 'backends
-00018600: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
-00018610: 7263 6548 616e 646c 6527 3a0a 2020 2020  rceHandle':.    
-00018620: 2222 2243 6865 636b 2069 6620 7468 6520  """Check if the 
-00018630: 6a6f 6273 2f73 6572 7665 2063 6f6e 7472  jobs/serve contr
-00018640: 6f6c 6c65 7220 6973 2075 702e 0a0a 2020  oller is up...  
-00018650: 2020 5468 6520 636f 6e74 726f 6c6c 6572    The controller
-00018660: 2069 7320 6163 6365 7373 6962 6c65 2077   is accessible w
-00018670: 6865 6e20 6974 2069 7320 696e 2055 5020  hen it is in UP 
-00018680: 6f72 2049 4e49 5420 7374 6174 652c 2061  or INIT state, a
-00018690: 6e64 2074 6865 2073 7368 0a20 2020 2063  nd the ssh.    c
-000186a0: 6f6e 6e65 6374 696f 6e20 6973 2073 7563  onnection is suc
-000186b0: 6365 7373 6675 6c2e 0a0a 2020 2020 4974  cessful...    It
-000186c0: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-000186d0: 6368 6563 6b20 6966 2074 6865 2063 6f6e  check if the con
-000186e0: 7472 6f6c 6c65 7220 6973 2061 6363 6573  troller is acces
-000186f0: 7369 626c 6520 2873 696e 6365 2074 6865  sible (since the
-00018700: 2061 7574 6f73 746f 700a 2020 2020 6973   autostop.    is
-00018710: 2073 6574 2066 6f72 2074 6865 2063 6f6e   set for the con
-00018720: 7472 6f6c 6c65 7229 2062 6566 6f72 6520  troller) before 
-00018730: 7468 6520 6a6f 6273 2f73 6572 7665 2063  the jobs/serve c
-00018740: 6f6d 6d61 6e64 7320 696e 7465 7261 6374  ommands interact
-00018750: 2077 6974 6820 7468 650a 2020 2020 636f   with the.    co
-00018760: 6e74 726f 6c6c 6572 2e0a 0a20 2020 2043  ntroller...    C
-00018770: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
-00018780: 2077 696c 6c20 6265 2072 6169 7365 6420   will be raised 
-00018790: 7768 656e 6576 6572 2074 6865 2063 6f6e  whenever the con
-000187a0: 7472 6f6c 6c65 7220 6361 6e6e 6f74 2062  troller cannot b
-000187b0: 6520 6163 6365 7373 6564 2e0a 0a20 2020  e accessed...   
-000187c0: 2041 7267 733a 0a20 2020 2020 2020 2074   Args:.        t
-000187d0: 7970 653a 2054 7970 6520 6f66 2074 6865  ype: Type of the
-000187e0: 2063 6f6e 7472 6f6c 6c65 722e 0a20 2020   controller..   
-000187f0: 2020 2020 2073 746f 7070 6564 5f6d 6573       stopped_mes
-00018800: 7361 6765 3a20 4d65 7373 6167 6520 746f  sage: Message to
-00018810: 2070 7269 6e74 2069 6620 7468 6520 636f   print if the co
-00018820: 6e74 726f 6c6c 6572 2069 7320 5354 4f50  ntroller is STOP
-00018830: 5045 442e 0a20 2020 2020 2020 206e 6f6e  PED..        non
-00018840: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
-00018850: 653a 204d 6573 7361 6765 2074 6f20 7368  e: Message to sh
-00018860: 6f77 2069 6620 7468 6520 636f 6e74 726f  ow if the contro
-00018870: 6c6c 6572 2064 6f65 7320 6e6f 7420 6578  ller does not ex
-00018880: 6973 742e 0a20 2020 2020 2020 2065 7869  ist..        exi
-00018890: 745f 6966 5f6e 6f74 5f61 6363 6573 7369  t_if_not_accessi
-000188a0: 626c 653a 2057 6865 7468 6572 2074 6f20  ble: Whether to 
-000188b0: 6578 6974 2064 6972 6563 746c 7920 6966  exit directly if
-000188c0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-000188d0: 6973 206e 6f74 0a20 2020 2020 2020 2020  is not.         
-000188e0: 2061 6363 6573 7369 626c 652e 2049 6620   accessible. If 
-000188f0: 4661 6c73 652c 2074 6865 2066 756e 6374  False, the funct
-00018900: 696f 6e20 7769 6c6c 2072 6169 7365 2043  ion will raise C
-00018910: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
-00018920: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00018930: 2020 2020 2020 2020 6861 6e64 6c65 3a20          handle: 
-00018940: 5468 6520 5265 736f 7572 6365 4861 6e64  The ResourceHand
-00018950: 6c65 206f 6620 7468 6520 636f 6e74 726f  le of the contro
-00018960: 6c6c 6572 2e0a 0a20 2020 2052 6169 7365  ller...    Raise
-00018970: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
-00018980: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
-00018990: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
-000189a0: 6368 4572 726f 723a 2069 6620 7468 6520  chError: if the 
-000189b0: 6375 7272 656e 7420 7573 6572 2069 7320  current user is 
-000189c0: 6e6f 740a 2020 2020 2020 2020 2020 7468  not.          th
-000189d0: 6520 7361 6d65 2061 7320 7468 6520 7573  e same as the us
-000189e0: 6572 2077 686f 2063 7265 6174 6564 2074  er who created t
-000189f0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-00018a00: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-00018a10: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
-00018a20: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
-00018a30: 6c20 746f 2067 6574 2074 6865 2063 7572  l to get the cur
-00018a40: 7265 6e74 2075 7365 720a 2020 2020 2020  rent user.      
-00018a50: 2020 2020 6964 656e 7469 7479 2e0a 2020      identity..  
-00018a60: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00018a70: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
-00018a80: 6f72 3a20 6966 2074 6865 2063 6f6e 7472  or: if the contr
-00018a90: 6f6c 6c65 7220 6973 206e 6f74 2061 6363  oller is not acc
-00018aa0: 6573 7369 626c 652c 206f 720a 2020 2020  essible, or.    
-00018ab0: 2020 2020 2020 6661 696c 6564 2074 6f20        failed to 
-00018ac0: 6265 2063 6f6e 6e65 6374 6564 2e0a 2020  be connected..  
-00018ad0: 2020 2222 220a 2020 2020 6966 206e 6f6e    """.    if non
-00018ae0: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
-00018af0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-00018b00: 2020 206e 6f6e 5f65 7869 7374 656e 745f     non_existent_
-00018b10: 6d65 7373 6167 6520 3d20 636f 6e74 726f  message = contro
-00018b20: 6c6c 6572 2e76 616c 7565 2e64 6566 6175  ller.value.defau
-00018b30: 6c74 5f68 696e 745f 6966 5f6e 6f6e 5f65  lt_hint_if_non_e
-00018b40: 7869 7374 656e 740a 2020 2020 636c 7573  xistent.    clus
-00018b50: 7465 725f 6e61 6d65 203d 2063 6f6e 7472  ter_name = contr
-00018b60: 6f6c 6c65 722e 7661 6c75 652e 636c 7573  oller.value.clus
-00018b70: 7465 725f 6e61 6d65 0a20 2020 206e 6565  ter_name.    nee
-00018b80: 645f 636f 6e6e 6563 7469 6f6e 5f63 6865  d_connection_che
-00018b90: 636b 203d 2046 616c 7365 0a20 2020 2063  ck = False.    c
-00018ba0: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
-00018bb0: 2c20 6861 6e64 6c65 203d 204e 6f6e 652c  , handle = None,
-00018bc0: 204e 6f6e 650a 2020 2020 7472 793a 0a20   None.    try:. 
-00018bd0: 2020 2020 2020 2023 2053 6574 2066 6f72         # Set for
-00018be0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
-00018bf0: 7365 733d 5b49 4e49 545d 2074 6f20 6d61  ses=[INIT] to ma
-00018c00: 6b65 2073 7572 6520 7468 6520 7265 6672  ke sure the refr
-00018c10: 6573 6820 6861 7070 656e 730a 2020 2020  esh happens.    
-00018c20: 2020 2020 2320 7768 656e 2074 6865 2063      # when the c
-00018c30: 6f6e 7472 6f6c 6c65 7220 6973 2049 4e49  ontroller is INI
-00018c40: 542f 5550 2028 7472 6967 6765 7265 6420  T/UP (triggered 
-00018c50: 696e 2074 6865 7365 2073 7461 7475 7365  in these statuse
-00018c60: 7320 6173 2074 6865 0a20 2020 2020 2020  s as the.       
-00018c70: 2023 2061 7574 6f73 746f 7020 6973 2061   # autostop is a
-00018c80: 6c77 6179 7320 7365 7420 666f 7220 7468  lways set for th
-00018c90: 6520 636f 6e74 726f 6c6c 6572 292e 2054  e controller). T
-00018ca0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6361  he controller ca
-00018cb0: 6e20 6265 2069 6e0a 2020 2020 2020 2020  n be in.        
-00018cc0: 2320 666f 6c6c 6f77 696e 6720 6361 7365  # following case
-00018cd0: 733a 0a20 2020 2020 2020 2023 202a 2028  s:.        # * (
-00018ce0: 5550 2c20 6175 746f 7374 6f70 2073 6574  UP, autostop set
-00018cf0: 293a 2069 7420 7769 6c6c 2062 6520 7265  ): it will be re
-00018d00: 6672 6573 6865 6420 7769 7468 6f75 7420  freshed without 
-00018d10: 666f 7263 655f 7265 6672 6573 6820 7365  force_refresh se
-00018d20: 742e 0a20 2020 2020 2020 2023 202a 2028  t..        # * (
-00018d30: 5550 2c20 6e6f 2061 7574 6f73 746f 7029  UP, no autostop)
-00018d40: 3a20 7665 7279 2072 6172 6520 2861 2075  : very rare (a u
-00018d50: 7365 7220 6374 726c 2d63 2077 6865 6e20  ser ctrl-c when 
-00018d60: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
-00018d70: 730a 2020 2020 2020 2020 2320 2020 6c61  s.        #   la
-00018d80: 756e 6368 696e 6729 2c20 646f 6573 206e  unching), does n
-00018d90: 6f74 206d 6174 7465 7220 6966 2072 6566  ot matter if ref
-00018da0: 7265 7368 206f 7220 6e6f 742c 2073 696e  resh or not, sin
-00018db0: 6365 206e 6f20 6175 746f 7374 6f70 2e20  ce no autostop. 
-00018dc0: 5765 0a20 2020 2020 2020 2023 2020 2064  We.        #   d
-00018dd0: 6f6e 2774 2069 6e63 6c75 6465 2055 5020  on't include UP 
-00018de0: 696e 2066 6f72 6365 5f72 6566 7265 7368  in force_refresh
-00018df0: 5f73 7461 7475 7365 7320 746f 2061 766f  _statuses to avo
-00018e00: 6964 206f 7665 7268 6561 6473 2e0a 2020  id overheads..  
-00018e10: 2020 2020 2020 2320 2a20 2849 4e49 542c        # * (INIT,
-00018e20: 2061 7574 6f73 746f 7020 7365 7429 0a20   autostop set). 
-00018e30: 2020 2020 2020 2023 202a 2028 494e 4954         # * (INIT
-00018e40: 2c20 6e6f 2061 7574 6f73 746f 7029 3a20  , no autostop): 
-00018e50: 7665 7279 2072 6172 6520 285f 7570 6461  very rare (_upda
-00018e60: 7465 5f63 6c75 7374 6572 5f73 7461 7475  te_cluster_statu
-00018e70: 735f 6e6f 5f6c 6f63 6b20 6d61 790a 2020  s_no_lock may.  
-00018e80: 2020 2020 2020 2320 2020 7265 7365 7420        #   reset 
-00018e90: 6c6f 6361 6c20 6175 746f 7374 6f70 2063  local autostop c
-00018ea0: 6f6e 6669 6729 2c20 6275 7420 666f 7263  onfig), but forc
-00018eb0: 655f 7265 6672 6573 6820 7769 6c6c 206d  e_refresh will m
-00018ec0: 616b 6520 7375 7265 0a20 2020 2020 2020  ake sure.       
-00018ed0: 2023 2020 2073 7461 7475 7320 6973 2072   #   status is r
-00018ee0: 6566 7265 7368 6564 2e0a 2020 2020 2020  efreshed..      
-00018ef0: 2020 230a 2020 2020 2020 2020 2320 5765    #.        # We
-00018f00: 2061 766f 6964 7320 756e 6e65 6365 7373   avoids unnecess
-00018f10: 6172 7920 636f 7374 6c79 2072 6566 7265  ary costly refre
-00018f20: 7368 2077 6865 6e20 7468 6520 636f 6e74  sh when the cont
-00018f30: 726f 6c6c 6572 2069 7320 616c 7265 6164  roller is alread
-00018f40: 790a 2020 2020 2020 2020 2320 5354 4f50  y.        # STOP
-00018f50: 5045 442e 2054 6869 7320 6f70 7469 6d69  PED. This optimi
-00018f60: 7a61 7469 6f6e 2069 7320 6261 7365 6420  zation is based 
-00018f70: 6f6e 2074 6865 2061 7373 756d 7074 696f  on the assumptio
-00018f80: 6e20 7468 6174 2074 6865 2075 7365 720a  n that the user.
-00018f90: 2020 2020 2020 2020 2320 7769 6c6c 206e          # will n
-00018fa0: 6f74 2073 7461 7274 2074 6865 2063 6f6e  ot start the con
-00018fb0: 7472 6f6c 6c65 7220 6d61 6e75 616c 6c79  troller manually
-00018fc0: 2066 726f 6d20 7468 6520 636c 6f75 6420   from the cloud 
-00018fd0: 636f 6e73 6f6c 652e 0a20 2020 2020 2020  console..       
-00018fe0: 2023 0a20 2020 2020 2020 2023 2054 6865   #.        # The
-00018ff0: 2061 6371 7569 7265 5f6c 6f63 6b5f 7469   acquire_lock_ti
-00019000: 6d65 6f75 7420 6973 2073 6574 2074 6f20  meout is set to 
-00019010: 3020 746f 2061 766f 6964 2068 616e 6769  0 to avoid hangi
-00019020: 6e67 2074 6865 2063 6f6d 6d61 6e64 2077  ng the command w
-00019030: 6865 6e0a 2020 2020 2020 2020 2320 6d75  hen.        # mu
-00019040: 6c74 6970 6c65 206a 6f62 732e 6c61 756e  ltiple jobs.laun
-00019050: 6368 2063 6f6d 6d61 6e64 7320 6172 6520  ch commands are 
-00019060: 7275 6e6e 696e 6720 6174 2074 6865 2073  running at the s
-00019070: 616d 6520 7469 6d65 2e20 4f75 7220 6c61  ame time. Our la
-00019080: 7465 720a 2020 2020 2020 2020 2320 636f  ter.        # co
-00019090: 6465 2077 696c 6c20 6368 6563 6b20 6966  de will check if
-000190a0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-000190b0: 6973 2061 6363 6573 7369 626c 6520 6279  is accessible by
-000190c0: 2064 6972 6563 746c 7920 6368 6563 6b69   directly checki
-000190d0: 6e67 0a20 2020 2020 2020 2023 2074 6865  ng.        # the
-000190e0: 2073 7368 2063 6f6e 6e65 6374 696f 6e20   ssh connection 
-000190f0: 746f 2074 6865 2063 6f6e 7472 6f6c 6c65  to the controlle
-00019100: 722c 2069 6620 6974 2066 6169 6c73 2074  r, if it fails t
-00019110: 6f20 6765 7420 6163 6375 7261 7465 0a20  o get accurate. 
-00019120: 2020 2020 2020 2023 2073 7461 7475 7320         # status 
-00019130: 6f66 2074 6865 2063 6f6e 7472 6f6c 6c65  of the controlle
-00019140: 722e 0a20 2020 2020 2020 2063 6f6e 7472  r..        contr
-00019150: 6f6c 6c65 725f 7374 6174 7573 2c20 6861  oller_status, ha
-00019160: 6e64 6c65 203d 2072 6566 7265 7368 5f63  ndle = refresh_c
-00019170: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
-00019180: 6e64 6c65 280a 2020 2020 2020 2020 2020  ndle(.          
-00019190: 2020 636c 7573 7465 725f 6e61 6d65 2c0a    cluster_name,.
-000191a0: 2020 2020 2020 2020 2020 2020 666f 7263              forc
-000191b0: 655f 7265 6672 6573 685f 7374 6174 7573  e_refresh_status
-000191c0: 6573 3d5b 7374 6174 7573 5f6c 6962 2e43  es=[status_lib.C
-000191d0: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
-000191e0: 545d 2c0a 2020 2020 2020 2020 2020 2020  T],.            
-000191f0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
-00019200: 6f63 6b5f 7469 6d65 6f75 743d 3029 0a20  ock_timeout=0). 
-00019210: 2020 2065 7863 6570 7420 6578 6365 7074     except except
-00019220: 696f 6e73 2e43 6c75 7374 6572 5374 6174  ions.ClusterStat
-00019230: 7573 4665 7463 6869 6e67 4572 726f 7220  usFetchingError 
-00019240: 6173 2065 3a0a 2020 2020 2020 2020 2320  as e:.        # 
-00019250: 5765 2064 6f20 6e6f 7420 6361 7463 6820  We do not catch 
-00019260: 7468 6520 6578 6365 7074 696f 6e73 2072  the exceptions r
-00019270: 656c 6174 6564 2074 6f20 7468 6520 636c  elated to the cl
-00019280: 7573 7465 7220 6f77 6e65 7220 6964 656e  uster owner iden
-00019290: 7469 7479 0a20 2020 2020 2020 2023 206d  tity.        # m
-000192a0: 6973 6d61 7463 682c 2070 6c65 6173 6520  ismatch, please 
-000192b0: 7265 6665 7220 746f 2074 6865 2063 6f6d  refer to the com
-000192c0: 6d65 6e74 2069 6e0a 2020 2020 2020 2020  ment in.        
-000192d0: 2320 6062 6163 6b65 6e64 5f75 7469 6c73  # `backend_utils
-000192e0: 2e63 6865 636b 5f63 6c75 7374 6572 5f61  .check_cluster_a
-000192f0: 7661 696c 6162 6c65 602e 0a20 2020 2020  vailable`..     
-00019300: 2020 2063 6f6e 7472 6f6c 6c65 725f 6e61     controller_na
-00019310: 6d65 203d 2063 6f6e 7472 6f6c 6c65 722e  me = controller.
-00019320: 7661 6c75 652e 6e61 6d65 2e72 6570 6c61  value.name.repla
-00019330: 6365 2827 2063 6f6e 7472 6f6c 6c65 7227  ce(' controller'
-00019340: 2c20 2727 290a 2020 2020 2020 2020 6c6f  , '').        lo
-00019350: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-00019360: 2020 2020 2020 2020 2020 2746 6169 6c65            'Faile
-00019370: 6420 746f 2067 6574 2074 6865 2073 7461  d to get the sta
-00019380: 7475 7320 6f66 2074 6865 2063 6f6e 7472  tus of the contr
-00019390: 6f6c 6c65 722e 2049 7420 6973 206e 6f74  oller. It is not
-000193a0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-000193b0: 2766 6174 616c 2c20 6275 7420 7b63 6f6e  'fatal, but {con
-000193c0: 7472 6f6c 6c65 725f 6e61 6d65 7d20 636f  troller_name} co
-000193d0: 6d6d 616e 6473 2f63 616c 6c73 206d 6179  mmands/calls may
-000193e0: 2068 616e 6720 6f72 2072 6574 7572 6e20   hang or return 
-000193f0: 270a 2020 2020 2020 2020 2020 2020 2773  '.            's
-00019400: 7461 6c65 2069 6e66 6f72 6d61 7469 6f6e  tale information
-00019410: 2c20 7768 656e 2074 6865 2063 6f6e 7472  , when the contr
-00019420: 6f6c 6c65 7220 6973 206e 6f74 2075 702e  oller is not up.
-00019430: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00019440: 6627 2020 4465 7461 696c 733a 207b 636f  f'  Details: {co
-00019450: 6d6d 6f6e 5f75 7469 6c73 2e66 6f72 6d61  mmon_utils.forma
-00019460: 745f 6578 6365 7074 696f 6e28 652c 2075  t_exception(e, u
-00019470: 7365 5f62 7261 636b 6574 3d54 7275 6529  se_bracket=True)
-00019480: 7d27 290a 2020 2020 2020 2020 7265 636f  }').        reco
-00019490: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
-000194a0: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
-000194b0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
-000194c0: 7374 6572 5f6e 616d 6529 0a20 2020 2020  ster_name).     
-000194d0: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
-000194e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000194f0: 2020 2020 2020 636f 6e74 726f 6c6c 6572        controller
-00019500: 5f73 7461 7475 732c 2068 616e 646c 6520  _status, handle 
-00019510: 3d20 7265 636f 7264 5b27 7374 6174 7573  = record['status
-00019520: 275d 2c20 7265 636f 7264 5b27 6861 6e64  '], record['hand
-00019530: 6c65 275d 0a20 2020 2020 2020 2020 2020  le'].           
-00019540: 2023 2057 6520 6368 6563 6b20 7468 6520   # We check the 
-00019550: 636f 6e6e 6563 7469 6f6e 2065 7665 6e20  connection even 
-00019560: 6966 2074 6865 2063 6c75 7374 6572 2068  if the cluster h
-00019570: 6173 2061 2063 6163 6865 6420 7374 6174  as a cached stat
-00019580: 7573 2055 500a 2020 2020 2020 2020 2020  us UP.          
-00019590: 2020 2320 746f 206d 616b 6520 7375 7265    # to make sure
-000195a0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-000195b0: 6973 2061 6374 7561 6c6c 7920 6163 6365  is actually acce
-000195c0: 7373 6962 6c65 2c20 6173 2074 6865 2063  ssible, as the c
-000195d0: 6163 6865 640a 2020 2020 2020 2020 2020  ached.          
-000195e0: 2020 2320 7374 6174 7573 206d 6967 6874    # status might
-000195f0: 2062 6520 7374 616c 652e 0a20 2020 2020   be stale..     
-00019600: 2020 2020 2020 206e 6565 645f 636f 6e6e         need_conn
-00019610: 6563 7469 6f6e 5f63 6865 636b 203d 2054  ection_check = T
-00019620: 7275 650a 0a20 2020 2065 7272 6f72 5f6d  rue..    error_m
-00019630: 7367 203d 204e 6f6e 650a 2020 2020 6966  sg = None.    if
-00019640: 2063 6f6e 7472 6f6c 6c65 725f 7374 6174   controller_stat
-00019650: 7573 203d 3d20 7374 6174 7573 5f6c 6962  us == status_lib
-00019660: 2e43 6c75 7374 6572 5374 6174 7573 2e53  .ClusterStatus.S
-00019670: 544f 5050 4544 3a0a 2020 2020 2020 2020  TOPPED:.        
-00019680: 6572 726f 725f 6d73 6720 3d20 7374 6f70  error_msg = stop
-00019690: 7065 645f 6d65 7373 6167 650a 2020 2020  ped_message.    
-000196a0: 656c 6966 2063 6f6e 7472 6f6c 6c65 725f  elif controller_
-000196b0: 7374 6174 7573 2069 7320 4e6f 6e65 206f  status is None o
-000196c0: 7220 6861 6e64 6c65 2069 7320 4e6f 6e65  r handle is None
-000196d0: 206f 7220 6861 6e64 6c65 2e68 6561 645f   or handle.head_
-000196e0: 6970 2069 7320 4e6f 6e65 3a0a 2020 2020  ip is None:.    
-000196f0: 2020 2020 2320 5765 2063 6865 636b 2074      # We check t
-00019700: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
-00019710: 2053 544f 5050 4544 2062 6566 6f72 6520   STOPPED before 
-00019720: 7468 6520 6368 6563 6b20 666f 7220 6861  the check for ha
-00019730: 6e64 6c65 2e68 6561 645f 6970 0a20 2020  ndle.head_ip.   
-00019740: 2020 2020 2023 204e 6f6e 6520 6265 6361       # None beca
-00019750: 7573 6520 7768 656e 2074 6865 2063 6f6e  use when the con
-00019760: 7472 6f6c 6c65 7220 6973 2053 544f 5050  troller is STOPP
-00019770: 4544 2c20 6861 6e64 6c65 2e68 6561 645f  ED, handle.head_
-00019780: 6970 2063 616e 2061 6c73 6f0a 2020 2020  ip can also.    
-00019790: 2020 2020 2320 6265 204e 6f6e 652c 2062      # be None, b
-000197a0: 7574 2077 6520 6f6e 6c79 2077 616e 7420  ut we only want 
-000197b0: 746f 2063 6174 6368 2074 6865 2063 6173  to catch the cas
-000197c0: 6520 7768 656e 2074 6865 2063 6f6e 7472  e when the contr
-000197d0: 6f6c 6c65 7220 6973 0a20 2020 2020 2020  oller is.       
-000197e0: 2023 2062 6569 6e67 2070 726f 7669 7369   # being provisi
-000197f0: 6f6e 6564 2061 7420 7468 6520 6669 7273  oned at the firs
-00019800: 7420 7469 6d65 2061 6e64 2068 6176 6520  t time and have 
-00019810: 6e6f 2068 6561 645f 6970 2e0a 2020 2020  no head_ip..    
-00019820: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
-00019830: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
-00019840: 7361 6765 0a20 2020 2065 6c69 6620 2863  sage.    elif (c
-00019850: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
-00019860: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
-00019870: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
-00019880: 5420 6f72 0a20 2020 2020 2020 2020 206e  T or.          n
-00019890: 6565 645f 636f 6e6e 6563 7469 6f6e 5f63  eed_connection_c
-000198a0: 6865 636b 293a 0a20 2020 2020 2020 2023  heck):.        #
-000198b0: 2043 6865 636b 2073 7368 2063 6f6e 6e65   Check ssh conne
-000198c0: 6374 696f 6e20 6966 2028 3129 2063 6f6e  ction if (1) con
-000198d0: 7472 6f6c 6c65 7220 6973 2069 6e20 494e  troller is in IN
-000198e0: 4954 2073 7461 7465 2c20 6f72 2028 3229  IT state, or (2)
-000198f0: 2077 6520 6661 696c 6564 2074 6f20 6665   we failed to fe
-00019900: 7463 6820 7468 650a 2020 2020 2020 2020  tch the.        
-00019910: 2320 7374 6174 7573 2c20 626f 7468 206f  # status, both o
-00019920: 6620 7768 6963 6820 6361 6e20 6861 7070  f which can happ
-00019930: 656e 2077 6865 6e20 636f 6e74 726f 6c6c  en when controll
-00019940: 6572 2773 2073 7461 7475 7320 6c6f 636b  er's status lock
-00019950: 2069 7320 6865 6c64 2062 7920 616e 6f74   is held by anot
-00019960: 6865 7220 6073 6b79 206a 6f62 7320 6c61  her `sky jobs la
-00019970: 756e 6368 6020 6f72 0a20 2020 2020 2020  unch` or.       
-00019980: 2023 2060 736b 7920 7365 7276 6520 7570   # `sky serve up
-00019990: 602e 2049 6620 7765 2068 6176 65c2 a063  `. If we have..c
-000199a0: 6f6e 7472 6f6c 6c65 7227 7320 6865 6164  ontroller's head
-000199b0: 5f69 7020 6176 6169 6c61 626c 6520 616e  _ip available an
-000199c0: 6420 6974 2069 7320 7373 682d 7265 6163  d it is ssh-reac
-000199d0: 6861 626c 652c 0a20 2020 2020 2020 2023  hable,.        #
-000199e0: 2077 6520 6361 6e20 616c 6c6f 7720 6163   we can allow ac
-000199f0: 6365 7373 2074 6f20 7468 6520 636f 6e74  cess to the cont
-00019a00: 726f 6c6c 6572 2e0a 2020 2020 2020 2020  roller..        
-00019a10: 7373 685f 6372 6564 656e 7469 616c 7320  ssh_credentials 
-00019a20: 3d20 7373 685f 6372 6564 656e 7469 616c  = ssh_credential
-00019a30: 5f66 726f 6d5f 7961 6d6c 2868 616e 646c  _from_yaml(handl
-00019a40: 652e 636c 7573 7465 725f 7961 6d6c 2c0a  e.cluster_yaml,.
-00019a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a80: 2020 2068 616e 646c 652e 646f 636b 6572     handle.docker
-00019a90: 5f75 7365 722c 0a20 2020 2020 2020 2020  _user,.         
-00019aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ac0: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
-00019ad0: 2e73 7368 5f75 7365 7229 0a0a 2020 2020  .ssh_user)..    
-00019ae0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
-00019af0: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
-00019b00: 6f6d 6d61 6e64 5275 6e6e 6572 2868 616e  ommandRunner(han
-00019b10: 646c 652e 6865 6164 5f69 702c 0a20 2020  dle.head_ip,.   
-00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b40: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-00019b50: 7373 685f 6372 6564 656e 7469 616c 732c  ssh_credentials,
-00019b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b90: 2020 706f 7274 3d68 616e 646c 652e 6865    port=handle.he
-00019ba0: 6164 5f73 7368 5f70 6f72 7429 0a20 2020  ad_ssh_port).   
-00019bb0: 2020 2020 2069 6620 6e6f 7420 7275 6e6e       if not runn
-00019bc0: 6572 2e63 6865 636b 5f63 6f6e 6e65 6374  er.check_connect
-00019bd0: 696f 6e28 293a 0a20 2020 2020 2020 2020  ion():.         
-00019be0: 2020 2065 7272 6f72 5f6d 7367 203d 2063     error_msg = c
-00019bf0: 6f6e 7472 6f6c 6c65 722e 7661 6c75 652e  ontroller.value.
-00019c00: 636f 6e6e 6563 7469 6f6e 5f65 7272 6f72  connection_error
-00019c10: 5f68 696e 740a 2020 2020 656c 7365 3a0a  _hint.    else:.
-00019c20: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00019c30: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
-00019c40: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
-00019c50: 6c75 7374 6572 5374 6174 7573 2e55 502c  lusterStatus.UP,
-00019c60: 2068 616e 646c 650a 0a20 2020 2069 6620   handle..    if 
-00019c70: 6572 726f 725f 6d73 6720 6973 206e 6f74  error_msg is not
-00019c80: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00019c90: 6620 6578 6974 5f69 665f 6e6f 745f 6163  f exit_if_not_ac
-00019ca0: 6365 7373 6962 6c65 3a0a 2020 2020 2020  cessible:.      
-00019cb0: 2020 2020 2020 736b 795f 6c6f 6767 696e        sky_loggin
-00019cc0: 672e 7072 696e 7428 6572 726f 725f 6d73  g.print(error_ms
-00019cd0: 6729 0a20 2020 2020 2020 2020 2020 2073  g).            s
-00019ce0: 7973 2e65 7869 7428 3129 0a20 2020 2020  ys.exit(1).     
-00019cf0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-00019d00: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-00019d10: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-00019d20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00019d30: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
-00019d40: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
-00019d50: 6572 726f 725f 6d73 672c 0a20 2020 2020  error_msg,.     
-00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d80: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00019d90: 725f 7374 6174 7573 3d63 6f6e 7472 6f6c  r_status=control
-00019da0: 6c65 725f 7374 6174 7573 2c0a 2020 2020  ler_status,.    
-00019db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019dd0: 2020 2020 2020 2020 2020 2068 616e 646c             handl
-00019de0: 653d 6861 6e64 6c65 290a 2020 2020 6173  e=handle).    as
-00019df0: 7365 7274 2068 616e 646c 6520 6973 206e  sert handle is n
-00019e00: 6f74 204e 6f6e 6520 616e 6420 6861 6e64  ot None and hand
-00019e10: 6c65 2e68 6561 645f 6970 2069 7320 6e6f  le.head_ip is no
-00019e20: 7420 4e6f 6e65 2c20 280a 2020 2020 2020  t None, (.      
-00019e30: 2020 6861 6e64 6c65 2c20 636f 6e74 726f    handle, contro
-00019e40: 6c6c 6572 5f73 7461 7475 7329 0a20 2020  ller_status).   
-00019e50: 2072 6574 7572 6e20 6861 6e64 6c65 0a0a   return handle..
-00019e60: 0a63 6c61 7373 2043 6c6f 7564 4669 6c74  .class CloudFilt
-00019e70: 6572 2865 6e75 6d2e 456e 756d 293a 0a20  er(enum.Enum):. 
-00019e80: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
-00019e90: 616c 6c20 7479 7065 7320 6f66 2063 6c6f  all types of clo
-00019ea0: 7564 732e 0a20 2020 2041 4c4c 203d 2027  uds..    ALL = '
-00019eb0: 616c 6c27 0a20 2020 2023 2046 696c 7465  all'.    # Filte
-00019ec0: 7220 666f 7220 536b 7927 7320 6d61 696e  r for Sky's main
-00019ed0: 2063 6c6f 7564 7320 2861 7773 2c20 6763   clouds (aws, gc
-00019ee0: 702c 2061 7a75 7265 2c20 646f 636b 6572  p, azure, docker
-00019ef0: 292e 0a20 2020 2043 4c4f 5544 535f 414e  )..    CLOUDS_AN
-00019f00: 445f 444f 434b 4552 203d 2027 636c 6f75  D_DOCKER = 'clou
-00019f10: 6473 2d61 6e64 2d64 6f63 6b65 7227 0a20  ds-and-docker'. 
-00019f20: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
-00019f30: 6f6e 6c79 206c 6f63 616c 2063 6c6f 7564  only local cloud
-00019f40: 732e 0a20 2020 204c 4f43 414c 203d 2027  s..    LOCAL = '
-00019f50: 6c6f 6361 6c27 0a0a 0a64 6566 2067 6574  local'...def get
-00019f60: 5f63 6c75 7374 6572 7328 0a20 2020 2069  _clusters(.    i
-00019f70: 6e63 6c75 6465 5f63 6f6e 7472 6f6c 6c65  nclude_controlle
-00019f80: 723a 2062 6f6f 6c2c 0a20 2020 2072 6566  r: bool,.    ref
-00019f90: 7265 7368 3a20 626f 6f6c 2c0a 2020 2020  resh: bool,.    
-00019fa0: 636c 7573 7465 725f 6e61 6d65 733a 204f  cluster_names: O
-00019fb0: 7074 696f 6e61 6c5b 556e 696f 6e5b 7374  ptional[Union[st
-00019fc0: 722c 204c 6973 745b 7374 725d 5d5d 203d  r, List[str]]] =
-00019fd0: 204e 6f6e 652c 0a29 202d 3e20 4c69 7374   None,.) -> List
-00019fe0: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00019ff0: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
-0001a000: 2061 206c 6973 7420 6f66 2063 6163 6865   a list of cache
-0001a010: 6420 6f72 206f 7074 696f 6e61 6c6c 7920  d or optionally 
-0001a020: 7265 6672 6573 6865 6420 636c 7573 7465  refreshed cluste
-0001a030: 7220 7265 636f 7264 732e 0a0a 2020 2020  r records...    
-0001a040: 436f 6d62 7320 7468 726f 7567 6820 7468  Combs through th
-0001a050: 6520 6461 7461 6261 7365 2028 696e 207e  e database (in ~
-0001a060: 2f2e 736b 792f 7374 6174 652e 6462 2920  /.sky/state.db) 
-0001a070: 746f 2067 6574 2061 206c 6973 7420 6f66  to get a list of
-0001a080: 2072 6563 6f72 6473 0a20 2020 2063 6f72   records.    cor
-0001a090: 7265 7370 6f6e 6469 6e67 2074 6f20 6c61  responding to la
-0001a0a0: 756e 6368 6564 2063 6c75 7374 6572 7320  unched clusters 
-0001a0b0: 2866 696c 7465 7265 6420 6279 2060 636c  (filtered by `cl
-0001a0c0: 7573 7465 725f 6e61 6d65 7360 2069 6620  uster_names` if 
-0001a0d0: 6974 2069 730a 2020 2020 7370 6563 6966  it is.    specif
-0001a0e0: 6965 6429 2e20 5468 6520 7265 6672 6573  ied). The refres
-0001a0f0: 6820 666c 6167 2063 616e 2062 6520 7573  h flag can be us
-0001a100: 6564 2074 6f20 666f 7263 6520 6120 7265  ed to force a re
-0001a110: 6672 6573 6820 6f66 2074 6865 2073 7461  fresh of the sta
-0001a120: 7475 730a 2020 2020 6f66 2074 6865 2063  tus.    of the c
-0001a130: 6c75 7374 6572 732e 0a0a 2020 2020 4172  lusters...    Ar
-0001a140: 6773 3a0a 2020 2020 2020 2020 696e 636c  gs:.        incl
-0001a150: 7564 655f 636f 6e74 726f 6c6c 6572 3a20  ude_controller: 
-0001a160: 5768 6574 6865 7220 746f 2069 6e63 6c75  Whether to inclu
-0001a170: 6465 2063 6f6e 7472 6f6c 6c65 7273 2c20  de controllers, 
-0001a180: 652e 672e 206a 6f62 7320 636f 6e74 726f  e.g. jobs contro
-0001a190: 6c6c 6572 0a20 2020 2020 2020 2020 2020  ller.           
-0001a1a0: 206f 7220 736b 7920 7365 7276 6520 636f   or sky serve co
-0001a1b0: 6e74 726f 6c6c 6572 2e0a 2020 2020 2020  ntroller..      
-0001a1c0: 2020 7265 6672 6573 683a 2057 6865 7468    refresh: Wheth
-0001a1d0: 6572 2074 6f20 7265 6672 6573 6820 7468  er to refresh th
-0001a1e0: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
-0001a1f0: 636c 7573 7465 7273 2e20 2852 6566 7265  clusters. (Refre
-0001a200: 7368 696e 6720 7769 6c6c 0a20 2020 2020  shing will.     
-0001a210: 2020 2020 2020 2073 6574 2074 6865 2073         set the s
-0001a220: 7461 7475 7320 746f 2053 544f 5050 4544  tatus to STOPPED
-0001a230: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
-0001a240: 6361 6e6e 6f74 2062 6520 7069 6e67 6564  cannot be pinged
-0001a250: 2e29 0a20 2020 2020 2020 2063 6c6f 7564  .).        cloud
-0001a260: 5f66 696c 7465 723a 2053 6574 7320 7768  _filter: Sets wh
-0001a270: 6963 6820 636c 6f75 6473 2074 6f20 6669  ich clouds to fi
-0001a280: 6c65 7220 7468 726f 7567 6820 6672 6f6d  ler through from
-0001a290: 2074 6865 2067 6c6f 6261 6c20 7573 6572   the global user
-0001a2a0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-0001a2b0: 7465 2e20 5375 7070 6f72 7473 2074 6872  te. Supports thr
-0001a2c0: 6565 2076 616c 7565 732c 2027 616c 6c27  ee values, 'all'
-0001a2d0: 2066 6f72 2061 6c6c 2063 6c6f 7564 732c   for all clouds,
-0001a2e0: 2027 7075 626c 6963 2720 666f 720a 2020   'public' for.  
-0001a2f0: 2020 2020 2020 2020 2020 7075 626c 6963            public
-0001a300: 2063 6c6f 7564 7320 6f6e 6c79 2c20 616e   clouds only, an
-0001a310: 6420 276c 6f63 616c 2720 666f 7220 6f6e  d 'local' for on
-0001a320: 6c79 206c 6f63 616c 2063 6c6f 7564 732e  ly local clouds.
-0001a330: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-0001a340: 5f6e 616d 6573 3a20 4966 2070 726f 7669  _names: If provi
-0001a350: 6465 642c 206f 6e6c 7920 7265 7475 726e  ded, only return
-0001a360: 2072 6563 6f72 6473 2066 6f72 2074 6865   records for the
-0001a370: 2067 6976 656e 2063 6c75 7374 6572 0a20   given cluster. 
-0001a380: 2020 2020 2020 2020 2020 206e 616d 6573             names
-0001a390: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001a3a0: 2020 2020 2020 2020 4120 6c69 7374 206f          A list o
-0001a3b0: 6620 636c 7573 7465 7220 7265 636f 7264  f cluster record
-0001a3c0: 732e 2049 6620 7468 6520 636c 7573 7465  s. If the cluste
-0001a3d0: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-0001a3e0: 206f 7220 6861 7320 6265 656e 0a20 2020   or has been.   
-0001a3f0: 2020 2020 2074 6572 6d69 6e61 7465 642c       terminated,
-0001a400: 2074 6865 2072 6563 6f72 6420 7769 6c6c   the record will
-0001a410: 2062 6520 6f6d 6974 7465 6420 6672 6f6d   be omitted from
-0001a420: 2074 6865 2072 6574 7572 6e65 6420 6c69   the returned li
-0001a430: 7374 2e0a 2020 2020 2222 220a 2020 2020  st..    """.    
-0001a440: 7265 636f 7264 7320 3d20 676c 6f62 616c  records = global
-0001a450: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-0001a460: 636c 7573 7465 7273 2829 0a0a 2020 2020  clusters()..    
-0001a470: 6966 206e 6f74 2069 6e63 6c75 6465 5f63  if not include_c
-0001a480: 6f6e 7472 6f6c 6c65 723a 0a20 2020 2020  ontroller:.     
-0001a490: 2020 2072 6563 6f72 6473 203d 205b 0a20     records = [. 
-0001a4a0: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
-0001a4b0: 6420 666f 7220 7265 636f 7264 2069 6e20  d for record in 
-0001a4c0: 7265 636f 7264 730a 2020 2020 2020 2020  records.        
-0001a4d0: 2020 2020 6966 2063 6f6e 7472 6f6c 6c65      if controlle
-0001a4e0: 725f 7574 696c 732e 436f 6e74 726f 6c6c  r_utils.Controll
-0001a4f0: 6572 732e 6672 6f6d 5f6e 616d 6528 7265  ers.from_name(re
-0001a500: 636f 7264 5b27 6e61 6d65 275d 2920 6973  cord['name']) is
-0001a510: 204e 6f6e 650a 2020 2020 2020 2020 5d0a   None.        ].
-0001a520: 0a20 2020 2079 656c 6c6f 7720 3d20 636f  .    yellow = co
-0001a530: 6c6f 7261 6d61 2e46 6f72 652e 5945 4c4c  lorama.Fore.YELL
-0001a540: 4f57 0a20 2020 2062 7269 6768 7420 3d20  OW.    bright = 
-0001a550: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e42  colorama.Style.B
-0001a560: 5249 4748 540a 2020 2020 7265 7365 7420  RIGHT.    reset 
-0001a570: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
-0001a580: 2e52 4553 4554 5f41 4c4c 0a0a 2020 2020  .RESET_ALL..    
-0001a590: 6966 2063 6c75 7374 6572 5f6e 616d 6573  if cluster_names
-0001a5a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001a5b0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001a5c0: 6e63 6528 636c 7573 7465 725f 6e61 6d65  nce(cluster_name
-0001a5d0: 732c 2073 7472 293a 0a20 2020 2020 2020  s, str):.       
-0001a5e0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-0001a5f0: 6573 203d 205b 636c 7573 7465 725f 6e61  es = [cluster_na
-0001a600: 6d65 735d 0a20 2020 2020 2020 206e 6577  mes].        new
-0001a610: 5f72 6563 6f72 6473 203d 205b 5d0a 2020  _records = [].  
-0001a620: 2020 2020 2020 6e6f 745f 6578 6973 745f        not_exist_
-0001a630: 636c 7573 7465 725f 6e61 6d65 7320 3d20  cluster_names = 
-0001a640: 5b5d 0a20 2020 2020 2020 2066 6f72 2063  [].        for c
-0001a650: 6c75 7374 6572 5f6e 616d 6520 696e 2063  luster_name in c
-0001a660: 6c75 7374 6572 5f6e 616d 6573 3a0a 2020  luster_names:.  
-0001a670: 2020 2020 2020 2020 2020 666f 7220 7265            for re
-0001a680: 636f 7264 2069 6e20 7265 636f 7264 733a  cord in records:
-0001a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a6a0: 2069 6620 7265 636f 7264 5b27 6e61 6d65   if record['name
-0001a6b0: 275d 203d 3d20 636c 7573 7465 725f 6e61  '] == cluster_na
-0001a6c0: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
-0001a6d0: 2020 2020 2020 2020 6e65 775f 7265 636f          new_reco
-0001a6e0: 7264 732e 6170 7065 6e64 2872 6563 6f72  rds.append(recor
-0001a6f0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0001a700: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0001a710: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001a720: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001a730: 6f74 5f65 7869 7374 5f63 6c75 7374 6572  ot_exist_cluster
-0001a740: 5f6e 616d 6573 2e61 7070 656e 6428 636c  _names.append(cl
-0001a750: 7573 7465 725f 6e61 6d65 290a 2020 2020  uster_name).    
-0001a760: 2020 2020 6966 206e 6f74 5f65 7869 7374      if not_exist
-0001a770: 5f63 6c75 7374 6572 5f6e 616d 6573 3a0a  _cluster_names:.
-0001a780: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-0001a790: 7465 7273 5f73 7472 203d 2027 2c20 272e  ters_str = ', '.
-0001a7a0: 6a6f 696e 286e 6f74 5f65 7869 7374 5f63  join(not_exist_c
-0001a7b0: 6c75 7374 6572 5f6e 616d 6573 290a 2020  luster_names).  
-0001a7c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0001a7d0: 2e69 6e66 6f28 6627 436c 7573 7465 7228  .info(f'Cluster(
-0001a7e0: 7329 206e 6f74 2066 6f75 6e64 3a20 7b62  s) not found: {b
-0001a7f0: 7269 6768 747d 7b63 6c75 7374 6572 735f  right}{clusters_
-0001a800: 7374 727d 7b72 6573 6574 7d2e 2729 0a20  str}{reset}.'). 
-0001a810: 2020 2020 2020 2072 6563 6f72 6473 203d         records =
-0001a820: 206e 6577 5f72 6563 6f72 6473 0a0a 2020   new_records..  
-0001a830: 2020 6966 206e 6f74 2072 6566 7265 7368    if not refresh
-0001a840: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001a850: 2072 6563 6f72 6473 0a0a 2020 2020 706c   records..    pl
-0001a860: 7572 616c 203d 2027 7327 2069 6620 6c65  ural = 's' if le
-0001a870: 6e28 7265 636f 7264 7329 203e 2031 2065  n(records) > 1 e
-0001a880: 6c73 6520 2727 0a20 2020 2070 726f 6772  lse ''.    progr
-0001a890: 6573 7320 3d20 7269 6368 5f70 726f 6772  ess = rich_progr
-0001a8a0: 6573 732e 5072 6f67 7265 7373 2874 7261  ess.Progress(tra
-0001a8b0: 6e73 6965 6e74 3d54 7275 652c 0a20 2020  nsient=True,.   
-0001a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8e0: 2020 2072 6564 6972 6563 745f 7374 646f     redirect_stdo
-0001a8f0: 7574 3d46 616c 7365 2c0a 2020 2020 2020  ut=False,.      
-0001a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a920: 7265 6469 7265 6374 5f73 7464 6572 723d  redirect_stderr=
-0001a930: 4661 6c73 6529 0a20 2020 2074 6173 6b20  False).    task 
-0001a940: 3d20 7072 6f67 7265 7373 2e61 6464 5f74  = progress.add_t
-0001a950: 6173 6b28 0a20 2020 2020 2020 2066 275b  ask(.        f'[
-0001a960: 626f 6c64 2063 7961 6e5d 5265 6672 6573  bold cyan]Refres
-0001a970: 6869 6e67 2073 7461 7475 7320 666f 7220  hing status for 
-0001a980: 7b6c 656e 2872 6563 6f72 6473 297d 2063  {len(records)} c
-0001a990: 6c75 7374 6572 7b70 6c75 7261 6c7d 5b2f  luster{plural}[/
-0001a9a0: 5d27 2c0a 2020 2020 2020 2020 746f 7461  ]',.        tota
-0001a9b0: 6c3d 6c65 6e28 7265 636f 7264 7329 290a  l=len(records)).
-0001a9c0: 0a20 2020 2064 6566 205f 7265 6672 6573  .    def _refres
-0001a9d0: 685f 636c 7573 7465 7228 636c 7573 7465  h_cluster(cluste
-0001a9e0: 725f 6e61 6d65 293a 0a20 2020 2020 2020  r_name):.       
-0001a9f0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001aa00: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
-0001aa10: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
-0001aa20: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0001aa30: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
-0001aa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aa50: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
-0001aa60: 7461 7475 7365 733d 7365 7428 7374 6174  tatuses=set(stat
-0001aa70: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-0001aa80: 6174 7573 292c 0a20 2020 2020 2020 2020  atus),.         
-0001aa90: 2020 2020 2020 2061 6371 7569 7265 5f70         acquire_p
-0001aaa0: 6572 5f63 6c75 7374 6572 5f73 7461 7475  er_cluster_statu
-0001aab0: 735f 6c6f 636b 3d54 7275 6529 0a20 2020  s_lock=True).   
-0001aac0: 2020 2020 2065 7863 6570 7420 2865 7863       except (exc
-0001aad0: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-0001aae0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-0001aaf0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0001ab00: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-0001ab10: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
-0001ab20: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-0001ab30: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0001ab40: 732e 436c 7573 7465 724f 776e 6572 4964  s.ClusterOwnerId
-0001ab50: 656e 7469 7479 4d69 736d 6174 6368 4572  entityMismatchEr
-0001ab60: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
-0001ab70: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
-0001ab80: 6661 696c 2074 6865 2065 6e74 6972 6520  fail the entire 
-0001ab90: 7265 6672 6573 6820 7072 6f63 6573 732e  refresh process.
-0001aba0: 2054 6865 2063 616c 6c65 7220 7769 6c6c   The caller will
-0001abb0: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
-0001abc0: 616e 646c 6520 7468 6520 2755 4e4b 4e4f  andle the 'UNKNO
-0001abd0: 574e 2720 7374 6174 7573 2c20 616e 6420  WN' status, and 
-0001abe0: 636f 6c6c 6563 7420 7468 6520 6572 726f  collect the erro
-0001abf0: 7273 2069 6e74 6f0a 2020 2020 2020 2020  rs into.        
-0001ac00: 2020 2020 2320 6120 7461 626c 652e 0a20      # a table.. 
-0001ac10: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
-0001ac20: 6420 3d20 7b27 7374 6174 7573 273a 2027  d = {'status': '
-0001ac30: 554e 4b4e 4f57 4e27 2c20 2765 7272 6f72  UNKNOWN', 'error
-0001ac40: 273a 2065 7d0a 2020 2020 2020 2020 7072  ': e}.        pr
-0001ac50: 6f67 7265 7373 2e75 7064 6174 6528 7461  ogress.update(ta
-0001ac60: 736b 2c20 6164 7661 6e63 653d 3129 0a20  sk, advance=1). 
-0001ac70: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0001ac80: 636f 7264 0a0a 2020 2020 636c 7573 7465  cord..    cluste
-0001ac90: 725f 6e61 6d65 7320 3d20 5b72 6563 6f72  r_names = [recor
-0001aca0: 645b 276e 616d 6527 5d20 666f 7220 7265  d['name'] for re
-0001acb0: 636f 7264 2069 6e20 7265 636f 7264 735d  cord in records]
-0001acc0: 0a20 2020 2077 6974 6820 7072 6f67 7265  .    with progre
-0001acd0: 7373 3a0a 2020 2020 2020 2020 7570 6461  ss:.        upda
-0001ace0: 7465 645f 7265 636f 7264 7320 3d20 7375  ted_records = su
-0001acf0: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
-0001ad00: 756e 5f69 6e5f 7061 7261 6c6c 656c 280a  un_in_parallel(.
-0001ad10: 2020 2020 2020 2020 2020 2020 5f72 6566              _ref
-0001ad20: 7265 7368 5f63 6c75 7374 6572 2c20 636c  resh_cluster, cl
-0001ad30: 7573 7465 725f 6e61 6d65 7329 0a0a 2020  uster_names)..  
-0001ad40: 2020 2320 5368 6f77 2069 6e66 6f72 6d61    # Show informa
-0001ad50: 7469 6f6e 2066 6f72 2072 656d 6f76 6564  tion for removed
-0001ad60: 2063 6c75 7374 6572 732e 0a20 2020 206b   clusters..    k
-0001ad70: 6570 745f 7265 636f 7264 7320 3d20 5b5d  ept_records = []
-0001ad80: 0a20 2020 2061 7574 6f64 6f77 6e5f 636c  .    autodown_cl
-0001ad90: 7573 7465 7273 2c20 7265 6d61 696e 696e  usters, remainin
-0001ada0: 675f 636c 7573 7465 7273 2c20 6661 696c  g_clusters, fail
-0001adb0: 6564 5f63 6c75 7374 6572 7320 3d20 5b5d  ed_clusters = []
-0001adc0: 2c20 5b5d 2c20 5b5d 0a20 2020 2066 6f72  , [], [].    for
-0001add0: 2069 2c20 7265 636f 7264 2069 6e20 656e   i, record in en
-0001ade0: 756d 6572 6174 6528 7265 636f 7264 7329  umerate(records)
-0001adf0: 3a0a 2020 2020 2020 2020 6966 2075 7064  :.        if upd
-0001ae00: 6174 6564 5f72 6563 6f72 6473 5b69 5d20  ated_records[i] 
-0001ae10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001ae20: 2020 2020 2069 6620 7265 636f 7264 5b27       if record['
-0001ae30: 746f 5f64 6f77 6e27 5d3a 0a20 2020 2020  to_down']:.     
-0001ae40: 2020 2020 2020 2020 2020 2061 7574 6f64             autod
-0001ae50: 6f77 6e5f 636c 7573 7465 7273 2e61 7070  own_clusters.app
-0001ae60: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
-0001ae70: 735b 695d 290a 2020 2020 2020 2020 2020  s[i]).          
-0001ae80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ae90: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
-0001aea0: 675f 636c 7573 7465 7273 2e61 7070 656e  g_clusters.appen
-0001aeb0: 6428 636c 7573 7465 725f 6e61 6d65 735b  d(cluster_names[
-0001aec0: 695d 290a 2020 2020 2020 2020 656c 6966  i]).        elif
-0001aed0: 2075 7064 6174 6564 5f72 6563 6f72 6473   updated_records
-0001aee0: 5b69 5d5b 2773 7461 7475 7327 5d20 3d3d  [i]['status'] ==
-0001aef0: 2027 554e 4b4e 4f57 4e27 3a0a 2020 2020   'UNKNOWN':.    
-0001af00: 2020 2020 2020 2020 6661 696c 6564 5f63          failed_c
-0001af10: 6c75 7374 6572 732e 6170 7065 6e64 280a  lusters.append(.
-0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af30: 2863 6c75 7374 6572 5f6e 616d 6573 5b69  (cluster_names[i
-0001af40: 5d2c 2075 7064 6174 6564 5f72 6563 6f72  ], updated_recor
-0001af50: 6473 5b69 5d5b 2765 7272 6f72 275d 2929  ds[i]['error']))
-0001af60: 0a20 2020 2020 2020 2020 2020 2023 204b  .            # K
-0001af70: 6565 7020 7468 6520 6f72 6967 696e 616c  eep the original
-0001af80: 2072 6563 6f72 6420 6966 2074 6865 2073   record if the s
-0001af90: 7461 7475 7320 6973 2075 6e6b 6e6f 776e  tatus is unknown
-0001afa0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001afb0: 736f 2074 6861 7420 7468 6520 7573 6572  so that the user
-0001afc0: 2063 616e 2073 7469 6c6c 2073 6565 2074   can still see t
-0001afd0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-0001afe0: 2020 2020 2020 2020 6b65 7074 5f72 6563          kept_rec
-0001aff0: 6f72 6473 2e61 7070 656e 6428 7265 636f  ords.append(reco
-0001b000: 7264 290a 2020 2020 2020 2020 656c 7365  rd).        else
-0001b010: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-0001b020: 7074 5f72 6563 6f72 6473 2e61 7070 656e  pt_records.appen
-0001b030: 6428 7570 6461 7465 645f 7265 636f 7264  d(updated_record
-0001b040: 735b 695d 290a 0a20 2020 2069 6620 6175  s[i])..    if au
-0001b050: 746f 646f 776e 5f63 6c75 7374 6572 733a  todown_clusters:
-0001b060: 0a20 2020 2020 2020 2070 6c75 7261 6c20  .        plural 
-0001b070: 3d20 2773 2720 6966 206c 656e 2861 7574  = 's' if len(aut
-0001b080: 6f64 6f77 6e5f 636c 7573 7465 7273 2920  odown_clusters) 
-0001b090: 3e20 3120 656c 7365 2027 270a 2020 2020  > 1 else ''.    
-0001b0a0: 2020 2020 636c 7573 7465 725f 7374 7220      cluster_str 
-0001b0b0: 3d20 272c 2027 2e6a 6f69 6e28 6175 746f  = ', '.join(auto
-0001b0c0: 646f 776e 5f63 6c75 7374 6572 7329 0a20  down_clusters). 
-0001b0d0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0001b0e0: 666f 2866 2741 7574 6f64 6f77 6e65 6420  fo(f'Autodowned 
-0001b0f0: 636c 7573 7465 727b 706c 7572 616c 7d3a  cluster{plural}:
-0001b100: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001b110: 2020 2020 2020 2066 277b 6272 6967 6874         f'{bright
-0001b120: 7d7b 636c 7573 7465 725f 7374 727d 7b72  }{cluster_str}{r
-0001b130: 6573 6574 7d27 290a 2020 2020 6966 2072  eset}').    if r
-0001b140: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
-0001b150: 733a 0a20 2020 2020 2020 2070 6c75 7261  s:.        plura
-0001b160: 6c20 3d20 2773 2720 6966 206c 656e 2872  l = 's' if len(r
-0001b170: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
-0001b180: 7329 203e 2031 2065 6c73 6520 2727 0a20  s) > 1 else ''. 
-0001b190: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
-0001b1a0: 7472 203d 2027 2c20 272e 6a6f 696e 286e  tr = ', '.join(n
-0001b1b0: 616d 6520 666f 7220 6e61 6d65 2069 6e20  ame for name in 
-0001b1c0: 7265 6d61 696e 696e 675f 636c 7573 7465  remaining_cluste
-0001b1d0: 7273 290a 2020 2020 2020 2020 6c6f 6767  rs).        logg
-0001b1e0: 6572 2e77 6172 6e69 6e67 2866 277b 7965  er.warning(f'{ye
-0001b1f0: 6c6c 6f77 7d43 6c75 7374 6572 7b70 6c75  llow}Cluster{plu
-0001b200: 7261 6c7d 2074 6572 6d69 6e61 7465 6420  ral} terminated 
-0001b210: 6f6e 2027 0a20 2020 2020 2020 2020 2020  on '.           
-0001b220: 2020 2020 2020 2020 2020 2020 6627 7468              f'th
-0001b230: 6520 636c 6f75 643a 207b 7265 7365 747d  e cloud: {reset}
-0001b240: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
-0001b250: 5f73 7472 7d7b 7265 7365 747d 2729 0a0a  _str}{reset}')..
-0001b260: 2020 2020 6966 2066 6169 6c65 645f 636c      if failed_cl
-0001b270: 7573 7465 7273 3a0a 2020 2020 2020 2020  usters:.        
-0001b280: 706c 7572 616c 203d 2027 7327 2069 6620  plural = 's' if 
-0001b290: 6c65 6e28 6661 696c 6564 5f63 6c75 7374  len(failed_clust
-0001b2a0: 6572 7329 203e 2031 2065 6c73 6520 2727  ers) > 1 else ''
-0001b2b0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0001b2c0: 7761 726e 696e 6728 6627 7b79 656c 6c6f  warning(f'{yello
-0001b2d0: 777d 4661 696c 6564 2074 6f20 7265 6672  w}Failed to refr
-0001b2e0: 6573 6820 7374 6174 7573 2066 6f72 2027  esh status for '
-0001b2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b300: 2020 2020 2020 2020 6627 7b6c 656e 2866          f'{len(f
-0001b310: 6169 6c65 645f 636c 7573 7465 7273 297d  ailed_clusters)}
-0001b320: 2063 6c75 7374 6572 7b70 6c75 7261 6c7d   cluster{plural}
-0001b330: 3a7b 7265 7365 747d 2729 0a20 2020 2020  :{reset}').     
-0001b340: 2020 2066 6f72 2063 6c75 7374 6572 5f6e     for cluster_n
-0001b350: 616d 652c 2065 2069 6e20 6661 696c 6564  ame, e in failed
-0001b360: 5f63 6c75 7374 6572 733a 0a20 2020 2020  _clusters:.     
-0001b370: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-0001b380: 726e 696e 6728 6627 2020 7b62 7269 6768  rning(f'  {brigh
-0001b390: 747d 7b63 6c75 7374 6572 5f6e 616d 657d  t}{cluster_name}
-0001b3a0: 7b72 6573 6574 7d3a 207b 657d 2729 0a20  {reset}: {e}'). 
-0001b3b0: 2020 2072 6574 7572 6e20 6b65 7074 5f72     return kept_r
-0001b3c0: 6563 6f72 6473 0a0a 0a40 7479 7069 6e67  ecords...@typing
-0001b3d0: 2e6f 7665 726c 6f61 640a 6465 6620 6765  .overload.def ge
-0001b3e0: 745f 6261 636b 656e 645f 6672 6f6d 5f68  t_backend_from_h
-0001b3f0: 616e 646c 6528 0a20 2020 2068 616e 646c  andle(.    handl
-0001b400: 653a 2027 636c 6f75 645f 766d 5f72 6179  e: 'cloud_vm_ray
-0001b410: 5f62 6163 6b65 6e64 2e43 6c6f 7564 566d  _backend.CloudVm
-0001b420: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-0001b430: 6527 0a29 202d 3e20 2763 6c6f 7564 5f76  e'.) -> 'cloud_v
-0001b440: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
-0001b450: 6f75 6456 6d52 6179 4261 636b 656e 6427  oudVmRayBackend'
-0001b460: 3a0a 2020 2020 2e2e 2e0a 0a0a 4074 7970  :.    ......@typ
-0001b470: 696e 672e 6f76 6572 6c6f 6164 0a64 6566  ing.overload.def
-0001b480: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
-0001b490: 6d5f 6861 6e64 6c65 280a 2020 2020 6861  m_handle(.    ha
-0001b4a0: 6e64 6c65 3a20 276c 6f63 616c 5f64 6f63  ndle: 'local_doc
-0001b4b0: 6b65 725f 6261 636b 656e 642e 4c6f 6361  ker_backend.Loca
-0001b4c0: 6c44 6f63 6b65 7252 6573 6f75 7263 6548  lDockerResourceH
-0001b4d0: 616e 646c 6527 0a29 202d 3e20 276c 6f63  andle'.) -> 'loc
-0001b4e0: 616c 5f64 6f63 6b65 725f 6261 636b 656e  al_docker_backen
-0001b4f0: 642e 4c6f 6361 6c44 6f63 6b65 7242 6163  d.LocalDockerBac
-0001b500: 6b65 6e64 273a 0a20 2020 202e 2e2e 0a0a  kend':.    .....
-0001b510: 0a40 7479 7069 6e67 2e6f 7665 726c 6f61  .@typing.overloa
-0001b520: 640a 6465 6620 6765 745f 6261 636b 656e  d.def get_backen
-0001b530: 645f 6672 6f6d 5f68 616e 646c 6528 0a20  d_from_handle(. 
-0001b540: 2020 2020 2020 2068 616e 646c 653a 2062         handle: b
-0001b550: 6163 6b65 6e64 732e 5265 736f 7572 6365  ackends.Resource
-0001b560: 4861 6e64 6c65 2920 2d3e 2062 6163 6b65  Handle) -> backe
-0001b570: 6e64 732e 4261 636b 656e 643a 0a20 2020  nds.Backend:.   
-0001b580: 202e 2e2e 0a0a 0a64 6566 2067 6574 5f62   ......def get_b
-0001b590: 6163 6b65 6e64 5f66 726f 6d5f 6861 6e64  ackend_from_hand
-0001b5a0: 6c65 280a 2020 2020 2020 2020 6861 6e64  le(.        hand
-0001b5b0: 6c65 3a20 6261 636b 656e 6473 2e52 6573  le: backends.Res
-0001b5c0: 6f75 7263 6548 616e 646c 6529 202d 3e20  ourceHandle) -> 
-0001b5d0: 6261 636b 656e 6473 2e42 6163 6b65 6e64  backends.Backend
-0001b5e0: 3a0a 2020 2020 2222 2247 6574 7320 6120  :.    """Gets a 
-0001b5f0: 4261 636b 656e 6420 6f62 6a65 6374 2063  Backend object c
-0001b600: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-0001b610: 6120 6861 6e64 6c65 2e0a 0a20 2020 2049  a handle...    I
-0001b620: 6e73 7065 6374 7320 6861 6e64 6c65 2074  nspects handle t
-0001b630: 7970 6520 746f 2069 6e66 6572 2074 6865  ype to infer the
-0001b640: 2062 6163 6b65 6e64 2075 7365 6420 666f   backend used fo
-0001b650: 7220 7468 6520 7265 736f 7572 6365 2e0a  r the resource..
-0001b660: 2020 2020 2222 220a 2020 2020 6261 636b      """.    back
-0001b670: 656e 643a 2062 6163 6b65 6e64 732e 4261  end: backends.Ba
-0001b680: 636b 656e 640a 2020 2020 6966 2069 7369  ckend.    if isi
-0001b690: 6e73 7461 6e63 6528 6861 6e64 6c65 2c20  nstance(handle, 
-0001b6a0: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
-0001b6b0: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-0001b6c0: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
-0001b6d0: 656e 6420 3d20 6261 636b 656e 6473 2e43  end = backends.C
-0001b6e0: 6c6f 7564 566d 5261 7942 6163 6b65 6e64  loudVmRayBackend
-0001b6f0: 2829 0a20 2020 2065 6c69 6620 6973 696e  ().    elif isin
-0001b700: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
-0001b710: 6163 6b65 6e64 732e 4c6f 6361 6c44 6f63  ackends.LocalDoc
-0001b720: 6b65 7252 6573 6f75 7263 6548 616e 646c  kerResourceHandl
-0001b730: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
-0001b740: 656e 6420 3d20 6261 636b 656e 6473 2e4c  end = backends.L
-0001b750: 6f63 616c 446f 636b 6572 4261 636b 656e  ocalDockerBacken
-0001b760: 6428 290a 2020 2020 656c 7365 3a0a 2020  d().    else:.  
-0001b770: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0001b780: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0001b790: 0a20 2020 2020 2020 2020 2020 2066 2748  .            f'H
-0001b7a0: 616e 646c 6520 7479 7065 207b 7479 7065  andle type {type
-0001b7b0: 2868 616e 646c 6529 7d20 6973 206e 6f74  (handle)} is not
-0001b7c0: 2073 7570 706f 7274 6564 2079 6574 2e27   supported yet.'
-0001b7d0: 290a 2020 2020 7265 7475 726e 2062 6163  ).    return bac
-0001b7e0: 6b65 6e64 0a0a 0a64 6566 2067 6574 5f74  kend...def get_t
-0001b7f0: 6173 6b5f 6465 6d61 6e64 735f 6469 6374  ask_demands_dict
-0001b800: 2874 6173 6b3a 2027 7461 736b 5f6c 6962  (task: 'task_lib
-0001b810: 2e54 6173 6b27 2920 2d3e 2044 6963 745b  .Task') -> Dict[
-0001b820: 7374 722c 2066 6c6f 6174 5d3a 0a20 2020  str, float]:.   
-0001b830: 2022 2222 5265 7475 726e 7320 7468 6520   """Returns the 
-0001b840: 7265 736f 7572 6365 7320 6469 6374 206f  resources dict o
-0001b850: 6620 7468 6520 7461 736b 2e0a 0a20 2020  f the task...   
-0001b860: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001b870: 2020 4120 6469 6374 206f 6620 7468 6520    A dict of the 
-0001b880: 7265 736f 7572 6365 7320 6f66 2074 6865  resources of the
-0001b890: 2074 6173 6b2e 2054 6865 206b 6579 7320   task. The keys 
-0001b8a0: 6172 6520 7468 6520 7265 736f 7572 6365  are the resource
-0001b8b0: 206e 616d 6573 0a20 2020 2020 2020 2061   names.        a
-0001b8c0: 6e64 2074 6865 2076 616c 7565 7320 6172  nd the values ar
-0001b8d0: 6520 7468 6520 6e75 6d62 6572 206f 6620  e the number of 
-0001b8e0: 7468 6520 7265 736f 7572 6365 732e 2049  the resources. I
-0001b8f0: 7420 616c 7761 7973 2063 6f6e 7461 696e  t always contain
-0001b900: 730a 2020 2020 2020 2020 7468 6520 4350  s.        the CP
-0001b910: 5520 7265 736f 7572 6365 2028 746f 2063  U resource (to c
-0001b920: 6f6e 7472 6f6c 2074 6865 206d 6178 696d  ontrol the maxim
-0001b930: 756d 206e 756d 6265 7220 6f66 2074 6173  um number of tas
-0001b940: 6b73 292c 2061 6e64 0a20 2020 2020 2020  ks), and.       
-0001b950: 206f 7074 696f 6e61 6c6c 7920 6163 6365   optionally acce
-0001b960: 6c65 7261 746f 7220 6465 6d61 6e64 732e  lerator demands.
-0001b970: 0a20 2020 2022 2222 0a20 2020 2023 2054  .    """.    # T
-0001b980: 4f44 4f3a 2043 7573 746f 6d20 4350 5520  ODO: Custom CPU 
-0001b990: 616e 6420 6f74 6865 7220 6d65 6d6f 7279  and other memory
-0001b9a0: 2072 6573 6f75 7263 6573 2061 7265 206e   resources are n
-0001b9b0: 6f74 2073 7570 706f 7274 6564 2079 6574  ot supported yet
-0001b9c0: 2e0a 2020 2020 2320 466f 7220 736b 7920  ..    # For sky 
-0001b9d0: 6a6f 6273 2f73 6572 7665 2063 6f6e 7472  jobs/serve contr
-0001b9e0: 6f6c 6c65 7220 7461 736b 2c20 7765 2073  oller task, we s
-0001b9f0: 6574 2074 6865 2043 5055 2072 6573 6f75  et the CPU resou
-0001ba00: 7263 6520 746f 2061 2073 6d61 6c6c 6572  rce to a smaller
-0001ba10: 0a20 2020 2023 2076 616c 7565 2074 6f20  .    # value to 
-0001ba20: 7375 7070 6f72 7420 6120 6c61 7267 6572  support a larger
-0001ba30: 206e 756d 6265 7220 6f66 206d 616e 6167   number of manag
-0001ba40: 6564 206a 6f62 7320 616e 6420 7365 7276  ed jobs and serv
-0001ba50: 6963 6573 2e0a 2020 2020 7265 736f 7572  ices..    resour
-0001ba60: 6365 735f 6469 6374 203d 207b 0a20 2020  ces_dict = {.   
-0001ba70: 2020 2020 2027 4350 5527 3a20 2863 6f6e       'CPU': (con
-0001ba80: 7374 616e 7473 2e43 4f4e 5452 4f4c 4c45  stants.CONTROLLE
-0001ba90: 525f 5052 4f43 4553 535f 4350 555f 4445  R_PROCESS_CPU_DE
-0001baa0: 4d41 4e44 0a20 2020 2020 2020 2020 2020  MAND.           
-0001bab0: 2020 2020 2069 6620 7461 736b 2e69 735f       if task.is_
-0001bac0: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
-0001bad0: 2920 656c 7365 2044 4546 4155 4c54 5f54  ) else DEFAULT_T
-0001bae0: 4153 4b5f 4350 555f 4445 4d41 4e44 290a  ASK_CPU_DEMAND).
-0001baf0: 2020 2020 7d0a 2020 2020 6966 2074 6173      }.    if tas
-0001bb00: 6b2e 6265 7374 5f72 6573 6f75 7263 6573  k.best_resources
-0001bb10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001bb20: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
-0001bb30: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
-0001bb40: 7572 6365 730a 2020 2020 656c 7365 3a0a  urces.    else:.
-0001bb50: 2020 2020 2020 2020 2320 5461 736b 206d          # Task m
-0001bb60: 6179 2028 652e 672e 2c20 736b 7920 6c61  ay (e.g., sky la
-0001bb70: 756e 6368 2920 6f72 206d 6179 206e 6f74  unch) or may not
-0001bb80: 2028 652e 672e 2c20 736b 7920 6578 6563   (e.g., sky exec
-0001bb90: 2920 6861 7665 2075 6e64 6572 676f 6e65  ) have undergone
-0001bba0: 0a20 2020 2020 2020 2023 2073 6b79 2e6f  .        # sky.o
-0001bbb0: 7074 696d 697a 6528 292c 2073 6f20 6265  ptimize(), so be
-0001bbc0: 7374 5f72 6573 6f75 7263 6573 206d 6179  st_resources may
-0001bbd0: 2062 6520 4e6f 6e65 2e0a 2020 2020 2020   be None..      
-0001bbe0: 2020 6173 7365 7274 206c 656e 2874 6173    assert len(tas
-0001bbf0: 6b2e 7265 736f 7572 6365 7329 203d 3d20  k.resources) == 
-0001bc00: 312c 2074 6173 6b2e 7265 736f 7572 6365  1, task.resource
-0001bc10: 730a 2020 2020 2020 2020 7265 736f 7572  s.        resour
-0001bc20: 6365 7320 3d20 6c69 7374 2874 6173 6b2e  ces = list(task.
-0001bc30: 7265 736f 7572 6365 7329 5b30 5d0a 2020  resources)[0].  
-0001bc40: 2020 6966 2072 6573 6f75 7263 6573 2069    if resources i
-0001bc50: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
-0001bc60: 6573 6f75 7263 6573 2e61 6363 656c 6572  esources.acceler
-0001bc70: 6174 6f72 7320 6973 206e 6f74 204e 6f6e  ators is not Non
-0001bc80: 653a 0a20 2020 2020 2020 2072 6573 6f75  e:.        resou
-0001bc90: 7263 6573 5f64 6963 742e 7570 6461 7465  rces_dict.update
-0001bca0: 2872 6573 6f75 7263 6573 2e61 6363 656c  (resources.accel
-0001bcb0: 6572 6174 6f72 7329 0a20 2020 2072 6574  erators).    ret
-0001bcc0: 7572 6e20 7265 736f 7572 6365 735f 6469  urn resources_di
-0001bcd0: 6374 0a0a 0a64 6566 2067 6574 5f74 6173  ct...def get_tas
-0001bce0: 6b5f 7265 736f 7572 6365 735f 7374 7228  k_resources_str(
-0001bcf0: 7461 736b 3a20 2774 6173 6b5f 6c69 622e  task: 'task_lib.
-0001bd00: 5461 736b 272c 0a20 2020 2020 2020 2020  Task',.         
-0001bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd20: 2020 6973 5f6d 616e 6167 6564 5f6a 6f62    is_managed_job
-0001bd30: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-0001bd40: 2d3e 2073 7472 3a0a 2020 2020 2222 2252  -> str:.    """R
-0001bd50: 6574 7572 6e73 2074 6865 2072 6573 6f75  eturns the resou
-0001bd60: 7263 6573 2073 7472 696e 6720 6f66 2074  rces string of t
-0001bd70: 6865 2074 6173 6b2e 0a0a 2020 2020 5468  he task...    Th
-0001bd80: 6520 7265 736f 7572 6365 7320 7374 7269  e resources stri
-0001bd90: 6e67 2069 7320 6f6e 6c79 2075 7365 6420  ng is only used 
-0001bda0: 6173 2061 2064 6973 706c 6179 2070 7572  as a display pur
-0001bdb0: 706f 7365 2c20 736f 2077 6520 6f6e 6c79  pose, so we only
-0001bdc0: 2073 686f 770a 2020 2020 7468 6520 6163   show.    the ac
-0001bdd0: 6365 6c65 7261 746f 7220 6465 6d61 6e64  celerator demand
-0001bde0: 7320 2869 6620 616e 7929 2e20 4f74 6865  s (if any). Othe
-0001bdf0: 7277 6973 652c 2074 6865 2043 5055 2064  rwise, the CPU d
-0001be00: 656d 616e 6420 6973 2073 686f 776e 2e0a  emand is shown..
-0001be10: 2020 2020 2222 220a 2020 2020 7370 6f74      """.    spot
-0001be20: 5f73 7472 203d 2027 270a 2020 2020 7461  _str = ''.    ta
-0001be30: 736b 5f63 7075 5f64 656d 616e 6420 3d20  sk_cpu_demand = 
-0001be40: 2873 7472 2863 6f6e 7374 616e 7473 2e43  (str(constants.C
-0001be50: 4f4e 5452 4f4c 4c45 525f 5052 4f43 4553  ONTROLLER_PROCES
-0001be60: 535f 4350 555f 4445 4d41 4e44 290a 2020  S_CPU_DEMAND).  
-0001be70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be80: 2020 2020 2069 6620 7461 736b 2e69 735f       if task.is_
-0001be90: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
-0001bea0: 2920 656c 7365 0a20 2020 2020 2020 2020  ) else.         
-0001beb0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001bec0: 7228 4445 4641 554c 545f 5441 534b 5f43  r(DEFAULT_TASK_C
-0001bed0: 5055 5f44 454d 414e 4429 290a 2020 2020  PU_DEMAND)).    
-0001bee0: 6966 2074 6173 6b2e 6265 7374 5f72 6573  if task.best_res
-0001bef0: 6f75 7263 6573 2069 7320 6e6f 7420 4e6f  ources is not No
-0001bf00: 6e65 3a0a 2020 2020 2020 2020 6163 6365  ne:.        acce
-0001bf10: 6c65 7261 746f 725f 6469 6374 203d 2074  lerator_dict = t
-0001bf20: 6173 6b2e 6265 7374 5f72 6573 6f75 7263  ask.best_resourc
-0001bf30: 6573 2e61 6363 656c 6572 6174 6f72 730a  es.accelerators.
-0001bf40: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
-0001bf50: 6e61 6765 645f 6a6f 623a 0a20 2020 2020  naged_job:.     
-0001bf60: 2020 2020 2020 2069 6620 7461 736b 2e62         if task.b
-0001bf70: 6573 745f 7265 736f 7572 6365 732e 7573  est_resources.us
-0001bf80: 655f 7370 6f74 3a0a 2020 2020 2020 2020  e_spot:.        
-0001bf90: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
-0001bfa0: 203d 2027 5b53 706f 745d 270a 2020 2020   = '[Spot]'.    
-0001bfb0: 2020 2020 2020 2020 7461 736b 5f63 7075          task_cpu
-0001bfc0: 5f64 656d 616e 6420 3d20 7461 736b 2e62  _demand = task.b
-0001bfd0: 6573 745f 7265 736f 7572 6365 732e 6370  est_resources.cp
-0001bfe0: 7573 0a20 2020 2020 2020 2069 6620 6163  us.        if ac
-0001bff0: 6365 6c65 7261 746f 725f 6469 6374 2069  celerator_dict i
-0001c000: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001c010: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
-0001c020: 7220 3d20 6627 4350 553a 7b74 6173 6b5f  r = f'CPU:{task_
-0001c030: 6370 755f 6465 6d61 6e64 7d27 0a20 2020  cpu_demand}'.   
-0001c040: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001c050: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0001c060: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
-0001c070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001c080: 2020 6627 7b6b 7d3a 7b76 7d27 2066 6f72    f'{k}:{v}' for
-0001c090: 206b 2c20 7620 696e 2061 6363 656c 6572   k, v in acceler
-0001c0a0: 6174 6f72 5f64 6963 742e 6974 656d 7328  ator_dict.items(
-0001c0b0: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-0001c0c0: 2020 2020 2072 6573 6f75 7263 655f 6163       resource_ac
-0001c0d0: 6365 6c65 7261 746f 7273 203d 205b 5d0a  celerators = [].
-0001c0e0: 2020 2020 2020 2020 6d69 6e5f 6370 7573          min_cpus
-0001c0f0: 203d 2066 6c6f 6174 2827 696e 6627 290a   = float('inf').
-0001c100: 2020 2020 2020 2020 7370 6f74 5f74 7970          spot_typ
-0001c110: 653a 2053 6574 5b73 7472 5d20 3d20 7365  e: Set[str] = se
-0001c120: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-0001c130: 7265 736f 7572 6365 2069 6e20 7461 736b  resource in task
-0001c140: 2e72 6573 6f75 7263 6573 3a0a 2020 2020  .resources:.    
-0001c150: 2020 2020 2020 2020 7461 736b 5f63 7075          task_cpu
-0001c160: 5f64 656d 616e 6420 3d20 2731 2b27 0a20  _demand = '1+'. 
-0001c170: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0001c180: 736f 7572 6365 2e63 7075 7320 6973 206e  source.cpus is n
-0001c190: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001c1a0: 2020 2020 2020 2020 2074 6173 6b5f 6370           task_cp
-0001c1b0: 755f 6465 6d61 6e64 203d 2072 6573 6f75  u_demand = resou
-0001c1c0: 7263 652e 6370 7573 0a20 2020 2020 2020  rce.cpus.       
-0001c1d0: 2020 2020 206d 696e 5f63 7075 7320 3d20       min_cpus = 
-0001c1e0: 6d69 6e28 6d69 6e5f 6370 7573 2c20 666c  min(min_cpus, fl
-0001c1f0: 6f61 7428 7461 736b 5f63 7075 5f64 656d  oat(task_cpu_dem
-0001c200: 616e 642e 7374 7269 7028 272b 2027 2929  and.strip('+ '))
-0001c210: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001c220: 2072 6573 6f75 7263 652e 7573 655f 7370   resource.use_sp
-0001c230: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
-0001c240: 2020 2020 7370 6f74 5f74 7970 652e 6164      spot_type.ad
-0001c250: 6428 2753 706f 7427 290a 2020 2020 2020  d('Spot').      
-0001c260: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c270: 2020 2020 2020 2020 2020 2020 7370 6f74              spot
-0001c280: 5f74 7970 652e 6164 6428 274f 6e2d 6465  _type.add('On-de
-0001c290: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-0001c2a0: 2020 2020 6966 2072 6573 6f75 7263 652e      if resource.
-0001c2b0: 6163 6365 6c65 7261 746f 7273 2069 7320  accelerators is 
-0001c2c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001c2d0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0001c2e0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-0001c2f0: 2c20 7620 696e 2072 6573 6f75 7263 652e  , v in resource.
-0001c300: 6163 6365 6c65 7261 746f 7273 2e69 7465  accelerators.ite
-0001c310: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0001c320: 2020 2020 2020 7265 736f 7572 6365 5f61        resource_a
-0001c330: 6363 656c 6572 6174 6f72 732e 6170 7065  ccelerators.appe
-0001c340: 6e64 2866 277b 6b7d 3a7b 767d 2729 0a0a  nd(f'{k}:{v}')..
-0001c350: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
-0001c360: 6e61 6765 645f 6a6f 623a 0a20 2020 2020  naged_job:.     
-0001c370: 2020 2020 2020 2069 6620 6c65 6e28 7461         if len(ta
-0001c380: 736b 2e72 6573 6f75 7263 6573 2920 3e20  sk.resources) > 
-0001c390: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0001c3a0: 2020 2074 6173 6b5f 6370 755f 6465 6d61     task_cpu_dema
-0001c3b0: 6e64 203d 2066 277b 6d69 6e5f 6370 7573  nd = f'{min_cpus
-0001c3c0: 7d2b 270a 2020 2020 2020 2020 2020 2020  }+'.            
-0001c3d0: 6966 2027 5370 6f74 2720 696e 2073 706f  if 'Spot' in spo
-0001c3e0: 745f 7479 7065 3a0a 2020 2020 2020 2020  t_type:.        
-0001c3f0: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
-0001c400: 203d 2027 7c27 2e6a 6f69 6e28 736f 7274   = '|'.join(sort
-0001c410: 6564 2873 706f 745f 7479 7065 2929 0a20  ed(spot_type)). 
-0001c420: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c430: 706f 745f 7374 7220 3d20 6627 5b7b 7370  pot_str = f'[{sp
-0001c440: 6f74 5f73 7472 7d5d 270a 2020 2020 2020  ot_str}]'.      
-0001c450: 2020 6966 2072 6573 6f75 7263 655f 6163    if resource_ac
-0001c460: 6365 6c65 7261 746f 7273 3a0a 2020 2020  celerators:.    
-0001c470: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0001c480: 735f 7374 7220 3d20 272c 2027 2e6a 6f69  s_str = ', '.joi
-0001c490: 6e28 7365 7428 7265 736f 7572 6365 5f61  n(set(resource_a
-0001c4a0: 6363 656c 6572 6174 6f72 7329 290a 2020  ccelerators)).  
-0001c4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c4c0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0001c4d0: 735f 7374 7220 3d20 6627 4350 553a 7b74  s_str = f'CPU:{t
-0001c4e0: 6173 6b5f 6370 755f 6465 6d61 6e64 7d27  ask_cpu_demand}'
-0001c4f0: 0a20 2020 2072 6573 6f75 7263 6573 5f73  .    resources_s
-0001c500: 7472 203d 2066 277b 7461 736b 2e6e 756d  tr = f'{task.num
-0001c510: 5f6e 6f64 6573 7d78 5b7b 7265 736f 7572  _nodes}x[{resour
-0001c520: 6365 735f 7374 727d 5d7b 7370 6f74 5f73  ces_str}]{spot_s
-0001c530: 7472 7d27 0a20 2020 2072 6574 7572 6e20  tr}'.    return 
-0001c540: 7265 736f 7572 6365 735f 7374 720a 0a0a  resources_str...
-0001c550: 2320 4861 6e64 6c65 2063 7472 6c2d 630a  # Handle ctrl-c.
-0001c560: 6465 6620 696e 7465 7272 7570 745f 6861  def interrupt_ha
-0001c570: 6e64 6c65 7228 7369 676e 756d 2c20 6672  ndler(signum, fr
-0001c580: 616d 6529 3a0a 2020 2020 6465 6c20 7369  ame):.    del si
-0001c590: 676e 756d 2c20 6672 616d 650a 2020 2020  gnum, frame.    
-0001c5a0: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
-0001c5b0: 2e6b 696c 6c5f 6368 696c 6472 656e 5f70  .kill_children_p
-0001c5c0: 726f 6365 7373 6573 2829 0a20 2020 2023  rocesses().    #
-0001c5d0: 2041 766f 6964 2075 7369 6e67 206c 6f67   Avoid using log
-0001c5e0: 6765 7220 6865 7265 2c20 6173 2069 7420  ger here, as it 
-0001c5f0: 7769 6c6c 2070 7269 6e74 2074 6865 2073  will print the s
-0001c600: 7461 636b 2074 7261 6365 2066 6f72 2062  tack trace for b
-0001c610: 726f 6b65 6e0a 2020 2020 2320 7069 7065  roken.    # pipe
-0001c620: 2c20 7768 656e 2074 6865 206f 7574 7075  , when the outpu
-0001c630: 7420 6973 2070 6970 6564 2074 6f20 616e  t is piped to an
-0001c640: 6f74 6865 7220 7072 6f67 7261 6d2e 0a20  other program.. 
-0001c650: 2020 2070 7269 6e74 2866 277b 636f 6c6f     print(f'{colo
-0001c660: 7261 6d61 2e53 7479 6c65 2e44 494d 7d54  rama.Style.DIM}T
-0001c670: 6970 3a20 5468 6520 6a6f 6220 7769 6c6c  ip: The job will
-0001c680: 206b 6565 7020 270a 2020 2020 2020 2020   keep '.        
-0001c690: 2020 6627 7275 6e6e 696e 6720 6166 7465    f'running afte
-0001c6a0: 7220 4374 726c 2d43 2e7b 636f 6c6f 7261  r Ctrl-C.{colora
-0001c6b0: 6d61 2e53 7479 6c65 2e52 4553 4554 5f41  ma.Style.RESET_A
-0001c6c0: 4c4c 7d27 290a 2020 2020 7769 7468 2075  LL}').    with u
-0001c6d0: 785f 7574 696c 732e 7072 696e 745f 6578  x_utils.print_ex
-0001c6e0: 6365 7074 696f 6e5f 6e6f 5f74 7261 6365  ception_no_trace
-0001c6f0: 6261 636b 2829 3a0a 2020 2020 2020 2020  back():.        
-0001c700: 7261 6973 6520 4b65 7962 6f61 7264 496e  raise KeyboardIn
-0001c710: 7465 7272 7570 7428 6578 6365 7074 696f  terrupt(exceptio
-0001c720: 6e73 2e4b 4559 424f 4152 445f 494e 5445  ns.KEYBOARD_INTE
-0001c730: 5252 5550 545f 434f 4445 290a 0a0a 2320  RRUPT_CODE)...# 
-0001c740: 4861 6e64 6c65 2063 7472 6c2d 7a0a 6465  Handle ctrl-z.de
-0001c750: 6620 7374 6f70 5f68 616e 646c 6572 2873  f stop_handler(s
-0001c760: 6967 6e75 6d2c 2066 7261 6d65 293a 0a20  ignum, frame):. 
-0001c770: 2020 2064 656c 2073 6967 6e75 6d2c 2066     del signum, f
-0001c780: 7261 6d65 0a20 2020 2073 7562 7072 6f63  rame.    subproc
-0001c790: 6573 735f 7574 696c 732e 6b69 6c6c 5f63  ess_utils.kill_c
-0001c7a0: 6869 6c64 7265 6e5f 7072 6f63 6573 7365  hildren_processe
-0001c7b0: 7328 290a 2020 2020 2320 4176 6f69 6420  s().    # Avoid 
-0001c7c0: 7573 696e 6720 6c6f 6767 6572 2068 6572  using logger her
-0001c7d0: 652c 2061 7320 6974 2077 696c 6c20 7072  e, as it will pr
-0001c7e0: 696e 7420 7468 6520 7374 6163 6b20 7472  int the stack tr
-0001c7f0: 6163 6520 666f 7220 6272 6f6b 656e 0a20  ace for broken. 
-0001c800: 2020 2023 2070 6970 652c 2077 6865 6e20     # pipe, when 
-0001c810: 7468 6520 6f75 7470 7574 2069 7320 7069  the output is pi
-0001c820: 7065 6420 746f 2061 6e6f 7468 6572 2070  ped to another p
-0001c830: 726f 6772 616d 2e0a 2020 2020 7072 696e  rogram..    prin
-0001c840: 7428 6627 7b63 6f6c 6f72 616d 612e 5374  t(f'{colorama.St
-0001c850: 796c 652e 4449 4d7d 5469 703a 2054 6865  yle.DIM}Tip: The
-0001c860: 206a 6f62 2077 696c 6c20 6b65 6570 2027   job will keep '
-0001c870: 0a20 2020 2020 2020 2020 2066 2772 756e  .          f'run
-0001c880: 6e69 6e67 2061 6674 6572 2043 7472 6c2d  ning after Ctrl-
-0001c890: 5a2e 7b63 6f6c 6f72 616d 612e 5374 796c  Z.{colorama.Styl
-0001c8a0: 652e 5245 5345 545f 414c 4c7d 2729 0a20  e.RESET_ALL}'). 
-0001c8b0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-0001c8c0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-0001c8d0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-0001c8e0: 0a20 2020 2020 2020 2072 6169 7365 204b  .        raise K
-0001c8f0: 6579 626f 6172 6449 6e74 6572 7275 7074  eyboardInterrupt
-0001c900: 2865 7863 6570 7469 6f6e 732e 5349 4754  (exceptions.SIGT
-0001c910: 5354 505f 434f 4445 290a 0a0a 6465 6620  STP_CODE)...def 
-0001c920: 7275 6e5f 636f 6d6d 616e 645f 616e 645f  run_command_and_
-0001c930: 6861 6e64 6c65 5f73 7368 5f66 6169 6c75  handle_ssh_failu
-0001c940: 7265 2872 756e 6e65 723a 2063 6f6d 6d61  re(runner: comma
-0001c950: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
-0001c960: 6d61 6e64 5275 6e6e 6572 2c0a 2020 2020  mandRunner,.    
-0001c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c990: 2020 2063 6f6d 6d61 6e64 3a20 7374 722c     command: str,
-0001c9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c9c0: 2020 2020 2020 2020 6661 696c 7572 655f          failure_
-0001c9d0: 6d65 7373 6167 653a 2073 7472 2920 2d3e  message: str) ->
-0001c9e0: 2073 7472 3a0a 2020 2020 2222 2252 756e   str:.    """Run
-0001c9f0: 7320 636f 6d6d 616e 6420 7265 6d6f 7465  s command remote
-0001ca00: 6c79 2061 6e64 2072 6574 7572 6e73 206f  ly and returns o
-0001ca10: 7574 7075 7420 7769 7468 2070 726f 7065  utput with prope
-0001ca20: 7220 6572 726f 7220 6861 6e64 6c69 6e67  r error handling
-0001ca30: 2e22 2222 0a20 2020 2072 632c 2073 7464  .""".    rc, std
-0001ca40: 6f75 742c 2073 7464 6572 7220 3d20 7275  out, stderr = ru
-0001ca50: 6e6e 6572 2e72 756e 2863 6f6d 6d61 6e64  nner.run(command
-0001ca60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca80: 2020 2020 2020 7265 7175 6972 655f 6f75        require_ou
-0001ca90: 7470 7574 733d 5472 7565 2c0a 2020 2020  tputs=True,.    
-0001caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cac0: 7374 7265 616d 5f6c 6f67 733d 4661 6c73  stream_logs=Fals
-0001cad0: 6529 0a20 2020 2069 6620 7263 203d 3d20  e).    if rc == 
-0001cae0: 3235 353a 0a20 2020 2020 2020 2023 2053  255:.        # S
-0001caf0: 5348 2066 6169 6c65 640a 2020 2020 2020  SH failed.      
-0001cb00: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-0001cb10: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0001cb20: 2020 6627 5353 4820 7769 7468 2075 7365    f'SSH with use
-0001cb30: 7220 7b72 756e 6e65 722e 7373 685f 7573  r {runner.ssh_us
-0001cb40: 6572 7d20 616e 6420 6b65 7920 7b72 756e  er} and key {run
-0001cb50: 6e65 722e 7373 685f 7072 6976 6174 655f  ner.ssh_private_
-0001cb60: 6b65 797d 2027 0a20 2020 2020 2020 2020  key} '.         
-0001cb70: 2020 2066 2774 6f20 7b72 756e 6e65 722e     f'to {runner.
-0001cb80: 6970 7d20 6661 696c 6564 2e20 5468 6973  ip} failed. This
-0001cb90: 2069 7320 6d6f 7374 206c 696b 656c 7920   is most likely 
-0001cba0: 6475 6520 746f 2069 6e63 6f72 7265 6374  due to incorrect
-0001cbb0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-0001cbc0: 6372 6564 656e 7469 616c 7320 6f72 2069  credentials or i
-0001cbd0: 6e63 6f72 7265 6374 2070 6572 6d69 7373  ncorrect permiss
-0001cbe0: 696f 6e73 2066 6f72 2074 6865 206b 6579  ions for the key
-0001cbf0: 2066 696c 652e 2043 6865 636b 2027 0a20   file. Check '. 
-0001cc00: 2020 2020 2020 2020 2020 2027 796f 7572             'your
-0001cc10: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
-0001cc20: 2074 7279 2061 6761 696e 2e27 290a 2020   try again.').  
-0001cc30: 2020 7375 6270 726f 6365 7373 5f75 7469    subprocess_uti
-0001cc40: 6c73 2e68 616e 646c 655f 7265 7475 726e  ls.handle_return
-0001cc50: 636f 6465 2872 632c 0a20 2020 2020 2020  code(rc,.       
-0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc80: 636f 6d6d 616e 642c 0a20 2020 2020 2020  command,.       
-0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccb0: 6661 696c 7572 655f 6d65 7373 6167 652c  failure_message,
-0001ccc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cce0: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
-0001ccf0: 7464 6572 7229 0a20 2020 2072 6574 7572  tderr).    retur
-0001cd00: 6e20 7374 646f 7574 0a0a 0a64 6566 2063  n stdout...def c
-0001cd10: 6865 636b 5f72 7379 6e63 5f69 6e73 7461  heck_rsync_insta
-0001cd20: 6c6c 6564 2829 202d 3e20 4e6f 6e65 3a0a  lled() -> None:.
-0001cd30: 2020 2020 2222 2243 6865 636b 7320 6966      """Checks if
-0001cd40: 2072 7379 6e63 2069 7320 696e 7374 616c   rsync is instal
-0001cd50: 6c65 642e 0a0a 2020 2020 5261 6973 6573  led...    Raises
-0001cd60: 3a0a 2020 2020 2020 2020 5275 6e74 696d  :.        Runtim
-0001cd70: 6545 7272 6f72 3a20 6966 2072 7379 6e63  eError: if rsync
-0001cd80: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
-0001cd90: 6420 696e 2074 6865 206d 6163 6869 6e65  d in the machine
-0001cda0: 2e0a 2020 2020 2222 220a 2020 2020 7472  ..    """.    tr
-0001cdb0: 793a 0a20 2020 2020 2020 2073 7562 7072  y:.        subpr
-0001cdc0: 6f63 6573 732e 7275 6e28 2772 7379 6e63  ocess.run('rsync
-0001cdd0: 202d 2d76 6572 7369 6f6e 272c 0a20 2020   --version',.   
-0001cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cdf0: 2020 2020 7368 656c 6c3d 5472 7565 2c0a      shell=True,.
-0001ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce10: 2020 2020 2020 2063 6865 636b 3d54 7275         check=Tru
-0001ce20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001ce30: 2020 2020 2020 2020 2020 7374 646f 7574            stdout
-0001ce40: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
-0001ce50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ce60: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
-0001ce70: 7375 6270 726f 6365 7373 2e50 4950 4529  subprocess.PIPE)
-0001ce80: 0a20 2020 2065 7863 6570 7420 7375 6270  .    except subp
-0001ce90: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
-0001cea0: 6365 7373 4572 726f 723a 0a20 2020 2020  cessError:.     
-0001ceb0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-0001cec0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-0001ced0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-0001cee0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0001cef0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-0001cf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cf10: 2027 6072 7379 6e63 6020 6973 2072 6571   '`rsync` is req
-0001cf20: 7569 7265 6420 666f 7220 7072 6f76 6973  uired for provis
-0001cf30: 696f 6e69 6e67 2061 6e64 270a 2020 2020  ioning and'.    
-0001cf40: 2020 2020 2020 2020 2020 2020 2720 6974              ' it
-0001cf50: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
-0001cf60: 642e 2046 6f72 2044 6562 6961 6e2f 5562  d. For Debian/Ub
-0001cf70: 756e 7475 2073 7973 7465 6d2c 2027 0a20  untu system, '. 
-0001cf80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001cf90: 696e 7374 616c 6c20 6974 2077 6974 683a  install it with:
-0001cfa0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001cfb0: 2020 2020 2720 2024 2073 7564 6f20 6170      '  $ sudo ap
-0001cfc0: 7420 696e 7374 616c 6c20 7273 796e 6327  t install rsync'
-0001cfd0: 2920 6672 6f6d 204e 6f6e 650a 0a0a 6465  ) from None...de
-0001cfe0: 6620 6368 6563 6b5f 7374 616c 655f 7275  f check_stale_ru
-0001cff0: 6e74 696d 655f 6f6e 5f72 656d 6f74 6528  ntime_on_remote(
-0001d000: 7265 7475 726e 636f 6465 3a20 696e 742c  returncode: int,
-0001d010: 2073 7464 6572 723a 2073 7472 2c0a 2020   stderr: str,.  
-0001d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d040: 636c 7573 7465 725f 6e61 6d65 3a20 7374  cluster_name: st
-0001d050: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-0001d060: 2222 2252 6169 7365 7320 5275 6e74 696d  """Raises Runtim
-0001d070: 6545 7272 6f72 2069 6620 7265 6d6f 7465  eError if remote
-0001d080: 2053 6b79 5069 6c6f 7420 7275 6e74 696d   SkyPilot runtim
-0001d090: 6520 6e65 6564 7320 746f 2062 6520 7570  e needs to be up
-0001d0a0: 6461 7465 642e 0a0a 2020 2020 5765 2064  dated...    We d
-0001d0b0: 6574 6563 7420 7468 6973 2062 7920 7061  etect this by pa
-0001d0c0: 7273 696e 6720 6365 7274 6169 6e20 6261  rsing certain ba
-0001d0d0: 636b 7761 7264 2d69 6e63 6f6d 7061 7469  ckward-incompati
-0001d0e0: 626c 6520 6572 726f 7220 6d65 7373 6167  ble error messag
-0001d0f0: 6573 2066 726f 6d0a 2020 2020 6073 7464  es from.    `std
-0001d100: 6572 7260 2e20 5479 7069 6361 6c6c 7920  err`. Typically 
-0001d110: 6475 6520 746f 2074 6865 206c 6f63 616c  due to the local
-0001d120: 2063 6c69 656e 7420 7665 7273 696f 6e20   client version 
-0001d130: 6a75 7374 2067 6f74 2075 7064 6174 6564  just got updated
-0001d140: 2c20 616e 640a 2020 2020 7468 6520 7265  , and.    the re
-0001d150: 6d6f 7465 2072 756e 7469 6d65 2069 7320  mote runtime is 
-0001d160: 616e 206f 6c64 6572 2076 6572 7369 6f6e  an older version
-0001d170: 2e0a 2020 2020 2222 220a 2020 2020 7061  ..    """.    pa
-0001d180: 7474 6572 6e20 3d20 7265 2e63 6f6d 7069  ttern = re.compi
-0001d190: 6c65 2872 2741 7474 7269 6275 7465 4572  le(r'AttributeEr
-0001d1a0: 726f 723a 206d 6f64 756c 6520 5c27 736b  ror: module \'sk
-0001d1b0: 795c 2e28 2e2a 295c 2720 6861 7320 6e6f  y\.(.*)\' has no
-0001d1c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001d1d0: 2020 2020 2020 2020 2020 2020 7227 6174              r'at
-0001d1e0: 7472 6962 7574 6520 5c27 282e 2a29 5c27  tribute \'(.*)\'
-0001d1f0: 2729 0a20 2020 2069 6620 7265 7475 726e  ').    if return
-0001d200: 636f 6465 2021 3d20 303a 0a20 2020 2020  code != 0:.     
-0001d210: 2020 2061 7474 7269 6275 7465 5f65 7272     attribute_err
-0001d220: 6f72 203d 2072 652e 6669 6e64 616c 6c28  or = re.findall(
-0001d230: 7061 7474 6572 6e2c 2073 7464 6572 7229  pattern, stderr)
-0001d240: 0a20 2020 2020 2020 2069 6620 6174 7472  .        if attr
-0001d250: 6962 7574 655f 6572 726f 723a 0a20 2020  ibute_error:.   
-0001d260: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
-0001d270: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
-0001d280: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
-0001d290: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
-0001d2a0: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-0001d2b0: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
-0001d2c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d2d0: 277b 636f 6c6f 7261 6d61 2e46 6f72 652e  '{colorama.Fore.
-0001d2e0: 5245 447d 536b 7950 696c 6f74 2072 756e  RED}SkyPilot run
-0001d2f0: 7469 6d65 206e 6565 6473 2074 6f20 6265  time needs to be
-0001d300: 2075 7064 6174 6564 2027 0a20 2020 2020   updated '.     
-0001d310: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001d320: 6f6e 2074 6865 2072 656d 6f74 6520 636c  on the remote cl
-0001d330: 7573 7465 722e 2054 6f20 7570 6461 7465  uster. To update
-0001d340: 2c20 7275 6e20 2865 7869 7374 696e 6720  , run (existing 
-0001d350: 6a6f 6273 2061 7265 2027 0a20 2020 2020  jobs are '.     
-0001d360: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d370: 276e 6f74 2069 6e74 6572 7275 7074 6564  'not interrupted
-0001d380: 293a 207b 636f 6c6f 7261 6d61 2e53 7479  ): {colorama.Sty
-0001d390: 6c65 2e42 5249 4748 547d 736b 7920 7374  le.BRIGHT}sky st
-0001d3a0: 6172 7420 2d66 202d 7920 270a 2020 2020  art -f -y '.    
-0001d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3c0: 6627 7b63 6c75 7374 6572 5f6e 616d 657d  f'{cluster_name}
-0001d3d0: 7b63 6f6c 6f72 616d 612e 5374 796c 652e  {colorama.Style.
-0001d3e0: 5245 5345 545f 414c 4c7d 270a 2020 2020  RESET_ALL}'.    
-0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d400: 6627 5c6e 2d2d 2d20 4465 7461 696c 7320  f'\n--- Details 
-0001d410: 2d2d 2d5c 6e7b 7374 6465 7272 2e73 7472  ---\n{stderr.str
-0001d420: 6970 2829 7d5c 6e27 290a                 ip()}\n').
+00017f20: 6572 726f 725f 6d73 677d 7b72 6573 6574  error_msg}{reset
+00017f30: 7d27 290a 2020 2020 6173 7365 7274 2063  }').    assert c
+00017f40: 6c75 7374 6572 5f73 7461 7475 7320 6973  luster_status is
+00017f50: 206e 6f74 204e 6f6e 652c 2027 6861 6e64   not None, 'hand
+00017f60: 6c65 2069 7320 6e6f 7420 4e6f 6e65 2062  le is not None b
+00017f70: 7574 2073 7461 7475 7320 6973 204e 6f6e  ut status is Non
+00017f80: 6527 0a20 2020 2062 6163 6b65 6e64 203d  e'.    backend =
+00017f90: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
+00017fa0: 6d5f 6861 6e64 6c65 2868 616e 646c 6529  m_handle(handle)
+00017fb0: 0a20 2020 2069 6620 6368 6563 6b5f 636c  .    if check_cl
+00017fc0: 6f75 645f 766d 5f72 6179 5f62 6163 6b65  oud_vm_ray_backe
+00017fd0: 6e64 2061 6e64 206e 6f74 2069 7369 6e73  nd and not isins
+00017fe0: 7461 6e63 6528 0a20 2020 2020 2020 2020  tance(.         
+00017ff0: 2020 2062 6163 6b65 6e64 2c20 6261 636b     backend, back
+00018000: 656e 6473 2e43 6c6f 7564 566d 5261 7942  ends.CloudVmRayB
+00018010: 6163 6b65 6e64 293a 0a20 2020 2020 2020  ackend):.       
+00018020: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+00018030: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+00018040: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+00018050: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00018060: 2065 7863 6570 7469 6f6e 732e 4e6f 7453   exceptions.NotS
+00018070: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
+00018080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018090: 277b 636f 6c6f 7261 6d61 2e46 6f72 652e  '{colorama.Fore.
+000180a0: 5945 4c4c 4f57 7d7b 6f70 6572 6174 696f  YELLOW}{operatio
+000180b0: 6e2e 6361 7069 7461 6c69 7a65 2829 7d3a  n.capitalize()}:
+000180c0: 2073 6b69 7070 6564 2066 6f72 2027 0a20   skipped for '. 
+000180d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000180e0: 2763 6c75 7374 6572 207b 636c 7573 7465  'cluster {cluste
+000180f0: 725f 6e61 6d65 2172 7d2e 2049 7420 6973  r_name!r}. It is
+00018100: 206f 6e6c 7920 7375 7070 6f72 7465 6420   only supported 
+00018110: 6279 2062 6163 6b65 6e64 3a20 270a 2020  by backend: '.  
+00018120: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00018130: 7b62 6163 6b65 6e64 732e 436c 6f75 6456  {backends.CloudV
+00018140: 6d52 6179 4261 636b 656e 642e 4e41 4d45  mRayBackend.NAME
+00018150: 7d2e 270a 2020 2020 2020 2020 2020 2020  }.'.            
+00018160: 2020 2020 6627 7b72 6573 6574 7d27 290a      f'{reset}').
+00018170: 2020 2020 6966 2063 6c75 7374 6572 5f73      if cluster_s
+00018180: 7461 7475 7320 213d 2073 7461 7475 735f  tatus != status_
+00018190: 6c69 622e 436c 7573 7465 7253 7461 7475  lib.ClusterStatu
+000181a0: 732e 5550 3a0a 2020 2020 2020 2020 7769  s.UP:.        wi
+000181b0: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
+000181c0: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
+000181d0: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
+000181e0: 2020 2020 2020 2020 6869 6e74 5f66 6f72          hint_for
+000181f0: 5f69 6e69 7420 3d20 2727 0a20 2020 2020  _init = ''.     
+00018200: 2020 2020 2020 2069 6620 636c 7573 7465         if cluste
+00018210: 725f 7374 6174 7573 203d 3d20 7374 6174  r_status == stat
+00018220: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00018230: 6174 7573 2e49 4e49 543a 0a20 2020 2020  atus.INIT:.     
+00018240: 2020 2020 2020 2020 2020 2068 696e 745f             hint_
+00018250: 666f 725f 696e 6974 203d 2028 0a20 2020  for_init = (.   
+00018260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018270: 2066 277b 7265 7365 747d 2057 6169 7420   f'{reset} Wait 
+00018280: 666f 7220 6120 6c61 756e 6368 2074 6f20  for a launch to 
+00018290: 6669 6e69 7368 2c20 6f72 2075 7365 2074  finish, or use t
+000182a0: 6869 7320 636f 6d6d 616e 6420 270a 2020  his command '.  
+000182b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182c0: 2020 6627 746f 2074 7279 2074 6f20 7472    f'to try to tr
+000182d0: 616e 7369 7469 6f6e 2074 6865 2063 6c75  ansition the clu
+000182e0: 7374 6572 2074 6f20 5550 3a20 7b62 7269  ster to UP: {bri
+000182f0: 6768 747d 736b 7920 270a 2020 2020 2020  ght}sky '.      
+00018300: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00018310: 7374 6172 7420 7b63 6c75 7374 6572 5f6e  start {cluster_n
+00018320: 616d 657d 7b72 6573 6574 7d27 290a 2020  ame}{reset}').  
+00018330: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00018340: 6578 6365 7074 696f 6e73 2e43 6c75 7374  exceptions.Clust
+00018350: 6572 4e6f 7455 7045 7272 6f72 280a 2020  erNotUpError(.  
+00018360: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00018370: 7b63 6f6c 6f72 616d 612e 466f 7265 2e59  {colorama.Fore.Y
+00018380: 454c 4c4f 577d 7b6f 7065 7261 7469 6f6e  ELLOW}{operation
+00018390: 2e63 6170 6974 616c 697a 6528 297d 3a20  .capitalize()}: 
+000183a0: 736b 6970 7065 6420 666f 7220 270a 2020  skipped for '.  
+000183b0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000183c0: 636c 7573 7465 7220 7b63 6c75 7374 6572  cluster {cluster
+000183d0: 5f6e 616d 6521 727d 2028 7374 6174 7573  _name!r} (status
+000183e0: 3a20 7b63 6c75 7374 6572 5f73 7461 7475  : {cluster_statu
+000183f0: 732e 7661 6c75 657d 292e 2027 0a20 2020  s.value}). '.   
+00018400: 2020 2020 2020 2020 2020 2020 2027 4974               'It
+00018410: 2069 7320 6f6e 6c79 2061 6c6c 6f77 6564   is only allowed
+00018420: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+00018430: 2020 2020 2020 2066 277b 7374 6174 7573         f'{status
+00018440: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
+00018450: 7573 2e55 502e 7661 6c75 657d 2063 6c75  us.UP.value} clu
+00018460: 7374 6572 732e 270a 2020 2020 2020 2020  sters.'.        
+00018470: 2020 2020 2020 2020 6627 7b68 696e 745f          f'{hint_
+00018480: 666f 725f 696e 6974 7d27 0a20 2020 2020  for_init}'.     
+00018490: 2020 2020 2020 2020 2020 2066 277b 7265             f'{re
+000184a0: 7365 747d 272c 0a20 2020 2020 2020 2020  set}',.         
+000184b0: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
+000184c0: 7461 7475 733d 636c 7573 7465 725f 7374  tatus=cluster_st
+000184d0: 6174 7573 2c0a 2020 2020 2020 2020 2020  atus,.          
+000184e0: 2020 2020 2020 6861 6e64 6c65 3d68 616e        handle=han
+000184f0: 646c 6529 0a0a 2020 2020 6966 2068 616e  dle)..    if han
+00018500: 646c 652e 6865 6164 5f69 7020 6973 204e  dle.head_ip is N
+00018510: 6f6e 653a 0a20 2020 2020 2020 2077 6974  one:.        wit
+00018520: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
+00018530: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
+00018540: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
+00018550: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+00018560: 6570 7469 6f6e 732e 436c 7573 7465 724e  eptions.ClusterN
+00018570: 6f74 5570 4572 726f 7228 0a20 2020 2020  otUpError(.     
+00018580: 2020 2020 2020 2020 2020 2066 2743 6c75             f'Clu
+00018590: 7374 6572 207b 636c 7573 7465 725f 6e61  ster {cluster_na
+000185a0: 6d65 2172 7d20 6861 7320 6265 656e 2073  me!r} has been s
+000185b0: 746f 7070 6564 206f 7220 6e6f 7420 7072  topped or not pr
+000185c0: 6f70 6572 6c79 2027 0a20 2020 2020 2020  operly '.       
+000185d0: 2020 2020 2020 2020 2027 7365 7420 7570           'set up
+000185e0: 2e20 506c 6561 7365 2072 652d 6c61 756e  . Please re-laun
+000185f0: 6368 2069 7420 7769 7468 2060 736b 7920  ch it with `sky 
+00018600: 7374 6172 7460 2e27 2c0a 2020 2020 2020  start`.',.      
+00018610: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00018620: 725f 7374 6174 7573 3d63 6c75 7374 6572  r_status=cluster
+00018630: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
+00018640: 2020 2020 2020 2020 2068 616e 646c 653d           handle=
+00018650: 6861 6e64 6c65 290a 2020 2020 7265 7475  handle).    retu
+00018660: 726e 2068 616e 646c 650a 0a0a 2320 544f  rn handle...# TO
+00018670: 444f 2874 6961 6e29 3a20 5265 6661 6374  DO(tian): Refact
+00018680: 6f72 2074 6f20 636f 6e74 726f 6c6c 6572  or to controller
+00018690: 5f75 7469 6c73 2e20 4375 7272 656e 7420  _utils. Current 
+000186a0: 626c 6f63 6b65 723a 2063 6972 6375 6c61  blocker: circula
+000186b0: 7220 696d 706f 7274 2e0a 6465 6620 6973  r import..def is
+000186c0: 5f63 6f6e 7472 6f6c 6c65 725f 6163 6365  _controller_acce
+000186d0: 7373 6962 6c65 280a 2020 2020 636f 6e74  ssible(.    cont
+000186e0: 726f 6c6c 6572 3a20 636f 6e74 726f 6c6c  roller: controll
+000186f0: 6572 5f75 7469 6c73 2e43 6f6e 7472 6f6c  er_utils.Control
+00018700: 6c65 7273 2c0a 2020 2020 7374 6f70 7065  lers,.    stoppe
+00018710: 645f 6d65 7373 6167 653a 2073 7472 2c0a  d_message: str,.
+00018720: 2020 2020 6e6f 6e5f 6578 6973 7465 6e74      non_existent
+00018730: 5f6d 6573 7361 6765 3a20 4f70 7469 6f6e  _message: Option
+00018740: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00018750: 2020 2020 6578 6974 5f69 665f 6e6f 745f      exit_if_not_
+00018760: 6163 6365 7373 6962 6c65 3a20 626f 6f6c  accessible: bool
+00018770: 203d 2046 616c 7365 2c0a 2920 2d3e 2027   = False,.) -> '
+00018780: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
+00018790: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
+000187a0: 6527 3a0a 2020 2020 2222 2243 6865 636b  e':.    """Check
+000187b0: 2069 6620 7468 6520 6a6f 6273 2f73 6572   if the jobs/ser
+000187c0: 7665 2063 6f6e 7472 6f6c 6c65 7220 6973  ve controller is
+000187d0: 2075 702e 0a0a 2020 2020 5468 6520 636f   up...    The co
+000187e0: 6e74 726f 6c6c 6572 2069 7320 6163 6365  ntroller is acce
+000187f0: 7373 6962 6c65 2077 6865 6e20 6974 2069  ssible when it i
+00018800: 7320 696e 2055 5020 6f72 2049 4e49 5420  s in UP or INIT 
+00018810: 7374 6174 652c 2061 6e64 2074 6865 2073  state, and the s
+00018820: 7368 0a20 2020 2063 6f6e 6e65 6374 696f  sh.    connectio
+00018830: 6e20 6973 2073 7563 6365 7373 6675 6c2e  n is successful.
+00018840: 0a0a 2020 2020 4974 2063 616e 2062 6520  ..    It can be 
+00018850: 7573 6564 2074 6f20 6368 6563 6b20 6966  used to check if
+00018860: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+00018870: 6973 2061 6363 6573 7369 626c 6520 2873  is accessible (s
+00018880: 696e 6365 2074 6865 2061 7574 6f73 746f  ince the autosto
+00018890: 700a 2020 2020 6973 2073 6574 2066 6f72  p.    is set for
+000188a0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7229   the controller)
+000188b0: 2062 6566 6f72 6520 7468 6520 6a6f 6273   before the jobs
+000188c0: 2f73 6572 7665 2063 6f6d 6d61 6e64 7320  /serve commands 
+000188d0: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
+000188e0: 650a 2020 2020 636f 6e74 726f 6c6c 6572  e.    controller
+000188f0: 2e0a 0a20 2020 2043 6c75 7374 6572 4e6f  ...    ClusterNo
+00018900: 7455 7045 7272 6f72 2077 696c 6c20 6265  tUpError will be
+00018910: 2072 6169 7365 6420 7768 656e 6576 6572   raised whenever
+00018920: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+00018930: 6361 6e6e 6f74 2062 6520 6163 6365 7373  cannot be access
+00018940: 6564 2e0a 0a20 2020 2041 7267 733a 0a20  ed...    Args:. 
+00018950: 2020 2020 2020 2074 7970 653a 2054 7970         type: Typ
+00018960: 6520 6f66 2074 6865 2063 6f6e 7472 6f6c  e of the control
+00018970: 6c65 722e 0a20 2020 2020 2020 2073 746f  ler..        sto
+00018980: 7070 6564 5f6d 6573 7361 6765 3a20 4d65  pped_message: Me
+00018990: 7373 6167 6520 746f 2070 7269 6e74 2069  ssage to print i
+000189a0: 6620 7468 6520 636f 6e74 726f 6c6c 6572  f the controller
+000189b0: 2069 7320 5354 4f50 5045 442e 0a20 2020   is STOPPED..   
+000189c0: 2020 2020 206e 6f6e 5f65 7869 7374 656e       non_existen
+000189d0: 745f 6d65 7373 6167 653a 204d 6573 7361  t_message: Messa
+000189e0: 6765 2074 6f20 7368 6f77 2069 6620 7468  ge to show if th
+000189f0: 6520 636f 6e74 726f 6c6c 6572 2064 6f65  e controller doe
+00018a00: 7320 6e6f 7420 6578 6973 742e 0a20 2020  s not exist..   
+00018a10: 2020 2020 2065 7869 745f 6966 5f6e 6f74       exit_if_not
+00018a20: 5f61 6363 6573 7369 626c 653a 2057 6865  _accessible: Whe
+00018a30: 7468 6572 2074 6f20 6578 6974 2064 6972  ther to exit dir
+00018a40: 6563 746c 7920 6966 2074 6865 2063 6f6e  ectly if the con
+00018a50: 7472 6f6c 6c65 7220 6973 206e 6f74 0a20  troller is not. 
+00018a60: 2020 2020 2020 2020 2061 6363 6573 7369           accessi
+00018a70: 626c 652e 2049 6620 4661 6c73 652c 2074  ble. If False, t
+00018a80: 6865 2066 756e 6374 696f 6e20 7769 6c6c  he function will
+00018a90: 2072 6169 7365 2043 6c75 7374 6572 4e6f   raise ClusterNo
+00018aa0: 7455 7045 7272 6f72 2e0a 0a20 2020 2052  tUpError...    R
+00018ab0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00018ac0: 6861 6e64 6c65 3a20 5468 6520 5265 736f  handle: The Reso
+00018ad0: 7572 6365 4861 6e64 6c65 206f 6620 7468  urceHandle of th
+00018ae0: 6520 636f 6e74 726f 6c6c 6572 2e0a 0a20  e controller... 
+00018af0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
+00018b00: 2020 2065 7863 6570 7469 6f6e 732e 436c     exceptions.Cl
+00018b10: 7573 7465 724f 776e 6572 4964 656e 7469  usterOwnerIdenti
+00018b20: 7479 4d69 736d 6174 6368 4572 726f 723a  tyMismatchError:
+00018b30: 2069 6620 7468 6520 6375 7272 656e 7420   if the current 
+00018b40: 7573 6572 2069 7320 6e6f 740a 2020 2020  user is not.    
+00018b50: 2020 2020 2020 7468 6520 7361 6d65 2061        the same a
+00018b60: 7320 7468 6520 7573 6572 2077 686f 2063  s the user who c
+00018b70: 7265 6174 6564 2074 6865 2063 6c75 7374  reated the clust
+00018b80: 6572 2e0a 2020 2020 2020 2020 6578 6365  er..        exce
+00018b90: 7074 696f 6e73 2e43 6c6f 7564 5573 6572  ptions.CloudUser
+00018ba0: 4964 656e 7469 7479 4572 726f 723a 2069  IdentityError: i
+00018bb0: 6620 7765 2066 6169 6c20 746f 2067 6574  f we fail to get
+00018bc0: 2074 6865 2063 7572 7265 6e74 2075 7365   the current use
+00018bd0: 720a 2020 2020 2020 2020 2020 6964 656e  r.          iden
+00018be0: 7469 7479 2e0a 2020 2020 2020 2020 6578  tity..        ex
+00018bf0: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
+00018c00: 4e6f 7455 7045 7272 6f72 3a20 6966 2074  NotUpError: if t
+00018c10: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+00018c20: 206e 6f74 2061 6363 6573 7369 626c 652c   not accessible,
+00018c30: 206f 720a 2020 2020 2020 2020 2020 6661   or.          fa
+00018c40: 696c 6564 2074 6f20 6265 2063 6f6e 6e65  iled to be conne
+00018c50: 6374 6564 2e0a 2020 2020 2222 220a 2020  cted..    """.  
+00018c60: 2020 6966 206e 6f6e 5f65 7869 7374 656e    if non_existen
+00018c70: 745f 6d65 7373 6167 6520 6973 204e 6f6e  t_message is Non
+00018c80: 653a 0a20 2020 2020 2020 206e 6f6e 5f65  e:.        non_e
+00018c90: 7869 7374 656e 745f 6d65 7373 6167 6520  xistent_message 
+00018ca0: 3d20 636f 6e74 726f 6c6c 6572 2e76 616c  = controller.val
+00018cb0: 7565 2e64 6566 6175 6c74 5f68 696e 745f  ue.default_hint_
+00018cc0: 6966 5f6e 6f6e 5f65 7869 7374 656e 740a  if_non_existent.
+00018cd0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00018ce0: 203d 2063 6f6e 7472 6f6c 6c65 722e 7661   = controller.va
+00018cf0: 6c75 652e 636c 7573 7465 725f 6e61 6d65  lue.cluster_name
+00018d00: 0a20 2020 206e 6565 645f 636f 6e6e 6563  .    need_connec
+00018d10: 7469 6f6e 5f63 6865 636b 203d 2046 616c  tion_check = Fal
+00018d20: 7365 0a20 2020 2063 6f6e 7472 6f6c 6c65  se.    controlle
+00018d30: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
+00018d40: 203d 204e 6f6e 652c 204e 6f6e 650a 2020   = None, None.  
+00018d50: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
+00018d60: 2053 6574 2066 6f72 6365 5f72 6566 7265   Set force_refre
+00018d70: 7368 5f73 7461 7475 7365 733d 5b49 4e49  sh_statuses=[INI
+00018d80: 545d 2074 6f20 6d61 6b65 2073 7572 6520  T] to make sure 
+00018d90: 7468 6520 7265 6672 6573 6820 6861 7070  the refresh happ
+00018da0: 656e 730a 2020 2020 2020 2020 2320 7768  ens.        # wh
+00018db0: 656e 2074 6865 2063 6f6e 7472 6f6c 6c65  en the controlle
+00018dc0: 7220 6973 2049 4e49 542f 5550 2028 7472  r is INIT/UP (tr
+00018dd0: 6967 6765 7265 6420 696e 2074 6865 7365  iggered in these
+00018de0: 2073 7461 7475 7365 7320 6173 2074 6865   statuses as the
+00018df0: 0a20 2020 2020 2020 2023 2061 7574 6f73  .        # autos
+00018e00: 746f 7020 6973 2061 6c77 6179 7320 7365  top is always se
+00018e10: 7420 666f 7220 7468 6520 636f 6e74 726f  t for the contro
+00018e20: 6c6c 6572 292e 2054 6865 2063 6f6e 7472  ller). The contr
+00018e30: 6f6c 6c65 7220 6361 6e20 6265 2069 6e0a  oller can be in.
+00018e40: 2020 2020 2020 2020 2320 666f 6c6c 6f77          # follow
+00018e50: 696e 6720 6361 7365 733a 0a20 2020 2020  ing cases:.     
+00018e60: 2020 2023 202a 2028 5550 2c20 6175 746f     # * (UP, auto
+00018e70: 7374 6f70 2073 6574 293a 2069 7420 7769  stop set): it wi
+00018e80: 6c6c 2062 6520 7265 6672 6573 6865 6420  ll be refreshed 
+00018e90: 7769 7468 6f75 7420 666f 7263 655f 7265  without force_re
+00018ea0: 6672 6573 6820 7365 742e 0a20 2020 2020  fresh set..     
+00018eb0: 2020 2023 202a 2028 5550 2c20 6e6f 2061     # * (UP, no a
+00018ec0: 7574 6f73 746f 7029 3a20 7665 7279 2072  utostop): very r
+00018ed0: 6172 6520 2861 2075 7365 7220 6374 726c  are (a user ctrl
+00018ee0: 2d63 2077 6865 6e20 7468 6520 636f 6e74  -c when the cont
+00018ef0: 726f 6c6c 6572 2069 730a 2020 2020 2020  roller is.      
+00018f00: 2020 2320 2020 6c61 756e 6368 696e 6729    #   launching)
+00018f10: 2c20 646f 6573 206e 6f74 206d 6174 7465  , does not matte
+00018f20: 7220 6966 2072 6566 7265 7368 206f 7220  r if refresh or 
+00018f30: 6e6f 742c 2073 696e 6365 206e 6f20 6175  not, since no au
+00018f40: 746f 7374 6f70 2e20 5765 0a20 2020 2020  tostop. We.     
+00018f50: 2020 2023 2020 2064 6f6e 2774 2069 6e63     #   don't inc
+00018f60: 6c75 6465 2055 5020 696e 2066 6f72 6365  lude UP in force
+00018f70: 5f72 6566 7265 7368 5f73 7461 7475 7365  _refresh_statuse
+00018f80: 7320 746f 2061 766f 6964 206f 7665 7268  s to avoid overh
+00018f90: 6561 6473 2e0a 2020 2020 2020 2020 2320  eads..        # 
+00018fa0: 2a20 2849 4e49 542c 2061 7574 6f73 746f  * (INIT, autosto
+00018fb0: 7020 7365 7429 0a20 2020 2020 2020 2023  p set).        #
+00018fc0: 202a 2028 494e 4954 2c20 6e6f 2061 7574   * (INIT, no aut
+00018fd0: 6f73 746f 7029 3a20 7665 7279 2072 6172  ostop): very rar
+00018fe0: 6520 285f 7570 6461 7465 5f63 6c75 7374  e (_update_clust
+00018ff0: 6572 5f73 7461 7475 735f 6e6f 5f6c 6f63  er_status_no_loc
+00019000: 6b20 6d61 790a 2020 2020 2020 2020 2320  k may.        # 
+00019010: 2020 7265 7365 7420 6c6f 6361 6c20 6175    reset local au
+00019020: 746f 7374 6f70 2063 6f6e 6669 6729 2c20  tostop config), 
+00019030: 6275 7420 666f 7263 655f 7265 6672 6573  but force_refres
+00019040: 6820 7769 6c6c 206d 616b 6520 7375 7265  h will make sure
+00019050: 0a20 2020 2020 2020 2023 2020 2073 7461  .        #   sta
+00019060: 7475 7320 6973 2072 6566 7265 7368 6564  tus is refreshed
+00019070: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
+00019080: 2020 2020 2320 5765 2061 766f 6964 7320      # We avoids 
+00019090: 756e 6e65 6365 7373 6172 7920 636f 7374  unnecessary cost
+000190a0: 6c79 2072 6566 7265 7368 2077 6865 6e20  ly refresh when 
+000190b0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
+000190c0: 7320 616c 7265 6164 790a 2020 2020 2020  s already.      
+000190d0: 2020 2320 5354 4f50 5045 442e 2054 6869    # STOPPED. Thi
+000190e0: 7320 6f70 7469 6d69 7a61 7469 6f6e 2069  s optimization i
+000190f0: 7320 6261 7365 6420 6f6e 2074 6865 2061  s based on the a
+00019100: 7373 756d 7074 696f 6e20 7468 6174 2074  ssumption that t
+00019110: 6865 2075 7365 720a 2020 2020 2020 2020  he user.        
+00019120: 2320 7769 6c6c 206e 6f74 2073 7461 7274  # will not start
+00019130: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+00019140: 6d61 6e75 616c 6c79 2066 726f 6d20 7468  manually from th
+00019150: 6520 636c 6f75 6420 636f 6e73 6f6c 652e  e cloud console.
+00019160: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00019170: 2020 2023 2054 6865 2061 6371 7569 7265     # The acquire
+00019180: 5f6c 6f63 6b5f 7469 6d65 6f75 7420 6973  _lock_timeout is
+00019190: 2073 6574 2074 6f20 3020 746f 2061 766f   set to 0 to avo
+000191a0: 6964 2068 616e 6769 6e67 2074 6865 2063  id hanging the c
+000191b0: 6f6d 6d61 6e64 2077 6865 6e0a 2020 2020  ommand when.    
+000191c0: 2020 2020 2320 6d75 6c74 6970 6c65 206a      # multiple j
+000191d0: 6f62 732e 6c61 756e 6368 2063 6f6d 6d61  obs.launch comma
+000191e0: 6e64 7320 6172 6520 7275 6e6e 696e 6720  nds are running 
+000191f0: 6174 2074 6865 2073 616d 6520 7469 6d65  at the same time
+00019200: 2e20 4f75 7220 6c61 7465 720a 2020 2020  . Our later.    
+00019210: 2020 2020 2320 636f 6465 2077 696c 6c20      # code will 
+00019220: 6368 6563 6b20 6966 2074 6865 2063 6f6e  check if the con
+00019230: 7472 6f6c 6c65 7220 6973 2061 6363 6573  troller is acces
+00019240: 7369 626c 6520 6279 2064 6972 6563 746c  sible by directl
+00019250: 7920 6368 6563 6b69 6e67 0a20 2020 2020  y checking.     
+00019260: 2020 2023 2074 6865 2073 7368 2063 6f6e     # the ssh con
+00019270: 6e65 6374 696f 6e20 746f 2074 6865 2063  nection to the c
+00019280: 6f6e 7472 6f6c 6c65 722c 2069 6620 6974  ontroller, if it
+00019290: 2066 6169 6c73 2074 6f20 6765 7420 6163   fails to get ac
+000192a0: 6375 7261 7465 0a20 2020 2020 2020 2023  curate.        #
+000192b0: 2073 7461 7475 7320 6f66 2074 6865 2063   status of the c
+000192c0: 6f6e 7472 6f6c 6c65 722e 0a20 2020 2020  ontroller..     
+000192d0: 2020 2063 6f6e 7472 6f6c 6c65 725f 7374     controller_st
+000192e0: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
+000192f0: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
+00019300: 7461 7475 735f 6861 6e64 6c65 280a 2020  tatus_handle(.  
+00019310: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00019320: 725f 6e61 6d65 2c0a 2020 2020 2020 2020  r_name,.        
+00019330: 2020 2020 666f 7263 655f 7265 6672 6573      force_refres
+00019340: 685f 7374 6174 7573 6573 3d5b 7374 6174  h_statuses=[stat
+00019350: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00019360: 6174 7573 2e49 4e49 545d 2c0a 2020 2020  atus.INIT],.    
+00019370: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+00019380: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
+00019390: 6f75 743d 3029 0a20 2020 2065 7863 6570  out=0).    excep
+000193a0: 7420 6578 6365 7074 696f 6e73 2e43 6c75  t exceptions.Clu
+000193b0: 7374 6572 5374 6174 7573 4665 7463 6869  sterStatusFetchi
+000193c0: 6e67 4572 726f 7220 6173 2065 3a0a 2020  ngError as e:.  
+000193d0: 2020 2020 2020 2320 5765 2064 6f20 6e6f        # We do no
+000193e0: 7420 6361 7463 6820 7468 6520 6578 6365  t catch the exce
+000193f0: 7074 696f 6e73 2072 656c 6174 6564 2074  ptions related t
+00019400: 6f20 7468 6520 636c 7573 7465 7220 6f77  o the cluster ow
+00019410: 6e65 7220 6964 656e 7469 7479 0a20 2020  ner identity.   
+00019420: 2020 2020 2023 206d 6973 6d61 7463 682c       # mismatch,
+00019430: 2070 6c65 6173 6520 7265 6665 7220 746f   please refer to
+00019440: 2074 6865 2063 6f6d 6d65 6e74 2069 6e0a   the comment in.
+00019450: 2020 2020 2020 2020 2320 6062 6163 6b65          # `backe
+00019460: 6e64 5f75 7469 6c73 2e63 6865 636b 5f63  nd_utils.check_c
+00019470: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
+00019480: 602e 0a20 2020 2020 2020 2063 6f6e 7472  `..        contr
+00019490: 6f6c 6c65 725f 6e61 6d65 203d 2063 6f6e  oller_name = con
+000194a0: 7472 6f6c 6c65 722e 7661 6c75 652e 6e61  troller.value.na
+000194b0: 6d65 2e72 6570 6c61 6365 2827 2063 6f6e  me.replace(' con
+000194c0: 7472 6f6c 6c65 7227 2c20 2727 290a 2020  troller', '').  
+000194d0: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+000194e0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+000194f0: 2020 2746 6169 6c65 6420 746f 2067 6574    'Failed to get
+00019500: 2074 6865 2073 7461 7475 7320 6f66 2074   the status of t
+00019510: 6865 2063 6f6e 7472 6f6c 6c65 722e 2049  he controller. I
+00019520: 7420 6973 206e 6f74 2027 0a20 2020 2020  t is not '.     
+00019530: 2020 2020 2020 2066 2766 6174 616c 2c20         f'fatal, 
+00019540: 6275 7420 7b63 6f6e 7472 6f6c 6c65 725f  but {controller_
+00019550: 6e61 6d65 7d20 636f 6d6d 616e 6473 2f63  name} commands/c
+00019560: 616c 6c73 206d 6179 2068 616e 6720 6f72  alls may hang or
+00019570: 2072 6574 7572 6e20 270a 2020 2020 2020   return '.      
+00019580: 2020 2020 2020 2773 7461 6c65 2069 6e66        'stale inf
+00019590: 6f72 6d61 7469 6f6e 2c20 7768 656e 2074  ormation, when t
+000195a0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+000195b0: 206e 6f74 2075 702e 5c6e 270a 2020 2020   not up.\n'.    
+000195c0: 2020 2020 2020 2020 6627 2020 4465 7461          f'  Deta
+000195d0: 696c 733a 207b 636f 6d6d 6f6e 5f75 7469  ils: {common_uti
+000195e0: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+000195f0: 696f 6e28 652c 2075 7365 5f62 7261 636b  ion(e, use_brack
+00019600: 6574 3d54 7275 6529 7d27 290a 2020 2020  et=True)}').    
+00019610: 2020 2020 7265 636f 7264 203d 2067 6c6f      record = glo
+00019620: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+00019630: 6574 5f63 6c75 7374 6572 5f66 726f 6d5f  et_cluster_from_
+00019640: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00019650: 6529 0a20 2020 2020 2020 2069 6620 7265  e).        if re
+00019660: 636f 7264 2069 7320 6e6f 7420 4e6f 6e65  cord is not None
+00019670: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00019680: 6e74 726f 6c6c 6572 5f73 7461 7475 732c  ntroller_status,
+00019690: 2068 616e 646c 6520 3d20 7265 636f 7264   handle = record
+000196a0: 5b27 7374 6174 7573 275d 2c20 7265 636f  ['status'], reco
+000196b0: 7264 5b27 6861 6e64 6c65 275d 0a20 2020  rd['handle'].   
+000196c0: 2020 2020 2020 2020 2023 2057 6520 6368           # We ch
+000196d0: 6563 6b20 7468 6520 636f 6e6e 6563 7469  eck the connecti
+000196e0: 6f6e 2065 7665 6e20 6966 2074 6865 2063  on even if the c
+000196f0: 6c75 7374 6572 2068 6173 2061 2063 6163  luster has a cac
+00019700: 6865 6420 7374 6174 7573 2055 500a 2020  hed status UP.  
+00019710: 2020 2020 2020 2020 2020 2320 746f 206d            # to m
+00019720: 616b 6520 7375 7265 2074 6865 2063 6f6e  ake sure the con
+00019730: 7472 6f6c 6c65 7220 6973 2061 6374 7561  troller is actua
+00019740: 6c6c 7920 6163 6365 7373 6962 6c65 2c20  lly accessible, 
+00019750: 6173 2074 6865 2063 6163 6865 640a 2020  as the cached.  
+00019760: 2020 2020 2020 2020 2020 2320 7374 6174            # stat
+00019770: 7573 206d 6967 6874 2062 6520 7374 616c  us might be stal
+00019780: 652e 0a20 2020 2020 2020 2020 2020 206e  e..            n
+00019790: 6565 645f 636f 6e6e 6563 7469 6f6e 5f63  eed_connection_c
+000197a0: 6865 636b 203d 2054 7275 650a 0a20 2020  heck = True..   
+000197b0: 2065 7272 6f72 5f6d 7367 203d 204e 6f6e   error_msg = Non
+000197c0: 650a 2020 2020 6966 2063 6f6e 7472 6f6c  e.    if control
+000197d0: 6c65 725f 7374 6174 7573 203d 3d20 7374  ler_status == st
+000197e0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
+000197f0: 5374 6174 7573 2e53 544f 5050 4544 3a0a  Status.STOPPED:.
+00019800: 2020 2020 2020 2020 6572 726f 725f 6d73          error_ms
+00019810: 6720 3d20 7374 6f70 7065 645f 6d65 7373  g = stopped_mess
+00019820: 6167 650a 2020 2020 656c 6966 2063 6f6e  age.    elif con
+00019830: 7472 6f6c 6c65 725f 7374 6174 7573 2069  troller_status i
+00019840: 7320 4e6f 6e65 206f 7220 6861 6e64 6c65  s None or handle
+00019850: 2069 7320 4e6f 6e65 206f 7220 6861 6e64   is None or hand
+00019860: 6c65 2e68 6561 645f 6970 2069 7320 4e6f  le.head_ip is No
+00019870: 6e65 3a0a 2020 2020 2020 2020 2320 5765  ne:.        # We
+00019880: 2063 6865 636b 2074 6865 2063 6f6e 7472   check the contr
+00019890: 6f6c 6c65 7220 6973 2053 544f 5050 4544  oller is STOPPED
+000198a0: 2062 6566 6f72 6520 7468 6520 6368 6563   before the chec
+000198b0: 6b20 666f 7220 6861 6e64 6c65 2e68 6561  k for handle.hea
+000198c0: 645f 6970 0a20 2020 2020 2020 2023 204e  d_ip.        # N
+000198d0: 6f6e 6520 6265 6361 7573 6520 7768 656e  one because when
+000198e0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+000198f0: 6973 2053 544f 5050 4544 2c20 6861 6e64  is STOPPED, hand
+00019900: 6c65 2e68 6561 645f 6970 2063 616e 2061  le.head_ip can a
+00019910: 6c73 6f0a 2020 2020 2020 2020 2320 6265  lso.        # be
+00019920: 204e 6f6e 652c 2062 7574 2077 6520 6f6e   None, but we on
+00019930: 6c79 2077 616e 7420 746f 2063 6174 6368  ly want to catch
+00019940: 2074 6865 2063 6173 6520 7768 656e 2074   the case when t
+00019950: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+00019960: 0a20 2020 2020 2020 2023 2062 6569 6e67  .        # being
+00019970: 2070 726f 7669 7369 6f6e 6564 2061 7420   provisioned at 
+00019980: 7468 6520 6669 7273 7420 7469 6d65 2061  the first time a
+00019990: 6e64 2068 6176 6520 6e6f 2068 6561 645f  nd have no head_
+000199a0: 6970 2e0a 2020 2020 2020 2020 6572 726f  ip..        erro
+000199b0: 725f 6d73 6720 3d20 6e6f 6e5f 6578 6973  r_msg = non_exis
+000199c0: 7465 6e74 5f6d 6573 7361 6765 0a20 2020  tent_message.   
+000199d0: 2065 6c69 6620 2863 6f6e 7472 6f6c 6c65   elif (controlle
+000199e0: 725f 7374 6174 7573 203d 3d20 7374 6174  r_status == stat
+000199f0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00019a00: 6174 7573 2e49 4e49 5420 6f72 0a20 2020  atus.INIT or.   
+00019a10: 2020 2020 2020 206e 6565 645f 636f 6e6e         need_conn
+00019a20: 6563 7469 6f6e 5f63 6865 636b 293a 0a20  ection_check):. 
+00019a30: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
+00019a40: 7368 2063 6f6e 6e65 6374 696f 6e20 6966  sh connection if
+00019a50: 2028 3129 2063 6f6e 7472 6f6c 6c65 7220   (1) controller 
+00019a60: 6973 2069 6e20 494e 4954 2073 7461 7465  is in INIT state
+00019a70: 2c20 6f72 2028 3229 2077 6520 6661 696c  , or (2) we fail
+00019a80: 6564 2074 6f20 6665 7463 6820 7468 650a  ed to fetch the.
+00019a90: 2020 2020 2020 2020 2320 7374 6174 7573          # status
+00019aa0: 2c20 626f 7468 206f 6620 7768 6963 6820  , both of which 
+00019ab0: 6361 6e20 6861 7070 656e 2077 6865 6e20  can happen when 
+00019ac0: 636f 6e74 726f 6c6c 6572 2773 2073 7461  controller's sta
+00019ad0: 7475 7320 6c6f 636b 2069 7320 6865 6c64  tus lock is held
+00019ae0: 2062 7920 616e 6f74 6865 7220 6073 6b79   by another `sky
+00019af0: 206a 6f62 7320 6c61 756e 6368 6020 6f72   jobs launch` or
+00019b00: 0a20 2020 2020 2020 2023 2060 736b 7920  .        # `sky 
+00019b10: 7365 7276 6520 7570 602e 2049 6620 7765  serve up`. If we
+00019b20: 2068 6176 65c2 a063 6f6e 7472 6f6c 6c65   have..controlle
+00019b30: 7227 7320 6865 6164 5f69 7020 6176 6169  r's head_ip avai
+00019b40: 6c61 626c 6520 616e 6420 6974 2069 7320  lable and it is 
+00019b50: 7373 682d 7265 6163 6861 626c 652c 0a20  ssh-reachable,. 
+00019b60: 2020 2020 2020 2023 2077 6520 6361 6e20         # we can 
+00019b70: 616c 6c6f 7720 6163 6365 7373 2074 6f20  allow access to 
+00019b80: 7468 6520 636f 6e74 726f 6c6c 6572 2e0a  the controller..
+00019b90: 2020 2020 2020 2020 7373 685f 6372 6564          ssh_cred
+00019ba0: 656e 7469 616c 7320 3d20 7373 685f 6372  entials = ssh_cr
+00019bb0: 6564 656e 7469 616c 5f66 726f 6d5f 7961  edential_from_ya
+00019bc0: 6d6c 2868 616e 646c 652e 636c 7573 7465  ml(handle.cluste
+00019bd0: 725f 7961 6d6c 2c0a 2020 2020 2020 2020  r_yaml,.        
+00019be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c00: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+00019c10: 652e 646f 636b 6572 5f75 7365 722c 0a20  e.docker_user,. 
+00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c50: 2020 6861 6e64 6c65 2e73 7368 5f75 7365    handle.ssh_use
+00019c60: 7229 0a0a 2020 2020 2020 2020 7275 6e6e  r)..        runn
+00019c70: 6572 203d 2063 6f6d 6d61 6e64 5f72 756e  er = command_run
+00019c80: 6e65 722e 5353 4843 6f6d 6d61 6e64 5275  ner.SSHCommandRu
+00019c90: 6e6e 6572 2868 616e 646c 652e 6865 6164  nner(handle.head
+00019ca0: 5f69 702c 0a20 2020 2020 2020 2020 2020  _ip,.           
+00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cd0: 2020 2020 2020 2a2a 7373 685f 6372 6564        **ssh_cred
+00019ce0: 656e 7469 616c 732c 0a20 2020 2020 2020  entials,.       
+00019cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d10: 2020 2020 2020 2020 2020 706f 7274 3d68            port=h
+00019d20: 616e 646c 652e 6865 6164 5f73 7368 5f70  andle.head_ssh_p
+00019d30: 6f72 7429 0a20 2020 2020 2020 2069 6620  ort).        if 
+00019d40: 6e6f 7420 7275 6e6e 6572 2e63 6865 636b  not runner.check
+00019d50: 5f63 6f6e 6e65 6374 696f 6e28 293a 0a20  _connection():. 
+00019d60: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+00019d70: 5f6d 7367 203d 2063 6f6e 7472 6f6c 6c65  _msg = controlle
+00019d80: 722e 7661 6c75 652e 636f 6e6e 6563 7469  r.value.connecti
+00019d90: 6f6e 5f65 7272 6f72 5f68 696e 740a 2020  on_error_hint.  
+00019da0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019db0: 6173 7365 7274 2063 6f6e 7472 6f6c 6c65  assert controlle
+00019dc0: 725f 7374 6174 7573 203d 3d20 7374 6174  r_status == stat
+00019dd0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00019de0: 6174 7573 2e55 502c 2068 616e 646c 650a  atus.UP, handle.
+00019df0: 0a20 2020 2069 6620 6572 726f 725f 6d73  .    if error_ms
+00019e00: 6720 6973 206e 6f74 204e 6f6e 653a 0a20  g is not None:. 
+00019e10: 2020 2020 2020 2069 6620 6578 6974 5f69         if exit_i
+00019e20: 665f 6e6f 745f 6163 6365 7373 6962 6c65  f_not_accessible
+00019e30: 3a0a 2020 2020 2020 2020 2020 2020 736b  :.            sk
+00019e40: 795f 6c6f 6767 696e 672e 7072 696e 7428  y_logging.print(
+00019e50: 6572 726f 725f 6d73 6729 0a20 2020 2020  error_msg).     
+00019e60: 2020 2020 2020 2073 7973 2e65 7869 7428         sys.exit(
+00019e70: 3129 0a20 2020 2020 2020 2077 6974 6820  1).        with 
+00019e80: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+00019e90: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+00019ea0: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+00019eb0: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+00019ec0: 7469 6f6e 732e 436c 7573 7465 724e 6f74  tions.ClusterNot
+00019ed0: 5570 4572 726f 7228 6572 726f 725f 6d73  UpError(error_ms
+00019ee0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+00019ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f10: 2020 636c 7573 7465 725f 7374 6174 7573    cluster_status
+00019f20: 3d63 6f6e 7472 6f6c 6c65 725f 7374 6174  =controller_stat
+00019f30: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
+00019f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f60: 2020 2068 616e 646c 653d 6861 6e64 6c65     handle=handle
+00019f70: 290a 2020 2020 6173 7365 7274 2068 616e  ).    assert han
+00019f80: 646c 6520 6973 206e 6f74 204e 6f6e 6520  dle is not None 
+00019f90: 616e 6420 6861 6e64 6c65 2e68 6561 645f  and handle.head_
+00019fa0: 6970 2069 7320 6e6f 7420 4e6f 6e65 2c20  ip is not None, 
+00019fb0: 280a 2020 2020 2020 2020 6861 6e64 6c65  (.        handle
+00019fc0: 2c20 636f 6e74 726f 6c6c 6572 5f73 7461  , controller_sta
+00019fd0: 7475 7329 0a20 2020 2072 6574 7572 6e20  tus).    return 
+00019fe0: 6861 6e64 6c65 0a0a 0a63 6c61 7373 2043  handle...class C
+00019ff0: 6c6f 7564 4669 6c74 6572 2865 6e75 6d2e  loudFilter(enum.
+0001a000: 456e 756d 293a 0a20 2020 2023 2046 696c  Enum):.    # Fil
+0001a010: 7465 7220 666f 7220 616c 6c20 7479 7065  ter for all type
+0001a020: 7320 6f66 2063 6c6f 7564 732e 0a20 2020  s of clouds..   
+0001a030: 2041 4c4c 203d 2027 616c 6c27 0a20 2020   ALL = 'all'.   
+0001a040: 2023 2046 696c 7465 7220 666f 7220 536b   # Filter for Sk
+0001a050: 7927 7320 6d61 696e 2063 6c6f 7564 7320  y's main clouds 
+0001a060: 2861 7773 2c20 6763 702c 2061 7a75 7265  (aws, gcp, azure
+0001a070: 2c20 646f 636b 6572 292e 0a20 2020 2043  , docker)..    C
+0001a080: 4c4f 5544 535f 414e 445f 444f 434b 4552  LOUDS_AND_DOCKER
+0001a090: 203d 2027 636c 6f75 6473 2d61 6e64 2d64   = 'clouds-and-d
+0001a0a0: 6f63 6b65 7227 0a20 2020 2023 2046 696c  ocker'.    # Fil
+0001a0b0: 7465 7220 666f 7220 6f6e 6c79 206c 6f63  ter for only loc
+0001a0c0: 616c 2063 6c6f 7564 732e 0a20 2020 204c  al clouds..    L
+0001a0d0: 4f43 414c 203d 2027 6c6f 6361 6c27 0a0a  OCAL = 'local'..
+0001a0e0: 0a64 6566 2067 6574 5f63 6c75 7374 6572  .def get_cluster
+0001a0f0: 7328 0a20 2020 2069 6e63 6c75 6465 5f63  s(.    include_c
+0001a100: 6f6e 7472 6f6c 6c65 723a 2062 6f6f 6c2c  ontroller: bool,
+0001a110: 0a20 2020 2072 6566 7265 7368 3a20 626f  .    refresh: bo
+0001a120: 6f6c 2c0a 2020 2020 636c 7573 7465 725f  ol,.    cluster_
+0001a130: 6e61 6d65 733a 204f 7074 696f 6e61 6c5b  names: Optional[
+0001a140: 556e 696f 6e5b 7374 722c 204c 6973 745b  Union[str, List[
+0001a150: 7374 725d 5d5d 203d 204e 6f6e 652c 0a29  str]]] = None,.)
+0001a160: 202d 3e20 4c69 7374 5b44 6963 745b 7374   -> List[Dict[st
+0001a170: 722c 2041 6e79 5d5d 3a0a 2020 2020 2222  r, Any]]:.    ""
+0001a180: 2252 6574 7572 6e73 2061 206c 6973 7420  "Returns a list 
+0001a190: 6f66 2063 6163 6865 6420 6f72 206f 7074  of cached or opt
+0001a1a0: 696f 6e61 6c6c 7920 7265 6672 6573 6865  ionally refreshe
+0001a1b0: 6420 636c 7573 7465 7220 7265 636f 7264  d cluster record
+0001a1c0: 732e 0a0a 2020 2020 436f 6d62 7320 7468  s...    Combs th
+0001a1d0: 726f 7567 6820 7468 6520 6461 7461 6261  rough the databa
+0001a1e0: 7365 2028 696e 207e 2f2e 736b 792f 7374  se (in ~/.sky/st
+0001a1f0: 6174 652e 6462 2920 746f 2067 6574 2061  ate.db) to get a
+0001a200: 206c 6973 7420 6f66 2072 6563 6f72 6473   list of records
+0001a210: 0a20 2020 2063 6f72 7265 7370 6f6e 6469  .    correspondi
+0001a220: 6e67 2074 6f20 6c61 756e 6368 6564 2063  ng to launched c
+0001a230: 6c75 7374 6572 7320 2866 696c 7465 7265  lusters (filtere
+0001a240: 6420 6279 2060 636c 7573 7465 725f 6e61  d by `cluster_na
+0001a250: 6d65 7360 2069 6620 6974 2069 730a 2020  mes` if it is.  
+0001a260: 2020 7370 6563 6966 6965 6429 2e20 5468    specified). Th
+0001a270: 6520 7265 6672 6573 6820 666c 6167 2063  e refresh flag c
+0001a280: 616e 2062 6520 7573 6564 2074 6f20 666f  an be used to fo
+0001a290: 7263 6520 6120 7265 6672 6573 6820 6f66  rce a refresh of
+0001a2a0: 2074 6865 2073 7461 7475 730a 2020 2020   the status.    
+0001a2b0: 6f66 2074 6865 2063 6c75 7374 6572 732e  of the clusters.
+0001a2c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001a2d0: 2020 2020 696e 636c 7564 655f 636f 6e74      include_cont
+0001a2e0: 726f 6c6c 6572 3a20 5768 6574 6865 7220  roller: Whether 
+0001a2f0: 746f 2069 6e63 6c75 6465 2063 6f6e 7472  to include contr
+0001a300: 6f6c 6c65 7273 2c20 652e 672e 206a 6f62  ollers, e.g. job
+0001a310: 7320 636f 6e74 726f 6c6c 6572 0a20 2020  s controller.   
+0001a320: 2020 2020 2020 2020 206f 7220 736b 7920           or sky 
+0001a330: 7365 7276 6520 636f 6e74 726f 6c6c 6572  serve controller
+0001a340: 2e0a 2020 2020 2020 2020 7265 6672 6573  ..        refres
+0001a350: 683a 2057 6865 7468 6572 2074 6f20 7265  h: Whether to re
+0001a360: 6672 6573 6820 7468 6520 7374 6174 7573  fresh the status
+0001a370: 206f 6620 7468 6520 636c 7573 7465 7273   of the clusters
+0001a380: 2e20 2852 6566 7265 7368 696e 6720 7769  . (Refreshing wi
+0001a390: 6c6c 0a20 2020 2020 2020 2020 2020 2073  ll.            s
+0001a3a0: 6574 2074 6865 2073 7461 7475 7320 746f  et the status to
+0001a3b0: 2053 544f 5050 4544 2069 6620 7468 6520   STOPPED if the 
+0001a3c0: 636c 7573 7465 7220 6361 6e6e 6f74 2062  cluster cannot b
+0001a3d0: 6520 7069 6e67 6564 2e29 0a20 2020 2020  e pinged.).     
+0001a3e0: 2020 2063 6c6f 7564 5f66 696c 7465 723a     cloud_filter:
+0001a3f0: 2053 6574 7320 7768 6963 6820 636c 6f75   Sets which clou
+0001a400: 6473 2074 6f20 6669 6c65 7220 7468 726f  ds to filer thro
+0001a410: 7567 6820 6672 6f6d 2074 6865 2067 6c6f  ugh from the glo
+0001a420: 6261 6c20 7573 6572 0a20 2020 2020 2020  bal user.       
+0001a430: 2020 2020 2073 7461 7465 2e20 5375 7070       state. Supp
+0001a440: 6f72 7473 2074 6872 6565 2076 616c 7565  orts three value
+0001a450: 732c 2027 616c 6c27 2066 6f72 2061 6c6c  s, 'all' for all
+0001a460: 2063 6c6f 7564 732c 2027 7075 626c 6963   clouds, 'public
+0001a470: 2720 666f 720a 2020 2020 2020 2020 2020  ' for.          
+0001a480: 2020 7075 626c 6963 2063 6c6f 7564 7320    public clouds 
+0001a490: 6f6e 6c79 2c20 616e 6420 276c 6f63 616c  only, and 'local
+0001a4a0: 2720 666f 7220 6f6e 6c79 206c 6f63 616c  ' for only local
+0001a4b0: 2063 6c6f 7564 732e 0a20 2020 2020 2020   clouds..       
+0001a4c0: 2063 6c75 7374 6572 5f6e 616d 6573 3a20   cluster_names: 
+0001a4d0: 4966 2070 726f 7669 6465 642c 206f 6e6c  If provided, onl
+0001a4e0: 7920 7265 7475 726e 2072 6563 6f72 6473  y return records
+0001a4f0: 2066 6f72 2074 6865 2067 6976 656e 2063   for the given c
+0001a500: 6c75 7374 6572 0a20 2020 2020 2020 2020  luster.         
+0001a510: 2020 206e 616d 6573 2e0a 0a20 2020 2052     names...    R
+0001a520: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0001a530: 4120 6c69 7374 206f 6620 636c 7573 7465  A list of cluste
+0001a540: 7220 7265 636f 7264 732e 2049 6620 7468  r records. If th
+0001a550: 6520 636c 7573 7465 7220 646f 6573 206e  e cluster does n
+0001a560: 6f74 2065 7869 7374 206f 7220 6861 7320  ot exist or has 
+0001a570: 6265 656e 0a20 2020 2020 2020 2074 6572  been.        ter
+0001a580: 6d69 6e61 7465 642c 2074 6865 2072 6563  minated, the rec
+0001a590: 6f72 6420 7769 6c6c 2062 6520 6f6d 6974  ord will be omit
+0001a5a0: 7465 6420 6672 6f6d 2074 6865 2072 6574  ted from the ret
+0001a5b0: 7572 6e65 6420 6c69 7374 2e0a 2020 2020  urned list..    
+0001a5c0: 2222 220a 2020 2020 7265 636f 7264 7320  """.    records 
+0001a5d0: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+0001a5e0: 6174 652e 6765 745f 636c 7573 7465 7273  ate.get_clusters
+0001a5f0: 2829 0a0a 2020 2020 6966 206e 6f74 2069  ()..    if not i
+0001a600: 6e63 6c75 6465 5f63 6f6e 7472 6f6c 6c65  nclude_controlle
+0001a610: 723a 0a20 2020 2020 2020 2072 6563 6f72  r:.        recor
+0001a620: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
+0001a630: 2020 2072 6563 6f72 6420 666f 7220 7265     record for re
+0001a640: 636f 7264 2069 6e20 7265 636f 7264 730a  cord in records.
+0001a650: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0001a660: 6f6e 7472 6f6c 6c65 725f 7574 696c 732e  ontroller_utils.
+0001a670: 436f 6e74 726f 6c6c 6572 732e 6672 6f6d  Controllers.from
+0001a680: 5f6e 616d 6528 7265 636f 7264 5b27 6e61  _name(record['na
+0001a690: 6d65 275d 2920 6973 204e 6f6e 650a 2020  me']) is None.  
+0001a6a0: 2020 2020 2020 5d0a 0a20 2020 2079 656c        ]..    yel
+0001a6b0: 6c6f 7720 3d20 636f 6c6f 7261 6d61 2e46  low = colorama.F
+0001a6c0: 6f72 652e 5945 4c4c 4f57 0a20 2020 2062  ore.YELLOW.    b
+0001a6d0: 7269 6768 7420 3d20 636f 6c6f 7261 6d61  right = colorama
+0001a6e0: 2e53 7479 6c65 2e42 5249 4748 540a 2020  .Style.BRIGHT.  
+0001a6f0: 2020 7265 7365 7420 3d20 636f 6c6f 7261    reset = colora
+0001a700: 6d61 2e53 7479 6c65 2e52 4553 4554 5f41  ma.Style.RESET_A
+0001a710: 4c4c 0a0a 2020 2020 6966 2063 6c75 7374  LL..    if clust
+0001a720: 6572 5f6e 616d 6573 2069 7320 6e6f 7420  er_names is not 
+0001a730: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+0001a740: 2069 7369 6e73 7461 6e63 6528 636c 7573   isinstance(clus
+0001a750: 7465 725f 6e61 6d65 732c 2073 7472 293a  ter_names, str):
+0001a760: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
+0001a770: 7374 6572 5f6e 616d 6573 203d 205b 636c  ster_names = [cl
+0001a780: 7573 7465 725f 6e61 6d65 735d 0a20 2020  uster_names].   
+0001a790: 2020 2020 206e 6577 5f72 6563 6f72 6473       new_records
+0001a7a0: 203d 205b 5d0a 2020 2020 2020 2020 6e6f   = [].        no
+0001a7b0: 745f 6578 6973 745f 636c 7573 7465 725f  t_exist_cluster_
+0001a7c0: 6e61 6d65 7320 3d20 5b5d 0a20 2020 2020  names = [].     
+0001a7d0: 2020 2066 6f72 2063 6c75 7374 6572 5f6e     for cluster_n
+0001a7e0: 616d 6520 696e 2063 6c75 7374 6572 5f6e  ame in cluster_n
+0001a7f0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+0001a800: 2020 666f 7220 7265 636f 7264 2069 6e20    for record in 
+0001a810: 7265 636f 7264 733a 0a20 2020 2020 2020  records:.       
+0001a820: 2020 2020 2020 2020 2069 6620 7265 636f           if reco
+0001a830: 7264 5b27 6e61 6d65 275d 203d 3d20 636c  rd['name'] == cl
+0001a840: 7573 7465 725f 6e61 6d65 3a0a 2020 2020  uster_name:.    
+0001a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a860: 6e65 775f 7265 636f 7264 732e 6170 7065  new_records.appe
+0001a870: 6e64 2872 6563 6f72 6429 0a20 2020 2020  nd(record).     
+0001a880: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0001a890: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+0001a8a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001a8b0: 2020 2020 2020 206e 6f74 5f65 7869 7374         not_exist
+0001a8c0: 5f63 6c75 7374 6572 5f6e 616d 6573 2e61  _cluster_names.a
+0001a8d0: 7070 656e 6428 636c 7573 7465 725f 6e61  ppend(cluster_na
+0001a8e0: 6d65 290a 2020 2020 2020 2020 6966 206e  me).        if n
+0001a8f0: 6f74 5f65 7869 7374 5f63 6c75 7374 6572  ot_exist_cluster
+0001a900: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
+0001a910: 2020 2020 636c 7573 7465 7273 5f73 7472      clusters_str
+0001a920: 203d 2027 2c20 272e 6a6f 696e 286e 6f74   = ', '.join(not
+0001a930: 5f65 7869 7374 5f63 6c75 7374 6572 5f6e  _exist_cluster_n
+0001a940: 616d 6573 290a 2020 2020 2020 2020 2020  ames).          
+0001a950: 2020 6c6f 6767 6572 2e69 6e66 6f28 6627    logger.info(f'
+0001a960: 436c 7573 7465 7228 7329 206e 6f74 2066  Cluster(s) not f
+0001a970: 6f75 6e64 3a20 7b62 7269 6768 747d 7b63  ound: {bright}{c
+0001a980: 6c75 7374 6572 735f 7374 727d 7b72 6573  lusters_str}{res
+0001a990: 6574 7d2e 2729 0a20 2020 2020 2020 2072  et}.').        r
+0001a9a0: 6563 6f72 6473 203d 206e 6577 5f72 6563  ecords = new_rec
+0001a9b0: 6f72 6473 0a0a 2020 2020 6966 206e 6f74  ords..    if not
+0001a9c0: 2072 6566 7265 7368 3a0a 2020 2020 2020   refresh:.      
+0001a9d0: 2020 7265 7475 726e 2072 6563 6f72 6473    return records
+0001a9e0: 0a0a 2020 2020 706c 7572 616c 203d 2027  ..    plural = '
+0001a9f0: 7327 2069 6620 6c65 6e28 7265 636f 7264  s' if len(record
+0001aa00: 7329 203e 2031 2065 6c73 6520 2727 0a20  s) > 1 else ''. 
+0001aa10: 2020 2070 726f 6772 6573 7320 3d20 7269     progress = ri
+0001aa20: 6368 5f70 726f 6772 6573 732e 5072 6f67  ch_progress.Prog
+0001aa30: 7265 7373 2874 7261 6e73 6965 6e74 3d54  ress(transient=T
+0001aa40: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0001aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa60: 2020 2020 2020 2020 2020 2072 6564 6972             redir
+0001aa70: 6563 745f 7374 646f 7574 3d46 616c 7365  ect_stdout=False
+0001aa80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aaa0: 2020 2020 2020 2020 7265 6469 7265 6374          redirect
+0001aab0: 5f73 7464 6572 723d 4661 6c73 6529 0a20  _stderr=False). 
+0001aac0: 2020 2074 6173 6b20 3d20 7072 6f67 7265     task = progre
+0001aad0: 7373 2e61 6464 5f74 6173 6b28 0a20 2020  ss.add_task(.   
+0001aae0: 2020 2020 2066 275b 626f 6c64 2063 7961       f'[bold cya
+0001aaf0: 6e5d 5265 6672 6573 6869 6e67 2073 7461  n]Refreshing sta
+0001ab00: 7475 7320 666f 7220 7b6c 656e 2872 6563  tus for {len(rec
+0001ab10: 6f72 6473 297d 2063 6c75 7374 6572 7b70  ords)} cluster{p
+0001ab20: 6c75 7261 6c7d 5b2f 5d27 2c0a 2020 2020  lural}[/]',.    
+0001ab30: 2020 2020 746f 7461 6c3d 6c65 6e28 7265      total=len(re
+0001ab40: 636f 7264 7329 290a 0a20 2020 2064 6566  cords))..    def
+0001ab50: 205f 7265 6672 6573 685f 636c 7573 7465   _refresh_cluste
+0001ab60: 7228 636c 7573 7465 725f 6e61 6d65 293a  r(cluster_name):
+0001ab70: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0001ab80: 2020 2020 2020 2020 2020 7265 636f 7264            record
+0001ab90: 203d 2072 6566 7265 7368 5f63 6c75 7374   = refresh_clust
+0001aba0: 6572 5f72 6563 6f72 6428 0a20 2020 2020  er_record(.     
+0001abb0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+0001abc0: 6572 5f6e 616d 652c 0a20 2020 2020 2020  er_name,.       
+0001abd0: 2020 2020 2020 2020 2066 6f72 6365 5f72           force_r
+0001abe0: 6566 7265 7368 5f73 7461 7475 7365 733d  efresh_statuses=
+0001abf0: 7365 7428 7374 6174 7573 5f6c 6962 2e43  set(status_lib.C
+0001ac00: 6c75 7374 6572 5374 6174 7573 292c 0a20  lusterStatus),. 
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001ac20: 6371 7569 7265 5f70 6572 5f63 6c75 7374  cquire_per_clust
+0001ac30: 6572 5f73 7461 7475 735f 6c6f 636b 3d54  er_status_lock=T
+0001ac40: 7275 6529 0a20 2020 2020 2020 2065 7863  rue).        exc
+0001ac50: 6570 7420 2865 7863 6570 7469 6f6e 732e  ept (exceptions.
+0001ac60: 436c 7573 7465 7253 7461 7475 7346 6574  ClusterStatusFet
+0001ac70: 6368 696e 6745 7272 6f72 2c0a 2020 2020  chingError,.    
+0001ac80: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0001ac90: 7074 696f 6e73 2e43 6c6f 7564 5573 6572  ptions.CloudUser
+0001aca0: 4964 656e 7469 7479 4572 726f 722c 0a20  IdentityError,. 
+0001acb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001acc0: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
+0001acd0: 724f 776e 6572 4964 656e 7469 7479 4d69  rOwnerIdentityMi
+0001ace0: 736d 6174 6368 4572 726f 7229 2061 7320  smatchError) as 
+0001acf0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0001ad00: 2044 6f20 6e6f 7420 6661 696c 2074 6865   Do not fail the
+0001ad10: 2065 6e74 6972 6520 7265 6672 6573 6820   entire refresh 
+0001ad20: 7072 6f63 6573 732e 2054 6865 2063 616c  process. The cal
+0001ad30: 6c65 7220 7769 6c6c 0a20 2020 2020 2020  ler will.       
+0001ad40: 2020 2020 2023 2068 616e 646c 6520 7468       # handle th
+0001ad50: 6520 2755 4e4b 4e4f 574e 2720 7374 6174  e 'UNKNOWN' stat
+0001ad60: 7573 2c20 616e 6420 636f 6c6c 6563 7420  us, and collect 
+0001ad70: 7468 6520 6572 726f 7273 2069 6e74 6f0a  the errors into.
+0001ad80: 2020 2020 2020 2020 2020 2020 2320 6120              # a 
+0001ad90: 7461 626c 652e 0a20 2020 2020 2020 2020  table..         
+0001ada0: 2020 2072 6563 6f72 6420 3d20 7b27 7374     record = {'st
+0001adb0: 6174 7573 273a 2027 554e 4b4e 4f57 4e27  atus': 'UNKNOWN'
+0001adc0: 2c20 2765 7272 6f72 273a 2065 7d0a 2020  , 'error': e}.  
+0001add0: 2020 2020 2020 7072 6f67 7265 7373 2e75        progress.u
+0001ade0: 7064 6174 6528 7461 736b 2c20 6164 7661  pdate(task, adva
+0001adf0: 6e63 653d 3129 0a20 2020 2020 2020 2072  nce=1).        r
+0001ae00: 6574 7572 6e20 7265 636f 7264 0a0a 2020  eturn record..  
+0001ae10: 2020 636c 7573 7465 725f 6e61 6d65 7320    cluster_names 
+0001ae20: 3d20 5b72 6563 6f72 645b 276e 616d 6527  = [record['name'
+0001ae30: 5d20 666f 7220 7265 636f 7264 2069 6e20  ] for record in 
+0001ae40: 7265 636f 7264 735d 0a20 2020 2077 6974  records].    wit
+0001ae50: 6820 7072 6f67 7265 7373 3a0a 2020 2020  h progress:.    
+0001ae60: 2020 2020 7570 6461 7465 645f 7265 636f      updated_reco
+0001ae70: 7264 7320 3d20 7375 6270 726f 6365 7373  rds = subprocess
+0001ae80: 5f75 7469 6c73 2e72 756e 5f69 6e5f 7061  _utils.run_in_pa
+0001ae90: 7261 6c6c 656c 280a 2020 2020 2020 2020  rallel(.        
+0001aea0: 2020 2020 5f72 6566 7265 7368 5f63 6c75      _refresh_clu
+0001aeb0: 7374 6572 2c20 636c 7573 7465 725f 6e61  ster, cluster_na
+0001aec0: 6d65 7329 0a0a 2020 2020 2320 5368 6f77  mes)..    # Show
+0001aed0: 2069 6e66 6f72 6d61 7469 6f6e 2066 6f72   information for
+0001aee0: 2072 656d 6f76 6564 2063 6c75 7374 6572   removed cluster
+0001aef0: 732e 0a20 2020 206b 6570 745f 7265 636f  s..    kept_reco
+0001af00: 7264 7320 3d20 5b5d 0a20 2020 2061 7574  rds = [].    aut
+0001af10: 6f64 6f77 6e5f 636c 7573 7465 7273 2c20  odown_clusters, 
+0001af20: 7265 6d61 696e 696e 675f 636c 7573 7465  remaining_cluste
+0001af30: 7273 2c20 6661 696c 6564 5f63 6c75 7374  rs, failed_clust
+0001af40: 6572 7320 3d20 5b5d 2c20 5b5d 2c20 5b5d  ers = [], [], []
+0001af50: 0a20 2020 2066 6f72 2069 2c20 7265 636f  .    for i, reco
+0001af60: 7264 2069 6e20 656e 756d 6572 6174 6528  rd in enumerate(
+0001af70: 7265 636f 7264 7329 3a0a 2020 2020 2020  records):.      
+0001af80: 2020 6966 2075 7064 6174 6564 5f72 6563    if updated_rec
+0001af90: 6f72 6473 5b69 5d20 6973 204e 6f6e 653a  ords[i] is None:
+0001afa0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001afb0: 7265 636f 7264 5b27 746f 5f64 6f77 6e27  record['to_down'
+0001afc0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0001afd0: 2020 2061 7574 6f64 6f77 6e5f 636c 7573     autodown_clus
+0001afe0: 7465 7273 2e61 7070 656e 6428 636c 7573  ters.append(clus
+0001aff0: 7465 725f 6e61 6d65 735b 695d 290a 2020  ter_names[i]).  
+0001b000: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b020: 7265 6d61 696e 696e 675f 636c 7573 7465  remaining_cluste
+0001b030: 7273 2e61 7070 656e 6428 636c 7573 7465  rs.append(cluste
+0001b040: 725f 6e61 6d65 735b 695d 290a 2020 2020  r_names[i]).    
+0001b050: 2020 2020 656c 6966 2075 7064 6174 6564      elif updated
+0001b060: 5f72 6563 6f72 6473 5b69 5d5b 2773 7461  _records[i]['sta
+0001b070: 7475 7327 5d20 3d3d 2027 554e 4b4e 4f57  tus'] == 'UNKNOW
+0001b080: 4e27 3a0a 2020 2020 2020 2020 2020 2020  N':.            
+0001b090: 6661 696c 6564 5f63 6c75 7374 6572 732e  failed_clusters.
+0001b0a0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+0001b0b0: 2020 2020 2020 2020 2863 6c75 7374 6572          (cluster
+0001b0c0: 5f6e 616d 6573 5b69 5d2c 2075 7064 6174  _names[i], updat
+0001b0d0: 6564 5f72 6563 6f72 6473 5b69 5d5b 2765  ed_records[i]['e
+0001b0e0: 7272 6f72 275d 2929 0a20 2020 2020 2020  rror'])).       
+0001b0f0: 2020 2020 2023 204b 6565 7020 7468 6520       # Keep the 
+0001b100: 6f72 6967 696e 616c 2072 6563 6f72 6420  original record 
+0001b110: 6966 2074 6865 2073 7461 7475 7320 6973  if the status is
+0001b120: 2075 6e6b 6e6f 776e 2c0a 2020 2020 2020   unknown,.      
+0001b130: 2020 2020 2020 2320 736f 2074 6861 7420        # so that 
+0001b140: 7468 6520 7573 6572 2063 616e 2073 7469  the user can sti
+0001b150: 6c6c 2073 6565 2074 6865 2063 6c75 7374  ll see the clust
+0001b160: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
+0001b170: 6b65 7074 5f72 6563 6f72 6473 2e61 7070  kept_records.app
+0001b180: 656e 6428 7265 636f 7264 290a 2020 2020  end(record).    
+0001b190: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b1a0: 2020 2020 2020 6b65 7074 5f72 6563 6f72        kept_recor
+0001b1b0: 6473 2e61 7070 656e 6428 7570 6461 7465  ds.append(update
+0001b1c0: 645f 7265 636f 7264 735b 695d 290a 0a20  d_records[i]).. 
+0001b1d0: 2020 2069 6620 6175 746f 646f 776e 5f63     if autodown_c
+0001b1e0: 6c75 7374 6572 733a 0a20 2020 2020 2020  lusters:.       
+0001b1f0: 2070 6c75 7261 6c20 3d20 2773 2720 6966   plural = 's' if
+0001b200: 206c 656e 2861 7574 6f64 6f77 6e5f 636c   len(autodown_cl
+0001b210: 7573 7465 7273 2920 3e20 3120 656c 7365  usters) > 1 else
+0001b220: 2027 270a 2020 2020 2020 2020 636c 7573   ''.        clus
+0001b230: 7465 725f 7374 7220 3d20 272c 2027 2e6a  ter_str = ', '.j
+0001b240: 6f69 6e28 6175 746f 646f 776e 5f63 6c75  oin(autodown_clu
+0001b250: 7374 6572 7329 0a20 2020 2020 2020 206c  sters).        l
+0001b260: 6f67 6765 722e 696e 666f 2866 2741 7574  ogger.info(f'Aut
+0001b270: 6f64 6f77 6e65 6420 636c 7573 7465 727b  odowned cluster{
+0001b280: 706c 7572 616c 7d3a 2027 0a20 2020 2020  plural}: '.     
+0001b290: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001b2a0: 277b 6272 6967 6874 7d7b 636c 7573 7465  '{bright}{cluste
+0001b2b0: 725f 7374 727d 7b72 6573 6574 7d27 290a  r_str}{reset}').
+0001b2c0: 2020 2020 6966 2072 656d 6169 6e69 6e67      if remaining
+0001b2d0: 5f63 6c75 7374 6572 733a 0a20 2020 2020  _clusters:.     
+0001b2e0: 2020 2070 6c75 7261 6c20 3d20 2773 2720     plural = 's' 
+0001b2f0: 6966 206c 656e 2872 656d 6169 6e69 6e67  if len(remaining
+0001b300: 5f63 6c75 7374 6572 7329 203e 2031 2065  _clusters) > 1 e
+0001b310: 6c73 6520 2727 0a20 2020 2020 2020 2063  lse ''.        c
+0001b320: 6c75 7374 6572 5f73 7472 203d 2027 2c20  luster_str = ', 
+0001b330: 272e 6a6f 696e 286e 616d 6520 666f 7220  '.join(name for 
+0001b340: 6e61 6d65 2069 6e20 7265 6d61 696e 696e  name in remainin
+0001b350: 675f 636c 7573 7465 7273 290a 2020 2020  g_clusters).    
+0001b360: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+0001b370: 6e67 2866 277b 7965 6c6c 6f77 7d43 6c75  ng(f'{yellow}Clu
+0001b380: 7374 6572 7b70 6c75 7261 6c7d 2074 6572  ster{plural} ter
+0001b390: 6d69 6e61 7465 6420 6f6e 2027 0a20 2020  minated on '.   
+0001b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3b0: 2020 2020 6627 7468 6520 636c 6f75 643a      f'the cloud:
+0001b3c0: 207b 7265 7365 747d 7b62 7269 6768 747d   {reset}{bright}
+0001b3d0: 7b63 6c75 7374 6572 5f73 7472 7d7b 7265  {cluster_str}{re
+0001b3e0: 7365 747d 2729 0a0a 2020 2020 6966 2066  set}')..    if f
+0001b3f0: 6169 6c65 645f 636c 7573 7465 7273 3a0a  ailed_clusters:.
+0001b400: 2020 2020 2020 2020 706c 7572 616c 203d          plural =
+0001b410: 2027 7327 2069 6620 6c65 6e28 6661 696c   's' if len(fail
+0001b420: 6564 5f63 6c75 7374 6572 7329 203e 2031  ed_clusters) > 1
+0001b430: 2065 6c73 6520 2727 0a20 2020 2020 2020   else ''.       
+0001b440: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+0001b450: 6627 7b79 656c 6c6f 777d 4661 696c 6564  f'{yellow}Failed
+0001b460: 2074 6f20 7265 6672 6573 6820 7374 6174   to refresh stat
+0001b470: 7573 2066 6f72 2027 0a20 2020 2020 2020  us for '.       
+0001b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b490: 6627 7b6c 656e 2866 6169 6c65 645f 636c  f'{len(failed_cl
+0001b4a0: 7573 7465 7273 297d 2063 6c75 7374 6572  usters)} cluster
+0001b4b0: 7b70 6c75 7261 6c7d 3a7b 7265 7365 747d  {plural}:{reset}
+0001b4c0: 2729 0a20 2020 2020 2020 2066 6f72 2063  ').        for c
+0001b4d0: 6c75 7374 6572 5f6e 616d 652c 2065 2069  luster_name, e i
+0001b4e0: 6e20 6661 696c 6564 5f63 6c75 7374 6572  n failed_cluster
+0001b4f0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+0001b500: 6f67 6765 722e 7761 726e 696e 6728 6627  ogger.warning(f'
+0001b510: 2020 7b62 7269 6768 747d 7b63 6c75 7374    {bright}{clust
+0001b520: 6572 5f6e 616d 657d 7b72 6573 6574 7d3a  er_name}{reset}:
+0001b530: 207b 657d 2729 0a20 2020 2072 6574 7572   {e}').    retur
+0001b540: 6e20 6b65 7074 5f72 6563 6f72 6473 0a0a  n kept_records..
+0001b550: 0a40 7479 7069 6e67 2e6f 7665 726c 6f61  .@typing.overloa
+0001b560: 640a 6465 6620 6765 745f 6261 636b 656e  d.def get_backen
+0001b570: 645f 6672 6f6d 5f68 616e 646c 6528 0a20  d_from_handle(. 
+0001b580: 2020 2068 616e 646c 653a 2027 636c 6f75     handle: 'clou
+0001b590: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
+0001b5a0: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
+0001b5b0: 7263 6548 616e 646c 6527 0a29 202d 3e20  rceHandle'.) -> 
+0001b5c0: 2763 6c6f 7564 5f76 6d5f 7261 795f 6261  'cloud_vm_ray_ba
+0001b5d0: 636b 656e 642e 436c 6f75 6456 6d52 6179  ckend.CloudVmRay
+0001b5e0: 4261 636b 656e 6427 3a0a 2020 2020 2e2e  Backend':.    ..
+0001b5f0: 2e0a 0a0a 4074 7970 696e 672e 6f76 6572  ....@typing.over
+0001b600: 6c6f 6164 0a64 6566 2067 6574 5f62 6163  load.def get_bac
+0001b610: 6b65 6e64 5f66 726f 6d5f 6861 6e64 6c65  kend_from_handle
+0001b620: 280a 2020 2020 6861 6e64 6c65 3a20 276c  (.    handle: 'l
+0001b630: 6f63 616c 5f64 6f63 6b65 725f 6261 636b  ocal_docker_back
+0001b640: 656e 642e 4c6f 6361 6c44 6f63 6b65 7252  end.LocalDockerR
+0001b650: 6573 6f75 7263 6548 616e 646c 6527 0a29  esourceHandle'.)
+0001b660: 202d 3e20 276c 6f63 616c 5f64 6f63 6b65   -> 'local_docke
+0001b670: 725f 6261 636b 656e 642e 4c6f 6361 6c44  r_backend.LocalD
+0001b680: 6f63 6b65 7242 6163 6b65 6e64 273a 0a20  ockerBackend':. 
+0001b690: 2020 202e 2e2e 0a0a 0a40 7479 7069 6e67     ......@typing
+0001b6a0: 2e6f 7665 726c 6f61 640a 6465 6620 6765  .overload.def ge
+0001b6b0: 745f 6261 636b 656e 645f 6672 6f6d 5f68  t_backend_from_h
+0001b6c0: 616e 646c 6528 0a20 2020 2020 2020 2068  andle(.        h
+0001b6d0: 616e 646c 653a 2062 6163 6b65 6e64 732e  andle: backends.
+0001b6e0: 5265 736f 7572 6365 4861 6e64 6c65 2920  ResourceHandle) 
+0001b6f0: 2d3e 2062 6163 6b65 6e64 732e 4261 636b  -> backends.Back
+0001b700: 656e 643a 0a20 2020 202e 2e2e 0a0a 0a64  end:.    ......d
+0001b710: 6566 2067 6574 5f62 6163 6b65 6e64 5f66  ef get_backend_f
+0001b720: 726f 6d5f 6861 6e64 6c65 280a 2020 2020  rom_handle(.    
+0001b730: 2020 2020 6861 6e64 6c65 3a20 6261 636b      handle: back
+0001b740: 656e 6473 2e52 6573 6f75 7263 6548 616e  ends.ResourceHan
+0001b750: 646c 6529 202d 3e20 6261 636b 656e 6473  dle) -> backends
+0001b760: 2e42 6163 6b65 6e64 3a0a 2020 2020 2222  .Backend:.    ""
+0001b770: 2247 6574 7320 6120 4261 636b 656e 6420  "Gets a Backend 
+0001b780: 6f62 6a65 6374 2063 6f72 7265 7370 6f6e  object correspon
+0001b790: 6469 6e67 2074 6f20 6120 6861 6e64 6c65  ding to a handle
+0001b7a0: 2e0a 0a20 2020 2049 6e73 7065 6374 7320  ...    Inspects 
+0001b7b0: 6861 6e64 6c65 2074 7970 6520 746f 2069  handle type to i
+0001b7c0: 6e66 6572 2074 6865 2062 6163 6b65 6e64  nfer the backend
+0001b7d0: 2075 7365 6420 666f 7220 7468 6520 7265   used for the re
+0001b7e0: 736f 7572 6365 2e0a 2020 2020 2222 220a  source..    """.
+0001b7f0: 2020 2020 6261 636b 656e 643a 2062 6163      backend: bac
+0001b800: 6b65 6e64 732e 4261 636b 656e 640a 2020  kends.Backend.  
+0001b810: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001b820: 6861 6e64 6c65 2c20 6261 636b 656e 6473  handle, backends
+0001b830: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
+0001b840: 7263 6548 616e 646c 6529 3a0a 2020 2020  rceHandle):.    
+0001b850: 2020 2020 6261 636b 656e 6420 3d20 6261      backend = ba
+0001b860: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
+0001b870: 7942 6163 6b65 6e64 2829 0a20 2020 2065  yBackend().    e
+0001b880: 6c69 6620 6973 696e 7374 616e 6365 2868  lif isinstance(h
+0001b890: 616e 646c 652c 2062 6163 6b65 6e64 732e  andle, backends.
+0001b8a0: 4c6f 6361 6c44 6f63 6b65 7252 6573 6f75  LocalDockerResou
+0001b8b0: 7263 6548 616e 646c 6529 3a0a 2020 2020  rceHandle):.    
+0001b8c0: 2020 2020 6261 636b 656e 6420 3d20 6261      backend = ba
+0001b8d0: 636b 656e 6473 2e4c 6f63 616c 446f 636b  ckends.LocalDock
+0001b8e0: 6572 4261 636b 656e 6428 290a 2020 2020  erBackend().    
+0001b8f0: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
+0001b900: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0001b910: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
+0001b920: 2020 2020 2066 2748 616e 646c 6520 7479       f'Handle ty
+0001b930: 7065 207b 7479 7065 2868 616e 646c 6529  pe {type(handle)
+0001b940: 7d20 6973 206e 6f74 2073 7570 706f 7274  } is not support
+0001b950: 6564 2079 6574 2e27 290a 2020 2020 7265  ed yet.').    re
+0001b960: 7475 726e 2062 6163 6b65 6e64 0a0a 0a64  turn backend...d
+0001b970: 6566 2067 6574 5f74 6173 6b5f 6465 6d61  ef get_task_dema
+0001b980: 6e64 735f 6469 6374 2874 6173 6b3a 2027  nds_dict(task: '
+0001b990: 7461 736b 5f6c 6962 2e54 6173 6b27 2920  task_lib.Task') 
+0001b9a0: 2d3e 2044 6963 745b 7374 722c 2066 6c6f  -> Dict[str, flo
+0001b9b0: 6174 5d3a 0a20 2020 2022 2222 5265 7475  at]:.    """Retu
+0001b9c0: 726e 7320 7468 6520 7265 736f 7572 6365  rns the resource
+0001b9d0: 7320 6469 6374 206f 6620 7468 6520 7461  s dict of the ta
+0001b9e0: 736b 2e0a 0a20 2020 2052 6574 7572 6e73  sk...    Returns
+0001b9f0: 3a0a 2020 2020 2020 2020 4120 6469 6374  :.        A dict
+0001ba00: 206f 6620 7468 6520 7265 736f 7572 6365   of the resource
+0001ba10: 7320 6f66 2074 6865 2074 6173 6b2e 2054  s of the task. T
+0001ba20: 6865 206b 6579 7320 6172 6520 7468 6520  he keys are the 
+0001ba30: 7265 736f 7572 6365 206e 616d 6573 0a20  resource names. 
+0001ba40: 2020 2020 2020 2061 6e64 2074 6865 2076         and the v
+0001ba50: 616c 7565 7320 6172 6520 7468 6520 6e75  alues are the nu
+0001ba60: 6d62 6572 206f 6620 7468 6520 7265 736f  mber of the reso
+0001ba70: 7572 6365 732e 2049 7420 616c 7761 7973  urces. It always
+0001ba80: 2063 6f6e 7461 696e 730a 2020 2020 2020   contains.      
+0001ba90: 2020 7468 6520 4350 5520 7265 736f 7572    the CPU resour
+0001baa0: 6365 2028 746f 2063 6f6e 7472 6f6c 2074  ce (to control t
+0001bab0: 6865 206d 6178 696d 756d 206e 756d 6265  he maximum numbe
+0001bac0: 7220 6f66 2074 6173 6b73 292c 2061 6e64  r of tasks), and
+0001bad0: 0a20 2020 2020 2020 206f 7074 696f 6e61  .        optiona
+0001bae0: 6c6c 7920 6163 6365 6c65 7261 746f 7220  lly accelerator 
+0001baf0: 6465 6d61 6e64 732e 0a20 2020 2022 2222  demands..    """
+0001bb00: 0a20 2020 2023 2054 4f44 4f3a 2043 7573  .    # TODO: Cus
+0001bb10: 746f 6d20 4350 5520 616e 6420 6f74 6865  tom CPU and othe
+0001bb20: 7220 6d65 6d6f 7279 2072 6573 6f75 7263  r memory resourc
+0001bb30: 6573 2061 7265 206e 6f74 2073 7570 706f  es are not suppo
+0001bb40: 7274 6564 2079 6574 2e0a 2020 2020 2320  rted yet..    # 
+0001bb50: 466f 7220 736b 7920 6a6f 6273 2f73 6572  For sky jobs/ser
+0001bb60: 7665 2063 6f6e 7472 6f6c 6c65 7220 7461  ve controller ta
+0001bb70: 736b 2c20 7765 2073 6574 2074 6865 2043  sk, we set the C
+0001bb80: 5055 2072 6573 6f75 7263 6520 746f 2061  PU resource to a
+0001bb90: 2073 6d61 6c6c 6572 0a20 2020 2023 2076   smaller.    # v
+0001bba0: 616c 7565 2074 6f20 7375 7070 6f72 7420  alue to support 
+0001bbb0: 6120 6c61 7267 6572 206e 756d 6265 7220  a larger number 
+0001bbc0: 6f66 206d 616e 6167 6564 206a 6f62 7320  of managed jobs 
+0001bbd0: 616e 6420 7365 7276 6963 6573 2e0a 2020  and services..  
+0001bbe0: 2020 7265 736f 7572 6365 735f 6469 6374    resources_dict
+0001bbf0: 203d 207b 0a20 2020 2020 2020 2027 4350   = {.        'CP
+0001bc00: 5527 3a20 2863 6f6e 7374 616e 7473 2e43  U': (constants.C
+0001bc10: 4f4e 5452 4f4c 4c45 525f 5052 4f43 4553  ONTROLLER_PROCES
+0001bc20: 535f 4350 555f 4445 4d41 4e44 0a20 2020  S_CPU_DEMAND.   
+0001bc30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001bc40: 7461 736b 2e69 735f 636f 6e74 726f 6c6c  task.is_controll
+0001bc50: 6572 5f74 6173 6b28 2920 656c 7365 2044  er_task() else D
+0001bc60: 4546 4155 4c54 5f54 4153 4b5f 4350 555f  EFAULT_TASK_CPU_
+0001bc70: 4445 4d41 4e44 290a 2020 2020 7d0a 2020  DEMAND).    }.  
+0001bc80: 2020 6966 2074 6173 6b2e 6265 7374 5f72    if task.best_r
+0001bc90: 6573 6f75 7263 6573 2069 7320 6e6f 7420  esources is not 
+0001bca0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
+0001bcb0: 736f 7572 6365 7320 3d20 7461 736b 2e62  sources = task.b
+0001bcc0: 6573 745f 7265 736f 7572 6365 730a 2020  est_resources.  
+0001bcd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001bce0: 2320 5461 736b 206d 6179 2028 652e 672e  # Task may (e.g.
+0001bcf0: 2c20 736b 7920 6c61 756e 6368 2920 6f72  , sky launch) or
+0001bd00: 206d 6179 206e 6f74 2028 652e 672e 2c20   may not (e.g., 
+0001bd10: 736b 7920 6578 6563 2920 6861 7665 2075  sky exec) have u
+0001bd20: 6e64 6572 676f 6e65 0a20 2020 2020 2020  ndergone.       
+0001bd30: 2023 2073 6b79 2e6f 7074 696d 697a 6528   # sky.optimize(
+0001bd40: 292c 2073 6f20 6265 7374 5f72 6573 6f75  ), so best_resou
+0001bd50: 7263 6573 206d 6179 2062 6520 4e6f 6e65  rces may be None
+0001bd60: 2e0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+0001bd70: 206c 656e 2874 6173 6b2e 7265 736f 7572   len(task.resour
+0001bd80: 6365 7329 203d 3d20 312c 2074 6173 6b2e  ces) == 1, task.
+0001bd90: 7265 736f 7572 6365 730a 2020 2020 2020  resources.      
+0001bda0: 2020 7265 736f 7572 6365 7320 3d20 6c69    resources = li
+0001bdb0: 7374 2874 6173 6b2e 7265 736f 7572 6365  st(task.resource
+0001bdc0: 7329 5b30 5d0a 2020 2020 6966 2072 6573  s)[0].    if res
+0001bdd0: 6f75 7263 6573 2069 7320 6e6f 7420 4e6f  ources is not No
+0001bde0: 6e65 2061 6e64 2072 6573 6f75 7263 6573  ne and resources
+0001bdf0: 2e61 6363 656c 6572 6174 6f72 7320 6973  .accelerators is
+0001be00: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001be10: 2020 2072 6573 6f75 7263 6573 5f64 6963     resources_dic
+0001be20: 742e 7570 6461 7465 2872 6573 6f75 7263  t.update(resourc
+0001be30: 6573 2e61 6363 656c 6572 6174 6f72 7329  es.accelerators)
+0001be40: 0a20 2020 2072 6574 7572 6e20 7265 736f  .    return reso
+0001be50: 7572 6365 735f 6469 6374 0a0a 0a64 6566  urces_dict...def
+0001be60: 2067 6574 5f74 6173 6b5f 7265 736f 7572   get_task_resour
+0001be70: 6365 735f 7374 7228 7461 736b 3a20 2774  ces_str(task: 't
+0001be80: 6173 6b5f 6c69 622e 5461 736b 272c 0a20  ask_lib.Task',. 
+0001be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bea0: 2020 2020 2020 2020 2020 6973 5f6d 616e            is_man
+0001beb0: 6167 6564 5f6a 6f62 3a20 626f 6f6c 203d  aged_job: bool =
+0001bec0: 2046 616c 7365 2920 2d3e 2073 7472 3a0a   False) -> str:.
+0001bed0: 2020 2020 2222 2252 6574 7572 6e73 2074      """Returns t
+0001bee0: 6865 2072 6573 6f75 7263 6573 2073 7472  he resources str
+0001bef0: 696e 6720 6f66 2074 6865 2074 6173 6b2e  ing of the task.
+0001bf00: 0a0a 2020 2020 5468 6520 7265 736f 7572  ..    The resour
+0001bf10: 6365 7320 7374 7269 6e67 2069 7320 6f6e  ces string is on
+0001bf20: 6c79 2075 7365 6420 6173 2061 2064 6973  ly used as a dis
+0001bf30: 706c 6179 2070 7572 706f 7365 2c20 736f  play purpose, so
+0001bf40: 2077 6520 6f6e 6c79 2073 686f 770a 2020   we only show.  
+0001bf50: 2020 7468 6520 6163 6365 6c65 7261 746f    the accelerato
+0001bf60: 7220 6465 6d61 6e64 7320 2869 6620 616e  r demands (if an
+0001bf70: 7929 2e20 4f74 6865 7277 6973 652c 2074  y). Otherwise, t
+0001bf80: 6865 2043 5055 2064 656d 616e 6420 6973  he CPU demand is
+0001bf90: 2073 686f 776e 2e0a 2020 2020 2222 220a   shown..    """.
+0001bfa0: 2020 2020 7370 6f74 5f73 7472 203d 2027      spot_str = '
+0001bfb0: 270a 2020 2020 7461 736b 5f63 7075 5f64  '.    task_cpu_d
+0001bfc0: 656d 616e 6420 3d20 2873 7472 2863 6f6e  emand = (str(con
+0001bfd0: 7374 616e 7473 2e43 4f4e 5452 4f4c 4c45  stants.CONTROLLE
+0001bfe0: 525f 5052 4f43 4553 535f 4350 555f 4445  R_PROCESS_CPU_DE
+0001bff0: 4d41 4e44 290a 2020 2020 2020 2020 2020  MAND).          
+0001c000: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001c010: 7461 736b 2e69 735f 636f 6e74 726f 6c6c  task.is_controll
+0001c020: 6572 5f74 6173 6b28 2920 656c 7365 0a20  er_task() else. 
+0001c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c040: 2020 2020 2020 7374 7228 4445 4641 554c        str(DEFAUL
+0001c050: 545f 5441 534b 5f43 5055 5f44 454d 414e  T_TASK_CPU_DEMAN
+0001c060: 4429 290a 2020 2020 6966 2074 6173 6b2e  D)).    if task.
+0001c070: 6265 7374 5f72 6573 6f75 7263 6573 2069  best_resources i
+0001c080: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001c090: 2020 2020 6163 6365 6c65 7261 746f 725f      accelerator_
+0001c0a0: 6469 6374 203d 2074 6173 6b2e 6265 7374  dict = task.best
+0001c0b0: 5f72 6573 6f75 7263 6573 2e61 6363 656c  _resources.accel
+0001c0c0: 6572 6174 6f72 730a 2020 2020 2020 2020  erators.        
+0001c0d0: 6966 2069 735f 6d61 6e61 6765 645f 6a6f  if is_managed_jo
+0001c0e0: 623a 0a20 2020 2020 2020 2020 2020 2069  b:.            i
+0001c0f0: 6620 7461 736b 2e62 6573 745f 7265 736f  f task.best_reso
+0001c100: 7572 6365 732e 7573 655f 7370 6f74 3a0a  urces.use_spot:.
+0001c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c120: 7370 6f74 5f73 7472 203d 2027 5b53 706f  spot_str = '[Spo
+0001c130: 745d 270a 2020 2020 2020 2020 2020 2020  t]'.            
+0001c140: 7461 736b 5f63 7075 5f64 656d 616e 6420  task_cpu_demand 
+0001c150: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
+0001c160: 7572 6365 732e 6370 7573 0a20 2020 2020  urces.cpus.     
+0001c170: 2020 2069 6620 6163 6365 6c65 7261 746f     if accelerato
+0001c180: 725f 6469 6374 2069 7320 4e6f 6e65 3a0a  r_dict is None:.
+0001c190: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0001c1a0: 7572 6365 735f 7374 7220 3d20 6627 4350  urces_str = f'CP
+0001c1b0: 553a 7b74 6173 6b5f 6370 755f 6465 6d61  U:{task_cpu_dema
+0001c1c0: 6e64 7d27 0a20 2020 2020 2020 2065 6c73  nd}'.        els
+0001c1d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001c1e0: 6573 6f75 7263 6573 5f73 7472 203d 2027  esources_str = '
+0001c1f0: 2c20 272e 6a6f 696e 280a 2020 2020 2020  , '.join(.      
+0001c200: 2020 2020 2020 2020 2020 6627 7b6b 7d3a            f'{k}:
+0001c210: 7b76 7d27 2066 6f72 206b 2c20 7620 696e  {v}' for k, v in
+0001c220: 2061 6363 656c 6572 6174 6f72 5f64 6963   accelerator_dic
+0001c230: 742e 6974 656d 7328 2929 0a20 2020 2065  t.items()).    e
+0001c240: 6c73 653a 0a20 2020 2020 2020 2072 6573  lse:.        res
+0001c250: 6f75 7263 655f 6163 6365 6c65 7261 746f  ource_accelerato
+0001c260: 7273 203d 205b 5d0a 2020 2020 2020 2020  rs = [].        
+0001c270: 6d69 6e5f 6370 7573 203d 2066 6c6f 6174  min_cpus = float
+0001c280: 2827 696e 6627 290a 2020 2020 2020 2020  ('inf').        
+0001c290: 7370 6f74 5f74 7970 653a 2053 6574 5b73  spot_type: Set[s
+0001c2a0: 7472 5d20 3d20 7365 7428 290a 2020 2020  tr] = set().    
+0001c2b0: 2020 2020 666f 7220 7265 736f 7572 6365      for resource
+0001c2c0: 2069 6e20 7461 736b 2e72 6573 6f75 7263   in task.resourc
+0001c2d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001c2e0: 7461 736b 5f63 7075 5f64 656d 616e 6420  task_cpu_demand 
+0001c2f0: 3d20 2731 2b27 0a20 2020 2020 2020 2020  = '1+'.         
+0001c300: 2020 2069 6620 7265 736f 7572 6365 2e63     if resource.c
+0001c310: 7075 7320 6973 206e 6f74 204e 6f6e 653a  pus is not None:
+0001c320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c330: 2074 6173 6b5f 6370 755f 6465 6d61 6e64   task_cpu_demand
+0001c340: 203d 2072 6573 6f75 7263 652e 6370 7573   = resource.cpus
+0001c350: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+0001c360: 5f63 7075 7320 3d20 6d69 6e28 6d69 6e5f  _cpus = min(min_
+0001c370: 6370 7573 2c20 666c 6f61 7428 7461 736b  cpus, float(task
+0001c380: 5f63 7075 5f64 656d 616e 642e 7374 7269  _cpu_demand.stri
+0001c390: 7028 272b 2027 2929 290a 2020 2020 2020  p('+ '))).      
+0001c3a0: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
+0001c3b0: 652e 7573 655f 7370 6f74 3a0a 2020 2020  e.use_spot:.    
+0001c3c0: 2020 2020 2020 2020 2020 2020 7370 6f74              spot
+0001c3d0: 5f74 7970 652e 6164 6428 2753 706f 7427  _type.add('Spot'
+0001c3e0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0001c3f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c400: 2020 2020 7370 6f74 5f74 7970 652e 6164      spot_type.ad
+0001c410: 6428 274f 6e2d 6465 6d61 6e64 2729 0a0a  d('On-demand')..
+0001c420: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0001c430: 6573 6f75 7263 652e 6163 6365 6c65 7261  esource.accelera
+0001c440: 746f 7273 2069 7320 4e6f 6e65 3a0a 2020  tors is None:.  
+0001c450: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001c460: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+0001c470: 2020 2066 6f72 206b 2c20 7620 696e 2072     for k, v in r
+0001c480: 6573 6f75 7263 652e 6163 6365 6c65 7261  esource.accelera
+0001c490: 746f 7273 2e69 7465 6d73 2829 3a0a 2020  tors.items():.  
+0001c4a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001c4b0: 736f 7572 6365 5f61 6363 656c 6572 6174  source_accelerat
+0001c4c0: 6f72 732e 6170 7065 6e64 2866 277b 6b7d  ors.append(f'{k}
+0001c4d0: 3a7b 767d 2729 0a0a 2020 2020 2020 2020  :{v}')..        
+0001c4e0: 6966 2069 735f 6d61 6e61 6765 645f 6a6f  if is_managed_jo
+0001c4f0: 623a 0a20 2020 2020 2020 2020 2020 2069  b:.            i
+0001c500: 6620 6c65 6e28 7461 736b 2e72 6573 6f75  f len(task.resou
+0001c510: 7263 6573 2920 3e20 313a 0a20 2020 2020  rces) > 1:.     
+0001c520: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
+0001c530: 6370 755f 6465 6d61 6e64 203d 2066 277b  cpu_demand = f'{
+0001c540: 6d69 6e5f 6370 7573 7d2b 270a 2020 2020  min_cpus}+'.    
+0001c550: 2020 2020 2020 2020 6966 2027 5370 6f74          if 'Spot
+0001c560: 2720 696e 2073 706f 745f 7479 7065 3a0a  ' in spot_type:.
+0001c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c580: 7370 6f74 5f73 7472 203d 2027 7c27 2e6a  spot_str = '|'.j
+0001c590: 6f69 6e28 736f 7274 6564 2873 706f 745f  oin(sorted(spot_
+0001c5a0: 7479 7065 2929 0a20 2020 2020 2020 2020  type)).         
+0001c5b0: 2020 2020 2020 2073 706f 745f 7374 7220         spot_str 
+0001c5c0: 3d20 6627 5b7b 7370 6f74 5f73 7472 7d5d  = f'[{spot_str}]
+0001c5d0: 270a 2020 2020 2020 2020 6966 2072 6573  '.        if res
+0001c5e0: 6f75 7263 655f 6163 6365 6c65 7261 746f  ource_accelerato
+0001c5f0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0001c600: 7265 736f 7572 6365 735f 7374 7220 3d20  resources_str = 
+0001c610: 272c 2027 2e6a 6f69 6e28 7365 7428 7265  ', '.join(set(re
+0001c620: 736f 7572 6365 5f61 6363 656c 6572 6174  source_accelerat
+0001c630: 6f72 7329 290a 2020 2020 2020 2020 656c  ors)).        el
+0001c640: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c650: 7265 736f 7572 6365 735f 7374 7220 3d20  resources_str = 
+0001c660: 6627 4350 553a 7b74 6173 6b5f 6370 755f  f'CPU:{task_cpu_
+0001c670: 6465 6d61 6e64 7d27 0a20 2020 2072 6573  demand}'.    res
+0001c680: 6f75 7263 6573 5f73 7472 203d 2066 277b  ources_str = f'{
+0001c690: 7461 736b 2e6e 756d 5f6e 6f64 6573 7d78  task.num_nodes}x
+0001c6a0: 5b7b 7265 736f 7572 6365 735f 7374 727d  [{resources_str}
+0001c6b0: 5d7b 7370 6f74 5f73 7472 7d27 0a20 2020  ]{spot_str}'.   
+0001c6c0: 2072 6574 7572 6e20 7265 736f 7572 6365   return resource
+0001c6d0: 735f 7374 720a 0a0a 2320 4861 6e64 6c65  s_str...# Handle
+0001c6e0: 2063 7472 6c2d 630a 6465 6620 696e 7465   ctrl-c.def inte
+0001c6f0: 7272 7570 745f 6861 6e64 6c65 7228 7369  rrupt_handler(si
+0001c700: 676e 756d 2c20 6672 616d 6529 3a0a 2020  gnum, frame):.  
+0001c710: 2020 6465 6c20 7369 676e 756d 2c20 6672    del signum, fr
+0001c720: 616d 650a 2020 2020 7375 6270 726f 6365  ame.    subproce
+0001c730: 7373 5f75 7469 6c73 2e6b 696c 6c5f 6368  ss_utils.kill_ch
+0001c740: 696c 6472 656e 5f70 726f 6365 7373 6573  ildren_processes
+0001c750: 2829 0a20 2020 2023 2041 766f 6964 2075  ().    # Avoid u
+0001c760: 7369 6e67 206c 6f67 6765 7220 6865 7265  sing logger here
+0001c770: 2c20 6173 2069 7420 7769 6c6c 2070 7269  , as it will pri
+0001c780: 6e74 2074 6865 2073 7461 636b 2074 7261  nt the stack tra
+0001c790: 6365 2066 6f72 2062 726f 6b65 6e0a 2020  ce for broken.  
+0001c7a0: 2020 2320 7069 7065 2c20 7768 656e 2074    # pipe, when t
+0001c7b0: 6865 206f 7574 7075 7420 6973 2070 6970  he output is pip
+0001c7c0: 6564 2074 6f20 616e 6f74 6865 7220 7072  ed to another pr
+0001c7d0: 6f67 7261 6d2e 0a20 2020 2070 7269 6e74  ogram..    print
+0001c7e0: 2866 277b 636f 6c6f 7261 6d61 2e53 7479  (f'{colorama.Sty
+0001c7f0: 6c65 2e44 494d 7d54 6970 3a20 5468 6520  le.DIM}Tip: The 
+0001c800: 6a6f 6220 7769 6c6c 206b 6565 7020 270a  job will keep '.
+0001c810: 2020 2020 2020 2020 2020 6627 7275 6e6e            f'runn
+0001c820: 696e 6720 6166 7465 7220 4374 726c 2d43  ing after Ctrl-C
+0001c830: 2e7b 636f 6c6f 7261 6d61 2e53 7479 6c65  .{colorama.Style
+0001c840: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
+0001c850: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
+0001c860: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
+0001c870: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
+0001c880: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
+0001c890: 7962 6f61 7264 496e 7465 7272 7570 7428  yboardInterrupt(
+0001c8a0: 6578 6365 7074 696f 6e73 2e4b 4559 424f  exceptions.KEYBO
+0001c8b0: 4152 445f 494e 5445 5252 5550 545f 434f  ARD_INTERRUPT_CO
+0001c8c0: 4445 290a 0a0a 2320 4861 6e64 6c65 2063  DE)...# Handle c
+0001c8d0: 7472 6c2d 7a0a 6465 6620 7374 6f70 5f68  trl-z.def stop_h
+0001c8e0: 616e 646c 6572 2873 6967 6e75 6d2c 2066  andler(signum, f
+0001c8f0: 7261 6d65 293a 0a20 2020 2064 656c 2073  rame):.    del s
+0001c900: 6967 6e75 6d2c 2066 7261 6d65 0a20 2020  ignum, frame.   
+0001c910: 2073 7562 7072 6f63 6573 735f 7574 696c   subprocess_util
+0001c920: 732e 6b69 6c6c 5f63 6869 6c64 7265 6e5f  s.kill_children_
+0001c930: 7072 6f63 6573 7365 7328 290a 2020 2020  processes().    
+0001c940: 2320 4176 6f69 6420 7573 696e 6720 6c6f  # Avoid using lo
+0001c950: 6767 6572 2068 6572 652c 2061 7320 6974  gger here, as it
+0001c960: 2077 696c 6c20 7072 696e 7420 7468 6520   will print the 
+0001c970: 7374 6163 6b20 7472 6163 6520 666f 7220  stack trace for 
+0001c980: 6272 6f6b 656e 0a20 2020 2023 2070 6970  broken.    # pip
+0001c990: 652c 2077 6865 6e20 7468 6520 6f75 7470  e, when the outp
+0001c9a0: 7574 2069 7320 7069 7065 6420 746f 2061  ut is piped to a
+0001c9b0: 6e6f 7468 6572 2070 726f 6772 616d 2e0a  nother program..
+0001c9c0: 2020 2020 7072 696e 7428 6627 7b63 6f6c      print(f'{col
+0001c9d0: 6f72 616d 612e 5374 796c 652e 4449 4d7d  orama.Style.DIM}
+0001c9e0: 5469 703a 2054 6865 206a 6f62 2077 696c  Tip: The job wil
+0001c9f0: 6c20 6b65 6570 2027 0a20 2020 2020 2020  l keep '.       
+0001ca00: 2020 2066 2772 756e 6e69 6e67 2061 6674     f'running aft
+0001ca10: 6572 2043 7472 6c2d 5a2e 7b63 6f6c 6f72  er Ctrl-Z.{color
+0001ca20: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
+0001ca30: 414c 4c7d 2729 0a20 2020 2077 6974 6820  ALL}').    with 
+0001ca40: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+0001ca50: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+0001ca60: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+0001ca70: 2072 6169 7365 204b 6579 626f 6172 6449   raise KeyboardI
+0001ca80: 6e74 6572 7275 7074 2865 7863 6570 7469  nterrupt(excepti
+0001ca90: 6f6e 732e 5349 4754 5354 505f 434f 4445  ons.SIGTSTP_CODE
+0001caa0: 290a 0a0a 6465 6620 7275 6e5f 636f 6d6d  )...def run_comm
+0001cab0: 616e 645f 616e 645f 6861 6e64 6c65 5f73  and_and_handle_s
+0001cac0: 7368 5f66 6169 6c75 7265 2872 756e 6e65  sh_failure(runne
+0001cad0: 723a 2063 6f6d 6d61 6e64 5f72 756e 6e65  r: command_runne
+0001cae0: 722e 5353 4843 6f6d 6d61 6e64 5275 6e6e  r.SSHCommandRunn
+0001caf0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0001cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb10: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+0001cb20: 6e64 3a20 7374 722c 0a20 2020 2020 2020  nd: str,.       
+0001cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb50: 6661 696c 7572 655f 6d65 7373 6167 653a  failure_message:
+0001cb60: 2073 7472 2920 2d3e 2073 7472 3a0a 2020   str) -> str:.  
+0001cb70: 2020 2222 2252 756e 7320 636f 6d6d 616e    """Runs comman
+0001cb80: 6420 7265 6d6f 7465 6c79 2061 6e64 2072  d remotely and r
+0001cb90: 6574 7572 6e73 206f 7574 7075 7420 7769  eturns output wi
+0001cba0: 7468 2070 726f 7065 7220 6572 726f 7220  th proper error 
+0001cbb0: 6861 6e64 6c69 6e67 2e22 2222 0a20 2020  handling.""".   
+0001cbc0: 2072 632c 2073 7464 6f75 742c 2073 7464   rc, stdout, std
+0001cbd0: 6572 7220 3d20 7275 6e6e 6572 2e72 756e  err = runner.run
+0001cbe0: 2863 6f6d 6d61 6e64 2c0a 2020 2020 2020  (command,.      
+0001cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc00: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001cc10: 7175 6972 655f 6f75 7470 7574 733d 5472  quire_outputs=Tr
+0001cc20: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0001cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc40: 2020 2020 2020 2020 7374 7265 616d 5f6c          stream_l
+0001cc50: 6f67 733d 4661 6c73 6529 0a20 2020 2069  ogs=False).    i
+0001cc60: 6620 7263 203d 3d20 3235 353a 0a20 2020  f rc == 255:.   
+0001cc70: 2020 2020 2023 2053 5348 2066 6169 6c65       # SSH faile
+0001cc80: 640a 2020 2020 2020 2020 7261 6973 6520  d.        raise 
+0001cc90: 5275 6e74 696d 6545 7272 6f72 280a 2020  RuntimeError(.  
+0001cca0: 2020 2020 2020 2020 2020 6627 5353 4820            f'SSH 
+0001ccb0: 7769 7468 2075 7365 7220 7b72 756e 6e65  with user {runne
+0001ccc0: 722e 7373 685f 7573 6572 7d20 616e 6420  r.ssh_user} and 
+0001ccd0: 6b65 7920 7b72 756e 6e65 722e 7373 685f  key {runner.ssh_
+0001cce0: 7072 6976 6174 655f 6b65 797d 2027 0a20  private_key} '. 
+0001ccf0: 2020 2020 2020 2020 2020 2066 2774 6f20             f'to 
+0001cd00: 7b72 756e 6e65 722e 6970 7d20 6661 696c  {runner.ip} fail
+0001cd10: 6564 2e20 5468 6973 2069 7320 6d6f 7374  ed. This is most
+0001cd20: 206c 696b 656c 7920 6475 6520 746f 2069   likely due to i
+0001cd30: 6e63 6f72 7265 6374 2027 0a20 2020 2020  ncorrect '.     
+0001cd40: 2020 2020 2020 2027 6372 6564 656e 7469         'credenti
+0001cd50: 616c 7320 6f72 2069 6e63 6f72 7265 6374  als or incorrect
+0001cd60: 2070 6572 6d69 7373 696f 6e73 2066 6f72   permissions for
+0001cd70: 2074 6865 206b 6579 2066 696c 652e 2043   the key file. C
+0001cd80: 6865 636b 2027 0a20 2020 2020 2020 2020  heck '.         
+0001cd90: 2020 2027 796f 7572 2063 7265 6465 6e74     'your credent
+0001cda0: 6961 6c73 2061 6e64 2074 7279 2061 6761  ials and try aga
+0001cdb0: 696e 2e27 290a 2020 2020 7375 6270 726f  in.').    subpro
+0001cdc0: 6365 7373 5f75 7469 6c73 2e68 616e 646c  cess_utils.handl
+0001cdd0: 655f 7265 7475 726e 636f 6465 2872 632c  e_returncode(rc,
+0001cde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce00: 2020 2020 2020 2020 636f 6d6d 616e 642c          command,
+0001ce10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce30: 2020 2020 2020 2020 6661 696c 7572 655f          failure_
+0001ce40: 6d65 7373 6167 652c 0a20 2020 2020 2020  message,.       
+0001ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce70: 7374 6465 7272 3d73 7464 6572 7229 0a20  stderr=stderr). 
+0001ce80: 2020 2072 6574 7572 6e20 7374 646f 7574     return stdout
+0001ce90: 0a0a 0a64 6566 2063 6865 636b 5f72 7379  ...def check_rsy
+0001cea0: 6e63 5f69 6e73 7461 6c6c 6564 2829 202d  nc_installed() -
+0001ceb0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2243  > None:.    """C
+0001cec0: 6865 636b 7320 6966 2072 7379 6e63 2069  hecks if rsync i
+0001ced0: 7320 696e 7374 616c 6c65 642e 0a0a 2020  s installed...  
+0001cee0: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+0001cef0: 2020 5275 6e74 696d 6545 7272 6f72 3a20    RuntimeError: 
+0001cf00: 6966 2072 7379 6e63 2069 7320 6e6f 7420  if rsync is not 
+0001cf10: 696e 7374 616c 6c65 6420 696e 2074 6865  installed in the
+0001cf20: 206d 6163 6869 6e65 2e0a 2020 2020 2222   machine..    ""
+0001cf30: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
+0001cf40: 2020 2073 7562 7072 6f63 6573 732e 7275     subprocess.ru
+0001cf50: 6e28 2772 7379 6e63 202d 2d76 6572 7369  n('rsync --versi
+0001cf60: 6f6e 272c 0a20 2020 2020 2020 2020 2020  on',.           
+0001cf70: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0001cf80: 6c3d 5472 7565 2c0a 2020 2020 2020 2020  l=True,.        
+0001cf90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001cfa0: 6865 636b 3d54 7275 652c 0a20 2020 2020  heck=True,.     
+0001cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cfc0: 2020 7374 646f 7574 3d73 7562 7072 6f63    stdout=subproc
+0001cfd0: 6573 732e 5049 5045 2c0a 2020 2020 2020  ess.PIPE,.      
+0001cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cff0: 2073 7464 6572 723d 7375 6270 726f 6365   stderr=subproce
+0001d000: 7373 2e50 4950 4529 0a20 2020 2065 7863  ss.PIPE).    exc
+0001d010: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+0001d020: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+0001d030: 723a 0a20 2020 2020 2020 2077 6974 6820  r:.        with 
+0001d040: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+0001d050: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+0001d060: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+0001d070: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0001d080: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+0001d090: 2020 2020 2020 2020 2027 6072 7379 6e63           '`rsync
+0001d0a0: 6020 6973 2072 6571 7569 7265 6420 666f  ` is required fo
+0001d0b0: 7220 7072 6f76 6973 696f 6e69 6e67 2061  r provisioning a
+0001d0c0: 6e64 270a 2020 2020 2020 2020 2020 2020  nd'.            
+0001d0d0: 2020 2020 2720 6974 2069 7320 6e6f 7420      ' it is not 
+0001d0e0: 696e 7374 616c 6c65 642e 2046 6f72 2044  installed. For D
+0001d0f0: 6562 6961 6e2f 5562 756e 7475 2073 7973  ebian/Ubuntu sys
+0001d100: 7465 6d2c 2027 0a20 2020 2020 2020 2020  tem, '.         
+0001d110: 2020 2020 2020 2027 696e 7374 616c 6c20         'install 
+0001d120: 6974 2077 6974 683a 5c6e 270a 2020 2020  it with:\n'.    
+0001d130: 2020 2020 2020 2020 2020 2020 2720 2024              '  $
+0001d140: 2073 7564 6f20 6170 7420 696e 7374 616c   sudo apt instal
+0001d150: 6c20 7273 796e 6327 2920 6672 6f6d 204e  l rsync') from N
+0001d160: 6f6e 650a 0a0a 6465 6620 6368 6563 6b5f  one...def check_
+0001d170: 7374 616c 655f 7275 6e74 696d 655f 6f6e  stale_runtime_on
+0001d180: 5f72 656d 6f74 6528 7265 7475 726e 636f  _remote(returnco
+0001d190: 6465 3a20 696e 742c 2073 7464 6572 723a  de: int, stderr:
+0001d1a0: 2073 7472 2c0a 2020 2020 2020 2020 2020   str,.          
+0001d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1c0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+0001d1d0: 6e61 6d65 3a20 7374 7229 202d 3e20 4e6f  name: str) -> No
+0001d1e0: 6e65 3a0a 2020 2020 2222 2252 6169 7365  ne:.    """Raise
+0001d1f0: 7320 5275 6e74 696d 6545 7272 6f72 2069  s RuntimeError i
+0001d200: 6620 7265 6d6f 7465 2053 6b79 5069 6c6f  f remote SkyPilo
+0001d210: 7420 7275 6e74 696d 6520 6e65 6564 7320  t runtime needs 
+0001d220: 746f 2062 6520 7570 6461 7465 642e 0a0a  to be updated...
+0001d230: 2020 2020 5765 2064 6574 6563 7420 7468      We detect th
+0001d240: 6973 2062 7920 7061 7273 696e 6720 6365  is by parsing ce
+0001d250: 7274 6169 6e20 6261 636b 7761 7264 2d69  rtain backward-i
+0001d260: 6e63 6f6d 7061 7469 626c 6520 6572 726f  ncompatible erro
+0001d270: 7220 6d65 7373 6167 6573 2066 726f 6d0a  r messages from.
+0001d280: 2020 2020 6073 7464 6572 7260 2e20 5479      `stderr`. Ty
+0001d290: 7069 6361 6c6c 7920 6475 6520 746f 2074  pically due to t
+0001d2a0: 6865 206c 6f63 616c 2063 6c69 656e 7420  he local client 
+0001d2b0: 7665 7273 696f 6e20 6a75 7374 2067 6f74  version just got
+0001d2c0: 2075 7064 6174 6564 2c20 616e 640a 2020   updated, and.  
+0001d2d0: 2020 7468 6520 7265 6d6f 7465 2072 756e    the remote run
+0001d2e0: 7469 6d65 2069 7320 616e 206f 6c64 6572  time is an older
+0001d2f0: 2076 6572 7369 6f6e 2e0a 2020 2020 2222   version..    ""
+0001d300: 220a 2020 2020 7061 7474 6572 6e20 3d20  ".    pattern = 
+0001d310: 7265 2e63 6f6d 7069 6c65 2872 2741 7474  re.compile(r'Att
+0001d320: 7269 6275 7465 4572 726f 723a 206d 6f64  ributeError: mod
+0001d330: 756c 6520 5c27 736b 795c 2e28 2e2a 295c  ule \'sky\.(.*)\
+0001d340: 2720 6861 7320 6e6f 2027 0a20 2020 2020  ' has no '.     
+0001d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d360: 2020 2020 7227 6174 7472 6962 7574 6520      r'attribute 
+0001d370: 5c27 282e 2a29 5c27 2729 0a20 2020 2069  \'(.*)\'').    i
+0001d380: 6620 7265 7475 726e 636f 6465 2021 3d20  f returncode != 
+0001d390: 303a 0a20 2020 2020 2020 2061 7474 7269  0:.        attri
+0001d3a0: 6275 7465 5f65 7272 6f72 203d 2072 652e  bute_error = re.
+0001d3b0: 6669 6e64 616c 6c28 7061 7474 6572 6e2c  findall(pattern,
+0001d3c0: 2073 7464 6572 7229 0a20 2020 2020 2020   stderr).       
+0001d3d0: 2069 6620 6174 7472 6962 7574 655f 6572   if attribute_er
+0001d3e0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0001d3f0: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+0001d400: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+0001d410: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+0001d420: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001d430: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+0001d440: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001d450: 2020 2020 2020 2066 277b 636f 6c6f 7261         f'{colora
+0001d460: 6d61 2e46 6f72 652e 5245 447d 536b 7950  ma.Fore.RED}SkyP
+0001d470: 696c 6f74 2072 756e 7469 6d65 206e 6565  ilot runtime nee
+0001d480: 6473 2074 6f20 6265 2075 7064 6174 6564  ds to be updated
+0001d490: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001d4a0: 2020 2020 2020 2027 6f6e 2074 6865 2072         'on the r
+0001d4b0: 656d 6f74 6520 636c 7573 7465 722e 2054  emote cluster. T
+0001d4c0: 6f20 7570 6461 7465 2c20 7275 6e20 2865  o update, run (e
+0001d4d0: 7869 7374 696e 6720 6a6f 6273 2061 7265  xisting jobs are
+0001d4e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001d4f0: 2020 2020 2020 2066 276e 6f74 2069 6e74         f'not int
+0001d500: 6572 7275 7074 6564 293a 207b 636f 6c6f  errupted): {colo
+0001d510: 7261 6d61 2e53 7479 6c65 2e42 5249 4748  rama.Style.BRIGH
+0001d520: 547d 736b 7920 7374 6172 7420 2d66 202d  T}sky start -f -
+0001d530: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
+0001d540: 2020 2020 2020 2020 6627 7b63 6c75 7374          f'{clust
+0001d550: 6572 5f6e 616d 657d 7b63 6f6c 6f72 616d  er_name}{coloram
+0001d560: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+0001d570: 4c7d 270a 2020 2020 2020 2020 2020 2020  L}'.            
+0001d580: 2020 2020 2020 2020 6627 5c6e 2d2d 2d20          f'\n--- 
+0001d590: 4465 7461 696c 7320 2d2d 2d5c 6e7b 7374  Details ---\n{st
+0001d5a0: 6465 7272 2e73 7472 6970 2829 7d5c 6e27  derr.strip()}\n'
+0001d5b0: 290a                                     ).
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/cloud_vm_ray_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240507/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/benchmark/benchmark_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -168,15 +168,15 @@
     bucket_name = f'sky-bench-{uuid.uuid4().hex[:4]}-{getpass.getuser()}'
 
     # Select the bucket type.
     enabled_clouds = storage_lib.get_cached_enabled_storage_clouds_or_refresh(
         raise_if_no_cloud_access=True)
     # Already checked by raise_if_no_cloud_access=True.
     assert enabled_clouds
-    bucket_type = data.StoreType.from_cloud(enabled_clouds[0])
+    bucket_type = data.StoreType.from_cloud(enabled_clouds[0]).value
 
     # Create a benchmark bucket.
     logger.info(f'Creating a bucket {bucket_name} to save the benchmark logs.')
     storage = data.Storage(bucket_name, source=None, persistent=True)
     storage.add_store(bucket_type)
 
     # Save the bucket name and type to the config.
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/check.py` & `skypilot_nightly-1.0.0.dev20240507/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240507/sky/cli.py`

 * *Files 0% similar despite different names*

```diff
@@ -2994,31 +2994,37 @@
         tpu_table = log_utils.create_table(
             ['GOOGLE_TPU', 'AVAILABLE_QUANTITIES'])
         other_table = log_utils.create_table(
             ['OTHER_GPU', 'AVAILABLE_QUANTITIES'])
 
         name, quantity = None, None
 
+        # Kubernetes specific bools
+        cloud_is_kubernetes = isinstance(cloud_obj, clouds.Kubernetes)
+        kubernetes_autoscaling = kubernetes_utils.get_autoscaler_type(
+        ) is not None
+
         if accelerator_str is None:
             result = service_catalog.list_accelerator_counts(
                 gpus_only=True,
                 clouds=cloud,
                 region_filter=region,
             )
 
-            if (len(result) == 0 and cloud_obj is not None and
-                    cloud_obj.is_same_cloud(clouds.Kubernetes())):
+            if len(result) == 0 and cloud_is_kubernetes:
                 yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
+                if kubernetes_autoscaling:
+                    yield '\n'
+                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
                 return
 
             # "Common" GPUs
             # If cloud is kubernetes, we want to show all GPUs here, even if
             # they are not listed as common in SkyPilot.
-            if (cloud_obj is not None and
-                    cloud_obj.is_same_cloud(clouds.Kubernetes())):
+            if cloud_is_kubernetes:
                 for gpu, _ in sorted(result.items()):
                     gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
             else:
                 for gpu in service_catalog.get_common_gpus():
                     if gpu in result:
                         gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
             yield from gpu_table.get_string()
@@ -3034,17 +3040,24 @@
             # Other GPUs
             if show_all:
                 yield '\n\n'
                 for gpu, qty in sorted(result.items()):
                     other_table.add_row([gpu, _list_to_str(qty)])
                 yield from other_table.get_string()
                 yield '\n\n'
+                if (cloud_is_kubernetes or
+                        cloud is None) and kubernetes_autoscaling:
+                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
+                    yield '\n\n'
             else:
                 yield ('\n\nHint: use -a/--all to see all accelerators '
                        '(including non-common ones) and pricing.')
+                if (cloud_is_kubernetes or
+                        cloud is None) and kubernetes_autoscaling:
+                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
                 return
         else:
             # Parse accelerator string
             accelerator_split = accelerator_str.split(':')
             if len(accelerator_split) > 2:
                 raise click.UsageError(
                     f'Invalid accelerator string {accelerator_str}. '
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240507/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/kubernetes.py`

 * *Files 1% similar despite different names*

```diff
@@ -333,22 +333,28 @@
                                resources.memory is not None else gpu_task_cpus *
                                self._DEFAULT_MEMORY_CPU_RATIO_WITH_GPU)
             chosen_instance_type = (
                 kubernetes_utils.KubernetesInstanceType.from_resources(
                     gpu_task_cpus, gpu_task_memory, acc_count, acc_type).name)
 
         # Check if requested instance type will fit in the cluster.
-        # TODO(romilb): This will fail early for autoscaling clusters.
-        fits, reason = kubernetes_utils.check_instance_fits(
-            chosen_instance_type)
-        if not fits:
-            logger.debug(f'Instance type {chosen_instance_type} does '
-                         'not fit in the Kubernetes cluster. '
-                         f'Reason: {reason}')
-            return [], []
+        autoscaler_type = kubernetes_utils.get_autoscaler_type()
+        if autoscaler_type is None:
+            # If autoscaler is not set, check if the instance type fits in the
+            # cluster. Else, rely on the autoscaler to provision the right
+            # instance type without running checks. Worst case, if autoscaling
+            # fails, the pod will be stuck in pending state until
+            # provision_timeout, after which failover will be triggered.
+            fits, reason = kubernetes_utils.check_instance_fits(
+                chosen_instance_type)
+            if not fits:
+                logger.debug(f'Instance type {chosen_instance_type} does '
+                             'not fit in the Kubernetes cluster. '
+                             f'Reason: {reason}')
+                return [], []
 
         # No fuzzy lists for Kubernetes
         return _make([chosen_instance_type]), []
 
     @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         if os.path.exists(os.path.expanduser(CREDENTIAL_PATH)):
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240507/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/core.py` & `skypilot_nightly-1.0.0.dev20240507/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240507/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240507/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240507/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240507/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240507/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240507/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/controller.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/core.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/state.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/jobs/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/jobs/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240507/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/kubernetes/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -31,14 +31,20 @@
     'P': 2**50,
 }
 NO_GPU_ERROR_MESSAGE = 'No GPUs found in Kubernetes cluster. \
 If your cluster contains GPUs, make sure nvidia.com/gpu resource is available on the nodes and the node labels for identifying GPUs \
 (e.g., skypilot.co/accelerator) are setup correctly. \
 To further debug, run: sky check.'
 
+KUBERNETES_AUTOSCALER_NOTE = (
+    'Note: Kubernetes cluster autoscaling is enabled. '
+    'All GPUs that can be provisioned may not be listed '
+    'here. Refer to your autoscaler\'s node pool '
+    'configuration to see the list of supported GPUs.')
+
 # TODO(romilb): Add links to docs for configuration instructions when ready.
 ENDPOINTS_DEBUG_MESSAGE = ('Additionally, make sure your {endpoint_type} '
                            'is configured correctly. '
                            '\nTo debug, run: {debug_cmd}')
 
 KIND_CONTEXT_NAME = 'kind-skypilot'  # Context name used by sky local up
 
@@ -174,21 +180,39 @@
         elif value.startswith('nvidia-'):
             return value.replace('nvidia-', '').upper()
         else:
             raise ValueError(
                 f'Invalid accelerator name in GKE cluster: {value}')
 
 
+class KarpenterLabelFormatter(SkyPilotLabelFormatter):
+    """Karpeneter label formatter
+    Karpenter uses the label `karpenter.k8s.aws/instance-gpu-name` to identify
+    the GPU type. Details: https://karpenter.sh/docs/reference/instance-types/
+    The naming scheme is same as the SkyPilot formatter, so we inherit from it.
+    """
+    LABEL_KEY = 'karpenter.k8s.aws/instance-gpu-name'
+
+
 # LABEL_FORMATTER_REGISTRY stores the label formats SkyPilot will try to
 # discover the accelerator type from. The order of the list is important, as
-# it will be used to determine the priority of the label formats.
+# it will be used to determine the priority of the label formats when
+# auto-detecting the GPU label type.
 LABEL_FORMATTER_REGISTRY = [
-    SkyPilotLabelFormatter, CoreWeaveLabelFormatter, GKELabelFormatter
+    SkyPilotLabelFormatter, CoreWeaveLabelFormatter, GKELabelFormatter,
+    KarpenterLabelFormatter
 ]
 
+# Mapping of autoscaler type to label formatter
+AUTOSCALER_TO_LABEL_FORMATTER = {
+    kubernetes_enums.KubernetesAutoscalerType.GKE: GKELabelFormatter,
+    kubernetes_enums.KubernetesAutoscalerType.KARPENTER: KarpenterLabelFormatter,  # pylint: disable=line-too-long
+    kubernetes_enums.KubernetesAutoscalerType.GENERIC: SkyPilotLabelFormatter,
+}
+
 
 def detect_gpu_label_formatter(
 ) -> Tuple[Optional[GPULabelFormatter], Dict[str, List[Tuple[str, str]]]]:
     """Detects the GPU label formatter for the Kubernetes cluster
 
     Returns:
         GPULabelFormatter: The GPU label formatter for the cluster, if found.
@@ -344,18 +368,34 @@
             - The cluster does not have GPU resources (nvidia.com/gpu)
             - The cluster does not have GPU labels setup correctly
             - The cluster doesn't have any nodes with acc_type GPU
     """
     # Check if the cluster has GPU resources
     # TODO(romilb): This assumes the accelerator is a nvidia GPU. We
     #  need to support TPUs and other accelerators as well.
-    # TODO(romilb): This will fail early for autoscaling clusters.
-    #  For AS clusters, we may need a way for users to specify GPU node pools
-    #  to use since the cluster may be scaling up from zero nodes and may not
-    #  have any GPU nodes yet.
+    # TODO(romilb): Currently, we broadly disable all GPU checks if autoscaling
+    #  is configured in config.yaml since the cluster may be scaling up from
+    #  zero nodes and may not have any GPU nodes yet. In the future, we should
+    #  support pollingthe clusters for autoscaling information, such as the
+    #  node pools configured etc.
+
+    autoscaler_type = get_autoscaler_type()
+    if autoscaler_type is not None:
+        # If autoscaler is set in config.yaml, override the label key and value
+        # to the autoscaler's format and bypass the GPU checks.
+        if check_mode:
+            # If check mode is enabled and autoscaler is set, we can return
+            # early since we assume the cluster autoscaler will handle GPU
+            # node provisioning.
+            return '', ''
+        formatter = AUTOSCALER_TO_LABEL_FORMATTER.get(autoscaler_type)
+        assert formatter is not None, ('Unsupported autoscaler type:'
+                                       f' {autoscaler_type}')
+        return formatter.get_label_key(), formatter.get_label_value(acc_type)
+
     has_gpus, cluster_resources = detect_gpu_resource()
     if has_gpus:
         # Check if the cluster has GPU labels setup correctly
         label_formatter, node_labels = \
             detect_gpu_label_formatter()
         if label_formatter is None:
             # If none of the GPU labels from LABEL_FORMATTER_REGISTRY are
@@ -1306,7 +1346,18 @@
     Returns:
         str: Pod name of the head pod
     """
     # We could have iterated over all pods in the namespace and checked for the
     # label, but since we know the naming convention, we can directly return the
     # head pod name.
     return f'{cluster_name_on_cloud}-head'
+
+
+def get_autoscaler_type(
+) -> Optional[kubernetes_enums.KubernetesAutoscalerType]:
+    """Returns the autoscaler type by reading from config"""
+    autoscaler_type = skypilot_config.get_nested(['kubernetes', 'autoscaler'],
+                                                 None)
+    if autoscaler_type is not None:
+        autoscaler_type = kubernetes_enums.KubernetesAutoscalerType(
+            autoscaler_type)
+    return autoscaler_type
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240507/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240507/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240507/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240507/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240507/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/skypilot_config.py`

 * *Files 2% similar despite different names*

```diff
@@ -148,15 +148,17 @@
             logger.debug(f'Config loaded:\n{pprint.pformat(_dict)}')
         except yaml.YAMLError as e:
             logger.error(f'Error in loading config file ({config_path}):', e)
         if _dict is not None:
             common_utils.validate_schema(
                 _dict,
                 schemas.get_config_schema(),
-                f'Invalid config YAML ({config_path}): ',
+                f'Invalid config YAML ({config_path}). See: '
+                'https://skypilot.readthedocs.io/en/latest/reference/config.html. '  # pylint: disable=line-too-long
+                'Error: ',
                 skip_none=False)
 
         logger.debug('Config syntax check passed.')
 
 
 def loaded_config_path() -> Optional[str]:
     """Returns the path to the loaded config file."""
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240507/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/task.py` & `skypilot_nightly-1.0.0.dev20240507/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/aws-ray.yml.j2`

 * *Files 2% similar despite different names*

```diff
@@ -56,14 +56,18 @@
   ssh_proxy_command: {{ssh_proxy_command}}
 {% endif %}
 
 available_node_types:
   ray.head.default:
     resources: {}
     node_config:
+      {% if remote_identity not in ['LOCAL_CREDENTIALS', 'SERVICE_ACCOUNT'] %}
+      IamInstanceProfile:
+        Name: {{remote_identity}}
+      {% endif %}
       InstanceType: {{instance_type}}
       ImageId: {{image_id}}  # Deep Learning AMI (Ubuntu 18.04); see aws.py.
       # https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.ServiceResource.create_instances
       BlockDeviceMappings:
         - DeviceName: /dev/sda1
           Ebs:
             VolumeSize: {{disk_size}}
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/jobs-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/jobs-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240507/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240507/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240507/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/kubernetes_enums.py`

 * *Files 8% similar despite different names*

```diff
@@ -32,7 +32,14 @@
 class KubernetesPortMode(enum.Enum):
     """Enum for the different types of modes supported for opening
     ports on Kubernetes.
     """
     INGRESS = 'ingress'
     LOADBALANCER = 'loadbalancer'
     PODIP = 'podip'
+
+
+class KubernetesAutoscalerType(enum.Enum):
+    """Enum for the different types of cluster autoscalers for Kubernetes."""
+    GKE = 'gke'
+    KARPENTER = 'karpenter'
+    GENERIC = 'generic'
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/schemas.py`

 * *Files 5% similar despite different names*

```diff
@@ -521,15 +521,42 @@
         },
     }
 }
 
 _REMOTE_IDENTITY_SCHEMA = {
     'remote_identity': {
         'type': 'string',
-        'case_insensitive_enum': ['LOCAL_CREDENTIALS', 'SERVICE_ACCOUNT'],
+        'case_insensitive_enum': ['LOCAL_CREDENTIALS', 'SERVICE_ACCOUNT']
+    }
+}
+
+_REMOTE_IDENTITY_SCHEMA_AWS = {
+    'remote_identity': {
+        'oneOf': [
+            {
+                'type': 'string'
+            },
+            {
+                # A list of single-element dict to pretain the order.
+                # Example:
+                #  remote_identity:
+                #    - my-cluster1-*: my-iam-role-1
+                #    - my-cluster2-*: my-iam-role-2
+                #    - "*"": my-iam-role-3
+                'type': 'array',
+                'items': {
+                    'type': 'object',
+                    'additionalProperties': {
+                        'type': 'string'
+                    },
+                    'maxProperties': 1,
+                    'minProperties': 1,
+                },
+            }
+        ]
     }
 }
 
 
 def get_config_schema():
     # pylint: disable=import-outside-toplevel
     from sky.utils import kubernetes_enums
@@ -559,15 +586,15 @@
     cloud_configs = {
         'aws': {
             'type': 'object',
             'required': [],
             'additionalProperties': False,
             'properties': {
                 'security_group_name': {
-                    'type': 'string',
+                    'type': 'string'
                 },
                 **_LABELS_SCHEMA,
                 **_NETWORK_CONFIG_SCHEMA,
             },
             **_check_not_both_fields_present('instance_tags', 'labels')
         },
         'gcp': {
@@ -627,14 +654,21 @@
                             'required': ['namespace']
                         }]
                     }
                 },
                 'provision_timeout': {
                     'type': 'integer',
                 },
+                'autoscaler': {
+                    'type': 'string',
+                    'case_insensitive_enum': [
+                        type.value
+                        for type in kubernetes_enums.KubernetesAutoscalerType
+                    ]
+                },
             }
         },
         'oci': {
             'type': 'object',
             'required': [],
             'properties': {},
             # Properties are either 'default' or a region name.
@@ -656,16 +690,19 @@
                         'type': 'string',
                     },
                 }
             },
         },
     }
 
-    for config in cloud_configs.values():
-        config['properties'].update(_REMOTE_IDENTITY_SCHEMA)
+    for cloud, config in cloud_configs.items():
+        if cloud == 'aws':
+            config['properties'].update(_REMOTE_IDENTITY_SCHEMA_AWS)
+        else:
+            config['properties'].update(_REMOTE_IDENTITY_SCHEMA)
     return {
         '$schema': 'https://json-schema.org/draft/2020-12/schema',
         'type': 'object',
         'required': [],
         'additionalProperties': False,
         'properties': {
             'jobs': controller_resources_schema,
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240507/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240506
+Version: 1.0.0.dev20240507
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240507/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_jobs_and_serve.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_jobs_and_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_smoke.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240506/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240507/tests/test_yaml_parser.py`

 * *Files identical despite different names*

